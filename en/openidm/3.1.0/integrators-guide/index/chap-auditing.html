<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;18.&nbsp;Using Audit Logs</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/css/shCore.css"><link rel="stylesheet" type="text/css" href="sh/css/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/css/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/js/shCore.js" type="text/javascript"></script><script src="sh/js/shBrushAci.js" type="text/javascript"></script><script src="sh/js/shBrushBash.js" type="text/javascript"></script><script src="sh/js/shBrushCsv.js" type="text/javascript"></script><script src="sh/js/shBrushHttp.js" type="text/javascript"></script><script src="sh/js/shBrushJava.js" type="text/javascript"></script><script src="sh/js/shBrushJScript.js" type="text/javascript"></script><script src="sh/js/shBrushLDIF.js" type="text/javascript"></script><script src="sh/js/shBrushPlain.js" type="text/javascript"></script><script src="sh/js/shBrushProperties.js" type="text/javascript"></script><script src="sh/js/shBrushXml.js" type="text/javascript"></script><script src="sh/js/shAll.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenIDM Integrator's Guide"><link rel="up" href="index.html" title="OpenIDM Integrator's Guide"><link rel="prev" href="chap-workflow.html" title="Chapter&nbsp;17.&nbsp;Integrating Business Processes and Workflows"><link rel="next" href="chap-cluster.html" title="Chapter&nbsp;19.&nbsp;Configuring OpenIDM to Work in a Cluster"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;18.&nbsp;Using Audit Logs</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-workflow.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-cluster.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-auditing"></a>Chapter&nbsp;18.&nbsp;Using Audit Logs</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-auditing.html#audit-log-types">18.1. Audit Log Types</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-log-format">18.2. Audit Log Formats</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-configuration">18.3. Audit Configuration</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-reports">18.4. Generating Reports</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-filtering">18.5. Filtering Data for Audits</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-purging">18.6. Purging Obsolete Audit Information</a></span></dt></dl></div><a class="indexterm" name="d0e19537"></a><p>OpenIDM auditing can publish and log all relevant system activity to
 the targets you specify. Auditing can include data from reconciliation as
 a basis for reporting, access details, and activity logs that capture
 operations on internal (managed) objects and external (system) objects.
 Auditing provides the data for all the relevant reports, including orphan
 account reports.</p><p>The auditing interface allows you to push auditing data to local files,
  to the OpenIDM repository, and to a remote system.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-log-types"></a>18.1.&nbsp;Audit Log Types</h2></div></div></div><div class="variablelist"><p>This section describes the types of audit log OpenIDM provides.</p><dl class="variablelist"><dt><span class="term">Access Log</span></dt><dd><p>OpenIDM writes messages concerning access to the REST API in this
     log.</p><p>Default file: <code class="filename">openidm/audit/access.csv</code></p></dd><dt><span class="term">Activity Log</span></dt><dd><p>OpenIDM logs operations on internal (managed) and external (system)
     objects to this log type.</p><p>
      Entries in the activity log contain identifiers, both for the action that
      triggered the activity, and also for the original caller and the
      relationships between related actions.
     </p><p>Default file: <code class="filename">openidm/audit/activity.csv</code></p></dd><dt><span class="term">Reconciliation Log</span></dt><dd><p>OpenIDM logs the results of a reconciliation run, including
     situations and the resulting actions taken to this log type. The activity
     log contains details about the actions, where log entries display parent
     activity identifiers,
     <code class="literal">recon/<em class="replaceable"><code>reconID</code></em></code>.</p><p>Default file: <code class="filename">openidm/audit/recon.csv</code></p></dd></dl></div><p>Where an action happens related to a higher level business
  function, the log entry points to a parent activity for that function.
  The relationships are hierarchical. For example, a synchronization operation
  could result from scheduled reconciliation for an object type. OpenIDM also
  logs the top level root activity with each entry, making it possible to
  query related activities.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-log-format"></a>18.2.&nbsp;Audit Log Formats</h2></div></div></div><p>This section describes the audit log formats to help you map
  these to the reports you generate.</p><div class="variablelist"><a name="audit-access-fields"></a><div class="variablelist-title">Access Log Fields</div><p>
    The access log includes the following information:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"_id"</code></span></dt><dd><p>
      UUID for the message object, such as
      <code class="literal">"0419d364-1b3d-4e4f-b769-555c3ca098b0"</code>
     </p></dd><dt><span class="term"><code class="literal">"action"</code></span></dt><dd><p>
      Action requested, such as <code class="literal">"authenticate"</code>
     </p></dd><dt><span class="term"><code class="literal">"ip"</code></span></dt><dd><p>
      IP address of the client. For access from the local host, this can appear
      for example as <code class="literal">"0:0:0:0:0:0:0:1%0"</code>.
     </p></dd><dt><span class="term"><code class="literal">"principal"</code></span></dt><dd><p>
      Principal (username) requesting the operation, such as
      <code class="literal">"openidm-admin"</code>
     </p></dd><dt><span class="term"><code class="literal">"roles"</code></span></dt><dd><p>
      Roles associated with the principal, such as
      <code class="literal">"[openidm-admin, openidm-authorized]"</code>
     </p></dd><dt><span class="term"><code class="literal">"status"</code></span></dt><dd><p>
      Result of the operation, such as <code class="literal">"SUCCESS"</code>
     </p></dd><dt><span class="term"><code class="literal">"timestamp"</code></span></dt><dd><p>
      The time that OpenIDM logged the message, in UTC format, for example
      <code class="literal">"2012-11-18T08:48:00.160Z"</code>
     </p></dd><dt><span class="term"><code class="literal">"userid"</code></span></dt><dd><p>
      The ID (<code class="literal">_id</code>) of the user requesting the operation, such
      as <code class="literal">openidm-admin</code>, <code class="literal">jdoe</code> or a UUID
      that has been generated by the server, such as
      <code class="literal">"0d7532e2-2b45-420e-b10e-c35684c633fd"</code>.
     </p></dd></dl></div><div class="variablelist"><a name="audit-activity-fields"></a><div class="variablelist-title">Activity Log Fields</div><p>
    The activity log includes the following information for each entry:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"_id"</code></span></dt><dd><p>
      UUID for the message object, such as
      <code class="literal">"0419d364-1b3d-4e4f-b769-555c3ca098b0"</code>
     </p></dd><dt><span class="term"><code class="literal">"action"</code></span></dt><dd><p>
      Action performed on that entry, such as <code class="literal">"create"</code>.
     </p></dd><dt><span class="term"><code class="literal">"activityId"</code></span></dt><dd><p>
      UUID for the activity corresponding to the UUID of the resource context
     </p></dd><dt><span class="term"><code class="literal">"after"</code></span></dt><dd><p>
      JSON representation of the object resulting from the activity
     </p></dd><dt><span class="term"><code class="literal">"before"</code></span></dt><dd><p>
      JSON representation of the object prior to the activity
     </p></dd><dt><span class="term"><code class="literal">"changedFields"</code></span></dt><dd><p>
      List of the fields that were changed as a result of the activity. This
      list takes into consideration only those fields that have been configured
      as <code class="literal">"watchedFields"</code> in the
      <code class="filename">conf/audit.json</code> file.
     </p></dd><dt><span class="term"><code class="literal">"message"</code></span></dt><dd><p>
      Human readable text about the activity
     </p></dd><dt><span class="term"><code class="literal">"objectId"</code></span></dt><dd><p>
      Object identifier, such as <code class="literal">"managed/user/jdoe"</code> or
      <code class="literal">"managed/user/38e29216-4b0e-4701-8a6f-ed8bf69692c7"</code>.
     </p></dd><dt><span class="term"><code class="literal">"parentActionId"</code></span></dt><dd><p>
      UUID of the action leading to the activity
     </p></dd><dt><span class="term"><code class="literal">"passwordChanged"</code></span></dt><dd><p>
      Boolean (<code class="literal">true</code> or <code class="literal">false</code>) indicating
      whether the action resulted in a password change.
     </p></dd><dt><span class="term"><code class="literal">"requester"</code></span></dt><dd><p>
      Principal requesting the operation
     </p></dd><dt><span class="term"><code class="literal">"rev"</code></span></dt><dd><p>Object revision number</p></dd><dt><span class="term"><code class="literal">"rootActionId"</code></span></dt><dd><p>UUID of the root cause for the activity. This matches a
     corresponding <code class="literal">"rootActionId"</code> in a reconciliation
     message.</p></dd><dt><span class="term"><code class="literal">"status"</code></span></dt><dd><p>Result of the operation, such as <code class="literal">"SUCCESS"</code></p></dd><dt><span class="term"><code class="literal">"timestamp"</code></span></dt><dd><p>Time when OpenIDM logged the message, in UTC format, for example 
     <code class="literal">"2012-11-18T08:48:00.160Z"</code></p></dd></dl></div><div class="variablelist"><a name="audit-recon-fields"></a><div class="variablelist-title">Reconciliation Log Fields</div><p>Reconciliation messages include the following information:</p><dl class="variablelist"><dt><span class="term"><code class="literal">"_id"</code></span></dt><dd><p>
      UUID for the message object, such as
      <code class="literal">"0419d364-1b3d-4e4f-b769-555c3ca098b0"</code>
     </p></dd><dt><span class="term"><code class="literal">"action"</code></span></dt><dd><p>
      Synchronization action, such as <code class="literal">"CREATE"</code>. See the
      section on <a href="../../integrators-guide/index/chap-synchronization.html#sync-actions" class="link"><em class="citetitle">Actions</em></a>
      for a list of possible actions.
     </p></dd><dt><span class="term"><code class="literal">"actionID"</code></span></dt><dd><p>
      The unique ID assigned to the action.
     </p></dd><dt><span class="term"><code class="literal">"ambiguousTargetObjectIds"</code></span></dt><dd><p>
      When the situation is AMBIGUOUS or UNQUALIFIED and OpenIDM cannot
      distinguish between more than one target object, OpenIDM logs the
      identifiers of the objects in this field in comma-separated format. This
      makes it possible to figure out what was ambiguous afterwards.
     </p></dd><dt><span class="term"><code class="literal">"entryType"</code></span></dt><dd><p>
      The type of reconciliation log entry, such as <code class="literal">"start"</code>,
      or <code class="literal">"summary"</code>.
     </p></dd><dt><span class="term"><code class="literal">"exception"</code></span></dt><dd><p>
      The stack trace of the exception, if any.
     </p></dd><dt><span class="term"><code class="literal">"mapping"</code></span></dt><dd><p>
      The name of the mapping used for the reconciliation (defined in
      <code class="filename">conf/sync.json</code>, for example
      <code class="literal">"systemLdapAccounts_managedUser"</code>.
     </p></dd><dt><span class="term"><code class="literal">"message"</code></span></dt><dd><p>
      Human readable text about the reconciliation action that was taken.
     </p></dd><dt><span class="term"><code class="literal">"messageDetail"</code></span></dt><dd><p>
      For the <code class="literal">"summary"</code> entry type, this field contains
      details about that specific stage of the reconciliation run, such as the
      stage name and description, start and end time, and so forth.
     </p><p>
      When script exceptions are encountered during a reconciliation run,
      the error details can also be stored in this property.
     </p><p>
      For script exception details to be pulled in, the script exception must
      take the following format:
     </p><pre class="brush: plain;">
"throw {
    'openidmCode' : HTTP error code,
    'message' : error message,
    'detail' : {
        details
    }
};"
     </pre></dd><dt><span class="term"><code class="literal">"reconId"</code></span></dt><dd><p>
      UUID for the reconciliation operation, which is the same for all entries
      pertaining to the reconciliation run.
     </p></dd><dt><span class="term"><code class="literal">"reconciling"</code></span></dt><dd><p>What OpenIDM is reconciling, 
     <code class="literal">"source"</code> for the first phase, 
     <code class="literal">"target"</code> for the second phase</p></dd><dt><span class="term"><code class="literal">"rootActionId"</code></span></dt><dd><p>UUID of the root cause for the activity. This matches a
     corresponding <code class="literal">"rootActionId"</code> in an activity
     message.</p></dd><dt><span class="term"><code class="literal">"situation"</code></span></dt><dd><p>The situation encountered. See
     the section describing <a href="../../integrators-guide/index/chap-synchronization.html#sync-situations" class="link">synchronization
     situations</a> for a list.</p></dd><dt><span class="term"><code class="literal">"sourceObjectId"</code></span></dt><dd><p>
      The object identifier on the source system, such as
      <code class="literal">"system/xmlfile/account/bjensen"</code> or
      <code class="literal">"managed/user/bjensen"</code> (depending on the resource
      configured as the source in the mapping).
     </p></dd><dt><span class="term"><code class="literal">"status"</code></span></dt><dd><p>Result of the operation, such as <code class="literal">"SUCCESS"</code></p></dd><dt><span class="term"><code class="literal">"targetObjectId"</code></span></dt><dd><p>
      The object identifier on the target system, such as
      <code class="literal">"system/xmlfile/account/bjensen"</code> or
      <code class="literal">"managed/user/bjensen"</code> (depending on the resource
      configured as the target in the mapping).
     </p></dd><dt><span class="term"><code class="literal">"timestamp"</code></span></dt><dd><p>Time when OpenIDM logged the message, in UTC format, for example 
    <code class="literal">"2012-11-18T08:48:00.160Z"</code></p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-configuration"></a>18.3.&nbsp;Audit Configuration</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-auditing.html#audit-eventtypes">18.3.1. Event Types</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-logto">18.3.2. Log To List</a></span></dt><dt><span class="section"><a href="chap-auditing.html#audit-exception-formatter">18.3.3. Exception Formatter</a></span></dt></dl></div><p>
   OpenIDM exposes the audit logging configuration under
   <code class="literal">https://localhost:8443/openidm/config/audit</code> for the REST
   API, and in the file <code class="filename">conf/audit.json</code> where you installed
   OpenIDM. A sample <code class="filename">conf/audit.json</code> configuration file
   follows:
  </p><pre class="brush: javascript;">{
    "eventTypes" : {
        "activity" : {
            "filter" : {
                "actions" : [
                    "create",
                    "update",
                    "delete",
                    "patch",
                    "action"
                ]
            },
            "watchedFields" : [ ],
            "passwordFields" : [ "password" ]
        },
        "recon" : { }
    },
    "logTo" : [
        {
            "logType" : "csv",
            "location" : "audit",
            "recordDelimiter" : ";",
            "ignoreLoggingFailures" : true
        },
        {
            "logType" : "repository",
            "useForQueries" : true,
            "ignoreLoggingFailures" : true
        }
    ],
    "exceptionFormatter" : {
        "type" : "text/javascript",
        "file" : "bin/defaults/script/audit/stacktraceFormatter.js"
    }
}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="audit-eventtypes"></a>18.3.1.&nbsp;Event Types</h3></div></div></div><p>
    The <code class="literal">eventTypes</code> configuration specifies what events
    OpenIDM writes to audit logs. OpenIDM supports the following event types:
    access, activity, synchronization, and reconciliation. The filter for
    actions under activity logging shows the actions on managed or system
    objects for which OpenIDM writes to the activity log.
   </p><div class="variablelist"><p>The <code class="literal">filter</code> <code class="literal">actions</code> list enables 
    you to configure the conditions that result in actions being written to the 
    activity log.</p><dl class="variablelist"><dt><span class="term"><code class="literal">read</code></span></dt><dd><p>
       When an object is read by using its identifier. By default, read
       actions are not logged. Add the <code class="literal">"read"</code> action to the
       list of actions to log all read actions.
      </p><p>
       Note that, due to the potential result size in the case of read
       operations on <code class="literal">system/</code> endpoints, only the read is
       logged, and not the resource detail. If you really need to log the
       complete resource detail, add the following line to your
       <code class="filename">conf/boot/boot.properties</code> file:
      </p><pre class="brush: plain;">openidm.audit.logFullObjects=true</pre></dd><dt><span class="term"><code class="literal">create</code></span></dt><dd><p>When an object is created.</p></dd><dt><span class="term"><code class="literal">update</code></span></dt><dd><p>When an object is updated.</p></dd><dt><span class="term"><code class="literal">delete</code></span></dt><dd><p>When an object is deleted.</p></dd><dt><span class="term"><code class="literal">patch</code></span></dt><dd><p>When an object is partially modified.</p></dd><dt><span class="term"><code class="literal">query</code></span></dt><dd><p>
       When a query is performed on an object. By default, query
       actions are not logged. Add the <code class="literal">"query"</code> action to the
       list of actions to log all query actions.
      </p><p>
       Note that, due to the potential result size in the case of query
       operations on <code class="literal">system/</code> endpoints, only the query is
       logged, and not the resource detail. If you really need to log the
       complete resource detail, add the following line to your
       <code class="filename">conf/boot/boot.properties</code> file:
      </p><pre class="brush: plain;">openidm.audit.logFullObjects=true</pre></dd><dt><span class="term"><code class="literal">action</code></span></dt><dd><p>When an action is performed on an object.</p></dd></dl></div><p>You can optionally add a <code class="literal">filter</code> 
   <code class="literal">triggers</code> list that specifies the actions that are logged 
   for a particular trigger. For example, the following addition to the 
   <code class="filename">audit.json</code> file specifies that only 
   <code class="literal">create</code> and <code class="literal">update</code> actions are logged 
   for an activity that was triggered by a <code class="literal">recon</code>.</p><pre class="brush: javascript;">
   ...
            "filter" : {
                "actions" : [
                    "create",
                    "update",
                    "delete",
                    "patch",
                    "action"
                ],
                "triggers" : {
                    "recon" : [
                        "create",
                        "update"
                    ]
                }
            },
            "watchedFields" : [ ],   
   ...
   </pre><p>If a trigger is provided, but no actions are specified, nothing is 
   logged for that trigger. If a trigger is omitted, all actions are logged 
   for that trigger. In the current OpenIDM release, only the 
   <code class="literal">recon</code> trigger is implemented. For a list of reconciliation 
   actions that can be logged, see <a href="../../integrators-guide/index/chap-synchronization.html#sync-actions" class="link"><em class="citetitle">Synchronization 
   Actions</em></a>.</p><p>The <code class="literal">watchedFields</code> parameter enables you to specify 
   a list of fields that should be "watched" for changes. When the value of one 
   of the fields in this list changes, the change is logged in the audit log, 
   under the column <code class="literal">"changedFields"</code>. Fields are listed in 
   comma-separated format, for example:</p><div class="screen"><pre>"watchedFields" : [ "email", "address" ]</pre></div><p>The <code class="literal">passwordFields</code> parameter enables you to specify 
   a list of fields that are considered passwords. This parameter functions much 
   like the <code class="literal">watchedFields</code> parameter in that changes to these 
   field values are logged in the audit log, under the column 
   <code class="literal">"changedFields"</code>. In addition, when a password field is 
   changed, the boolean <code class="literal">"passwordChanged"</code> flag is set to 
   <code class="literal">true</code> in the audit log. Fields are listed in 
   comma-separated format, for example:</p><div class="screen"><pre>"passwordFields" : [ "password", "username" ]</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="audit-logto"></a>18.3.2.&nbsp;Log To List</h3></div></div></div><div class="variablelist"><p>
     The <code class="literal">logTo</code> list enables you to specify the format of the
     log, where it is written, and various parameters for each log type.
    </p><dl class="variablelist"><dt><span class="term"><code class="literal">logType</code></span></dt><dd><p>
       The format of the audit log. The log type can be one of the following:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">csv</code> - write to a comma-separated variable format
          file.
         </p><p>
          The <code class="literal">"location"</code> property indicates the name of the
          directory in which the file should be written, relative to the
          directory in which you installed OpenIDM.
         </p><p>
          Audit file names are fixed, <code class="filename">access.csv</code>,
          <code class="filename">activity.csv</code>, and <code class="filename">recon.csv</code>.
         </p><p>
          The <code class="literal">"recordDelimiter"</code> property enables you to
          specify the separator between each record.
         </p></li><li class="listitem"><p>
          <code class="literal">repository</code> - write to the OpenIDM repository.
         </p><p>
          OpenIDM stores entries under the
          <code class="literal">/openidm/repo/audit/</code> context. Such entries appear
          as <code class="literal">audit/access/<em class="replaceable"><code>_id</code></em></code>,
          <code class="literal">audit/activity/<em class="replaceable"><code>_id</code></em></code>, and
          <code class="literal">audit/recon/<em class="replaceable"><code>_id</code></em></code>, where
          the <em class="replaceable"><code>_id</code></em> is the UUID of the entry, such as
          <code class="literal">0419d364-1b3d-4e4f-b769-555c3ca098b0</code>.
         </p><p>
          In the OrientDB repository, OpenIDM stores log records in the
          <code class="literal">audit_access</code>, <code class="literal">audit_activity</code>,
          and <code class="literal">audit_recon</code> tables.
         </p><p>
          In a JDBC repository, OpenIDM stores records in the
          <code class="literal">auditaccess</code>, <code class="literal">auditactivity</code>, and
          <code class="literal">auditrecon</code> tables.
         </p><p>
          The <code class="literal">"useForQueries"</code> boolean property indicates
          whether the repository logger should be used to service reads and
          query requests. The value is <code class="literal">true</code> by default. If
          <code class="literal">"useForQueries"</code> is set to <code class="literal">false</code>,
          the CSV file is used to service read and query requests.
         </p></li><li class="listitem"><p>
          <code class="literal">router</code> - enables log events to be
          directed to any endpoint in the system, such as
          <code class="literal">system/scriptedsql</code> or
          <code class="literal">endpoint/myhandler</code>.
         </p><p>
          As noted with previous instances of <code class="literal">logType</code>, the
          <code class="literal">location</code> specifies the relative directory, and
          <code class="literal">useForQueries</code> defines whether the logger is used
          to service read and query requests.
         </p></li></ul></div></dd><dt><span class="term"><code class="literal">ignoreLoggingFailures</code></span></dt><dd><p>
       In certain situations, you might want to tolerate the inability to write
       to an audit log and prevent an exception from being thrown if the logging
       fails. For example, a request for configuration data might succeed, but
       fail to write to the activity log. Reasons for logging failures might
       include full disk (for a CSV logger) or repository unavailable (for a
       repository logger).
      </p><p>
       For each log type, you can specify that failure to write to the log
       should be ignored, and should not prevent the successful execution of the
       underlying request. To ignore logging failures for a specific log type,
       add the <code class="literal">"ignoreLoggingFailures"</code> property to the log
       type configuration, and set its value to <code class="literal">true</code>. This
       parameter is not included in the default <code class="literal">audit.json</code>
       file, and its value is considered to be <code class="literal">false</code> by
       default for all log types.
      </p></dd></dl></div><p>
    You can specify a <code class="literal">logTo</code> location to the directory of your
    choice. The example shown in <a href="../../integrators-guide/index/chap-configuration.html#custom-audit-log-location" class="link"><em class="citetitle">Custom
    Audit Log Locations</em></a> shows how you can configure
    <code class="literal">logTo</code> to direct audit logs to a user home directory.
   </p><p>
    If you want to review the audit log, read the section on <a href="../../integrators-guide/index/chap-synchronization.html#querying-recon-logs" class="link"><em class="citetitle">Querying the
    Reconciliation Audit Log</em></a>. You can review several
    different ways to run a RESTful GET on audit endpoints in that section.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="audit-remote-logging"></a>18.3.2.1.&nbsp;Logging to a Remote System</h4></div></div></div><p>
     You can configure logging to a remote system. OpenIDM exposes a useful
     logging configuration in the <code class="filename">openidm/samples/audit-sample</code>
     directory, in the <code class="filename">conf/audit.json</code> configuration file.
     The <code class="literal">logTo</code> location stanza differs slightly from other
     versions of that file, in that it includes the following excerpt:
    </p><pre class="brush: javascript;">...
        "logTo" : [
    ...
            },
            {
                 "logType" : "router",
                 "location" : "system/auditdb",
                 "useForQueries" : true
            }
     ...
    </pre><p>
     To connect to an external JDBC database, you can use the
     <code class="literal">location</code> property, which is configured with the
     <code class="literal">auditdb</code> system.
    </p><p>
     You can then set up that connection
     in the <code class="filename">conf/provisioner.openicf-scriptedsql.json</code> file.
     In this particular example, that file starts with:
    </p><pre class="brush: javascript;">{
     "name" : "auditdb",</pre><p>
     You can configure remote access in that file, in the
     <code class="literal">configurationProperties</code> stanza, in the
     <code class="literal">host</code> and <code class="literal">jdbcConnectionUrl</code> properties.
     Substitute the URL or IP address of the running remote MySQL server for
     <code class="literal">localhost</code>:
    </p><pre class="brush: javascript;">...
 },
     "configurationProperties" : {
     "host" : "localhost",
     "port" : "3306",
     "user" : "root",
     "password" : "password",
     "database" : "audit",
     "autoCommit" : false,
     "reloadScriptOnExecution" : false,
     "jdbcDriver" : "com.mysql.jdbc.Driver",
     "jdbcConnectionUrl" : "jdbc:mysql://localhost:3306/audit",
     "jdbcUrlTemplate" : "jdbc:mysql://%h:%p/%d",
     "createScriptFileName" : "&amp;{launcher.project.location}/tools/CreateScript.groovy",
     "testScriptFileName" : "&amp;{launcher.project.location}/tools/TestScript.groovy",
     "searchScriptFileName" : "&amp;{launcher.project.location}/tools/SearchScript.groovy"
 },
    ...</pre><p>
     After you change the <code class="literal">localhost</code> entries, start OpenIDM
     with the configuration associated with your audit configuration. The
     following command is based on the
     <code class="filename">openidm/samples/audit-sample</code> that comes with OpenIDM.
    </p><div class="screen"><pre>$ ./setup.sh -p samples/audit-sample</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="audit-exception-formatter"></a>18.3.3.&nbsp;Exception Formatter</h3></div></div></div><p>
    The <code class="literal">exceptionFormatter</code> property specifies the name and
    type of file that handles the formatting and display of exceptions thrown by
    the audit logger. Supported types include <code class="literal">"text/javascript"</code> and
    <code class="literal">"groovy"</code>.
   </p><p>
    The <code class="literal">"file"</code> property provides the path to the script file
    that performs the formatting. The default exception formatter is
    <code class="literal">"bin/defaults/script/audit/stacktraceFormatter.js"</code>.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-reports"></a>18.4.&nbsp;Generating Reports</h2></div></div></div><p>When generating reports from audit logs, you can correlate information
  from activity and reconciliation logs by matching the
  <code class="literal">"rootActionId"</code> on entries in both logs.</p><p>The following MySQL query shows a join of the audit activity and
  audit reconciliation tables using root action ID values.</p><div class="screen"><pre>
mysql&gt; select distinct auditrecon.activity,auditrecon.sourceobjectid,
 auditrecon.targetobjectid,auditactivity.activitydate,auditrecon.status
 from auditactivity inner join auditrecon
 auditactivity.rootactionid=auditrecon.rootactionid
 where auditrecon.activity is not null group by auditrecon.sourceobjectid;
+----------+--------------------------+----------------------+---------------------+---------+
| activity | sourceobjectid           | targetobjectid       | activitydate        | status  |
+----------+--------------------------+----------------------+---------------------+---------+
| CREATE   | system/xmlfile/account/1 | managed/user/juser   | 2012-01-17T07:59:12 | SUCCESS |
| CREATE   | system/xmlfile/account/2 | managed/user/ajensen | 2012-01-17T07:59:12 | SUCCESS |
| CREATE   | system/xmlfile/account/3 | managed/user/bjensen | 2012-01-17T07:59:12 | SUCCESS |
+----------+--------------------------+----------------------+---------------------+---------+
3 rows in set (0.00 sec)</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-filtering"></a>18.5.&nbsp;Filtering Data for Audits</h2></div></div></div><p>
   With OpenIDM, you can collect large amounts of data on each transaction,
   subdivided in several different <code class="literal">eventTypes</code>: access,
   activity, reconciliation, and synchronization.
  </p><p>
   In some cases, you may want to minimize the amount of data collected with
   one or more filters. As with other <a class="xref" href="chap-auditing.html#audit-configuration" title="18.3.&nbsp;Audit Configuration">Section&nbsp;18.3, &#8220;Audit Configuration&#8221;</a>
   options, you can do so in the <code class="filename">conf/audit.json</code> file,
   based on the event type.
  </p><p>
   For example, the following entry under <code class="literal">eventTypes</code> refers
   to the <code class="filename">auditfilter.js</code> file to script limits to
   reconciliation information:
  </p><pre class="brush: javascript;">
{
   "eventTypes" : {
       ...
       "recon" : {
           "filter" : {
               "script" : {
                   "type" : "text/javascript",
                   "file" : "auditfilter.js"
               }
           }
       }
   },
   ...
}</pre><p>
   You can create a script for filtering. As it does for other scripts, OpenIDM
   makes the create request and the context objects available to the script.
   Before the audit record is written, it can be accessed as a
   <code class="literal">request.content</code> object. For guidance, see the Integrator's
   Guide appendix on <a class="link" href="integrators-guide#scripting-configuration" target="_blank">
   <em class="citetitle">Scripting Configuration</em></a>.
  </p><p>
   For example, if you want to set up a script to log just the summary records
   for mapping managed users in an LDAP data store, you could include the
   following entry in the <code class="filename">auditfilter.js</code> script:
  </p><pre class="brush: javascript;">
return request.content.entryType == 'summary' &amp;&amp;
   request.content.mapping == 'systemLdapAccounts_managedUser'
  </pre><p>
   The script must return <code class="literal">true</code> to include the log entry;
   <code class="literal">false</code> to exclude it.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audit-purging"></a>18.6.&nbsp;Purging Obsolete Audit Information</h2></div></div></div><p>
   If audit records grow "excessively" large, any subsequent reconciliations
   and queries to audit tables may become "sluggish". In a deployment with
   limited resources, a lack of disk space may affect system performance.
  </p><p>
   You may have already run through the process of
   <a class="xref" href="chap-auditing.html#audit-filtering" title="18.5.&nbsp;Filtering Data for Audits">Section&nbsp;18.5, &#8220;Filtering Data for Audits&#8221;</a>. If desired, you can also purge audit
   records with specific queries. Alternatively, you can also purge audit
   records older than a specific date, using timestamps.
  </p><p>
   OpenIDM includes a preconfigured purge script,
   <code class="filename">autoPurgeRecon.js</code> in the
   <code class="filename">bin/defaults/script/audit</code> directory.
   This script purges audit log entries from the repositoyr only, not from the
   corresponding CSV files.
  </p><p>
   You will also want to set up a schedule. For that purpose, you can find a
   pre-configured <code class="filename">schedule-autoPurgeAuditRecon.json</code> file in
   the <code class="filename">samples/schedules</code> subdirectory. You can configure
   that file as desired and then copy it to the <code class="filename">conf/</code>
   subdirectory for your deployment.
  </p><p>
   Examine the contents of the
   <code class="filename">schedule-autoPurgeAuditRecon.json</code> file:
  </p><div class="screen"><pre>{
   "enabled" : false,
   "type" : "cron",
   "schedule" : "0 0 */12 * * ?",
   "persisted" : true,
   "misfirePolicy" : "doNothing",
   "invokeService" : "script",
   "invokeContext" : {
      "script" : {
         "type" : "text/javascript",
         "file" : "audit/autoPurgeAuditRecon.js",
         "input" : {
            "mappings" : [ "%" ],
            "purgeType" : "purgeByNumOfReconsToKeep",
            "numOfRecons" : 1,
            "intervalUnit" : "minutes",
            "intervalValue" : 1
         }
      }
   }
}</pre></div><p>
   For more information on the schedule-related directives in this file, see
   <a href="../../integrators-guide/index/chap-synchronization.html#scheduling-synchronization" class="link">
    <em class="citetitle">Scheduling Synchronization</em></a>.
  </p><div class="variablelist"><p>
    Beyond scheduling, you may also be interested in the following parameters:
   </p><dl class="variablelist"><dt><span class="term">input</span></dt><dd><p>Input information; the parameters below specify different kinds of
      input.
     </p></dd><dt><span class="term">mappings</span></dt><dd><p>
      An array of mappings to prune. Each element in the array can be either a
      string or an object.
     </p><p>
      Strings must contain the mapping(s) name and can use "%" as a wild card
      value that will be used in a LIKE condition.
     </p><p>
      Objects provide the ability to specify mapping(s) to include/exclude and
      must be of the form:
      </p><div class="screen"><pre>{
      "include" : "mapping1",
      "exclude" : "mapping2"
 </pre></div><p>
     </p></dd><dt><span class="term">purgeType</span></dt><dd><p>
      The type of purge to perform, Can be set to one of two values:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">purgeByNumOfReconsToKeep</span></dt><dd><p>
         Uses the <code class="literal">deleteFromAuditReconByNumOf</code> function and
         the <code class="literal">numOfRecons</code> config variable.
        </p></dd><dt><span class="term">purgeByExpired</span></dt><dd><p>
         Uses the <code class="literal">deleteFromAuditReconByExpired</code> function and
         the config variables <code class="literal">intervalUnit</code> and
         <code class="literal">intervalValue</code>.
        </p></dd></dl></div></dd><dt><span class="term">num-of-recons</span></dt><dd><p>
      The number of recon summary records to keep for a given mapping, including
      all child records.
     </p></dd><dt><span class="term">intervalUnit</span></dt><dd><p>
      The type of time interval when using <code class="literal">purgeByExpired</code>.
      Acceptable values include: <code class="literal">minutes</code>,
      <code class="literal">hours</code>, or <code class="literal">days</code>.
     </p></dd><dt><span class="term">intervalValue</span></dt><dd><p>
      The value of the time interval when using
      <code class="literal">purgeByExpired</code>. Set to an integer value.
     </p></dd></dl></div><p>
   Once you have filtered and purged unneeded log information from the database,
   you can use log rotation services to limit the size of individual log files,
   and archive them as needed. Some log rotation services also support
   archiving to remote log servers. Details vary by the service
   and the operating system.
  </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-workflow.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-cluster.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;17.&nbsp;Integrating Business Processes and Workflows&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;19.&nbsp;Configuring OpenIDM to Work in a Cluster</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10020&components=10164&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>