<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;8.&nbsp;Managing Users, Groups, and Roles</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/css/shCore.css"><link rel="stylesheet" type="text/css" href="sh/css/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/css/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/js/shCore.js" type="text/javascript"></script><script src="sh/js/shBrushAci.js" type="text/javascript"></script><script src="sh/js/shBrushBash.js" type="text/javascript"></script><script src="sh/js/shBrushCsv.js" type="text/javascript"></script><script src="sh/js/shBrushHttp.js" type="text/javascript"></script><script src="sh/js/shBrushJava.js" type="text/javascript"></script><script src="sh/js/shBrushJScript.js" type="text/javascript"></script><script src="sh/js/shBrushLDIF.js" type="text/javascript"></script><script src="sh/js/shBrushPlain.js" type="text/javascript"></script><script src="sh/js/shBrushProperties.js" type="text/javascript"></script><script src="sh/js/shBrushXml.js" type="text/javascript"></script><script src="sh/js/shAll.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenIDM Integrator's Guide"><link rel="up" href="index.html" title="OpenIDM Integrator's Guide"><link rel="prev" href="chap-data.html" title="Chapter&nbsp;7.&nbsp;Accessing Data Objects"><link rel="next" href="chap-policies.html" title="Chapter&nbsp;9.&nbsp;Using Policies to Validate Data"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;8.&nbsp;Managing Users, Groups, and Roles</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-data.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-policies.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-users-groups-roles"></a>Chapter&nbsp;8.&nbsp;Managing Users, Groups, and Roles</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-users-groups-roles.html#working-with-managed-users">8.1. Working with Managed Users</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#working-with-groups">8.2. Working With Managed Groups</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#configuring-custom-roles">8.3. Configuring Custom Roles</a></span></dt></dl></div><p>
  OpenIDM does not control the structure of objects that are stored in its
  repository. You can define any kind of managed object, but a definition for
  users, groups and roles is provided by default.
 </p><p>
  This chapter describes how to work with these default managed objects. More
  information about the OpenIDM object model is provided in the <a href="../../integrators-guide/index/appendix-objects.html" class="link"><em class="citetitle">Data Models and
  Objects Reference</em></a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="working-with-managed-users"></a>8.1.&nbsp;Working with Managed Users</h2></div></div></div><p>
   External users that are stored in OpenIDM's repository are referred to as
   <em class="firstterm">managed users</em>. For a JDBC repository, OpenIDM stores
   managed users in the <code class="literal">managedobjects</code> table. A second table,
   <code class="literal">managedobjectproperties</code>, serves as the index table. For an
   OrientDB repository, managed users are stored in the
   <code class="literal">managed_user</code> table.
  </p><p>
   OpenIDM provides RESTful access to managed users, at the context path
   <code class="literal">/openidm/managed/user</code>. For more information, see
   <a href="../../install-guide/index/chap-install.html#first-steps-with-rest" class="link"><em class="citetitle">To Get Started
   With the OpenIDM REST Interface</em></a> in the
   <em class="citetitle">Installation Guide</em>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="working-with-groups"></a>8.2.&nbsp;Working With Managed Groups</h2></div></div></div><p>
   OpenIDM provides support for a managed <code class="literal">"group"</code> object. For
   a JDBC repository, OpenIDM stores managed groups with all other managed
   objects, in the <code class="literal">managedobjects</code> table, and uses the
   <code class="literal">managedobjectproperties</code> for indexing. For an OrientDB
   repository, managed groups are stored in the <code class="literal">managed_group</code>
   table.
  </p><p>
   The managed group object is not provided by default. To use managed groups,
   add an object similar to the following to your
   <code class="filename">conf/managed.json</code> file:
  </p><pre class="brush: plain;">{
    "name" : "group"
},
  </pre><p>
   With this addition, OpenIDM provides RESTful access to managed groups, at the
   context path <code class="literal">/openidm/managed/group</code>.
  </p><p>
   For an example of a deployment that uses managed groups, see <a href="../../install-guide/index/chap-samples.html#more-sample2d" class="link"><em class="citetitle">Sample 2d -
   Synchronizing LDAP Groups</em></a> in the <em class="citetitle">Installation
   Guide</em>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuring-custom-roles"></a>8.3.&nbsp;Configuring Custom Roles</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-users-groups-roles.html#roles-creating-assigning-deleting">8.3.1. Creating, Assigning, and Deleting Roles</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#effective-roles-and-assignments">8.3.2. Understanding Effective Roles and Effective Assignments</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#role-mapping">8.3.3. Setting up the Role Mapping</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#test-effective-roles">8.3.4. Testing the Roles Mechanism</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#dynamic-role-assignments">8.3.5. Adding Support for Dynamic Assignments</a></span></dt><dt><span class="section"><a href="chap-users-groups-roles.html#managed-role-script-hooks">8.3.6. Managed Role Object Script Hooks</a></span></dt></dl></div><p>
   The default managed object model includes a managed <code class="literal">role</code>
   object that can be manipulated in the same way as any other managed object.
  </p><p>
   This section refers to two distinct types of roles - direct (static) and
   indirect (dynamic) roles. Direct roles refer to roles that are specifically
   added to the user's <code class="literal">"roles"</code> attribute by an administrator
   operation. Indirect roles might be added to the user entry as a result of a
   script or rule that assigns the role. For example, a user might acquire a
   <code class="literal">"sales-role"</code> as a result of being in the
   <code class="literal">"sales"</code> organization.
  </p><p>
   A managed user's <code class="literal">"roles"</code> attribute takes an array as a
   value. Currently, only flat strings are supported in this array.
  </p><p>
   The <code class="literal">"roles"</code> attribute includes any specifically assigned
   roles, and any roles assigned internally by OpenIDM. So, the
   <code class="literal">"roles"</code> attribute of a particular user entry might
   appear as follows:
  </p><pre class="brush: java;">
"roles" : [
    "name" : "managed/role/sample-role",
    "name" : "openidm-authorized"
]
  </pre><p>
   A role value that includes a <code class="literal">/</code> character is considered to
   be a URL that points to the role details on the router, for example,
   <code class="literal">managed/role/sample-role</code>.
  </p><p>
   The following sections describe basic role manipulation - how roles are
   defined, assigned to users, and deleted. The entitlements or assignments
   supplied by roles are described in the subsequent section.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="roles-creating-assigning-deleting"></a>8.3.1.&nbsp;Creating, Assigning, and Deleting Roles</h3></div></div></div><p>
    Role definitions are stored in the repository and are accessible at the
    <code class="literal">/openidm/managed/role</code> context path. This section
    describes how to manipulate roles over the REST interface.
   </p><p>
    The examples in this section assume that OpenIDM has been started with the
    configuration of Sample 2b, and refers to the managed user objects created
    in that sample. For more information, see <a href="../../install-guide/index/chap-samples.html#more-sample2b" class="link"><em class="citetitle">Sample 2b - LDAP Two Way</em></a> in the
    <em class="citetitle">Installation Guide</em>.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="create-role-definition"></a>8.3.1.1.&nbsp;To Create a Role Definition</h4></div></div></div><p>
     To create a managed role definition, use a PUT request on the
     <code class="literal">openidm/managed/role</code> context path, specifying the role
     ID in the URL. The following request creates a role definition named
     <code class="literal">newrole</code>. The role effectively assigns the value
     <code class="literal">"CN=employees,O=corp"</code> to the
     <code class="literal">ldapGroups</code> attribute on the <code class="literal">ldap</code>
     system.
    </p><div class="screen"><pre>$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --header "If-None-Match: *" \
 --request PUT \
 --data '{
  "properties": {
    "description": "an example role"
  },
  "assignments": {
    "ldap": {
      "attributes": [
        {
          "name": "ldapGroups",
          "assignmentOperation": "mergeWithTarget",
          "unassignmentOperation": "removeFromTarget",
          "value": [
            "CN=employees,O=corp"
          ]
        }
      ],
      "onAssignment": {
        "file": "roles\/onAssignment_ldap.js",
        "type": "text\/javascript"
      },
      "onUnassignment": {
        "file": "roles\/onUnassignment_ldap.js",
        "type": "text\/javascript"
      }
    }
  }
}' \
 "https://localhost:8443/openidm/managed/role/newrole"</strong>
 <em>
 {
   "assignments": {
     "ldap": {
       "attributes": [
         {
           "name": "ldapGroups",
           "unassignmentOperation": "removeFromTarget",
           "assignmentOperation": "mergeWithTarget",
           "value": [
             "CN=employees,O=corp"
           ]
         }
       ],
       "onAssignment": {
         "file": "roles/onAssignment_ldap.js",
         "type": "text/javascript"
       },
       "onUnassignment": {
         "file": "roles/onUnassignment_ldap.js",
         "type": "text/javascript"
       }
     }
   },
   "_id": "newrole",
   "properties": {
     "description": "an example role"
   },
   "_rev": "1"
 }</em>
    </pre></div><p>
     For information about each of the properties in the role definition, see
     <a class="xref" href="chap-users-groups-roles.html#sample-role-definition" title="8.3.2.1.&nbsp;A Sample Role Definition for Two Remote Systems">Section&nbsp;8.3.2.1, &#8220;A Sample Role Definition for Two Remote Systems&#8221;</a>.
    </p><p>
     Most of the examples in this guide use PUT to create client-assigned IDs
     for resources, as it makes the examples easier to read. Your deployment
     might require you to use server-assigned UUIDs, in which case you should
     use a POST request. For more information, see
     <a href="../../integrators-guide/index/appendix-rest.html#put-post-managed-objects" class="link">
     <em class="citetitle">Should You Use PUT or POST to Create A Managed Object?
     </em></a>
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="listing-defined-roles"></a>8.3.1.2.&nbsp;To List the Defined Roles</h4></div></div></div><p>
     To obtain a list of all defined managed roles, query the
     <code class="literal">/openidm/managed/role</code> context path, as follows.
    </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/managed/role/?_queryId=query-all-ids"</strong>
     <em>
{
  "remainingPagedResults": -1,
  "pagedResultsCookie": null,
  "resultCount": 1,
  "result": [
    {
      "_rev": "0",
      "_id": "newrole"
    }
  ]
}     </em>
    </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="assign-role-to-user"></a>8.3.1.3.&nbsp;To Assign a Role to a User</h4></div></div></div><p>
     To assign a direct role to a user, update the user's entry over REST,
     adding <code class="literal">managed/role/<em class="replaceable"><code>role ID</code></em></code>
     to the user's <code class="literal">"roles"</code> attribute. The following example
     adds the <code class="literal">ldap</code> role, created previously, to user
     <code class="literal">bjensen</code>, whose <code class="literal">_id</code> is
     <code class="literal">2e78fd22-a7cb-4585-9570-5f649e8abd25</code>.
    </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --header "If-Match: *" \
 --request PATCH \
 --data '[
    {
        "operation": "add",
        "field": "/roles/-",
        "value": "managed/role/newrole"

    }
]' \
 "https://localhost:8443/openidm/managed/user/2e78fd22-a7cb-4585-9570-5f649e8abd25"
    </strong>
<em>{
  "displayName": "Babara Jensen",
  "stateProvince": "",
  "userName": "bjensen",
  "postalAddress": "",
  "effectiveAssignments": {
    "ldap": {
      "attributes": [
        {
          "name": "ldapGroups",
          "unassignmentOperation": "removeFromTarget",
          "assignmentOperation": "mergeWithTarget",
          "assignedThrough": "managed/role/newrole",
          "value": [
            "CN=employees,O=corp"
          ]
        }
      ],
      "onAssignment": {
        "file": "roles/onAssignment_ldap.js",
        "type": "text/javascript"
      },
      "onUnassignment": {
        "file": "roles/onUnassignment_ldap.js",
        "type": "text/javascript"
      }
    }
  },
  "roles": [
    "openidm-authorized",
    "managed/role/newrole"
  ],
  "city": "",
  "effectiveRoles": [
    "openidm-authorized",
    "managed/role/newrole"
  ],
  "givenName": "Barbara",
  "lastPasswordAttempt": "Tue Oct 21 2014 16:01:22 GMT+0200 (SAST)",
  "address2": "",
  "passwordAttempts": "0",
  "sn": "Jensen",
  "mail": "bjensen@example.com",
  "country": "",
  "_rev": "2",
  "lastPasswordSet": "",
  "postalCode": "",
  "_id": "2e78fd22-a7cb-4585-9570-5f649e8abd25",
  "description": "Created for OpenIDM",
  "accountStatus": "active",
  "telephoneNumber": "1-360-229-7105"
}</em>
    </pre></div><p>
     Note the dash (<code class="literal">-</code>) character that is appended to the
     field name in the <code class="literal">data</code> that is being sent. This
     character specifies that the role should be added to the existing roles for
     that user. If you do not include the dash character, the request overwrites
     all current values of the user's <code class="literal">"roles"</code> attribute.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="query-role-membership"></a>8.3.1.4.&nbsp;To Query Role Membership</h4></div></div></div><p>
     To return a list of all users who have a specific directly assigned role,
     use the <code class="literal">get-users-of-direct-role</code> query, specifying the
     role ID. You cannot query role membership for indirect roles.
    </p><p>
     The following query returns all members of the <code class="literal">"newrole"</code>
     role created previously. Currently that role has only one member,
     <code class="literal">bjensen</code>, whose ID is
     <code class="literal">2e78fd22-a7cb-4585-9570-5f649e8abd25</code>. The query returns
     the complete user object.
    </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/managed/user?_queryId=get-users-of-direct-role&amp;role=managed/role/newrole"
     </strong>
<em>{
  "remainingPagedResults": -1,
  "pagedResultsCookie": null,
  "resultCount": 1,
  "result": [
    {
      "effectiveAssignments": {
        "ldap": {
          "attributes": [
            {
              "name": "ldapGroups",
...
      "_id": "2e78fd22-a7cb-4585-9570-5f649e8abd25",
      "_rev": "2",
      "description": "Created for OpenIDM",
      "accountStatus": "active"
    }
  ]
}</em>
    </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="remove-role-assignment"></a>8.3.1.5.&nbsp;To Remove a Role Assignment</h4></div></div></div><p>
     To remove a role assignment from a user, simply replace that user's
     <code class="literal">"roles"</code> attribute with the array of roles that the user
     should have. The following example removes the <code class="literal">newrole</code>
     role from user <code class="literal">bjensen</code> by replacing the current value of
     her <code class="literal">"roles"</code> attribute with its previous value
     (<code class="literal">"openidm-authorized"</code>).
    </p><div class="screen"><pre>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --header "If-Match: *" \
 --request PATCH \
 --data '[
    {
        "operation": "replace",
        "field": "/roles",
        "value": [
            "openidm-authorized"
        ]
    }
]' \
 "https://localhost:8443/openidm/managed/user/2e78fd22-a7cb-4585-9570-5f649e8abd25"</pre></div><p>
     In the role definition, you can specify what should happen when an
     assignment of that role is removed. For more information, see
     <a class="xref" href="chap-users-groups-roles.html#effective-roles-and-assignments" title="8.3.2.&nbsp;Understanding Effective Roles and Effective Assignments">Section&nbsp;8.3.2, &#8220;Understanding Effective Roles and Effective Assignments&#8221;</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="delete-role-definition"></a>8.3.1.6.&nbsp;To Delete a Managed Role Definition</h4></div></div></div><p>
     To delete a role definition, send a DELETE request, specifying the role ID
     in the URL. The following sample command deletes the
     <code class="literal">newrole</code> role, created previously.
    </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request DELETE \
 "https://localhost:8443/openidm/managed/role/newrole"</strong>
<em>{
  "properties": {
    "description": "an example role"
  },
  "assignments": {
    "ldap": {
      "attributes": [
        {
          "name": "ldapGroups",
          "unassignmentOperation": "removeFromTarget",
          "assignmentOperation": "mergeWithTarget",
          "value": [
            "CN=employees,O=corp"
          ]
        }
      ],
      "onAssignment": {
        "file": "roles/onAssignment_ldap.js",
        "type": "text/javascript"
      },
      "onUnassignment": {
        "file": "roles/onUnassignment_ldap.js",
        "type": "text/javascript"
      }
    }
  },
  "_rev": "1",
  "_id": "newrole"
}</em>
    </pre></div><div class="note"><h3 class="title">Note</h3><p>
      You cannot delete a role definition if that role is currently assigned to
      a user. Attempting to delete an assigned role results in the following
      error:
     </p><div class="screen"><pre>{
  "message": "Cannot delete a role that is currently assigned",
  "reason": "Conflict",
  "code": 409
}</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="effective-roles-and-assignments"></a>8.3.2.&nbsp;Understanding Effective Roles and Effective Assignments</h3></div></div></div><p>
    The primary purpose of roles is the management of user access to system
    resources. User access is controlled by the
    <em class="firstterm">assignments</em> or entitlements provided by the role.
   </p><p>
    The previous section described how to create a basic role definition and to
    assign that role to a user. This section describes how the assignments that
    are specified for that role are applied.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="sample-role-definition"></a>8.3.2.1.&nbsp;A Sample Role Definition for Two Remote Systems</h4></div></div></div><p>
     The following sample role definition shows how assignments are configured
     for two remote systems - an LDAP server (<code class="literal">ldap</code>), and an
     Active Directory Server (<code class="literal">ad</code>).
    </p><pre class="brush: java;">{
     "name": "samplerole",
     "_id": "samplerole",
     "assignments": {
         "ad": {
             "attributes": [
                 {
                     "name": "adSystems",
                     "value": [
                         "CN=fileshare,O=corp",
                         "CN=desktop,O=corp",
                         "CN=terminal,O=corp",
                         "CN=intranet,O=corp"
                     ],
                     "assignmentOperation": "mergeWithTarget",
                     "unassignmentOperation": "removeFromTarget"
                 }
             ]
         },
         "ldap": {
             "attributes": [
                 {
                     "name": "ldapGroups",
                     "value": [
                         "CN=employees,O=corp"
                     ],
                     "assignmentOperation": "mergeWithTarget",
                     "unassignmentOperation": "removeFromTarget"
                 },
                 {
                     "name": "employeeType",
                     "value": "employee"
                 }
             ],
             "onAssignment": {
                 "file": "roles/onAssignment_ldap.js",
                 "type": "text/javascript"
             },
             "onUnassignment": {
                 "file": "roles/onUnassignment_ldap.js",
                 "type": "text/javascript"
             }
         }
     }
}</pre><div class="itemizedlist"><p>
      The role definition includes the following properties:
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">"name"</code> is the name of the role, and should be unique.
       Avoid using special characters in the role name.
      </p></li><li class="listitem"><p>
       <code class="literal">"_id"</code> is the object identifier of the role, by which
       it is accessed over REST.
      </p></li><li class="listitem"><p>
       <code class="literal">"assignments"</code> specifies the list of assignments
       (or entitlements) that this role will create on the remote systems.
      </p><p>
       Each assignment includes the name of the external system, such as
       <code class="literal">ad</code> and <code class="literal">ldap</code>, the
       attribute or attributes whose values will be generated, on the external
       system, and the value or values that will be applied to each attribute.
      </p><p>
       OpenIDM uses the <code class="literal">"assignments"</code> property to keep
       assigned roles up to date.
      </p></li><li class="listitem"><p>
       <code class="literal">"assignmentOperation"</code> and
       <code class="literal">"unassignmentOperation"</code>
      </p><p>
       When you update a role definition by adding, updating, or removing an
       attribute, the update triggers an <code class="literal">"assignmentOperation"</code>
       or an <code class="literal">"unassignmentOperation"</code>.
      </p><p>
       When you assign or unassign a role to a user, that action also triggers
       an <code class="literal">"assignmentOperation"</code> or an
       <code class="literal">"unassignmentOperation"</code>.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
         The <code class="literal">"assignmentOperation"</code> specifies the way in which
         the attribute value is applied, and can be one of
         <code class="literal">"replaceTarget"</code> (the default) or
         <code class="literal">"mergeWithTarget"</code>.
        </p><p>
         The <code class="literal">"replaceTarget"</code> operation replaces the entire
         target attribute value with whatever is specified in the role
         definition. When this operation is specified, the value from the role
         assignments becomes the only authoritative source for the attribute.
        </p><p>
         The <code class="literal">"mergeWithTarget"</code> operation first merges the
         source value with the existing target value, then adds the value or
         values from the role assignment. In the event that duplicate values are
         found (for attributes that take a list as a value), each value is
         included only once in the resulting target value.
        </p></li><li class="listitem"><p>
         The <code class="literal">"unassignmentOperation"</code> specifies the way in
         which the attribute value is removed, and can only be set to
         <code class="literal">"removeFromTarget"</code>.
        </p></li></ul></div><p>
       The <code class="literal">"mergeWithTarget"</code>, <code class="literal">"replaceTarget"</code>
       and <code class="literal">"removeFromTarget"</code> operations are aliases, and are
       defined in the file
       <code class="filename">openidm/bin/defaults/script/roles/defaultMapping.js</code>.
      </p></li><li class="listitem"><p>
       <code class="literal">"onAssignment"</code> and <code class="literal">"onUnassignment"</code>
      </p><p>
       These properties refer to customizable scripts, that are specific to each
       assignment.
      </p><p>
       By default, OpenIDM addresses any change in role assignments with the
       assignment operations defined in the
       <code class="filename">defaultMapping.js</code> file. You can modify this behavior
       by writing custom <code class="literal">onAssignment</code> and
       <code class="literal">onUnassignment</code> scripts. If these custom scripts are
       specified, OpenIDM triggers the <code class="literal">"onAssignment"</code> or
       <code class="literal">"onUnassignment"</code> script whenever you create, assign,
       or delete a role from a user entry. In addition, every synchronization
       operation triggers the <code class="literal">"onAssignment"</code> script. The
       <code class="literal">"onUnassignment"</code> script is triggered when an
       assignment is removed from a role, or when a role is unassigned from a
       user.
      </p><p>
       If you create a custom <code class="literal">"onAssignment"</code> or
       <code class="literal">"onUnassignment"</code> script, the script must return a
       <code class="literal">"targetObject"</code>, otherwise, the script operation might
       fail.
      </p></li></ul></div><p>
     OpenIDM logs any changes to a managed role definition in the audit log.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="roles-virtual-attributes"></a>8.3.2.2.&nbsp;Virtual Role Attributes</h4></div></div></div><p>
     Based on the set of role definitions that are assigned to a specific user,
     the roles mechanism generates two virtual attributes on the user entry -
     <code class="literal">effectiveRoles</code> and
     <code class="literal">effectiveAssignments</code>.
    </p><p>
     The logic that calculates the <code class="literal">effectiveRoles</code> and
     <code class="literal">effectiveAssignments</code> attribute values is located in two
     scripts:
     <code class="filename">openidm/bin/defaults/script/roles/effectiveRoles.js</code>
     and
     <code class="filename">openidm/bin/defaults/script/roles/effectiveAssignments.js</code>.
     Do not alter these scripts. If you need to modify how roles and assignments
     are handled, create your own custom script and reference it in the
     <code class="filename">conf/managed.json</code> file. For information about using
     custom scripts, see the
     <a href="../../integrators-guide/index/appendix-scripting.html" class="link"><em class="citetitle">Scripting
     Reference</em></a>.
    </p><p>
     The <code class="literal">effectiveRoles</code> attribute lists the specific role
     definitions that are applied to a user entry. By default, the effective
     roles script supports direct role assignments only. Dynamic role assignment
     is not provided out of the box, but can be added with a custom script that
     overrides the default <code class="filename">effectiveRoles.js</code> script. For
     more information, see <a class="xref" href="chap-users-groups-roles.html#dynamic-role-assignments" title="8.3.5.&nbsp;Adding Support for Dynamic Assignments">Section&nbsp;8.3.5, &#8220;Adding Support for Dynamic Assignments&#8221;</a>.
    </p><p>
     Based on the effective roles, the <code class="literal">effectiveAssignments</code>
     attribute provides the calculated resource assignments, that is the
     amalgamated set of entitlements for a specific user.
    </p><p>
     The value of the <code class="literal">effectiveAssignments</code> attribute provides
     the information required for the provisioner to apply the effective
     assignments, and provides a reference to the source of the assignment. In
     reading this attribute, it is therefore possible to find and change the
     root source of an assignment.
    </p><p>
     Effective assignments can merge attribute operations on the same system from
     multiple roles. For example, role A might add group A to a user's group
     membership list, and role B might add group B to the same group membership
     property on the same assigned system.
    </p><p>
     The effective roles and effective assignments attributes are configured in
    <code class="filename">openidm/conf/managed.json</code> as follows:
    </p><pre class="brush: java;">
 {
     "name" : "effectiveRoles",
     "type" : "virtual",
     "onRetrieve" : {
         "type" : "text/javascript",
         "file" : "roles/effectiveRoles.js",
         "rolesPropName" : "roles"
     }
 },
 {
     "name" : "effectiveAssignments",
     "type" : "virtual",
     "onRetrieve" : {
         "type" : "text/javascript",
         "file" : "roles/effectiveAssignments.js",
         "effectiveRolesPropName" : "effectiveRoles"
     }
 }
   </pre><p>
     By default, the <code class="filename">effectiveRoles.js</code> script uses the
     <code class="literal">"roles"</code> attribute of a user entry to determine the
     direct roles assigned to the user. The
     <code class="filename">effectiveAssignments.js</code> script uses the virtual
     <code class="literal">"effectiveRoles"</code> attribute of the user entry to calculate
     the user's effective assignments. If your deployment uses different
     attributes to store this information, change the
     <code class="literal">"rolesPropName"</code> and the
     <code class="literal">"effectiveRolesPropName"</code> properties of the virtual
     attribute definitions accordingly.
    </p><p>
     When a user entry is assigned a role, the <code class="literal">effectiveRoles</code>
     and <code class="literal">effectiveAssignments</code> of that entry are calculated
     according to the role definition. A managed user entry, whose roles have
     been generated based on the role definition illustrated previously, might
     appear as follows:
    </p><pre class="brush: javascript;">
 {
    "_id":"i",
    "_rev":"1",
    "roles":[
       "openidm-authorized",
       "managed/role/sample-role"
    ],
    "effectiveRoles":[
       "openidm-authorized",
       "managed/role/sample-role"
    ],
    "effectiveAssignments":{
       "ldap":{
          "attributes":[
             {
                "value":[
                   "CN=employees,O=corp"
                ],
                "operation":"replaceTarget",
                "name":"ldapGroups",
                "assignedThrough":"managed/role/sample-role"
             },
             {
                "value":"employee",
                "name":"employeeType",
                "assignedThrough":"managed/role/sample-role"
             }
          ]
       },
       "ad":{
          "attributes":[
             {
                "value":[
                   "CN=fileshare,O=corp",
                   "CN=desktop,O=corp",
                   "CN=terminal,O=corp",
                   "CN=intranet,O=corp"
                ],
                "operation":"replaceTarget",
                "name":"adSystems",
                "assignedThrough":"managed/role/sample-role"
             }
          ]
       }
    }
 }</pre><p>
    Note that the value of the <code class="literal">"assignedThrough"</code> property
    of the virtual <code class="literal">"effectiveAssignments"</code> attribute indicates
    how each assignment has been generated.
   </p><p>
     After you have defined a role, and assigned it to a user, verify that the
     expected effective roles and effective assignments have been generated for
     that user. To apply the effective assignments to the target resource, add a
     default mapping to your synchronization configuration, as described in the
     following section.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="role-mapping"></a>8.3.3.&nbsp;Setting up the Role Mapping</h3></div></div></div><p>
    After the role has been defined, and the effective assignments checked, you
    must set up mapping for the role and, optionally, restrict provisioning
    based on the effective assignments.
   </p><p>
    This section describes these two steps.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="roles-default-mapping"></a>8.3.3.1.&nbsp;Creating a Mapping For Effective Assignments</h4></div></div></div><p>
    After the effective assignments have been calculated, OpenIDM applies these
    assignments to the target resources.
   </p><p>
    The following sample extract of a <code class="filename">sync.json</code> file
    applies the <code class="literal">ldap</code> assignment, illustrated in the previous
    section, on the target resource (<code class="literal">system/ldap/account</code>) for
    all entries that have <code class="literal">"effectiveAssignments" : "ldap"</code> in
    the source.
   </p><pre class="brush: javascript;">
{
    "name" : "managedUser_systemLdapAccounts",
    "source" : "managed/user",
    "target" : "system/ldap/account",
    "links" : "systemLdapAccounts_managedUser",
    },
    "assignmentsToMap": [
        "ldap"
    ],
    ...
}   </pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="conditional-mapping"></a>8.3.3.2.&nbsp;Using Roles For Conditional Mapping</h4></div></div></div><p>
    The roles mechanism provides the ability to restrict provisioning based on
    a user's effective assignments. For example, you might want to prevent users
    from being provisioned to an Active Directory system, if they do not have
    specific access to that system.
   </p><p>
    Based on the <code class="literal">"effectiveAssignments"</code> virtual attribute,
    described in the previous section, you could configure a conditional mapping
    for this example, as follows:
   </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
      Create a role definition that gives the user the Active Directory
      assignment, for example:
     </p><pre class="brush: javascript;">
 "_id": "ad-role",
     "assignments": {
         "ad": {
             "attributes": [
                 {
                     "name": "adSystems",
                     "value": [
                         "CN=fileshare,O=corp",
                         "CN=desktop,O=corp",
                         "CN=terminal,O=corp",
                         "CN=intranet,O=corp"
                     ],
                     "assignmentOperation": "replaceTarget"
                 }
             ]
         }
     </pre></li><li class="listitem"><p>Add the role directly as a value of the user's
      <code class="literal">"roles"</code> attribute.</p><pre class="brush: plain;">
"roles" : [
    "name" : "managed/role/ad-role",
    "name" : "openidm-authorized"
]
     </pre></li><li class="listitem"><p>
      Add a condition in the mapping that restricts provisioning to users who
      have the <code class="literal">"ad"</code> assignment as an effective assignment.
      The effective assignments are calculated from the values in the user's
      <code class="literal">"roles"</code> attribute.
     </p><pre class="brush: java;">
{
    "mappings": [
        {
            "name": "managedUser_systemAdAccounts",
            "source": "managed/user",
            "sourceCondition": {
                "effectiveAssignments": "ad"
            },
            "target": "system/ad/account"
            ...
        }
    ]
}
     </pre></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-effective-roles"></a>8.3.4.&nbsp;Testing the Roles Mechanism</h3></div></div></div><div class="procedure"><p>
     The following sample procedure creates a new role that includes an
     assignment, adds that role to the user entry <code class="literal">bjensen</code> and
     then shows how bjensen's effective assignments have been generated.
    </p><ol class="procedure" type="1"><li class="step"><p>
      Create the role definition over REST.
     </p><p>
      This example uses a PUT request to create the role definition, so that we
      can specify the role <code class="literal">_id</code>. The example adds a role
      definition with the ID <code class="literal">ldap-role</code>. The role ID is used
      to assign the role directly to the user entry.
     </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --header "If-None-Match: *" \
 --request PUT \
 --data '{
  "assignments": {
    "ldap": {
      "attributes": [
        {
          "name": "ldapSystems",
          "value": [
            "cn=printers,ou=Groups,dc=example,dc=com",
            "cn=intranet,ou=Groups,dc=example,dc=com"
          ],
          "operation": "replaceTarget"
        }
      ]
    }
  }
}' \
 "https://localhost:8443/openidm/managed/role/ldap-role"</strong>
     <em>{
  "assignments": {
    "ldap": {
      "attributes": [
        {
          "name": "ldapSystems",
          "operation": "replaceTarget",
          "value": [
            "cn=printers,ou=Groups,dc=example,dc=com",
            "cn=intranet,ou=Groups,dc=example,dc=com"
          ]
        }
      ]
    }
  },
  "_id": "ldap-role",
  "_rev": "0"
}</em>
     </pre></div></li><li class="step"><p>
     The <code class="literal">ldap-role</code> includes one assignment, named
     <code class="literal">ldap</code>. Add a mapping for the assignment, by adding the
     following lines to your <code class="literal">sync.json</code> file:
    </p><pre class="brush: javascript;">
    "mappings":[
        "assignmentsToMap":[
            "ldap"
        ],
    ]</pre><p>
      By default, OpenIDM addresses any change in role assignments with the
      assignment operations defined in the
      <code class="filename">defaultMapping.js</code> file. You can modify this behavior
      by writing custom <code class="literal">onAssignment</code> and
      <code class="literal">onUnassignment</code> scripts.
     </p></li><li class="step"><p>
      Assign the role to user <code class="literal">bjensen</code>, whose ID is
      <code class="literal">2e78fd22-a7cb-4585-9570-5f649e8abd25</code>.
     </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --header "If-Match: *" \
 --request PATCH \
 --data '[
    {
        "operation": "replace",
        "field": "/roles",
        "value": [
            "openidm-authorized",
            "managed/role/ldap-role"
        ]
    }
]' \
 "https://localhost:8443/openidm/managed/user/2e78fd22-a7cb-4585-9570-5f649e8abd25"</strong>
     <em>{
    "mail": "bjensen@example.com",
    "sn": "Jensen",
    "passwordAttempts": "0",
    "address2": "",
    "lastPasswordAttempt": "Thu October 23 2014 12:49:32 GMT+0200 (SAST)",
    "givenName": "Barbara",
    "city": "",
    "country": "",
    "_rev": "2",
    "lastPasswordSet": "",
    "postalCode": "",
    "_id": "2e78fd22-a7cb-4585-9570-5f649e8abd25",
    "accountStatus": "active",
    "description": "Created for OpenIDM",
    "roles": [
        "openidm-authorized",
        "managed/role/ldap-role"
    ],
    "telephoneNumber": "1-360-229-7105",
    "postalAddress": "",
    "userName": "bjensen",
    "stateProvince": "",
    "displayName": "Babara Jensen"
}</em>
     </pre></div></li><li class="step"><p>
      Query <code class="literal">bjensen's</code> user entry to verify that her
      effective assignments have been updated.
     </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/managed/user/2e78fd22-a7cb-4585-9570-5f649e8abd25"</strong>
      <em>...
{
  "effectiveAssignments": {
    "ldap": {
      "attributes": [
        {
          "assignedThrough": "managed/role/ldap-role",
          "name": "ldapSystems",
          "operation": "replaceTarget",
          "value": [
            "cn=printers,ou=Groups,dc=example,dc=com",
            "cn=intranet,ou=Groups,dc=example,dc=com"
          ]
        }
      ]
    }
  },
  ...</em>
     </pre></div><p>
      Note that bjensen's effective assignments have been updated to include the
      assignments provided by the <code class="literal">ldap-role</code> role.
     </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-role-assignments"></a>8.3.5.&nbsp;Adding Support for Dynamic Assignments</h3></div></div></div><p>
    Although support for dynamic role assignments is not provided by default,
    it can easily be added with a custom script, as follows.
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
       Copy the default effective roles script to your project's
       <code class="literal">script/roles</code> directory.
      </p><div class="screen"><pre>
$ cp /path/to/openidm/bin/defaults/script/roles/effectiveRoles.js \
      <em><strong>project-dir</strong></em>/script/roles/
     </pre></div><p>
       The new script will override the default effective roles script.
      </p></li><li class="step"><p>
       Modify the effective roles script to include the dynamic role assignment
       logic.
      </p><p>
       For example, to enable dynamic role assignment for the
       <code class="literal">example</code> organization, you might add the following
       extract after the section:
      </p><pre class="brush: java;">
 // This is the location to expand to dynamic roles,
 // project role script return values can then be added via
 // effectiveRoles = effectiveRoles.concat(dynamicRolesArray);
     </pre><pre class="brush: java;">
 if (object.org === 'example') {
     effectiveRoles = effectiveRoles.concat(['dynamic-role1', 'dynamic-role2']);
 }
     </pre></li><li class="step"><p>
       To apply changes to the dynamic assignment rules to existing users, run a
       reconciliation operation on those users.
      </p></li></ol></div><p>
     Note that changes to dynamic role assignments for existing users require a
     manual reconciliation of the affected group of users for those changes to
     take effect. So, if a new dynamic role definition is created, if an
     existing dynamic role definition is changed, or if changes are made to the
     dynamic assignment rule, the group of users affected by that assignment
     rule must be reconciled manually.
    </p><p>
     When a user entry is changed or synchronized, however, all dynamic role
     assignments are reassessed automatically.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="managed-role-script-hooks"></a>8.3.6.&nbsp;Managed Role Object Script Hooks</h3></div></div></div><p>
     In addition to the functionality provided by the assignments, a managed
     role object has script hooks that enable you to configure role behavior.
     The managed role object has the following structure in the managed objects
     configuration file (<code class="filename">managed.json</code>):
    </p><pre class="brush: javascript;">{
     "name" : "role",
     "postCreate" : {
         "type" : "text/javascript",
         "file" : "roles/update-users-of-role.js"
     },
     "postUpdate" : {
         "type" : "text/javascript",
         "file" : "roles/update-users-of-role.js"
     },
     "postDelete" : {
         "type" : "text/javascript",
         "file" : "roles/update-users-of-role.js"
     }
}</pre><p>
     The <code class="literal">"postCreate"</code>, <code class="literal">"postUpdate"</code>, and
     <code class="literal">"postDelete"</code> properties enable you to specify what
     should happen when a role definition is created, updated, or deleted. By
     default, the <code class="filename">update-users-of-role.js</code> script runs in
     each of these cases.
    </p><p>
     The <code class="filename">update-users-of-role.js</code> script includes a
     <code class="literal">triggerSyncCheck</code> attribute, which reviews the
     <code class="literal">effectiveRoles</code> and <code class="literal">effectiveAssignments</code>
     virtual attributes, to determine whether OpenIDM should run a
     synchronization operation on these attributes.
    </p><p>
     This script iterates over all managed users, locates the users who have
     been assigned this role, and regenerates their effective assignments on the
     target resource. So, for example, if the role <code class="literal">"ldap"</code>
     gives a user an assignment on the resource "Active Directory", when that
     role definition is changed, a reconciliation operation runs to update the
     assignment for that user on the "Active Directory" resource.
    </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-data.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-policies.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;7.&nbsp;Accessing Data Objects&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;9.&nbsp;Using Policies to Validate Data</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10020&components=10164&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>