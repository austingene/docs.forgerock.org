<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;12.&nbsp;Scheduling Tasks and Events</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenIDM Integrator's Guide"><link rel="up" href="index.html" title="OpenIDM Integrator's Guide"><link rel="prev" href="chap-synchronization.html" title="Chapter&nbsp;11.&nbsp;Configuring Synchronization"><link rel="next" href="chap-passwords.html" title="Chapter&nbsp;13.&nbsp;Managing Passwords"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;12.&nbsp;Scheduling Tasks and Events</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-synchronization.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-passwords.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-scheduler-conf"></a>Chapter&nbsp;12.&nbsp;Scheduling Tasks and Events</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-scheduler-conf.html#scheduler-configuration-file">12.1. Scheduler Configuration</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#persistent-schedules">12.2. Configuring Persistent Schedules</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#scheduler-examples">12.3. Schedule Examples</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#schedules-over-rest">12.4. Managing Schedules Over REST</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#task-scanner">12.5. Scanning Data to Trigger Tasks</a></span></dt></dl></div><a class="indexterm" name="d0e10750"></a><a class="indexterm" name="d0e10753"></a><p>OpenIDM enables you to schedule reconciliation and synchronization 
  tasks. You can also use scheduling to trigger scripts, collect and run 
  reports, trigger workflows, perform custom logging, and so forth.</p><p>OpenIDM supports <span class="command"><strong>cron</strong></span>-like syntax to schedule events
 and tasks, based on expressions supported by the Quartz Scheduler (bundled 
 with OpenIDM).</p><p>If you use configuration files to schedule tasks and events, you must 
 place the schedule files in the <code class="filename">openidm/conf</code> directory.
 By convention, OpenIDM uses file names of the form
 <code class="filename">schedule-<em class="replaceable"><code>schedule-name</code></em>.json</code>, 
 where <em class="replaceable"><code>schedule-name</code></em> is a logical name for the 
 scheduled operation, for example, 
 <code class="filename">schedule-reconcile_systemXmlAccounts_managedUser.json</code>. 
 There are several example schedule configuration files in the 
 <code class="filename">openidm/samples/schedules</code> directory.</p><p>You can configure OpenIDM to pick up changes to scheduled tasks and 
 events dynamically, during initialization and also at runtime. For more 
 information, see <a href="../../integrators-guide/index/chap-configuration.html#changing-configuration" class="link"><em class="citetitle">Changing the 
 Configuration</em></a>.</p><p>In addition to the fine-grained scheduling facility, you can perform a 
 scheduled batch scan for a specified date in OpenIDM data, and then 
 automatically execute a task when this date is reached. For more information, 
 see <a class="xref" href="chap-scheduler-conf.html#task-scanner" title="12.5.&nbsp;Scanning Data to Trigger Tasks">Section&nbsp;12.5, &#8220;Scanning Data to Trigger Tasks&#8221;</a>.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduler-configuration-file"></a>12.1.&nbsp;Scheduler Configuration</h2></div></div></div><a class="indexterm" name="d0e10796"></a><div class="itemizedlist"><p>
    Schedules are configured through JSON objects. The schedule configuration
    involves three files:
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The <code class="filename">openidm/conf/boot/boot.properties</code> file, where you
     can enable the execution of persistent schedules
    </p></li><li class="listitem"><p>
     The <code class="filename">openidm/conf/scheduler.json</code> file, that configures
     the overall scheduler service
    </p></li><li class="listitem"><p>
     One <code class="filename">openidm/conf/schedule-<em class="replaceable"><code>schedule-name</code></em>.json</code>
     file for each configured schedule
    </p></li></ul></div><p>
   In the boot properties configuration file
   (<code class="filename">openidm/conf/boot/boot.properties</code>),
   the instance type is standalone and persistent schedules are enabled by
   default:
  </p><pre class="brush: plain;">
# valid instance types for node include standalone, clustered-first, and clustered-additional
openidm.instance.type=standalone

# enables the execution of persistent schedulers
openidm.scheduler.execute.persistent.schedules=true
  </pre><p>
   The scheduler service configuration file
   (<code class="filename">openidm/conf/scheduler.json</code>) governs the configuration
   for a specific scheduler instance, and has the following format:
  </p><pre class="brush: javascript;">
{
 "threadPool" : {
     "threadCount" : "10"
 },
 "scheduler" : {
     "executePersistentSchedules" : "&amp;{openidm.scheduler.execute.persistent.schedules}"
 }
}
  </pre><div class="itemizedlist"><p>The properties in the <code class="filename">scheduler.json</code> file relate 
   to the configuration of the Quartz Scheduler.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">threadCount</code> specifies the maximum number of 
     threads that are available for the concurrent execution of scheduled 
     tasks.</p></li><li class="listitem"><p><code class="literal">executePersistentSchedules</code> allows you to disable 
     persistent schedule execution for a specific node. If this parameter is 
     set to <code class="literal">false</code>, the Scheduler Service will support the 
     management of persistent schedules (CRUD operations) but it will not 
     execute any persistent schedules. The value of this property can be a 
     string or boolean and is <code class="literal">true</code> by default.</p></li><li class="listitem"><p><code class="literal">advancedProperties</code> (optional) enables you to 
     configure additional properties for the Quartz Scheduler.</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>
    In clustered environments, the scheduler service obtains an
    <code class="literal">instanceID</code> and checkin and timeout settings from the
    cluster management service (defined in the
    <code class="filename">openidm/conf/cluster.json</code> file). This
    behavior differs from OpenIDM 2.1.0 (in which the scheduler service
    specified the instance ID and checkin and timeout settings). Therefore, if
    you used the scheduler service in OpenIDM 2.1.0, you will need to migrate
    any reference to assigned instance IDs, allowing them to be provided by the
    cluster management service.
   </p></div><p>For details of all the configurable properties for the Quartz Scheduler, 
  see the <a class="link" href="http://www.quartz-scheduler.org/documentation/quartz-2.1.x/configuration/ConfigMain" target="_blank"><em class="citetitle">Quartz Scheduler Configuration Reference</em></a>.</p><p>Each schedule configuration file, <code class="filename">openidm/conf/schedule-
  <em class="replaceable"><code>schedule-name</code></em>.json</code> has the following 
  format:</p><pre class="brush: javascript;">
{
 "enabled"             : true,
 "persisted"           : false,
 "concurrentExecution" : false,
 "type"                : "cron",
 "startTime"           : "(optional) time",
 "endTime"             : "(optional) time",
 "schedule"            : "cron expression",
 "misfirePolicy"       : "optional, string",
 "timeZone"            : "(optional) time zone",
 "invokeService"       : "service identifier",
 "invokeContext"       : "service specific context info",
 "invokeLogLevel"      : "(optional) debug"
}</pre><div class="variablelist"><p>The schedule configuration properties are defined as follows:</p><dl class="variablelist"><dt><span class="term">enabled</span></dt><dd><p>Set to <code class="literal">true</code> to enable the schedule. When this 
    property is set to <code class="literal">false</code>, OpenIDM considers the 
    schedule configuration dormant, and does not allow it to be triggered or
    executed.</p><p>If you want to retain a schedule configuration, but do not want it 
    used, set <code class="literal">enabled</code> to <code class="literal">false</code> for task 
    and event schedulers, instead of changing the configuration or 
    <span class="command"><strong>cron</strong></span> expressions.</p></dd><dt><span class="term">persisted (optional)</span></dt><dd><p>
     Specifies whether the schedule state should be persisted or stored in RAM.
     Boolean (<code class="literal">true</code> or <code class="literal">false</code>),
     <code class="literal">false</code> by default.
    </p><p>
     In a clustered environment, this property must be set to <code class="literal">true</code>
     to have the schedule fire only once across the cluster. For more
     information, see <a class="xref" href="chap-scheduler-conf.html#persistent-schedules" title="12.2.&nbsp;Configuring Persistent Schedules">Section&nbsp;12.2, &#8220;Configuring Persistent Schedules&#8221;</a>.
    </p></dd><dt><span class="term">concurrentExecution</span></dt><dd><p>Specifies whether multiple instances of the same schedule can run
      concurrently. Boolean (<code class="literal">true</code> or <code class="literal">false</code>),
      <code class="literal">false</code> by default. Multiple instances of the same
      schedule cannot run concurrently by default. This setting prevents a new
      scheduled task from being launched before the same previously launched
      task has completed. For example, under normal circumstances you would
      want a liveSync operation to complete its execution before the same
      operation was launched again. To enable concurrent execution of multiple
      schedules, set this parameter to <code class="literal">true</code>. The behavior of
      "missed" scheduled tasks is governed by the <a class="xref" href="chap-scheduler-conf.html#misfire-policy">misfirePolicy</a>.</p></dd><dt><span class="term">type</span></dt><dd><p>Currently OpenIDM supports only <code class="literal">cron</code>.</p></dd><dt><span class="term">startTime (optional)</span></dt><dd><p>Used to start the schedule at some time in the future. If this 
    parameter is omitted, empty, or set to a time in the past, the task or 
    event is scheduled to start immediately.</p><p>Use ISO 8601 format to specify times and dates (<code class="literal"><em class="replaceable"><code>
    YYYY</code></em>-<em class="replaceable"><code>MM</code></em>-<em class="replaceable"><code>DD
    </code></em>T<em class="replaceable"><code>hh</code></em>:<em class="replaceable"><code>mm
    </code></em>:<em class="replaceable"><code>ss</code></em></code>).</p></dd><dt><span class="term">endTime (optional)</span></dt><dd><p>Used to plan the end of scheduling.</p></dd><dt><span class="term">schedule</span></dt><dd><p>Takes <span class="command"><strong>cron</strong></span> expression syntax. For more information, 
    see the <a class="link" href="http://www.quartz-scheduler.org/docs/tutorials/crontrigger.html" target="_blank"><em class="citetitle">CronTrigger Tutorial</em></a> and <a class="link" href="http://www.quartz-scheduler.org/docs/tutorial/TutorialLesson06.html" target="_blank"><em class="citetitle">Lesson 6: CronTrigger</em></a>.</p></dd><dt><span class="term"><a name="misfire-policy"></a>misfirePolicy</span></dt><dd><p>For persistent schedules, this optional parameter specifies the
    behavior if the scheduled task is missed, for some reason. Possible values
    are as follows:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">fireAndProceed</code>. The first execution 
     of a missed schedule is immediately executed when the server is back 
     online. Subsequent executions are discarded. After this, the normal 
     schedule is resumed.</p></li><li class="listitem"><p><code class="literal">doNothing</code>, all missed schedules are 
     discarded and the normal schedule is resumed when the server is back 
     online.</p></li></ul></div></dd><dt><span class="term">timeZone (optional)</span></dt><dd><p>If not set, OpenIDM uses the system time zone.</p></dd><dt><span class="term">invokeService</span></dt><dd><p>Defines the type of scheduled event or action. The value of this 
    parameter can be one of the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">"sync"</code> for reconciliation</p></li><li class="listitem"><p><code class="literal">"provisioner"</code> for LiveSync</p></li><li class="listitem"><p><code class="literal">"script"</code> to call some other scheduled 
       operation defined in a script</p></li></ul></div></dd><dt><span class="term">invokeContext</span></dt><dd><p>Specifies contextual information, depending on the type of scheduled 
    event (the value of the <code class="literal">invokeService</code> parameter).
    </p><p>The following example invokes reconciliation.</p><pre class="brush: javascript;">
{
    "invokeService": "sync",
    "invokeContext": {
        "action": "reconcile",
        "mapping": "systemLdapAccount_managedUser"
    }
}</pre><div class="itemizedlist"><p>For a scheduled reconciliation task, you can define the mapping 
   in one of two ways:</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Reference a mapping by its name in <code class="filename">sync.json</code>,
    as shown in the previous example. The mapping must exist in the
    <code class="filename">openidm/conf/sync.json</code> file.</p></li><li class="listitem"><p>Add the mapping definition inline by using the
    <code class="literal">"mapping"</code> property, as shown in the example in
    <a href="../../integrators-guide/index/chap-synchronization.html#alternative-mapping" class="link"><em class="citetitle">Alternative
    Mappings</em></a>.</p></li></ul></div><p>The following example invokes a LiveSync action.</p><pre class="brush: javascript;">
{
    "invokeService": "provisioner",
    "invokeContext": {
        "action": "liveSync",
        "source": "system/OpenDJ/__ACCOUNT__"
    }
}</pre><p>For scheduled LiveSync tasks, the <code class="literal">"source"</code> property 
  follows OpenIDM's convention for a pointer to an external resource object 
  and takes the form <code class="literal">system/<em class="replaceable"><code>resource-name</code></em>
  /<em class="replaceable"><code>object-type</code></em></code>.</p><p>The following example invokes a script, which prints the string 
  <code class="literal">Hello World</code> to the OpenIDM log 
  (<code class="filename">/openidm/logs/openidm0.log.X</code>).</p><pre class="brush: javascript;">
{
    "invokeService": "script",
    "invokeContext": {
        "script": {
            "type": "text/javascript",
            "source": "java.lang.System.out.println('Hello World');"
        }
    }
}</pre><p>Note that these are sample configurations only. Your own schedule 
    configuration will differ according to your specific requirements.</p></dd><dt><span class="term">invokeLogLevel (optional)</span></dt><dd><p>Specifies the level at which the invocation will be logged. 
    Particularly for schedules that run very frequently, such as LiveSync, the 
    scheduled task can generate significant output to the log file, and the log 
    level should be adjusted accordingly. The default schedule log level is 
    <code class="literal">info</code>. The value can be set to any one of the <a class="link" href="http://www.slf4j.org/apidocs/org/apache/commons/logging/Log.html" target="_top">SLF4J</a> 
    log levels:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">"trace"</code></p></li><li class="listitem"><p><code class="literal">"debug"</code></p></li><li class="listitem"><p><code class="literal">"info"</code></p></li><li class="listitem"><p><code class="literal">"warn"</code></p></li><li class="listitem"><p><code class="literal">"error"</code></p></li><li class="listitem"><p><code class="literal">"fatal"</code></p></li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="persistent-schedules"></a>12.2.&nbsp;Configuring Persistent Schedules</h2></div></div></div><p>By default, scheduling information, such as schedule state and details 
  of the schedule execution, is stored in RAM. This means that such 
  information is lost when OpenIDM is rebooted. The schedule configuration 
  itself (defined in the <code class="filename">openidm/conf/schedule-
  <em class="replaceable"><code>schedule-name</code></em>.json</code> file) is not lost 
  when OpenIDM is shut down, and normal scheduling continues when the server is 
  restarted. However, there are no details of missed schedule executions that 
  should have occurred during the period the server was unavailable.</p><p>You can configure schedules to be persistent, which means that the 
  scheduling information is stored in the internal repository rather than in 
  RAM. With persistent schedules, scheduling information is retained when OpenIDM 
  is shut down. Any previously scheduled jobs can be rescheduled automatically 
  when OpenIDM is restarted.</p><p>Persistent schedules also enable you to manage scheduling across a 
  cluster (multiple OpenIDM instances). When scheduling is persistent, a 
  particular schedule will be executed only once across the cluster, rather than 
  once on every OpenIDM instance. For example, if your deployment includes a 
  cluster of OpenIDM nodes for high availability, you can use persistent 
  scheduling to start a reconciliation action on only one node in the cluster, 
  instead of starting several competing reconciliation actions on each node.</p><p>You can use persistent schedules with the default OrientDB repository, 
  or with the MySQL repository (see <a href="../../install-guide/index/chap-repository.html" class="link"><em class="citetitle">Installing a 
    Repository For Production</em></a>).
  </p><p>To configure persistent schedules, set the <code class="literal">"persisted"</code> 
  property to <code class="literal">true</code> in the schedule configuration file 
  (<code class="filename">schedule-<em class="replaceable"><code>schedule-name</code></em>.json)</code>.
  </p><p>If OpenIDM is down when a scheduled task was set to occur, one or more 
  executions of that schedule might be missed. To specify what action should be 
  taken if schedules are missed, set the <code class="literal">misfirePolicy</code> in the 
  schedule configuration file. The <code class="literal">misfirePolicy</code> determines 
  what OpenIDM should do if scheduled tasks are missed. Possible values are as 
  follows:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">fireAndProceed</code>. The first execution of 
     a missed schedule is immediately executed when the server is back online. 
     Subsequent executions are discarded. After this, the normal schedule is 
     resumed.</p></li><li class="listitem"><p><code class="literal">doNothing</code>. All missed schedules are 
     discarded and the normal schedule is resumed when the server is back 
     online.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduler-examples"></a>12.3.&nbsp;Schedule Examples</h2></div></div></div><a class="indexterm" name="d0e11245"></a><p>The following example shows a schedule for reconciliation that
  is not enabled. When enabled (<code class="literal">"enabled" : true,</code>),
  reconciliation runs every 30 minutes, starting on the hour.</p><pre class="brush: javascript;">
{
    "enabled": false,
    "persisted": false,
    "type": "cron",
    "schedule": "0 0/30 * * * ?",
    "invokeService": "sync",
    "invokeContext": {
        "action": "reconcile",
        "mapping": "systemLdapAccounts_managedUser"
    }
}</pre><p>The following example shows a schedule for LiveSync enabled to run 
  every 15 seconds, starting at the beginning of the minute. The schedule is 
  persisted, that is, stored in the internal repository rather than in memory. 
  If one or more LiveSync executions are missed, as a result of OpenIDM being 
  unavailable, the first execution of the LiveSync action is executed when the 
  server is back online. Subsequent executions are discarded. After this, the 
  normal schedule is resumed.</p><pre class="brush: javascript;">{
    "enabled": false,
    "persisted": true,
    "misfirePolicy" : "fireAndProceed",
    "type": "cron",
    "schedule": "0/15 * * * * ?",
    "invokeService": "provisioner",
    "invokeContext": {
        "action": "liveSync",
        "source": "system/ldap/account"
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="schedules-over-rest"></a>12.4.&nbsp;Managing Schedules Over REST</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-scheduler-conf.html#creating-schedules">12.4.1. Creating a Schedule</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#schedule-details">12.4.2. Obtaining the Details of a Schedule</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#updating-schedules">12.4.3. Updating a Schedule</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#listing-schedules">12.4.4. Listing Configured Schedules</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#deleting-schedules">12.4.5. Deleting a Schedule</a></span></dt></dl></div><p>
   OpenIDM exposes the scheduler service under the
   <code class="literal">/openidm/scheduler</code> context path. The following examples
   show how schedules can be created, read, updated, and deleted, over REST,
   like any other object.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="creating-schedules"></a>12.4.1.&nbsp;Creating a Schedule</h3></div></div></div><p>
    You can create a schedule with a PUT request, which allows you to specify
    the ID of the schedule, or with a POST request, in which case the server
    assigns an ID automatically.
   </p><p>
    The following example uses a PUT request to create a schedule that fires a
    script (<code class="filename">script/testlog.js</code>) every second. The schedule
    configuration is as described in <a class="xref" href="chap-scheduler-conf.html#scheduler-configuration-file" title="12.1.&nbsp;Scheduler Configuration">Section&nbsp;12.1, &#8220;Scheduler Configuration&#8221;</a>.
   </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request PUT \
 --data '{
    "enabled":true,
    "type":"cron",
    "schedule":"0/1 * * * * ?",
    "persisted":true,
    "misfirePolicy":"fireAndProceed",
    "invokeService":"script",
    "invokeContext": {
        "script": {
            "type":"text/javascript",
            "file":"script/testlog.js"
        }
    }
 }' \
 "https://localhost:8443/openidm/scheduler/testlog-schedule"</strong>
<em>{
  "type": "cron",
  "invokeService": "script",
  "persisted": true,
  "_id": "testlog-schedule",
  "schedule": "0/1 * * * * ?",
  "misfirePolicy": "fireAndProceed",
  "enabled": true,
  "invokeContext": {
    "script": {
      "file": "script/testlog.js",
      "type": "text/javascript"
    }
  }
}</em></pre></div><p>
    The following example uses a POST request to create an identical schedule to
    the one created in the previous example, but with a server-assigned ID.
   </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request POST \
 --data '{
    "enabled":true,
    "type":"cron",
    "schedule":"0/1 * * * * ?",
    "persisted":true,
    "misfirePolicy":"fireAndProceed",
    "invokeService":"script",
    "invokeContext": {
        "script": {
            "type":"text/javascript",
            "file":"script/testlog.js"
        }
    }
 }' \
 "https://localhost:8443/openidm/scheduler?_action=create"</strong>
<em>{
  "type": "cron",
  "invokeService": "script",
  "persisted": true,
  "_id": "d6d1b256-7e46-486e-af88-169b4b1ad57a",
  "schedule": "0/1 * * * * ?",
  "misfirePolicy": "fireAndProceed",
  "enabled": true,
  "invokeContext": {
    "script": {
      "file": "script/testlog.js",
      "type": "text/javascript"
    }
  }
}</em></pre></div><p>
    The output includes the <code class="literal">_id</code> of the schedule, in this case
    <code class="literal">"_id": "d6d1b256-7e46-486e-af88-169b4b1ad57a"</code>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="schedule-details"></a>12.4.2.&nbsp;Obtaining the Details of a Schedule</h3></div></div></div><p>
    The following example displays the details of the schedule created in the
    previous section. Specify the schedule ID in the URL.
   </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/scheduler/d6d1b256-7e46-486e-af88-169b4b1ad57a"</strong>
<em>{
  "_id": "d6d1b256-7e46-486e-af88-169b4b1ad57a",
  "schedule": "0/1 * * * * ?",
  "misfirePolicy": "fireAndProceed",
  "startTime": null,
  "invokeContext": {
    "script": {
      "file": "script/testlog.js",
      "type": "text/javascript"
    }
  },
  "enabled": true,
  "concurrentExecution": false,
  "persisted": true,
  "timeZone": null,
  "type": "cron",
  "invokeService": "org.forgerock.openidm.script",
  "endTime": null,
  "invokeLogLevel": "info"
}</em></pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="updating-schedules"></a>12.4.3.&nbsp;Updating a Schedule</h3></div></div></div><p>
    To update a schedule definition, use a PUT request and update all properties
    of the object. Note that PATCH requests are currently supported only for
    managed objects. The following example disables the schedule created in the
    previous section.
   </p><div class="screen"><pre>$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request PUT \
 --data '{
    "enabled":false,
    "type":"cron",
    "schedule":"0/1 * * * * ?",
    "persisted":true,
    "misfirePolicy":"fireAndProceed",
    "invokeService":"script",
    "invokeContext": {
        "script": {
            "type":"text/javascript",
            "file":"script/testlog.js"
        }
    }
 }' \
 "https://localhost:8443/openidm/scheduler/d6d1b256-7e46-486e-af88-169b4b1ad57a"</strong>
   <em>null</em></pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="listing-schedules"></a>12.4.4.&nbsp;Listing Configured Schedules</h3></div></div></div><p>
    To display a list of all configured schedules, query the
    <code class="literal">openidm/scheduler</code> context path as shown in the following
    example:
   </p><div class="screen"><pre>$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/scheduler?_queryId=query-all-ids"</strong>
<em>{
  "remainingPagedResults": -1,
  "pagedResultsCookie": null,
  "resultCount": 2,
  "result": [
    {
      "_id": "d6d1b256-7e46-486e-af88-169b4b1ad57a"
    },
    {
      "_id": "recon"
    }
  ]
}</em></pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="deleting-schedules"></a>12.4.5.&nbsp;Deleting a Schedule</h3></div></div></div><p>
    To deleted a configured schedule, call a DELETE request on the schedule ID.
    For example:
   </p><div class="screen"><pre>$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request DELETE \
 "https://localhost:8443/openidm/scheduler/d6d1b256-7e46-486e-af88-169b4b1ad57a"</strong>
<em>null</em></pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="task-scanner"></a>12.5.&nbsp;Scanning Data to Trigger Tasks</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-scheduler-conf.html#task-scanner-config">12.5.1. Configuring the Task Scanner</a></span></dt><dt><span class="section"><a href="chap-scheduler-conf.html#task-scanner-rest">12.5.2. Managing Scanning Tasks Over REST</a></span></dt></dl></div><p>
   In addition to the fine-grained scheduling facility described previously,
   OpenIDM provides a task scanning mechanism. The task scanner enables you to
   perform a batch scan on a specified property in OpenIDM, at a scheduled
   interval, and then to execute a task when the value of that property matches
   a specified value.
  </p><p>
   When the task scanner identifies a condition that should trigger the task, it
   can invoke a script created specifically to handle the task.
  </p><p>
   For example, the task scanner can scan all <code class="literal">managed/user</code>
   objects for a "sunset date" and can invoke a script that executes a "sunset
   task" on the user object when this date is reached.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="task-scanner-config"></a>12.5.1.&nbsp;Configuring the Task Scanner</h3></div></div></div><p>
   The task scanner is essentially a scheduled task that queries a set of
   managed users. The task scanner is configured in the same way as a regular
   scheduled task, in a schedule configuration file named
   (<code class="filename">schedule-<em class="replaceable"><code>task-name</code></em>.json)</code>,
   with the <code class="literal">"invokeService"</code> parameter set to
   <code class="literal">"taskscanner</code>. The <code class="literal">"invokeContext"</code>
   parameter defines the details of the scan, and the task that should be
   executed when the specified condition is triggered.
  </p><p>
   The following example defines a scheduled scanning task that triggers a
   sunset script. This sample configuration file is provided in the OpenIDM
   delivery as
   <code class="filename">openidm/samples/taskscanner/conf/schedule-taskscan_sunset.json</code>.
   To use this sample file, copy it to the <code class="filename">openidm/conf</code>
   directory. The sample file calls a script (<code class="filename">script/sunset.js</code>)
   which must be copied from <code class="filename">openidm/samples/taskscanner/script/sunset.js</code>
   to the <code class="filename">openidm/script</code> directory.
  </p><pre class="brush: javascript;">
{
    "enabled" : true,
    "type" : "cron",
    "schedule" : "0 0 * * * ?",
    "concurrentExecution" : false,
    "invokeService" : "taskscanner",
    "invokeContext" : {
        "waitForCompletion" : false,
        "maxRecords" : 2000,
        "numberOfThreads" : 5,
        "scan" : {
            "_queryId" : "scan-tasks",
            "property" : "sunset/date",
            "condition" : {
                "before" : "${Time.now}"
            },
            "taskState" : {
                "started" : "sunset/task-started",
                "completed" : "sunset/task-completed"
            },
            "recovery" : {
                "timeout" : "10m"
            }
        },
        "task" : {
            "script" : {
                "type" : "text/javascript",
                "file" : "script/sunset.js"
            }
        }
    }
}</pre><div class="variablelist"><p>
   The <code class="literal">"invokeContext"</code> parameter takes the following
   properties:
  </p><dl class="variablelist"><dt><span class="term"><code class="literal">"waitForCompletion"</code> (optional)</span></dt><dd><p>
     This property specifies whether the task should be performed synchronously.
     Tasks are performed asynchronously by default (with
     <code class="literal">waitForCompletion</code> set to false). A task ID (such as
     <code class="literal">{"_id":"354ec41f-c781-4b61-85ac-93c28c180e46"}</code>) is
     returned immediately. If this property is set to true, tasks are performed
     synchronously and the ID is not returned until all tasks have completed.
    </p></dd><dt><span class="term"><code class="literal">"maxRecords"</code> (optional)</span></dt><dd><p>
     The maximum number of records that can be processed. This property is not
     set by default so the number of records is unlimited. If a maximum number
     of records is specified, that number will be spread evenly over the number
     of threads.
    </p></dd><dt><span class="term"><code class="literal">"numberOfThreads"</code> (optional)</span></dt><dd><p>
     By default, the task scanner runs in a multi-threaded manner, that is,
     numerous threads are dedicated to the same scanning task run.
     Multithreading generally improves the performance of the task scanner. The
     default number of threads for a single scanning task is ten. To change this
     default, set the <code class="literal">"numberOfThreads"</code> property.
    </p></dd><dt><span class="term"><code class="literal">"scan"</code></span></dt><dd><p>
     Defines the details of the scan. The following properties are defined:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">"object"</code></span></dt><dd><p>
        Defines the object type against which the query should be performed.
       </p></dd><dt><span class="term"><code class="literal">"_queryId"</code></span></dt><dd><p>
        Specifies the query that is performed. The queries that can be set here
        are defined in the database configuration file (either
        <code class="filename">conf/repo.orientdb.json</code> or
        <code class="filename">conf/repo.jdbc.json</code>).
       </p></dd><dt><span class="term"><code class="literal">"property"</code></span></dt><dd><p>
        Defines the property against which the query is performed.
       </p><p>
        If you are using a JDBC repository, with a generic mapping, you must
        explicitly set this property as searchable so that it can be queried by
        the task scanner. For more information, see <a href="../../install-guide/index/chap-repository.html#generic-mappings" class="link"><em class="citetitle">Using
        Generic Mappings</em></a> in the <em class="citetitle">Installation
        Guide</em>.
       </p></dd><dt><span class="term"><code class="literal">"condition"</code> (optional)</span></dt><dd><p>Indicates the conditions that must be matched for the defined 
       property.</p><p>In the previous example, the scanner scans for users for whom the 
       property <code class="literal">sunset/date</code> is set to a value prior to the 
       current timestamp at the time the script is executed.</p><p>You can use these fields to define any condition. For example, if 
       you wanted to limit the scanned objects to a specified location, say, 
       London, you could formulate a query to compare against object locations 
       and then set the condition to be:</p><pre class="brush: javascript;">
            "condition" : {
                "location" : "London"
            },</pre><p>For time-based conditions, the <code class="literal">"condition"</code> 
        property supports macro syntax, based on the <code class="literal">Time.now</code> 
        object (which fetches the current time). You can specify any date/time 
        in relation to the current time, using the <code class="literal">+</code> or 
        <code class="literal">-</code> operator, and a duration modifier. For example: 
        <code class="literal">"before": "${Time.now + 1d}"</code> would return all user 
        objects whose <code class="literal">sunset/date</code> is before tomorrow 
        (current time plus one day). You must include space characters around the 
        operator (<code class="literal">+</code> or <code class="literal">-</code>). The duration 
        modifier supports the following unit specifiers:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">s</code> - second</td></tr><tr><td><code class="literal">m</code> - minute</td></tr><tr><td><code class="literal">h</code> - hour</td></tr><tr><td><code class="literal">d</code> - day</td></tr><tr><td><code class="literal">M</code> - month</td></tr><tr><td><code class="literal">y</code> - year</td></tr></table></dd><dt><span class="term"><code class="literal">"taskState"</code></span></dt><dd><p>Indicates the fields that are used to track the status of the 
       task.</p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"started"</code> specifies the field that stores 
        the timestamp for when the task begins.</td></tr><tr><td><code class="literal">"completed"</code> specifies the field that stores 
        the timestamp for when the task completes its operation. The
        <code class="literal">"completed"</code> field is present as soon as the task has
        started, but its value is <code class="literal">null</code> until the task has
        completed.</td></tr></table></dd><dt><span class="term"><code class="literal">"recovery"</code> (optional)</span></dt><dd><p>Specifies a configurable timeout, after which the task scanner 
        process ends. In a scenario with clustered OpenIDM instances, there 
        might be more than one task scanner running at a time. A task 
        cannot be executed by two task scanners at the same time. When one 
        task scanner "claims" a task, it indicates that the task has been 
        started. That task is then unavailable to be claimed by another task 
        scanner and remains unavailable until the end of the task is indicated. 
        In the event that the first task scanner does not complete the task by 
        the specified timeout, for whatever reason, a second task scanner can 
        pick up the task.</p></dd></dl></div></dd><dt><span class="term"><code class="literal">"task"</code></span></dt><dd><p>Provides details of the task that is performed. Usually, 
   the task is invoked by a script, whose details are defined in the 
   <code class="literal">"script"</code> property:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"type"</code> - the type of script. Currently, only 
     JavaScript is supported.</td></tr><tr><td><code class="literal">"file"</code> - the path to the script file. The script 
     file takes at least two objects (in addition to the default objects that 
     are provided to all OpenIDM scripts): <code class="literal">"input"</code> which is 
     the individual object that is retrieved from the query (in the example, 
     this is the individual user object) and <code class="literal">"objectID"</code> 
     which is a string that contains the full identifier of the object. The 
     objectID is useful for performing updates with the script as it allows you 
     to target the object directly, for example: 
     <code class="literal">openidm.update(objectID, input['_rev'], input);</code>. A sample 
     script file is provided in <code class="filename">openidm/samples/taskscanner/script/sunset.js</code>. 
     To use this sample file, you must copy it to the <code class="filename">openidm/script</code> 
     directory. The sample script marks all user objects that match the 
     specified conditions as "inactive". You can use this sample script to 
     trigger a specific workflow, or any other task associated with the sunset 
     process. For more information about using scripts in OpenIDM, see the 
     <a href="../../integrators-guide/index/appendix-scripting.html" class="link">
     <em class="citetitle">Scripting Reference</em></a>.</td></tr></table></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="task-scanner-rest"></a>12.5.2.&nbsp;Managing Scanning Tasks Over REST</h3></div></div></div><p>You can trigger, cancel, and monitor scanning tasks over the REST 
   interface, using the REST endpoint 
   <code class="literal">https://localhost:8443/openidm/taskscanner</code>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="triggering-task-scanner"></a>12.5.2.1.&nbsp;Triggering a Scanning Task</h4></div></div></div><p>The following REST command executes a task named "taskscan_sunrise". 
    The task itself is defined in a file named 
    <code class="filename">openidm/conf/schedule-taskscan_sunset.json</code>.</p><div class="screen"><pre>
$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request POST \
 "https://localhost:8443/openidm/taskscanner?_action=execute&amp;name=schedule/taskscan_sunset"</strong>
   </pre></div><p>By default, a scanning task ID is returned immediately when the task 
   is initiated. Clients can make subsequent calls to the task scanner service, 
   using this task ID to query its state and to call operations on it.</p><p>For example, the scanning task initiated previously would return
    something similar to the following, as soon as it was initiated:</p><div class="screen"><pre>{"_id":"edfaf59c-aad1-442a-adf6-3620b24f8385"}</pre></div><p>To have the scanning task complete before the ID is returned, set the 
    <code class="literal">waitForCompletion</code> property to <code class="literal">true</code> 
    in the task definition file (<code class="filename">schedule-taskscan_sunset.json</code>). 
    You can also set the property directly over the REST interface when the task is 
    initiated. For example:</p><div class="screen"><pre>
$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request POST \
 "https://localhost:8443/openidm/taskscanner?_action=execute&amp;name=schedule/taskscan_sunset&amp;waitForCompletion=true"</strong>
    </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="canceling-task-scanner"></a>12.5.2.2.&nbsp;Canceling a Scanning Task</h4></div></div></div><p>You can cancel a scanning task by sending a REST call with the 
    <code class="literal">cancel</code> action, specifying the task ID. For example, the 
    following call cancels the scanning task initiated in the previous section.
    </p><div class="screen"><pre>
$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request POST \
 "https://localhost:8443/openidm/taskscanner/edfaf59c-aad1-442a-adf6-3620b24f8385?_action=cancel"</strong>
    </pre></div><p>The output for a scanning task cancellation request is similar to the
    following:</p><div class="screen"><pre>
    {"_id":"edfaf59c-aad1-442a-adf6-3620b24f8385",
     "action":"cancel",
     "status":"SUCCESS"}
    </pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="listing-task-scanner"></a>12.5.2.3.&nbsp;Listing Scanning Tasks</h4></div></div></div><p>
     You can display a list of scanning tasks that have completed, and
    those that are in progress, by running a RESTful GET on the
    <code class="literal">openidm/taskscanner"</code> context. The following example
     displays all scanning tasks.</p><div class="screen"><pre>
$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/taskscanner"</strong>
    </pre></div><p>The output of such a request is similar to the following, with one 
    item for each scanning task.</p><div class="screen"><pre>{
 "tasks": [
    {
      "ended": 1352455546182
      "started": 1352455546149,
      "progress": {
        "failures": 0
        "successes": 2400,
        "total": 2400,
        "processed": 2400,
        "state": "COMPLETED",
      },
      "_id": "edfaf59c-aad1-442a-adf6-3620b24f8385",
    }
  ]
}
    </pre></div><div class="variablelist"><p>Each scanning task has the following properties:</p><dl class="variablelist"><dt><span class="term"><code class="literal">ended</code></span></dt><dd><p>The time at which the scanning task ended.</p></dd><dt><span class="term"><code class="literal">started</code></span></dt><dd><p>The time at which the scanning task started.</p></dd><dt><span class="term"><code class="literal">progress</code></span></dt><dd><p>The progress of the scanning task, summarised in the following 
       fields:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">failures</code> - the number of records not able
        to be processed</td></tr><tr><td><code class="literal">successes</code> - the number of records processed
         successfully</td></tr><tr><td><code class="literal">total</code> - the total number of records</td></tr><tr><td><code class="literal">processed</code> - the number of processed records
        </td></tr><tr><td><code class="literal">state</code> - the overall state of the task,
         <code class="literal">INITIALIZED</code>, <code class="literal">ACTIVE</code>, <code class="literal">
          COMPLETED</code>, <code class="literal">CANCELLED</code>, or <code class="literal">
          ERROR</code>
        </td></tr></table></dd><dt><span class="term"><code class="literal">_id</code></span></dt><dd><p>The ID of the scanning task.</p></dd></dl></div><p>The number of processed tasks whose details are retained is governed 
    by the <code class="literal">"openidm.taskscanner.maxcompletedruns"</code> property 
    in the <code class="filename">conf/system.properties</code> file. By default, the 
    last one hundred completed tasks are retained.</p></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-synchronization.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-passwords.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;11.&nbsp;Configuring Synchronization&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;13.&nbsp;Managing Passwords</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10020&components=10164&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>