<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;13.&nbsp;Managing Passwords</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenIDM Integrator's Guide"><link rel="up" href="index.html" title="OpenIDM Integrator's Guide"><link rel="prev" href="chap-scheduler-conf.html" title="Chapter&nbsp;12.&nbsp;Scheduling Tasks and Events"><link rel="next" href="chap-auth.html" title="Chapter&nbsp;14.&nbsp;Managing Authentication, Authorization and Role-Based Access Control"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;13.&nbsp;Managing Passwords</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-scheduler-conf.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-auth.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-passwords"></a>Chapter&nbsp;13.&nbsp;Managing Passwords</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-passwords.html#enforce-password-policy">13.1. Enforcing Password Policy</a></span></dt><dt><span class="section"><a href="chap-passwords.html#password-sync">13.2. Password Synchronization</a></span></dt></dl></div><a class="indexterm" name="d0e11861"></a><p>OpenIDM provides password management features that help you enforce
 password policies, limit the number of passwords users must remember, and
 let users reset and change their passwords.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="enforce-password-policy"></a>13.1.&nbsp;Enforcing Password Policy</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-passwords.html#password-history">13.1.1. Creating a Password History Policy</a></span></dt></dl></div><p>A password policy is a set of rules defining what sequence of
  characters constitutes an acceptable password. Acceptable passwords generally
  are too complex for users or automated programs to generate or guess.</p><p>Password policies set requirements for password length, character sets
  that passwords must contain, dictionary words and other values that passwords
  must not contain. Password policies also require that users not reuse old
  passwords, and that users change their passwords on a regular basis.</p><a class="indexterm" name="d0e11873"></a><p>OpenIDM enforces password policy rules as part of the general policy 
  service. For more information about the policy service, see 
  <a href="../../integrators-guide/index/chap-policies.html" class="link">
  <em class="citetitle">Using Policies to Validate Data</em></a>. The default 
  password policy applies the following rules to passwords as they are created 
  and updated:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A password property is required for any user object.</p></li><li class="listitem"><p>The value of a password cannot be empty.</p></li><li class="listitem"><p>The password must include at least one capital letter.
    </p></li><li class="listitem"><p>The password must include at least one number.</p></li><li class="listitem"><p>The minimum length of a password is 8 characters.</p></li><li class="listitem"><p>The password cannot contain the user name, given name, or 
    family name.</p></li></ul></div><p>You can remove these validation requirements, or include additional 
  requirements, by configuring the policy for passwords. For more information, 
  see <a href="../../integrators-guide/index/chap-policies.html#configuring-default-policy" class="link">
  <em class="citetitle">Configuring the Default Policy</em></a>.</p><div class="variablelist"><p>The password validation mechanism can apply in many situations.</p><dl class="variablelist"><dt><span class="term">Password change and password reset</span></dt><dd><p>Password change involves changing a user or account password
     in accordance with password policy. Password reset involves setting a
     new user or account password on behalf of a user.</p><p>By default, OpenIDM controls password values as they are
     provisioned.</p><p>To change the default administrative user password,
     <code class="literal">openidm-admin</code>, see the procedure, <a href="../../integrators-guide/index/chap-security.html#security-replace-default-user-password" class="link"><em class="citetitle">To Replace the Default User and Password</em></a>,
     for instructions.</p></dd><dt><span class="term">Password recovery</span></dt><dd><p>Password recovery involves recovering a password or setting a new
     password when the password has been forgotten.</p><p>OpenIDM provides a self-service end user interface for password
     changes, password recovery, and password reset. For more information, see 
     <span class="olink">
     <em class="citetitle">Managing Passwords With the UI</em></span>.</p></dd><dt><span class="term">Password comparisons with dictionary words</span></dt><dd><p>You can add dictionary lookups to prevent use of password values
     that match dictionary words.</p></dd><dt><span class="term">Password history</span></dt><dd><p>
      You can add checks to prevent reuse of previous password values. For more
      information, see <a class="xref" href="chap-passwords.html#password-history" title="13.1.1.&nbsp;Creating a Password History Policy">Section&nbsp;13.1.1, &#8220;Creating a Password History Policy&#8221;</a>.
     </p></dd><dt><span class="term">Password expiration</span></dt><dd><p>You can configure OpenIDM to call a workflow that ensures users
     are able to change expiring or to reset expired passwords.</p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="password-history"></a>13.1.1.&nbsp;Creating a Password History Policy</h3></div></div></div><a class="indexterm" name="d0e11971"></a><p>
     To minimize password reuse, you can set up a password history policy.
     One way to do so is with a custom javascript file for the
     <code class="literal">onCreate</code> trigger. You can then add a reference
     to that javascript file in the <code class="filename">conf/managed.json</code> file.
    </p><p>
     You would then add a scripted policy in a custom javascript file,
     ready to be called out in appropriate JSON configuration files.
    </p><p>
     The following procedure retains a record of the last four passwords for
     each user. Any attempt to reuse one of those passwords is rejected.
    </p><p>
     This procedure takes advantage of the directories configured in
     the <code class="filename">conf/script.json</code> file. If you started
     OpenIDM with files in some <code class="filename">customconfig</code>
     subdirectory, you would need to make sure such files exist in
     that directory tree. For more information, see the section on <a href="../../integrators-guide/index/chap-configuration.html#config-default-directories" class="link">
     <em class="citetitle">Default and Custom Configuration Directories</em>.
     </a>
    </p><div class="procedure"><a name="create-password-array"></a><div class="procedure-title">Procedure&nbsp;13.1.&nbsp;Configuring Limits on Password History</div><ol class="procedure" type="1"><li class="step"><p>
      Create a custom <code class="literal">onCreate</code> javascript file. One
      way to do so is with a copy of the
      <code class="filename">onCreate-user-set-default-files.js</code> file in the
      <code class="filename">bin/defaults/script/ui</code> directory.
      You can save the custom file in the
      <code class="filename">script</code> directory. For example,
      the following commands create an
      <code class="filename">onCreate-user-custom.js</code> file in the default
      script directory defined in <code class="filename">conf/script.json</code>:
     </p><div class="screen"><pre>$ cd /path/to/openidm/bin/defaults/script/ui
$ cp onCreate-user-set-default-fields.js /path/to/openidm/script/onCreate-user-custom.js</pre></div></li><li class="step"><p>
      In the newly created custom Javascript file, include the cipher for
      password encryption:
     </p><div class="screen"><pre>var cipher = "AES/CBC/PKCS5Padding",
     alias = identityServer.getProperty("openidm.config.crypto.alias", "true", true);</pre></div></li><li class="step"><p>
      Next, declare a new
      <code class="literal">lastPass</code> attribute. For example, to prevent
      reuse of the last four passwords, you would add the following line:
     </p><div class="screen"><pre>object.lastPass = new Array(4);</pre></div></li><li class="step"><p>
      After the new array is declared, the following lines would increment
      the previous password:
     </p><div class="screen"><pre>if (object.password) {
    object.lastPass.shift();
    object.lastPass.push(object.password);
}</pre></div></li><li class="step"><p>
      Now create a new file with a script that increments passwords in the
      array with each new password. This procedure uses the following file name:
      <code class="filename">onUpdate-user-pwpolicy.js</code>, written to the same
      directory as the <code class="filename">onCreate-user-custom.js</code> file,
      in this case, <code class="filename">script</code>.
     </p></li><li class="step"><p>
      Add the following content to the newly created
      <code class="filename">onUpdate-user-pwpolicy.js</code> file:
     </p><div class="screen"><pre>/*global newObject, oldObject */
var cipher = "AES/CBC/PKCS5Padding",
  alias = identityServer.getProperty("openidm.config.crypto.alias", "true", true);

if (openidm.isEncrypted(newObject.lastPass)) {
  newObject.lastPass = openidm.decrypt(newObject.lastPass);
}

if (typeof newObject.lastPass === "undefined") {
  newObject.lastPass = new Array(4);
}

if (newObject.password !== oldObject.password) {
  newObject.lastPass.shift();
  newObject.lastPass.push(newObject.password);
}

newObject.lastPass = openidm.encrypt(newObject.lastPass, cipher, alias);
}</pre></div></li><li class="step"><p>
      In the existing <code class="filename">conf/managed.json</code> file, add
      appropriate lines that point to the files just created in the
      <code class="filename">script</code> directory. Given the
      default directories previously described in the <code class="filename">
      conf/script.json</code> file, you do not need to add a
      directory path to the newly created files. The following is
      an excerpt of the modified <code class="filename">conf/managed.json</code> file:
     </p><div class="screen"><pre>{
      "objects" : [
           "name" : "user"
           "onCreate" : {
                "type" : "text/javascript",
                "file" : "onCreate-user-custom.js"
           },
           "onUpdate" : {
                "type" : "text/javascript",
                "file" : "onUpdate-user-pwpolicy.js"
           },
           "onDelete" : {
                "type" : "text/javascript",
                "file" : "ui/onDelete-user-cleanup.js"
           },</pre></div></li><li class="step"><p>
      Now extend the policy service to all users by adding a scripted
      policy. One way to do so is by adding the following information to
      a custom javascript file. For this procedure, call that file
      <code class="filename">pwpolicy.js</code>, also in the <code class="filename">script</code>
      subdirectory.
     </p><p>
      As you can see from the comments to the file, it is designed to ignore new
      users, users without a password history, and users for whom passwords
      have not changed.
     </p><p>
      The last part of the file decrypts encrypted passwords prior to making
      the comparison, and makes sure the password has a non-zero length.
     </p><div class="screen"><pre>/*global addPolicy, request, openidm */

addPolicy({
  "policyId" : "is-new",
  "policyExec" : "isNew",
  "policyRequirements" : ["IS_NEW"]
});

function isNew(fullObject, value, params, property) {
  var currentObject, lastPass, i;

  // don't do a read if the resource ends with "/*", which indicates that
  // this is a create with a server-supplied id
  if (!request.resourceName || request.resourceName.match('/\\*$')) {
    return [];
  }

  currentObject = openidm.read(request.resourceName);

  // don't try this policy if the resource being evaluated wasn't found. Happens in the
  // case of a create with a client-supplied id.
  if (currentObject === null) {
    return [];
  }

  // don't try this policy is there is no history object available
  if (currentObject.lastPass === null || currentObject.lastPass === undefined) {
     return [];
  }

  if (currentObject[property] !== null &amp;&amp; currentObject[property] !== undefined &amp;&amp;
     openidm.isEncrypted(currentObject[property])) {
     currentObject[property] = openidm.decrypt(currentObject[property]);
  }

  // if the password hasn't changed, then we aren't interested in checking the history
  if (currentObject[property] === value) {
     return [];
  }

  if (openidm.isEncrypted(currentObject.lastPass)) {
     lastPass = openidm.decrypt(currentObject.lastPass);
  } else {
     lastPass = currentObject.lastPass;
  }

  for(i=0; i &lt; lastPass.length; i++) {
    if (lastPass[i] === value) {
      return [{"policyRequirement": "IS_NEW"}];
    }
  }
  return [];

}</pre></div></li><li class="step"><p>
      Now open the <code class="filename">conf/policy.json</code> file. Add
      the following lines to call the newly created
      <code class="filename">pwpolicy.js</code> script, right after
      the existing line that calls the <code class="filename">policy.js</code>
      script:
     </p><div class="screen"><pre>...
      "file" : "policy.js",
      "additionalFiles" :  [
          "script/pwpolicy.js"],
...</pre></div></li><li class="step"><p>
      Later in the same <code class="filename">conf/policy.json</code> file, in the
      <code class="literal">password</code> configuration block, add the newly created
      <code class="literal">is-new</code> <code class="literal">policyId</code>:
     </p><div class="screen"><pre>...
     {
          "name" : "password",
          "policies" : [
              {
                  "policyId" : "not-empty"
              },
              {
                  "policyId" : "is-new"
              },
...</pre></div></li><li class="step"><p>
      Reopen the <code class="filename">conf/managed.json</code> file. Add the following
      code to the <code class="literal">properties</code> section to encrypt the
      new <code class="literal">lastPass</code> attribute, and
      to prevent REST retrievals of such passwords:
     </p><div class="screen"><pre>...
      "properties" : [
          {
              "name" : "lastPass",
              "encryption" : {
                  "key" : "openidm-sym-default"
              },
              "scope" : "private"
          }
      ...</pre></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="password-sync"></a>13.2.&nbsp;Password Synchronization</h2></div></div></div><a class="indexterm" name="d0e12146"></a><p>
   Password synchronization intercepts user password changes, and ensures
   uniform password changes across resources that store the password. Following
   password synchronization, the user authenticates using the same password on
   each resource. No centralized directory or authentication server is required
   for performing authentication. Password synchronization reduces the number of
   passwords users need to remember, so they can use fewer, stronger passwords.
  </p><p>
   OpenIDM can propagate passwords to the resources that store a user's
   password, and can intercept and synchronize passwords that are changed
   natively in OpenDJ and Active Directory.
  </p><p>
   When you use password synchronization, set up password policy enforcement on
   OpenDJ or Active Directory rather than on OpenIDM. Alternatively, ensure that
   all password policies that are enforced are identical to prevent password
   updates on one resource from being rejected by OpenIDM or by another
   resource.
  </p><p>
   The password synchronization plugins intercept password changes on the
   resource before the passwords are stored in encrypted form. The plugins then
   send intercepted password values to OpenIDM over an encrypted channel.
  </p><p>
   In the event that the OpenIDM instance is unavailable when a password is
   changed, the plugin intercepts the change, encrypts the password, and stores
   the encrypted password in a JSON file. The plugin then checks whether the
   OpenIDM instance is available, at a predefined interval. When OpenIDM becomes
   available, the plugin performs a PATCH on the user record, to replace the
   password with the encrypted password stored in the JSON file.
  </p><p>
   To be able to synchronize the passwords, the plugin requires that the
   <code class="literal">managed/user</code> object exist in the OpenIDM repository. Users
   have typically been created by a reconciliation or liveSync process.
  </p><p>
   The OpenDJ password sync plugin is supported for OpenDJ versions 2.4.6, 2.5,
   and 2.6. The Active Directory password sync plugin is supported on Windows
   2003, Windows 2008 R2, and Windows 2012 R2.
  </p><p>
   The sample provided in
   <code class="filename">/path/to/openidm/samples/misc/managed.json</code> shows
   password synchronization between three systems - OpenIDM, OpenDJ, and Active
   Directory. The sample assumes that the following steps have been performed:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     You have set up OpenDJ and Active Directory.
    </p></li><li class="listitem"><p>
     The password attributes for the three systems are as follows:
    </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">ldapPassword</code> for OpenDJ</td></tr><tr><td><code class="literal">adPassword</code> for Active Directory</td></tr><tr><td><code class="literal">password</code> for the internal OpenIDM password</td></tr></table></li><li class="listitem"><p>
     You have installed the password synchronization plugins, as described in
     the following sections.
    </p></li></ul></div><div class="procedure"><a name="install-opendj-password-sync-plugin"></a><div class="procedure-title">Procedure&nbsp;13.2.&nbsp;To Install the OpenDJ Password Synchronization Plugin</div><a class="indexterm" name="d0e12199"></a><div class="itemizedlist"><p>
      Before you start:
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Make sure that OpenDJ is configured to communicate over LDAPS as
       described in the <a class="link" href="http://opendj.forgerock.org/doc/admin-guide/#chap-listeners" target="_blank">OpenDJ documentation</a>.
      </p></li><li class="listitem"><p>
       OpenIDM must be running.
      </p></li></ul></div><p>
    The following steps install the plugin on an OpenDJ directory server that is
    running on the same host as OpenIDM. If you run OpenDJ on a different host,
    use the fully qualified domain name rather than
    <code class="literal">localhost</code>, and use your certificates rather than the
    generated OpenIDM certificate.
   </p><ol class="procedure" type="1"><li class="step"><p>
     OpenIDM generates a self-signed certificate the first time it starts up.
     You must import this self-signed certificate into OpenDJ's truststore so
     that the OpenDJ agent can make SSL requests to the OpenIDM endpoints.
    </p><ol type="a" class="substeps"><li class="step"><p>
       Export OpenIDM's generated self-signed certificate to a file, as follows:
      </p><div class="screen"><pre>$ cd /path/to/openidm/security
$ keytool
 -export
 -alias openidm-localhost
 -file openidm-localhost.crt
 -keystore keystore.jceks
 -storetype jceks
Enter keystore password: &lt;changeit&gt;
Certificate stored in file &lt;openidm-localhost.crt&gt;</pre></div></li><li class="step"><p>
       Import the self-signed certificate into the trust store for OpenDJ.
      </p><div class="screen"><pre>$ cd /path/to/OpenDJ/config
$ keytool
 -import
 -alias openidm-localhost
 -keystore truststore
 -storepass `cat keystore.pin`
 -file /path/to/openidm/security/openidm-localhost.crt
Owner: C=None, L=None, O=OpenIDM Self-Signed Certificate, OU=None, CN=localhost
Issuer: C=None, L=None, O=OpenIDM Self-Signed Certificate, OU=None, CN=localhost
Serial number: 1544a7b975ed50a7
Valid from: Sat Oct 19 16:04:41 SAST 2013 until: Thu Nov 16 16:04:41 SAST 2023
Certificate fingerprints:
	 MD5:  0C:BF:08:06:F0:69:E8:E6:6F:39:38:B8:CC:9A:C1:60
	 SHA1: B0:40:17:0A:6E:3A:3B:BB:82:39:A1:97:04:00:BC:7C:94:63:76:E7
	 Signature algorithm name: SHA512withRSA
	 Version: 3
Trust this certificate? [no]:  yes
Certificate was added to keystore
      </pre></div></li></ol></li><li class="step"><p>
     Download the OpenDJ password synchronization plugin (OpenIDM Agents-OpenDJ)
     from the OpenIDM download page under the ForgeRock <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Open Stack download page</a>.
    </p></li><li class="step"><p>
     Unzip the module delivery.
    </p><div class="screen"><pre>
$ unzip ~/Downloads/opendj-accountchange-handler-1.0.0.zip
   creating: opendj/
   creating: opendj/config/
   creating: opendj/config/schema/
...</pre></div></li><li class="step"><p>
     Copy the files to the directory where OpenDJ is installed.
    </p><div class="screen"><pre>$ cd opendj
$ cp -r * /path/to/OpenDJ/</pre></div></li><li class="step"><p>
     Workaround for <code class="literal">OPENIDM-1380</code>:
    </p><p>
     Edit the file
     <code class="filename">/path/to/OpenDJ/config/schema/90-openidm-pwsync-plugin.ldif</code>
     to remove the attributes <code class="literal">ds-cfg-sql-user</code> and
     <code class="literal">ds-cfg-sql-passwd</code>.
    </p></li><li class="step"><p>
     Workaround for <code class="literal">OPENIDM-1379</code>:
    </p><p>
     Move the following nine jar files from the <code class="literal">opendj/lib</code>
     folder into the <code class="literal">opendj/lib/extensions</code> folder:
    </p><div class="screen"><pre>
$ cd /path/to/opendj/lib
$ mv json-fluent-1.1.0.jar extensions/
$ mv org.forgerock.util-1.0.0.jar extensions/
$ mv json-crypto-core-1.1.0.jar extensions/
$ mv jackson-core-asl-1.9.3.jar extensions/
$ mv jackson-mapper-asl-1.9.3.jar extensions/
$ mv org.restlet-2.0.10.jar extensions/
$ mv org.restlet.ext.jackson-2.0.10.jar extensions/
$ mv org.restlet.ext.net-2.0.10.jar extensions/
$ mv commons-codec-1.5.jar extensions/
       </pre></div></li><li class="step"><p>
     Restart OpenDJ to load the additional schema from the module.
    </p><div class="screen"><pre>$ cd /path/to/OpenDJ/bin
$ ./stop-ds --restart</pre></div></li><li class="step"><p>
     Workaround for <code class="literal">OPENIDM-1523</code>:
    </p><p>
     Edit the plugin config with a subjectDN that matches the generated OpenIDM
     certificate.
    </p><div class="screen"><pre>$ cd /path/to/OpenDJ/config</pre></div><p>
     Edit <code class="filename">openidm-pwsync-plugin-config.ldif</code>, changing the
     value of <code class="literal">ds-certificate-subject-dn</code> to
     <code class="literal">C=None, L=None, O=OpenIDM Self-Signed Certificate, OU=None,
      CN=localhost</code>.
    </p></li><li class="step"><p>
     Add the plugin configuration to OpenDJ's configuration.
    </p><div class="screen"><pre>$ ./ldapmodify
 --port 1389
 --hostname `hostname`
 --bindDN "cn=Directory Manager"
 --bindPassword "password"
 --defaultAdd
 --filename ../config/openidm-pwsync-plugin-config.ldif
Processing ADD request for cn=OpenIDM Notification Handler,
        cn=Account Status Notification Handlers,cn=config
ADD operation successful for DN cn=OpenIDM Notification Handler,
        cn=Account Status Notification Handlers,cn=config
</pre></div></li><li class="step"><p>
     Restart OpenDJ.
    </p><div class="screen"><pre>$ ./stop-ds --restart
...
[20/Nov/2013:08:55:47 +0100] category=EXTENSIONS severity=INFORMATION
 msgID=1049147 msg=Loaded extension from file '/path/to/OpenDJ/lib/extensions
 /opendj-accountchange-handler-1.0.0.jar' (build &lt;unknown&gt;,
 revision &lt;unknown&gt;)
...
[20/Nov/2013:08:55:51 +0100] category=CORE severity=NOTICE msgID=458891
 msg=The Directory Server has sent an alert notification generated by class
 org.opends.server.core.DirectoryServer (alert type
 org.opends.server.DirectoryServerStarted, alert ID 458887):
 The Directory Server has started successfully</pre></div></li><li class="step"><p>
     Enable the plugin for the appropriate password policy.
    </p><p>
     The following command enables the plugin for the default password policy.
    </p><div class="screen"><pre>$ ./dsconfig \
 set-password-policy-prop \
 --port 4444 \
 --hostname `hostname` \
 --bindDN "cn=Directory Manager" \
 --bindPassword password \
 --policy-name "Default Password Policy" \
 --set account-status-notification-handler:"OpenIDM Notification Handler" \
 --trustStorePath ../config/admin-truststore \
 --no-prompt</pre></div></li><li class="step"><p>
     
     If the <code class="literal">password</code> attribute does not exist in the
     <code class="literal">managed/user</code> object on OpenIDM, the password sync
     service will return an error when the password is updated in OpenDJ. To
     prevent this, add the following <code class="literal">onCreate</code> script to the
     OpenDJ &gt; Managed Users mapping in the <code class="filename">sync.json</code>
     file:
    </p><pre class="brush: javascript;">
"mappings" : [
 {
  "name" : "systemLdapAccounts_managedUser",
  "source" : "system/ldap/account",
  "target" : "managed/user",
  "properties" : [
   {
    "source" : "uid",
    "target" : "userName"
   }
  ],
  "onCreate" : {
   "type" : "text/javascript",
   "source" : "target.password=''"
  },
...
    </pre><p>
     The onCreate script creates an empty password in the
     <code class="literal">managed/user</code> object, so that the attribute exists and
     can be patched.
    </p></li></ol></div><div class="procedure"><a name="install-ad-password-sync-plugin"></a><div class="procedure-title">Procedure&nbsp;13.3.&nbsp;To Install the Active Directory Password Synchronization Plugin</div><a class="indexterm" name="d0e12360"></a><p>
    Use the Active Directory password synchronization plugin to synchronize
    passwords between OpenIDM and Active Directory (on systems running at least
    Microsoft Windows Server 2008 R2).
   </p><p>
    Install the plugin on Active Directory primary domain controllers (PDCs) to
    intercept password changes, and send the password values to OpenIDM over an
    encrypted channel. You must have Administrator privileges to install the
    plugin. In a clustered Active Directory environment, you must install the
    plugin on all PDCs.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download the Active Directory password synchronization plugin,
     OpenIDM Agents-AD, from the OpenIDM download page under the ForgeRock
     <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Open Stack download page</a>.
    </p></li><li class="step"><p>
     Double-click the setup file (<code class="filename">setup.exe</code>) to launch the
     installation wizard.
    </p></li><li class="step"><p>
     Provide the following information during the installation. You must accept
     the Common Development and Distribution License (CDDL) license agreement to
     proceed with the installation.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">OpenIDM Connection information</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <span class="emphasis"><em>OpenIDM URL.</em></span> Enter the URL where OpenIDM is
          deployed, including the query that targets each user account. For
          example:
         </p><div class="screen"><pre>http://localhost:8080/openidm/managed/user?_action=patch&amp;_queryId=for-userName&amp;uid=${samaccountname}
         </pre></div><p>
          For mutual authentication, the default URL is
         </p><div class="screen"><pre>https://localhost:8444/openidm/managed/user?_action=patch&amp;_queryId=for-userName&amp;uid=${samaccountname}
         </pre></div><p>
         </p><p>
          For this query to work, you must set a mapping from
          <code class="literal">samaccountname</code> to <code class="literal">username</code> in
          the <code class="filename">/path/to/openidm/conf/sync.json</code> file, for
          example:
         </p><pre class="brush: javascript;">{
    "mappings" : [
        {
            "name" : "systemADAccounts_managedUser",
            "source" : "system/ad/account",
            "target" : "managed/user",
            "properties" : [
                ...
                {
                    "source" : "samaccountname",
                    "target" : "userName"
                },
                ...
          }
    ]
}        </pre></li><li class="listitem"><p>
          <span class="emphasis"><em>OpenIDM User Password attribute.</em></span> The password
          attribute for the <code class="literal">managed/user</code> object, for example
          <code class="literal">password</code>.
         </p><p>
          If the <code class="literal">password</code> attribute does not exist in the
          <code class="literal">managed/user</code> object, the password sync service will
          return an error when the password is updated in Active Directory. To
          prevent this, add the following script to the Active Directory &gt;
          Managed Users mapping in the <code class="filename">sync.json</code> file:
         </p><pre class="brush: javascript;">"onCreate" : {
    "type" : "text/javascript",
    "source" : "target.password=''; target.adPassword='';"
},       </pre><p>
          The onCreate script creates an empty password in the
          <code class="literal">managed/user</code> object, so that the attribute exists
          and can be patched.
         </p></li></ul></div></dd><dt><span class="term">OpenIDM Authentication Parameters</span></dt><dd><p>
        Provide the following information:
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <span class="emphasis"><em>User name.</em></span> Enter the user name that is used to
          authenticate to OpenIDM, for example, <code class="literal">openidm-admin</code>.
         </p></li><li class="listitem"><p>
          <span class="emphasis"><em>Password.</em></span> Enter the password of the user that
          authenticates to OpenIDM, for example, <code class="literal">openidm-admin</code>.
         </p></li><li class="listitem"><p>
         <span class="emphasis"><em>Select authentication type.</em></span> Select the type of
         authentication that Active Directory will use to authenticate to
         OpenIDM.
        </p><p>
         For plain HTTP authentication, select <code class="literal">OpenIDM Header</code>.
         For mutual authentication, select <code class="literal">Certificate</code>.
        </p></li></ul></div></dd><dt><span class="term">Certificate authentication settings</span></dt><dd><p>If you selected <code class="literal">Certificate</code> as the authentication
       type on the previous screen, specify the details of the certificate that
       will be used for authentication.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         <span class="emphasis"><em>Select Certificate file.</em></span> Browse to select the
         certificate file that Active Directory will use to authenticate to
         OpenIDM. The certificate file must be in PKCS12 format.
        </p><p>
         For production purposes, you should use a certificate that has been
         issued by a Certificate Authority. For testing purposes, you can
         generate a self-signed certificate. Whichever certificate you use, the
         certificate must be imported into OpenIDM's trust store.
        </p><p>
         To generate a self-signed certificate for Active Directory, follow
         these steps:
        </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
           On the Active Directory host, generate a self-signed certificate with
           the alias <code class="literal">ad-pwd-plugin-localhost</code>.
          </p><div class="screen"><pre>&gt; keytool
 -genkey
 -alias ad-pwd-plugin-localhost
 -keyalg rsa
 -dname "CN=localhost, O=AD-pwd-plugin Self-Signed Certificate"
 -keystore keystore.jceks
 -storetype JCEKS
Enter keystore password: <em><strong>changeit</strong></em>
Re-enter new password: changeit
Enter key password for &lt;ad-pwd-plugin-localhost&gt;
      &lt;RETURN if same as keystore password&gt;
          </pre></div></li><li class="step"><p>
           Self-sign the certificate.
          </p><div class="screen"><pre>&gt; keytool
 -selfcert
 -alias ad-pwd-plugin-localhost
 -validity 365
 -keystore keystore.jceks
 -storetype JCEKS
 -storepass changeit
          </pre></div></li><li class="step"><p>
           Export the certificate as a PKCS12 certificate.
          </p><div class="screen"><pre>&gt; keytool
 -importkeystore
 -srckeystore keystore.jceks
 -srcstoretype jceks
 -srcstorepass changeit
 -srckeypass changeit
 -srcalias ad-pwd-plugin-localhost
 -destkeystore ad-pwd-plugin-localhost.p12
 -deststoretype PKCS12
 -deststorepass changeit
 -destkeypass changeit
 -destalias ad-pwd-plugin-localhost
 -noprompt
          </pre></div><p>
           This command generates a PKCS12 certificate file, named
           <code class="filename">ad-pwd-plugin-localhost.p12</code>. Copy this
           certificate file to the machine that hosts OpenIDM, and import the
           certificate into the OpenIDM truststore.
          </p><div class="screen"><pre>$ keytool
 -importkeystore
 -srckeystore /path/to/ad-pwd-plugin-localhost.p12
 -srcstoretype PKCS12
 -destkeystore truststore
 -deststoretype JKS
          </pre></div></li></ol></div></li><li class="listitem"><p>
         <span class="emphasis"><em>Password to open certificate file.</em></span> Specify the
         keystore password (<code class="literal">changeit</code>, in the previous
         example).</p></li></ul></div></dd><dt><span class="term">Password Encryption settings</span></dt><dd><p>
        Provide the details of the certificate that will be used to encrypt
        password values.
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <span class="emphasis"><em>Certificate file.</em></span> Browse to select the
          certificate file that will be used for password encryption. The
          certificate file must be in PKCS12 format.
         </p><p>For evaluation purposes, you can use a self-signed certificate,
          as described in the previous step. For production purposes, you should
          use a certificate that has been issued by a Certificate Authority.
         </p><p>
          Whichever certificate you use, the certificate must be imported into
          OpenIDM's keystore, so that OpenIDM can locate the key with which to
          decrypt the data. To import the certificate into OpenIDM's keystore,
          run the following command on the OpenIDM host:
         </p><div class="screen"><pre>
$ keytool
 -importkeystore
 -srckeystore /path/to/ad-pwd-plugin-localhost.p12
 -srcstoretype PKCS12
 -destkeystore /path/to/openidm/security/keystore.jceks
 -deststoretype jceks
         </pre></div></li><li class="listitem"><p>
          <span class="emphasis"><em>Private key alias.</em></span> Specify the certificate alias
          for the certificate, such as <code class="literal">ad-pwd-plugin-localhost</code>,
          from the previous self-signed certificate example.
         </p></li><li class="listitem"><p>
          <span class="emphasis"><em>Password to open certificate file.</em></span> Specify the
          password to access the PFX keystore file, such as
          <code class="literal">changeit</code>, from the previous example.
         </p></li><li class="listitem"><p>
          <span class="emphasis"><em>Select encryption key type.</em></span> Specify the
          encryption key type that will be used when encrypting the password
          value (AES-128, AES-192, or AES-256).
         </p></li></ul></div></dd><dt><span class="term">Data storage</span></dt><dd><p>
        Provide the details for the storage of encrypted passwords in the event
        that OpenIDM is not available when a password modification is made.
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Select a secure directory in which the JSON files that contain
          encrypted passwords are queued. The server should prevent access to
          this folder, except access by the <code class="literal">Password Sync
          service</code>. The path name cannot include spaces.
         </p></li><li class="listitem"><p>
          <span class="emphasis"><em>Directory poll interval (seconds).</em></span> Enter the
          number of seconds between calls to check whether OpenIDM is available,
          for example, <code class="literal">60</code>, to poll OpenIDM every minute.
         </p></li></ul></div></dd><dt><span class="term">Log storage</span></dt><dd><p>
        Provide the details of the messages that should be logged by the plugin.
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Select the location to which messages should be logged. The path name
          cannot include spaces.
         </p></li><li class="listitem"><p><span class="emphasis"><em>Select logging level.</em></span> Select the severity of
          messages that should be logged, either <code class="literal">error</code>,
          <code class="literal">info</code>, <code class="literal">warning</code>,
          <code class="literal">fatal</code>, or <code class="literal">debug</code>.
         </p></li></ul></div></dd><dt><span class="term">Select Destination Location</span></dt><dd><p>
        Setup installs the plugin in the location you select, by default
        <code class="filename">C:\Program Files\OpenIDM Password Sync</code>.
       </p></dd></dl></div></li><li class="step"><p>
     After running the installation wizard, restart the computer.
    </p></li><li class="step"><p>
     If you need to change any settings after installation, access the
     settings using the Registry Editor under HKEY_LOCAL_MACHINE &gt; SOFTWARE
     &gt; ForgeRock &gt; OpenIDM &gt; PasswordSync.</p></li><li class="step"><p>
     If you selected to authenticate over plain HTTP in the previous step, your
     setup is now complete.
    </p><p>
     If you selected to authenticate with mutual authentication, complete this
     step.
    </p><ol type="a" class="substeps"><li class="step"><p>
       The Password Sync Service uses Windows certificate stores to verify
       OpenIDM's identity. The certificate that OpenIDM uses must therefore
       be added to the list of trusted certificates on the Windows machine.
      </p><p>
       For production purposes, you should use a certificate that has been
       issued by a certificate authority. For test purposes, you can use the
       self-signed certificate that is generated by OpenIDM on first startup.
      </p><p>
       To add the OpenIDM certificate to the list of trusted certificates, use
       the Microsoft Management Console.
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
         Select Start and type <code class="literal">mmc</code> in the Search field.
        </p></li><li class="listitem"><p>
         In the Console window, select File &gt; Add/Remove Snap-in.
        </p></li><li class="listitem"><p>
         From the left hand column, select Certificates and click Add.
        </p></li><li class="listitem"><p>
         Select My user account, and click Finish.
        </p></li><li class="listitem"><p>
         Repeat the previous two steps for Service account and Computer account.
        </p><p>
         For Service account, select Local computer, then select OpenIDM
         Password Sync Service.
        </p><div class="mediaobject" align="center"><a name="password-sync-service"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/service-acct.png" align="middle" height="360" alt="OpenIDM architecture"></td></tr></table></div><p>
         For Computer account, select Local computer.
        </p></li><li class="listitem"><p>
         Click Finish when you have added the three certificate snap-ins.
        </p></li><li class="listitem"><p>
         Still in the mmc Console, expand Certificates - Current User &gt;
         Personal and select Certificates.
        </p></li><li class="listitem"><p>
         Select Action &gt; All Tasks &gt; Import to open the Certificate Import
         Wizard.
        </p></li><li class="listitem"><p>
         Browse for the OpenIDM certificate (<code class="literal">openidm-localhost</code>
         by default, if you use OpenIDM's self-signed certificate).
        </p></li><li class="listitem"><p>
         Enter the Password for the certificate (<code class="literal">changeit</code> by
         default, if you use OpenIDM's self-signed certificate).
        </p></li><li class="listitem"><p>
         Accept the default for the Certificate Store.
        </p></li><li class="listitem"><p>
         Click Finish to complete the import.
        </p></li><li class="listitem"><p>
         Repeat the previous five steps to import the certificate for:
        </p><table border="0" summary="Simple list" class="simplelist"><tr><td>
          <code class="literal">Current User &gt; Trusted Root Certification
           Authorities</code>
         </td></tr><tr><td>
          <code class="literal">Service &gt; OpenIDM Password Sync\Personal</code>
         </td></tr><tr><td>
          <code class="literal">Service &gt; OpenIDM Password Sync\Trusted Root Certification
           Authorities</code>
         </td></tr><tr><td>
          <code class="literal">Local Computer &gt; Personal</code>
         </td></tr><tr><td>
          <code class="literal">Local Computer &gt; Trusted Root Certification
           Authorities</code>
         </td></tr></table></li></ol></div></li></ol></li></ol></div><div class="procedure"><a name="setup-openidm-for-password-sync"></a><div class="procedure-title">Procedure&nbsp;13.4.&nbsp;To Set Up OpenIDM to Handle Password Changes</div><p>
    Follow these steps to configure OpenIDM to access password changes from
    OpenDJ and Active Directory.</p><ol class="procedure" type="1"><li class="step"><p>
     You must add the OpenDJ/Active Directory server certificates that you have
     used to OpenIDM's trust store so that OpenIDM knows to trust OpenDJ/Active
     Directory during mutual authentication.
    </p><p>
     Use the Java <span class="command"><strong>keytool</strong></span> command to import the certificate
     into the OpenIDM trust store.
    </p></li><li class="step"><p>
     Add the configuration to managed objects to handle password
     synchronization.
    </p><p>
     An example for synchronization with both OpenDJ and Active Directory is
     provided in the <code class="filename">samples/misc/managed.json</code> file,
     JavaScript lines folded for readability:</p><pre class="brush: javascript;">
{
    "objects": [
        {
            "name": "user",
            "properties": [
                {
                    "name": "ldapPassword",
                    "encryption": {
                        "key": "openidm-sym-default"
                    }
                },
                {
                    "name": "adPassword",
                    "encryption": {
                        "key": "openidm-sym-default"
                    }
                },
                {
                    "name": "password",
                    "encryption": {
                        "key": "openidm-sym-default"
                    }
                }
            ],
            "onUpdate": {
                "type": "text/javascript",
                "source":
                 "if (newObject.ldapPassword != oldObject.ldapPassword) {
                     newObject.password = newObject.ldapPassword
                  } else if (newObject.adPassword != oldObject.adPassword) {
                      newObject.password = newObject.adPassword
                  }"
            }
        }
    ]
}</pre><p>This sample assumes you define the password as
    <code class="literal">ldapPassword</code> for OpenDJ, and
    <code class="literal">adPassword</code> for Active Directory.</p></li><li class="step"><p>
     Update the connector configuration files to add the password property to
     the <code class="literal">account</code> object type.
    </p><p>
     For OpenDJ, update <code class="filename">provisioner.openicf-ldap.json</code>, as
     follows:
    </p><pre class="brush: javascript;">
   "objectTypes" :
      {
         "account" :
            {
               "$schema" : "http://json-schema.org/draft-03/schema",
               "id" : "__ACCOUNT__",
               "type" : "object",
               "nativeType" : "__ACCOUNT__",
               "properties" :
                  {
                     "cn" :
                        {
                           "type" : "string",
                           "nativeName" : "cn",
                           "nativeType" : "string"
                        },
                      ...
                     "ldapPassword" :
                        {
                           "type" : "string",
                           "nativeName" : "userpassword",
                           "nativeType" : "string"
                        },
     ...
    </pre><p>
     For Active Directory, update
     <code class="filename">provisioner.openicf-ad.json</code>, as follows:
    </p><pre class="brush: javascript;">
   "objectTypes" :
      {
         "account" :
            {
               "$schema" : "http://json-schema.org/draft-03/schema",
               "id" : "__ACCOUNT__",
               "type" : "object",
               "nativeType" : "__ACCOUNT__",
               "properties" :
                  {
                     "cn" :
                        {
                           "type" : "string",
                           "nativeName" : "cn",
                           "nativeType" : "string"
                        },
                      ...
                     "adPassword" :
                        {
                           "type" : "string",
                           "nativeName" : "_PASSWORD_",
                           "nativeType" : "JAVA_TYPE_GUARDEDSTRING"
                        },
     ...
    </pre></li><li class="step"><p>When you change a password in OpenDJ, you will notice that the value 
    changes in OpenIDM.</p><div class="screen"><pre>$ tail -f openidm/audit/activity.csv | grep bjensen
...userName=bjensen, ... password={$crypto={...data=tEsy7ZXo6nZtEqzW/uVE/A==...
...userName=bjensen, ... password={$crypto={...data=BReT79lnQEPcvfQG3ibLpg==...</pre></div><p>
     Be aware that the plugin is patching the password value of the
    managed user in OpenIDM. The target <code class="literal">password</code> property 
    must exist for the patch to work.
    </p><p>
     To configure automatic synchronization, that is the password is updated in
     Active Directory automatically when it is changed in OpenIDM, you must
     complete the following three steps:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Define a mapping from <code class="literal">managed/user</code> to
       <code class="literal">system/ad/account</code> in your
       <code class="filename">/path/to/openidm/conf/sync.json</code> file.
      </p></li><li class="listitem"><p>
       Specify the <code class="literal">{"source" : "password", "target" : "adPassword"}</code>
       property as part of this mapping.
      </p></li><li class="listitem"><p>
       Make sure that automatic synchronization is enabled for that mapping. By
       default, all mappings participate in automatic synchronization operations
       so you should not have to enable this operation manually unless you have
       specifically set the <code class="literal">"enableSync"</code> property of the
       mapping to <code class="literal">false</code>.
      </p></li></ul></div></li></ol></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-scheduler-conf.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-auth.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;12.&nbsp;Scheduling Tasks and Events&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;14.&nbsp;Managing Authentication, Authorization and Role-Based Access Control</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10020&components=10164&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>