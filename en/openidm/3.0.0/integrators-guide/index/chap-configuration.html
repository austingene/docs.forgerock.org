<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;5.&nbsp;Configuring OpenIDM</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenIDM Integrator's Guide"><link rel="up" href="index.html" title="OpenIDM Integrator's Guide"><link rel="prev" href="chap-ui.html" title="Chapter&nbsp;4.&nbsp;OpenIDM User Interface"><link rel="next" href="chap-data.html" title="Chapter&nbsp;6.&nbsp;Accessing Data Objects"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;5.&nbsp;Configuring OpenIDM</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-ui.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-data.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-configuration"></a>Chapter&nbsp;5.&nbsp;Configuring OpenIDM</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-configuration.html#configuration-objects">5.1. OpenIDM Configuration Objects</a></span></dt><dt><span class="section"><a href="chap-configuration.html#changing-configuration">5.2. Changing the Default Configuration</a></span></dt><dt><span class="section"><a href="chap-configuration.html#configuring-for-production">5.3. Configuring an OpenIDM System for Production</a></span></dt><dt><span class="section"><a href="chap-configuration.html#configuring-over-rest">5.4. Configuring OpenIDM Over REST</a></span></dt><dt><span class="section"><a href="chap-configuration.html#using-property-substitution">5.5. Using Property Value Substitution in the Configuration</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints">5.6. Adding Custom Endpoints</a></span></dt><dt><span class="section"><a href="chap-configuration.html#config-default-directories">5.7. Default and Custom Configuration Directories</a></span></dt></dl></div><p>OpenIDM configuration is split between <code class="filename">.properties</code> and container
 configuration files, and also dynamic configuration objects. The majority
 of OpenIDM configuration files are stored under
 <code class="filename">openidm/conf/</code>, as described in the appendix listing the
 <a href="../../integrators-guide/index/appendix-file-layout.html" class="link"><em class="citetitle">File
 Layout</em></a>.</p><p>OpenIDM stores configuration objects in its internal repository.
 You can manage the configuration by using either the REST access to the
 configuration objects, or by using the JSON file based views.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-objects"></a>5.1.&nbsp;OpenIDM Configuration Objects</h2></div></div></div><a class="indexterm" name="d0e2506"></a><a class="indexterm" name="d0e2511"></a><p>OpenIDM exposes internal configuration objects in JSON format.
      Configuration elements can be either single instance or multiple
      instance for an OpenIDM installation.</p><div class="itemizedlist"><a name="single-instance-configuration-objects"></a><div class="itemizedlist-title">Single Instance Configuration Objects</div><p>Single instance configuration objects correspond to services that have
   at most one instance per installation.</p><p>JSON file views of these configuration objects are named
   <code class="filename"><em class="replaceable"><code>object-name</code></em>.json</code>.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The <code class="literal">audit</code> configuration specifies how audit
    events are logged.</p></li><li class="listitem"><p>The <code class="literal">authentication</code> configuration controls
    REST access.</p></li><li class="listitem"><p>The <code class="literal">cluster</code> configuration defines how one
    OpenIDM instance can be configured in a cluster.</p></li><li class="listitem"><p>The <code class="literal">endpoint</code> configuration controls any custom
    REST endpoints.</p></li><li class="listitem"><p>The <code class="literal">info</code> configuration points to script files for
    the customizable information service.</p></li><li class="listitem"><p>The <code class="literal">managed</code> configuration defines managed
          objects and their schemas.</p></li><li class="listitem"><p>The <code class="literal">policy</code> configuration defines the policy
      validation service.</p></li><li class="listitem"><p>The <code class="literal">process access</code> configuration defines access
      to any configured workflows.</p></li><li class="listitem"><p>The <code class="literal">repo.<em class="replaceable"><code>repo-type</code></em></code>
    configuration such as <code class="literal">repo.orientdb</code> or
    <code class="literal">repo.jdbc</code> configures the internal repository.</p></li><li class="listitem"><p>The <code class="literal">router</code> configuration specifies filters to
    apply for specific operations.</p></li><li class="listitem"><p>The <code class="literal">script</code> configuration defines default
    and custom configuration directories.</p></li><li class="listitem"><p>The <code class="literal">sync</code> configuration defines the mappings that
    OpenIDM uses when synchronizing and reconciling managed objects.</p></li><li class="listitem"><p>The <code class="literal">ui</code> configuration defines the configurable
       aspects of the default user interface.</p></li><li class="listitem"><p>The <code class="literal">workflow</code> configuration defines the
       configuration of the workflow engine.</p></li></ul></div><div class="itemizedlist"><a name="multiple-instance-configuration-objects"></a><div class="itemizedlist-title">Multiple Instance Configuration Objects</div><p>Multiple instance configuration objects correspond to services that
   can have many instances per installation. Configuration objects are named
   <code class="literal"><em class="replaceable"><code>objectname</code></em>/<em class="replaceable"><code>instancename</code></em></code>,
   for example, <code class="filename">provisioner.openicf/xml</code>.</p><p><span class="emphasis"><em>JSON file</em></span> views of these configuration objects 
   are named <code class="filename"><em class="replaceable"><code>objectname</code></em>-<em class="replaceable"><code>instancename</code></em>.json</code>, for example,
   <code class="filename">provisioner.openicf-xml.json.</code></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Multiple <code class="literal">schedule</code> configurations can run
    reconciliations and other tasks on different schedules.</p></li><li class="listitem"><p>Multiple <code class="literal">provisioner.openicf</code> configurations
    correspond to the resources connected to OpenIDM.</p></li><li class="listitem"><p>Multiple <code class="literal">servletfilter</code> configurations can
    be used for different servlet filters such as the Cross Origin and GZip
    filters.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="changing-configuration"></a>5.2.&nbsp;Changing the Default Configuration</h2></div></div></div><div class="itemizedlist"><p>When you change OpenIDM's configuration objects, take the following
         points into account.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>OpenIDM's authoritative configuration source is the internal
             repository. JSON files provide a view of the configuration objects,
             but do not represent the authoritative source.</p><p>OpenIDM updates JSON files after making configuration changes,
             whether those changes are made through REST access to configuration
             objects, or through edits to the JSON files.</p></li><li class="listitem"><p>OpenIDM recognizes changes to JSON files when it is running. OpenIDM
             <span class="emphasis"><em>must</em></span> be running when you delete configuration
             objects, even if you do so by editing the JSON files.</p></li><li class="listitem"><p>Avoid editing configuration objects directly in the internal
               repository. Rather edit the configuration over the REST API, or
               in the configuration JSON files to ensure consistent behavior
               and that operations are logged.</p></li><li class="listitem"><p>OpenIDM stores its configuration in the internal database by
               default. If you remove an OpenIDM instance and do not specifically
               drop the repository, the configuration remains in effect for a
               new OpenIDM instance that uses that repository. For testing or
               evaluation purposes, you can disable this <span class="emphasis"><em>persistent
               configuration</em></span> in the <code class="filename">conf/system.properties</code>
               file by uncommenting the following line:</p><pre class="brush: plain;">
# openidm.config.repo.enabled=false
             </pre><p>Disabling persistent configuration means that OpenIDM will
                 store its configuration in memory only. You should not disable
                 persistent configuration in a production environment.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuring-for-production"></a>5.3.&nbsp;Configuring an OpenIDM System for Production</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-configuration.html#configuring-production-repo">5.3.1. Configuring a Production Repository</a></span></dt><dt><span class="section"><a href="chap-configuration.html#disabling-auto-config-updates">5.3.2. Disabling Automatic Configuration Updates</a></span></dt></dl></div><p>
   Out of the box, OpenIDM is configured to make it easy to install and
   evaluate. Specific configuration changes are required before you deploy
   OpenIDM in a production environment.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuring-production-repo"></a>5.3.1.&nbsp;Configuring a Production Repository</h3></div></div></div><p>
    By default, OpenIDM uses OrientDB for its internal repository so that you do
    not have to install a database in order to evaluate OpenIDM. Before you use
    OpenIDM in production, you must replace OrientDB with a supported
    repository.
   </p><p>
    For more information, see <a href="../../install-guide/index/chap-repository.html" class="link"><em class="citetitle">Installing a
    Repository for Production</em></a> in the <em class="citetitle">Installation
    Guide</em>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="disabling-auto-config-updates"></a>5.3.2.&nbsp;Disabling Automatic Configuration Updates</h3></div></div></div><p>
    By default, OpenIDM polls the JSON files in the <code class="literal">conf</code>
    directory periodically for any changes to the configuration. In a production
    system, it is recommended that you disable automatic polling for updates to
    prevent untested configuration changes from disrupting your identity service.
   </p><p>
    To disable automatic polling for configuration changes, edit the
    <code class="filename">conf/system.properties</code> file by uncommenting the
    following line:
   </p><pre class="brush: plain;"># openidm.fileinstall.enabled=false</pre><p>
    This setting also disables the file-based configuration view, which means
    that OpenIDM reads its configuration only from the repository.
   </p><p>
    Before you disable automatic polling, you must have started the OpenIDM
    instance at least once to ensure that the configuration has been loaded into
    the repository.
   </p><p>
    Note if automatic polling is enabled, changes to scripts that are  called
    from a JSON configuration file are taken into account immediately.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuring-over-rest"></a>5.4.&nbsp;Configuring OpenIDM Over REST</h2></div></div></div><a class="indexterm" name="d0e2746"></a><a class="indexterm" name="d0e2749"></a><p>OpenIDM exposes configuration objects under the
  <code class="literal">/openidm/config</code> context path.</p><a class="indexterm" name="d0e2759"></a><p>You can list the configuration on the local host by performing a GET
  <code class="literal">https://localhost:8443/openidm/config</code>. The following
  example shows excerpts of the default configuration for an OpenIDM instance
  started with Sample 1.</p><div class="screen"><pre><strong>$ curl \
 --request GET \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --cacert self-signed.crt \
 https://localhost:8443/openidm/config</strong>
   <em>{
   "configurations": [
      {
         "factoryPid": "servletfilter",
         "pid": "servletfilter.ec099f08-bfd4-4ab4-8537-78e5b956c7cc",
         "_id": "servletfilter/gzip"
      },
      {
         "factoryPid": null,
         "pid": "router",
         "_id": "router"
      },

   ...

      {
         "factoryPid": "endpoint",
         "pid": "endpoint.7e9ec068-bb4a-4fa0-ae15-1706bb4a3a07",
         "_id": "endpoint/jqgrid"
      },
      {
         "factoryPid": "endpoint",
         "pid": "endpoint.47978983-0411-425d-8f53-4022175e146a",
         "_id": "endpoint/gettasksview"
      },

   ...

      {
         "factoryPid": "ui",
         "pid": "ui.b10eb4cb-83e3-4a4b-9d29-d91d90eb3053",
         "_id": "ui/countries"
      },
      {
         "factoryPid": "process",
         "pid": "process.9863529c-60e0-42e3-b5d5-c5c704016e95",
         "_id": "process/access"
      }
   ]
}</em></pre></div><p>Single instance configuration objects are located under
  <code class="literal">openidm/config/<em class="replaceable"><code>object-name</code></em></code>.
  The following example shows the default <code class="literal">audit</code>
  configuration.</p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 "https://localhost:8443/openidm/config/audit"</strong>
<em>{
   "eventTypes": {
     "recon": {},
     "activity": {
       "filter": {
         "actions": [
           "create",
           "update",
           "delete",
           "patch",
           "action"
         ]
       },
       "passwordFields": [
         "password"
       ],
       "watchedFields": []
     }
   },
   "exceptionFormatter": {
     "file": "bin/defaults/script/audit/stacktraceFormatter.js",
     "type": "text/javascript"
   },
   "logTo": [
     {
       "recordDelimiter": ";",
       "logType": "csv",
       "location": "audit"
     },
     {
       "useForQueries": true,
       "logType": "repository"
     }
   ]
} </em>  </pre></div><p>Multiple instance configuration objects are found under
  <code class="literal">openidm/config/<em class="replaceable"><code>object-name</code></em>/<em class="replaceable"><code>instance-name</code></em></code>.
  </p><p>The following example shows the configuration for the XML connector
    provisioner, based on the first IDM sample described in the
    <a href="../../install-guide/index/chap-sample.html" class="link"><em class="citetitle">
    First IDM Sample</em></a> of the OpenIDM Installation Guide.</p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 "https://localhost:8443/openidm/config/provisioner.openicf/xml"</strong>
<em>{
    "operationTimeout": {
      "SCRIPT_ON_CONNECTOR": -1,
      "VALIDATE": -1,
      "SYNC": -1,
      "DELETE": -1,
      "TEST": -1,
      "UPDATE": -1,
      "CREATE": -1,
      "AUTHENTICATE": -1,
      "SEARCH": -1,
      "GET": -1,
      "SCRIPT_ON_RESOURCE": -1,
      "SCHEMA": -1
    },
    "connectorRef": {
      "connectorName": "org.forgerock.openicf.connectors.xml.XMLConnector",
      "bundleVersion": "1.1.0.1",
      "bundleName": "org.forgerock.openicf.connectors.xml-connector"
    },
    "connectorPoolingSupported": true,
    "syncFailureHandler": {
      "maxRetries": 5,
      "postRetryAction": "logged-ignore"
    },
    "configurationProperties": {
      "xsdFilePath": "samples/sample1/data/resource-schema-extension.xsd",
      "xsdIcfFilePath": "samples/sample1/data/resource-schema-1.xsd",
      "xmlFilePath": "samples/sample1/data/xmlConnectorData.xml"
    },
    "objectTypes": {
      "account": {
        "nativeType": "__ACCOUNT__",
        "$schema": "http://json-schema.org/draft-03/schema",
        "type": "object",
        "properties": {
          "securityAnswer": {
            "nativeType": "string",
            "nativeName": "securityAnswer",
            "required": true,
            "type": "string"
          },
          "securityQuestion": {
            "nativeType": "string",
            "nativeName": "securityQuestion",
            "required": true,
            "type": "string"
          },
          "password": {
            "nativeType": "string",
            "nativeName": "password",
            "type": "string"
          },
          "mobileTelephoneNumber": {
            "nativeType": "string",
            "nativeName": "mobileTelephoneNumber",
            "required": true,
            "type": "string"
          },
          "_id": {
            "nativeName": "__UID__",
            "type": "string"
          },
          "email": {
            "nativeType": "string",
            "nativeName": "email",
            "type": "string"
          },
          "description": {
            "nativeType": "string",
            "nativeName": "__DESCRIPTION__",
            "type": "string"
          },
          "name": {
            "nativeType": "string",
            "nativeName": "__NAME__",
            "required": true,
            "type": "string"
          },
          "roles": {
            "nativeType": "string",
            "nativeName": "roles",
            "required": false,
            "type": "string"
          },
          "lastname": {
            "nativeType": "string",
            "nativeName": "lastname",
            "required": true,
            "type": "string"
          },
          "firstname": {
            "nativeType": "string",
            "nativeName": "firstname",
            "type": "string"
          }
        },
        "id": "__ACCOUNT__"
      }
    },
    "operationOptions": {},
    "name": "xmlfile",
    "producerBufferSize": 100,
    "poolConfigOption": {
      "maxObjects": 10,
      "minEvictableIdleTimeMillis": 120000,
      "maxIdle": 10,
      "minIdle": 1,
      "maxWait": 150000
    }
  }
</em>
  </pre></div><p>
   You can change the configuration over REST by using an HTTP PUT request to
   modify the required configuration object. Note that HTTP PATCH is not
   supported on the <code class="literal">/config</code> endpoint.
  </p><p>
   The following example modifies the <code class="filename">router.json</code> file to
   remove all filters, effectively bypassing any policy validation.
  </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --header "Content-Type: application/json" \
 --request PUT \
 --data '{
   "filters" : [
     {
       "onRequest" : {
         "type" : "text/javascript",
         "file" : "bin/defaults/script/router-authz.js"
       }
     }
   ]
   }' \
 "https://localhost:8443/openidm/config/router"</strong>
<em>{
  "filters": [
    {
      "onRequest": {
        "file": "bin/defaults/script/router-authz.js",
        "type": "text/javascript"
      }
    }
  ]
} </em></pre></div><p>
   For more information about using the REST API to update objects, see the
   <a href="../../integrators-guide/index/appendix-rest.html" class="link"><em class="citetitle">REST API
   Reference</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="using-property-substitution"></a>5.5.&nbsp;Using Property Value Substitution in the Configuration</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-configuration.html#property-substitution-system">5.5.1. Using Property Value Substitution With System Properties</a></span></dt><dt><span class="section"><a href="chap-configuration.html#property-substitution-limitations">5.5.2. Limitations of Property Value Substitution</a></span></dt></dl></div><p>
   In an environment where you have more than one OpenIDM instance, you might
   require a configuration that is similar, but not identical, across the
   different OpenIDM hosts. OpenIDM supports variable replacement in its
   configuration which means that you can modify the effective configuration
   according to the requirements of a specific environment or OpenIDM instance.
  </p><div class="itemizedlist"><p>
    Property substitution enables you to achieve the following:
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Define a configuration that is specific to a single OpenIDM instance, for
     example, setting the location of the keystore on a particular host.
    </p></li><li class="listitem"><p>
     Define a configuration whose parameters vary between different
     environments, for example, the URLs and passwords for test, development,
     and production environments.
    </p></li><li class="listitem"><p>
     Disable certain capabilities on specific nodes. For example, you might want
     to disable the workflow engine on specific instances.
    </p></li></ul></div><p>
   When OpenIDM starts up, it combines the system configuration, which might
   contain specific environment variables, with the defined OpenIDM
   configuration properties. This combination makes up the effective
   configuration for that OpenIDM instance. By varying the environment
   properties, you can change specific configuration items that vary between
   OpenIDM instances or environments.
  </p><p>
   Property references are contained within the construct
   <code class="literal">&amp;{ }</code>. When such references are found, OpenIDM replaces
   them with the appropriate property value, defined in the
   <code class="filename">boot.properties</code> file.
  </p><div class="example"><a name="d0e2864"></a><div class="example-title">Example&nbsp;5.1.&nbsp;</div><div class="example-contents"><p>The following example defines two separate OpenIDM environments - 
   a development environment and a production environment. You can specify the 
   environment at startup time and, depending on the environment, the database 
   URL is set accordingly.</p><p>The environments are defined by adding the following lines to the 
   <code class="filename">conf/boot.properties</code> file:</p><pre class="brush: javascript;">PROD.location=production
DEV.location=development</pre><p>
    The database URL is then specified as follows in the
    <code class="filename">repo.orientdb.json</code> file:
   </p><pre class="brush: javascript;">{
    "dbUrl" : "plocal:./db/&amp;{&amp;{environment}.location}-openidm",
    ...
}   </pre><p>
    The effective database URL is determined by setting the
    <code class="literal">OPENIDM_OPTS</code> environment variable when you start OpenIDM.
    To use the production environment, start OpenIDM as follows:
   </p><div class="screen"><pre>$ export OPENIDM_OPTS="-Xmx1024m -Xms1024m -Denvironment=PROD"
$ ./startup.sh</pre></div><p>
    To use the development environment, start OpenIDM as follows:
   </p><div class="screen"><pre>$ export OPENIDM_OPTS="-Xmx1024m -Xms1024m -Denvironment=DEV"
$ ./startup.sh</pre></div></div></div><br class="example-break"><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="property-substitution-system"></a>5.5.1.&nbsp;Using Property Value Substitution With System Properties</h3></div></div></div><p>You can use property value substitution in conjunction with the system 
  properties, to modify the configuration according to the system on which 
  the OpenIDM instance runs.</p><div class="example"><a name="custom-audit-log-location"></a><div class="example-title">Example&nbsp;5.2.&nbsp;Custom Audit Log Location</div><div class="example-contents"><p>The following example modifies the <code class="literal">audit.json</code> file so 
   that the log file is written to the user's directory. The 
   <code class="literal">user.home</code> property is a default Java System property.</p><pre class="brush: javascript;">{
    "logTo" : [
        {
            "logType" : "csv",
            "location" : "&amp;{user.home}/audit",
            "recordDelimiter" : ";"
        }
    ]
}
   </pre></div></div><br class="example-break"><p>You can define <span class="emphasis"><em>nested</em></span> properties (that is a property 
 definition within another property definition) and you can combine system 
 properties and boot properties.</p><div class="example"><a name="d0e2915"></a><div class="example-title">Example&nbsp;5.3.&nbsp;</div><div class="example-contents"><p>
   The following example uses the <code class="literal">user.country</code> property, a
   default Java System property. The example defines specific LDAP ports,
   depending on the country (identified by the country code) in the 
   <code class="literal">boot.properties</code> file. The value of the LDAP port (set in 
   the <code class="literal">provisioner.openicf-ldap.json</code> file) depends on the 
   value of the <code class="literal">user.country</code> System property.
  </p><p>
   The port numbers are defined in the <code class="literal">boot.properties</code>
   file as follows:
  </p><pre class="brush: javascript;">openidm.NO.ldap.port=2389
openidm.EN.ldap.port=3389
openidm.US.ldap.port=1389</pre><p>
   The following extract from the <code class="literal">provisioner.openicf-ldap.json</code>
   file shows how the value of the LDAP port is eventually determined, based on
   the System property:
  </p><pre class="brush: javascript;">"configurationProperties" :
   {
      "credentials" : "Passw0rd",
      "port" : "&amp;{openidm.&amp;{user.country}.ldap.port}",
      "principal" : "cn=Directory Manager",
      "baseContexts" :
         [
            "dc=example,dc=com"
         ],
      "host" : "localhost"
   }</pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="property-substitution-limitations"></a>5.5.2.&nbsp;Limitations of Property Value Substitution</h3></div></div></div><div class="itemizedlist"><p>
     Note the following limitations when you use property value substitution:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      You cannot reference complex objects or properties with syntaxes other
      than String. Property values are resolved from the
      <code class="literal">boot.properties</code> file or from the System properties and
      the value of these properties is always in String format.
     </p><p>
      Property substitution of boolean values is currently only supported in
      stringified format, that is, resulting in <code class="literal">"true"</code> or
      <code class="literal">"false"</code>.
     </p></li><li class="listitem"><p>
      Substitution of encrypted property values is currently not supported.
     </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adding-custom-endpoints"></a>5.6.&nbsp;Adding Custom Endpoints</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-structure">5.6.1. The Components of an Endpoint Configuration File</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-context-components">5.6.2. Context Component Access Methods</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-request">5.6.3. Custom Endpoints and <code class="literal">request</code> Objects</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-chains">5.6.4. Custom Endpoints, Contexts, and Chains</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-more">5.6.5. Additional Custom Endpoint Parameters</a></span></dt><dt><span class="section"><a href="chap-configuration.html#adding-custom-endpoints-example">5.6.6. Custom Endpoint Example</a></span></dt></dl></div><p>
    You can customize OpenIDM to meet the specific requirements of your
    deployment by adding your own RESTful endpoints. Endpoints are configured
    in files named
    <code class="filename">conf/endpoint-<em class="replaceable"><code>name</code></em>.json</code>,
    where <em class="replaceable"><code>name</code></em> generally describes the purpose of the
    endpoint.
   </p><p>
    A sample custom endpoint configuration is provided in the
    <code class="filename">openidm/samples/customendpoint</code> directory. The use
    of this sample is described in
    <a class="xref" href="chap-configuration.html#adding-custom-endpoints-example" title="5.6.6.&nbsp;Custom Endpoint Example">Section&nbsp;5.6.6, &#8220;Custom Endpoint Example&#8221;</a>. Custom endpoints in
    OpenIDM can be written either in JavaScript or Groovy. The sample includes
    three files:
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">conf/endpoint-echo.json</span></dt><dd><p>
       Provides the configuration for the endpoint.
      </p></dd><dt><span class="term">script/echo.js</span></dt><dd><p>
       Supports an endpoint script written in JavaScript.
      </p></dd><dt><span class="term">script/echo.groovy</span></dt><dd><p>
       Supports an endpoint script written in Groovy.
      </p></dd></dl></div><p>
    Endpoint configuration files have a certain structure. They may cite scripts
    written in JavaScript or Groovy.
   </p><p>
    The cited scripts include defined <code class="literal">request</code> and
    <code class="literal">context</code> global variables.
   </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-structure"></a>5.6.1.&nbsp;The Components of an Endpoint Configuration File</h3></div></div></div><p>
     The sample custom endpoint configuration
     (<code class="filename">/path/to/openidm/samples/customendpoint/conf/endpoint-echo.json</code>)
     depicts a typical endpoint, configured to use a Groovy script that is
     specified in the <code class="filename">script/echo.groovy</code> file. The
     structure of the sample configuration is as follows:
    </p><pre class="brush: javascript;">{
  "file" : "echo.groovy",
  "type" : "groovy",
  "_file" : "echo.js",
  "_type" : "text/javascript"
}    </pre><p>
      The <code class="literal">"_file"</code> and <code class="literal">"_type"</code> properties
      are comments, which you can change to accommodate an endpoint written in
      JavaScript.
     </p><p>
      If appropriate, you can also include a <code class="literal">context</code> property
      in this file. The following example shows how the
      <code class="literal">context</code> is used to display routing to an endpoint.
     </p><pre class="brush: javascript;">
  "context" : "endpoint/echo",
     </pre><p>
      The endpoint configuration can specify the route on which the endpoint is
      available. For an example, look at the
      <code class="filename">conf/endpoint-linkedView.json</code> file. The code shown
      declares the route on which the endpoint is available.
     </p><pre class="brush: javascript;">
{
  "context": "endpoint/linkedView/*",
  "type" : "text/javascript",
  "source" : "require('linkedView').fetch(request.resourceName);"
}
     </pre><p>
      The following list describes each property in the custom endpoint
      configuration file:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">"type"</code></span></dt><dd><p>
            string, required
           </p><p>
            Specifies the type of script to be executed. Supported types include
            <code class="literal">"text/javascript"</code> and <code class="literal">"groovy"</code>.
           </p></dd><dt><span class="term"><code class="literal">"file"</code> or <code class="literal">"source"</code></span></dt><dd><p>
            The actual script, inline, or a path to the file that
            contains the script. The script files associated with this sample,
            <code class="filename">echo.js</code> and <code class="filename">echo.groovy</code>,
            support requests using all ForgeRock RESTful CRUD operations
            (including PATCH, ACTION, and QUERY).
           </p></dd><dt><span class="term"><code class="literal">context</code></span></dt><dd><p>
          Requests are dispatched, routed, handled, processed, and more, in a
          <code class="literal">context</code>.
         </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-context-components"></a>5.6.2.&nbsp;Context Component Access Methods</h3></div></div></div><p>
      For both JavaScript and Groovy, the context consists of a chain of
      structures that provide different levels of detail. The detail varies
      depending on the context type:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">security</code></span></dt><dd><p>
         Provides authentication / authorization data.
        </p></dd><dt><span class="term"><code class="literal">http</code></span></dt><dd><p>
         Provides data from the HTTP request.
        </p></dd><dt><span class="term">
        <code class="literal">router</code>
       </span></dt><dd><p>
         Provides data on where the information is sent.
        </p></dd></dl></div><p>
      JavaScript and Groovy access these context structures in different ways.
      The term shown is the JavaScript access method; the definition includes
      the Groovy access method.
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">context.current</code></span></dt><dd><p>
         In Groovy, known simply as <code class="literal">context</code>
        </p><p>
         The current context in which the request is handled by a script or a
         script-hook.
        </p></dd><dt><span class="term">
        <code class="literal">context.http</code>
       </span></dt><dd><p>
         In Groovy, known as one of the following:
         </p><table border="0" summary="Simple list" class="simplelist"><tr><td>
           <code class="literal">
            context.asContext(org.forgerock.json.resource.servlet.HttpContext.class)
           </code>
          </td></tr><tr><td>
           <code class="literal">
            context.getContext("http")
           </code>
          </td></tr></table><p>
        </p><p>
         The HTTP context.
        </p></dd><dt><span class="term"><code class="literal">context.security</code></span></dt><dd><p>
         In Groovy, known as one of the following:
         </p><table border="0" summary="Simple list" class="simplelist"><tr><td>
           <code class="literal">
            context.asContext(org.forgerock.json.resource.SecurityContext.class)
           </code>
          </td></tr><tr><td>
           <code class="literal">
            context.getContext("security")
           </code>
          </td></tr></table><p>
        </p><p>
         The security context.
        </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-request"></a>5.6.3.&nbsp;Custom Endpoints and <code class="literal">request</code> Objects</h3></div></div></div><p>
      The endpoint configuration file specifies a script (either inline with the
      <code class="literal">"source"</code> property, or in a referenced file with the
      <code class="literal">"file"</code> property). The script is invoked with a global
      <code class="literal">request</code> variable in its scope.
     </p><p>
      All processes within OpenIDM are initiated with a request. Requests can
      come either from the REST API, as shown in the <a href="../../integrators-guide/index/appendix-rest.html" class="link"><em class="citetitle">REST API
      Reference</em></a>) or internally, from a script, using the
      <code class="literal">openidm</code> router object, as defined in the
      <a href="../../integrators-guide/index/appendix-router.html" class="link"><em class="citetitle">Router Service
      Reference</em></a>.
      Regardless of how the process is initiated, the details of the request are
      represented in the same way - within an object named <code class="literal">request</code>.
     </p><p>
      Most request types include a complex object that stores the details
      required for that particular request. For example, when you start an
      <code class="literal">action</code> process over the REST interface, you might want
      to include certain detailed information for that action. You include this
      information as a JSON string in the POST body. The HTTP request header
      <code class="literal">Content-type</code> describes this string as
      <code class="literal">application/json</code>.
     </p><p>
      Consider the following REST request:
     </p><div class="screen"><pre><strong>$ curl \
 --cacert self-signed.crt \
 --header "Content-Type: application/json" \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request POST \
 --data { "name": "bob"} \
 "https://localhost:8443/openidm/endpoint/test?_action=myAction"</strong></pre></div><p>
      This request includes the string <code class="literal">'{ "name": "bob"}'</code>
      as the HTTP post body. OpenIDM expects this to be a JSON string, and will
      deserialize it into an object. The object is accessed using
      <code class="literal">request.content</code>.
     </p><p>
      Depending on the type of <code class="literal">request</code>,
      the associated content may include the following
      properties:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">method</code></span></dt><dd><p>The requested operation, which may be <code class="literal">create</code>,
         <code class="literal">read</code>, <code class="literal">update</code>,
         <code class="literal">delete</code>, <code class="literal">patch</code>,
         <code class="literal">query</code> or <code class="literal">action</code>.</p></dd><dt><span class="term"><code class="literal">resourceName</code></span></dt><dd><p>The local identifier, without the <code class="literal">endpoint/</code>
         prefix, such as <code class="literal">echo</code>.</p></dd><dt><span class="term"><code class="literal">newResourceId</code></span></dt><dd><p>
         An identifier associated with a new resource, associated with
         the <code class="literal">create</code> method.
        </p></dd><dt><span class="term"><code class="literal">additionalParameters</code></span></dt><dd><p>The sample code returns request parameters from an HTTP GET
         with <code class="literal">?param=x</code>, as
         <code class="literal">"params":{"param":"x"}</code>.</p></dd><dt><span class="term"><code class="literal">revision</code></span></dt><dd><p>
         The revision level associated with the method used, relative to
         a <code class="literal">newResourceId</code>.
        </p></dd><dt><span class="term"><code class="literal">content</code></span></dt><dd><p>
         Content based on the latest version of the object, using
         <code class="literal">getObject</code>.
        </p></dd><dt><span class="term"><code class="literal">context</code></span></dt><dd><p>
         Based on a JSON object that contains nested attributes. The object
         with the attributes, defines the request, based on ForgeRock REST
         <a href="../../integrators-guide/index/appendix-rest.html#rest-supported-operations" class="link"><em class="citetitle">
         Supported Operations</em></a>.
        </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-chains"></a>5.6.4.&nbsp;Custom Endpoints, Contexts, and Chains</h3></div></div></div><p>
     Custom endpoints include contexts that may be wrapped in various layers,
     analogous to the way network packets can be wrapped at ascending network
     levels.
    </p><p>
     As an example, start with a request such as the following:
    </p><div class="screen"><pre>GET https://localhost:8443/openidm/endpoint/echo?queryId=query-all-ids&amp;_para=foo</pre></div><p>
     A request at an endpoint starts with a root context, associated with a
     specific context ID, and the
     <code class="literal">org.forgerock.json.resource.RootContext</code> context.
    </p><p>
     The root context is wrapped in the security context that holds the
     authentication and authorization detail for the request. The associated
     class is <code class="literal">org.forgerock.json.resource.SecurityContext</code>,
     with an <code class="literal">authenticationId</code> user name such as
     <code class="literal">openidm-admin</code>, and associated roles such as
     <code class="literal">openidm-authorized</code>.
    </p><p>
     That security context is further wrapped by the HTTP context, with the
     target URI. The class is
     <code class="literal">org.forgerock.json.resource.HttpContext</code>, and it is
     associated with the normal parameters of a REST call, including a user
     agent, authorization token, and method.
    </p><p>
     The HTTP context is then further wrapped by one or more server / router
     context(s). That class is
     <code class="literal">org.forgerock.json.resource.RouterContext</code>,
     with an endpoint URI. You may see several layers of server and router
     contexts.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-more"></a>5.6.5.&nbsp;Additional Custom Endpoint Parameters</h3></div></div></div><p>
      A couple of additional parameters are shown with the
      <code class="literal">query</code> request method. You can review how this works
      in the following section of the OpenIDM Installation Guide:
      <a href="../../install-guide/index/chap-samples.html#more-sample2c" class="link"><em class="citetitle">Sample 2c -
      Synchronizing LDAP Group Membership</em></a>.
     </p><p>
      The final statement in the script is the return value. In the following
      example, there is no <code class="literal">return</code> keyword, and the value of
      the last statement (<code class="literal">x</code>) is returned.
     </p><pre class="brush: javascript;">var x = "Sample return";
functioncall();
x   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-custom-endpoints-example"></a>5.6.6.&nbsp;Custom Endpoint Example</h3></div></div></div><p>The following example uses the sample provided in the
      <code class="filename">openidm/samples/customendpoint</code> directory, copied to
      the <code class="filename">openidm/conf</code> and
      <code class="filename">openidm/script</code> directories. The output from the query
      shows the complete request structure.
     </p><div class="screen"><pre>$ <strong>curl \
 --cacert self-signed.crt \
 --header "X-OpenIDM-Username: openidm-admin" \
 --header "X-OpenIDM-Password: openidm-admin" \
 --request GET \
 "https://localhost:8443/openidm/endpoint/echo?_queryId=query-all-ids"
     </strong>
     <em>{
 "result" : [ {
     "method" : "query",
     "resourceName" : "",
     "pagedResultsCookie" : null,
     "pagedResultsOffset" : 0,
     "pageSize" : 0,
     "queryExpression" : null,
     "queryId" : "query-all-ids",
     "queryFilter" : "null",
     "parameters" : { },
     "context" : {
       "parent" : {
         "parent" : {
           "parent" : {
             "parent" : {
               "parent" : {
                 "parent" : null,
                 "contextName" : "root",
                 "rootContext" : true,
                 "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
               },
               "contextName" : "security",
               "authenticationId" : "openidm-admin",
               "authorizationId" : {
                 "id" : "openidm-admin",
                 "component" : "repo/internal/user",
                 "roles" : [ "openidm-admin", "openidm-authorized" ]
               },
               "rootContext" : false,
               "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
             },
             "headers" : {
               "X-OpenIDM-Username" : [ "openidm-admin" ],
               "Host" : [ "localhost:8443" ],
               "Accept" : [ "*/*" ],
               "X-OpenIDM-Password" : [ "openidm-admin" ],
               "User-Agent" : [ "curl/7.19.7 (x86_64-redhat-linux-gnu)
                 libcurl/7.19.7 NSS/3.14.0.0 zlib/1.2.3 libidn/1.18
                 libssh2/1.4.2" ]
             },
             "parameters" : {
               "_queryId" : [ "query-all-ids" ],
               "_prettyPrint" : [ "true" ]
             },
             "external" : true,
             "contextName" : "http",
             "method" : "GET",
             "path" : "https://localhost:8443/openidm/endpoint/echo",
             "rootContext" : false,
             "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
           },
           "contextName" : "apiInfo",
           "apiVersion" : "2.3.1-SNAPSHOT",
           "apiName" : "org.forgerock.commons.json-resource-servlet",
           "rootContext" : false,
           "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
         },
         "contextName" : "server",
         "rootContext" : false,
         "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
       },
       "uriTemplateVariables" : { },
       "contextName" : "router",
       "matchedUri" : "endpoint/echo",
       "baseUri" : "endpoint/echo",
       "rootContext" : false,
       "id" : "43576021-fe54-4468-8d10-09b14af2a36d"
     }
 } ],
 "resultCount" : 1,
 "pagedResultsCookie" : null,
 "remainingPagedResults" : -1
} </em> </pre></div><p>You must protect access to any custom endpoints by configuring the 
    appropriate authorization for those contexts. For more information, see 
    the <a href="../../integrators-guide/index/chap-auth.html#openidm-authorization" class="link">
    <em class="citetitle">Authorization</em></a> section.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="config-default-directories"></a>5.7.&nbsp;Default and Custom Configuration Directories</h2></div></div></div><p>
    You can set up custom configuration files in directories as
    defined in the <code class="filename">openidm/conf/script.json</code> file.
   </p><p>
    The following portion of the <code class="filename">script.json</code> file
    points to sources in installation and project directories. As implied in the
    section on
    <a href="../../integrators-guide/index/chap-services.html#startup-configuration" class="link">
     <em class="citetitle">Specifying the OpenIDM Startup Configuration</em>
    </a>, the <code class="literal">launcher.project.location</code> is the directory
    cited if you start OpenIDM with a specific project directory.</p><pre class="brush: plain;">...
"sources" : {
  "default" : {
    "directory" : "&amp;{launcher.install.location}/bin/defaults/script"
  },
  "install" : {
    "directory" : "&amp;{launcher.install.location}"
  },
  "project" : {
    "directory" : "&amp;{launcher.project.location}"
  },
  "project-script" : {
    "directory" : "&amp;{launcher.project.location}/script"
  }
...</pre><p>
    For example, if you start OpenIDM from the <code class="filename">/path/to/openidm</code>
    directory with the following command:
   </p><div class="screen"><pre>$ ./startup.sh -p /path/to/openidm/customconfig
   </pre></div><p>
    The <code class="literal">launcher.project.location</code> directory would be
    <code class="filename">/path/to/openidm/customconfig</code>.
   </p><p>
    The <code class="filename">script.json</code> file also refers to a
    <code class="literal">launcher.install.location</code> directory, which is
    <code class="filename">/path/to/openidm</code>.
   </p><p>Thus, based on the way the <code class="filename">script.json</code> file
    is configured for <code class="literal">project</code>
    and <code class="literal">project-script</code>, you can add custom
    configuration and script files to the
    <code class="filename">/path/to/openidm/customconfig</code> and the
    <code class="filename">/path/to/openidm/customconfig/script</code> directories.
   </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-ui.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-data.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;4.&nbsp;OpenIDM User Interface&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;6.&nbsp;Accessing Data Objects</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10020&components=10164&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-9']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>