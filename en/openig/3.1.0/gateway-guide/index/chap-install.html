<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;3.&nbsp;Installation in Detail</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Guide to OpenIG"><link rel="up" href="index.html" title="Guide to OpenIG"><link rel="prev" href="chap-quickstart.html" title="Chapter&nbsp;2.&nbsp;Getting Started"><link rel="next" href="chap-credentials-tutorial.html" title="Chapter&nbsp;4.&nbsp;Getting Login Credentials From Data Sources"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;3.&nbsp;Installation in Detail</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-quickstart.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-credentials-tutorial.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-install"></a>Chapter&nbsp;3.&nbsp;Installation in Detail</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-install.html#configure-container">3.1. Configuring Deployment Containers</a></span></dt><dt><span class="section"><a href="chap-install.html#configure-network">3.2. Preparing the Network</a></span></dt><dt><span class="section"><a href="chap-install.html#install">3.3. Installing OpenIG</a></span></dt><dt><span class="section"><a href="chap-install.html#load-balancing">3.4. Preparing For Load Balancing &amp; Failover</a></span></dt><dt><span class="section"><a href="chap-install.html#client-side-security">3.5. Configuring OpenIG For HTTPS (Client-Side)</a></span></dt><dt><span class="section"><a href="chap-install.html#keystore-for-jwt-encryption">3.6. Setting Up Keys For JWT Encryption</a></span></dt></dl></div><p>
  This chapter covers more advanced installation procedures.
 </p><a class="indexterm" name="d0e1104"></a><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Make sure you have a supported Java version installed.
   </p><p>
    See the <em class="citetitle">Release Notes</em> section,
    <a href="../../release-notes/index/chap-before-you-install.html#java-requirements" class="link"><em class="citetitle">JDK Version</em></a>, for details.
   </p></li><li class="listitem"><p>
    Prepare a deployment container.
   </p><p>
    For details, see <a class="xref" href="chap-install.html#configure-container" title="3.1.&nbsp;Configuring Deployment Containers">Section&nbsp;3.1, &#8220;Configuring Deployment Containers&#8221;</a>.
   </p></li><li class="listitem"><p>
    Prepare the network to use OpenIG as a reverse proxy.
   </p><p>
    For details, see <a class="xref" href="chap-install.html#configure-network" title="3.2.&nbsp;Preparing the Network">Section&nbsp;3.2, &#8220;Preparing the Network&#8221;</a>.
   </p></li><li class="listitem"><p>
    Download, deploy, and configure OpenIG.
   </p><p>
    For details, see <a class="xref" href="chap-install.html#install" title="3.3.&nbsp;Installing OpenIG">Section&nbsp;3.3, &#8220;Installing OpenIG&#8221;</a>.
   </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-container"></a>3.1.&nbsp;Configuring Deployment Containers</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-install.html#about-securing-connections">3.1.1. About Securing Connections</a></span></dt><dt><span class="section"><a href="chap-install.html#tomcat">3.1.2. Configuring Apache Tomcat For OpenIG</a></span></dt><dt><span class="section"><a href="chap-install.html#jetty">3.1.3. Configuring Jetty For OpenIG</a></span></dt></dl></div><p>
   This section provides installation and configuration tips
   that you need to run OpenIG in supported containers.
  </p><p>
   For the full list of supported containers,
   see the <em class="citetitle">Release Notes</em> section,
   <a href="../../release-notes/index/chap-before-you-install.html#which-container" class="link"><em class="citetitle">Web Application Containers</em></a>.
  </p><p>
   For further information on advanced configuration for a particular container,
   see the container documentation.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="about-securing-connections"></a>3.1.1.&nbsp;About Securing Connections</h3></div></div></div><p>
    OpenIG is often deployed to replay credentials
    or other security information.
    In a real world deployment,
    that information must be communicated over a secure connection using HTTPS,
    meaning in effect HTTP over encrypted Transport Layer Security (TLS).
    Never send real credentials, bearer tokens, or other security information
    unprotected over HTTP.
   </p><p>
    When OpenIG is acting as a server,
    the web application container where OpenIG runs
    is responsible for setting up TLS connections
    with client applications that connect to OpenIG.
    For details, see <a class="xref" href="chap-install.html#jetty-https" title="3.1.3.2.&nbsp;Configuring Jetty For HTTPS (Server-Side)">Section&nbsp;3.1.3.2, &#8220;Configuring Jetty For HTTPS (Server-Side)&#8221;</a>
    or <a class="xref" href="chap-install.html#tomcat-https" title="3.1.2.2.&nbsp;Configuring Tomcat For HTTPS (Server-Side)">Section&nbsp;3.1.2.2, &#8220;Configuring Tomcat For HTTPS (Server-Side)&#8221;</a>.
   </p><p>
    When OpenIG is acting as a client, the
    <a href="../../reference/index/HttpClient.html" class="link">HttpClient</a> configuration sets up TLS connections
    from OpenIG to other servers.
    For details, see <a class="xref" href="chap-install.html#client-side-security" title="3.5.&nbsp;Configuring OpenIG For HTTPS (Client-Side)">Section&nbsp;3.5, &#8220;Configuring OpenIG For HTTPS (Client-Side)&#8221;</a>.
   </p><p>
    TLS depends on the use of digital certificates (public keys).
    In typical use of TLS,
    the client authenticates the server by its X.509 digital certificate
    as the first step to establishing communication.
    Once trust is established,
    then the client and server can set up
    a symmetric key to encrypt communications.
   </p><p>
    In order for the client to trust the server certificate,
    the client needs first to trust
    the certificate of the party who signed the server's certificate.
    This means that either the client
    has a trusted copy of the signer's certificate,
    or the client has a trusted copy
    of the certificate of the party who signed the signer's certificate.
   </p><p>
    Certificate Authorities (CAs) are trusted signers
    with well-known certificates.
    Browsers generally ship with many well-known CA certificates.
    Java distributions also ship with many well-known CA certificates.
    Getting a certificate signed by a well-known CA generally costs money.
   </p><p>
    It is also possible for you to self-sign certificates.
    The trade off is that although you do not have to pay any money,
    the certificate is not trusted by any clients until they have a copy.
    Whereas it is often enough
    to install a certificate signed by a well-known CA
    in the server key store as the basis of trust for HTTPS connections,
    self-signed certificates must also be installed in all clients.
   </p><p>
    Like self-signed certificates,
    the signing certificates of less well-known CAs
    are also unlikely to be found in the default trust store.
    You might therefore need to install those signing certificates
    on the client side as well.
   </p><p>
    This guide describes how to install self-signed certificates,
    which are certainly fine for trying out the software
    and okay for deployments where you manage all clients
    that access OpenIG.
    If you need a well-known CA signed certificate instead,
    see the documentation for your container for details
    on requesting a CA signature and installing the CA signed certificate.
   </p><p>
    Once certificates are properly installed to allow client-server trust,
    also consider the cipher suites configured for use.
    The cipher suite used determines the security settings for the communication.
    Initial TLS negotiations bring the client and server to agreement on which
    cipher suite to use.
    Basically the client and server share their preferred cipher suites
    to compare and to choose.
    If you therefore have a preference concerning the cipher suites to use,
    you must set up your container to use only your preferred cipher suites.
    Otherwise the container is likely to inherit the list of cipher suites
    from the underlying Java environment.
   </p><p>
    The Java Secure Socket Extension (JSSE), part of the Java environment,
    provides security services that OpenIG uses to secure connections.
    You can set security and system properties to configure the JSSE.
    For a list of properties you can use to customize the JSSE in Oracle Java,
    see the <em class="citetitle">Customization</em> section of the
    <a class="link" href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/jsse/JSSERefGuide.html#Customization" target="_blank"><em class="citetitle">JSSE Reference Guide</em></a>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tomcat"></a>3.1.2.&nbsp;Configuring Apache Tomcat For OpenIG</h3></div></div></div><p>
    This section describes essential Apache Tomcat configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d0e1203"></a><p>
    Download and install a supported version of Apache Tomcat from
    <a class="link" href="http://tomcat.apache.org/" target="_blank">http://tomcat.apache.org/</a>.
   </p><p>
    Configure Tomcat to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Tomcat to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Tomcat to do so as well.
   </p><p>
    To configure Tomcat to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-cookie-domains"></a>3.1.2.1.&nbsp;Configuring Tomcat Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Tomcat to set domain cookies.
     To do this, add a session cookie domain context element
     that specifies the domain to
     <code class="filename">/path/to/conf/Catalina/<em class="replaceable"><code>server</code></em>/root.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Context sessionCookieDomain=".example.com" /&gt;

    </pre><p>
     Restart Tomcat to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-https"></a>3.1.2.2.&nbsp;Configuring Tomcat For HTTPS (Server-Side)</h4></div></div></div><p>
     To get Tomcat up quickly on an SSL port
     add an entry similar to the following in
     <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    </p><pre class="brush: xml;">
&lt;Connector
 port="8443"
 protocol="HTTP/1.1"
 SSLEnabled="true"
 maxThreads="150"
 scheme="https"
 secure="true"
 address="127.0.0.1"
 clientAuth="false"
 sslProtocol="TLS"
 keystoreFile="/path/to/tomcat/conf/keystore"
 keystorePass="password"
/&gt;

    </pre><p>
     Also create a key store holding a self-signed certificate.
    </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias tomcat \
 -keyalg RSA \
 -keystore /path/to/tomcat/conf/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
    </pre></div><p>
     Notice the key store file location and the key store password
     both match the configuration.
     By default, Tomcat looks for a certificate with alias <code class="literal">tomcat</code>.
    </p><p>
     Restart Tomcat to read the configuration changes.
    </p><p>
     Browsers generally do not trust self-signed certificates.
     To work with a certificate signed instead by a trusted CA,
     see the Apache Tomcat documentation on configuring HTTPS.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-mysql"></a>3.1.2.3.&nbsp;Configuring Tomcat to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Apache Tomcat to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/tomcat/lib/</code>
       so that it is on Tomcat's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/tomcat/conf/context.xml</code>.
      </p><pre class="brush: xml;">
&lt;Resource
 name="jdbc/forgerock"
 auth="Container"
 type="javax.sql.DataSource"
 maxActive="100"
 maxIdle="30"
 maxWait="10000"
 username="mysqladmin"
 password="password"
 driverClassName="com.mysql.jdbc.Driver"
 url="jdbc:mysql://localhost:3306/databasename"
/&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/tomcat/conf/web.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Tomcat to read the configuration changes.
      </p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jetty"></a>3.1.3.&nbsp;Configuring Jetty For OpenIG</h3></div></div></div><p>
    This section describes essential Jetty configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d0e1303"></a><p>
    Download and install a supported version of Jetty from
    <a class="link" href="http://download.eclipse.org/jetty/" target="_blank">http://download.eclipse.org/jetty/</a>.
   </p><p>
    Configure Jetty to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Jetty to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Jetty to do so as well.
   </p><p>
    To configure Jetty to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-cookie-domains"></a>3.1.3.1.&nbsp;Configuring Jetty Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Jetty to set domain cookies.
     To do this, add a session domain handler element
     that specifies the domain to
     <code class="filename">/path/to/jetty/etc/jetty.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Get name="sessionHandler"&gt;
    &lt;Get name="sessionManager"&gt;
        &lt;Set name="sessionDomain"&gt;.example.com&lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Get&gt;

    </pre><p>
     Restart Jetty to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-https"></a>3.1.3.2.&nbsp;Configuring Jetty For HTTPS (Server-Side)</h4></div></div></div><p>
    To get Jetty up quickly on an SSL port, follow the steps in this section.
   </p><p>
    These steps involve replacing the built-in key store with your own.
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
      If you have not done so already, remove the built-in key store.
     </p><div class="screen"><pre>
$ <strong>rm /path/to/jetty/etc/keystore</strong>
     </pre></div></li><li class="step"><p>
      Generate a new key pair with self-signed certificate in the key store.
     </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias jetty \
 -keyalg RSA \
 -keystore /path/to/jetty/etc/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
     </pre></div></li><li class="step"><p>
      Find the obfuscated form of the password.
     </p><div class="screen"><pre>
$ <strong>java \
 -cp /path/to/jetty/lib/jetty-util-*.jar \
 org.eclipse.jetty.util.security.Password \
 password</strong>
<em>password
OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v
MD5:5f4dcc3b5aa765d61d8327deb882cf99</em>
     </pre></div></li><li class="step"><p>
      Edit the SSL Context Factory entry in the Jetty configuration file,
      <code class="filename">/path/to/jetty/etc/jetty-ssl.xml</code>.
     </p><pre class="brush: xml;">
&lt;New id="sslContextFactory" class="org.eclipse.jetty.http.ssl.SslContextFactory"&gt;
  &lt;Set name="KeyStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="KeyStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="KeyManagerPassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="TrustStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="TrustStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
&lt;/New&gt;

   </pre></li><li class="step"><p>
      Uncomment the line specifying that configuration file in
      <code class="filename">/path/to/jetty/start.ini</code>.
     </p><pre class="brush: ini;">
etc/jetty-ssl.xml
     </pre></li><li class="step"><p>
      Restart Jetty.
     </p></li><li class="step"><p>
      Browse <a class="link" href="https://www.example.com:8443" target="_blank">https://www.example.com:8443</a>.
     </p><p>
      You should see a warning in the browser
      that the (self-signed) certificate is not recognized.
     </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-mysql"></a>3.1.3.3.&nbsp;Configuring Jetty to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Jetty to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/jetty/lib/jndi/</code>
       so that it is on Jetty's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
      </p><pre class="brush: xml;">
&lt;New id="jdbc/forgerock" class="org.eclipse.jetty.plus.jndi.Resource"&gt;
  &lt;Arg&gt;&lt;/Arg&gt;
  &lt;Arg&gt;jdbc/forgerock&lt;/Arg&gt;
  &lt;Arg&gt;
    &lt;New class="com.mysql.jdbc.jdbc2.optional.MysqlConnectionPoolDataSource"&gt;
      &lt;Set name="Url"&gt;jdbc:mysql://localhost:3306/databasename&lt;/Set&gt;
      &lt;Set name="User"&gt;mysqladmin&lt;/Set&gt;
      &lt;Set name="Password"&gt;password&lt;/Set&gt;
    &lt;/New&gt;
  &lt;/Arg&gt;
&lt;/New&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Jetty to read the configuration changes.
      </p></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-network"></a>3.2.&nbsp;Preparing the Network</h2></div></div></div><p>
   In order for OpenIG to function as a reverse proxy,
   browsers attempting to access the protected application
   must go through OpenIG instead.
  </p><p>
   Modify DNS or host file settings so that
   the host name of the protected application
   resolves to the IP address of OpenIG
   on the system where the browser runs.
  </p><p>
   Restart the browser after making this change.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install"></a>3.3.&nbsp;Installing OpenIG</h2></div></div></div><div class="procedure"><p>
    Follow these steps to install OpenIG.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download the OpenIG.
    </p><div class="itemizedlist"><p>
      OpenIG can be downloaded from these locations.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Enterprise Software Downloads</a> page
       provides thoroughly validated release builds
       for ForgeRock customers who run OpenIG in production deployments,
       and for those who want to try or test with release builds.
      </p><p>
       Use this build with officially released project documentation from
       <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.
      </p><p>
       Make sure you review and agree with
       the Software License and Subscription Agreement
       in order to use the software.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-builds/" target="_blank">Nightly Builds</a> page
       offers the very latest successful nightly build of the latest code.
      </p><p>
       Use this build to get a preview of the latest features and fixes,
       when reading along with the draft documentation.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-archive/" target="_blank">Archive</a> page
       makes older builds available.
      </p></li></ul></div></li><li class="step"><p>
     Deploy the OpenIG war file <span class="emphasis"><em>to the root context</em></span>
     of the web application container.
    </p><p>
     OpenIG must be deployed to the root context, not below.
    </p></li><li class="step"><p>
     Prepare your OpenIG configuration files.
    </p><div class="variablelist"><p>
      By default, OpenIG files are located under
      <code class="filename">$HOME/.openig</code> on Linux, Mac OS X, and UNIX systems,
      and <code class="filename">%appdata%\OpenIG</code> on Windows systems.
      OpenIG uses the following file system directories.
     </p><dl class="variablelist"><dt><span class="term"><code class="filename">$HOME/.openig/config</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\config</code></span></dt><dd><p>
        OpenIG configuration files,
        where the main configuration file is <code class="filename">config.json</code>.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/config/routes</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\config\routes</code></span></dt><dd><p>
        OpenIG route configuration files.
       </p><p>
        See the chapter,
        <a href="../../gateway-guide/index/chap-routing.html" class="link"><em class="citetitle">Configuring Routes</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\SAML</code></span></dt><dd><p>
        OpenIG SAML 2.0 configuration files.
       </p><p>
        See the chapter,
        <a href="../../gateway-guide/index/chap-federation.html" class="link"><em class="citetitle">Using OpenIG Federation</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/scripts/groovy</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\scripts\groovy</code></span></dt><dd><p>
        OpenIG script files, for Groovy scripted filters and handlers.
       </p><p>
        See the chapter,
        <a href="../../gateway-guide/index/chap-extending.html" class="link"><em class="citetitle">Extending OpenIG</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/tmp</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\tmp</code></span></dt><dd><p>
        OpenIG temporary files.
       </p><p>
        This location can be used for temporary storage.
       </p></dd></dl></div><div class="itemizedlist"><p>
      You can change <code class="filename">$HOME/.openig</code>
      (or <code class="filename">%appdata%\OpenIG</code>)
      from the default location in the following ways.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Unpack the OpenIG war file,
       and edit the <code class="filename">WEB-INF/web.xml</code> application descriptor
       to set the <code class="literal">openig-base</code> initialization parameter
       to the full path to the base location for OpenIG files,
       as in the following example.
      </p><pre class="brush: xml;">

 &lt;servlet&gt;
   &lt;servlet-name&gt;GatewayServlet&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.forgerock.openig.servlet.GatewayServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
     &lt;param-name&gt;openig-base&lt;/param-name&gt;
     &lt;param-value&gt;/path/to/openig&lt;/param-value&gt;
   &lt;/init-param&gt;
 &lt;/servlet&gt;

      </pre></li><li class="listitem"><p>
       Set the <code class="literal">OPENIG_BASE</code> environment variable
       to the full path to the base location for OpenIG files.
      </p><div class="screen"><pre>
# On Linux, Mac OS X, and UNIX using Bash
$ <strong>export OPENIG_BASE=/path/to/openig</strong>

# On Windows
C:&gt;<strong>set OPENIG_BASE=c:\path\to\openig</strong>
      </pre></div></li><li class="listitem"><p>
       Set the <code class="literal">openig.base</code> Java system property
       to the full path to the base location for OpenIG files
       when starting the web application container where OpenIG runs,
       as in the following example that starts Jetty server in the foreground.
      </p><div class="screen"><pre>
$ <strong>java -Dopenig.base=/path/to/openig -jar start.jar</strong>
      </pre></div></li></ul></div><p>
     If you have not yet prepared configuration files,
     then start with the configuration from the chapter on
     <a href="../../gateway-guide/index/chap-quickstart.html#quickstart-config" class="link"><em class="citetitle">Getting Started</em></a>.
    </p><p>
     Copy the template to <code class="filename">$HOME/.openig/config/config.json</code>.
     Replace the "baseURI" of the "DispatchHandler"
     with that of the protected application.
    </p><p>
     On Windows,
     copy the template to <code class="filename">%appdata%\OpenIG\config\config.json</code>.
     To locate the <code class="filename">%appdata%</code> folder
     for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create the <code class="filename">%appdata%\OpenIG\config</code> folder,
     and then add the configuration file.
    </p></li><li class="step"><p>
     Start the web container where OpenIG is deployed.
    </p></li><li class="step"><p>
     Browse to the protected application.
    </p><p>
     OpenIG should now proxy all traffic to the application.
    </p></li><li class="step"><p>
     Make sure the browser is going through OpenIG.
    </p><p>
     Verify this in one of the following ways.
    </p><ul class="stepalternatives">
     <li class="step"><ol type="a" class="substeps"><li class="step"><p>
         Stop the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you cannot browse to the protected application.
        </p></li><li class="step"><p>
         Start the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you can now browse to the protected application again.
        </p></li></ol></li>

     <li class="step"><p>
       Check the LogSink to see that traffic is going through OpenIG.
      </p><p>
       The default ConsoleLogSink is the deployment container log.
      </p></li>
    </ul></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="load-balancing"></a>3.4.&nbsp;Preparing For Load Balancing &amp; Failover</h2></div></div></div><p>
   For a high scale or highly available deployment,
   you can prepare a pool of OpenIG servers
   with nearly identical configurations,
   and then load balance requests across the pool,
   routing around any servers that become unavailable.
   Load balancing allows the service to handle more load.
  </p><p>
   Before you spread requests across multiple servers, however,
   you must determine what to do with state information
   that OpenIG saves in the exchange,
   or retrieves locally from the OpenIG server system.
   If information is retrieved locally,
   then also consider setting up failover
   so that if one server becomes unavailable,
   another server in the pool can take its place.
   The benefit of failover is
   that a server failure can be invisible to client applications.
  </p><div class="itemizedlist"><p>
    OpenIG can save state information in the exchange in several ways.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Handlers including a
     <a href="../../reference/index/SamlFederationHandler.html" class="link">SamlFederationHandler</a>
     or a custom
     <a href="../../reference/index/ScriptableHandler.html" class="link">ScriptableHandler</a>
     can store information in the exchange.
     Most handlers depend on information in the exchange,
     some of which is first stored by OpenIG.
    </p></li><li class="listitem"><p>
     Filters including those having types
     <a href="../../reference/index/AssignmentFilter.html" class="link">AssignmentFilter</a>,
     <a href="../../reference/index/HeaderFilter.html" class="link">HeaderFilter</a>,
     <a href="../../reference/index/OAuth2ClientFilter.html" class="link">OAuth2ClientFilter</a>,
     <a href="../../reference/index/OAuth2ResourceServerFilter.html" class="link">OAuth2ResourceServerFilter</a>,
     <a href="../../reference/index/ScriptableFilter.html" class="link">ScriptableFilter</a>,
     <a href="../../reference/index/SqlAttributesFilter.html" class="link">SqlAttributesFilter</a>,
     and
     <a href="../../reference/index/StaticRequestFilter.html" class="link">StaticRequestFilter</a>
     can store information in the exchange.
     Most filters depend on information in the exchange,
     some of which is first stored by OpenIG.
    </p></li></ul></div><div class="itemizedlist"><p>
    OpenIG can also retrieve information locally in several ways.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Filters and handlers including
     <a href="../../reference/index/FileAttributesFilter.html" class="link">FileAttributesFilter</a>,
     <a href="../../reference/index/ScriptableFilter.html" class="link">ScriptableFilter</a>,
     <a href="../../reference/index/ScriptableHandler.html" class="link">ScriptableHandler</a>,
     and
     <a href="../../reference/index/SqlAttributesFilter.html" class="link">SqlAttributesFilter</a>
     can depend on local system files or container configuration.
    </p></li></ul></div><p>
   By default the exchange data resides in memory in the container
   where OpenIG runs.
   This includes the default session implementation,
   which is backed by the HttpSession that the container handles.
   You can opt to store session data on the user-agent instead, however.
   For details and to consider whether your data fits, see
   <a href="../../reference/index/JwtSession.html" class="link">JwtSession</a>.
   When you use the <code class="literal">JwtSession</code> implementation,
   be sure to share the encryption keys across all servers,
   so that any server can read session cookies from any other.
  </p><p>
   If your data does not fit in an HTTP cookie,
   for example because when encrypted it is larger than 4 KB,
   consider storing a reference in the cookie,
   and then retrieve the data by using another filter.
   OpenIG logs warning messages if the JwtSession cookie is too large.
   Using a reference can also work when a server becomes unavailable,
   and the load balancer must fail requests over to another server in the pool.
  </p><p>
   If some data attached to an exchange must be stored on the server side,
   then you have additional configuration steps to perform
   for session stickiness and for session replication.
   Session stickiness means that the load balancer sends all requests
   from the same client session to the same server.
   Session stickiness helps to ensure that a client request goes
   to the server holding the original session data.
   Session replication involves writing session data
   either to other servers or to a data store,
   so that if one server goes down,
   other servers can read the session data and continue processing.
   Session replication helps when one server fails,
   allowing another server to take its place
   without having to start the session over again.
   If you set up session stickiness but not session replication,
   when a server crashes the client session information for that server is lost,
   and the client must start again with a new session.
  </p><p>
   How you configure session stickiness and session replication
   depends on your load balancer and on your container.
  </p><div class="itemizedlist"><p>
    Apache Tomcat can help with session stickiness,
    and a Tomcat cluster can handle session replication.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     If you choose to use the
     <a class="link" href="http://tomcat.apache.org/connectors-doc/" target="_blank">Apache Tomcat connector</a> (mod_jk) on your web server
     to perform load balancing, then see the
     <a class="link" href="http://tomcat.apache.org/connectors-doc/generic_howto/loadbalancers.html" target="_blank"><em class="citetitle">LoadBalancer HowTo</em></a> for details.
    </p><p>
     Notice in that HowTo that
     you configure the <code class="literal">jvmRoute</code> attribute
     in the Tomcat server configuration,
     <code class="filename">/path/to/tomcat/conf/server.xml</code>,
     to identify the server.
     The connector can use this identifier to achieve session stickiness.
    </p></li><li class="listitem"><p>
     A Tomcat
     <a class="link" href="http://tomcat.apache.org/tomcat-7.0-doc/config/cluster.html" target="_blank">cluster</a> configuration can handle session replication.
     When setting up a cluster configuration, the
     <a class="link" href="http://tomcat.apache.org/tomcat-7.0-doc/config/cluster-manager.html" target="_blank">ClusterManager</a> defines the session replication implementation.
    </p></li></ul></div><div class="itemizedlist"><p>
    Jetty has provisions for session stickiness,
    and also for session replication through clustering.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Jetty's persistent session mechanism appends a node ID to the session ID,
     in the same way Tomcat appends the <code class="literal">jvmRoute</code> value
     to the session cookie.
     This can be useful for session stickiness
     if your load balancer examines the session ID.
    </p></li><li class="listitem"><p>
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/session-clustering-jdbc.html" target="_blank">Session Clustering with a Database</a>
     describes how to configure Jetty to persist sessions over JDBC,
     allowing session replication.
    </p><p>
     Unless it is set up to be highly available,
     the database can be a single point of failure in this case.
    </p></li><li class="listitem"><p>
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/session-clustering-mongodb.html" target="_blank">Session Clustering with MongoDB</a>
     describes how to configure Jetty to persist sessions in MongoDB,
     allowing session replication.
    </p><p>
     The Jetty documentation recommends this implementation
     when session data is seldom written but often read.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="client-side-security"></a>3.5.&nbsp;Configuring OpenIG For HTTPS (Client-Side)</h2></div></div></div><p>
   For OpenIG to connect to a server securely over HTTPS,
   OpenIG must be able to trust the server.
   The default settings rely on the Java environment trust store
   to trust server certificates.
   The Java environment default trust store includes
   public key signing certificates
   from many well-known Certificate Authorities (CAs).
   If all servers present certificates signed by these CAs,
   then you have nothing to configure.
  </p><p>
   If however the server certificates are self-signed
   or signed by a CA whose certificate is not trusted out of the box,
   then you can configure a
   <a href="../../reference/index/KeyStore.html" class="link">KeyStore</a>,
   <a href="../../reference/index/TrustManager.html" class="link">TrustManager</a>,
   and optionally a
   <a href="../../reference/index/KeyManager.html" class="link">KeyManager</a>
   to reference when configuring an
   <a href="../../reference/index/HttpClient.html" class="link">HttpClient</a>
   to enable OpenIG to trust servers when acting as a client.
  </p><p>
   The KeyStore holds the servers' certificates or the CA signing certificate.
   The TrustManager allows OpenIG to handle the certificates
   in the KeyStore when deciding whether to trust a server certificate.
   The optional KeyManager allows OpenIG to present its certificate
   from the key store when the server must authenticate OpenIG as client.
   The HttpClient references whatever TrustManager and KeyManager you configure.
  </p><p>
   You can configure each of these either globally for the OpenIG server,
   of locally for a particular ClientHandler configuration.
  </p><p>
   The Java KeyStore holds the peer servers' public key certificates
   (and optionally the OpenIG certificate and private key).
   For example, suppose you have a certificate file, <code class="filename">ca.crt</code>,
   that holds the trusted signer's certificate
   of the CA who signed the server certificates
   of the servers in your deployment.
   In that case, you could import the certificate into a Java Key Store file,
   <code class="filename">/path/to/keystore.jks</code>.
  </p><div class="screen"><pre>
$ <strong>keytool \
 -import \
 -trustcacerts \
 -keystore /path/to/keystore \
 -file ca.crt \
 -alias ca-cert \
 -storepass changeit</strong>
  </pre></div><p>
   You could then configure the following "KeyStore" for OpenIG
   that holds the trusted certificate.
   Notice that the "url" field takes an expression that evaluates to a URL,
   starting with a scheme such as <code class="literal">file://</code>.
  </p><pre class="brush: javascript;">
{
    "name": "MyKeyStore",
    "type": "KeyStore",
    "config": {
        "url": "file:///path/to/keystore",
        "password": "changeit"
    }
}
  </pre><p>
   The TrustManager handles the certificates in the KeyStore
   when deciding whether to trust the server certificate.
   The TrustManager references your KeyStore.
  </p><pre class="brush: javascript;">
{
    "name": "MyTrustManager",
    "type": "TrustManager",
    "config": {
        "keystore": "MyKeyStore"
    }
}
  </pre><div class="variablelist"><p>
    The HttpClient configuration has the following security settings.
   </p><dl class="variablelist"><dt><span class="term">"trustManager"</span></dt><dd><p>
      This references your TrustManager.
     </p><p>
      Recall that you must configure this
      when your server certificates are not trusted out of the box.
     </p></dd><dt><span class="term">"hostnameVerifier"</span></dt><dd><p>
      This defines how the HttpClient verifies host names in server certificates.
     </p><p>
      By default, host name verification is turned off.
     </p></dd><dt><span class="term">"keyManager"</span></dt><dd><p>
      This references your optional KeyManager.
     </p><p>
      Configure this if servers request that OpenIG present
      its certificate as part of mutual authentication.
     </p><p>
      In that case, generate a key pair for OpenIG,
      and have the certificate signed by a well-known CA.
      See the <span class="command"><strong>keytool</strong></span> documentation for instructions.
      You can use a different key store for the KeyManager
      than you use for the TrustManager.
     </p></dd></dl></div><p>
   The following HttpClient configuration references "MyTrustManager"
   and sets browser-compatible host name verification.
  </p><pre class="brush: javascript;">
{
    "name": "HttpClient",
    "type": "HttpClient",
    "config": {
        "hostnameVerifier": "BROWSER_COMPATIBLE",
        "trustManager": "MyTrustManager"
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="keystore-for-jwt-encryption"></a>3.6.&nbsp;Setting Up Keys For JWT Encryption</h2></div></div></div><p>
   You can use
   <a href="../../reference/index/JwtSession.html" class="link">JwtSession</a> to configure OpenIG
   to store session information in JWT cookies on the user-agent,
   rather than storing the information
   in the container where OpenIG runs.
  </p><p>
   In order to encrypt the JWTs, OpenIG needs cryptographic keys.
   OpenIG can generate its own key pair in memory,
   but that key pair disappears on restart
   and cannot be shared across OpenIG servers.
  </p><p>
   Alternatively, OpenIG can use keys from a key store.
   The following steps describe how to prepare the key store for JWT encryption.
  </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
     Generate the key pair in a new key store file
     by using the Java <span class="command"><strong>keytool</strong></span> command.
    </p><p>
     The following command generates a Java Key Store format file,
     <code class="filename">/path/to/keystore.jks</code>,
     holding a key pair with alias <code class="literal">jwe-key</code>.
     Notice that both the key store and the private key have the same password.
    </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias jwe-key \
 -keyalg rsa \
 -keystore /path/to/keystore.jks \
 -storepass changeit \
 -keypass changeit \
 -dname "CN=www.example.com,O=Example Corp"</strong>
    </pre></div></li><li class="step"><p>
     Add a
     <a href="../../reference/index/KeyStore.html" class="link">KeyStore</a>
     to your configuration that references the key store file.
    </p><pre class="brush: javascript;">
{
    "name": "MyKeyStore",
    "type": "KeyStore",
    "config": {
        "url": "file:///path/to/keystore.jks",
        "password": "changeit"
    }
}
    </pre></li><li class="step"><p>
     Add a JwtSession to your configuration that references your KeyStore.
    </p><pre class="brush: javascript;">
{
    "name": "MyJwtSession",
    "type": "JwtSession",
    "config": {
        "keystore": "MyKeyStore",
        "alias": "jwe-key",
        "password": "changeit",
        "cookieName": "OpenIG"
    }
}
    </pre></li><li class="step"><p>
     Specify your JwtSession object in the top-level configuration,
     or in the route configuration.
    </p><pre class="brush: javascript;">
"session": "MyJwtSession"
    </pre></li></ol></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-quickstart.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-credentials-tutorial.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;2.&nbsp;Getting Started&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;4.&nbsp;Getting Login Credentials From Data Sources</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10060&components=10220&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-14']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>