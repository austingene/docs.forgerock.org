<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Guide to OpenIG</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="gateway-guide"></a>Guide to OpenIG</h1></div><div><h2 class="subtitle">Version 3.1.0</h2></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Paul </span> <span class="surname">Bryan</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Mark </span> <span class="surname">Craig</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Jamie </span> <span class="surname">Nelson</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Guillaume </span> <span class="surname">Sauthier</span></h3><div lang="en" class="affiliation"><span class="orgname">ForgeRock AS<br></span><div class="address"><p><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="street">33&nbsp;New&nbsp;Montgomery&nbsp;St.</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="otheraddr">Suite&nbsp;1500</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="city">San&nbsp;Francisco</span>,&nbsp;<span class="state">CA</span>&nbsp;<span class="postcode">94105</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="country">USA</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="phone">+1&nbsp;415-599-1100&nbsp;(US)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<code class="uri">www.forgerock.com</code><br>
&nbsp;&nbsp;&nbsp;</p></div></div></div></div></div><div><p class="releaseinfo">Software release date: December 12, 2014</p></div><div><p class="copyright">Copyright &copy; 2011-2014 ForgeRock AS</p></div><div><a href="legalnotice.html">Legal Notice</a></div><div><p class="pubdate">Publication date: December 05, 2014</p></div></div><hr></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#chap-start-here">1. Understanding OpenIG</a></span></dt><dt><span class="chapter"><a href="#chap-quickstart">2. Getting Started</a></span></dt><dt><span class="chapter"><a href="#chap-install">3. Installation in Detail</a></span></dt><dt><span class="chapter"><a href="#chap-credentials-tutorial">4. Getting Login Credentials From Data Sources</a></span></dt><dt><span class="chapter"><a href="#chap-password-capture-replay-tutorial">5. Getting Login Credentials From OpenAM</a></span></dt><dt><span class="chapter"><a href="#chap-federation">6. OpenIG as a SAML 2.0 Service Provider</a></span></dt><dt><span class="chapter"><a href="#chap-oauth2-rs">7. OpenIG as an OAuth 2.0 Resource Server</a></span></dt><dt><span class="chapter"><a href="#chap-oauth2-client">8. OpenIG as an OAuth 2.0 Client</a></span></dt><dt><span class="chapter"><a href="#chap-routing">9. Configuring Routes</a></span></dt><dt><span class="chapter"><a href="#chap-gateway-templates">10. Configuration Templates</a></span></dt><dt><span class="chapter"><a href="#chap-extending">11. Extending OpenIG</a></span></dt><dt><span class="chapter"><a href="#chap-auditing">12. OpenIG Audit Framework</a></span></dt><dt><span class="chapter"><a href="#chap-troubleshooting">13. Troubleshooting</a></span></dt><dt><span class="appendix"><a href="#appendix-multiple-sps">A. SAML 2.0 &amp; Multiple Applications</a></span></dt><dt><span class="index"><a href="#d1182e5357">Index</a></span></dt></dl></div><div lang="en" class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="preface"></a>Preface</h1></div></div></div><p>
  This guide shows you how to install and configure OpenIG,
  a high-performance reverse proxy server with specialized session management
  and credential replay functionality.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d1182e156"></a>1.&nbsp;Who Should Use this Guide</h2></div></div></div><p>
   This guide is written for access management designers and administrators
   who develop, build, deploy, and maintain OpenIG deployments
   for their organizations.
   This guide covers the tasks you might perform once
   or repeat throughout the life cycle of an OpenIG release.
  </p><p>
   You do not need to be an expert to learn something from this guide,
   though a background in HTTP, access management web applications can help.
   You do need some background in managing services on your operating systems
   and in your application servers.
   You can nevertheless get started with this guide,
   and then learn more as you go along.
  </p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="formatting-conventions"></a>2.&nbsp;Formatting Conventions</h2></div></div></div><p>
  Most examples in the documentation are created on GNU/Linux or Mac OS X.

  Where it is helpful to make a distinction between operating environments,
  examples for UNIX, GNU/Linux, Mac OS X, and so forth are labeled (UNIX).
  Mac OS X specific examples can be labeled (Mac OS X).
  Examples for Microsoft Windows can be labeled (Windows).

  To avoid repetition, however, file system directory names are
  often given only in UNIX format as in <code class="filename">/path/to/server</code>,
  even if the text applies to <code class="filename">C:\path\to\server</code> as well.
 </p><p>
  Absolute path names usually begin with the placeholder
  <code class="filename">/path/to/</code>.

  This path might translate to <code class="filename">/opt/</code>,
  <code class="filename">C:\Program Files\</code>, or somewhere else on your system.
 </p><p>
  Command line, terminal sessions are formatted as follows.
 </p><div class="screen"><pre>$ <strong>echo $JAVA_HOME</strong>
<em>/path/to/jdk</em></pre></div><p>
  Command output is sometimes formatted for narrower, more readable output
  even though formatting parameters are not shown in the command.
  In the following example, the query string parameter
  <code class="literal">_prettyPrint=true</code> is omitted.
 </p><div class="screen"><pre>
$ <strong>curl https://bjensen:hifalutin@opendj.example.com:8443/users/newuser</strong>
<em>{
  "_rev" : "000000005b337348",
  "schemas" : [ "urn:scim:schemas:core:1.0" ],
  "contactInformation" : {
    "telephoneNumber" : "+1 408 555 1212",
    "emailAddress" : "newuser@example.com"
  },
  "_id" : "newuser",
  "name" : {
    "familyName" : "New",
    "givenName" : "User"
  },
  "userName" : "newuser@example.com",
  "displayName" : "New User",
  "meta" : {
    "created" : "2014-06-03T09:58:27Z"
  },
  "manager" : [ {
    "_id" : "kvaughan",
    "displayName" : "Kirsten Vaughan"
  } ]
}</em>
 </pre></div><p>
  Program listings are formatted as follows.
 </p><pre class="brush: java;">class Test {
    public static void main(String [] args)  {
        System.out.println("This is a program listing.");
    }
}</pre></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="accessing-doc-online"></a>3.&nbsp;Accessing Documentation Online</h2></div></div></div><p>
  ForgeRock core documentation, such as what you are now reading, aims to be
  technically accurate and complete with respect to the software documented.
 </p><div class="itemizedlist"><p>
   Core documentation therefore follows a three-phase review process
   designed to eliminate errors.
  </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Product managers and software architects review project documentation design
    with respect to the users' software lifecycle needs.
   </p></li><li class="listitem"><p>
    Subject matter experts review proposed documentation changes for
    technical accuracy and completeness
    with respect to the corresponding software.
   </p></li><li class="listitem"><p>
    Quality experts validate implemented documentation changes for
    technical validity with respect to the software,
    technical completeness with respect to the scope of the document,
    and usability for the expected audience.
   </p></li></ul></div><p>
  The review process helps to ensure that documentation published for
  a ForgeRock release is technically accurate and complete.
 </p><p>
  Fully reviewed, published core documentation is available at
  <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.

  Use this documentation when working with a ForgeRock Enterprise release.
 </p><p>
  In-progress documentation can be found at each project site under the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> projects page.

  Use this documentation when trying a nightly build.
 </p><p>
  The ForgeRock <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a> and provide additional, user-created information.

  We encourage you to
  <a class="link" href="https://sso.forgerock.com/openam/UI/Login" target="_blank">join the community</a>, so that you can update the Wikis, too.
 </p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="joining-the-community"></a>4.&nbsp;Joining the ForgeRock Community</h2></div></div></div><p>
  After you
  <a class="link" href="https://backstage.forgerock.com/#/account/register" target="_blank">sign up</a> to join the ForgeRock community,
  you can edit the
  <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a>,
  and also log bugs and feature requests in the
  <a class="link" href="https://bugster.forgerock.org/" target="_blank">issue tracker</a>.
 </p><p>
  If you have a question regarding a project but cannot find an answer
  in the project documentation or Wiki, browse to the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> page for the project,
  where you can find details on joining the project mailing lists,
  and find links to mailing list archives.

  You can also suggest updates to documentation through the
  <a class="link" href="https://lists.forgerock.org/mailman/listinfo/docs" target="_blank">ForgeRock docs mailing list</a>.
 </p><p>
  The Community Wikis describe how to check out and build source code.

  Should you want to contribute a patch, test, or feature,
  or want to author part of the core documentation,
  first have a look on the ForgeRock site at
  <a class="link" href="http://forgerock.org/get_involved.html" target="_blank">how to get involved</a>.
 </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-start-here"></a>Chapter&nbsp;1.&nbsp;Understanding OpenIG</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about">1.1. About OpenIG</a></span></dt><dt><span class="section"><a href="#the-exchange">1.2. The Exchange</a></span></dt><dt><span class="section"><a href="#the-configuration">1.3. The Configuration</a></span></dt><dt><span class="section"><a href="#routing">1.4. Routing</a></span></dt><dt><span class="section"><a href="#filters-handlers-chains">1.5. Filters, Handlers, &amp; Chains</a></span></dt><dt><span class="section"><a href="#config-comments">1.6. Comments in OpenIG Configuration Files</a></span></dt><dt><span class="section"><a href="#where-to-go-from-here">1.7. Where To Go From Here</a></span></dt></dl></div><p>
  This chapter introduces OpenIG, briefly covering essential concepts.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about"></a>1.1.&nbsp;About OpenIG</h2></div></div></div><p>
   Most organizations have valuable existing services
   that they cannot easily integrate into newer architectures.
   Often, however, they also cannot change the existing services.
   Without a gateway to bridge the gap,
   some client applications cannot communicate with these existing services.
  </p><div class="figure"><a name="figure-missing-gateway"></a><div class="figure-title">Figure&nbsp;1.1.&nbsp;Missing Gateway</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/missing-gateway.png" align="middle" height="360" alt="Missing Gateway"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e291.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   OpenIG works as an HTTP gateway, also known as a
   <a class="link" href="http://en.wikipedia.org/wiki/Reverse_proxy" target="_blank">reverse proxy</a>.
   You deploy OpenIG on the network
   so that it intercepts both client requests and also server responses.
  </p><div class="figure"><a name="figure-gateway-deployed"></a><div class="figure-title">Figure&nbsp;1.2.&nbsp;OpenIG Deployed</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/gateway-deployed.png" align="middle" height="360" alt="OpenIG Deployed"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e307.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   Clients then exchange with protected servers through OpenIG.
   This means that without touching either clients or servers,
   you can configure OpenIG to add new capabilities
   to existing services.
  </p><div class="itemizedlist"><p>
    The list that follows names some of what you can add by using OpenIG.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Access management integration
    </p></li><li class="listitem"><p>
     Application &amp; API security
    </p></li><li class="listitem"><p>
     Credential replay
    </p></li><li class="listitem"><p>
     OAuth 2.0 support
    </p></li><li class="listitem"><p>
     OpenID Connect 1.0 support
    </p></li><li class="listitem"><p>
     Network traffic control
    </p></li><li class="listitem"><p>
     Proxy with request &amp; response capture
    </p></li><li class="listitem"><p>
     Request &amp; response rewriting
    </p></li><li class="listitem"><p>
     SAML 2.0 federation support
    </p></li><li class="listitem"><p>
     Single sign-on
    </p></li></ul></div><p>
   OpenIG supports these capabilities
   as out-of-the-box configuration options.
   Once you understand the essential concepts covered in this chapter,
   try the demonstrations in this guide to see for yourself
   how to add these features by using OpenIG.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-exchange"></a>1.2.&nbsp;The Exchange</h2></div></div></div><p>
   OpenIG handles HTTP requests and responses
   with a wrapper called the <em class="firstterm">exchange</em>.
  </p><p>
   The OpenIG exchange encapsulates HTTP requests and responses
   that pass through OpenIG,
   as well as the principal associated with the request,
   the session context associated with the client,
   and any other state information needed.
   OpenIG makes it easy
   to access arbitrary state information through the exchange
   so that you can use it throughout the duration of the exchange,
   even when the exchange calls for interaction with additional services.
  </p><p>
   In addition, OpenIG includes information in the exchange
   about the client that made the incoming request,
   such as the client host, port, and IP address,
   and also the user-agent description,
   the login of the user making the request,
   and the X.509 certificates presented by the client
   when these are available as part of the request.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-configuration"></a>1.3.&nbsp;The Configuration</h2></div></div></div><p>
   OpenIG represents its configuration in JSON format,
   which is store in flat files.<a href="#ftn.d1182e369" class="footnote" name="d1182e369"><sup class="footnote">[1]</sup></a>
   You configure OpenIG by editing the JSON flat files.
  </p><p>
   After installation, you add at least one configuration file.
   Each configuration file holds a JSON object.
   At minimum, the JSON object specifies a "handler" to deal with the exchange.
  </p><p>
   The following very simple configuration routes exchanges
   to be handled according to separate route configurations.
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Router"
    }
}
  </pre><p>
   The "handler" indicates which object OpenIG invokes first.
   A handler is an object responsible for producing a response to a request,
   therefore every route must call a handler.
  </p><p>
   Notice in this case that the "handler" field takes an object as its value.
   This is an inline declaration.
   If you only use the object once where it is declared,
   then it makes sense to use an inline declaration.
  </p><p>
   To change the definition of an object defined by default
   or when you need to declare an object once and use it multiple times,
   you declare object definitions in the "heap",
   and then reference the objects by "name".
   You can also use this technique instead of inline declarations.
  </p><p>
   The following example declares an identical "Router" object as above
   and references it by its name.
  </p><pre class="brush: javascript;">
{
    "handler": "My Router",
    "heap": [
        {
            "name": "My Router",
            "type": "Router"
        }
    ]
}
  </pre><p>
   Notice that the "heap" takes an array.
   As the "heap" holds configuration objects all at the same level,
   you can impose any hierarchy or order that you like when referencing objects.
   Yet, when you declare all objects in the "heap" and reference them by name,
   neither hierarchy nor ordering are obvious
   from the structure of the configuration file alone.
  </p><div class="itemizedlist"><p>
    Each configuration object has a "type", a "name", and an optional "config".
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The "type" must be the type name of the configuration object.<a href="#ftn.d1182e397" class="footnote" name="d1182e397"><sup class="footnote">[2]</sup></a>
    </p><p>
     As you see in the rest of this guide
     and in the <em class="citetitle">Reference</em>,
     OpenIG defines many types for different purposes.
    </p></li><li class="listitem"><p>
     The "name" takes a string that is unique in the list of objects.
    </p><p>
     You can omit this field when declaring objects inline.
    </p></li><li class="listitem"><p>
     The contents of the "config" object depend on the "type".
    </p><p>
     When all the configuration settings for the type are optional,
     the "config" field is also optional, as in this example.
     If all configuration settings are optional,
     then omitting the "config" field,
     or setting the "config" field to an empty object, "config": {},
     or setting "config": null
     all signify that the object uses default settings.
    </p></li></ul></div><p>
   The configuration can specify additional objects as well.
   For example, you can configure an "HttpClient"
   that OpenIG uses to connect to servers.
   The following "HttpClient" configuration uses defaults for all settings,
   except "hostnameVerifier", which it configures to
   verify host names in SSL certificates in the same way as most browsers.
  </p><pre class="brush: javascript;">
{
    "name": "HttpClient",
    "type": "HttpClient",
    "config": {
        "hostnameVerifier": "BROWSER_COMPATIBLE"
    }
}
  </pre><p>
   <em class="firstterm">Decorators</em> are additional heap objects
   that let you extend what another object can do.
   For example, a "CaptureDecorator" enables filters and handlers
   to log requests and responses.
   A "TimerDecorator" logs processing times.
   You decorate the configuration of other objects
   with the names of decorators as field names.
   OpenIG defines both a "CaptureDecorator" named "capture"
   and also a "TimerDecorator" named "timer" by default.
   You can therefore log requests, responses, and processing times
   by adding decorations as shown in the following example.
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Router",
        "capture": [ "request", "response" ],
        "timer": true
    }
}
  </pre><p>
   In addition to decorators, OpenIG also creates
   other utility objects with default settings,
   including "HttpClient", "LogSink", and "TemporaryStorage".
   You can reference these objects by name without configuring them
   unless you need to override the default configurations.
  </p><p>
   Routes, mentioned here
   and described in more detail in <a class="xref" href="#routing" title="1.4.&nbsp;Routing">Section&nbsp;1.4, &#8220;Routing&#8221;</a>,
   inherit settings from their parent configurations.
   This means that you can
   configure global objects in the "heap" of the base configuration for example,
   and then reference the objects by name
   in any other OpenIG configuration.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing"></a>1.4.&nbsp;Routing</h2></div></div></div><p>
   OpenIG routing lets you use multiple configuration files.
   Routing also lets OpenIG reload configurations
   that you change at runtime without restarting OpenIG.
  </p><p>
   You can use routing where OpenIG protects multiple services,
   or multiple different endpoints of the same service.
   You can also use routing when handling an exchange involves multiple steps,
   for example because you must redirect the client
   to authenticate with an identity provider
   before accessing the service.
  </p><p>
   A <em class="firstterm">router</em>,
   as shown in <a class="xref" href="#the-configuration" title="1.3.&nbsp;The Configuration">Section&nbsp;1.3, &#8220;The Configuration&#8221;</a>,
   takes responsibility for managing the routes used,
   periodically reloading changed routes
   unless configured to load them only at startup.
  </p><p>
   Notice in the example that the router does not specify any routes.
   Instead, routes optionally specify their own "condition".
   If a route "condition" is true, then the route handles the exchange.
  </p><p>
   The following example specifies a condition
   that is true when the incoming request path is <code class="literal">/login</code>.
  </p><pre class="brush: javascript;">
"condition": "${matches(exchange.request.uri.path, '^/login')}"
  </pre><p>
   If the route has no "condition", or if the value of the condition is null,
   then the route matches any exchange.
   Furthermore, OpenIG orders routes lexicographically by name.
  </p><p>
   You can use these features to have both optional and default routes.
   For example, you could name your routes to check conditions in order:
   <code class="filename">01-login.json</code>,
   <code class="filename">02-protected.json</code>,
   <code class="filename">99-default.json</code>.
   Alternatively, you can name routes using the "name" property on the route.
  </p><p>
   A router configuration can specify where to look for route files.
   As a "Router" is a kind of "handler", routes can have routers, too.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filters-handlers-chains"></a>1.5.&nbsp;Filters, Handlers, &amp; Chains</h2></div></div></div><p>
   Routing only delegates exchange handling.
   It does not actually deal with exchanges.
   To deal with an exchange, you chain together filters and handlers.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     A <em class="firstterm">handler</em> either delegates to another handler,
     or it produces a response.
    </p><p>
     One way of producing a response is
     to send a request to and receive a response from an external service.
     In this case, OpenIG acts as a client of the service,
     often on behalf of the client whose request initiated the exchange.
    </p><p>
     Another way of producing a response is
     to build a response either statically or based on something in the exchange.
     In this case, OpenIG plays the role of server,
     generating a response to return to the client.
    </p></li><li class="listitem"><p>
     A <em class="firstterm">filter</em> transforms something in the exchange.
    </p><p>
     A filter can leave the exchange unchanged.
     Alternatively a filter can even replace the request or the response,
     for example generating a static request that replaces the client request.
     Other filters only add or change some of the data in the exchange.
    </p></li><li class="listitem"><p>
     A <em class="firstterm">chain</em> takes a list of filters and one handler.
     (The list of filters can be empty.)
    </p><p>
     Like a router, a chain itself is technically a handler.
     You can therefore place a chain anywhere in the configuration
     that you can place a handler.
    </p><p>
     The chain dispatches processing to the filters in order,
     and then to the handler.
    </p><p>
     Initially the filters process the incoming exchange,
     with each filter handing off to the next filter and finally the handler.
     Then after the handler produces the response,
     the filters process the outgoing exchange on its way to the client.
     The same filter can process the incoming request and the outgoing response.
     Many filters, however, either process the request or the response.
    </p></li></ul></div><p>
   The following diagram shows the flow inside a chain that has
   a request filter transforming the request,
   a response filter transforming the response,
   and a handler sending a request to a service to get a response.
   Notice how the flow traverses the filters in reverse order
   when the outgoing exchange comes back from the handler.
  </p><div class="figure"><a name="figure-chain"></a><div class="figure-title">Figure&nbsp;1.3.&nbsp;Flow Inside a Chain</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/chain.png" align="middle" height="360" alt="Flow Inside a Chain"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e512.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   The following route configuration demonstrates the flow,
   but without an external service.
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "comment": "Base configuration defines the capture decorator",
        "config": {
            "filters": [
                {
                    "type": "HeaderFilter",
                    "comment": "Same header on all requests",
                    "config": {
                        "messageType": "REQUEST",
                        "add": {
                            "X-MyHeaderFilter": [
                                "Added by HeaderFilter to request"
                            ]
                        }
                    }
                },
                {
                    "type": "HeaderFilter",
                    "comment": "Remove X-Powered-By from response",
                    "capture": "response",
                    "config": {
                        "messageType": "RESPONSE",
                        "remove": [
                            "X-Powered-By"
                        ]
                    }
                }
            ],
            "handler": {
                "type": "StaticResponseHandler",
                "comment": "Same response to all requests",
                "capture": "request",
                "config": {
                    "status": 200,
                    "reason": "OK",
                    "headers": {
                        "X-Powered-By": [
                            "OpenIG"
                        ]
                    },
                    "entity": "&lt;html&gt;&lt;p&gt;Hello, World!&lt;/p&gt;&lt;/html&gt;"
                }
            }
        }
    }
}
  </pre><div class="orderedlist"><p>
    When the "Chain" gets the request, it processes the exchange as follows.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     The first "HeaderFilter" adds a header to the incoming request.
    </p></li><li class="listitem"><p>
     The second "HeaderFilter" deals with responses,
     so it simply passes the exchange to the handler.
    </p></li><li class="listitem"><p>
     The "StaticResponseHandler" captures (logs) the request.
    </p></li><li class="listitem"><p>
     The "StaticResponseHandler" itself produces a response
     having an entity body and a header.
    </p></li><li class="listitem"><p>
     The second "HeaderFilter" captures (logs) the response.
    </p></li><li class="listitem"><p>
     The second "HeaderFilter" removes the header added to the response.
    </p></li><li class="listitem"><p>
     The first "HeaderFilter" deals with requests,
     so it simply passes the outgoing exchange back to OpenIG.
    </p></li></ol></div><p>
   Suppose this chain configuration is the only route active for the request.
   In that case, the flow produces the following.
  </p><pre class="brush: http;">
### Original request from user-agent
GET / HTTP/1.1
Host: www.example.com:8080
Accept: */*

### Captured incoming request (inside OpenIG exchange)
GET / HTTP/1.1
X-MyHeaderFilter: Added by HeaderFilter to request
Accept: */*
Host: www.example.com:8080

### Captured outgoing response (inside OpenIG exchange)
HTTP/1.1 200 OK
Content-Length: 33
X-Powered-By: OpenIG

&lt;html&gt;&lt;p&gt;Hello, World!&lt;/p&gt;&lt;/html&gt;

### Final response to user-agent
HTTP/1.1 200 OK
Content-Length: 33

&lt;html&gt;&lt;p&gt;Hello, World!&lt;/p&gt;&lt;/html&gt;
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="config-comments"></a>1.6.&nbsp;Comments in OpenIG Configuration Files</h2></div></div></div><p>
   JSON does not specify a notation for comments.
  </p><p>
   However, when OpenIG does not recognize a JSON field name,
   it ignores the field.
   This makes it possible to use comments in configuration files.
  </p><div class="variablelist"><p>
    To make your configuration files easier to read,
    use the following conventions when commenting.
   </p><dl class="variablelist"><dt><span class="term">"comment"</span></dt><dd><p>
      Use the "comment" fields to add text comments.
     </p><p>
      The following "CaptureDecorator" configuration includes a text comment.
     </p><pre class="brush: javascript;">
{
    "name": "capture",
    "type": "CaptureDecorator",
    "comment": "Write request and response information to the LogSink",
    "config": {
        "captureEntity": true
    }
}
     </pre></dd><dt><span class="term">"_<em class="replaceable"><code>field-name</code></em>"</span></dt><dd><p>
      Use an underscore (<code class="literal">_</code>) to comment a field temporarily.
     </p><p>
      The following "CaptureDecorator" configuration has
      <code class="literal">"captureEntity": true</code> commented out.
      As a result, it uses the default setting
      (<code class="literal">"captureEntity": false</code>).
     </p><pre class="brush: javascript;">
{
    "name": "capture",
    "type": "CaptureDecorator",
    "config": {
        "_captureEntity": true
    }
}
     </pre></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="where-to-go-from-here"></a>1.7.&nbsp;Where To Go From Here</h2></div></div></div><p>
   Now that you understand the essential concepts,
   start using OpenIG with the help of the following chapters.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>
    </span></dt><dd><p>
      This chapter shows you how to get OpenIG up and running quickly.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-install" class="link"><em class="citetitle">Installation in Detail</em></a>
    </span></dt><dd><p>
      This chapter covers more advanced installation procedures.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-credentials-tutorial" class="link"><em class="citetitle">Getting Login Credentials From Data Sources</em></a>
    </span></dt><dd><p>
      This chapter shows you how to configure OpenIG
      to look up credentials in external sources, such as a file or a database.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-password-capture-replay-tutorial" class="link"><em class="citetitle">Getting Login Credentials From OpenAM</em></a>
    </span></dt><dd><p>
      This chapter walks you through an OpenAM integration
      with OpenAM's password capture and replay feature.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">OpenIG as a SAML 2.0 Service Provider</em></a>
    </span></dt><dd><p>
      This chapter shows how to configure OpenIG
      as a SAML 2.0 Identity Provider.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-oauth2-rs" class="link"><em class="citetitle">OpenIG as an OAuth 2.0 Resource Server</em></a>
    </span></dt><dd><p>
      This chapter explains how OpenIG acts
      as an OAuth 2.0 Resource Server,
      and follows with a tutorial
      that shows you how to use OpenIG as a resource server.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-oauth2-client" class="link"><em class="citetitle">OpenIG as an OAuth 2.0 Client</em></a>
    </span></dt><dd><p>
      This chapter explains how OpenIG acts
      as an OAuth 2.0 client or OpenID Connect 1.0 relying party,
      and follows with a tutorial
      that shows you how to use OpenIG
      as an OpenID Connect 1.0 relying party.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-routing" class="link"><em class="citetitle">Configuring Routes</em></a>
    </span></dt><dd><p>
      This chapter shows how to configure OpenIG
      to allow dynamic configuration changes and route to multiple applications.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-gateway-templates" class="link"><em class="citetitle">Configuration Templates</em></a>
    </span></dt><dd><p>
      This chapter provides sample OpenIG configuration files
      for common use cases.
     </p></dd></dl></div><p>
   ForgeRock can also help you succeed in your projects involving OpenIG.
   You can purchase OpenIG support subscriptions and training courses
   from ForgeRock and from consulting partners around the world and in your area.
   To contact ForgeRock, send mail to
   <a class="link" href="mailto:info@forgerock.com" target="_top">info@forgerock.com</a>.
   To find a partner in your area, see
   <a class="link" href="http://forgerock.com/partners/find-a-partner/" target="_blank">http://forgerock.com/partners/find-a-partner/</a>.
  </p></div><div class="footnotes"><br><hr class="footnote-hr"><div id="ftn.d1182e369" class="footnote"><p><a href="#d1182e369" class="para"><sup class="para">[1] </sup></a>
     OpenIG also uses additional file formats for SAML 2.0,
     but the primary configuration files are in JSON format.
    </p></div><div id="ftn.d1182e397" class="footnote"><p><a href="#d1182e397" class="para"><sup class="para">[2] </sup></a>
      For built-in objects, you can use the short name alias.
      If the object has no alias,
      use the fully qualified class name
      of the Java class implementing the object.
     </p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-quickstart"></a>Chapter&nbsp;2.&nbsp;Getting Started</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#before-you-quickstart">2.1. Before You Begin</a></span></dt><dt><span class="section"><a href="#quickstart-install">2.2. Install OpenIG</a></span></dt><dt><span class="section"><a href="#quickstart-sample-app">2.3. Install an Application to Protect</a></span></dt><dt><span class="section"><a href="#quickstart-config">2.4. Configure OpenIG</a></span></dt><dt><span class="section"><a href="#quickstart-network-config">2.5. Configure the Network</a></span></dt><dt><span class="section"><a href="#quickstart-try-it-out">2.6. Try It Out</a></span></dt></dl></div><a class="indexterm" name="d1182e692"></a><p>
  This chapter provides instructions to get OpenIG up and running on Jetty,
  configured to serve as reverse proxy
  to a minimal HTTP server for use when following along with the documentation.
  This allows you to quickly see how OpenIG works,
  and provides hands on experience with a few key features.
  For more general installation and configuration instructions,
  start with the chapter on
  <a href="../gateway-guide/index.html#chap-install" class="link"><em class="citetitle">Installation in Detail</em></a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="before-you-quickstart"></a>2.1.&nbsp;Before You Begin</h2></div></div></div><p>
   Make sure you have a supported Java Development Kit installed.
   For details, see the <em class="citetitle">Release Notes</em> section,
   <a href="../release-notes/index.html#java-requirements" class="link"><em class="citetitle">JDK Version</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-install"></a>2.2.&nbsp;Install OpenIG</h2></div></div></div><p>
   You install OpenIG in the root context of a web application container.
   In this chapter, you use Jetty server as the web application container.
  </p><div class="procedure"><p>
    To perform initial installation, follow these steps.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download and unzip a supported version of Jetty server.
    </p><p>
     Supported versions are listed in the <em class="citetitle">Release Notes</em> section,
     <a href="../release-notes/index.html#which-container" class="link"><em class="citetitle">Web Application Containers</em></a>.
    </p></li><li class="step"><p>
     <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Download</a> the OpenIG war file.
    </p></li><li class="step"><p>
     Deploy OpenIG in the root context.
    </p><p>
     Copy the OpenIG war file as <code class="filename">root.war</code>
     to the <code class="filename">/path/to/jetty/webapps/</code>.
    </p><div class="screen"><pre>
$ <strong>cp OpenIG-3.1.0.war /path/to/jetty/webapps/root.war</strong>
    </pre></div><p>
     Jetty automatically deploys OpenIG in the root context on startup.
    </p></li><li class="step"><p>Start Jetty in the background:</p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh start</strong>
    </pre></div><p>Or start Jetty in the foreground:</p><div class="screen"><pre>
$ <strong>cd /path/to/jetty/</strong>
$ <strong>java -jar start.jar</strong>
    </pre></div></li><li class="step"><p>
     Verify that you can see the OpenIG welcome page at
     <a class="link" href="http://localhost:8080" target="_blank">http://localhost:8080</a>.
    </p><p>
     When you start OpenIG without a configuration,
     requests to OpenIG default to a welcome page
     with a link to the documentation.
    </p></li><li class="step"><p>
     Stop Jetty in the background:
    </p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh stop</strong>
    </pre></div><p>
     Or stop Jetty in the foreground
     by entering Ctrl+C in the terminal where Jetty is running.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-sample-app"></a>2.3.&nbsp;Install an Application to Protect</h2></div></div></div><p>
   Now that OpenIG is installed,
   set up a sample application to protect.
  </p><div class="procedure"><p>
    Follow these steps.
   </p><ol class="procedure" type="1"><li class="step"><p lang="en">
 Download and run the
 <a class="link" href="http://maven.forgerock.org/repo/releases/org/forgerock/openig/openig-doc-samples/3.1.0/openig-doc-samples-3.1.0-jar-with-dependencies.jar" target="_top">minimal HTTP server .jar</a>
 to use as the application to protect.
</p><div class="screen"><pre>
$ <strong>java -jar openig-doc-samples-3.1.0-jar-with-dependencies.jar</strong>
<em>Jun 11, 2014 4:32:42 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Starting HTTP server on port 8081
Jun 11, 2014 4:32:42 PM org.glassfish.grizzly.http.server.NetworkListener start
INFO: Started listener bound to [0.0.0.0:8081]
Jun 11, 2014 4:32:42 PM org.glassfish.grizzly.http.server.HttpServer start
INFO: [HttpServer] Started.
Jun 11, 2014 4:32:42 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Press Ctrl+C to stop the server.
</em>
    </pre></div><p>
     By default, this server listens on port 8081.
     If that port is not free, specify another port.
    </p><div class="screen"><pre>
$ <strong>java -jar openig-doc-samples-3.1.0-jar-with-dependencies.jar 8888</strong>
<em>Jun 11, 2014 4:33:04 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Starting HTTP server on port 8888
Jun 11, 2014 4:33:04 PM org.glassfish.grizzly.http.server.NetworkListener start
INFO: Started listener bound to [0.0.0.0:8888]
Jun 11, 2014 4:33:04 PM org.glassfish.grizzly.http.server.HttpServer start
INFO: [HttpServer] Started.
Jun 11, 2014 4:33:04 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Press Ctrl+C to stop the server.</em>
    </pre></div></li><li class="step"><p>
     Now access the minimal HTTP server through a browser at
     <a class="link" href="http://localhost:8081" target="_blank">http://localhost:8081</a>.
    </p><p>
     Login with username <code class="literal">demo</code>,
     password <code class="literal">changeit</code>.
     You should see a page that includes the username, <code class="literal">demo</code>,
     and some information about your browser request.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-config"></a>2.4.&nbsp;Configure OpenIG</h2></div></div></div><p>
   Now that you have installed both OpenIG
   and also a sample application to protect,
   and configure OpenIG.
  </p><div class="procedure"><p>
    Follow these steps to configure OpenIG
    to proxy traffic to the sample application.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Prepare the OpenIG configuration.
    </p><p>
     Add the following base configuration file
     as <code class="filename">$HOME/.openig/config/config.json</code>.
     By default, OpenIG looks for <code class="filename">config.json</code>
     in the <code class="filename">$HOME/.openig/config</code> directory.
    </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Router",
        "audit": "global",
        "capture": "all"
    },
    "heap": [
        {
            "name": "LogSink",
            "type": "ConsoleLogSink",
            "config": {
                "level": "DEBUG"
            }
        },
        {
            "name": "JwtSession",
            "type": "JwtSession"
        },
        {
            "name": "ClientHandler",
            "type": "ClientHandler"
        },
        {
            "name": "capture",
            "type": "CaptureDecorator",
            "config": {
                "captureEntity": true,
                "_captureExchange": true
            }
        }
    ],
    "baseURI": "http://www.example.com:8081"
}

  </pre><div class="screen"><pre>
$ <strong>mkdir -p $HOME/.openig/config</strong>
$ <strong>vi $HOME/.openig/config/config.json</strong>
    </pre></div><p>
     On Windows, the configuration files belong in
     <code class="filename">%appdata%\OpenIG\config</code>.
     To locate the <code class="filename">%appdata%</code> folder
     for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create the <code class="filename">%appdata%\OpenIG\config</code> folder,
     and then copy the configuration files.
    </p><p>
     If you adapt this base configuration for production use,
     make sure to adjust the log level,
     and to deactivate the "CaptureDecorator"
     that generates several log message lines for each request and response.
     Also consider editing the router based on recommendations in the section,
     <a href="../gateway-guide/index.html#routing-lockdown" class="link"><em class="citetitle">Locking Down Route Configurations</em></a>.
    </p></li><li class="step"><p>
     Add the following default route configuration file
     as <code class="filename">$HOME/.openig/config/routes/99-default.json</code>.
     By default, the Router defined in the base configuration file
     looks for routes in the <code class="filename">$HOME/.openig/config/routes</code> directory.
    </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler"
}

  </pre><div class="screen"><pre>
$ <strong>mkdir $HOME/.openig/config/routes</strong>
$ <strong>vi $HOME/.openig/config/routes/99-default.json</strong>
    </pre></div><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\99-default.json</code>.
    </p></li><li class="step"><p>Start Jetty in the background:</p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh start</strong>
    </pre></div><p>Or start Jetty in the foreground:</p><div class="screen"><pre>
$ <strong>cd /path/to/jetty/</strong>
$ <strong>java -jar start.jar</strong>
    </pre></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-network-config"></a>2.5.&nbsp;Configure the Network</h2></div></div></div><p>
   So far you have deployed OpenIG in the root context of Jetty on port 8080.
   Since OpenIG is a reverse proxy you must make sure
   that all traffic from your browser to the protected application
   goes through OpenIG.
   In other words, the network must be configured
   so that the browser goes to OpenIG
   instead of going directly to the protected application.
  </p><p>
   Although if you followed the installation steps you are running
   both OpenIG and the minimal HTTP server
   on the same host as your browser (probably your laptop or desktop),
   keep in mind that network configuration is an important deployment step.
   To encourage you to keep this in mind,
   the sample configuration for this chapter expects the minimal HTTP server
   to be running on <code class="literal">www.example.com</code>,
   rather than <code class="literal">localhost</code>.
  </p><p>
   The quickest way to configure the network locally is to add an entry to your
   <code class="filename">/etc/hosts</code> file on UNIX systems
   or <code class="filename">%SystemRoot%\system32\drivers\etc\hosts</code> on Windows.
   See the Wikipedia entry,
   <a class="link" href="http://en.wikipedia.org/wiki/Hosts_(file)" target="_blank"><em class="citetitle">Hosts (file)</em></a>,
   for more information on host files.
   If you are indeed running all servers in this chapter on the same host,
   add the following entry to the hosts file.
  </p><pre class="brush: plain;">127.0.0.1    www.example.com</pre><p>
   If you are running the browser and OpenIG on separate hosts,
   add the IP address of the host running OpenIG
   to the hosts file on the system running the browser,
   where the host name matches that of protected application.
   For example, if OpenIG is running on a host with IP address 192.168.0.15:
  </p><pre class="brush: plain;">192.168.0.15    www.example.com</pre><p>
   If OpenIG is on a different host from the protected application,
   also make sure that the host name of the protected application
   resolves correctly for requests from OpenIG to the application.
  </p><div class="tip"><h3 class="title">Tip</h3><p>
    Some browsers cache IP address resolutions,
    even after clearing all browsing data.
    Restart the browser after changing the IP addresses of named hosts.
  </p><p>
    The simplest way to make sure you have configured
    your DNS or host settings properly for remote systems is to stop OpenIG
    and then to make sure you cannot reach the target application
    with the host name and port number of OpenIG.
    If you can still reach it, double check your host settings.
  </p><p>
    Also make sure name resolution is configured to check host files before DNS.
    This configuration can be found in <code class="filename">/etc/nsswitch.conf</code>
    for most UNIX systems.
    Make sure <code class="literal">files</code> is listed before <code class="literal">dns</code>.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-try-it-out"></a>2.6.&nbsp;Try It Out</h2></div></div></div><p>
   <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>
   should take you to the home page of the minimal HTTP server.
  </p><p>
   What just happened?
  </p><p>
   When your browser goes to <code class="literal">http://www.example.com:8080/</code>,
   it is actually connecting to OpenIG deployed in Jetty.
   OpenIG proxies all traffic it receives to the protected application at
   <code class="literal">http://www.example.com:8080/</code>,
   and returns responses from the application to your browser.
   It does this based on the configuration that you set up.
  </p><p>
   Consider the base configuration file first, <code class="filename">config.json</code>.
   The base configuration file specifies a router handler named "Router".
   OpenIG calls this handler when it receives an incoming request.
   In addition, it uses the "LogSink" to log debug messages to the console.
   Alternatively, to send log messages to a file you can use a
   <a href="../reference/index.html#FileLogSink" class="link">"FileLogSink"</a>, rather than a "ConsoleLogSink".
  </p><p>
   The "baseURI" setting in turn changes the request URI
   to point the request to the sample application to protect.
   The "Router" captures the request on the way in,
   and captures the response on the way out.
  </p><p>
   The "Router" routes processing to separate route configurations.
  </p><p>
   For now the only route available is the the default route you added,
   <code class="filename">99-default.json</code>.
   The default route calls a "ClientHandler" with the default configuration.
   This "ClientHandler" simply proxies the request to and the response from
   the sample application to protect
   without changing either the request or the response.
   Therefore, the browser request is sent unchanged to the sample application
   and the response from the sample application
   is returned unchanged to your browser.
  </p><div class="orderedlist"><p>
    Now change the OpenIG configuration to log you in automatically
    with hard-coded credentials.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Add a route to automatically log you in as
     username <code class="literal">demo</code>, password <code class="literal">password</code>.
    </p><p>
     Add the following route configuration file
     as <code class="filename">$HOME/.openig/config/routes/01-static.json</code>.
    </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "demo"
                            ],
                            "password": [
                                "changeit"
                            ]
                        }
                    }
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/static')}"
}

  </pre><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\01-static.json</code>.
    </p></li><li class="listitem"><p>
     Access the new route,
     <a class="link" href="http://www.example.com:8080/static" target="_blank">http://www.example.com:8080/static</a>.
    </p><p>
     This time, OpenIG logs you in automatically.
    </p></li></ol></div><p>
   Also view the information logged about requests and responses,
   which shows up in the Jetty log.
  </p><p>
   What's happening behind the scenes?
  </p><p>
   With the original configuration,
   OpenIG does not change requests or responses,
   but only proxies requests and responses,
   and captures request and response information.
  </p><p>
   After you change the configuration,
   OpenIG continues to capture request and response data.
   When your request does not goes to the default route,
   but instead goes to <code class="literal">/static</code>,
   then the condition on the new route you added matches the request.
   OpenIG therefore uses the new route you added.
  </p><p>
   Using the route configuration in <code class="filename">01-static.json</code>,
   OpenIG replaces your browser's original HTTP GET request
   with an HTTP POST login request containing credentials to authenticate.
   As a result, instead of the home page with a login form,
   OpenIG logs you in directly,
   and the application responds with the page you see after logging in.
   OpenIG then returns this response to your browser.
  </p><p>
   The following sequence diagram shows the steps.
  </p><div class="figure"><a name="figure-hard-coded-login"></a><div class="figure-title">Figure&nbsp;2.1.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/hard-coded-login.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e1070.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     The browser host makes a DNS request for
     the IP address of the HTTP server host, <code class="literal">www.example.com</code>.
    </p></li><li class="listitem"><p>
     DNS responds with the address for OpenIG.
    </p></li><li class="listitem"><p>
     Browser sends a request to the HTTP server.
    </p></li><li class="listitem"><p>
     OpenIG replaces the request with an HTTP POST request,
     including the login form with hard-coded credentials.
    </p></li><li class="listitem"><p>
     HTTP server validates the credentials,
     and responds with the profile page.
    </p></li><li class="listitem"><p>
     OpenIG passes the response back to the browser.
    </p></li></ol></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-install"></a>Chapter&nbsp;3.&nbsp;Installation in Detail</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#configure-container">3.1. Configuring Deployment Containers</a></span></dt><dt><span class="section"><a href="#configure-network">3.2. Preparing the Network</a></span></dt><dt><span class="section"><a href="#install">3.3. Installing OpenIG</a></span></dt><dt><span class="section"><a href="#load-balancing">3.4. Preparing For Load Balancing &amp; Failover</a></span></dt><dt><span class="section"><a href="#client-side-security">3.5. Configuring OpenIG For HTTPS (Client-Side)</a></span></dt><dt><span class="section"><a href="#keystore-for-jwt-encryption">3.6. Setting Up Keys For JWT Encryption</a></span></dt></dl></div><p>
  This chapter covers more advanced installation procedures.
 </p><a class="indexterm" name="d1182e1104"></a><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Make sure you have a supported Java version installed.
   </p><p>
    See the <em class="citetitle">Release Notes</em> section,
    <a href="../release-notes/index.html#java-requirements" class="link"><em class="citetitle">JDK Version</em></a>, for details.
   </p></li><li class="listitem"><p>
    Prepare a deployment container.
   </p><p>
    For details, see <a class="xref" href="#configure-container" title="3.1.&nbsp;Configuring Deployment Containers">Section&nbsp;3.1, &#8220;Configuring Deployment Containers&#8221;</a>.
   </p></li><li class="listitem"><p>
    Prepare the network to use OpenIG as a reverse proxy.
   </p><p>
    For details, see <a class="xref" href="#configure-network" title="3.2.&nbsp;Preparing the Network">Section&nbsp;3.2, &#8220;Preparing the Network&#8221;</a>.
   </p></li><li class="listitem"><p>
    Download, deploy, and configure OpenIG.
   </p><p>
    For details, see <a class="xref" href="#install" title="3.3.&nbsp;Installing OpenIG">Section&nbsp;3.3, &#8220;Installing OpenIG&#8221;</a>.
   </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-container"></a>3.1.&nbsp;Configuring Deployment Containers</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#about-securing-connections">3.1.1. About Securing Connections</a></span></dt><dt><span class="section"><a href="#tomcat">3.1.2. Configuring Apache Tomcat For OpenIG</a></span></dt><dt><span class="section"><a href="#jetty">3.1.3. Configuring Jetty For OpenIG</a></span></dt></dl></div><p>
   This section provides installation and configuration tips
   that you need to run OpenIG in supported containers.
  </p><p>
   For the full list of supported containers,
   see the <em class="citetitle">Release Notes</em> section,
   <a href="../release-notes/index.html#which-container" class="link"><em class="citetitle">Web Application Containers</em></a>.
  </p><p>
   For further information on advanced configuration for a particular container,
   see the container documentation.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="about-securing-connections"></a>3.1.1.&nbsp;About Securing Connections</h3></div></div></div><p>
    OpenIG is often deployed to replay credentials
    or other security information.
    In a real world deployment,
    that information must be communicated over a secure connection using HTTPS,
    meaning in effect HTTP over encrypted Transport Layer Security (TLS).
    Never send real credentials, bearer tokens, or other security information
    unprotected over HTTP.
   </p><p>
    When OpenIG is acting as a server,
    the web application container where OpenIG runs
    is responsible for setting up TLS connections
    with client applications that connect to OpenIG.
    For details, see <a class="xref" href="#jetty-https" title="3.1.3.2.&nbsp;Configuring Jetty For HTTPS (Server-Side)">Section&nbsp;3.1.3.2, &#8220;Configuring Jetty For HTTPS (Server-Side)&#8221;</a>
    or <a class="xref" href="#tomcat-https" title="3.1.2.2.&nbsp;Configuring Tomcat For HTTPS (Server-Side)">Section&nbsp;3.1.2.2, &#8220;Configuring Tomcat For HTTPS (Server-Side)&#8221;</a>.
   </p><p>
    When OpenIG is acting as a client, the
    <a href="../reference/index.html#HttpClient" class="link">HttpClient</a> configuration sets up TLS connections
    from OpenIG to other servers.
    For details, see <a class="xref" href="#client-side-security" title="3.5.&nbsp;Configuring OpenIG For HTTPS (Client-Side)">Section&nbsp;3.5, &#8220;Configuring OpenIG For HTTPS (Client-Side)&#8221;</a>.
   </p><p>
    TLS depends on the use of digital certificates (public keys).
    In typical use of TLS,
    the client authenticates the server by its X.509 digital certificate
    as the first step to establishing communication.
    Once trust is established,
    then the client and server can set up
    a symmetric key to encrypt communications.
   </p><p>
    In order for the client to trust the server certificate,
    the client needs first to trust
    the certificate of the party who signed the server's certificate.
    This means that either the client
    has a trusted copy of the signer's certificate,
    or the client has a trusted copy
    of the certificate of the party who signed the signer's certificate.
   </p><p>
    Certificate Authorities (CAs) are trusted signers
    with well-known certificates.
    Browsers generally ship with many well-known CA certificates.
    Java distributions also ship with many well-known CA certificates.
    Getting a certificate signed by a well-known CA generally costs money.
   </p><p>
    It is also possible for you to self-sign certificates.
    The trade off is that although you do not have to pay any money,
    the certificate is not trusted by any clients until they have a copy.
    Whereas it is often enough
    to install a certificate signed by a well-known CA
    in the server key store as the basis of trust for HTTPS connections,
    self-signed certificates must also be installed in all clients.
   </p><p>
    Like self-signed certificates,
    the signing certificates of less well-known CAs
    are also unlikely to be found in the default trust store.
    You might therefore need to install those signing certificates
    on the client side as well.
   </p><p>
    This guide describes how to install self-signed certificates,
    which are certainly fine for trying out the software
    and okay for deployments where you manage all clients
    that access OpenIG.
    If you need a well-known CA signed certificate instead,
    see the documentation for your container for details
    on requesting a CA signature and installing the CA signed certificate.
   </p><p>
    Once certificates are properly installed to allow client-server trust,
    also consider the cipher suites configured for use.
    The cipher suite used determines the security settings for the communication.
    Initial TLS negotiations bring the client and server to agreement on which
    cipher suite to use.
    Basically the client and server share their preferred cipher suites
    to compare and to choose.
    If you therefore have a preference concerning the cipher suites to use,
    you must set up your container to use only your preferred cipher suites.
    Otherwise the container is likely to inherit the list of cipher suites
    from the underlying Java environment.
   </p><p>
    The Java Secure Socket Extension (JSSE), part of the Java environment,
    provides security services that OpenIG uses to secure connections.
    You can set security and system properties to configure the JSSE.
    For a list of properties you can use to customize the JSSE in Oracle Java,
    see the <em class="citetitle">Customization</em> section of the
    <a class="link" href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/jsse/JSSERefGuide.html#Customization" target="_blank"><em class="citetitle">JSSE Reference Guide</em></a>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tomcat"></a>3.1.2.&nbsp;Configuring Apache Tomcat For OpenIG</h3></div></div></div><p>
    This section describes essential Apache Tomcat configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d1182e1203"></a><p>
    Download and install a supported version of Apache Tomcat from
    <a class="link" href="http://tomcat.apache.org/" target="_blank">http://tomcat.apache.org/</a>.
   </p><p>
    Configure Tomcat to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Tomcat to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Tomcat to do so as well.
   </p><p>
    To configure Tomcat to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-cookie-domains"></a>3.1.2.1.&nbsp;Configuring Tomcat Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Tomcat to set domain cookies.
     To do this, add a session cookie domain context element
     that specifies the domain to
     <code class="filename">/path/to/conf/Catalina/<em class="replaceable"><code>server</code></em>/root.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Context sessionCookieDomain=".example.com" /&gt;

    </pre><p>
     Restart Tomcat to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-https"></a>3.1.2.2.&nbsp;Configuring Tomcat For HTTPS (Server-Side)</h4></div></div></div><p>
     To get Tomcat up quickly on an SSL port
     add an entry similar to the following in
     <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    </p><pre class="brush: xml;">
&lt;Connector
 port="8443"
 protocol="HTTP/1.1"
 SSLEnabled="true"
 maxThreads="150"
 scheme="https"
 secure="true"
 address="127.0.0.1"
 clientAuth="false"
 sslProtocol="TLS"
 keystoreFile="/path/to/tomcat/conf/keystore"
 keystorePass="password"
/&gt;

    </pre><p>
     Also create a key store holding a self-signed certificate.
    </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias tomcat \
 -keyalg RSA \
 -keystore /path/to/tomcat/conf/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
    </pre></div><p>
     Notice the key store file location and the key store password
     both match the configuration.
     By default, Tomcat looks for a certificate with alias <code class="literal">tomcat</code>.
    </p><p>
     Restart Tomcat to read the configuration changes.
    </p><p>
     Browsers generally do not trust self-signed certificates.
     To work with a certificate signed instead by a trusted CA,
     see the Apache Tomcat documentation on configuring HTTPS.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-mysql"></a>3.1.2.3.&nbsp;Configuring Tomcat to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Apache Tomcat to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/tomcat/lib/</code>
       so that it is on Tomcat's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/tomcat/conf/context.xml</code>.
      </p><pre class="brush: xml;">
&lt;Resource
 name="jdbc/forgerock"
 auth="Container"
 type="javax.sql.DataSource"
 maxActive="100"
 maxIdle="30"
 maxWait="10000"
 username="mysqladmin"
 password="password"
 driverClassName="com.mysql.jdbc.Driver"
 url="jdbc:mysql://localhost:3306/databasename"
/&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/tomcat/conf/web.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Tomcat to read the configuration changes.
      </p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jetty"></a>3.1.3.&nbsp;Configuring Jetty For OpenIG</h3></div></div></div><p>
    This section describes essential Jetty configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d1182e1303"></a><p>
    Download and install a supported version of Jetty from
    <a class="link" href="http://download.eclipse.org/jetty/" target="_blank">http://download.eclipse.org/jetty/</a>.
   </p><p>
    Configure Jetty to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Jetty to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Jetty to do so as well.
   </p><p>
    To configure Jetty to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-cookie-domains"></a>3.1.3.1.&nbsp;Configuring Jetty Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Jetty to set domain cookies.
     To do this, add a session domain handler element
     that specifies the domain to
     <code class="filename">/path/to/jetty/etc/jetty.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Get name="sessionHandler"&gt;
    &lt;Get name="sessionManager"&gt;
        &lt;Set name="sessionDomain"&gt;.example.com&lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Get&gt;

    </pre><p>
     Restart Jetty to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-https"></a>3.1.3.2.&nbsp;Configuring Jetty For HTTPS (Server-Side)</h4></div></div></div><p>
    To get Jetty up quickly on an SSL port, follow the steps in this section.
   </p><p>
    These steps involve replacing the built-in key store with your own.
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
      If you have not done so already, remove the built-in key store.
     </p><div class="screen"><pre>
$ <strong>rm /path/to/jetty/etc/keystore</strong>
     </pre></div></li><li class="step"><p>
      Generate a new key pair with self-signed certificate in the key store.
     </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias jetty \
 -keyalg RSA \
 -keystore /path/to/jetty/etc/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
     </pre></div></li><li class="step"><p>
      Find the obfuscated form of the password.
     </p><div class="screen"><pre>
$ <strong>java \
 -cp /path/to/jetty/lib/jetty-util-*.jar \
 org.eclipse.jetty.util.security.Password \
 password</strong>
<em>password
OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v
MD5:5f4dcc3b5aa765d61d8327deb882cf99</em>
     </pre></div></li><li class="step"><p>
      Edit the SSL Context Factory entry in the Jetty configuration file,
      <code class="filename">/path/to/jetty/etc/jetty-ssl.xml</code>.
     </p><pre class="brush: xml;">
&lt;New id="sslContextFactory" class="org.eclipse.jetty.http.ssl.SslContextFactory"&gt;
  &lt;Set name="KeyStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="KeyStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="KeyManagerPassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="TrustStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="TrustStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
&lt;/New&gt;

   </pre></li><li class="step"><p>
      Uncomment the line specifying that configuration file in
      <code class="filename">/path/to/jetty/start.ini</code>.
     </p><pre class="brush: ini;">
etc/jetty-ssl.xml
     </pre></li><li class="step"><p>
      Restart Jetty.
     </p></li><li class="step"><p>
      Browse <a class="link" href="https://www.example.com:8443" target="_blank">https://www.example.com:8443</a>.
     </p><p>
      You should see a warning in the browser
      that the (self-signed) certificate is not recognized.
     </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-mysql"></a>3.1.3.3.&nbsp;Configuring Jetty to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Jetty to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/jetty/lib/jndi/</code>
       so that it is on Jetty's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
      </p><pre class="brush: xml;">
&lt;New id="jdbc/forgerock" class="org.eclipse.jetty.plus.jndi.Resource"&gt;
  &lt;Arg&gt;&lt;/Arg&gt;
  &lt;Arg&gt;jdbc/forgerock&lt;/Arg&gt;
  &lt;Arg&gt;
    &lt;New class="com.mysql.jdbc.jdbc2.optional.MysqlConnectionPoolDataSource"&gt;
      &lt;Set name="Url"&gt;jdbc:mysql://localhost:3306/databasename&lt;/Set&gt;
      &lt;Set name="User"&gt;mysqladmin&lt;/Set&gt;
      &lt;Set name="Password"&gt;password&lt;/Set&gt;
    &lt;/New&gt;
  &lt;/Arg&gt;
&lt;/New&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Jetty to read the configuration changes.
      </p></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-network"></a>3.2.&nbsp;Preparing the Network</h2></div></div></div><p>
   In order for OpenIG to function as a reverse proxy,
   browsers attempting to access the protected application
   must go through OpenIG instead.
  </p><p>
   Modify DNS or host file settings so that
   the host name of the protected application
   resolves to the IP address of OpenIG
   on the system where the browser runs.
  </p><p>
   Restart the browser after making this change.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install"></a>3.3.&nbsp;Installing OpenIG</h2></div></div></div><div class="procedure"><p>
    Follow these steps to install OpenIG.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download the OpenIG.
    </p><div class="itemizedlist"><p>
      OpenIG can be downloaded from these locations.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Enterprise Software Downloads</a> page
       provides thoroughly validated release builds
       for ForgeRock customers who run OpenIG in production deployments,
       and for those who want to try or test with release builds.
      </p><p>
       Use this build with officially released project documentation from
       <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.
      </p><p>
       Make sure you review and agree with
       the Software License and Subscription Agreement
       in order to use the software.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-builds/" target="_blank">Nightly Builds</a> page
       offers the very latest successful nightly build of the latest code.
      </p><p>
       Use this build to get a preview of the latest features and fixes,
       when reading along with the draft documentation.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-archive/" target="_blank">Archive</a> page
       makes older builds available.
      </p></li></ul></div></li><li class="step"><p>
     Deploy the OpenIG war file <span class="emphasis"><em>to the root context</em></span>
     of the web application container.
    </p><p>
     OpenIG must be deployed to the root context, not below.
    </p></li><li class="step"><p>
     Prepare your OpenIG configuration files.
    </p><div class="variablelist"><p>
      By default, OpenIG files are located under
      <code class="filename">$HOME/.openig</code> on Linux, Mac OS X, and UNIX systems,
      and <code class="filename">%appdata%\OpenIG</code> on Windows systems.
      OpenIG uses the following file system directories.
     </p><dl class="variablelist"><dt><span class="term"><code class="filename">$HOME/.openig/config</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\config</code></span></dt><dd><p>
        OpenIG configuration files,
        where the main configuration file is <code class="filename">config.json</code>.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/config/routes</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\config\routes</code></span></dt><dd><p>
        OpenIG route configuration files.
       </p><p>
        See the chapter,
        <a href="../gateway-guide/index.html#chap-routing" class="link"><em class="citetitle">Configuring Routes</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\SAML</code></span></dt><dd><p>
        OpenIG SAML 2.0 configuration files.
       </p><p>
        See the chapter,
        <a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">Using OpenIG Federation</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/scripts/groovy</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\scripts\groovy</code></span></dt><dd><p>
        OpenIG script files, for Groovy scripted filters and handlers.
       </p><p>
        See the chapter,
        <a href="../gateway-guide/index.html#chap-extending" class="link"><em class="citetitle">Extending OpenIG</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/tmp</code>, </span><span class="term"><code class="filename">%appdata%\OpenIG\tmp</code></span></dt><dd><p>
        OpenIG temporary files.
       </p><p>
        This location can be used for temporary storage.
       </p></dd></dl></div><div class="itemizedlist"><p>
      You can change <code class="filename">$HOME/.openig</code>
      (or <code class="filename">%appdata%\OpenIG</code>)
      from the default location in the following ways.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Unpack the OpenIG war file,
       and edit the <code class="filename">WEB-INF/web.xml</code> application descriptor
       to set the <code class="literal">openig-base</code> initialization parameter
       to the full path to the base location for OpenIG files,
       as in the following example.
      </p><pre class="brush: xml;">

 &lt;servlet&gt;
   &lt;servlet-name&gt;GatewayServlet&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.forgerock.openig.servlet.GatewayServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
     &lt;param-name&gt;openig-base&lt;/param-name&gt;
     &lt;param-value&gt;/path/to/openig&lt;/param-value&gt;
   &lt;/init-param&gt;
 &lt;/servlet&gt;

      </pre></li><li class="listitem"><p>
       Set the <code class="literal">OPENIG_BASE</code> environment variable
       to the full path to the base location for OpenIG files.
      </p><div class="screen"><pre>
# On Linux, Mac OS X, and UNIX using Bash
$ <strong>export OPENIG_BASE=/path/to/openig</strong>

# On Windows
C:&gt;<strong>set OPENIG_BASE=c:\path\to\openig</strong>
      </pre></div></li><li class="listitem"><p>
       Set the <code class="literal">openig.base</code> Java system property
       to the full path to the base location for OpenIG files
       when starting the web application container where OpenIG runs,
       as in the following example that starts Jetty server in the foreground.
      </p><div class="screen"><pre>
$ <strong>java -Dopenig.base=/path/to/openig -jar start.jar</strong>
      </pre></div></li></ul></div><p>
     If you have not yet prepared configuration files, then start with the
     <span class="olink"><em class="citetitle">Configuration for Proxy &amp; Capture</em></span>.
    </p><p>
     Copy the template to <code class="filename">$HOME/.openig/config/config.json</code>.
     Replace the "baseURI" of the "DispatchHandler"
     with that of the protected application.
    </p><p>
     On Windows,
     copy the template to <code class="filename">%appdata%\OpenIG\config\config.json</code>.
     To locate the <code class="filename">%appdata%</code> folder
     for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create the <code class="filename">%appdata%\OpenIG\config</code> folder,
     and then add the configuration file.
    </p></li><li class="step"><p>
     Start the web container where OpenIG is deployed.
    </p></li><li class="step"><p>
     Browse to the protected application.
    </p><p>
     OpenIG should now proxy all traffic to the application.
    </p></li><li class="step"><p>
     Make sure the browser is going through OpenIG.
    </p><p>
     Verify this in one of the following ways.
    </p><ul class="stepalternatives">
     <li class="step"><ol type="a" class="substeps"><li class="step"><p>
         Stop the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you cannot browse to the protected application.
        </p></li><li class="step"><p>
         Start the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you can now browse to the protected application again.
        </p></li></ol></li>

     <li class="step"><p>
       Check the LogSink to see that traffic is going through OpenIG.
      </p><p>
       The default ConsoleLogSink is the deployment container log.
      </p></li>
    </ul></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="load-balancing"></a>3.4.&nbsp;Preparing For Load Balancing &amp; Failover</h2></div></div></div><p>
   For a high scale or highly available deployment,
   you can prepare a pool of OpenIG servers
   with nearly identical configurations,
   and then load balance requests across the pool,
   routing around any servers that become unavailable.
   Load balancing allows the service to handle more load.
  </p><p>
   Before you spread requests across multiple servers, however,
   you must determine what to do with state information
   that OpenIG saves in the exchange,
   or retrieves locally from the OpenIG server system.
   If information is retrieved locally,
   then also consider setting up failover
   so that if one server becomes unavailable,
   another server in the pool can take its place.
   The benefit of failover is
   that a server failure can be invisible to client applications.
  </p><div class="itemizedlist"><p>
    OpenIG can save state information in the exchange in several ways.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Handlers including a
     <a href="../reference/index.html#SamlFederationHandler" class="link">SamlFederationHandler</a>
     or a custom
     <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a>
     can store information in the exchange.
     Most handlers depend on information in the exchange,
     some of which is first stored by OpenIG.
    </p></li><li class="listitem"><p>
     Filters including those having types
     <a href="../reference/index.html#AssignmentFilter" class="link">AssignmentFilter</a>,
     <a href="../reference/index.html#HeaderFilter" class="link">HeaderFilter</a>,
     <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a>,
     <a href="../reference/index.html#OAuth2ResourceServerFilter" class="link">OAuth2ResourceServerFilter</a>,
     <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>,
     <a href="../reference/index.html#SqlAttributesFilter" class="link">SqlAttributesFilter</a>,
     and
     <a href="../reference/index.html#StaticRequestFilter" class="link">StaticRequestFilter</a>
     can store information in the exchange.
     Most filters depend on information in the exchange,
     some of which is first stored by OpenIG.
    </p></li></ul></div><div class="itemizedlist"><p>
    OpenIG can also retrieve information locally in several ways.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Filters and handlers including
     <a href="../reference/index.html#FileAttributesFilter" class="link">FileAttributesFilter</a>,
     <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>,
     <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a>,
     and
     <a href="../reference/index.html#SqlAttributesFilter" class="link">SqlAttributesFilter</a>
     can depend on local system files or container configuration.
    </p></li></ul></div><p>
   By default the exchange data resides in memory in the container
   where OpenIG runs.
   This includes the default session implementation,
   which is backed by the HttpSession that the container handles.
   You can opt to store session data on the user-agent instead, however.
   For details and to consider whether your data fits, see
   <a href="../reference/index.html#JwtSession" class="link">JwtSession</a>.
   When you use the <code class="literal">JwtSession</code> implementation,
   be sure to share the encryption keys across all servers,
   so that any server can read session cookies from any other.
  </p><p>
   If your data does not fit in an HTTP cookie,
   for example because when encrypted it is larger than 4 KB,
   consider storing a reference in the cookie,
   and then retrieve the data by using another filter.
   OpenIG logs warning messages if the JwtSession cookie is too large.
   Using a reference can also work when a server becomes unavailable,
   and the load balancer must fail requests over to another server in the pool.
  </p><p>
   If some data attached to an exchange must be stored on the server side,
   then you have additional configuration steps to perform
   for session stickiness and for session replication.
   Session stickiness means that the load balancer sends all requests
   from the same client session to the same server.
   Session stickiness helps to ensure that a client request goes
   to the server holding the original session data.
   Session replication involves writing session data
   either to other servers or to a data store,
   so that if one server goes down,
   other servers can read the session data and continue processing.
   Session replication helps when one server fails,
   allowing another server to take its place
   without having to start the session over again.
   If you set up session stickiness but not session replication,
   when a server crashes the client session information for that server is lost,
   and the client must start again with a new session.
  </p><p>
   How you configure session stickiness and session replication
   depends on your load balancer and on your container.
  </p><div class="itemizedlist"><p>
    Apache Tomcat can help with session stickiness,
    and a Tomcat cluster can handle session replication.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     If you choose to use the
     <a class="link" href="http://tomcat.apache.org/connectors-doc/" target="_blank">Apache Tomcat connector</a> (mod_jk) on your web server
     to perform load balancing, then see the
     <a class="link" href="http://tomcat.apache.org/connectors-doc/generic_howto/loadbalancers.html" target="_blank"><em class="citetitle">LoadBalancer HowTo</em></a> for details.
    </p><p>
     Notice in that HowTo that
     you configure the <code class="literal">jvmRoute</code> attribute
     in the Tomcat server configuration,
     <code class="filename">/path/to/tomcat/conf/server.xml</code>,
     to identify the server.
     The connector can use this identifier to achieve session stickiness.
    </p></li><li class="listitem"><p>
     A Tomcat
     <a class="link" href="http://tomcat.apache.org/tomcat-7.0-doc/config/cluster.html" target="_blank">cluster</a> configuration can handle session replication.
     When setting up a cluster configuration, the
     <a class="link" href="http://tomcat.apache.org/tomcat-7.0-doc/config/cluster-manager.html" target="_blank">ClusterManager</a> defines the session replication implementation.
    </p></li></ul></div><div class="itemizedlist"><p>
    Jetty has provisions for session stickiness,
    and also for session replication through clustering.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Jetty's persistent session mechanism appends a node ID to the session ID,
     in the same way Tomcat appends the <code class="literal">jvmRoute</code> value
     to the session cookie.
     This can be useful for session stickiness
     if your load balancer examines the session ID.
    </p></li><li class="listitem"><p>
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/session-clustering-jdbc.html" target="_blank">Session Clustering with a Database</a>
     describes how to configure Jetty to persist sessions over JDBC,
     allowing session replication.
    </p><p>
     Unless it is set up to be highly available,
     the database can be a single point of failure in this case.
    </p></li><li class="listitem"><p>
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/session-clustering-mongodb.html" target="_blank">Session Clustering with MongoDB</a>
     describes how to configure Jetty to persist sessions in MongoDB,
     allowing session replication.
    </p><p>
     The Jetty documentation recommends this implementation
     when session data is seldom written but often read.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="client-side-security"></a>3.5.&nbsp;Configuring OpenIG For HTTPS (Client-Side)</h2></div></div></div><p>
   For OpenIG to connect to a server securely over HTTPS,
   OpenIG must be able to trust the server.
   The default settings rely on the Java environment trust store
   to trust server certificates.
   The Java environment default trust store includes
   public key signing certificates
   from many well-known Certificate Authorities (CAs).
   If all servers present certificates signed by these CAs,
   then you have nothing to configure.
  </p><p>
   If however the server certificates are self-signed
   or signed by a CA whose certificate is not trusted out of the box,
   then you can configure a
   <a href="../reference/index.html#KeyStore" class="link">KeyStore</a>,
   <a href="../reference/index.html#TrustManager" class="link">TrustManager</a>,
   and optionally a
   <a href="../reference/index.html#KeyManager" class="link">KeyManager</a>
   to reference when configuring an
   <a href="../reference/index.html#HttpClient" class="link">HttpClient</a>
   to enable OpenIG to trust servers when acting as a client.
  </p><p>
   The KeyStore holds the servers' certificates or the CA signing certificate.
   The TrustManager allows OpenIG to handle the certificates
   in the KeyStore when deciding whether to trust a server certificate.
   The optional KeyManager allows OpenIG to present its certificate
   from the key store when the server must authenticate OpenIG as client.
   The HttpClient references whatever TrustManager and KeyManager you configure.
  </p><p>
   You can configure each of these either globally for the OpenIG server,
   of locally for a particular ClientHandler configuration.
  </p><p>
   The Java KeyStore holds the peer servers' public key certificates
   (and optionally the OpenIG certificate and private key).
   For example, suppose you have a certificate file, <code class="filename">ca.crt</code>,
   that holds the trusted signer's certificate
   of the CA who signed the server certificates
   of the servers in your deployment.
   In that case, you could import the certificate into a Java Key Store file,
   <code class="filename">/path/to/keystore.jks</code>.
  </p><div class="screen"><pre>
$ <strong>keytool \
 -import \
 -trustcacerts \
 -keystore /path/to/keystore \
 -file ca.crt \
 -alias ca-cert \
 -storepass changeit</strong>
  </pre></div><p>
   You could then configure the following "KeyStore" for OpenIG
   that holds the trusted certificate.
   Notice that the "url" field takes an expression that evaluates to a URL,
   starting with a scheme such as <code class="literal">file://</code>.
  </p><pre class="brush: javascript;">
{
    "name": "MyKeyStore",
    "type": "KeyStore",
    "config": {
        "url": "file:///path/to/keystore",
        "password": "changeit"
    }
}
  </pre><p>
   The TrustManager handles the certificates in the KeyStore
   when deciding whether to trust the server certificate.
   The TrustManager references your KeyStore.
  </p><pre class="brush: javascript;">
{
    "name": "MyTrustManager",
    "type": "TrustManager",
    "config": {
        "keystore": "MyKeyStore"
    }
}
  </pre><div class="variablelist"><p>
    The HttpClient configuration has the following security settings.
   </p><dl class="variablelist"><dt><span class="term">"trustManager"</span></dt><dd><p>
      This references your TrustManager.
     </p><p>
      Recall that you must configure this
      when your server certificates are not trusted out of the box.
     </p></dd><dt><span class="term">"hostnameVerifier"</span></dt><dd><p>
      This defines how the HttpClient verifies host names in server certificates.
     </p><p>
      By default, host name verification is turned off.
     </p></dd><dt><span class="term">"keyManager"</span></dt><dd><p>
      This references your optional KeyManager.
     </p><p>
      Configure this if servers request that OpenIG present
      its certificate as part of mutual authentication.
     </p><p>
      In that case, generate a key pair for OpenIG,
      and have the certificate signed by a well-known CA.
      See the <span class="command"><strong>keytool</strong></span> documentation for instructions.
      You can use a different key store for the KeyManager
      than you use for the TrustManager.
     </p></dd></dl></div><p>
   The following HttpClient configuration references "MyTrustManager"
   and sets browser-compatible host name verification.
  </p><pre class="brush: javascript;">
{
    "name": "HttpClient",
    "type": "HttpClient",
    "config": {
        "hostnameVerifier": "BROWSER_COMPATIBLE",
        "trustManager": "MyTrustManager"
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="keystore-for-jwt-encryption"></a>3.6.&nbsp;Setting Up Keys For JWT Encryption</h2></div></div></div><p>
   You can use
   <a href="../reference/index.html#JwtSession" class="link">JwtSession</a> to configure OpenIG
   to store session information in JWT cookies on the user-agent,
   rather than storing the information
   in the container where OpenIG runs.
  </p><p>
   In order to encrypt the JWTs, OpenIG needs cryptographic keys.
   OpenIG can generate its own key pair in memory,
   but that key pair disappears on restart
   and cannot be shared across OpenIG servers.
  </p><p>
   Alternatively, OpenIG can use keys from a key store.
   The following steps describe how to prepare the key store for JWT encryption.
  </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
     Generate the key pair in a new key store file
     by using the Java <span class="command"><strong>keytool</strong></span> command.
    </p><p>
     The following command generates a Java Key Store format file,
     <code class="filename">/path/to/keystore.jks</code>,
     holding a key pair with alias <code class="literal">jwe-key</code>.
     Notice that both the key store and the private key have the same password.
    </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias jwe-key \
 -keyalg rsa \
 -keystore /path/to/keystore.jks \
 -storepass changeit \
 -keypass changeit \
 -dname "CN=www.example.com,O=Example Corp"</strong>
    </pre></div></li><li class="step"><p>
     Add a
     <a href="../reference/index.html#KeyStore" class="link">KeyStore</a>
     to your configuration that references the key store file.
    </p><pre class="brush: javascript;">
{
    "name": "MyKeyStore",
    "type": "KeyStore",
    "config": {
        "url": "file:///path/to/keystore.jks",
        "password": "changeit"
    }
}
    </pre></li><li class="step"><p>
     Add a JwtSession to your configuration that references your KeyStore.
    </p><pre class="brush: javascript;">
{
    "name": "MyJwtSession",
    "type": "JwtSession",
    "config": {
        "keystore": "MyKeyStore",
        "alias": "jwe-key",
        "password": "changeit",
        "cookieName": "OpenIG"
    }
}
    </pre></li><li class="step"><p>
     Specify your JwtSession object in the top-level configuration,
     or in the route configuration.
    </p><pre class="brush: javascript;">
"session": "MyJwtSession"
    </pre></li></ol></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-credentials-tutorial"></a>Chapter&nbsp;4.&nbsp;Getting Login Credentials From Data Sources</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#tutorial-before-you-start">4.1. Before You Start</a></span></dt><dt><span class="section"><a href="#tutorial-credentials-from-file">4.2. Login With Credentials From a File</a></span></dt><dt><span class="section"><a href="#tutorial-credentials-from-sql">4.3. Login With Credentials From a Database</a></span></dt></dl></div><a class="indexterm" name="d1182e1943"></a><a class="indexterm" name="d1182e1948"></a><p>
  In the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
  you learned how to configure OpenIG
  to proxy traffic and capture request and response data.
  You also learned how to configure OpenIG
  to use a static request to log in with hard-coded credentials.
 </p><p>
  This chapter shows you how OpenIG can look up credentials in external sources.
  For example, OpenIG can look up credentials in a file or in a relational database.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-before-you-start"></a>4.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-credentials-from-file"></a>4.2.&nbsp;Login With Credentials From a File</h2></div></div></div><p>
   This sample shows you how to configure OpenIG to get credentials from a file.
  </p><p>
   The sample uses a comma-separated value file, <code class="filename">userfile</code>.
  </p><pre class="brush: java;">
username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com

  </pre><p>
   OpenIG looks up the user credentials based on the user's email address.
   OpenIG relies for this on
   a <code class="literal">FileAttributesFilter</code> configuration object.
  </p><div class="orderedlist"><p>
    Follow these steps to set up login with credentials from a file.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Add the user file on your system.
    </p><div class="screen"><pre>
$ <strong>vi /tmp/userfile</strong>
$ <strong>cat /tmp/userfile</strong>
<em>username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com
</em>
    </pre></div><p>
     On Windows systems, use an appropriate path
     such as <code class="filename">C:\Temp\userfile</code>.
    </p></li><li class="listitem"><p>
     Add a new route to the OpenIG configuration
     to use the <code class="literal">FileAttributesFilter</code> configuration object.
    </p><p>
     To add the route, add the following route configuration file
     as <code class="filename">$HOME/.openig/config/routes/02-file.json</code>.
    </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "FileAttributesFilter",
                    "config": {
                        "target": "${exchange.credentials}",
                        "file": "/tmp/userfile",
                        "key": "email",
                        "value": "george@example.com"
                    }
                },
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "${exchange.credentials.username}"
                            ],
                            "password": [
                                "${exchange.credentials.password}"
                            ]
                        }
                    }
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/file')}"
}

    </pre><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\02-file.json</code>.
    </p><div class="itemizedlist"><p>
      Notice the following features of the new route.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The "FileAttributesFilter" specifies the file to access,
       the key and value to look up to retrieve the user's record,
       and where the exchange stores the search results.
      </p></li><li class="listitem"><p>
       The "StaticRequestFilter" filter retrieves
       the username and password from the exchange
       and replaces your browser's original HTTP GET request
       with an HTTP POST login request
       that contains the credentials to authenticate.
      </p></li><li class="listitem"><p>
       The route matches requests to <code class="literal">/file</code>.
      </p></li></ul></div></li><li class="listitem"><p>
     On Windows systems, edit the path name to the user file.
    </p></li></ol></div><p>
   Now browse to
   <a class="link" href="http://www.example.com:8080/file" target="_blank">http://www.example.com:8080/file</a>.
  </p><p>
   If everything is configured correctly, OpenIG logs you in as George.
  </p><p>
   What's happening behind the scenes?
  </p><div class="figure"><a name="figure-login-from-file"></a><div class="figure-title">Figure&nbsp;4.1.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/login-from-file.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e2056.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   OpenIG intercepts your browser's HTTP GET request.
   The request matches the new route configuration.
   The OpenIG "FileAttributesFilter" looks up credentials in a file,
   and stores the credentials it finds in the exchange.
   OpenIG then calls the next filter in the chain, "StaticRequestFilter",
   passing the exchange object that now holds the credentials.
   The "StaticRequestFilter" filter pulls the credentials out of the exchange,
   builds the login form, and performs the HTTP POST request to the HTTP server.
   The HTTP server validates the credentials, and responds with a profile page.
   OpenIG then passes the response from the HTTP server to your browser.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-credentials-from-sql"></a>4.3.&nbsp;Login With Credentials From a Database</h2></div></div></div><p>
   This sample shows you how to configure OpenIG to get credentials from H2.
   This sample was developed with Jetty and with H2 1.4.178.
  </p><p>
   Although this sample uses H2, OpenIG also works with other database software.
   OpenIG relies on the application server where it runs
   to connect to the database.
   Configuring OpenIG to retrieve data from a database is therefore
   a question of configuring the application server to connect to the database,
   and configuring OpenIG to choose the appropriate data source,
   and to send the appropriate SQL request to the database.
   As a result, the OpenIG configuration depends more on the data structure
   than on any particular database drivers or connection configuration.
  </p><div class="procedure"><a name="sql-prepare-database"></a><div class="procedure-title">Procedure&nbsp;4.1.&nbsp;Preparing the Database</div><p>
    Follow these steps to prepare the database.
   </p><ol class="procedure" type="1"><li class="step"><p>
     On the system where OpenIG runs, download and unpack
     <a class="link" href="http://h2database.com" target="_blank">H2 database</a>.
    </p></li><li class="step"><p>
     Start H2.
    </p><div class="screen"><pre>
$ <strong>sh /path/to/h2/bin/h2.sh</strong>
    </pre></div><p>
     H2 starts, listening on port 8082, and opens a browser console page.
    </p></li><li class="step"><p>
     In the browser console page,
     select Generic H2 (Server) under Saved Settings.
     This sets the Driver Class, <code class="literal">org.h2.Driver</code>,
     the JDBC URL, <code class="literal">jdbc:h2:tcp://localhost/~/test</code>,
     the User Name, <code class="literal">sa</code>.
    </p><p>
     In the Password field, type <code class="literal">password</code>.
    </p><p>
     Then click Connect to access the console.
    </p></li><li class="step"><p>
     Run a statement to create a users table
     based on the user file from
     <a class="xref" href="#tutorial-credentials-from-file" title="4.2.&nbsp;Login With Credentials From a File">Section&nbsp;4.2, &#8220;Login With Credentials From a File&#8221;</a>.
    </p><p>
     If you have not created the user file on your system,
     put the following content in <code class="filename">/tmp/userfile</code>.
    </p><pre class="brush: java;">
username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com

  </pre><p>
     Then create the users table through the H2 console:
    </p><pre class="brush: plain;">
DROP TABLE IF EXISTS USERS;
CREATE TABLE USERS AS SELECT * FROM CSVREAD('/tmp/userfile');
    </pre><p>
     On success, the table should contain the same users as the file.
     You can check this by running <code class="literal">SELECT * FROM users;</code>
     in the H2 console.
    </p></li></ol></div><div class="procedure"><a name="sql-connect-to-database"></a><div class="procedure-title">Procedure&nbsp;4.2.&nbsp;Preparing Jetty's Connection to the Database</div><p>
    Follow these steps to enable Jetty to connect to the database.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Configure Jetty for JNDI as described in the Jetty documentation on
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/jndi.html" target="_blank"><em class="citetitle">Configuring JNDI</em></a>.
    </p><p>
     For the version of Jetty used in this sample,
     stop Jetty and add the following lines to
     <code class="filename">/path/to/jetty/start.ini</code>.
    </p><pre class="brush: plain;">
# ===========================================================
# Enable JNDI
# -----------------------------------------------------------
OPTIONS=jndi

# ===========================================================
# Enable additional webapp environment configurators
# -----------------------------------------------------------
OPTIONS=plus
etc/jetty-plus.xml
    </pre></li><li class="step"><p>
     Copy the H2 library to the classpath for Jetty.
    </p><div class="screen"><pre>
$ <strong>cp /path/to/h2/bin/h2-*.jar /path/to/jetty/lib/ext/</strong>
    </pre></div></li><li class="step"><p>
     Define a JNDI resource for H2 in
     <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
    </p><pre class="brush: xml;">
&lt;New id="jdbc/forgerock" class="org.eclipse.jetty.plus.jndi.Resource"&gt;
  &lt;Arg&gt;&lt;/Arg&gt;
  &lt;Arg&gt;jdbc/forgerock&lt;/Arg&gt;
  &lt;Arg&gt;
    &lt;New class="org.h2.jdbcx.JdbcDataSource"&gt;
      &lt;Set name="Url"&gt;jdbc:h2:tcp://localhost/~/test&lt;/Set&gt;
      &lt;Set name="User"&gt;sa&lt;/Set&gt;
      &lt;Set name="Password"&gt;password&lt;/Set&gt;
    &lt;/New&gt;
  &lt;/Arg&gt;
&lt;/New&gt;

     </pre></li><li class="step"><p>
     Add a resource reference to the data source in
     <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
    </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

     </pre></li><li class="step"><p>
     Restart Jetty to take the configuration changes into account.
    </p></li></ol></div><div class="procedure"><a name="sql-configure-openig"></a><div class="procedure-title">Procedure&nbsp;4.3.&nbsp;Preparing the OpenIG Configuration</div><p>
    Add a new route to the OpenIG configuration
    to look up credentials in the database.
   </p><ul class="procedure"><li class="step"><p>
     To add the route, add the following route configuration file
     as <code class="filename">$HOME/.openig/config/routes/03-sql.json</code>.
    </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "SqlAttributesFilter",
                    "config": {
                        "dataSource": "java:comp/env/jdbc/forgerock",
                        "preparedStatement":
                            "SELECT username, password FROM users WHERE email = ?;",
                        "parameters": [
                            "george@example.com"
                        ],
                        "target": "${exchange.credentials}"
                    }
                },
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "${exchange.credentials.USERNAME}"
                            ],
                            "password": [
                                "${exchange.credentials.PASSWORD}"
                            ]
                        }
                    }
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/sql')}"
}

     </pre></div><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\03-sql.json</code>.
    </p><div class="itemizedlist"><p>
      Notice the following features of the new route.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The "SqlAttributesFilter" specifies the data source to access,
       a prepared statement to look up the user's record,
       a parameter to pass into the statement,
       and where the exchange stores the search results.
      </p></li><li class="listitem"><p>
       The "StaticRequestFilter" retrieves
       the username and password from the exchange
       and replaces your browser's original HTTP GET request
       with an HTTP POST login request
       that contains the credentials to authenticate.
      </p><p>
       Notice that the request is for <code class="literal">username, password</code>,
       and that H2 returns the fields as
       <code class="literal">USERNAME</code> and <code class="literal">PASSWORD</code>.
       The configuration reflects this difference.
      </p></li><li class="listitem"><p>
       The route matches requests to <code class="literal">/sql</code>.
      </p></li></ul></div></li></ul></div><div class="procedure"><a name="try-login-sql"></a><div class="procedure-title">Procedure&nbsp;4.4.&nbsp;To Try Logging In With Credentials From a Database</div><p>
    With H2, Jetty, and OpenIG correctly configured, you can try it out.
   </p><ul class="procedure"><li class="step"><p>
     Access the new route,
     <a class="link" href="http://www.example.com:8080/sql" target="_blank">http://www.example.com:8080/sql</a>.
    </p><p>
     OpenIG logs you in automatically as George.
    </p></li></ul></div><p>
   What's happening behind the scenes?
  </p><div class="figure"><a name="figure-login-from-sql"></a><div class="figure-title">Figure&nbsp;4.2.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/login-from-sql.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d1182e2239.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   OpenIG intercepts your browser's HTTP GET request.
   The request matches the new route configuration.
   The OpenIG "SqlAttributesFilter" looks up credentials in H2,
   and stores the credentials it finds in the exchange.
   OpenIG then calls the next filter in the chain, "StaticRequestFilter",
   passing the exchange object that now holds the credentials.
   The "StaticRequestFilter" filter pulls the credentials out of the exchange,
   builds the login form, and performs the HTTP POST request to the HTTP server.
   The HTTP server validates the credentials, and responds with a profile page.
   OpenIG then passes the response from the HTTP server to your browser.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-password-capture-replay-tutorial"></a>Chapter&nbsp;5.&nbsp;Getting Login Credentials From OpenAM</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#capture-replay-flow">5.1. Detailed Flow</a></span></dt><dt><span class="section"><a href="#capture-replay-summary">5.2. Setup Summary</a></span></dt><dt><span class="section"><a href="#capture-replay-setup">5.3. Setup Details</a></span></dt><dt><span class="section"><a href="#capture-replay-try-it-out">5.4. Trying It Out</a></span></dt></dl></div><a class="indexterm" name="d1182e2251"></a><p>
  This chapter walks you through an OpenAM integration
  with OpenAM's password capture and replay feature.
  This feature of OpenAM is typically used to integrate
  with Microsoft Outlook Web Access (OWA) or SharePoint
  by capturing the password during OpenAM authentication,
  encrypting it, and adding to the session, which is later decrypted
  and used for Basic Authentication to OWA or SharePoint.
  This tutorial shows how you can configure OpenIG
  to use the user name and password from the OpenAM Authentication
  to log the user an application.
  This is also how you would achieve OWA or SharePoint integration.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-flow"></a>5.1.&nbsp;Detailed Flow</h2></div></div></div><p>
   The figure below illustrates the flow of requests
   for a user who is not yet logged in to OpenAM
   accessing a protected application.
   After successful authentication, the user is logged into the application
   with the username and password from the OpenAM login session.
  </p><div class="mediaobject" align="center"><a name="figure-password-capture-replay"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/password-capture-replay.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-password-capture-replay.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     The user sends a browser request to access a protected application.
    </p></li><li class="listitem"><p>
     The OpenAM policy agent protecting OpenIG intercepts the request.
    </p></li><li class="listitem"><p>
     The policy agent redirects the browser to OpenAM.
    </p></li><li class="listitem"><p>
     OpenAM authenticates the user, capturing the login credentials,
     storing the password in encrypted form in the user's session.
    </p></li><li class="listitem"><p>
     After authentication, OpenAM redirects the browser...
    </p></li><li class="listitem"><p>
     ...back to the protected application.
    </p></li><li class="listitem"><p>
     The OpenAM policy agent protecting OpenIG intercepts the request,
     validates the user session with OpenAM (not shown here),
     adds the username and encrypted password to headers in the request,
     and passes the request to OpenIG.
    </p></li><li class="listitem"><p>
     OpenIG retrieves the credentials from the headers,
     and uses the username and decrypted password
     to replace the request with an HTTP POST of the login form.
    </p></li><li class="listitem"><p>
     The application validates the login credentials,
     and sends a response back to OpenIG.
    </p></li><li class="listitem"><p>
     OpenIG passes the response from the application back to the user's browser.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-summary"></a>5.2.&nbsp;Setup Summary</h2></div></div></div><p>
   This tutorial calls for you to set up several different software components.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     OpenAM is installed on
     <code class="literal">http://openam.example.com:8088/openam</code>.
    </p></li><li class="listitem"><p lang="en">
 Download and run the
 <a class="link" href="http://maven.forgerock.org/repo/releases/org/forgerock/openig/openig-doc-samples/3.1.0/openig-doc-samples-3.1.0-jar-with-dependencies.jar" target="_top">minimal HTTP server .jar</a>
 to use as the application to protect.
</p><p>
     The openig-doc-samples-3.1.0-jar-with-dependencies.jar application
     listens at <code class="literal">http://www.example.com:8081</code>.
     The minimal HTTP server is run
     with the <span class="command"><strong>java -jar openig-doc-samples-3.1.0-jar-with-dependencies.jar</strong></span> command,
     as described in the chapter on
     <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
    </p></li><li class="listitem"><p>
     OpenIG is deployed in Jetty as described in the chapter on
     <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
     OpenIG listens at <code class="literal">http://www.example.com:8080</code>.
    </p></li><li class="listitem"><p>
     OpenIG is protected by an OpenAM Java EE policy agent also deployed in Jetty.
     The policy agent is configured
     to add username and encrypted password headers to the HTTP requests.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-setup"></a>5.3.&nbsp;Setup Details</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#capture-relay-setup-openam">5.3.1. Setting Up OpenAM Server</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-pa-profile">5.3.2. Preparing the Policy Agent Profile</a></span></dt><dt><span class="section"><a href="#password-capture-configuration">5.3.3. Configuring Password Capture</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-openig-minimal-server">5.3.4. Installing OpenIG</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-pa">5.3.5. Installing the Policy Agent</a></span></dt><dt><span class="section"><a href="#capture-relay-configure-openig">5.3.6. Configuring OpenIG</a></span></dt></dl></div><p>
   In this section, it is assumed that you are familiar
   with the components involved.
   For OpenAM documentation, see
   <a class="link" href="http://docs.forgerock.org/en/openam/" target="_blank">http://docs.forgerock.org/en/openam/</a>.
   For OpenAM policy agent documentation, see
   <a class="link" href="http://docs.forgerock.org/en/openam-pa/" target="_blank">http://docs.forgerock.org/en/openam-pa/</a>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-openam"></a>5.3.1.&nbsp;Setting Up OpenAM Server</h3></div></div></div><p>
    Install and configure OpenAM on
    <code class="literal">http://openam.example.com:8088/openam</code>
    with the default configuration.
    If you use a different configuration,
    make sure you substitute in the tutorial accordingly.
   </p><p>
    Create a sample user Subject in the top level realm with
    username <code class="literal">george</code> and password <code class="literal">costanza</code>.
    Test that you can login to OpenAM with this username and password.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-pa-profile"></a>5.3.2.&nbsp;Preparing the Policy Agent Profile</h3></div></div></div><div class="itemizedlist"><p>
     Create the Java EE agent profile in the top level realm
     with the following settings:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Server URL: <code class="literal">http://openam.example.com:8088/openam</code>
     </p></li><li class="listitem"><p>
      Agent URL: <code class="literal">http://www.example.com:8080/agentapp</code>
     </p></li></ul></div><div class="itemizedlist"><p>
     Edit the policy agent profile to add these settings,
     making sure to save your work when you finish.
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      On the Global settings tab page under General, change the Agent Filter Mode
      from <code class="literal">ALL</code> to <code class="literal">SSO_ONLY</code>.
     </p></li><li class="listitem"><p>
      On the Application tab page under Session Attributes Processing,
      change the Session Attribute Fetch Mode
      from <code class="literal">NONE</code> to <code class="literal">HTTP_HEADER</code>.
     </p></li><li class="listitem"><p>
      Also on the Application tab page under Session Attributes Processing,
      add <code class="literal">UserToken=username</code>
      and <code class="literal">sunIdentityUserPassword=password</code>
      to the Session Attribute Mapping list.
     </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="password-capture-configuration"></a>5.3.3.&nbsp;Configuring Password Capture</h3></div></div></div><p>
    Configure password capture in OpenAM as follows.
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      In the OpenAM console
      under Access Control &gt; / (Top Level Realm) &gt; Authentication,
      click All Core Settings,
      and then add
      <code class="literal">com.sun.identity.authentication.spi.ReplayPasswd</code>
      to the Authentication Post Processing Classes.
     </p></li><li class="listitem"><p>
      Run OpenAM's <span class="command"><strong>com.sun.identity.common.DESGenKey</strong></span> command
      to generate a shared key for the OpenAM Authentication plugin
      and for OpenIG.
     </p><div class="itemizedlist"><p>
       To run this command using the <span class="command"><strong>java</strong></span> command,
       you must add OpenAM .jar file libraries to the Java class path.
       The library names depend on the version of OpenAM that you use.
      </p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
        When using OpenAM 12.0.0, the libraries are
        <code class="filename">forgerock-util-1.3.5.jar</code>
        <code class="filename">openam-core-12.0.0.jar</code>,
        and <code class="filename">openam-shared-12.0.0.jar</code>.
       </p><p>
        As an example,
        if OpenAM 12.0.0 is installed in Apache Tomcat under <code class="literal">/openam</code>
        you would run the command
        <span class="command"><strong>java -classpath
        /path/to/tomcat/webapps/openam/WEB-INF/lib/forgerock-util-1.3.5.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-core-12.0.0.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-shared-12.0.0.jar
        com.sun.identity.common.DESGenKey</strong></span>.
       </p></li><li class="listitem"><p>
        When using OpenAM 11.0.0 for example, the libraries are
        <code class="filename">forgerock-util-1.1.0.jar</code>
        <code class="filename">openam-core-11.0.0.jar</code>,
        and <code class="filename">openam-shared-11.0.0.jar</code>.
       </p><p>
        As an example,
        if OpenAM 11.0.0 is installed in Apache Tomcat under <code class="literal">/openam</code>
        you would run the command
        <span class="command"><strong>java -classpath
        /path/to/tomcat/webapps/openam/WEB-INF/lib/forgerock-util-1.1.0.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-core-11.0.0.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-shared-11.0.0.jar
        com.sun.identity.common.DESGenKey</strong></span>.
       </p></li><li class="listitem"><p>
        When using OpenAM 10 and earlier, the libraries are
        <code class="filename">amserver.jar</code>
        and <code class="filename">opensso-sharedlib.jar</code>.
       </p><p>
        As an example, if OpenAM 10 is installed in Apache Tomcat under <code class="literal">/openam</code>
        you would run the command
        <span class="command"><strong>java -classpath
        /path/to/tomcat/webapps/openam/WEB-INF/lib/amserver.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/opensso-sharedlib.jar
        com.sun.identity.common.DESGenKey</strong></span>.
       </p></li></ul></div><p>
      The output of the command shows the generated key,
      as in the following example for OpenAM 11.0.0.
     </p><div class="screen"><pre>
$ <strong>cd /path/to/tomcat/webapps/openam/WEB-INF/lib</strong>
$ <strong>java -classpath \
 forgerock-util-1.1.0.jar:openam-core-11.0.0.jar:openam-shared-11.0.0.jar \
 com.sun.identity.common.DESGenKey</strong>
<em>Key ==&gt; ipvvZF2Mj0k</em>
     </pre></div></li><li class="listitem"><p>
      In the OpenAM console under Configuration &gt; Servers and Sites,
      click on the server name link,
      go to the Advanced tab
      and add <code class="literal">com.sun.am.replaypasswd.key</code>
      with the value of the key generated in the previous step.
     </p><p>
      Restart the OpenAM server after adding the Advanced property
      for the change to take effect.
     </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-openig-minimal-server"></a>5.3.4.&nbsp;Installing OpenIG</h3></div></div></div><p>
    Install OpenIG in Jetty and run the minimal HTTP server
    as described in the chapter on
    <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
   </p><p>
    When you finish, OpenIG should be running in Jetty,
    configured to access the minimal HTTP server as described in that chapter.
   </p><p>
    The initial OpenIG configuration file should look like the one used
    to proxy requests through to the HTTP server
    and to capture request and response data, see
    <span class="olink"><em class="citetitle">Configuration for Proxy &amp; Capture</em></span>.
   </p><p>
    To test your setup, access the HTTP server home page through OpenIG at
    <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
    Login as username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    You should see a page showing the username and some information about the request.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-pa"></a>5.3.5.&nbsp;Installing the Policy Agent</h3></div></div></div><p>
    Install the OpenAM Java EE policy agent alongside OpenIG in Jetty,
    listening at <code class="literal">http://www.example.com:8080</code>,
    using the following hints.
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Jetty Server Config Directory : <code class="literal">/path/to/jetty/etc</code>
     </p></li><li class="listitem"><p>
      Jetty installation directory. : <code class="literal">/path/to/jetty</code>
     </p></li><li class="listitem"><p>
      OpenAM server URL : <code class="literal">http://openam.example.com:8088/openam</code>
     </p></li><li class="listitem"><p>
      Agent URL : <code class="literal">http://www.example.com:8080/agentapp</code>
     </p></li><li class="listitem"><p>
      After copying <code class="filename">agentapp.war</code>
      into <code class="filename">/path/to/jetty/webapps/</code>,
      also add the following filter configuration to
      <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
     </p><pre class="brush: xml;">
&lt;filter&gt;
  &lt;filter-name&gt;Agent&lt;/filter-name&gt;
  &lt;display-name&gt;Agent&lt;/display-name&gt;
  &lt;description&gt;OpenAM Policy Agent Filter&lt;/description&gt;
  &lt;filter-class&gt;com.sun.identity.agents.filter.AmAgentFilter&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
  &lt;filter-name&gt;Agent&lt;/filter-name&gt;
  &lt;url-pattern&gt;/replay&lt;/url-pattern&gt;
  &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
  &lt;dispatcher&gt;INCLUDE&lt;/dispatcher&gt;
  &lt;dispatcher&gt;FORWARD&lt;/dispatcher&gt;
  &lt;dispatcher&gt;ERROR&lt;/dispatcher&gt;
&lt;/filter-mapping&gt;

     </pre></li></ul></div><p>
    To test the configuration, start Jetty, and then browse to
    <a class="link" href="http://www.example.com:8080/replay" target="_blank">http://www.example.com:8080/replay</a>.
    You should be redirected to OpenAM for authentication.
   </p><p>
    Do not log in, however.
    You have not yet configured a route
    to handle requests to <code class="literal">/replay</code>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-configure-openig"></a>5.3.6.&nbsp;Configuring OpenIG</h3></div></div></div><p>
    Add a new route to the OpenIG configuration
    to handle OpenAM password capture &amp; replay.
   </p><p>
    To add the route, add the following route configuration file
    as <code class="filename">$HOME/.openig/config/routes/04-replay.json</code>.
   </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "CryptoHeaderFilter",
                    "config": {
                        "messageType": "REQUEST",
                        "operation": "DECRYPT",
                        "algorithm": "DES/ECB/NoPadding",
                        "key": "DESKEY",
                        "keyType": "DES",
                        "charSet": "utf-8",
                        "headers": [
                            "password"
                        ]
                    }
                },
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "${exchange.request.headers['username'][0]}"
                            ],
                            "password": [
                                "${exchange.request.headers['password'][0]}"
                            ]
                        }
                    }
                },
                {
                    "type": "HeaderFilter",
                    "config": {
                        "messageType": "REQUEST",
                        "remove": [
                            "password",
                            "username"
                        ]
                    }
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/replay')}"
}

   </pre><p>
    On Windows, the file name should be
    <code class="filename">%appdata%\OpenIG\config\routes\04-replay.json</code>.
   </p><p>
    Change <code class="literal">DESKEY</code> to the actual key value
    that you generated in <a class="xref" href="#password-capture-configuration" title="5.3.3.&nbsp;Configuring Password Capture">Section&nbsp;5.3.3, &#8220;Configuring Password Capture&#8221;</a>.
   </p><div class="itemizedlist"><p>
     Notice the following features of the new route.
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      The "CryptoHeaderFilter" decrypts the password
      that OpenAM captured and encrypted,
      and that the OpenAM policy agent included in the headers for the request.
     </p><p>
      The resulting "CryptoHeaderFilter" should look something like this,
      but using the "key" value that you generated:
     </p><pre class="brush: javascript;">
{
    "type": "CryptoHeaderFilter",
    "config": {
        "messageType": "REQUEST",
        "operation": "DECRYPT",
        "algorithm": "DES/ECB/NoPadding",
        "key": "ipvvZF2Mj0k",
        "keyType": "DES",
        "charSet": "utf-8",
        "headers": [
            "password"
        ]
    }
}
     </pre></li><li class="listitem"><p>
      The "StaticRequestFilter" retrieves
      the username and password from the exchange
      and replaces your browser's original HTTP GET request
      with an HTTP POST login request
      that contains the credentials to authenticate.
     </p></li><li class="listitem"><p>
      The "HeaderFilter" removes the username and password headers
      before continuing to process the exchange.
     </p></li><li class="listitem"><p>
      The route matches requests to <code class="literal">/replay</code>.
     </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-try-it-out"></a>5.4.&nbsp;Trying It Out</h2></div></div></div><p>
   Log out of OpenAM if you are logged in already.
  </p><p>
   Access the new route,
   <a class="link" href="http://www.example.com:8080/replay" target="_blank">http://www.example.com:8080/replay</a>.
  </p><p>
   If you are not already logged into OpenAM
   you should be redirected to the OpenAM login page.
   Login with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
   After login you should be redirected back to the application.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-federation"></a>Chapter&nbsp;6.&nbsp;OpenIG as a SAML 2.0 Service Provider</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-saml2">6.1. About SAML 2.0 Federation</a></span></dt><dt><span class="section"><a href="#federation-installation">6.2. Installation Overview</a></span></dt><dt><span class="section"><a href="#federation-configuration-files">6.3. Configuration File Overview</a></span></dt><dt><span class="section"><a href="#federation-configuration">6.4. Configuring the Federation Handler</a></span></dt><dt><span class="section"><a href="#federation-example-settings">6.5. Example Settings</a></span></dt><dt><span class="section"><a href="#federation-idp-metadata">6.6. Identity Provider Metadata</a></span></dt><dt><span class="section"><a href="#fed-tutorial-before-you-start">6.7. Preparing to Try OpenIG as a SAML 2.0 Service Provider</a></span></dt><dt><span class="section"><a href="#fed-tutorial-configure-openam">6.8. Configuring OpenAM</a></span></dt><dt><span class="section"><a href="#fed-tutorial-configure-federation">6.9. Configuring OpenIG For Federation</a></span></dt><dt><span class="section"><a href="#fed-tutorial-testing">6.10. Trying It Out</a></span></dt></dl></div><p>
  This chapter has two aims.
  First, it aims to help you understand how
  OpenIG works as a SAML 2.0 service provider,
  and what that entails in terms of setup and configuration.
  Second, it aims to show you how to configure OpenIG
  as a SAML 2.0 federation service provider,
  logging users in to a protected application
  with information from a SAML assertion.
 </p><a class="indexterm" name="d1182e2671"></a><a class="indexterm" name="d1182e2674"></a><a class="indexterm" name="d1182e2679"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-saml2"></a>6.1.&nbsp;About SAML 2.0 Federation</h2></div></div></div><p>
   The Federation component of OpenIG is
   a standards based authentication service used by OpenIG
   to validate a user and retrieve key attributes of the user
   in order to log them in to applications that OpenIG protects.
   The Federation component implements Security Assertion Markup Language 2.0.
  </p><p>
   Security Assertion Markup Language (SAML) 2.0 is a standard
   for exchanging security information across organizational boundaries.
   SAML 2.0 enables web single sign-on (SSO), for example,
   where the service managing the user's identity
   does not necessarily belong to the same organization
   and does not necessarily use the same software
   as the service that the user wants to access.
  </p><p>
   In SAML 2.0, the service managing the user's identity
   is called the <em class="firstterm">Identity Provider</em> (IDP).
   The service that the user wants to access
   is called the <em class="firstterm">Service Provider</em> (SP).
   Provider organizations agree on the security information they want to exchange,
   and then they mutually configure access to each others' services,
   so that the SAML 2.0 federation capability is ready for use.
   The group of providers sets up a <em class="firstterm">circle of trust</em>,
   which is a list of services participating in the federation.
   In order to be able to configure access to services in the circle of trust,
   the providers share SAML 2.0 <em class="firstterm">metadata</em>
   describing their services in an XML format defined by the SAML 2.0 standard.
  </p><p>
   OpenIG plays the role of SAML 2.0 SP.
   You must therefore configure OpenIG as SP to access IDP services
   in order for the Federation component to be operational.
  </p><p>
   For SAML 2.0 web SSO, the user authenticates with the IDP.
   This can start either with the user visiting the IDP site and logging in,
   or with the user visiting the SP site and being directed to the IDP to log in.
   On successful authentication, the IDP sends
   an assertion statement about the authentication to the SP.
   This assertion statement attests which user the IDP authenticated,
   when the authentication succeeded, how long the assertion is valid, and so forth.
   It can optionally contain attribute values for the user who authenticated.
   (OpenIG can then, for example, use the attribute values
   to log a user into a protected application.)
   The assertion can optionally be signed and encrypted.
  </p><div class="orderedlist"><p>
    There are two ways that the OpenIG federation component can be invoked:
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     IDP initiated SSO,
     where the remote Identity Provider sends
     an unsolicited authentication statement to OpenIG
    </p></li><li class="listitem"><p>
     SP initiated SSO,
     where OpenIG calls the Federation component to
     initiate federated SSO with the Identity Provider
    </p></li></ol></div><p>
   In both cases, the job of the Federation component is
   to validate the user
   and to pass the required attributes to OpenIG
   so that it can log the user into protected applications.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-installation"></a>6.2.&nbsp;Installation Overview</h2></div></div></div><a class="indexterm" name="d1182e2723"></a><div class="itemizedlist"><p>
    This section summarizes the steps needed to prepare OpenIG
    to act as a SAML 2.0 SP for your target application.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Install the OpenIG war file.
    </p></li><li class="listitem"><p>
     Configure OpenIG to proxy successfully, and even log a user in,
     to the target application.
     Getting this to work before configuring Federation
     makes the process much simpler to troubleshoot if anything goes wrong.
    </p></li><li class="listitem"><p>
     Add Federation configuration to the OpenIG configuration.
    </p></li><li class="listitem"><p>
     Include the assertion mapping, redirect URI,
     and any optional configuration settings you choose
     in the Federation configuration.
    </p></li><li class="listitem"><p>
     Export the Identity Provider metadata from the remote IDP,
     or use the metadata from an OpenAM-generated Fedlet.
     (An OpenAM Fedlet is a small web application that can act as SP.)
    </p></li><li class="listitem"><p>
     Import OpenIG metadata to your Identity Provider.
    </p></li></ul></div><p>
   If you intend to protect multiple service provider applications
   first read this chapter and work through the samples.
   Then consider the explanation in the appendix,
   <a href="../gateway-guide/index.html#appendix-multiple-sps" class="link"><em class="citetitle">SAML 2.0 &amp; Multiple Applications</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-configuration-files"></a>6.3.&nbsp;Configuration File Overview</h2></div></div></div><a class="indexterm" name="d1182e2758"></a><p>
   You configure the Federation component by modifying
   both the OpenIG <code class="filename">config.json</code> file
   and also by including Federation-specific XML files with the configuration.
  </p><div class="itemizedlist"><p>
    The location of configuration information depends on
    the operating system where OpenIG runs,
    and on the user who runs the application server where OpenIG runs.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     On UNIX, Linux, and similar systems,
     where this user's home directory is referred to as <code class="filename">$HOME</code>,
     by default the Federation component looks
     in <code class="filename">$HOME/.openig/config</code> for <code class="filename">config.json</code>
     and in <code class="filename">$HOME/.openig/SAML</code> for the Federation XML configuration.
    </p></li><li class="listitem"><p>
     On Windows, by default the Federation component looks
     in <code class="filename">%appdata%\OpenIG\config</code>,
     and in <code class="filename">%appdata%\OpenIG\SAML</code>.
     To locate the <code class="filename">%appdata%</code> folder for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create
     the <code class="filename">%appdata%\OpenIG\config</code>
     and <code class="filename">%appdata%\OpenIG\SAML</code> folders,
     and then copy the configuration files into the folders.
    </p></li></ul></div><div class="variablelist"><p>The following is a description of the files:</p><dl class="variablelist"><dt><span class="term"><code class="filename">$HOME/.openig/config/config.json</code></span></dt><dd><p>
      This is the core configuration file for OpenIG,
      where you configure a
      <a href="../reference/index.html#SamlFederationHandler" class="link">SamlFederationHandler</a>.
      If this file uses a
      <a href="../reference/index.html#Router" class="link">Router</a>, you can configure the handler in a route file.
     </p><p>
      You must configure both the OpenIG core configuration,
      and also the XML files specific to the Federation component.
      The reason there are two sets of configuration files
      is that the Federation component includes a federation library from OpenAM.
     </p><p>
      In order to configure the Federation component you must tag swap the XML files.
      If you are familiar with the workflow in the OpenAM console
      you can instead generate a Fedlet and directly copy the configuration files
      into <code class="filename">$HOME/.openig/SAML</code>.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/FederationConfig.properties</code></span></dt><dd><p>
      Advanced features of the federation library from OpenAM.
      The defaults suffice in most deployments.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/fedlet.cot</code></span></dt><dd><p>
      Circle of trust for OpenIG and the Identity Provider.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/idp.xml</code></span></dt><dd><p>
      This metadata file is generated by the Identity Provider.
      You must copy the generated metadata file into the configuration directory.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/idp-extended.xml</code></span></dt><dd><p>
      Standard metadata extensions generated by the Identity Provider.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/sp.xml</code>, </span><span class="term"><code class="filename">$HOME/.openig/SAML/sp-extended.xml</code></span></dt><dd><p>
      These are the standard metadata and metadata extensions
      for the OpenIG Federation component.
     </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-configuration"></a>6.4.&nbsp;Configuring the Federation Handler</h2></div></div></div><a class="indexterm" name="d1182e2871"></a><p>
   The simplest way to configure the Federation component
   is to use the OpenAM task wizard to generate a Fedlet,
   and then copy the Fedlet configuration files to the correct locations.
   If you use the Fedlet configuration files,
   simply unpack <code class="filename">Fedlet.war</code>
   and copy all the files listed above into <code class="filename">$HOME/.openig/SAML</code>.
   You do not have to modify the files
   to do basic IDP and SP initiated SSO with OpenIG.
   When generating a Fedlet,
   know that the sample <code class="filename">config.json</code> templates
   uses <code class="literal">/saml</code> as the URI
   so your Fedlet end point should be specified as
   <code class="literal"><em class="replaceable"><code>protocol</code></em>://<em class="replaceable"><code>host</code></em>.<em class="replaceable"><code>domain</code></em>:<em class="replaceable"><code>port</code></em>/saml</code>.
  </p><p>
   If you do not use the Fedlet wizard,
   edit the configuration files for the unconfigured Fedlet,
   and then copy the Fedlet configuration files
   to the <code class="filename">$HOME/.openig/SAML</code> directory.
   You must still nevertheless get the metadata from the IDP,
   and then copy it to <code class="filename">idp.xml</code> in the same directory.
  </p><p>
   Once you have the Fedlet configuration files set up, add the
   <a href="../reference/index.html#SamlFederationHandler" class="link">SamlFederationHandler</a> object to the OpenIG configuration.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-example-settings"></a>6.5.&nbsp;Example Settings</h2></div></div></div><p>
   Application <code class="literal">myportal</code> requires a form
   with username and password for login.
   The username for <code class="literal">myportal</code>
   is the <code class="literal">mail</code> attribute at the user's Identity Provider.
   The password for <code class="literal">myportal</code>
   is the <code class="literal">mailPassword</code> attribute at the Identity Provider.
  </p><p>
   The incoming SAML2 assertion sent by the Identity Provider contains
   the <code class="literal">mail</code> and <code class="literal">mailPassword</code> attributes.
   The Federation component validates the incoming assertion,
   sets the session attributes
   <code class="literal">username</code> and <code class="literal">password</code>
   to the values of
   <code class="literal">mail</code> and <code class="literal">mailPassword</code>
   from the assertion attributes,
   and redirects the user to <code class="literal">/myportal/login</code>.
   A "LoginRequest" filter then retrieves the credentials
   and creates the form to log the user in to <code class="literal">myportal</code>.
  </p><p>
   The "SamlFederationHandler" configuration object looks like this:
  </p><pre class="brush: javascript;">
{
    "name": "SamlFederationHandler",
    "type": "org.forgerock.openig.saml.SamlFederationHandler",
    "config": {
        "assertionMapping": {
            "username": "mail",
            "password": "mailPassword"
        },
        "redirectURI": "/myportal/login",
        "logoutURI": "/myportal/logout"
    }
}
  </pre><p>
   The "LoginRequest" configuration object looks like this:
  </p><pre class="brush: javascript;">
{
    "name": "LoginRequest",
    "type": "StaticRequestFilter",
    "config": {
        "method": "POST",
        "uri": "https://www.myportal.com/myportal/login",
        "form": {
            "username": [
                "${exchange.session.username}"
            ],
            "password": [
                "${exchange.session.password}"
            ]
        }
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-idp-metadata"></a>6.6.&nbsp;Identity Provider Metadata</h2></div></div></div><p>
   The Identity Provider metadata must be copied to
   the <code class="filename">$HOME/.openig/SAML/idp.xml</code> directory.
   See the documentation for your Identity Provider
   for instructions on how to get the metadata.
  </p><p>
   To export Identity Provider metadata from OpenAM,
   either save the response from the appropriate end point,
   such as <code class="literal">http://openam.example.com:8088/openam/saml2/jsp/exportmetadata.jsp</code>,
   or run an <span class="command"><strong>ssoadm</strong></span> command such as the following:
  </p><div class="screen"><pre>
$ <strong>ssoadm \
 export-entity \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --entityid http://openam.example.com:8088/openam \
 --meta-data-file /tmp/idp.xml</strong>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-before-you-start"></a>6.7.&nbsp;Preparing to Try OpenIG as a SAML 2.0 Service Provider</h2></div></div></div><p>
   The following sections in this chapter are a tutorial on setting up
   OpenAM to send a SAML 2.0 assertion to OpenIG containing user credentials,
   and OpenIG to validate the assertion and use the credentials
   to log the user in to the protected application.
  </p><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   The initial OpenIG configuration file should look like the one used
   to proxy requests through to the HTTP server
   and to capture request and response data, see
   <span class="olink"><em class="citetitle">Configuration for Proxy &amp; Capture</em></span>.
  </p><p>
   To test your setup, access the HTTP server home page through OpenIG at
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
   Login as username <code class="literal">george</code>, password <code class="literal">costanza</code>.
   You should see a page showing the username and some information about the request.
  </p><p>
   In this tutorial, it is assumed that you are familiar
   with SAML 2.0 federation and with the components involved, including OpenAM.
   For OpenAM documentation, see
   <a class="link" href="http://docs.forgerock.org/en/openam/" target="_blank">http://docs.forgerock.org/en/openam/</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-configure-openam"></a>6.8.&nbsp;Configuring OpenAM</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard to create a hosted Identity Provider.
   This tutorial does not address PKI configuration for validation and encryption,
   though OpenIG is capable of handling both when properly configured,
   just as any OpenAM Fedlet can handle both.
   Configure the Attribute Mapping to map the
   the <code class="literal">mail</code> attribute to <code class="literal">mail</code>
   and the <code class="literal">employeenumber</code> attribute to <code class="literal">employeenumber</code>.
   You can use the <code class="literal">test</code> certificate
   in the Identity Provider configuration for signing in this example.
  </p><p>
   Then use the common task wizard to create a Fedlet.
   Set the Name to <code class="literal">OpenIG</code>.
   Set the Destination URL to <code class="literal">http://www.example.com:8080/saml</code>.
   Also configure the Attribute Mapping for the Fedlet to map the
   the <code class="literal">mail</code> attribute to <code class="literal">mail</code>
   and the <code class="literal">employeenumber</code> attribute to <code class="literal">employeenumber</code>.
  </p><p>
   Why map these attributes?
   The SAML 2.0 attribute mapping indicates that the SP, OpenIG,
   wants the IDP, OpenAM in this case,
   to get the values of these attributes from the user profile
   and then send them to the SP, OpenIG.
   OpenIG can then use the values of the attributes,
   in this case <code class="literal">mail</code> and <code class="literal">employeenumber</code>,
   to log the user in to the application it protects.
  </p><p>
   This tutorial uses <code class="literal">mail</code>
   and <code class="literal">employeenumber</code>
   for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses <code class="literal">mail</code> to hold the username,
   and <code class="literal">employeenumber</code> to hold the password.
   In a real deployment, you would no doubt use other attributes
   that depend on how the real user profiles are configured.
  </p><p>
   Use the OpenAM console to create a user subject in the top level realm
   with Email Address <code class="literal">george</code>
   and Employee Number <code class="literal">costanza</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-configure-federation"></a>6.9.&nbsp;Configuring OpenIG For Federation</h2></div></div></div><p>
   Unpack the configuration files from the Fedlet you created
   in <a class="xref" href="#fed-tutorial-configure-openam" title="6.8.&nbsp;Configuring OpenAM">Section&nbsp;6.8, &#8220;Configuring OpenAM&#8221;</a>.
   The Fedlet is packaged as a .zip file that contains a war file
   that in turn contains the configuration files to unpack.
   OpenAM displays the location of the .zip file
   upon successful creation of the Fedlet.
   If you followed the instructions above, the .zip is
   <code class="filename">$HOME/openam/myfedlets/OpenIG/Fedlet.zip</code>
   on the system where OpenAM runs.
  </p><div class="screen"><pre>
$ <strong>cd $HOME/openam/myfedlets/OpenIG</strong>
$ <strong>unzip Fedlet.zip fedlet.war</strong>
$ <strong>unzip fedlet.war conf/*</strong>
$ <strong>mkdir $HOME/.openig/SAML</strong>
$ <strong>cp conf/* $HOME/.openig/SAML</strong>
$ <strong>ls -1 $HOME/.openig/SAML</strong>
<em>FederationConfig.properties
fedlet.cot
idp-extended.xml
idp.xml
sp-extended.xml
sp.xml</em>
  </pre></div><p>
   On Windows, the SAML configuration files belong in
   <code class="filename">%appdata%\OpenIG\SAML</code>.
   To locate the <code class="filename">%appdata%</code> folder for your version of Windows,
   open Windows Explorer,
   type <code class="literal">%appdata%</code> as the file path,
   and press Enter.
  </p><p>
   Restart Jetty after preparing the SAML configuration files.
  </p><div class="itemizedlist"><p>
    Add two new routes to the OpenIG configuration.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Add a route that injects credentials into the exchange
     based on attribute values from the SAML assertion
     returned on successful authentication.
    </p><p>
     The configuration file to add in this case is
     <code class="filename">$HOME/.openig/config/routes/05-saml.json</code>
    </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "SamlFederationHandler",
        "config": {
            "assertionMapping": {
                "username": "mail",
                "password": "employeenumber"
            },
            "subjectMapping": "subjectName",
            "redirectURI": "/federate"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/saml')}",
    "session": "JwtSession"
}

    </pre><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\05-saml.json</code>.
    </p><div class="itemizedlist"><p>
      Notice the following features of the new route.
     </p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
       The "SamlFederationHandler" extracts credentials
       from the attributes returned in the SAML 2.0 assertion.
       It then redirects to the <code class="literal">/federate</code> route.
      </p></li><li class="listitem"><p>
       The route matches requests to <code class="literal">/saml</code>.
      </p></li><li class="listitem"><p>
       The route uses the "JwtSession" session implementation,
       meaning it stores encrypted session information in a browser cookie.
       The name is a reference to the "JwtSession" object
       defined in <code class="filename">config.json</code>.
       For details, see the reference for
       <a href="../reference/index.html#JwtSession" class="link">JwtSession</a>.
      </p></li></ul></div></li><li class="listitem"><p>
     Add a route that handles requests to perform SAML federation.
    </p><p>
     The configuration file to add in this case is
     <code class="filename">$HOME/.openig/config/routes/05-federate.json</code>
    </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${empty exchange.session.username}",
                    "handler": {
                        "type": "StaticResponseHandler",
                        "config": {
                            "status": 302,
                            "reason": "Found",
                            "headers": {
                                "Location": [
                                    "http://www.example.com:8080/saml/SPInitiatedSSO"
                                ]
                            }
                        }
                    },
                    "baseURI": "http://www.example.com:8081"
                },
                {
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "http://www.example.com:8081",
                                        "form": {
                                            "username": [
                                                "${exchange.session.username}"
                                            ],
                                            "password": [
                                                "${exchange.session.password}"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://www.example.com:8081"
                }
            ]
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/federate')}",
    "session": "JwtSession"
}

     </pre></div><p>
     On Windows, the file name should be
     <code class="filename">%appdata%\OpenIG\config\routes\05-federate.json</code>.
    </p><div class="itemizedlist"><p>
      Notice the following features of the new route.
     </p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
       The "DispatchHandler" dispatches requests
       to the "StaticResponseHandler"
       if the username has not yet been populated in the exchange,
       meaning the user has not yet authenticated with the IDP.
       Otherwise, if the credentials have been inserted into the exchange,
       the "DispatchHandler" dispatches requests
       to the "Chain" to log the user in to the protected application.
      </p></li><li class="listitem"><p>
       The "StaticResponseHandler" redirects
       to the Service Provider initiated single sign-on end point
       to initiate SAML 2.0 web browser SSO.
       After authentication is successful
       and the "SamlFederationHandler" has injected credentials into the exchange,
       the user-agent ends up redirected to this same route.
      </p></li><li class="listitem"><p>
       The "StaticRequestFilter" retrieves
       the username and password from the exchange
       and replaces your browser's original HTTP GET request
       with an HTTP POST login request
       that contains the credentials to authenticate.
      </p></li><li class="listitem"><p>
       The route matches requests to <code class="literal">/federate</code>.
       This is the route you use to test the configuration.
      </p></li><li class="listitem"><p>
       The route also uses the "JwtSession" session implementation.
      </p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-testing"></a>6.10.&nbsp;Trying It Out</h2></div></div></div><div class="itemizedlist"><p>
    Log out of OpenAM console,
    and then test whether everything is properly configured.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     For IDP initiated SSO, click
     <a class="link" href="http://openam.example.com:8088/openam/idpssoinit?NameIDFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:transient&amp;metaAlias=/idp&amp;spEntityID=OpenIG&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">this IDP initiated SSO link</a>,
     and then login to OpenAM
     with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    </p></li><li class="listitem"><p>
     For SP initiated SSO,
     either browse to the URL for the new route,
     at <a class="link" href="http://www.example.com:8080/federate" target="_blank">http://www.example.com:8080/federate</a>,
     or click
     <a class="link" href="http://www.example.com:8080/saml/SPInitiatedSSO?metaAlias=/sp&amp;idpEntityID=http://openam.example.com:8088/openam&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">this SP initiated SSO link</a>,
     and then login to OpenAM
     with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    </p></li></ul></div><p>
   However you initiate single sign-on,
   you should wind up viewing the page you normally see after logging in.
  </p><p>
   What is happening behind the scenes?
  </p><p>
   The initial incoming requests matches the <code class="literal">/federate</code> route.
   As the user is not yet authenticated,
   the "SPInitiatedSSORedirectHandler" sends a redirect to initiate SSO.
  </p><p>
   The user authenticates with the Identity Provider for SAML 2.0 single sign-on.
   After authentication, the Identity Provider redirects the user-agent back to
   the SAML URI on the Service Provider (OpenIG),
   which you configured for the Fedlet as <code class="literal">/saml</code>.
   The "SamlFederationHandler" gets the request to this route.
   The request holds the SAML 2.0 assertion whose attributes contain credentials.
  </p><p>
   The "SamlFederationHandler" processes an incoming SAML 2.0 assertion,
   injecting credentials values from the assertion into the exchange session.
   The "SamlFederationHandler" then redirects
   to the <code class="literal">/federate</code> route.
  </p><p>
   On the <code class="literal">/federate</code> route,
   once the attributes from the assertion are set in the session,
   OpenIG dispatches the exchange to the "Chain".
   The "StaticRequestFilter" in the "Chain"
   uses the attribute values to replace the request
   with an HTTP POST of login form data
   to log the user in to the protected application.
  </p><p>
   OpenIG returns the response page showing that the user has logged in.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-oauth2-rs"></a>Chapter&nbsp;7.&nbsp;OpenIG as an OAuth 2.0 Resource Server</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-oauth2-rs">7.1. About OpenIG as an OAuth 2.0 Resource Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-before-you-start">7.2. Preparing the Tutorial</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-openam-config">7.3. Setting Up OpenAM as an Authorization Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-gateway-config">7.4. Configuring OpenIG as a Resource Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-test">7.5. Trying It Out</a></span></dt></dl></div><p>
  This chapter explains how OpenIG acts as an OAuth 2.0 Resource Server,
  and follows with a tutorial
  that shows you how to use OpenIG as a resource server.
 </p><a class="indexterm" name="d1182e3290"></a><a class="indexterm" name="d1182e3295"></a><a class="indexterm" name="d1182e3300"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oauth2-rs"></a>7.1.&nbsp;About OpenIG as an OAuth 2.0 Resource Server</h2></div></div></div><p>
   <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank">The OAuth 2.0 Authorization Framework</a> describes a way of
   allowing a third-party application to access a user's resources
   without having the user's credentials.
   When resources are protected with OAuth 2.0,
   users can use their credentials with an OAuth 2.0-compliant identity provider,
   such as OpenAM, Facebook, Google and others
   to access the resources, rather than setting up an account
   with yet another third-party application.
  </p><div class="itemizedlist"><p>
    In OAuth 2.0, there are four entities involved.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The <em class="firstterm">resource owner</em> is the end user
     who owns protected resources on a resource server.
    </p><p>
     For example, a resource owner has photos stored in a web service.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">resource server</em> provides
     the user's protected resources to authorized client applications.
    </p><p>
     In OAuth 2.0, an authorization server grants the client application
     authorization based on the resource owner's consent.
    </p><p>
     For example, a web service holds user's photos.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">client</em> is the application
     that needs access to the protected resources.
    </p><p>
     For example, a photo printing service needs access to the user's photos.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">authorization server</em> is the service
     responsible for authenticating resource owners and obtaining their consent
     to allow client applications to access their resources.
    </p><p>
     For example, OpenAM can act as the OAuth 2.0 authorization server
     to authenticate resource owners and obtain their consent.
     Other services can play this role as well.
     Google and Facebook for example provide OAuth 2.0 authorization services.
    </p></li></ul></div><p>
   In OAuth 2.0, there are different grant mechanisms
   whereby the client can obtain authorization.
   One grant mechanism involves the client redirecting the resource owner's browser
   to the authorization server to complete authentication and authorization.
   You might have experienced this grant mechanism yourself
   when logging in with your identity provider account to access a web service,
   rather than creating a new account directly with the web service.
   Whatever the grant mechanism,
   the client's aim is to get an
   OAuth 2.0 <em class="firstterm">access token</em> from the authorization server.
  </p><p>
   Access tokens are the credentials used to access protected resources.
   An access token is just a string that represents the authorization
   to access protected resources given by the authorization server.
   An access token, like cash, is a bearer token.
   This means that anyone who has the access token can use it to get the resources.
   Access tokens therefore must be protected,
   so requests involving them must go over HTTPS.
   The advantage of access tokens over passwords or other credentials
   is that access tokens can be granted and revoked
   without exposing the user's credentials.
  </p><p>
   When the client requests access to protected resources,
   it supplies the access token to the resource server housing the resources.
   The resource server must then validate the access token.
   If the access token is found to be valid,
   then the resource server can let the client have access to the resources.
  </p><p>
   When OpenIG acts therefore as an OAuth 2.0 resource server,
   its role is to validate access tokens.
   How an access token is validated is technically not covered
   in the specifications for OAuth 2.0.
   Typically the resource server validates an access token
   by submitting the token to a token information endpoint.
   The token information endpoint typically returns
   the access token, when it expires,
   and the OAuth 2.0 <em class="firstterm">scopes</em> associated with the token,
   potentially with other information.
   In OAuth 2.0, the token scopes are strings
   that can identify the scope of access authorized to the client,
   but can also be used for other purposes.
   For example, OpenAM maps them to user profile attribute values by default,
   and also allows custom scope handling plugins.
  </p><p>
   In the tutorial that follows,
   you configure OpenIG as a resource server,
   and use OpenAM as the OAuth 2.0 authorization server.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-before-you-start"></a>7.2.&nbsp;Preparing the Tutorial</h2></div></div></div><p>
   In the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
   you learned how to configure OpenIG
   to proxy traffic and capture request and response data.
   You also learned how to configure OpenIG
   to use a static request to log in with hard-coded credentials.
  </p><p>
   This tutorial shows you how OpenIG
   can act as an OAuth 2.0 resource server,
   validating OAuth 2.0 access tokens and including token info in the exchange.
  </p><p>
   This tutorial relies on OpenAM as an OAuth 2.0 authorization server.
   As an OAuth 2.0 client of OpenAM, you get an access token.
   You then submit the access token to OpenIG,
   and OpenIG acts as the resource server.
  </p><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-openam-config"></a>7.3.&nbsp;Setting Up OpenAM as an Authorization Server</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
   Although this tutorial does not use HTTPS,
   you must use HTTPS to protect access tokens in production environments.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard, Configure OAuth2,
   to configure an OAuth 2.0 authorization server in / (Top Level Realm).
  </p><p>
   Also create an OAuth 2.0 Client profile in / (Top Level Realm).
   This allows you to request an OAuth 2.0 access token on behalf of the client.
   In OpenAM console, browse to
   Access Control &gt; / (Top Level Realm) &gt; Agents &gt; OAuth 2.0 Client,
   and then click New in the Agent table.
  </p><p>
   Create an OAuth 2.0 client profile with name <code class="literal">OpenIG</code>
   and password <code class="literal">password</code>.
   The name is the OAuth 2.0 client_id, and the password is the client_secret.
  </p><p>
   Edit the <code class="literal">OpenIG</code> client profile
   to add <code class="literal">mail</code> and <code class="literal">employeenumber</code> scopes
   to the Scope(s) list, and then save your work.
   In this tutorial,
   you overload these profile settings to pass credentials to OpenIG.
   This tutorial uses <code class="literal">mail</code>
   and <code class="literal">employeenumber</code>
   for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses <code class="literal">mail</code> to hold the username,
   and <code class="literal">employeenumber</code> to hold the password.
   In a real deployment, you would no doubt use other attributes
   that depend on how the real user profiles are configured.
  </p><div class="orderedlist"><p>
    Finally, create a user whose additional credentials you set in
    the Email Address and Employee Number fields
    if you have not already done so for another tutorial.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     In OpenAM console,
     under Access Control &gt; / (Top Level Realm) &gt; Subjects &gt; User,
     click New to create the user profile.
    </p></li><li class="listitem"><p>
     Set the ID to <code class="literal">george</code>,
     the password to <code class="literal">costanza</code>,
     and fill the other required fields as you like
     before clicking OK.
    </p></li><li class="listitem"><p>
     Click the user name to edit the profile again,
     setting Email Address to <code class="literal">george</code>
     and Employee Number to <code class="literal">costanza</code>
     before clicking Save.
    </p></li><li class="listitem"><p>
     When finished, log out of OpenAM console.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-gateway-config"></a>7.4.&nbsp;Configuring OpenIG as a Resource Server</h2></div></div></div><p>
   To configure OpenIG as an OAuth 2.0 resource server, you use an
   <a href="../reference/index.html#OAuth2ResourceServerFilter" class="link">OAuth2ResourceServerFilter</a>.
  </p><p>
   The filter expects an OAuth 2.0 access token
   in an incoming <code class="literal">Authorization</code> request header,
   such as the following.
  </p><pre class="brush: http;">
Authorization: Bearer 7af41ddd-47a4-40dc-b530-a9aa9f7ceda9
  </pre><p>
   The filter then uses the access token to validate the token
   and to retrieve token information from the authorization server.
   On successful validation, the filter injects
   the response from the authorization server into
   the location set by the "target" in the configuration.
  </p><p>
   If no access token is present in the request,
   or token validation does not complete successfully,
   the filter returns an HTTP error status to the user-agent,
   and OpenIG does not continue processing the exchange.
   This is done as specified in the RFC,
   <a class="link" href="http://tools.ietf.org/html/rfc6750" target="_blank">OAuth 2.0 Bearer Token Usage</a>.
  </p><p>
   You can therefore add additional filters and handlers to the chain
   directly after the <code class="literal">OAuth2ResourceServerFilter</code>,
   and expect to have the access token if the filter completes successfully.
  </p><p>
   To configure OpenIG as an OAuth 2.0 resource server,
   add a new route to the OpenIG configuration,
   by including the following route configuration file
   as <code class="filename">$HOME/.openig/config/routes/06-rs.json</code>.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "OAuth2ResourceServerFilter",
                    "config": {
                        "providerHandler": "ClientHandler",
                        "scopes": [
                            "mail",
                            "employeenumber"
                        ],
                        "tokenInfoEndpoint":
                            "http://openam.example.com:8088/openam/oauth2/tokeninfo",
                        "requireHttps": false,
                        "target": "${exchange.token}"
                    },
                    "timer": true
                },
                {
                    "type": "ScriptableFilter",
                    "config": {
                        "type": "application/x-groovy",
                        "source":
                            "import org.forgerock.json.fluent.JsonValue;
                             logger.info(exchange.token.asJsonValue() as String);
                             exchange.username = exchange.token.info.mail;
                             exchange.password = exchange.token.info.employeenumber;
                             next.handle(exchange)"
                    },
                    "timer": true
                },
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "${exchange.username}"
                            ],
                            "password": [
                                "${exchange.password}"
                            ]
                        }
                    },
                    "timer": true
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/rs')}",
    "timer": true
}

   </pre></div><p>
   On Windows, the file name should be
   <code class="filename">%appdata%\OpenIG\config\routes\06-rs.json</code>.
  </p><div class="itemizedlist"><p>
    Notice the following features of the new route.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The "OAuth2ResourceServerFilter" includes
     a client handler to send access token validation requests,
     the list of required scopes that the filter expects to find in access tokens,
     the OpenAM token info endpoint used to validate access tokens,
     and <code class="literal">"requireHttps": false</code> to allow testing
     without having to set up keys and certificates.
     (In production environments, do use HTTPS to protect access tokens.)
    </p><p>
     After successfully using the token info endpoint
     to validate an access token,
     the "OAuth2ResourceServerFilter" injects data
     from the response into <code class="literal">exchange.token</code>.
    </p></li><li class="listitem"><p>
     After the "OAuth2ResourceServerFilter"
     has injected information for a valid access token into the exchange,
     the "ScriptableFilter" dumps the token information to the log.
     The "ScriptableFilter" also injects the credentials
     from the user profile in OpenAM into the exchange.
    </p></li><li class="listitem"><p>
     The "StaticRequestFilter" retrieves
     the username and password from the exchange
     and replaces the original HTTP GET request
     with an HTTP POST login request
     that contains the credentials to authenticate.
    </p></li><li class="listitem"><p>
     The route matches requests to <code class="literal">/rs</code>.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-test"></a>7.5.&nbsp;Trying It Out</h2></div></div></div><p>
   To try your configuration, you need an access token.
   Get an access token from OpenAM and use it to access OpenIG
   as in the following example,
   which uses the OAuth 2.0 resource owner password credentials authorization grant.
  </p><div class="screen"><pre>
$ <strong>curl \
 --user "OpenIG:password" \
 --data "grant_type=password&amp;username=george&amp;password=costanza&amp;scope=mail%20employeenumber" \
 http://openam.example.com:8088/openam/oauth2/access_token</strong>
<em>{
    "scope": "mail employeenumber",
    "expires_in": 60,
    "token_type": "Bearer",
    "refresh_token": "80963b0e-8283-434b-ba11-ce01ef0e93b6",
    "access_token": "ddf31dac-e23a-446c-bd21-db60cf19b9f3"
}</em>

$ <strong>curl \
 --header "Authorization: Bearer ddf31dac-e23a-446c-bd21-db60cf19b9f3" \
 http://www.example.com:8080/rs</strong>
<em>...
    &lt;h1&gt;User Information&lt;/h1&gt;

    &lt;dl&gt;
        &lt;dt&gt;Username&lt;/dt&gt;
        &lt;dd&gt;george&lt;/dd&gt;
    &lt;/dl&gt;

    &lt;h1&gt;Request Information&lt;/h1&gt;

    &lt;dl&gt;
        &lt;dt&gt;Method&lt;/dt&gt;
        &lt;dd&gt;POST&lt;/dd&gt;

        &lt;dt&gt;URI&lt;/dt&gt;
        &lt;dd&gt;/&lt;/dd&gt;

        &lt;dt&gt;Headers&lt;/dt&gt;
        &lt;dd style="font-family: monospace; font-size: small;"&gt;...&lt;/dd&gt;
    &lt;/dl&gt;
</em>
  </pre></div><p>
   Also look in the Jetty server output to see the access token information.
   The access token information looks something like the following.
  </p><pre class="brush: plain;">
TUE DEC 02 17:14:28 CET 2014 (INFO) {ScriptableFilter}/handler/config/filters/1
{
    "mail": "george",
    "employeenumber": "costanza",
    "scope": [
        "mail",
        "employeenumber"
    ],
    "grant_type": "password",
    "realm": "/",
    "token_type": "Bearer",
    "expires_in": 41,
    "access_token": "e362515f-ecf2-47b7-b1a7-c6480e705129"
}
  </pre><p>
   What is happening behind the scenes?
  </p><p>
   After OpenIG gets the <span class="command"><strong>curl</strong></span> request,
   the resource server filter validates the access token with OpenAM,
   and injects the token information into the exchange.
   (If the access token was missing or invalid,
   then the resource server filter would have
   returned an error status to the user-agent.
   The OAuth 2.0 client would then have had to deal with the error.)
  </p><p>
   The "ScriptableFilter" logs the token information,
   and also extracts the credentials to inject them into the exchange.
   Finally the "StaticRequestFilter" uses the credentials
   to log the user in to the minimal HTTP server,
   which responds with the User Information page.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-oauth2-client"></a>Chapter&nbsp;8.&nbsp;OpenIG as an OAuth 2.0 Client</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-oauth2-client">8.1. About OpenIG as an OAuth 2.0 Client</a></span></dt><dt><span class="section"><a href="#about-oidc-rp">8.2. About OpenIG as an OpenID Connect 1.0 Relying Party</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-before-you-start">8.3. Preparing the Tutorial</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-openam-config">8.4. Setting Up OpenAM as an OpenID Provider</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-gateway-config">8.5. Configuring OpenIG as a Relying Party</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-test">8.6. Trying It Out</a></span></dt></dl></div><p>
  This chapter explains how OpenIG acts
  as an OAuth 2.0 client or OpenID Connect 1.0 relying party,
  and follows with a tutorial
  that shows you how to use OpenIG
  as an OpenID Connect 1.0 relying party.
 </p><a class="indexterm" name="d1182e3562"></a><a class="indexterm" name="d1182e3567"></a><a class="indexterm" name="d1182e3572"></a><a class="indexterm" name="d1182e3577"></a><a class="indexterm" name="d1182e3582"></a><a class="indexterm" name="d1182e3587"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oauth2-client"></a>8.1.&nbsp;About OpenIG as an OAuth 2.0 Client</h2></div></div></div><p>
   As described in the chapter,
   <a href="../gateway-guide/index.html#chap-oauth2-rs" class="link"><em class="citetitle">OpenIG as an OAuth 2.0 Resource Server</em></a>,
   an OAuth 2.0 client is the third-party application that needs access
   to a user's protected resources.
   The client application therefore has the user (the OAuth 2.0 resource owner)
   delegate authorization by authenticating
   with an identity provider (the OAuth 2.0 authorization server)
   using an existing account,
   and then consenting to authorize access to protected resources
   (on an OAuth 2.0 resource server).
  </p><p>
   OpenIG can act as an OAuth 2.0 client when you configure an
   <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a>.
   The filter handles the process of allowing the user to select a provider,
   and redirecting the user through the authentication and authorization steps
   of an OAuth 2.0 authorization code grant,
   which results in the authorization server returning an access token to the filter.
   At the outcome of a successful authorization grant,
   the filter injects the access token data
   into a configurable target field of the exchange
   so that subsequent filters and handlers have access
   to the access token.
   Subsequent requests can use the access token without re-authentication.
  </p><p>
   If the protected application is an OAuth 2.0 resource server,
   then OpenIG can send the access token with the resource request.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oidc-rp"></a>8.2.&nbsp;About OpenIG as an OpenID Connect 1.0 Relying Party</h2></div></div></div><p>
   The specifications available through the
   <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank">OpenID Connect</a> site describe an authentication layer built on OAuth 2.0,
   which is OpenID Connect 1.0.
  </p><p>
   OpenID Connect 1.0 is a specific implementation of OAuth 2.0
   where the identity provider holds the protected resource
   that the third-party application aims to access.
   This resource is the <em class="firstterm">UserInfo</em>,
   information about the authenticated end-user expressed in a standard format.
  </p><div class="itemizedlist"><p>
    In OpenID Connect 1.0, the key entities are the following.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The <em class="firstterm">end user</em> (OAuth 2.0 resource owner)
     whose user information the application needs to access.
    </p><p>
     The end user wants to use an application
     through existing identity provider account
     without signing up to and creating credentials for yet another web service.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">Relying Party</em> (RP) (OAuth 2.0 client)
     needs access to the end user's protected user information.
    </p><p>
     For example, an online mail application needs to know which end user
     is accessing the application in order to present the correct inbox.
    </p><p>
     As another example, an online shopping site needs to know which end user
     is accessing the site in order to present
     the right offerings, account, and shopping cart.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">OpenID Provider</em> (OP)
     (OAuth 2.0 authorization server and also resource server)
     that holds the user information and grants access.
    </p><p>
     The OP effectively has the end user consent to providing the RP
     with access to some of its user information.
     As OpenID Connect 1.0 defines unique identification for an account
     (subject identifier + issuer identifier),
     the RP can use this as a key to its own user profile.
    </p><p>
     In the case of the online mail application,
     this key could be used to access the mailboxes and related account information.
     In the case of the online shopping site,
     this key could be used to access the offerings, account, shopping cart and so forth.
     The key makes it possible to serve users as if they had local accounts.
    </p></li></ul></div><p>
   When OpenIG acts therefore as an OpenID Connect 1.0 relying party,
   its ultimate role is to retrieve user information from the OpenID provider,
   and then to inject that information into the exchange
   for use by subsequent filters and handlers.
  </p><p>
   In the tutorial that follows,
   you configure OpenIG as a relying party,
   and use OpenAM as the OpenID Provider.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-before-you-start"></a>8.3.&nbsp;Preparing the Tutorial</h2></div></div></div><p>
   In the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
   you learned how to configure OpenIG
   to proxy traffic and capture request and response data.
   You also learned how to configure OpenIG
   to use a static request to log in with hard-coded credentials.
  </p><p>
   This tutorial shows you how OpenIG
   can act as an OpenID Connect 1.0 relying party.
  </p><p>
   This tutorial relies on OpenAM as an OpenID Provider.
   As a relying party, OpenIG takes the end user to OpenAM
   for authorization and an access token.
   It then uses the access token to get end user information from OpenAM.
  </p><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-openam-config"></a>8.4.&nbsp;Setting Up OpenAM as an OpenID Provider</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
   Although this tutorial does not use HTTPS,
   you must use HTTPS to protect access tokens and user information
   in production environments.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard, Configure OAuth2,
   to configure an OAuth 2.0 authorization server in / (Top Level Realm).
   This also configures OpenAM as an OpenID Provider.
  </p><p>
   Also create an OAuth 2.0 Client profile in / (Top Level Realm).
   This allows OpenIG to communicate with OpenAM as an OAuth 2.0 client.
   In OpenAM console, browse to
   Access Control &gt; / (Top Level Realm) &gt; Agents &gt; OAuth 2.0 Client,
   and then click New in the Agent table.
  </p><p>
   Create an OAuth 2.0 client profile with name <code class="literal">OpenIG</code>
   and password <code class="literal">password</code>.
   The name is the "clientId" value, and the password is the "clientSecret" value
   that you use in the provider configuration in OpenIG.
  </p><p>
   Edit the <code class="literal">OpenIG</code> client profile
   to add the Redirection URI
   <code class="literal">http://www.example.com:8080/openid/callback</code>.
   Also add <code class="literal">openid</code> and <code class="literal">profile</code> scopes
   to the Scope(s) list, and then save your work.
  </p><p>
   In this tutorial,
   you overload the profile settings to pass credentials to OpenIG.
   This tutorial uses Full Name and Last Name for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses Last Name to hold the username,
   and Full Name to hold the password.
   In a real deployment, you would no doubt use other attributes,
   depending upon the user profiles and on your requirements.
  </p><div class="orderedlist"><p>
    To overload the profile,
    create a user whose additional credentials you set in
    the Full Name and Last Name fields,
    or edit the existing user <code class="literal">george</code> if you have already
    created the profile for another tutorial.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     In OpenAM console,
     under Access Control &gt; / (Top Level Realm) &gt; Subjects &gt; User,
     click New to create the user profile.
    </p><p>
     If the profile already exists in the table,
     then click the link to open the profile for editing.
    </p></li><li class="listitem"><p>
     Set the ID to <code class="literal">george</code>,
     the password to <code class="literal">costanza</code>,
     the Last Name to <code class="literal">george</code>,
     and the Full Name to <code class="literal">costanza</code>
     before clicking OK (or Save).
    </p></li><li class="listitem"><p>
     When finished, log out of OpenAM console by clicking the log out button.
     It is not enough simply to close the browser tab,
     as the OpenAM session remains active until you log out or quit the browser.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-gateway-config"></a>8.5.&nbsp;Configuring OpenIG as a Relying Party</h2></div></div></div><p>
   To configure OpenIG as an OpenID Connect 1.0 relying party,
   add a new route to the OpenIG configuration,
   by including the following route configuration file
   as <code class="filename">$HOME/.openig/config/routes/07-openid.json</code>.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
  "handler": {
    "type": "Chain",
    "config": {
      "filters": [
        {
          "type": "OAuth2ClientFilter",
          "config": {
            "clientEndpoint": "/openid",
            "requireHttps": false,
            "requireLogin": true,
            "target": "${exchange.openid}",
            "scopes": [
              "openid",
              "profile"
            ],
            "failureHandler": {
              "type": "StaticResponseHandler",
              "config": {
                "comment": "Trivial failure handler for debugging only",
                "status": 500,
                "reason": "Error",
                "entity": "${exchange.openid}"
              }
            },
            "providerHandler": "ClientHandler",
            "providers": [
              {
                "name": "openam",
                "wellKnownConfiguration":
                    "http://openam.example.com:8088/openam/.well-known/openid-configuration",
                "clientId": "OpenIG",
                "clientSecret": "password"
              }
            ]
          }
        }
      ],
      "handler": {
        "type": "Chain",
        "config": {
          "filters": [
            {
              "type": "StaticRequestFilter",
              "config": {
                "method": "POST",
                "uri": "http://www.example.com:8081",
                "form": {
                  "username": [
                    "${exchange.openid.user_info.family_name}"
                  ],
                  "password": [
                    "${exchange.openid.user_info.name}"
                  ]
                }
              }
            }
          ],
          "handler": "ClientHandler"
        }
      }
    }
  },
  "condition": "${matches(exchange.request.uri.path, '^/openid')}",
  "baseURI": "http://www.example.com:8080"
}

  </pre></div><p>
   On Windows, the file name should be
   <code class="filename">%appdata%\OpenIG\config\routes\07-openid.json</code>.
  </p><div class="itemizedlist"><p>
    Notice the following features of the new route.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     At the global level the route changes the base URI for requests
     to ensure that the initial exchange happens
     between OpenIG and OpenAM, which is the OpenID Provider.
     This route sends only the final request to the protected application.
    </p></li><li class="listitem"><p>
     The first filter in the outermost chain has the
     <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a> type.
     This is the filter that enables OpenIG to act as a relying party.
    </p><p>
     The filter is configured to work only with a single provider,
     the OpenAM server you configured in
     <a class="xref" href="#oidc-rp-tutorial-openam-config" title="8.4.&nbsp;Setting Up OpenAM as an OpenID Provider">Section&nbsp;8.4, &#8220;Setting Up OpenAM as an OpenID Provider&#8221;</a>.
     If you had more than one provider configured,
     you would need a "loginHandler" as well to help end users pick a provider.
    </p><p>
     The "OAuth2ClientFilter" has
     a base client endpoint of <code class="literal">/openid</code>.
     Incoming requests to <code class="literal">/openid/login</code>
     start the delegated authorization process.
     Incoming requests to <code class="literal">/openid/callback</code>
     are expected as redirects from the OP (as authorization server),
     so this is why you set the redirect URI in the client profile in OpenAM to
     <code class="literal">http://www.example.com:8080/openid/callback</code>.
    </p><p>
     The "OAuth2ClientFilter" has <code class="literal">"requireHttps": false</code>
     as a convenience for testing.
     In production environments, require HTTPS.
    </p><p>
     The filter has <code class="literal">"requireLogin": true</code> to ensure you see
     the delegated authorization process when you make your request.
    </p><p>
     In the "OAuth2ClientFilter",
     the target for storing authorization state information is
     <code class="literal">${exchange.openid}</code>,
     so this is where subsequent filters and handlers can find
     access token and user information.
    </p><p>
     The scopes are set to "openid" and "profile"
     as allowed for OpenID Connect 1.0.
    </p><p>
     Notice that on failure the filter
     dumps the current information in the exchange
     into a web page response to the end user.
     While this is helpful to you for debugging purposes,
     it is not helpful to an end user.
     In production environments, return a more user-friendly failure page.
    </p><p>
     Also in the "OAuth2ClientFilter",
     the typical "ClientHandler" configures the HTTP client that communicates
     with the OpenID Provider.
    </p></li><li class="listitem"><p>
     After the filter injects the access token and user information
     into <code class="literal">exchange.openid</code>,
     OpenIG invokes a "Chain".
     The "Chain" uses the credentials to log the user in
     to the minimal HTTP server.
    </p><p>
     With this configuration, all successful requests result in login attempts
     against the minimal HTTP server.
    </p></li><li class="listitem"><p>
     The "StaticRequestFilter" retrieves
     the username and password from the exchange
     and replaces the original HTTP GET request
     with an HTTP POST login request
     that contains the credentials to authenticate.
    </p></li><li class="listitem"><p>
     The route matches requests to <code class="literal">/openid</code>.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-test"></a>8.6.&nbsp;Trying It Out</h2></div></div></div><p>
   To try your configuration, browse to OpenIG at
   <a class="link" href="http://www.example.com:8080/openid" target="_blank">http://www.example.com:8080/openid</a>.
  </p><p>
   When redirected to the OpenAM login page,
   login as user <code class="literal">george</code>, password <code class="literal">costanza</code>,
   and then allow the application access to user information.
  </p><p>
   If successful, OpenIG logs you into the minimal HTTP server
   as George Costanza, and the minimal HTTP server returns George's page.
  </p><p>
   What is happening behind the scenes?
  </p><p>
   After OpenIG gets the browser request,
   the "OAuth2ClientFilter" redirects you to authenticate with OpenAM
   and consent to authorize access to user information.
   After you authorize access, OpenAM returns an access token to the filter.
  </p><p>
   The filter then uses that access token to get the user information.
   The filter injects the authorization state information into
   <code class="literal">exchange.openid</code>.
   The outermost chain then calls its handler, which as another "Chain".
  </p><p>
   This inner chain uses the credentials to log the user in
   to the minimal HTTP server, which responds with its User Information page.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-routing"></a>Chapter&nbsp;9.&nbsp;Configuring Routes</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#routing-before-you-start">9.1. Before You Start</a></span></dt><dt><span class="section"><a href="#routing-router-setup">9.2. Configuring the Router</a></span></dt><dt><span class="section"><a href="#routing-route-setup">9.3. Configuring Additional Routes</a></span></dt><dt><span class="section"><a href="#routing-try-it-out">9.4. Trying it Out</a></span></dt><dt><span class="section"><a href="#routing-lockdown">9.5. Locking Down Route Configurations</a></span></dt></dl></div><a class="indexterm" name="d1182e3859"></a><a class="indexterm" name="d1182e3862"></a><a class="indexterm" name="d1182e3867"></a><a class="indexterm" name="d1182e3872"></a><p>
  Other tutorials in this guide demonstrate how to use routes
  so that you can change the configuration without restarting OpenIG.
 </p><p>
  This tutorial takes a closer look at
  <a href="../reference/index.html#Router" class="link">Router</a>
  and
  <a href="../reference/index.html#Route" class="link">Route</a> configurations.
  This tutorial demonstrates the use of routes to handle multiple applications.
  It also shows how to lock down the configurations for deployment
  so that accidental changes to configuration files
  do not affect servers running in production.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-before-you-start"></a>9.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   You start therefore with a default route
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-router-setup"></a>9.2.&nbsp;Configuring the Router</h2></div></div></div><p>
   When you set up the first tutorial, you configured a Router.
  </p><p>
   The Router is a handler that you can configure in the top-level
   <code class="filename">config.json</code> file for OpenIG,
   and in fact wherever you can configure a Handler.
   For the first tutorial, you added a Router as part of the base configuration,
   which is shown here again in the following listing.
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Router",
        "audit": "global",
        "capture": "all"
    },
    "heap": [
        {
            "name": "LogSink",
            "type": "ConsoleLogSink",
            "config": {
                "level": "DEBUG"
            }
        },
        {
            "name": "JwtSession",
            "type": "JwtSession"
        },
        {
            "name": "ClientHandler",
            "type": "ClientHandler"
        },
        {
            "name": "capture",
            "type": "CaptureDecorator",
            "config": {
                "captureEntity": true,
                "_captureExchange": true
            }
        }
    ],
    "baseURI": "http://www.example.com:8081"
}

  </pre><p>
   The Router's job is to pass the exchange to a route that matches a condition,
   and to periodically reload changed route configurations.
   As routes define the conditions on which they accept any given Exchange,
   the Router does not have to know about specific Routes in advance.
   In other words, you can configure the Router first
   and then add routes while OpenIG is running,
   as you have done in other tutorials.
  </p><p>
   The configuration shown above passes all Exchanges to the Router
   using the default settings, meaning that the Router
   monitors <code class="filename">$HOME/.openig/config/routes</code> for Routes.
   When OpenIG receives a request,
   if more time has passed than the default scan interval of 10 seconds,
   then OpenIG rescans the Routes directory for changes
   and reloads any Routes changes it finds.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-route-setup"></a>9.3.&nbsp;Configuring Additional Routes</h2></div></div></div><p>
   Routes are configurations to handle an Exchange
   that meets a specified condition.
  </p><p>
   The condition is defined using a OpenIG
   <a href="../reference/index.html#Expressions" class="link">expression</a>, so it can be based on
   almost any characteristic of the Exchange
   or even of the OpenIG runtime environment.
   Another way to think of the Route is like an independent
   <a href="../reference/index.html#DispatchHandler" class="link">DispatchHandler</a>.
  </p><p>
   Routes can also have their own names, used to order them lexicographically.
   If no name is specified, the Route file name is used.
   Route file names have the extension <code class="literal">.json</code>.
   In other words, a router only scans for files
   with the <code class="literal">.json</code> extension,
   and ignores files with other extensions.
  </p><p>
   Routes can have a base URI to change the scheme, host, and port of the request.
  </p><p>
   Routes wrap a heap of configuration objects,
   and hand off any Exchange they accept to a handler.
   In this way each Route is much like
   its own server-wide configuration file.
  </p><p>
   If no condition is specified for the Route, the Route accepts any Exchange.
   The following is a basic default route that accepts any Exchange
   and forwards it on without changes.
  </p><pre class="brush: javascript;">
{
    "name": "default",
    "handler": {
        "type": "ClientHandler"
    }
}
  </pre><div class="orderedlist"><p>
    The rest of this section indicates how to set up Route configurations
    to direct requests to ForgeRock.com and ForgeRock.org
    based on a query string parameter.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Add a ForgeRock.com Route file in the routes directory,
     <code class="filename">08-com.json</code>, that holds the following content.
    </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler",
    "condition": "${matches(exchange.request.uri.query, 'site=com')}",
    "baseURI": "http://forgerock.com:80/",
    "audit": "ForgeRock.com route"
}

  </pre><p>
     This Route accepts the Exchange when the query string parameter,
     <code class="literal">site</code> matches <code class="literal">com</code>.
     When this Route picks up an Exchange,
     it changes the request scheme, host, and port,
     and sends it to ForgeRock.com.
    </p></li><li class="listitem"><p>
     Add a ForgeRock.org community Route file in the routes directory,
     <code class="filename">08-org.json</code>, that holds the following content.
    </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler",
    "condition": "${matches(exchange.request.uri.query, 'site=org')}",
    "baseURI": "https://forgerock.org:443/",
    "audit": "ForgeRock.org route"
}

  </pre><p>
     This Route accepts the Exchange when the query string parameter,
     <code class="literal">site</code> matches <code class="literal">org</code>.
     When this Route picks up an Exchange,
     it changes the request scheme, host, and port,
     and sends it to ForgeRock.org.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-try-it-out"></a>9.4.&nbsp;Trying it Out</h2></div></div></div><p>
   At this point you can try your new route configurations.
  </p><p>
   Browse to the .com URL:
   <a class="link" href="http://www.example.com:8080/?site=com" target="_blank">http://www.example.com:8080/?site=com</a>.
  </p><p>
   You should see the ForgeRock.com page.
  </p><p>
   Browse to the .org URL:
   <a class="link" href="http://www.example.com:8080/?site=org" target="_blank">http://www.example.com:8080/?site=org</a>.
  </p><p>
   You should see the ForgeRock.org Community page.
  </p><p>
   Now browse to the base URL to see that the default route still works:
   <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>.
  </p><p>
   What happened behind the scenes?
  </p><p>
   When you issued your first request with "?site=com",
   the request matched the condition defined in the ForgeRock.com route.
   OpenIG rebased the request and sent it along to
   <code class="literal">http://forgerock.com:80/</code>.
  </p><p>
   When you issued your second request with "?site=org",
   the request matched the condition defined in the ForgeRock.org Community route.
   OpenIG rebased the request and sent it along to
   <code class="literal">http://forgerock.org:80/</code>.
  </p><p>
   When the third request did not match any of the conditions defined,
   the Exchange was routed to the default Route (that accepts any Exchange).
   The static request filter returned the default page.
  </p><p>
   At this point, tinker with your route configurations
   without stopping OpenIG, and notice that changes are picked up
   every 10 seconds.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-lockdown"></a>9.5.&nbsp;Locking Down Route Configurations</h2></div></div></div><p>
   Having the Route configurations automatically reloaded is great in the lab,
   but is perhaps not what you want in production.
  </p><p>
   In that case, stop the server, edit the Router "scanInterval", and restart.
   When "scanInterval" is set to -1, the Router only loads routes at startup.
  </p><pre class="brush: javascript;">
{
    "name": "Router",
    "type": "Router",
    "config": {
        "scanInterval": -1
    }
}
  </pre><p>
   You can also change the file system location to look for routes.
  </p><pre class="brush: javascript;">
{
    "name": "Router",
    "type": "Router",
    "config": {
        "directory": "/path/to/safe/routes",
        "scanInterval": -1
    }
}
  </pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-gateway-templates"></a>Chapter&nbsp;10.&nbsp;Configuration Templates</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#template-proxy-capture">10.1. Proxy &amp; Capture</a></span></dt><dt><span class="section"><a href="#template-simple-login">10.2. Simple Login Form</a></span></dt><dt><span class="section"><a href="#template-login-cookie">10.3. Login Form With Cookie From Login Page</a></span></dt><dt><span class="section"><a href="#template-login-extract-cookie-filters">10.4. Login Form With Extract Filter &amp; Cookie Filter</a></span></dt><dt><span class="section"><a href="#template-login-hidden-value">10.5. Login Which Requires a Hidden Value From the Login Page</a></span></dt><dt><span class="section"><a href="#template-http-and-https">10.6. HTTP &amp; HTTPS Application</a></span></dt><dt><span class="section"><a href="#template-am-integration-headers">10.7. OpenAM Integration With Headers</a></span></dt><dt><span class="section"><a href="#template-owa-online">10.8. Microsoft Online Outlook Web Access</a></span></dt></dl></div><p>
  This chapter contains template routes for common configurations.
 </p><p>
  Before you use one of the templates here,
  install and configure OpenIG with a Router and default route
  as described in the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
 </p><p>
  Next, take one of the templates and then modify it to suit your deployment.
  Read the summary of each template to find the right match for your application.
 </p><p>
  When you move to use OpenIG in production,
  be sure to turn off DEBUG level logging,
  and to deactivate "CaptureDecorator" use to avoid filling up disk space.
  Also consider locking down the Router configuration.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-proxy-capture"></a>10.1.&nbsp;Proxy &amp; Capture</h2></div></div></div><a class="indexterm" name="d1182e4052"></a><p>
   If you installed and configured OpenIG
   with a Router and default route as described in the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
   then you already proxy &amp; capture
   both the application requests coming in and the server responses going out.
  </p><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   with a "DispatchHandler" to change the scheme to HTTPS on login.
   Simply change the "baseURI" to that of the target application,
   and login to the application.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${exchange.request.uri.scheme == 'http'}",
                    "handler": "ClientHandler",
                    "baseURI": "http://TARGETIP"
                },
                {
                    "condition": "${exchange.request.uri.path == '/login'}",
                    "handler": "ClientHandler",
                    "baseURI": "https://TARGETIP"
                },
                {
                    "handler": "ClientHandler",
                    "baseURI": "https://TARGETIP"
                }
            ]
        }
    },
    "capture": "all"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-simple-login"></a>10.2.&nbsp;Simple Login Form</h2></div></div></div><a class="indexterm" name="d1182e4078"></a><p>
   Logs the user into the target application
   with hard-coded user name and password.
   This template intercepts the login page request
   and replaces it with the login form.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${exchange.request.uri.path == '/login'}",
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "https://TARGETIP/login",
                                        "form": {
                                            "USER": [
                                                "MY_USERNAME"
                                            ],
                                            "PASSWORD": [
                                                "MY_PASSWORD"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://TARGETIP"
                },
                {
                    "handler": "ClientHandler",
                    "baseURI": "http://TARGETIP"
                }
            ]
        }
    }
}

   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of your application.
   Also change <code class="literal">MY_USERNAME</code> and <code class="literal">MY_PASSWORD</code>,
   and adapt the "StaticRequestFilter" for your application.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-cookie"></a>10.3.&nbsp;Login Form With Cookie From Login Page</h2></div></div></div><a class="indexterm" name="d1182e4109"></a><p>
   For applications that expect a cookie from the login page
   to be sent in the login request form.
   This templates allows the login page request to go through to the target,
   intercepts the response,
   then creates the login form and adds the intercepted cookie to the POST.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "heap": [
        {
            "name": "DispatchHandler",
            "type": "DispatchHandler",
            "config": {
                "bindings": [
                    {
                        "condition": "${exchange.request.uri.path == '/eum/login'}",
                        "handler": {
                            "type": "Chain",
                            "config": {
                                "filters": [
                                    {
                                        "type": "SwitchFilter",
                                        "config": {
                                            "onResponse": [
                                                {
                                                    "handler": "LoginRequestHandler"
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "handler": "ClientHandler"
                            }
                        },
                        "baseURI": "http://TARGETIP"
                    },
                    {
                        "handler": "ClientHandler",
                        "baseURI": "http://TARGETIP"
                    }
                ]
            }
        },
        {
            "name": "LoginRequestHandler",
            "type": "Chain",
            "config": {
                "filters": [
                    {
                        "type": "StaticRequestFilter",
                        "config": {
                            "method": "POST",
                            "uri": "https://TARGETIP/login",
                            "form": {
                                "USER": [
                                    "MY_USERNAME"
                                ],
                                "PASSWORD": [
                                    "MY_PASSWORD"
                                ]
                            },
                            "headers": {
                                "cookie": [
                                    "${exchange.response.headers['Set-Cookie'][0]}"
                                ]
                            }
                        }
                    }
                ],
                "handler": "ClientHandler"
            }
        }
    ],
    "handler": "DispatchHandler"
}

   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of your application.
   Also change <code class="literal">MY_USERNAME</code> and <code class="literal">MY_PASSWORD</code>,
   and adapt the "StaticRequestFilter" for your application.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-extract-cookie-filters"></a>10.4.&nbsp;Login Form With Extract Filter &amp; Cookie Filter</h2></div></div></div><a class="indexterm" name="d1182e4140"></a><p>
   For applications that return the login page
   when the user tries to access a page without a valid session.
   This template shows how to use the "ExtractFilter"
   to find the login page on the response
   and use the "CookieFilter" to ensure
   the cookies from the application are replayed on each request.
   The sample application in this template is OpenAM.
  </p><div class="note"><h3 class="title">Note</h3><p>
    Without the "CookieFilter" in the "OutgoingChain"
    the cookie set in the login page response would not get set in the browser
    since that request is intercepted before it gets to the browser.
    The simplest way to deal with this situation is
    to let OpenIG manage all the cookies
    by enabling the "CookieFilter".
    The side effect of OpenIG managing cookies is
    none of the cookies are sent to the browser,
    but are managed locally by OpenIG.
   </p></div><div class="informalexample"><pre class="brush: javascript;">
{
    "heap": [
        {
            "name": "DispatchHandler",
            "type": "DispatchHandler",
            "config": {
                "bindings": [
                    {
                        "handler": {
                            "type": "Chain",
                            "config": {
                                "filters": [
                                    "IsLoginPage",
                                    {
                                        "type": "EntityExtractFilter",
                                        "config": {
                                            "messageType": "response",
                                            "target": "${exchange.isLoginPage}",
                                            "bindings": [
                                                {
                                                    "key": "found",
                                                    "pattern": "OpenAM\s\(Login\)",
                                                    "template": "true"
                                                }
                                            ]
                                        }
                                    }
                                ],
                                "handler": "OutgoingChain"
                            }
                        },
                        "baseURI": "http://TARGETIP:PORT"
                    }
                ]
            }
        },
        {
            "name": "IsLoginPage",
            "type": "SwitchFilter",
            "config": {
                "onResponse": [
                    {
                        "condition": "${exchange.isLoginPage.found == 'true'}",
                        "handler": {
                            "type": "Chain",
                            "config": {
                                "filters": [
                                    {
                                        "type": "StaticRequestFilter",
                                        "config": {
                                            "method": "POST",
                                            "uri":
                                                "http://TARGETIP:PORT/openam/UI/Login",
                                            "form": {
                                                "IDToken0": [
                                                    ""
                                                ],
                                                "IDToken1": [
                                                    "MY_USERNAME"
                                                ],
                                                "IDToken2": [
                                                    "MY_PASSWORD"
                                                ],
                                                "IDButton": [
                                                    "Log+In"
                                                ],
                                                "encoded": [
                                                    "false"
                                                ]
                                            },
                                            "headers": {
                                                "host": [
                                                    "TARGETFQDN:PORT"
                                                ]
                                            }
                                        }
                                    }
                                ],
                                "handler": "OutgoingChain"
                            }
                        }
                    }
                ]
            }
        },
        {
            "name": "OutgoingChain",
            "type": "Chain",
            "config": {
                "filters": [
                    {
                        "type": "CookieFilter"
                    }
                ],
                "handler": {
                    "type": "ClientHandler"
                }
            }
        }
    ],
    "handler": "DispatchHandler"
}
   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of OpenAM,
   <code class="literal">TARGETFQDN</code> with the fully qualified domain name of OpenAM,
   and <code class="literal">PORT</code> with the port on which OpenAM listens.
   Also change <code class="literal">MY_USERNAME</code> and <code class="literal">MY_PASSWORD</code>
   to match those of your OpenAM user.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-hidden-value"></a>10.5.&nbsp;Login Which Requires a Hidden Value From the Login Page</h2></div></div></div><a class="indexterm" name="d1182e4180"></a><p>
   Extracts a hidden value from the login page
   and includes it in the login form POSTed to the target application.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${exchange.request.uri.path == '/login'}",
                    "handler": {
                        "name": "LoginChain",
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "EntityExtractFilter",
                                    "config": {
                                        "messageType": "response",
                                        "target": "${exchange.hiddenValue}",
                                        "bindings": [
                                            {
                                                "key": "value",
                                                "pattern":
                                                    "wpLoginToken\"\s.*value=\"(.*)\"",
                                                "template": "$1"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "https://TARGETIP/login",
                                        "form": {
                                            "USER": [
                                                "MY_USERNAME"
                                            ],
                                            "PASSWORD": [
                                                "MY_PASSWORD"
                                            ],
                                            "hiddenValue": [
                                                "${exchange.hiddenValue.value}"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://TARGETIP"
                },
                {
                    "handler": "ClientHandler",
                    "baseURI": "http://TARGETIP"
                }
            ]
        }
    }
}

   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of your application.
   Also change <code class="literal">MY_USERNAME</code> and <code class="literal">MY_PASSWORD</code>,
   and adapt the "StaticRequestFilter" for your application.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-http-and-https"></a>10.6.&nbsp;HTTP &amp; HTTPS Application</h2></div></div></div><a class="indexterm" name="d1182e4211"></a><p>
   Proxies traffic to an application listening on ports 80 and 443.
   The assumption is the application uses HTTPS for authentication
   and HTTP for the general application features.
   Assuming all login requests go to port 443,
   you must add the login filters and handlers to the "Chain".
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${exchange.request.uri.scheme == 'http'}",
                    "handler": "ClientHandler",
                    "baseURI": "http://TARGETIP"
                },
                {
                    "condition": "${exchange.request.uri.path == '/login'}",
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                "MY_FILTERS"
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "https://TARGETIP"
                },
                {
                    "handler": "ClientHandler",
                    "baseURI": "https://TARGETIP"
                }
            ]
        }
    }
}

   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of your application.
   Also add the necessary filter configurations
   that are required for login with your application,
   and then change <code class="literal">MY_FILTERS</code> to identify the added filters.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-am-integration-headers"></a>10.7.&nbsp;OpenAM Integration With Headers</h2></div></div></div><p>
   Logs the user into the target application
   using the headers passed down from an OpenAM policy agent.
   This template assumes the user name and password
   are passed down by the OpenAM policy agent as headers.
   If the header passed in contains only a user name or subject
   and requires a lookup to an external data source,
   you must add an attribute filter to the chain to retrieve the credentials.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${exchange.request.uri.path == '/login'}",
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "https://TARGETIP/login",
                                        "form": {
                                            "USER": [
                                                "${exchange.request.headers['username'][0]}"
                                            ],
                                            "PASSWORD": [
                                                "${exchange.request.headers['password'][0]}"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://TARGETIP"
                },
                {
                    "handler": "ClientHandler",
                    "baseURI": "http://TARGETIP"
                }
            ]
        }
    }
}

   </pre></div><p>
   This template is a replacement for the default route,
   <code class="filename">$HOME/.openig/config/routes/99-default.json</code>,
   Substitute <code class="literal">TARGETIP</code> with the IP address of your application.
   Also adapt the "StaticRequestFilter" for your application.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-owa-online"></a>10.8.&nbsp;Microsoft Online Outlook Web Access</h2></div></div></div><a class="indexterm" name="d1182e4259"></a><p>
   Logs the user into Microsoft Online Outlook Web Access (OWA).
   This template shows how you would use OpenIG
   and the OpenAM password capture feature to integrate with OWA.
   You can follow the chapter on
   <a href="../gateway-guide/index.html#chap-password-capture-replay-tutorial" class="link"><em class="citetitle">Getting Login Credentials From OpenAM</em></a>,
   and substitute this template as a replacement for the default route.
  </p><div class="informalexample"><pre class="brush: javascript;">
{
  "heap": [
    {
      "name": "DispatchHandler",
      "type": "DispatchHandler",
      "config": {
        "bindings": [
          {
            "condition": "${exchange.request.uri.path == '/owa/auth/logon.aspx'}",
            "handler": {
              "type": "Chain",
              "config": {
                "filters": [
                  {
                    "type": "CryptoHeaderFilter",
                    "config": {
                      "messageType": "REQUEST",
                      "operation": "DECRYPT",
                      "algorithm": "DES/ECB/NoPadding",
                      "key": "DESKEY",
                      "keyType": "DES",
                      "charSet": "utf-8",
                      "headers": [
                        "password"
                      ]
                    }
                  },
                  {
                    "type": "StaticRequestFilter",
                    "config": {
                      "method": "POST",
                      "uri": "https://65.55.171.158/owa/auth/owaauth.dll",
                      "headers": {
                        "Host": [
                          "red001.mail.microsoftonline.com"
                        ],
                        "Content-Type": [
                          "Content-Type:application/x-www-form-urlencoded"
                        ]
                      },
                      "form": {
                        "destination": [
                          "https://red001.mail.microsoftonline.com/owa/"
                        ],
                        "forcedownlevel": [
                          "0"
                        ],
                        "trusted": [
                          "0"
                        ],
                        "username": [
                          "${exchange.request.headers['username'][0]}"
                        ],
                        "password": [
                          "${exchange.request.headers['password'][0]}"
                        ],
                        "isUtf8": [
                          "1"
                        ]
                      }
                    }
                  }
                ],
                "handler": "OutgoingChain"
              }
            },
            "baseURI": "https://65.55.171.158"
          },
          {
            "handler": "OutgoingChain",
            "baseURI": "https://65.55.171.158"
          }
        ]
      }
    },
    {
      "name": "OutgoingChain",
      "type": "Chain",
      "config": {
        "filters": [
          {
            "type": "HeaderFilter",
            "config": {
              "messageType": "REQUEST",
              "remove": [
                "password",
                "username"
              ]
            }
          }
        ],
        "handler": {
          "type": "ClientHandler"
        }
      }
    }
  ],
  "handler": "DispatchHandler"
}

   </pre></div><p>
   Change <code class="literal">DESKEY</code> to the actual key value
   that you generated when following the instructions in
   <a href="../gateway-guide/index.html#password-capture-configuration" class="link">Configuring Password Capture</a>.
   This template references a "ClientHandler"
   defined in <code class="filename">config.json</code>.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-extending"></a>Chapter&nbsp;11.&nbsp;Extending OpenIG</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-scripting">11.1. About Scripting</a></span></dt><dt><span class="section"><a href="#scripting-dispatch">11.2. Scripting Dispatch</a></span></dt><dt><span class="section"><a href="#scripting-http-basic">11.3. Scripting HTTP Basic Authentication</a></span></dt><dt><span class="section"><a href="#scripting-ldap-auth">11.4. Scripting LDAP Authentication</a></span></dt><dt><span class="section"><a href="#scripting-sql">11.5. Scripting SQL Queries</a></span></dt><dt><span class="section"><a href="#about-custom-extensions">11.6. About Developing Custom Extensions</a></span></dt><dt><span class="section"><a href="#extension-points">11.7. Key Extension Points</a></span></dt><dt><span class="section"><a href="#custom-filter">11.8. Implementing a Filter</a></span></dt><dt><span class="section"><a href="#custom-handler">11.9. Implementing a Handler</a></span></dt><dt><span class="section"><a href="#custom-heap-config">11.10. Heap Object Configuration</a></span></dt><dt><span class="section"><a href="#custom-sample-filter">11.11. Sample Filter</a></span></dt><dt><span class="section"><a href="#custom-build">11.12. Building Customizations</a></span></dt><dt><span class="section"><a href="#custom-embed">11.13. Embedding Customizations in OpenIG</a></span></dt></dl></div><p>
  This chapter looks at extending what OpenIG can do
  beyond what you get out of the box.
 </p><p>
  To extend what you can do with Filters and Handlers,
  OpenIG supports dynamic scripting languages like Groovy
  through the use of <code class="literal">ScriptableFilter</code>
  and <code class="literal">ScriptableHandler</code> objects.
 </p><p>
  If scripting is not enough, be aware that
  OpenIG includes a complete
  <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html" target="_blank">application programming interface</a>,
  designed to allow you to customize OpenIG as required.
  Customizing OpenIG can be used to perform complex server interactions
  or intensive data transformations
  that you cannot achieve with scripts or existing handlers, filters and
  <a href="../reference/index.html#Expressions" class="link">expressions</a>.
 </p><p>
  Interface Stability:
  <a href="../reference/index.html#interface-stability" class="link">Evolving</a>
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-scripting"></a>11.1.&nbsp;About Scripting</h2></div></div></div><p>
   You add these Filters and Handlers to your configuration in the same way
   as for other Filters and Handlers.
   Each takes as its configuration the script's Internet media "type"
   and either a "source" script included in the JSON configuration,
   or a "file" script that OpenIG reads from a file.
   The configuration can also optionally supply "args"
   in order to pass parameters to the script.
  </p><p>
   The following example defines a <code class="literal">ScriptableFilter</code>,
   written in the Groovy language,
   and stored in a file named
   <code class="filename">$HOME/.openig/scripts/groovy/SimpleFormLogin.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\SimpleFormLogin.groovy</code> on Windows).
  </p><pre class="brush: java;">
 {
     "name": "SimpleFormLogin",
     "type": "ScriptableFilter",
     "config": {
         "type": "application/x-groovy",
         "file": "SimpleFormLogin.groovy"
     }
 }
  </pre><p>
   Relative paths in the "file" field depend on how OpenIG is installed.
   If OpenIG is installed in an application server,
   then paths for Groovy scripts are relative to
   <code class="filename">$HOME/.openig/scripts/groovy</code>.
  </p><p>
   This base location <code class="filename">$HOME/.openig/scripts/groovy</code>
   is on the classpath when the scripts are executed.
   If therefore some Groovy scripts are not in the default package,
   but instead have their own package names,
   they belong in the directory corresponding to their package name.
   For example, a script in package <code class="literal">com.example.groovy</code>
   belongs under <code class="filename">$HOME/.openig/scripts/groovy/com/example/groovy/</code>.
  </p><p>
   OpenIG provides scripts with several global variables at run time,
   enabling them to access the Exchange,
   to store variables across executions,
   to write messages to the logs,
   and to make requests to a web service or to an LDAP directory service,
   in addition to Groovy's built-in functionality.
   For details, see the reference documentation for
   <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>
   and
   <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a>.
  </p><p>
   This chapter demonstrates some of what you might do using scripts.
  </p><p>
   If you want to try these scripts,
   first install and configure OpenIG as described in the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   When developing and debugging your scripts, consider configuring a
   <a href="../reference/index.html#CaptureDecorator" class="link"><em class="citetitle">CaptureDecorator</em></a>
   to log requests, responses, and the exchange data in JSON form.
   You can then turn off capturing when you move to production.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-dispatch"></a>11.2.&nbsp;Scripting Dispatch</h2></div></div></div><p>
   In order to route requests, especially when the conditions are complicated,
   you can use a <code class="literal">ScriptableHandler</code> instead of a
   <a href="../reference/index.html#DispatchHandler" class="link">DispatchHandler</a>.
  </p><p>
   The following script demonstrates a simple dispatch handler.
  </p><pre class="brush: java;">
import org.forgerock.openig.http.Response

/*
 * This simplistic dispatcher matches the path part of the HTTP request.
 * If the path is /login, it checks Username and Password headers,
 * accepting bjensen:hifalutin, and returning HTTP 403 Forbidden to others.
 * Otherwise it returns HTTP 401 Unauthorized.
 */

// Rather than get the response from an external source,
// this handler produces the response itself.
exchange.response = new Response();

switch (exchange.request.uri.path) {

    case "/login":

        if (exchange.request.headers.Username[0] == "bjensen" &amp;&amp;
                exchange.request.headers.Password[0] == "hifalutin") {

            exchange.response.status = 200
            exchange.response.entity = "&lt;html&gt;&lt;p&gt;Welcome back, Babs!&lt;/p&gt;&lt;/html&gt;"

        } else {

            exchange.response.status = 403
            exchange.response.entity = "&lt;html&gt;&lt;p&gt;Authorization required&lt;/p&gt;&lt;/html&gt;"

        }

        break

    default:

        exchange.response.status = 401
        exchange.response.entity = "&lt;html&gt;&lt;p&gt;Please &lt;a href='./login'&gt;log in&lt;/a&gt;.&lt;/p&gt;&lt;/html&gt;"

        break

}

  </pre><p>
   To try this handler, save the script
   as <code class="filename">$HOME/.openig/scripts/groovy/DispatchHandler.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\DispatchHandler.groovy</code> on Windows).
  </p><p>
   Next, add the following route to your configuration
   as <code class="filename">$HOME/.openig/config/routes/98-dispatch.json</code>
   (<code class="filename">%appdata%\OpenIG\config\routes\98-dispatch.json</code> on Windows).
  </p><pre class="brush: javascript;">
{
    "heap": [
        {
            "name": "DispatchHandler",
            "type": "DispatchHandler",
            "config": {
                "bindings": [
                    {
                        "condition":
                            "${matches(exchange.request.uri.path, '^/login')}",
                        "handler": {
                            "type": "Chain",
                            "config": {
                                "filters": [
                                    {
                                        "type": "HeaderFilter",
                                        "config": {
                                            "messageType": "REQUEST",
                                            "add": {
                                                "Username": [
                                                    "bjensen"
                                                ],
                                                "Password": [
                                                    "hifalutin"
                                                ]
                                            }
                                        }
                                    }
                                ],
                                "handler": "Dispatcher"
                            }
                        }
                    },
                    {
                        "handler": "Dispatcher"
                    }
                ]
            }
        },
        {
            "name": "Dispatcher",
            "type": "ScriptableHandler",
            "config": {
                "type": "application/x-groovy",
                "file": "DispatchHandler.groovy"
            }
        }
    ],
    "handler": "DispatchHandler"
}

  </pre><p>
   The route sets up the headers required by the script when the user logs in.
  </p><p>
   To try it out, browse to
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
  </p><p>
   The response from the script says <code class="literal">Please
   <a class="link" href="http://www.example.com:8080/login" target="_blank">log in</a>.</code>
   When you click the "log in" link,
   the "HeaderFilter" sets Username and Password headers in the request,
   and passes the request to the script.
  </p><p>
   The script then responds, <code class="literal">Welcome back, Babs!</code>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-http-basic"></a>11.3.&nbsp;Scripting HTTP Basic Authentication</h2></div></div></div><p>
   HTTP Basic authentication calls for the user agent such as a browser
   to send a user name and password to the server in an Authorization header.
   HTTP Basic authentication relies on an encrypted connection
   to protect the user name and password credentials,
   which are base64-encoded in the Authorization header, not encrypted.
  </p><p>
   The following script, for use in a <code class="literal">ScriptableFilter</code>,
   adds an Authorization header based on a username and password combination.
  </p><pre class="brush: java;">
/*
 * Perform basic authentication with the user name and password
 * that are supplied using a configuration like the following:
 *
 * {
 *     "name": "BasicAuth",
 *     "type": "ScriptableFilter",
 *     "config": {
 *         "type": "application/x-groovy",
 *         "file": "BasicAuthFilter.groovy",
 *         "args": {
 *             "username": "bjensen",
 *             "password": "hifalutin"
 *             }
 *         }
 * }
 */

def userPass = username + ":" + password
def base64UserPass = userPass.getBytes().encodeBase64()
exchange.request.headers.add("Authorization", "Basic ${base64UserPass}" as String)

// Credentials are only base64-encoded, not encrypted: Set scheme to HTTPS.

/*
 * When connecting over HTTPS, by default the client tries to trust the server.
 * If the server has no certificate
 * or has a self-signed certificate unknown to the client,
 * then the most likely result is an SSLPeerUnverifiedException.
 *
 * To avoid an SSLPeerUnverifiedException,
 * set up HTTPS correctly on the server.
 * Either use a server certificate signed by a well-known CA,
 * or set up the gateway to trust the server certificate.
 */
exchange.request.uri.scheme = "https"

// Call the next handler. This returns when the request has been handled.
next.handle(exchange)

  </pre><p>
   To try this filter, save the script
   as <code class="filename">$HOME/.openig/scripts/groovy/BasicAuthFilter.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\BasicAuthFilter.groovy</code> on Windows).
  </p><p>
   Next, add the following route to your configuration
   as <code class="filename">$HOME/.openig/config/routes/09-basic.json</code>
   (<code class="filename">%appdata%\OpenIG\config\routes\09-basic.json</code> on Windows).
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "ScriptableFilter",
                    "config": {
                        "type": "application/x-groovy",
                        "file": "BasicAuthFilter.groovy",
                        "args": {
                            "username": "bjensen",
                            "password": "hifalutin"
                        }
                    },
                    "capture": "filtered_request"
                }
            ],
            "handler": {
                "type": "StaticResponseHandler",
                "config": {
                    "status": 200,
                    "reason": "OK",
                    "entity": "Hello, Babs!"
                }
            }
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/basic')}"
}

  </pre><p>
   When the request path matches <code class="literal">/basic</code>
   the route calls the "Chain",
   which runs the "ScriptableFilter".
   The "capture" setting captures the request
   as updated by the "ScriptableFilter".
   Finally, OpenIG returns a static page.
  </p><p>
   To try it out, browse to
   <a class="link" href="http://www.example.com:8080/basic" target="_blank">http://www.example.com:8080/basic</a>.
  </p><p>
   The captured request in the console log
   shows that the "scheme" is now HTTPS,
   and that the "Authorization" header is set for HTTP Basic.
  </p><pre class="brush: http;">
GET https://www.example.com:8080/basic HTTP/1.1
Authorization: Basic YmplbnNlbjpoaWZhbHV0aW4=
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-ldap-auth"></a>11.4.&nbsp;Scripting LDAP Authentication</h2></div></div></div><p>
   Many organizations use an LDAP directory service to store user profiles
   including authentication credentials.
   The LDAP directory service securely stores user passwords
   in a highly-available, central service capable of
   handling thousands of authentications per second.
  </p><p>
   The following script, for use in a <code class="literal">ScriptableFilter</code>,
   performs simple authentication against an LDAP server
   based on request form fields
   <code class="literal">username</code> and <code class="literal">password</code>.
  </p><pre class="brush: java;">
import org.forgerock.opendj.ldap.*
import org.forgerock.openig.http.Response

/*
 * Perform LDAP authentication based on user credentials from a form.
 *
 * If LDAP authentication succeeds, then call the next handler.
 * If there is a failure, send a response back to the user.
 */

username = exchange.request.form?.username[0]
password = exchange.request.form?.password[0]

// For testing purposes, the LDAP host and port are provided in the exchange.
// Edit as needed to match your directory service.
host = exchange.ldapHost ?: "localhost"
port = exchange.ldapPort ?: 1389

client = ldap.connect(host, port as Integer)
try {

    // Assume the username is an exact match of either
    // the user ID, the email address, or the user's full name.
    filter = "(|(uid=%s)(mail=%s)(cn=%s))"

    user = client.searchSingleEntry(
            "ou=people,dc=example,dc=com",
            ldap.scope.sub,
            ldap.filter(filter, username, username, username))

    client.bind(user.name as String, password?.toCharArray())

    // Authentication succeeded.

    // Set a header (or whatever else you want to do here).
    exchange.request.headers.add("Ldap-User-Dn", user.name)

    // Most LDAP attributes are multi-valued.
    // When you read multi-valued attributes, use the parse() method,
    // with an AttributeParser method
    // that specifies the type of object to return.
    exchange.cn = user.cn?.parse().asSetOfString()

    // When you write attribute values, set them directly.
    user.description = "New description set by my script"

    // Here is how you might read a single value of a multi-valued attribute:
    exchange.description = user.description?.parse().asString()

    // Call the next handler. This returns when the request has been handled.
    next.handle(exchange)

} catch (AuthenticationException e) {

    // LDAP authentication failed, so fail the exchange with
    // HTTP status code 403 Forbidden.

    exchange.response = new Response()
    exchange.response.status = 403
    exchange.response.reason = e.message
    exchange.response.entity = "&lt;html&gt;&lt;p&gt;Authentication failed: " + e.message + "&lt;/p&gt;&lt;/html&gt;"

} catch (Exception e) {

    // Something other than authentication failed on the server side,
    // so fail the exchange with HTTP 500 Internal Server Error.

    exchange.response = new Response()
    exchange.response.status = 500
    exchange.response.reason = e.message
    exchange.response.entity = "&lt;html&gt;&lt;p&gt;Server error: " + e.message + "&lt;/p&gt;&lt;/html&gt;"

} finally {
    client.close()
}

  </pre><p>
   For the list of methods to specify which type of objects to return,
   see the OpenDJ LDAP SDK Javadoc for
   <a class="link" href="http://docs.forgerock.org/en/opendj/2.6.9/apidocs/index.html?org/forgerock/opendj/ldap/AttributeParser.html" target="_blank">AttributeParser</a>.
  </p><p>
   To try this out, first install an LDAP directory server such as
   <a class="link" href="http://opendj.forgerock.org/" target="_blank">OpenDJ</a>.
   Also import some sample users who can authenticate over LDAP.
   With OpenDJ, you can generate sample users at installation time.
  </p><p>
   Next, save the script
   as <code class="filename">$HOME/.openig/scripts/groovy/LdapAuthFilter.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\LdapAuthFilter.groovy</code> on Windows).
   If the directory server installation does not match
   the assumptions made in the script,
   adjust the script to use the correct settings for your installation.
  </p><p>
   Finally, add the following route to your configuration
   as <code class="filename">$HOME/.openig/config/routes/10-ldap.json</code>
   (<code class="filename">%appdata%\OpenIG\config\routes\10-ldap.json</code> on Windows).
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "ScriptableFilter",
                    "config": {
                        "type": "application/x-groovy",
                        "file": "LdapAuthFilter.groovy"
                    }
                }
            ],
            "handler": {
                "type": "ScriptableHandler",
                "config": {
                    "type": "application/x-groovy",
                    "source":
                        "import org.forgerock.openig.http.Response;
                         dn = exchange.request.headers['Ldap-User-Dn'][0];
                         entity = '&lt;html&gt;&lt;p&gt;Ldap-User-Dn: ' + dn + '&lt;/p&gt;&lt;/html&gt;';

                         exchange.response = new Response();
                         exchange.response.status = 200;
                         exchange.response.entity = entity;"
                }
            }
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/ldap')}"
}
  </pre><p>
   The route calls the "LdapAuthFilter.groovy" script
   to authenticate the user over LDAP.
   On successful authentication, it responds with the the bind DN.
  </p><p>
   To try it out, browse to a URL
   where query string parameters specify a valid username and password, such as
   <a class="link" href="http://www.example.com:8080/ldap?username=user.0&amp;password=password" target="_blank">http://www.example.com:8080/ldap?username=user.0&amp;password=password</a>.
  </p><p>
   The response from the script shows the DN:
   <code class="literal">Ldap-User-Dn: uid=user.0,ou=People,dc=example,dc=com</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-sql"></a>11.5.&nbsp;Scripting SQL Queries</h2></div></div></div><p>
   You can use a <code class="literal">ScriptableFilter</code>
   to look up information in a relational database
   and include the results in the Exchange.
  </p><p>
   The following filter looks up user credentials in a database
   given the user's email address,
   which is found in the form data of the request.
   The script then sets the credentials in headers,
   making sure the scheme is HTTPS to protect the request
   when it leaves OpenIG.
  </p><pre class="brush: java;">
/*
 * Look up user credentials in a relational database
 * based on the user's email address provided in the request form data,
 * and set the credentials in the exchange headers for the next handler.
 */

def client = new SqlClient()
def credentials = client.getCredentials(exchange.request.form?.mail[0])
exchange.request.headers.add("Username", credentials.Username)
exchange.request.headers.add("Password", credentials.Password)

// The credentials are not protected in the headers, so use HTTPS.
exchange.request.uri.scheme = "https"

// Call the next handler. This returns when the request has been handled.
next.handle(exchange)

  </pre><p>
   The previous script demonstrates a <code class="literal">ScriptableFilter</code>
   that uses a <code class="literal">SqlClient</code> class defined in another script.
   The following code listing shows the <code class="literal">SqlClient</code> class.
  </p><pre class="brush: java;">
import groovy.sql.Sql

import javax.naming.InitialContext
import javax.sql.DataSource

/**
 * Access a database with a well-known structure,
 * in particular to get credentials given an email address.
 */
class SqlClient {

    // Get a DataSource from the container.
    InitialContext context = new InitialContext()
    DataSource dataSource = context.lookup("jdbc/forgerock") as DataSource
    def sql = new Sql(dataSource)

    // The expected table is laid out like the following.

    // Table USERS
    // ----------------------------------------
    // | USERNAME  | PASSWORD |   EMAIL   |...|
    // ----------------------------------------
    // | &lt;username&gt;| &lt;passwd&gt; | &lt;mail@...&gt;|...|
    // ----------------------------------------

    String tableName = "USERS"
    String usernameColumn = "USERNAME"
    String passwordColumn = "PASSWORD"
    String mailColumn = "EMAIL"

    /**
     * Get the Username and Password given an email address.
     *
     * @param mail Email address used to look up the credentials
     * @return Username and Password from the database
     */
    def getCredentials(mail) {
        def credentials = [:]
        def query = "SELECT " + usernameColumn + ", " + passwordColumn +
                " FROM " + tableName + " WHERE " + mailColumn + "='$mail';"

        sql.eachRow(query) {
            credentials.put("Username", it."$usernameColumn")
            credentials.put("Password", it."$passwordColumn")
        }
        return credentials
    }
}

  </pre><p>
   To try this out, first follow the tutorial on
   <a href="../gateway-guide/index.html#tutorial-credentials-from-sql" class="link"><em class="citetitle">Login With Credentials From a Database</em></a>.
   When everything in that tutorial works,
   you know that OpenIG can connect to the database,
   lookup users by email address,
   and successfully authenticate to the sample application.
  </p><p>
   Next, save the scripts
   as <code class="filename">$HOME/.openig/scripts/groovy/SqlAccessFilter.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\SqlAccessFilter.groovy</code> on Windows),
   and as <code class="filename">$HOME/.openig/scripts/groovy/SqlClient.groovy</code>
   (<code class="filename">%appdata%\OpenIG\scripts\groovy\SqlClient.groovy</code> on Windows).
  </p><p>
   Finally, add the following route to your configuration
   as <code class="filename">$HOME/.openig/config/routes/11-db.json</code>
   (<code class="filename">%appdata%\OpenIG\config\routes\11-db.json</code> on Windows).
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "ScriptableFilter",
                    "config": {
                        "type": "application/x-groovy",
                        "file": "SqlAccessFilter.groovy"
                    }
                },
                {
                    "type": "StaticRequestFilter",
                    "config": {
                        "method": "POST",
                        "uri": "http://www.example.com:8081",
                        "form": {
                            "username": [
                                "${exchange.request.headers['Username'][0]}"
                            ],
                            "password": [
                                "${exchange.request.headers['Password'][0]}"
                            ]
                        }
                    }
                }
            ],
            "handler": "ClientHandler"
        }
    },
    "condition": "${matches(exchange.request.uri.path, '^/db')}"
}

  </pre><p>
   The route calls the "ScriptableFilter" to look up credentials over SQL.
   It then uses calls a "StaticRequestFilter" to build a login request.
   Although the script sets the scheme to HTTPS,
   the "StaticRequestFilter" ignores that and resets the URI.
   This is to make it easier for you to try this out,
   without having to worry about setting up HTTPS.
  </p><p>
   To try it out, browse to a URL
   where a query string parameter specifies a valid email address, such as
   <a class="link" href="http://www.example.com:8080/db?mail=george@example.com" target="_blank">http://www.example.com:8080/db?mail=george@example.com</a>.
  </p><p>
   If the lookup and authentication are successful,
   you see the profile page of the sample application.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-custom-extensions"></a>11.6.&nbsp;About Developing Custom Extensions</h2></div></div></div><p>
   If scripting is not enough, be aware that
   OpenIG includes a complete Java
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html" target="_blank">application programming interface</a>,
   designed to allow you to customize OpenIG as required.
   Customizing OpenIG can be used to perform complex server interactions
   or intensive data transformations
   that you cannot achieve with scripts or existing handlers, filters and
   <a href="../reference/index.html#Expressions" class="link">expressions</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extension-points"></a>11.7.&nbsp;Key Extension Points</h2></div></div></div><a class="indexterm" name="d1182e4597"></a><div class="variablelist"><p>
    Primary extension points include these interfaces.
   </p><dl class="variablelist"><dt><span class="term"><a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/audit/AuditEventListener.html" target="_blank">AuditEventListener</a></span></dt><dd><p>
      An AuditEventListener observes audit events.
      For an example, see
      <a href="../reference/index.html#MonitorEndpointHandler" class="link">MonitorEndpointHandler</a>.
     </p><p>
      You must implement the interface for your audit agent
      and its heaplet must extend
      <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/audit/ConditionalAuditEventListener.ConditionalListenerHeaplet.html" target="_blank">ConditionalAuditEventListener.ConditionalListenerHeaplet</a>.
     </p></dd><dt><span class="term"><a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/decoration/Decorator.html" target="_blank">Decorator</a></span></dt><dd><p>
      A Decorator adds new behavior to another object,
      without changing the base type of the object.
     </p><p>
      When suggesting custom Decorator names,
      know that OpenIG reserves all field names
      that use only alphanumeric characters.
      To avoid clashes, use dots or dashes in your field names,
      such as "my-decorator".
     </p></dd><dt><span class="term"><a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/filter/Filter.html" target="_blank">Filter</a></span></dt><dd><p>
      A Filter serves to process the request and/or the response.
     </p></dd><dt><span class="term"><a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/handler/Handler.html" target="_blank">Handler</a></span></dt><dd><p>
      A Handler generates a response given a request.
     </p></dd></dl></div><p>
   These Filter and Handler interfaces are similar to Java Enterprise Edition
   <code class="literal">Filter</code> and <code class="literal">Servlet</code> interfaces,
   with some differences in the semantics of messages.
   While you can simply implement these interfaces,
   OpenIG also provides convenience classes:
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/filter/GenericFilter.html" target="_blank">GenericFilter</a> and
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/handler/GenericHandler.html" target="_blank">GenericHandler</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-filter"></a>11.8.&nbsp;Implementing a Filter</h2></div></div></div><a class="indexterm" name="d1182e4660"></a><p>
   The <code class="literal">Filter</code> interface exposes a
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/filter/Filter.html#filter(org.forgerock.openig.http.Exchange,%20org.forgerock.openig.handler.Handler)" target="_blank">filter()</a> method,
   which takes an
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html" target="_blank">Exchange</a> object
   and the
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/filter/Chain.html" target="_blank">Chain</a> of remaining filters and handler to dispatch to.
   Initially,
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html#request" target="_blank">exchange.request</a> contains the request to be filtered.
   To pass the request to the next filter or handler in the chain,
   the filter calls
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/filter/Chain.html#handle(org.forgerock.openig.http.Exchange)" target="_blank">next.handle(exchange)</a>.
   After this call,
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html#response" target="_blank">exchange.response</a> contains the response that can be filtered.
  </p><p>
   A filter might elect not to pass the request to the next filter or handler,
   and instead handle the request itself.
   It can achieve this by merely avoiding a call
   to <code class="literal">next.handle(exchange)</code>
   and creating its own response object in the exchange.
   The filter is also at liberty to replace a response with another of its own.
   A filter can exist in more than one chain,
   therefore should make no assumptions or correlations
   using the chain it is supplied.
   The only valid use of a chain by a filter is to call its
   <code class="literal">handle()</code> method to dispatch the exchange
   to the rest of the chain.
  </p><div class="note"><h3 class="title">Note</h3><p>
    If an existing response exists in the exchange object
    and the filter intends to replace it with its own,
    it must call the
    <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Message.html#close()" target="_blank">response.close()</a> method in order to signal
    that the processing of the response from a remote server is complete.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-handler"></a>11.9.&nbsp;Implementing a Handler</h2></div></div></div><a class="indexterm" name="d1182e4705"></a><p>
   The <code class="literal">Handler</code> interface exposes a
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/handler/Handler.html#handle(org.forgerock.openig.http.Exchange)" target="_blank">handle()</a> method,
   which takes an
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html#response" target="_blank">Exchange</a> object.
   It processes the request in
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html#request" target="_blank">exchange.request</a> and produces a response in
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Exchange.html#response" target="_blank">exchange.response</a>.
   A handler can elect to dispatch the exchange to another handler or chain.
  </p><div class="note"><h3 class="title">Note</h3><p>
    If an existing response exists in the exchange object
    and the filter intends to replace it with its own,
    it must first check to see if the
    it must call the
    <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/http/Message.html#close()" target="_blank">response.close()</a> method in order to signal
    that the processing of the response from a remote server is complete.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-heap-config"></a>11.10.&nbsp;Heap Object Configuration</h2></div></div></div><a class="indexterm" name="d1182e4736"></a><p>
   Objects are added to the heap and supplied with configuration artifacts
   at initialization time. To be integrated with the configuration, a class must
   have an accompanying implementation of the
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/heap/Heaplet.html" target="_blank">Heaplet</a> interface. The easiest and most common way of exposing the
   heaplet is to extend the
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/heap/GenericHeaplet.html" target="_blank">GenericHeaplet</a> class
   in a nested class of the class you want to create and initialize,
   overriding the heaplet's
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/heap/GenericHeaplet.html#create()" target="_blank">create</a> method.
  </p><p>
   Within the <code class="literal">create</code> method,
   you can access the object's configuration through the
   <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/org/forgerock/openig/heap/GenericHeaplet.html#config" target="_blank">config</a> field.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-sample-filter"></a>11.11.&nbsp;Sample Filter</h2></div></div></div><p>
   The following sample filter sets an arbitrary header
   in the incoming request and outgoing response.
  </p><pre class="brush: java;">package org.forgerock.openig.doc;

import org.forgerock.openig.filter.GenericFilter;
import org.forgerock.openig.handler.Handler;
import org.forgerock.openig.handler.HandlerException;
import org.forgerock.openig.heap.GenericHeaplet;
import org.forgerock.openig.heap.HeapException;
import org.forgerock.openig.http.Exchange;

import java.io.IOException;

/**
 * Filter to set a header in the incoming request and in the outgoing response.
 */
public class SampleFilter extends GenericFilter {

    /** Header name. */
    String name;

    /** Header value. */
    String value;

    /**
     * Set a header in the incoming request and in the outgoing response.
     * A configuration example looks something like the following.
     *
     * &lt;pre&gt;
     * {
     *     "name": "SampleFilter",
     *     "type": "SampleFilter",
     *     "config": {
     *         "name": "X-Greeting",
     *         "value": "Hello world"
     *     }
     * }
     * &lt;/pre&gt;
     *
     * @param exchange          Wraps request and response.
     * @param next              Next filter or handler in the chain.
     * @throws HandlerException Failure when handling the exchange.
     * @throws IOException      I/O exception when handling the exchange.
     */
    @Override
    public void filter(Exchange exchange, Handler next)
            throws HandlerException, IOException {

        // Set header in the request.
        exchange.request.getHeaders().putSingle(name, value);

        // Pass to the next filter or handler in the chain.
        next.handle(exchange);

        // Set header in the response.
        exchange.response.getHeaders().putSingle(name, value);
    }

    /**
     * Create and initialize the filter, based on the configuration.
     * The filter object is stored in the heap.
     */
    public static class Heaplet extends GenericHeaplet {

        /**
         * Create the filter object in the heap,
         * setting the header name and value for the filter,
         * based on the configuration.
         *
         * @return                  The filter object.
         * @throws HeapException    Failed to create the object.
         */
        @Override
        public Object create() throws HeapException {

            SampleFilter filter = new SampleFilter();
            filter.name  = config.get("name").required().asString();
            filter.value = config.get("value").required().asString();

            return filter;
        }
    }
}</pre><p>
   When you set the sample filter "type" in the configuration,
   you need to provide the fully qualified class name,
   as in <code class="literal">"type": "org.forgerock.openig.doc.SampleFilter"</code>.
   You can however implement a class alias resolver
   to make it possible to use a short name instead,
   as in <code class="literal">"type": "SampleFilter"</code>.
  </p><pre class="brush: java;">package org.forgerock.openig.doc;

import org.forgerock.openig.alias.ClassAliasResolver;

import java.util.HashMap;
import java.util.Map;

/**
 * Allow use of short name aliases in configuration object types.
 *
 * This allows a configuration with {@code "type": "SampleFilter"}
 * instead of {@code "type": "org.forgerock.openig.doc.SampleFilter"}.
 */
public class SampleClassAliasResolver implements ClassAliasResolver {

    private static final Map&lt;String, Class&lt;?&gt;&gt; ALIASES =
            new HashMap&lt;String, Class&lt;?&gt;&gt;();

    static {
        ALIASES.put("SampleFilter", SampleFilter.class);
    }

    /**
     * Get the class for a short name alias.
     *
     * @param alias Short name alias.
     * @return      The class, or null if the alias is not defined.
     */
    @Override
    public Class&lt;?&gt; resolve(String alias) {
        return ALIASES.get(alias);
    }
}</pre><p>
   When you add your own resolver,
   you must make it discoverable within your custom library.
   You do this by adding a services file named after the class resolver interface,
   where the file contains the fully qualified class name of your resolver, under
   <code class="filename">META-INF/services/org.forgerock.openig.alias.ClassAliasResolver</code>
   in the jar file for your customizations.
   When you have more than one resolver,
   add one fully qualified class name per line.
   If you build your project using Maven, then you can add this
   under the <code class="filename">src/main/resources</code> directory.
   The content of the file in this example is one line:
  </p><pre class="brush: plain;">
org.forgerock.openig.doc.SampleClassAliasResolver
  </pre><p>
   The corresponding heap object configuration then looks as follows.
  </p><pre class="brush: javascript;">
{
    "name": "SampleFilter",
    "type": "SampleFilter",
    "config": {
        "name": "X-Greeting",
        "value": "Hello world"
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-build"></a>11.12.&nbsp;Building Customizations</h2></div></div></div><p>
   You can use Apache Maven to manage dependencies on OpenIG.
   The dependencies are found in the ForgeRock Maven repository.
  </p><p>
   The following listing shows the Maven POM configuration
   for the ForgeRock Maven repository
   and the dependency to build the sample Filter.
  </p><pre class="brush: xml;">

  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;forgerock-staging-repository&lt;/id&gt;
      &lt;name&gt;ForgeRock Release Repository&lt;/name&gt;
      &lt;url&gt;http://maven.forgerock.org/repo/releases&lt;/url&gt;
      &lt;snapshots&gt;
        &lt;enabled&gt;false&lt;/enabled&gt;
      &lt;/snapshots&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
      &lt;id&gt;forgerock-snapshots-repository&lt;/id&gt;
      &lt;name&gt;ForgeRock Snapshot Repository&lt;/name&gt;
      &lt;url&gt;http://maven.forgerock.org/repo/snapshots&lt;/url&gt;
      &lt;releases&gt;
        &lt;enabled&gt;false&lt;/enabled&gt;
      &lt;/releases&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.forgerock.openig&lt;/groupId&gt;
      &lt;artifactId&gt;openig-core&lt;/artifactId&gt;
      &lt;version&gt;3.1.0&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;

  </pre><p>
   You can then build your customizations into a jar file
   and install them in your local Maven repository
   by using the <span class="command"><strong>mvn install</strong></span> command.
  </p><div class="screen"><pre>
$ <strong>mvn install</strong>
<em>...
[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ sample-filter ---
[INFO] Building jar: .../sample-filter/target/sample-filter-1.0.0-SNAPSHOT.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.478s
[INFO] Finished at: Fri Nov 07 16:57:18 CET 2014
[INFO] Final Memory: 18M/309M
[INFO] ------------------------------------------------------------------------
</em>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-embed"></a>11.13.&nbsp;Embedding Customizations in OpenIG</h2></div></div></div><p>
   After building your customizations into a jar file,
   you can include them in the OpenIG war file for deployment.
   You do this by unpacking <code class="filename">OpenIG-3.1.0.war</code>,
   including your jar library in <code class="filename">WEB-INF/lib</code>,
   and then creating a new war file.
  </p><p>
   For example, if your jar file is in a project named <code class="literal">sample-filter</code>,
   and the development version is <code class="literal">1.0.0-SNAPSHOT</code>,
   you might include the file as in the following example.
  </p><div class="screen"><pre>
$ <strong>mkdir root &amp;&amp; cd root</strong>
$ <strong>jar -xf ~/Downloads/OpenIG-3.1.0.war</strong>
$ <strong>cp ~/Documents/sample-filter/target/sample-filter-1.0.0-SNAPSHOT.jar WEB-INF/lib</strong>
$ <strong>jar -cf ../custom.war *</strong>
  </pre></div><p>
   In this example, the resulting <code class="filename">custom.war</code>
   contains the custom sample filter.
   You can deploy the custom war file
   as you would deploy <code class="filename">OpenIG-3.1.0.war</code>.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-auditing"></a>Chapter&nbsp;12.&nbsp;OpenIG Audit Framework</h1></div></div></div><a class="indexterm" name="d1182e4860"></a><a class="indexterm" name="d1182e4863"></a><p>
  OpenIG provides a publish-and-subscribe audit framework.
  Filters and Handlers publish audit events.
  Agents in OpenIG that are registered with the audit system can
  subscribe to audit events.
 </p><p>
  Agents take responsibility for disseminating audit data
  to clients and to other systems.
  The
  <a href="../reference/index.html#MonitorEndpointHandler" class="link">MonitorEndpointHandler</a> is an example of an audit agent.
 </p><p>
  To audit a Filter, Handler, or a route, you add an audit decoration.
  Audit decoration values are tags, which are strings useful to audit agents.
  Agents can filter audit events of interest based on tags and other conditions.
  The following example route has an audit decoration.
 </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler",
    "condition": "${matches(exchange.request.uri.query, 'site=com')}",
    "baseURI": "http://forgerock.com:80/",
    "audit": "ForgeRock.com route"
}

 </pre><p>
  OpenIG creates an "audit" decorator, so you do not need to do so.
  For details on audit decorations, see the <em class="citetitle">Reference</em> for
  <a href="../reference/index.html#AuditDecorator" class="link">AuditDecorator</a>.
 </p><div class="itemizedlist"><p>
   The "MonitorEndpointHandler" is a simple audit agent
   that collates basic statistics
   about the number of messages "in progress", "completed", and "internal errors"
   for each Filter or Handler that you have tagged,
   and returns the data in JSON format.
   To try auditing with the "MonitorEndpointHandler" agent,
   first set up the following routes.
  </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    A route for the "MonitorEndpointHandler",
    <code class="filename">00-monitor.json</code>:
   </p><pre class="brush: javascript;">
{
  "handler": {
    "type": "MonitorEndpointHandler"
  },
  "condition": "${exchange.request.method == 'GET'
                  and exchange.request.uri.path == '/openig/monitor'}"
}
 </pre></li><li class="listitem"><p>
    A route to ForgeRock.com, <code class="filename">08-com.json</code>:
   </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler",
    "condition": "${matches(exchange.request.uri.query, 'site=com')}",
    "baseURI": "http://forgerock.com:80/",
    "audit": "ForgeRock.com route"
}

 </pre></li><li class="listitem"><p>
    A route to ForgeRock.org, <code class="filename">08-org.json</code>:
   </p><pre class="brush: javascript;">
{
    "handler": "ClientHandler",
    "condition": "${matches(exchange.request.uri.query, 'site=org')}",
    "baseURI": "https://forgerock.org:443/",
    "audit": "ForgeRock.org route"
}

 </pre></li><li class="listitem"><p>
    A default route with a static handler, <code class="filename">99-default.json</code>:
   </p><pre class="brush: javascript;">
{
  "handler": {
    "type": "StaticResponseHandler",
    "config": {
      "status": 200,
      "reason": "OK",
      "entity": "Hello from a static default route"
    }
  },
  "audit": "Static default route"
}

 </pre></li></ul></div><p>
  With the routes in place and OpenIG running,
  access the following route endpoints a few times to trigger audit events
  by using the following URLs.
 </p><table border="0" summary="Simple list" class="simplelist"><tr><td><a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a></td></tr><tr><td><a class="link" href="http://www.example.com:8080/?site=com" target="_blank">http://www.example.com:8080/?site=com</a></td></tr><tr><td><a class="link" href="http://www.example.com:8080/?site=org" target="_blank">http://www.example.com:8080/?site=org</a></td></tr></table><p>
  After triggering a few audit events, access the monitor endpoint,
  <a class="link" href="http://www.example.com:8080/openig/monitor" target="_blank">http://www.example.com:8080/openig/monitor</a>.
  You should see counts of the audit events in JSON format.
 </p><pre class="brush: javascript;">
{
    "Static default route": {
        "in progress": 0,
        "completed": 14,
        "internal errors": 0
    },
    "ForgeRock.com route": {
        "in progress": 0,
        "completed": 16,
        "internal errors": 0
    },
    "ForgeRock.org route": {
        "in progress": 0,
        "completed": 15,
        "internal errors": 0
    },
    "global": {
        "in progress": 0,
        "completed": 45,
        "internal errors": 0
    }
}
 </pre><p>
  According to the example output shown above,
  OpenIG successfully handled 16 requests on the "ForgeRock.com route",
  15 requests on the "ForgeRock.org route", 14 default route requests
  for a total of 45 request completed on the top-level "global" route.
 </p><p>
  You can build your own audit agents that implement
  <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/audit/AuditEventListener.html" target="_blank">AuditEventListener</a> for the audit agent logic
  and extend
  <a class="link" href="http://docs.forgerock.org/en/openig/3.1.0/apidocs/index.html?org/forgerock/openig/audit/ConditionalAuditEventListener.ConditionalListenerHeaplet.html" target="_blank">ConditionalAuditEventListener.ConditionalListenerHeaplet</a> for the heaplet
  as described in the section on
  <span class="olink"><em class="citetitle">Key Extension Points</em></span>.
  For instructions on bundling your custom audit agents, see
  <span class="olink"><em class="citetitle">Building Customizations</em></span>.
 </p></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-troubleshooting"></a>Chapter&nbsp;13.&nbsp;Troubleshooting</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#troubleshooting-object-not-found-in-heap">13.1. Object not found in heap</a></span></dt><dt><span class="section"><a href="#troubleshooting-invalid-json">13.2. Extra or missing character / invalid JSON</a></span></dt><dt><span class="section"><a href="#troubleshooting-flat-file-values-not-correct">13.3. The values in the flat file are incorrect</a></span></dt><dt><span class="section"><a href="#troubleshooting-problem-accessing-url">13.4. Problem accessing URL</a></span></dt><dt><span class="section"><a href="#troubleshooting-static-response-handler-blank-page">13.5. StaticResponseHandler results in a blank page</a></span></dt><dt><span class="section"><a href="#troubleshooting-not-logging-users-in">13.6. OpenIG is not logging users in</a></span></dt><dt><span class="section"><a href="#troubleshooting-read-timeout-sending-request">13.7. Read timed out error when sending a request</a></span></dt><dt><span class="section"><a href="#troubleshooting-new-route-not-used">13.8. OpenIG does not use new route configuration</a></span></dt><dt><span class="section"><a href="#troubleshooting-skip-a-route">13.9. Make OpenIG skip a route</a></span></dt></dl></div><a class="indexterm" name="d1182e4959"></a><p>
  This chapter covers common problems and their solutions.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-object-not-found-in-heap"></a>13.1.&nbsp;Object not found in heap</h2></div></div></div><pre class="brush: plain;">
org.forgerock.json.fluent.JsonValueException: /handler:
   object Router2 not found in heap
    at org.forgerock.openig.heap.HeapImpl.resolve(HeapImpl.java:351)
    at org.forgerock.openig.heap.HeapImpl.resolve(HeapImpl.java:334)
    at org.forgerock.openig.heap.HeapImpl.getHandler(HeapImpl.java:538)
  </pre><p>
   You have specified "handler": "Router2"
   in <code class="filename">config.json</code>,
   but no handler configuration object named "Router2" exists.
   Make sure you have added an entry for the handler
   and that you have correctly spelled its name.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-invalid-json"></a>13.2.&nbsp;Extra or missing character / invalid JSON</h2></div></div></div><pre class="brush: plain;">
HTTP ERROR 500

Problem accessing /wp/wp-login.php. Reason:

    Server Error

Caused by:

    org.forgerock.openig.handler.HandlerException: no handler to dispatch to
  </pre><p>
   A better description of the error appears as an error in the console log:
  </p><pre class="brush: plain;">  
TUE DEC 02 17:35:57 CET 2014 (ERROR) {Router}/handler
The route defined in file '/Users/me/.openig/config/routes/route1.json'
 cannot be added
------------------------------
TUE DEC 02 17:35:57 CET 2014 (ERROR) {Router}/handler
Cannot read/parse content of /Users/me/.openig/config/routes/route1.json
[            HeapException] &gt; Cannot read/parse content of
                              /Users/me/.openig/config/routes/route1.json
[       JsonParseException] &gt; Unexpected character (',' (code 44)):
                              was expecting double-quote to start field name
 at [Source: java.io.InputStreamReader@4c8d1091; line: 4, column: 28]
  </pre><p>
   In this case, extra comma is spotted at line 4, column 28.
  </p><p>
   Use a JSON editor or JSON validation tool such as
   <a class="link" href="http://jsonlint.com/" target="_blank">JSONLint</a> to make sure your JSON is valid.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-flat-file-values-not-correct"></a>13.3.&nbsp;The values in the flat file are incorrect</h2></div></div></div><p>
   Ensure the flat file is readable
   by the user running the container for OpenIG.
   Values are all characters, including space and tabs,
   between the separator, so make sure the values are not padded with spaces.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-problem-accessing-url"></a>13.4.&nbsp;Problem accessing URL</h2></div></div></div><pre class="brush: plain;">
HTTP ERROR 500

Problem accessing /myURL . Reason:

java.lang.String cannot be cast to java.util.List
Caused by:
java.lang.ClassCastException: java.lang.String cannot be cast to java.util.List
  </pre><p>
   This error is typically encountered when using the
   <a href="../reference/index.html#AssignmentFilter" class="link">AssignmentFilter</a>
   and setting a string value for one of the Headers.
   All headers are stored in Lists
   so the header must be addressed with a subscript.
  </p><p>
   For example, if you try to set
   <code class="literal">exchange.request.headers['Location']</code>
   for a redirect in the response object, you should instead set
   <code class="literal">exchange.request.headers['Location'][0]</code>.
   A header without a subscript leads to the error above.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-static-response-handler-blank-page"></a>13.5.&nbsp;StaticResponseHandler results in a blank page</h2></div></div></div><p>
   You must define an entity for the response as in the following example.
  </p><pre class="brush: javascript;">
{
    "name": "AccessDeniedHandler",
    "type": "StaticResponseHandler",
    "config": {
        "status": 403,
        "reason": "Forbidden",
        "entity": "&lt;html&gt;&lt;p&gt;User does not have permission&lt;/p&gt;&lt;/html&gt;"
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-not-logging-users-in"></a>13.6.&nbsp;OpenIG is not logging users in</h2></div></div></div><p>
   If you are proxying to more than one application in multiple DNS domains,
   you must make sure your container is enabled for domain cookies.
   For details on your specific container, see the section on
   <a href="../gateway-guide/index.html#configure-container" class="link"><em class="citetitle">Configuring Deployment Containers</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-read-timeout-sending-request"></a>13.7.&nbsp;Read timed out error when sending a request</h2></div></div></div><p>
   If a "baseURI" configuration setting
   causes a request to come back to OpenIG,
   OpenIG never produces a response to the request.
   You then observe the following behavior.
  </p><p>
   You send a request and OpenIG seems to hang.
   Then you see a failure message,
   <code class="literal">HTTP Status 500 - Read timed out</code>,
   accompanied by OpenIG throwing an exception,
   <code class="literal">java.net.SocketTimeoutException: Read timed out</code>.
  </p><p>
   To fix this issue, make sure
   that "baseURI" configuration settings do not cause requests
   to come back to OpenIG.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-new-route-not-used"></a>13.8.&nbsp;OpenIG does not use new route configuration</h2></div></div></div><p>
   OpenIG loads all configuration at startup.
   By default, it then periodically reloads changed route configurations.
  </p><p>
   If you make changes to a route
   that result in an invalid configuration,
   OpenIG logs errors,
   but it keeps the previous, correct configuration,
   and continues to use the old route.
  </p><p>
   OpenIG only uses the new configuration
   after you save a valid version or when you restart OpenIG.
  </p><p>
   Of course, if you restart OpenIG with an invalid route configuration,
   then OpenIG tries to load the invalid route at startup
   and logs an error.
   In that case, if there is no default handler to accept any incoming exchange
   for the invalid route, then you see an error,
   <code class="literal">No handler to dispatch to</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="troubleshooting-skip-a-route"></a>13.9.&nbsp;Make OpenIG skip a route</h2></div></div></div><p>
   If you have copied routes from another OpenIG server,
   those routes might depend on environment or container configuration
   that you have not yet configured locally.
  </p><p>
   You can work around this problem by changing the route file extension.
   A router ignores route files
   that do not have the <code class="literal">.json</code> extension.
  </p><p>
   For example, suppose you copy route all sample route configurations
   from the documentation, and then start OpenIG
   without first configuring your container.
   This can result in an error such as the following.
  </p><div class="informalexample"><pre class="brush: plain;">
org.forgerock.json.fluent.JsonValueException:
 /handler/config/filters/0/config/dataSource:
 javax.naming.NameNotFoundException;
 remaining name 'jdbc/forgerock'
  at org.forgerock.openig.servlet.GatewayServlet.init(GatewayServlet.java:222)
  at org.eclipse.jetty.servlet.ServletHolder.initServlet(ServletHolder.java:595)
  at org.eclipse.jetty.servlet.ServletHolder.getServlet(ServletHolder.java:458)
  at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:724)
   </pre></div><p>
   This arises from the route in <code class="filename">03-sql.json</code>,
   which defines an "SqlAttributesFilter"
   that depends on a JNDI data source configured in the container.
  </p><pre class="brush: javascript;">
{
    "type": "SqlAttributesFilter",
    "config": {
        "dataSource": "java:comp/env/jdbc/forgerock",
        "preparedStatement":
          "SELECT username, password FROM users WHERE email = ?;",
        "parameters": [
            "george@example.com"
        ],
        "target": "${exchange.credentials}"
    }
}
  </pre><p>
   To prevent OpenIG from loading the route configuration
   until you have had time to configure the container,
   change the file extension to render the route inactive.
  </p><div class="screen"><pre>
$ <strong>mv ~/.openig/config/routes/03-sql.json ~/.openig/config/routes/03-sql.inactive</strong>
  </pre></div><p>
   If necessary, restart the container
   to force OpenIG to reload the configuration.
  </p><p>
   When you have configured the data source in the container,
   change the file extension back to <code class="literal">.json</code>
   to render the route active again.
  </p><div class="screen"><pre>
$ <strong>mv ~/.openig/config/routes/03-sql.inactive ~/.openig/config/routes/03-sql.json</strong>
  </pre></div></div></div><div lang="en" class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="appendix-multiple-sps"></a>Appendix&nbsp;A.&nbsp;SAML 2.0 &amp; Multiple Applications</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#multisp-before-you-start">A.1. Before You Start</a></span></dt><dt><span class="section"><a href="#multisp-prepare-network">A.2. Preparing the Network</a></span></dt><dt><span class="section"><a href="#multisp-prepare-saml-conf">A.3. Preparing the SAML 2.0 Service Provider Configurations</a></span></dt><dt><span class="section"><a href="#multisp-create-saml-entities">A.4. Importing Service Provider Configurations Into OpenAM</a></span></dt><dt><span class="section"><a href="#multisp-create-gateway-conf">A.5. Preparing Configurations in OpenIG</a></span></dt><dt><span class="section"><a href="#multisp-try-it-out">A.6. Trying It Out</a></span></dt></dl></div><p>
  You can use a single OpenIG server as SAML 2.0 Service Provider
  for multiple protected applications.
 </p><a class="indexterm" name="d1182e5105"></a><a class="indexterm" name="d1182e5108"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-before-you-start"></a>A.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you try the samples described here,
   familiarize yourself with OpenIG SAML 2.0 support
   by reading the chapter,
   <a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">OpenIG as a SAML 2.0 Service Provider</em></a>,
   and working through the tutorial in that chapter.
  </p><p>
   Also make sure you understand the principles
   for configuring SAML 2.0 entities in OpenAM.
   The preparation for handling multiple applications
   involves editing the SAML 2.0 Service Provider configurations
   based on the original Fedlet configuration,
   and then importing the new configurations as SAML 2.0 entities in OpenAM.
  </p><p>
   At this point, you should have OpenIG
   protecting the sample application as SAML 2.0 Service Provider,
   with OpenAM working as Identity Provider
   configured as described in the tutorial.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-prepare-network"></a>A.2.&nbsp;Preparing the Network</h2></div></div></div><p>
   You must configure the network so that
   browser traffic to the application hosts is proxied through OpenIG.
  </p><p>
   Modify DNS or host file settings so that
   the hosts name of the protected applications resolve
   to the IP address of OpenIG on the system where the browser runs.
   Restart the browser as necessary to take the changes into account.
  </p><p>
   The examples that follow use host names
   <code class="literal">sp.one.example</code> and <code class="literal">sp.two.example</code>.
   To try the examples on your computer,
   you can edit the host file settings to add these to the loopback address.
  </p><pre class="brush: plain;">
127.0.0.1    localhost www.example.com sp.one.example sp.two.example
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-prepare-saml-conf"></a>A.3.&nbsp;Preparing the SAML 2.0 Service Provider Configurations</h2></div></div></div><p>
   Based on the original Fedlet configuration,
   you add configuration for each new protected application.
  </p><p>
   In the following examples,
   the first application runs on host <code class="literal">sp.one.example</code>.
   The examples assign the entity ID <code class="literal">One</code> to this application,
   and use the metaAlias <code class="literal">/sp1</code> in the SAML configuration.
   The second application runs on <code class="literal">sp.two.example</code>
   with entity ID <code class="literal">Two</code> and metaAlias <code class="literal">/sp2</code>.
  </p><p>
   Edit the <code class="filename">SAML/fedlet.cot</code> file
   to include the entity IDs as in the following example.
  </p><pre class="brush: ini;">
cot-name=Circle of Trust
sun-fm-cot-status=Active
sun-fm-trusted-providers=http://openam.example.com:8088/openam,${projectName},One,Two
sun-fm-saml2-readerservice-url=
sun-fm-saml2-writerservice-url=

  </pre><p>
   For each application, make copies of the SAML configuration files
   <code class="filename">sp.xml</code> and <code class="filename">sp-extended.xml</code>.
   Edit the copy of <code class="filename">sp.xml</code> for the application so that
   the entity ID matches the application,
   the Location and ResponseLocation attributes reflect those of the application,
   and the AssertionConsumerService Location attributes include the metaAlias.
  </p><div class="example"><a name="multisp-sp1"></a><div class="example-title">Example&nbsp;A.1.&nbsp;Service Provider Configuration for Application One</div><div class="example-contents"><pre class="brush: xml;">
&lt;!--
  Set the entityID and edit *Location attributes to match the service provider.
  Note that AssertionConsumerService Location attributes include the metaAlias.
--&gt;
&lt;EntityDescriptor
  entityID="One"
  xmlns="urn:oasis:names:tc:SAML:2.0:metadata"&gt;
  &lt;SPSSODescriptor
    AuthnRequestsSigned="false"
    WantAssertionsSigned="false"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
      Location="http://sp.one.example:8080/saml/fedletSloRedirect"
      ResponseLocation="http://sp.one.example:8080/saml/fedletSloRedirect"/&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
      Location="http://sp.one.example:8080/saml/fedletSloPOST"
      ResponseLocation="http://sp.one.example:8080/saml/fedletSloPOST"/&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:SOAP"
      Location="http://sp.one.example:8080/saml/fedletSloSoap"/&gt;
    &lt;NameIDFormat&gt;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&lt;/NameIDFormat&gt;
    &lt;AssertionConsumerService
      isDefault="true"
      index="0"
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
      Location="http://sp.one.example:8080/saml/fedletapplication/metaAlias/sp1"/&gt;
    &lt;AssertionConsumerService
      index="1"
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact"
      Location="http://sp.one.example:8080/saml/fedletapplication/metaAlias/sp1"/&gt;
  &lt;/SPSSODescriptor&gt;
  &lt;RoleDescriptor
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
    xsi:type="query:AttributeQueryDescriptorType"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;/RoleDescriptor&gt;
  &lt;XACMLAuthzDecisionQueryDescriptor
    WantAssertionsSigned="false"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;/XACMLAuthzDecisionQueryDescriptor&gt;
&lt;/EntityDescriptor&gt;

   </pre></div></div><br class="example-break"><div class="example"><a name="multisp-sp2"></a><div class="example-title">Example&nbsp;A.2.&nbsp;Service Provider Configuration for Application Two</div><div class="example-contents"><pre class="brush: xml;">
&lt;!--
  Set the entityID and edit *Location attributes to match the service provider.
  Note that AssertionConsumerService Location attributes include the metaAlias.
--&gt;
&lt;EntityDescriptor
  entityID="Two"
  xmlns="urn:oasis:names:tc:SAML:2.0:metadata"&gt;
  &lt;SPSSODescriptor
    AuthnRequestsSigned="false"
    WantAssertionsSigned="false"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
      Location="http://sp.two.example:8080/saml/fedletSloRedirect"
      ResponseLocation="http://sp.two.example:8080/saml/fedletSloRedirect"/&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
      Location="http://sp.two.example:8080/saml/fedletSloPOST"
      ResponseLocation="http://sp.two.example:8080/saml/fedletSloPOST"/&gt;
    &lt;SingleLogoutService
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:SOAP"
      Location="http://sp.two.example:8080/saml/fedletSloSoap"/&gt;
    &lt;NameIDFormat&gt;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&lt;/NameIDFormat&gt;
    &lt;AssertionConsumerService
      isDefault="true"
      index="0"
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
      Location="http://sp.two.example:8080/saml/fedletapplication/metaAlias/sp2"/&gt;
    &lt;AssertionConsumerService
      index="1"
      Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact"
      Location="http://sp.two.example:8080/saml/fedletapplication/metaAlias/sp2"/&gt;
  &lt;/SPSSODescriptor&gt;
  &lt;RoleDescriptor
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
    xsi:type="query:AttributeQueryDescriptorType"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;/RoleDescriptor&gt;
  &lt;XACMLAuthzDecisionQueryDescriptor
    WantAssertionsSigned="false"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;/XACMLAuthzDecisionQueryDescriptor&gt;
&lt;/EntityDescriptor&gt;

   </pre></div></div><br class="example-break"><p>
   Edit the copy of <code class="filename">sp-extended.xml</code> for the application
   so that the entity ID matches the application,
   and the metaAlias and appLogoutUrl are correctly set.
  </p><div class="example"><a name="multisp-sp1-extended"></a><div class="example-title">Example&nbsp;A.3.&nbsp;Service Provider Extended Configuration for Application One</div><div class="example-contents"><pre class="brush: xml;">
&lt;!--
  Set the entityID and edit the SPSSOConfig metaAlias attribute.
  Also set the value of appLogoutUrl.
--&gt;
&lt;EntityConfig xmlns="urn:sun:fm:SAML:2.0:entityconfig"
    xmlns:fm="urn:sun:fm:SAML:2.0:entityconfig"
    hosted="1"
    entityID="One"&gt;

    &lt;SPSSOConfig metaAlias="/sp1"&gt;
        &lt;Attribute name="description"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthOn"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthUser"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthPassword"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="autofedEnabled"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="autofedAttribute"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="transientUser"&gt;
            &lt;Value&gt;anonymous&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAdapter"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAdapterEnv"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="fedletAdapter"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultFedletAdapter&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="fedletAdapterEnv"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAccountMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultLibrarySPAccountMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="useNameIDAsSPUserID"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAttributeMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAttributeMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAuthnContextMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextClassrefMapping"&gt;
            &lt;Value&gt;
            urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport|0|default
            &lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextComparisonType"&gt;
           &lt;Value&gt;exact&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="attributeMap"&gt;
           &lt;Value&gt;employeenumber=employeenumber&lt;/Value&gt;
           &lt;Value&gt;mail=mail&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="saml2AuthModuleName"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="localAuthURL"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="intermediateUrl"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="defaultRelayState"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="appLogoutUrl"&gt;
           &lt;Value&gt;http://sp.one.example:8080/saml/logout&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="assertionTimeSkew"&gt;
           &lt;Value&gt;300&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantAttributeEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantAssertionEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantNameIDEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantPOSTResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantArtifactResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantLogoutRequestSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantLogoutResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantMNIRequestSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantMNIResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="responseArtifactMessageEncoding"&gt;
           &lt;Value&gt;URI&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="cotlist"&gt;
       &lt;Value&gt;Circle of Trust&lt;/Value&gt;&lt;/Attribute&gt;
       &lt;Attribute name="saeAppSecretList"&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="saeSPUrl"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="saeSPLogoutUrl"&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPListFinderImpl"&gt;
           &lt;Value&gt;com.sun.identity.saml2.plugins.ECPIDPFinder&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPList"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPListGetComplete"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="enableIDPProxy"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="idpProxyList"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="idpProxyCount"&gt;
           &lt;Value&gt;0&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="useIntroductionForIDPProxy"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="spSessionSyncEnabled"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
        &lt;Attribute name="relayStateUrlList"&gt;
        &lt;/Attribute&gt;
    &lt;/SPSSOConfig&gt;
    &lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantNameIDEncrypted"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="cotlist"&gt;
            &lt;Value&gt;Circle of Trust&lt;/Value&gt;
        &lt;/Attribute&gt;
    &lt;/AttributeQueryConfig&gt;
    &lt;XACMLAuthzDecisionQueryConfig metaAlias="/pep"&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthOn"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthUser"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthPassword"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantXACMLAuthzDecisionResponseSigned"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantAssertionEncrypted"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="cotlist"&gt;
            &lt;Value&gt;Circle of Trust&lt;/Value&gt;
        &lt;/Attribute&gt;
    &lt;/XACMLAuthzDecisionQueryConfig&gt;
&lt;/EntityConfig&gt;

   </pre></div></div><br class="example-break"><div class="example"><a name="multisp-sp2-extended"></a><div class="example-title">Example&nbsp;A.4.&nbsp;Service Provider Extended Configuration for Application Two</div><div class="example-contents"><pre class="brush: xml;">
&lt;!--
  Set the entityID and edit the SPSSOConfig metaAlias attribute.
  Also set the value of appLogoutUrl.
--&gt;
&lt;EntityConfig xmlns="urn:sun:fm:SAML:2.0:entityconfig"
    xmlns:fm="urn:sun:fm:SAML:2.0:entityconfig"
    hosted="1"
    entityID="Two"&gt;

    &lt;SPSSOConfig metaAlias="/sp2"&gt;
        &lt;Attribute name="description"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthOn"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthUser"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthPassword"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="autofedEnabled"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="autofedAttribute"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="transientUser"&gt;
            &lt;Value&gt;anonymous&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAdapter"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAdapterEnv"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="fedletAdapter"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultFedletAdapter&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="fedletAdapterEnv"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAccountMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultLibrarySPAccountMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="useNameIDAsSPUserID"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAttributeMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAttributeMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextMapper"&gt;
            &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAuthnContextMapper&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextClassrefMapping"&gt;
            &lt;Value&gt;
            urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport|0|default
            &lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="spAuthncontextComparisonType"&gt;
           &lt;Value&gt;exact&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="attributeMap"&gt;
           &lt;Value&gt;employeenumber=employeenumber&lt;/Value&gt;
           &lt;Value&gt;mail=mail&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="saml2AuthModuleName"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="localAuthURL"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="intermediateUrl"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="defaultRelayState"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="appLogoutUrl"&gt;
           &lt;Value&gt;http://sp.two.example:8080/saml/logout&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="assertionTimeSkew"&gt;
           &lt;Value&gt;300&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantAttributeEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantAssertionEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantNameIDEncrypted"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantPOSTResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantArtifactResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantLogoutRequestSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantLogoutResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantMNIRequestSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="wantMNIResponseSigned"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="responseArtifactMessageEncoding"&gt;
           &lt;Value&gt;URI&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="cotlist"&gt;
       &lt;Value&gt;Circle of Trust&lt;/Value&gt;&lt;/Attribute&gt;
       &lt;Attribute name="saeAppSecretList"&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="saeSPUrl"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="saeSPLogoutUrl"&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPListFinderImpl"&gt;
           &lt;Value&gt;com.sun.identity.saml2.plugins.ECPIDPFinder&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPList"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="ECPRequestIDPListGetComplete"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="enableIDPProxy"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="idpProxyList"&gt;
           &lt;Value&gt;&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="idpProxyCount"&gt;
           &lt;Value&gt;0&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="useIntroductionForIDPProxy"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
       &lt;Attribute name="spSessionSyncEnabled"&gt;
           &lt;Value&gt;false&lt;/Value&gt;
       &lt;/Attribute&gt;
        &lt;Attribute name="relayStateUrlList"&gt;
        &lt;/Attribute&gt;
    &lt;/SPSSOConfig&gt;
    &lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantNameIDEncrypted"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="cotlist"&gt;
            &lt;Value&gt;Circle of Trust&lt;/Value&gt;
        &lt;/Attribute&gt;
    &lt;/AttributeQueryConfig&gt;
    &lt;XACMLAuthzDecisionQueryConfig metaAlias="/pep"&gt;
        &lt;Attribute name="signingCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="encryptionCertAlias"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthOn"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthUser"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="basicAuthPassword"&gt;
            &lt;Value&gt;&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantXACMLAuthzDecisionResponseSigned"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="wantAssertionEncrypted"&gt;
            &lt;Value&gt;false&lt;/Value&gt;
        &lt;/Attribute&gt;
        &lt;Attribute name="cotlist"&gt;
            &lt;Value&gt;Circle of Trust&lt;/Value&gt;
        &lt;/Attribute&gt;
    &lt;/XACMLAuthzDecisionQueryConfig&gt;
&lt;/EntityConfig&gt;

   </pre></div></div><br class="example-break"><p>
   For each of the service provider extended configuration files,
   prepare a copy for use when importing the configuration into OpenAM.
   The only change to make in each copy is to set <code class="literal">hosted="0"</code>,
   so that when you import the configuration into OpenAM,
   OpenAM considers it that of a <span class="emphasis"><em>remote</em></span> service provider.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-create-saml-entities"></a>A.4.&nbsp;Importing Service Provider Configurations Into OpenAM</h2></div></div></div><p>
   For each new protected application, import a SAML 2.0 entity into OpenAM.
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     Login to OpenAM console as global administrator (<code class="literal">amadmin</code>).
    </p></li><li class="listitem"><p>
     On the Federation tab &gt; Entity Providers table, click Import Entity.
    </p></li><li class="listitem"><p>
     Import the entity using the metadata from the edited copies of
     <code class="filename">sp.xml</code> and <code class="filename">sp-extended.xml</code>,
     where the copy of <code class="filename">sp-extended.xml</code>
     has <code class="literal">hosted="0"</code>.
    </p><p>
     The service provider configurations should have
     Location <code class="literal">Remote</code> in the Entity Providers table.
    </p></li><li class="listitem"><p>
     Log out of OpenAM Console.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-create-gateway-conf"></a>A.5.&nbsp;Preparing Configurations in OpenIG</h2></div></div></div><p>
   For each new protected application, prepare a OpenIG configuration.
   The configurations in this section follow the example in the chapter,
   <a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">OpenIG as a SAML 2.0 Service Provider</em></a>.
  </p><p>
   Before editing route configurations for the protected applications,
   configure a top-level router that does not rebase the incoming URLs,
   such as the following <code class="filename">config.json</code>.
   This differs from the example used in earlier tutorials.
  </p><pre class="brush: javascript;">
{
    "handler": {
        "type": "Router"
    },
    "heap": [
        {
            "name": "LogSink",
            "type": "ConsoleLogSink",
            "config": {
                "level": "DEBUG"
            }
        },
        {
            "name": "ClientHandler",
            "type": "ClientHandler"
        },
        {
            "name": "capture",
            "type": "CaptureDecorator",
            "config": {
                "captureEntity": true,
                "captureExchange": true
            }
        }
    ]
}

  </pre><p>
   Also restart OpenIG to put all configuration changes into effect.
  </p><p>
   For each application set up a pair of routes,
   one to handle redirection for SAML authentication and login to the application,
   the other to act as the SAML 2.0 assertion consumer
   that maps attributes from the SAML assertion into the exchange
   and redirects back to the first route.
  </p><p>
   The following examples show the routes for application One.
  </p><div class="example"><a name="multisp-sp1-route"></a><div class="example-title">Example&nbsp;A.5.&nbsp;Route for SAML Authentication &amp; Login: Application One</div><div class="example-contents"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${empty exchange.session.sp1Username}",
                    "handler": {
                        "type": "StaticResponseHandler",
                        "config": {
                            "status": 302,
                            "reason": "Found",
                            "headers": {
                                "Location": [
                                    "http://sp.one.example:8080/saml/SPInitiatedSSO?metaAlias=/sp1"
                                ]
                            }
                        }
                    },
                    "baseURI": "http://sp.one.example:8081"
                },
                {
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "http://sp.one.example:8081",
                                        "form": {
                                            "username": [
                                                "${exchange.session.sp1Username}"
                                            ],
                                            "password": [
                                                "${exchange.session.sp1Password}"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://sp.one.example:8081"
                }
            ]
        }
    },
    "condition": "${matches(exchange.request.uri.host, 'sp.one.example')}"
}

   </pre></div></div><br class="example-break"><div class="example"><a name="multisp-sp1-saml-route"></a><div class="example-title">Example&nbsp;A.6.&nbsp;SAML Assertion Consumer: Application One</div><div class="example-contents"><pre class="brush: javascript;">
{
    "handler": {
        "type": "SamlFederationHandler",
        "config": {
            "comment": "Use unique session properties for this SP.",
            "assertionMapping": {
                "sp1Username": "mail",
                "sp1Password": "employeenumber"
            },
            "authnContext": "sp1AuthnContext",
            "sessionIndexMapping": "sp1SessionIndex",
            "subjectMapping": "sp1SubjectName",
            "redirectURI": "/sp1"
        }
    },
    "condition": "${matches(exchange.request.uri.host, 'sp.one.example')
                    and matches(exchange.request.uri.path, '^/saml')}"
}

   </pre></div></div><br class="example-break"><p>
   The following examples show the routes for application Two.
  </p><div class="example"><a name="multisp-sp2-route"></a><div class="example-title">Example&nbsp;A.7.&nbsp;Route for SAML Authentication &amp; Login: Application Two</div><div class="example-contents"><pre class="brush: javascript;">
{
    "handler": {
        "type": "DispatchHandler",
        "config": {
            "bindings": [
                {
                    "condition": "${empty exchange.session.sp2Username}",
                    "handler": {
                        "type": "StaticResponseHandler",
                        "config": {
                            "status": 302,
                            "reason": "Found",
                            "headers": {
                                "Location": [
                                    "http://sp.two.example:8080/saml/SPInitiatedSSO?metaAlias=/sp2"
                                ]
                            }
                        }
                    },
                    "baseURI": "http://sp.two.example:8081"
                },
                {
                    "handler": {
                        "type": "Chain",
                        "config": {
                            "filters": [
                                {
                                    "type": "StaticRequestFilter",
                                    "config": {
                                        "method": "POST",
                                        "uri": "http://sp.two.example:8081",
                                        "form": {
                                            "username": [
                                                "${exchange.session.sp2Username}"
                                            ],
                                            "password": [
                                                "${exchange.session.sp2Password}"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "handler": "ClientHandler"
                        }
                    },
                    "baseURI": "http://sp.two.example:8081"
                }
            ]
        }
    },
    "condition": "${matches(exchange.request.uri.host, 'sp.two.example')}"
}

   </pre></div></div><br class="example-break"><div class="example"><a name="multisp-sp2-saml-route"></a><div class="example-title">Example&nbsp;A.8.&nbsp;SAML Assertion Consumer: Application Two</div><div class="example-contents"><pre class="brush: javascript;">
{
    "handler": {
        "type": "SamlFederationHandler",
        "config": {
            "comment": "Use unique session properties for this SP.",
            "assertionMapping": {
                "sp2Username": "mail",
                "sp2Password": "employeenumber"
            },
            "authnContext": "sp2AuthnContext",
            "sessionIndexMapping": "sp2SessionIndex",
            "subjectMapping": "sp2SubjectName",
            "redirectURI": "/sp2"
        }
    },
    "condition": "${matches(exchange.request.uri.host, 'sp.two.example')
                    and matches(exchange.request.uri.path, '^/saml')}"
}

   </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multisp-try-it-out"></a>A.6.&nbsp;Trying It Out</h2></div></div></div><p>
   Try the configuration for multiple protected applications,
   logging in to OpenAM as for the single SP federation example
   with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
  </p><div class="itemizedlist"><p>
    If you use the example configurations described here
    with all services running on your computer protecting the sample application,
    then you can try the SAML 2.0 web single sign-on profile
    with application One by using either of the following links.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The link for
     <a class="link" href="http://sp.one.example:8080/saml/SPInitiatedSSO?metaAlias=/sp1&amp;idpEntityID=http://openam.example.com:8088/openam&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">SP initiated SSO</a>.
    </p></li><li class="listitem"><p>
     The link for
     <a class="link" href="http://openam.example.com:8088/openam/idpssoinit?NameIDFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:transient&amp;metaAlias=/idp&amp;spEntityID=One&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">IDP initiated SSO</a>.
    </p></li></ul></div><div class="itemizedlist"><p>
    Similarly you can try the SAML 2.0 web single sign-on profile
    with application Two by using either of the following links.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The link for
     <a class="link" href="http://sp.two.example:8080/saml/SPInitiatedSSO?metaAlias=/sp2&amp;idpEntityID=http://openam.example.com:8088/openam&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">SP initiated SSO</a>.
    </p></li><li class="listitem"><p>
     The link for
     <a class="link" href="http://openam.example.com:8088/openam/idpssoinit?NameIDFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:transient&amp;metaAlias=/idp&amp;spEntityID=Two&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">IDP initiated SSO</a>.
    </p></li></ul></div><p>
   If you have not configured the examples exactly as shown in this guide,
   then adapt the SSO links accordingly.
  </p></div></div><div class="index"><div class="titlepage"><div><div><h1 class="title"><a name="d1182e5357"></a>Index</h1></div></div></div><div class="index"><div class="indexdiv"><h3>A</h3><dl><dt>Auditing, <a class="indexterm" href="#chap-auditing">OpenIG Audit Framework</a></dt></dl></div><div class="indexdiv"><h3>C</h3><dl><dt>Configuration</dt><dd><dl><dt>Federation, <a class="indexterm" href="#federation-configuration-files">Configuration File Overview</a>, <a class="indexterm" href="#federation-configuration">Configuring the Federation Handler</a></dt><dt>HTTP &amp; HTTPS, <a class="indexterm" href="#template-http-and-https">HTTP &amp; HTTPS Application</a></dt><dt>Login with cookie, <a class="indexterm" href="#template-login-cookie">Login Form With Cookie From Login Page</a></dt><dt>Login with filter, <a class="indexterm" href="#template-login-extract-cookie-filters">Login Form With Extract Filter &amp; Cookie Filter</a></dt><dt>Login with hidden value, <a class="indexterm" href="#template-login-hidden-value">Login Which Requires a Hidden Value From the Login Page</a></dt><dt>Microsoft Online Outlook Web Access, <a class="indexterm" href="#template-owa-online">Microsoft Online Outlook Web Access</a></dt><dt>Multiple applications, <a class="indexterm" href="#chap-routing">Configuring Routes</a></dt><dt>OAuth 2.0, <a class="indexterm" href="#chap-oauth2-rs">OpenIG as an OAuth 2.0 Resource Server</a>, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt><dt>OpenID Connect 1.0, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt><dt>Proxy &amp; capture, <a class="indexterm" href="#template-proxy-capture">Proxy &amp; Capture</a></dt><dt>Run time changes, <a class="indexterm" href="#chap-routing">Configuring Routes</a></dt><dt>SAML 2.0, <a class="indexterm" href="#chap-federation">OpenIG as a SAML 2.0 Service Provider</a>, <a class="indexterm" href="#appendix-multiple-sps">SAML 2.0 &amp; Multiple Applications</a></dt><dt>Simple login form, <a class="indexterm" href="#template-simple-login">Simple Login Form</a></dt></dl></dd><dt>Containers</dt><dd><dl><dt>Jetty, <a class="indexterm" href="#jetty">Configuring Jetty For OpenIG</a></dt><dt>Tomcat, <a class="indexterm" href="#tomcat">Configuring Apache Tomcat For OpenIG</a></dt></dl></dd><dt>Customizations</dt><dd><dl><dt>Extension points, <a class="indexterm" href="#extension-points">Key Extension Points</a></dt><dt>Filters, <a class="indexterm" href="#custom-filter">Implementing a Filter</a></dt><dt>Handlers, <a class="indexterm" href="#custom-handler">Implementing a Handler</a></dt><dt>Heap objects, <a class="indexterm" href="#custom-heap-config">Heap Object Configuration</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>I</h3><dl><dt>Installation, <a class="indexterm" href="#chap-install">Installation in Detail</a></dt><dd><dl><dt>Federation, <a class="indexterm" href="#federation-installation">Installation Overview</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>O</h3><dl><dt>OAuth 2.0</dt><dd><dl><dt>Client, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt><dt>Resource server, <a class="indexterm" href="#chap-oauth2-rs">OpenIG as an OAuth 2.0 Resource Server</a></dt></dl></dd><dt>OpenID Connect 1.0</dt><dd><dl><dt>Relying party, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>Routing, <a class="indexterm" href="#chap-routing">Configuring Routes</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>SAML 2.0, <a class="indexterm" href="#chap-federation">OpenIG as a SAML 2.0 Service Provider</a>, <a class="indexterm" href="#appendix-multiple-sps">SAML 2.0 &amp; Multiple Applications</a></dt></dl></div><div class="indexdiv"><h3>T</h3><dl><dt>Troubleshooting, <a class="indexterm" href="#chap-troubleshooting">Troubleshooting</a></dt><dt>Tutorials</dt><dd><dl><dt>Auditing, <a class="indexterm" href="#chap-auditing">OpenIG Audit Framework</a></dt><dt>Capture &amp; relay passwords, <a class="indexterm" href="#chap-password-capture-replay-tutorial">Getting Login Credentials From OpenAM</a></dt><dt>Credentials from a file, <a class="indexterm" href="#chap-credentials-tutorial">Getting Login Credentials From Data Sources</a></dt><dt>Credentials from a relational database, <a class="indexterm" href="#chap-credentials-tutorial">Getting Login Credentials From Data Sources</a></dt><dt>Getting started, <a class="indexterm" href="#chap-quickstart">Getting Started</a></dt><dt>OAuth 2.0, <a class="indexterm" href="#chap-oauth2-rs">OpenIG as an OAuth 2.0 Resource Server</a>, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt><dt>OpenID Connect 1.0, <a class="indexterm" href="#chap-oauth2-client">OpenIG as an OAuth 2.0 Client</a></dt><dt>Routing, <a class="indexterm" href="#chap-routing">Configuring Routes</a></dt><dt>SAML 2.0, <a class="indexterm" href="#chap-federation">OpenIG as a SAML 2.0 Service Provider</a></dt></dl></dd></dl></div></div></div></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10060&components=10220&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-14']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>