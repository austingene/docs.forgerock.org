<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Guide to OpenIG</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="gateway-guide"></a>Guide to OpenIG</h1></div><div><h2 class="subtitle">Version 3.0.0</h2></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Paul </span> <span class="surname">Bryan</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Mark </span> <span class="surname">Craig</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Jamie </span> <span class="surname">Nelson</span></h3><div lang="en" class="affiliation"><span class="orgname">ForgeRock AS<br></span><div class="address"><p><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="street">33&nbsp;New&nbsp;Montgomery&nbsp;St.</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="otheraddr">Suite&nbsp;1500</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="city">San&nbsp;Francisco</span>,&nbsp;<span class="state">CA</span>&nbsp;<span class="postcode">94105</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="country">USA</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="phone">+1&nbsp;415-523-0772</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<code class="uri">www.forgerock.com</code><br>
&nbsp;&nbsp;&nbsp;</p></div></div></div></div></div><div><p class="releaseinfo">Software release date: August 11, 2014</p></div><div><p class="copyright">Copyright &copy; 2011-2014 ForgeRock AS</p></div><div><a href="legalnotice.html">Legal Notice</a></div><div><p class="pubdate">Publication date: August 07, 2014</p></div></div><hr></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#chap-overview">1. Solutions Overview</a></span></dt><dt><span class="chapter"><a href="#chap-howitworks">2. How OpenIG Works</a></span></dt><dt><span class="chapter"><a href="#chap-quickstart">3. Getting Started</a></span></dt><dt><span class="chapter"><a href="#chap-install">4. Installing OpenIG</a></span></dt><dt><span class="chapter"><a href="#chap-usecases">5. Detailed Use Cases</a></span></dt><dt><span class="chapter"><a href="#chap-credentials-tutorial">6. Tutorial On Looking Up Credentials</a></span></dt><dt><span class="chapter"><a href="#chap-password-capture-replay-tutorial">7. Tutorial On OpenAM Password Capture &amp; Replay</a></span></dt><dt><span class="chapter"><a href="#chap-federation">8. Using OpenIG Federation</a></span></dt><dt><span class="chapter"><a href="#chap-federation-tutorial">9. Tutorial For OpenIG Federation</a></span></dt><dt><span class="chapter"><a href="#chap-oauth-rs">10. Configuring OpenIG as an OAuth 2.0 Resource Server</a></span></dt><dt><span class="chapter"><a href="#chap-oauth2-client">11. Configuring OpenIG as an OAuth 2.0 Client</a></span></dt><dt><span class="chapter"><a href="#chap-routing">12. Routing Tutorial</a></span></dt><dt><span class="chapter"><a href="#chap-gateway-templates">13. Configuration Templates</a></span></dt><dt><span class="chapter"><a href="#chap-scripting">14. Scripting Filters &amp; Handlers</a></span></dt><dt><span class="chapter"><a href="#chap-customizing">15. Customizing OpenIG</a></span></dt><dt><span class="chapter"><a href="#chap-troubleshooting">16. Troubleshooting</a></span></dt><dt><span class="appendix"><a href="#appendix-config">A. Tutorial Configuration Files</a></span></dt><dt><span class="index"><a href="#d851e4695">Index</a></span></dt></dl></div><div lang="en" class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="preface"></a>Preface</h1></div></div></div><p>
  This guide shows you how to install and configure OpenIG,
  a high-performance reverse proxy server with specialized session management
  and credential replay functionality.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e148"></a>1.&nbsp;Who Should Use this Guide</h2></div></div></div><p>
   This guide is written for access management designers and administrators
   who develop, build, deploy, and maintain OpenIG deployments
   for their organizations.
   This guide covers the tasks you might perform once
   or repeat throughout the life cycle of an OpenIG release.
  </p><p>
   You do not need to be an expert to learn something from this guide,
   though a background in HTTP, access management web applications can help.
   You do need some background in managing services on your operating systems
   and in your application servers.
   You can nevertheless get started with this guide,
   and then learn more as you go along.
  </p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="formatting-conventions"></a>2.&nbsp;Formatting Conventions</h2></div></div></div><p>
  Most examples in the documentation are created on GNU/Linux or Mac OS X.

  Where it is helpful to make a distinction between operating environments,
  examples for UNIX, GNU/Linux, Mac OS X, and so forth are labeled (UNIX).
  Mac OS X specific examples can be labeled (Mac OS X).
  Examples for Microsoft Windows can be labeled (Windows).

  To avoid repetition, however, file system directory names are
  often given only in UNIX format as in <code class="filename">/path/to/server</code>,
  even if the text applies to <code class="filename">C:\path\to\server</code> as well.
 </p><p>
  Absolute path names usually begin with the placeholder
  <code class="filename">/path/to/</code>.

  This path might translate to <code class="filename">/opt/</code>,
  <code class="filename">C:\Program Files\</code>, or somewhere else on your system.
 </p><p>
  Command line, terminal sessions are formatted as follows.
 </p><div class="screen"><pre>$ <strong>echo $JAVA_HOME</strong>
<em>/path/to/jdk</em></pre></div><p>
  Command output is sometimes formatted for narrower, more readable output
  even though formatting parameters are not shown in the command.
  In the following example, the query string parameter
  <code class="literal">_prettyPrint=true</code> is omitted.
 </p><div class="screen"><pre>
$ <strong>curl https://bjensen:hifalutin@opendj.example.com:8443/users/newuser</strong>
<em>{
  "_rev" : "000000005b337348",
  "schemas" : [ "urn:scim:schemas:core:1.0" ],
  "contactInformation" : {
    "telephoneNumber" : "+1 408 555 1212",
    "emailAddress" : "newuser@example.com"
  },
  "_id" : "newuser",
  "name" : {
    "familyName" : "New",
    "givenName" : "User"
  },
  "userName" : "newuser@example.com",
  "displayName" : "New User",
  "meta" : {
    "created" : "2014-06-03T09:58:27Z"
  },
  "manager" : [ {
    "_id" : "kvaughan",
    "displayName" : "Kirsten Vaughan"
  } ]
}</em>
 </pre></div><p>
  Program listings are formatted as follows.
 </p><pre class="brush: java;">class Test {
    public static void main(String [] args)  {
        System.out.println("This is a program listing.");
    }
}</pre></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="accessing-doc-online"></a>3.&nbsp;Accessing Documentation Online</h2></div></div></div><p>
  ForgeRock core documentation, such as what you are now reading, aims to be
  technically accurate and complete with respect to the software documented.
 </p><div class="itemizedlist"><p>
   Core documentation therefore follows a three-phase review process
   designed to eliminate errors.
  </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Product managers and software architects review project documentation design
    with respect to the users' software lifecycle needs.
   </p></li><li class="listitem"><p>
    Subject matter experts review proposed documentation changes for
    technical accuracy and completeness
    with respect to the corresponding software.
   </p></li><li class="listitem"><p>
    Quality experts validate implemented documentation changes for
    technical validity with respect to the software,
    technical completeness with respect to the scope of the document,
    and usability for the expected audience.
   </p></li></ul></div><p>
  The review process helps to ensure that documentation published for
  a ForgeRock release is technically accurate and complete.
 </p><p>
  Fully reviewed, published core documentation is available at
  <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.

  Use this documentation when working with a ForgeRock Enterprise release.
 </p><p>
  In-progress documentation can be found at each project site under the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> projects page.

  Use this documentation when trying a nightly build.
 </p><p>
  The ForgeRock <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a> and provide additional, user-created information.

  We encourage you to
  <a class="link" href="https://sso.forgerock.com/openam/UI/Login" target="_blank">join the community</a>, so that you can update the Wikis, too.
 </p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="joining-the-community"></a>4.&nbsp;Joining the ForgeRock Community</h2></div></div></div><p>
  After you
  <a class="link" href="https://backstage.forgerock.com/#/account/register" target="_blank">sign up</a> to join the ForgeRock community,
  you can edit the
  <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a>,
  and also log bugs and feature requests in the
  <a class="link" href="https://bugster.forgerock.org/" target="_blank">issue tracker</a>.
 </p><p>
  If you have a question regarding a project but cannot find an answer
  in the project documentation or Wiki, browse to the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> page for the project,
  where you can find details on joining the project mailing lists,
  and find links to mailing list archives.

  You can also suggest updates to documentation through the
  <a class="link" href="https://lists.forgerock.org/mailman/listinfo/docs" target="_blank">ForgeRock docs mailing list</a>.
 </p><p>
  The Community Wikis describe how to check out and build source code.

  Should you want to contribute a patch, test, or feature,
  or want to author part of the core documentation,
  first have a look on the ForgeRock site at
  <a class="link" href="http://forgerock.org/get_involved.html" target="_blank">how to get involved</a>.
 </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-overview"></a>Chapter&nbsp;1.&nbsp;Solutions Overview</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#sso-for-any-app">1.1. Extend SSO To Any Application</a></span></dt><dt><span class="section"><a href="#federate-any-app">1.2. Federate Enabling Applications</a></span></dt><dt><span class="section"><a href="#oauth2-support">1.3. Quickly Add OAuth 2.0 &amp; OpenID Connect 1.0 Support</a></span></dt></dl></div><p>
  ForgeRock OpenIG provides the answer to three important challenges.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sso-for-any-app"></a>1.1.&nbsp;Extend SSO To Any Application</h2></div></div></div><p>In today's enterprise, more than 30% of web applications are
  incompatible with web access management (WAM) software. That is, unlike
  OpenAM with OpenIG, most web access management products lack the agent
  to protect the web applications, or the application is a legacy solution that
  does not follow standard protocols for single sign-on. This limits the return
  on the enterprise WAM investment and constrains what types of web applications
  can be protected.</p><p>ForgeRock OpenIG addresses this problem by extending
  access management to encompass <span class="emphasis"><em>all</em></span> web applications.
  With OpenIG, OpenAM deployments can now be extended to be inclusive of those
  applications that do not integrate with policy agents alone. In addition,
  ForgeRock OpenIG interoperates, out-of-the-box, with all
  management solutions. Most importantly, your organization can on-board any
  web application without ever modifying or touching the target application
  again, significantly reducing the development and quality assurance required
  to protect web applications.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federate-any-app"></a>1.2.&nbsp;Federate Enabling Applications</h2></div></div></div><p>
   The expertise and cost required to add SAML 2.0 support to web applications
   is a problem for many businesses.
   Those businesses not moving to a standard
   for exposing their applications to their customers
   see increased cost and maintenance due to the complexity
   of one-off proprietary integrations.
   They can also see a loss of business to those customers
   requiring a Federation standard for authentication.
   Sometimes, deploying a full access management solution
   just to federate a few applications is is too complex and costly,
   and building out their own solution by modifying their applications
   is just not possible.
  </p><div class="mediaobject" align="center"><a name="figure-federate-any-app"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/federate-any-app.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-federate-any-app.html" target="longdesc">D</a>]</span></div></div><p>
   OpenIG Federation allows businesses to add SAML 2.0 support
   to their applications with little to no knowledge of the standard.
   In addition, there is no need to modify the application
   or to install any plugin or policy agent on the application container.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-support"></a>1.3.&nbsp;Quickly Add OAuth 2.0 &amp; OpenID Connect 1.0 Support</h2></div></div></div><p>
   OAuth 2.0 is modern federation alternative,
   aimed at making it easy for users to delegate
   third-party applications access to their protected resources
   without having to share credentials with the third-party applications.
   Like federation, OAuth 2.0 lets users benefit from new services
   without having to create new accounts.
   Instead they can use an existing account
   with an OAuth 2.0-compliant identity provider,
   such as Facebook, Google, or any provider using OpenAM.
   Many mobile and web applications are moving to use OAuth 2.0.
  </p><p>
   With OpenIG, you can add OAuth 2.0 support to existing protected resources,
   and use OpenIG capabilities to quickly develop new OAuth 2.0 applications.
   OpenIG can protect resources by using OAuth 2.0 (as resource server),
   interoperating with client applications and identity providers,
   so that your applications can
   rely on delegated authorization for access to users' protected resources.
  </p><p>
   The following figure shows OpenIG playing the role of resource server
   in an OAuth 2.0 authorization code grant flow.
  </p><div class="mediaobject" align="center"><a name="figure-oauth2-support"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/oauth2-support.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-oauth2-support.html" target="longdesc">D</a>]</span></div></div><p>
   OpenIG can also play the role of OAuth 2.0 client,
   authenticating an end user using OAuth 2.0 delegated authorization
   with an existing OAuth 2.0-compliant identity provider.
   This means developers can quickly develop OAuth 2.0 client applications
   without having to learn the intricacies of OAuth 2.0 authorization grant flows.
   OpenIG takes care of obtaining the access token
   on behalf of your application and injects the access token for your use.
  </p><p>
   OpenID Connect 1.0 is an implementation of OAuth 2.0
   whereby the protected resource is information about the user
   or about the user's account with the identity provider.
  </p><p>
   As OAuth 2.0 client, OpenIG can play the role
   of OpenID Connect 1.0 relying party, obtaining user information
   on behalf of your application.
  </p><p>
   The following figure shows OpenIG playing the role of relying party,
   where the mail server requires user information to show the right mailboxes.
  </p><div class="mediaobject" align="center"><a name="figure-oidc-support"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/oidc-support.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-oidc-support.html" target="longdesc">D</a>]</span></div></div><p>
   In addition, there is generally no need to modify
   existing applications or servers housing protected resources
   or to install plugins or policy agents on the servers.
  </p><p>
   OpenIG can for example inject user information into the URL,
   adding a <em class="replaceable"><code>username</code></em> as in
   <code class="literal">https://mail.example.com/mail/<em class="replaceable"><code>username</code></em></code>.
   For some applications, you might choose to provide additional capabilities,
   and so you might want to enhance the application to accept
   additional user information from the provider in other ways.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-howitworks"></a>Chapter&nbsp;2.&nbsp;How OpenIG Works</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#how-it-works-short">2.1. How It Works In A Nutshell</a></span></dt><dt><span class="section"><a href="#how-it-works-detail">2.2. How It Works In Detail</a></span></dt></dl></div><a class="indexterm" name="d851e344"></a><p>This chapter provides a detailed look at OpenIG components and how
 they work together.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="how-it-works-short"></a>2.1.&nbsp;How It Works In A Nutshell</h2></div></div></div><p>The underlying core of ForgeRock OpenIG is based on a
  <a class="link" href="http://en.wikipedia.org/wiki/Reverse_proxy" target="_blank">reverse proxy architecture</a>. All HTTP traffic to each protected
  application is routed through OpenIG, enabling close inspection,
  transformation and filtering of each request.  By inspecting the traffic,
  OpenIG is able to intercept requests that would normally require the user to
  authenticate, obtain the user's login credentials, and send the necessary
  HTTP request to the target application, thereby logging in the user without
  modifying or installing anything on the application.  In its simplest form
  and basic configuration, OpenIG is a Java-based reverse proxy which runs as
  a web application.  Enable the Form-Filter replay module and OpenIG
  automatically log users in when a timeout or authentication page is detected.
  Additionally, enable the SAML2 service and OpenIG becomes a SAML2
  endpoint. In this mode of operation, OpenIG receives
  and verifies the SAML2 request and then logs the user directly
  into the target application.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="how-it-works-detail"></a>2.2.&nbsp;How It Works In Detail</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#how-it-works-core">2.2.1. OpenIG Core (Reverse Proxy)</a></span></dt><dt><span class="section"><a href="#how-it-works-exchange">2.2.2. Exchange</a></span></dt><dt><span class="section"><a href="#how-it-works-router">2.2.3. Router &amp; Routes</a></span></dt><dt><span class="section"><a href="#how-it-works-dispatcher">2.2.4. Dispatcher</a></span></dt><dt><span class="section"><a href="#how-it-works-chain">2.2.5. Chain</a></span></dt><dt><span class="section"><a href="#how-it-works-handlers">2.2.6. Handlers</a></span></dt><dt><span class="section"><a href="#how-it-works-filters">2.2.7. Filters</a></span></dt><dt><span class="section"><a href="#how-it-works-configuration">2.2.8. Configuration</a></span></dt><dt><span class="section"><a href="#how-it-works-heaplets">2.2.9. Heaplets</a></span></dt><dt><span class="section"><a href="#how-it-works-saml2">2.2.10. OpenIG SAML 2.0 Federation</a></span></dt></dl></div><p>The following modules make up OpenIG.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-core"></a>2.2.1.&nbsp;OpenIG Core (Reverse Proxy)</h3></div></div></div><p>OpenIG core is a standard Java EE servlet implementation of a reverse
   proxy. The main function of OpenIG core is to act as a reverse proxy to the
   target application. When deployed in its base configuration, OpenIG can be
   used as a pure reverse proxy. The power of the OpenIG core comes in its
   ability to search, transform, and process HTTP traffic to and from the
   target application. This enables OpenIG to recognize login pages, submit
   login forms, transform or filter content, and even function as a Federation
   endpoint for the application.  All these features are possible without
   making any changes to the application's deployment container or the
   application itself.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-exchange"></a>2.2.2.&nbsp;Exchange</h3></div></div></div><p>The <a href="../reference/index.html#Exchange" class="link">Exchange</a> is a
   wrapper around the HTTP request and response objects that pass through
   OpenIG. Every request or response being processed in OpenIG can be accessed
   or modified through the Exchange object.  In addition, arbitrary data can
   be set in the Exchange to facilitate the passing of data and state between
   filters and handlers.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-router"></a>2.2.3.&nbsp;Router &amp; Routes</h3></div></div></div><p>
    In a multiple-file configuration, the
    <a href="../reference/index.html#Router" class="link">Router</a>
    takes responsibility for managing
    <a href="../reference/index.html#Route" class="link">Route</a> configurations.
   </p><p>
    Each Route accepts all Exchanges that match its (configurable) condition.
    The Route then optionally changes the request scheme, host, and port,
    and forwards the Exchange on to the configured chain of filters and handlers.
   </p><p>
    The Router can be configured either
    to load Route configurations only at startup
    or to reload Route configurations periodically,
    picking up any changes you make.
    You can thus reconfigure OpenIG without restarting the server.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-dispatcher"></a>2.2.4.&nbsp;Dispatcher</h3></div></div></div><p>
    In a single-file configuration with no Router,
    the Dispatcher may be thought of as the internal router of OpenIG.
    Every request that comes into OpenIG is analyzed
    and forwarded on to the configured processing chain of filters and handlers.
    A request may be forwarded based on
    the target host, URL, URL parameters, headers, cookies,
    or any other component of the request.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-chain"></a>2.2.5.&nbsp;Chain</h3></div></div></div><p>A <a href="../reference/index.html#Chain" class="link">Chain</a> is a
   combination of one or more Filters and a handler that process an incoming
   request from the Dispatcher. For example, the Dispatcher can process an
   incoming request with a URL parameter of <code class="literal">action=login</code>
   and forward the request to the Login Chain. The Login Chain executes a list
   of Filters and then calls a Handler. The Handler sends the request on to
   the target application or to another Chain for further processing.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-handlers"></a>2.2.6.&nbsp;Handlers</h3></div></div></div><p>The final processing of every Chain ends in a call to a Handler. A
   Handler can simply call another Chain or it can send the request on to the
   target application. The following Handlers are shipped with OpenIG:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <a href="../reference/index.html#ClientHandler" class="link">ClientHandler</a>: Sends the final request to the target application.
     </p><p>
      You can specify HTTP client settings for requests to remote servers
      by adding an
      <a href="../reference/index.html#HttpClient" class="link">HttpClient</a>
      in the configuration for the <code class="literal">ClientHandler</code>.
     </p></li><li class="listitem"><p>
      <a href="../reference/index.html#Router" class="link">Router</a>: Routes Exchange processing to separate configuration files.
     </p></li><li class="listitem"><p>
      <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a>: Handles a request by using a script.
     </p></li><li class="listitem"><p><a href="../reference/index.html#SequenceHandler" class="link">SequenceHandler</a>:
     Links together multiple handlers or chains during request
     processing.</p></li><li class="listitem"><p><a href="../reference/index.html#StaticResponseHandler" class="link">StaticResponseHandler</a>: Used to send a response, such as a
     redirect, to a client during request processing.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-filters"></a>2.2.7.&nbsp;Filters</h3></div></div></div><p>Filters are responsible for processing HTTP requests in OpenIG.
   Filters can be chained together to act on the input stream coming from the
   browser, or the  output stream returned back from the target application.
   A filter can do something as simple as logging the input and output stream
   or something more complex, such as processing login pages, fetching user
   attributes, or transforming content. There are multiple Filters shipped with
   OpenIG that can be combined in chains to provide very extensible request and
   response processing features. Custom filters can also be written using the
   Java SPIs. The following is a list of Filters shipped with OpenIG:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a href="../reference/index.html#AssignmentFilter" class="link">AssignmentFilter</a>:
     Sets values in the HTTP request and response.</p></li><li class="listitem"><p><a href="../reference/index.html#CaptureFilter" class="link">CaptureFilter</a>:
     Captures the HTTP requests being processed by OpenIG. Capture can be used
     for audit purposes and may also be very useful when analyzing an
     application or troubleshooting a misbehaving OpenIG. Logs are written to
     a flat file on the OpenIG host.</p></li><li class="listitem"><p><a href="../reference/index.html#CookieFilter" class="link">CookieFilter</a>:
     The default behavior of OpenIG is to accept and forward all cookies.
     Since this is not always the desirable behavior, the CookieFilter, when
     configured, allows you to suppress, manage, and relay cookies.</p></li><li class="listitem"><p><a href="../reference/index.html#EntityExtractFilter" class="link">EntityExtractFilter</a>: Searches for specific content within the body
     of the requests. For example, it can be used to extract hidden form
     parameters in a login page, which are needed in the login request.</p></li><li class="listitem"><p><a href="../reference/index.html#ExceptionFilter" class="link">ExceptionFilter</a>:
     Sends users to configured URLs when errors or exceptions occur during
     request processing or user interactions.</p></li><li class="listitem"><p><a href="../reference/index.html#FileAttributesFilter" class="link">FileAttributesFilter</a>: Looks up attributes in a flat file with the
     specified key. The attributes are added to the exchange to be used by
     subsequent filters or handlers.</p></li><li class="listitem"><p><a href="../reference/index.html#HeaderFilter" class="link">HeaderFilter</a>:
     The default behavior of OpenIG is to accept and forward all headers.
     The HeaderFilter can be configured to add additional headers or remove
     headers on both the HTTP request and the response. It can also be
     configured to parse and set header values in OpenIG context to allow
     filters access to the header attributes. This feature is used most
     commonly when OpenIG is integrated with OpenAM and being fronted by a
     policy agent.</p></li><li class="listitem"><p><a href="../reference/index.html#HttpBasicAuthFilter" class="link">HttpBasicAuthFilter</a>: Performs HTTP basic authentication to the
     target application per <a class="link" href="http://www.ietf.org/rfc/rfc2617.txt" target="_blank">RFC 2617</a>.</p></li><li class="listitem"><p>
      <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a>:
      acts as an OAuth 2.0 or OpenID Connect 1.0 client,
      authenticating an end user using OAuth 2.0 delegated authorization.
     </p></li><li class="listitem"><p>
      <a href="../reference/index.html#OAuth2ResourceServerFilter" class="link">OAuth2ResourceServerFilter</a>: acts as an OAuth 2.0 resource server,
      validating OAuth 2.0 access tokens,
      and injecting token information into the exchange.
     </p></li><li class="listitem"><p><a href="../reference/index.html#RedirectFilter" class="link">RedirectFilter</a>: Rewrites Location headers on responses that
     generate a redirect that would take the user directly to the application
     being proxied rather than taking the user through OpenIG.</p></li><li class="listitem"><p>
      <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>: Processes the HTTP exchange by using a script.
     </p></li><li class="listitem"><p><a href="../reference/index.html#SqlAttributesFilter" class="link">SqlAttributesFilter</a>: Executes an SQL prepared statement with
     configured parameters. The result is added to the exchange to be used by
     subsequent filters or handlers.</p></li><li class="listitem"><p><a href="../reference/index.html#StaticRequestFilter" class="link">StaticRequestFilter</a>: Creates and sends HTTP GET and POST requests.
     The request can be formed using parameters from previous processing or
     statically configured values.</p></li><li class="listitem"><p><a href="../reference/index.html#SwitchFilter" class="link">SwitchFilter</a>:
     Conditionally diverts the exchange to another handler.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-configuration"></a>2.2.8.&nbsp;Configuration</h3></div></div></div><p>The configuration of OpenIG was designed to be very modular and
   self-contained. Each module within OpenIG stores its configuration in JSON
   representation, which is stored in flat files. The
   features of OpenIG can be configured by directly manipulating the JSON flat
   files.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-heaplets"></a>2.2.9.&nbsp;Heaplets</h3></div></div></div><p>Every OpenIG module which has JSON configuration also has a Heaplet
   associated with it. Each module's Heaplet is responsible for reading the
   JSON configuration and creating that module's configuration in the OpenIG
   runtime heap. Each module can then read its configuration from the heap as
   well as make shared configuration information available to other
   modules.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="how-it-works-saml2"></a>2.2.10.&nbsp;OpenIG SAML 2.0 Federation</h3></div></div></div><p>
    When the Federation component is configured,
    OpenIG acts as the Service Provider in a Circle of Trust
    with a SAML 2.0-compliant Identity Provider.
    The Federation component supports both IDP and SP-initiated
    SAML 2.0 Web Single Sign-On.
    OpenIG Federation can serve as a a Service Provider
    in the classic Federation use case
    where the IDP and SP are different companies or domains.
    
   </p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-quickstart"></a>Chapter&nbsp;3.&nbsp;Getting Started</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#before-you-quickstart">3.1. Before You Begin</a></span></dt><dt><span class="section"><a href="#quickstart-install">3.2. Install OpenIG</a></span></dt><dt><span class="section"><a href="#quickstart-sample-app">3.3. Install an Application to Protect</a></span></dt><dt><span class="section"><a href="#quickstart-config">3.4. Configure OpenIG</a></span></dt><dt><span class="section"><a href="#quickstart-network-config">3.5. Configure the Network</a></span></dt><dt><span class="section"><a href="#quickstart-try-it-out">3.6. Try It Out</a></span></dt><dt><span class="section"><a href="#quickstart-where-to-go-from-here">3.7. Where To Go From Here</a></span></dt></dl></div><a class="indexterm" name="d851e556"></a><p>
  This chapter provides instructions to get OpenIG up and running on Jetty,
  configured to serve as reverse proxy
  to a minimal HTTP server for use when following along with the documentation.
  This allows you to quickly see how OpenIG works,
  and provides hands on experience with a few key features.
  For more general installation and configuration instructions,
  start with the chapter on
  <a href="../gateway-guide/index.html#chap-install" class="link"><em class="citetitle">Installing OpenIG</em></a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="before-you-quickstart"></a>3.1.&nbsp;Before You Begin</h2></div></div></div><p>
   Make sure you have a supported Java Development Kit installed.
   For details, see the <em class="citetitle">Release Notes</em> section,
   <a href="../release-notes/index.html#java-requirements" class="link"><em class="citetitle">JDK Version</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-install"></a>3.2.&nbsp;Install OpenIG</h2></div></div></div><p>
   You install OpenIG in the root context of a web application container.
   In this chapter, you use Jetty server as the web application container.
  </p><div class="procedure"><p>
    To perform initial installation, follow these steps.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download and unzip a supported version of Jetty server.
    </p><p>
     Supported versions are listed in the <em class="citetitle">Release Notes</em> section,
     <a href="../release-notes/index.html#which-container" class="link"><em class="citetitle">Web Application Containers</em></a>.
    </p></li><li class="step"><p>
     <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Download</a> the OpenIG .war file.
    </p></li><li class="step"><p>
     Deploy OpenIG in the root context.
    </p><p>
     Copy the OpenIG .war file as <code class="filename">root.war</code>
     to the <code class="filename">/path/to/jetty/webapps/</code>.
    </p><div class="screen"><pre>
$ <strong>cp OpenIG-3.0.0.war /path/to/jetty/webapps/root.war</strong>
    </pre></div><p>
     Jetty automatically deploys OpenIG in the root context on startup.
    </p></li><li class="step"><p>Start Jetty in the background:</p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh start</strong>
    </pre></div><p>Or start Jetty in the foreground:</p><div class="screen"><pre>
$ <strong>cd /path/to/jetty/</strong>
$ <strong>java -jar start.jar</strong>
    </pre></div></li><li class="step"><p>
     Verify that you can see the OpenIG welcome page at
     <a class="link" href="http://localhost:8080" target="_blank">http://localhost:8080</a>.
    </p><p>
     When you start OpenIG without a configuration,
     requests to OpenIG default to a welcome page
     with a link to the documentation.
    </p></li><li class="step"><p>
     Stop Jetty in the background:
    </p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh stop</strong>
    </pre></div><p>
     Or stop Jetty in the foreground
     by entering Ctrl+C in the terminal where Jetty is running.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-sample-app"></a>3.3.&nbsp;Install an Application to Protect</h2></div></div></div><p>
   Now that OpenIG is installed,
   set up a sample application to protect.
  </p><div class="procedure"><p>
    Follow these steps.
   </p><ol class="procedure" type="1"><li class="step"><p lang="en">
 Download and run the
 <a class="link" href="http://maven.forgerock.org/repo/releases/org/forgerock/openig/openig-doc-samples/3.0.0/openig-doc-samples-3.0.0-jar-with-dependencies.jar" target="_top">minimal HTTP server .jar</a>
 to use as the application to protect.
</p><div class="screen"><pre>
$ <strong>java -jar openig-doc-samples-3.0.0-jar-with-dependencies.jar</strong>
<em>Jun 11, 2014 4:32:42 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Starting HTTP server on port 8081
Jun 11, 2014 4:32:42 PM org.glassfish.grizzly.http.server.NetworkListener start
INFO: Started listener bound to [0.0.0.0:8081]
Jun 11, 2014 4:32:42 PM org.glassfish.grizzly.http.server.HttpServer start
INFO: [HttpServer] Started.
Jun 11, 2014 4:32:42 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Press Ctrl+C to stop the server.
</em>
    </pre></div><p>
     By default, this server listens on port 8081.
     If that port is not free, specify another port.
    </p><div class="screen"><pre>
$ <strong>java -jar openig-doc-samples-3.0.0-jar-with-dependencies.jar 8888</strong>
<em>Jun 11, 2014 4:33:04 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Starting HTTP server on port 8888
Jun 11, 2014 4:33:04 PM org.glassfish.grizzly.http.server.NetworkListener start
INFO: Started listener bound to [0.0.0.0:8888]
Jun 11, 2014 4:33:04 PM org.glassfish.grizzly.http.server.HttpServer start
INFO: [HttpServer] Started.
Jun 11, 2014 4:33:04 PM org.forgerock.openig.doc.SampleServer runServer
INFO: Press Ctrl+C to stop the server.</em>
    </pre></div></li><li class="step"><p>
     Now access the minimal HTTP server through a browser at
     <a class="link" href="http://localhost:8081" target="_blank">http://localhost:8081</a>.
    </p><p>
     Login with username <code class="literal">demo</code>,
     password <code class="literal">changeit</code>.
     You should see a page that includes the username, <code class="literal">demo</code>,
     and some information about your browser request.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-config"></a>3.4.&nbsp;Configure OpenIG</h2></div></div></div><p>
   Now that you have installed both OpenIG
   and also a sample application to protect,
   and configure OpenIG.
  </p><div class="procedure"><p>
    Follow these steps to configure OpenIG
    to proxy traffic to the sample application.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Prepare the OpenIG configuration.
    </p><p>
     Copy the basic configuration file from the example,
     <a href="../gateway-guide/index.html#config-proxy-and-capture" class="link"><em class="citetitle">Configuration for Proxy &amp; Capture</em></a>,
     to <code class="filename">$HOME/.openig/config/config.json</code>.
     By default, OpenIG looks for <code class="filename">config.json</code>
     in the <code class="filename">$HOME/.openig/config</code> directory.
    </p><div class="screen"><pre>
$ <strong>mkdir -p $HOME/.openig/config</strong>
$ <strong>cp config.json $HOME/.openig/config/config.json</strong>
    </pre></div><p>
     On Windows, the configuration files belong in
     <code class="filename">%appdata%\.openig\config</code>.
     To locate the <code class="filename">%appdata%</code> folder
     for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create the <code class="filename">%appdata%\.openig\config</code> folder,
     and then copy the configuration files.
    </p><p>
     Also on Windows, change the capture log file name
     in <code class="filename">config.json</code>
     from <code class="filename">/tmp/gateway.log</code>
     to a file system location that works for Windows systems,
     such as <code class="filename">C:\Temp\gateway.log</code>.
    </p></li><li class="step"><p>Start Jetty in the background:</p><div class="screen"><pre>
$ <strong>/path/to/jetty/bin/jetty.sh start</strong>
    </pre></div><p>Or start Jetty in the foreground:</p><div class="screen"><pre>
$ <strong>cd /path/to/jetty/</strong>
$ <strong>java -jar start.jar</strong>
    </pre></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-network-config"></a>3.5.&nbsp;Configure the Network</h2></div></div></div><p>
   So far you have deployed OpenIG in the root context of Jetty on port 8080.
   Since OpenIG is a reverse proxy you must make sure
   that all traffic from your browser to the protected application
   goes through OpenIG.
   In other words, the network must be configured
   so that the browser goes to OpenIG
   instead of going directly to the protected application.
  </p><p>
   Although if you followed the installation steps you are running
   both OpenIG and the minimal HTTP server
   on the same host as your browser (probably your laptop or desktop),
   keep in mind that network configuration is an important deployment step.
   To encourage you to keep this in mind,
   the sample configuration for this chapter expects the minimal HTTP server
   to be running on <code class="literal">www.example.com</code>,
   rather than <code class="literal">localhost</code>.
  </p><p>
   The quickest way to configure the network locally is to add an entry to your
   <code class="filename">/etc/hosts</code> file on UNIX systems
   or <code class="filename">%SystemRoot%\system32\drivers\etc\hosts</code> on Windows.
   See the Wikipedia entry,
   <a class="link" href="http://en.wikipedia.org/wiki/Hosts_(file)" target="_blank"><em class="citetitle">Hosts (file)</em></a>,
   for more information on host files.
   If you are indeed running all servers in this chapter on the same host,
   add the following entry to the hosts file.
  </p><pre class="brush: plain;">127.0.0.1    www.example.com</pre><p>
   If you are running the browser and OpenIG on separate hosts,
   add the IP address of the host running OpenIG
   to the hosts file on the system running the browser,
   where the host name matches that of protected application.
   For example, if OpenIG is running on a host with IP address 192.168.0.15:
  </p><pre class="brush: plain;">192.168.0.15    www.example.com</pre><p>
   If OpenIG is on a different host from the protected application,
   also make sure that the host name of the protected application
   resolves correctly for requests from OpenIG to the application.
  </p><div class="tip"><h3 class="title">Tip</h3><p>
    Some browsers cache IP address resolutions,
    even after clearing all browsing data.
    Restart the browser after changing the IP addresses of named hosts.
  </p><p>
    The simplest way to make sure you have configured
    your DNS or host settings properly for remote systems is to stop OpenIG
    and then to make sure you cannot reach the target application
    with the host name and port number of OpenIG.
    If you can still reach it, double check your host settings.
  </p><p>
    Also make sure name resolution is configured to check host files before DNS.
    This configuration can be found in <code class="filename">/etc/nsswitch.conf</code>
    for most UNIX systems.
    Make sure <code class="literal">files</code> is listed before <code class="literal">dns</code>.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-try-it-out"></a>3.6.&nbsp;Try It Out</h2></div></div></div><p>
   <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>
   should take you to the home page of the minimal HTTP server.
  </p><div class="orderedlist"><p>
    Now change the OpenIG configuration to log you in automatically
    with hard-coded credentials.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Edit the configuration file, <code class="filename">config.json</code>,
     to automatically log you in as username <code class="literal">demo</code>,
     password <code class="literal">password</code>.
    </p><div class="orderedlist"><p>
      To do this, make the following two changes to the file.
     </p><ol class="orderedlist" type="a"><li class="listitem"><p>
       Between the <code class="literal">"OutgoingChain"</code> object
       and the "CaptureFilter" object,
       add a new <code class="literal">StaticRequestFilter</code> configuration object.
      </p><p>
       The <code class="literal">StaticRequestFilter</code> performs
       an HTTP POST of the username and password as form data.
       OpenIG supports a variety of ways to get the credentials,
       but for now just hard code them into the configuration.
      </p><p>
       The new filter configuration object should look like this:
      </p><pre class="brush: javascript;">
{
    "name": "LoginRequest",
    "type": "StaticRequestFilter",
    "config": {
        "method": "POST",
        "uri": "http://www.example.com:8081",
        "form": {
            "username": [
                "demo"
            ],
            "password": [
                "changeit"
            ]
        }
    }
}
      </pre><p>
       Do not forget to add the comma after the object,
       so that your configuration file remains valid JSON.
      </p></li><li class="listitem"><p>
       Edit the list of filters in the "OutgoingChain" object
       to include your new filter before the "CaptureFilter".
      </p><p>
       The full "OutgoingChain" object should now look like this:
      </p><pre class="brush: javascript;">
{
    "name": "OutgoingChain",
    "type": "Chain",
    "config": {
        "filters": [
            "LoginRequest",
            "CaptureFilter"
        ],
        "handler": "DefaultHandler"
    }
}
      </pre></li></ol></div><p>
     Make sure that the configuration is valid JSON,
     and then save your changes.
    </p><p>
     The resulting configuration file should be very close to the example,
     <a href="../gateway-guide/index.html#config-login-static-request" class="link"><em class="citetitle">Configuration for Hard-Coded Credentials</em></a>.
    </p></li><li class="listitem"><p>
     Restart the Jetty server where OpenIG is deployed.
    </p></li><li class="listitem"><p>
     Access the home page again,
     <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>.
    </p><p>
     This time, OpenIG logs you in automatically.
    </p></li></ol></div><p>
   Also view the file capturing information about requests and responses.
   In the default sample configuration,
   this file is <code class="filename">/tmp/gateway.log</code>.
  </p><p>
   What's happening behind the scenes?
  </p><p>
   When your browser goes to <code class="literal">http://www.example.com:8080/</code>,
   it is actually connecting to OpenIG deployed in Jetty.
   OpenIG proxies all traffic it receives to the protected application at
   <code class="literal">http://www.example.com:8080/</code>,
   and returns responses from the application to your browser.
  </p><p>
   With the original configuration,
   OpenIG does not change requests or responses,
   but only proxies requests and responses,
   and captures request and response information.
  </p><p>
   After you change the configuration,
   OpenIG continues to capture request and response data.
   And OpenIG also replaces your browser's original HTTP GET request
   with an HTTP POST login request containing credentials to authenticate.
   As a result, instead of the home page with a login form,
   OpenIG logs you in directly,
   and the application responds with the page you see after logging in.
   OpenIG then returns this response to your browser.
  </p><p>
   The following sequence diagram shows the steps.
  </p><div class="figure"><a name="figure-hard-coded-login"></a><div class="figure-title">Figure&nbsp;3.1.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/hard-coded-login.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d851e925.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     The browser host makes a DNS request for
     the IP address of the HTTP server host, <code class="literal">www.example.com</code>.
    </p></li><li class="listitem"><p>
     DNS responds with the address for OpenIG.
    </p></li><li class="listitem"><p>
     Browser sends a request to the HTTP server.
    </p></li><li class="listitem"><p>
     OpenIG replaces the request with an HTTP POST request,
     including the login form with hard-coded credentials.
    </p></li><li class="listitem"><p>
     HTTP server validates the credentials,
     and responds with the profile page.
    </p></li><li class="listitem"><p>
     OpenIG passes the response back to the browser.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart-where-to-go-from-here"></a>3.7.&nbsp;Where To Go From Here</h2></div></div></div><p>
   In this chapter, you have scratched the surface of OpenIG.
   For more information, start with these chapters.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><a href="../gateway-guide/index.html#chap-usecases" class="link"><em class="citetitle">Detailed Use Cases</em></a>
    </span></dt><dd><p>
      This chapter covers common use case request and response flows.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-install" class="link"><em class="citetitle">Installing OpenIG</em></a>
    </span></dt><dd><p>
      This chapter covers everything you need to install OpenIG.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-credentials-tutorial" class="link"><em class="citetitle">Tutorial On Looking Up Credentials</em></a>
    </span></dt><dd><p>
      This chapter shows you how to configure OpenIG
      to look up credentials in external sources, such as a file or a database.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-gateway-templates" class="link"><em class="citetitle">Configuration Templates</em></a>
    </span></dt><dd><p>
      This chapter provides sample OpenIG configuration files
      for common use cases.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-federation-tutorial" class="link"><em class="citetitle">Tutorial For OpenIG Federation</em></a>
    </span></dt><dd><p>
      This chapter shows how to configure OpenIG to get credentials
      from a SAML 2.0 Identity Provider.
     </p></dd><dt><span class="term"><span class="olink"><em class="citetitle">Configuring OpenIG as an OAuth 2.0 Resource Server</em></span>
    </span></dt><dd><p>
      This chapter explains how OpenIG acts
      as an OAuth 2.0 Resource Server,
      and follows with a tutorial
      that shows you how to use OpenIG as a resource server.
     </p></dd><dt><span class="term"><span class="olink"><em class="citetitle">Configuring OpenIG as an OAuth 2.0 Client</em></span>
    </span></dt><dd><p>
      This chapter explains how OpenIG acts
      as an OAuth 2.0 client or OpenID Connect 1.0 relying party,
      and follows with a tutorial
      that shows you how to use OpenIG
      as an OpenID Connect 1.0 relying party.
     </p></dd><dt><span class="term"><a href="../gateway-guide/index.html#chap-routing" class="link"><em class="citetitle">Routing Tutorial</em></a>
    </span></dt><dd><p>
      This chapter shows how to configure OpenIG
      to allow dynamic configuration changes and route to multiple applications.
     </p></dd></dl></div><p>
   ForgeRock can also help you succeed in your projects involving OpenIG.
   You can purchase OpenIG support subscriptions and training courses
   from ForgeRock and from consulting partners around the world and in your area.
   To contact ForgeRock, send mail to
   <a class="link" href="mailto:info@forgerock.com" target="_top">info@forgerock.com</a>.
   To find a partner in your area, see
   <a class="link" href="http://forgerock.com/partners/find-a-partner/" target="_blank">http://forgerock.com/partners/find-a-partner/</a>.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-install"></a>Chapter&nbsp;4.&nbsp;Installing OpenIG</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#configure-container">4.1. Configuring Deployment Containers</a></span></dt><dt><span class="section"><a href="#configure-network">4.2. Preparing the Network</a></span></dt><dt><span class="section"><a href="#install">4.3. Installing OpenIG</a></span></dt></dl></div><p>
  This chapter covers everything you need to install OpenIG.
 </p><a class="indexterm" name="d851e1044"></a><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Make sure you have a supported Java version installed.
   </p><p>
    See the <em class="citetitle">Release Notes</em> section,
    <a href="../release-notes/index.html#java-requirements" class="link"><em class="citetitle">JDK Version</em></a>, for details.
   </p></li><li class="listitem"><p>
    Prepare a deployment container.
   </p><p>
    For details, see <a class="xref" href="#configure-container" title="4.1.&nbsp;Configuring Deployment Containers">Section&nbsp;4.1, &#8220;Configuring Deployment Containers&#8221;</a>.
   </p></li><li class="listitem"><p>
    Prepare the network to use OpenIG as a reverse proxy.
   </p><p>
    For details, see <a class="xref" href="#configure-network" title="4.2.&nbsp;Preparing the Network">Section&nbsp;4.2, &#8220;Preparing the Network&#8221;</a>.
   </p></li><li class="listitem"><p>
    Download, deploy, and configure OpenIG.
   </p><p>
    For details, see <a class="xref" href="#install" title="4.3.&nbsp;Installing OpenIG">Section&nbsp;4.3, &#8220;Installing OpenIG&#8221;</a>.
   </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-container"></a>4.1.&nbsp;Configuring Deployment Containers</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#about-securing-connections">4.1.1. About Securing Connections</a></span></dt><dt><span class="section"><a href="#tomcat">4.1.2. Configuring Apache Tomcat For OpenIG</a></span></dt><dt><span class="section"><a href="#jetty">4.1.3. Configuring Jetty For OpenIG</a></span></dt></dl></div><p>
   This section provides installation and configuration tips
   that you need to run OpenIG in supported containers.
  </p><p>
   For the full list of supported containers,
   see the <em class="citetitle">Release Notes</em> section,
   <a href="../release-notes/index.html#which-container" class="link"><em class="citetitle">Web Application Containers</em></a>.
  </p><p>
   For further information on advanced configuration for a particular container,
   see the container documentation.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="about-securing-connections"></a>4.1.1.&nbsp;About Securing Connections</h3></div></div></div><p>
    OpenIG is often deployed to replay credentials
    or other security information.
    In a real world deployment,
    that information must be communicated over a secure connection using HTTPS,
    meaning in effect HTTP over encrypted Transport Layer Security (TLS).
    Never send real credentials, bearer tokens, or other security information
    unprotected over HTTP.
   </p><p>
    The web application container where OpenIG runs
    is responsible for setting up TLS connections.
   </p><p>
    TLS depends on the use of digital certificates (public keys).
    In typical use of TLS,
    the client authenticates the server by its X.509 digital certificate
    as the first step to establishing communication.
    Once trust is established,
    then the client and server can set up
    a symmetric key to encrypt communications.
   </p><p>
    In order for the client to trust the server certificate,
    the client needs first to trust
    the certificate of the party who signed the server's certificate.
    This means that either the client
    has a trusted copy of the signer's certificate,
    or the client has a trusted copy
    of the certificate of the party who signed the signer's certificate.
   </p><p>
    Certificate Authorities (CAs) are trusted signers
    with well-known certificates.
    Browsers generally ship with with many well-known CA certificates.
    Java distributions also ship with many well-known CA certificates.
    Getting a certificate signed by a well-known CA generally costs money.
   </p><p>
    It is also possible for you to self-sign certificates.
    The trade off is that although you do not have to pay any money,
    the certificate is not trusted by any clients until they have a copy.
    Whereas it is often enough
    to install a certificate signed by a well-known CA
    in the server key store as the basis of trust for HTTPS connections,
    self-signed certificates must also be installed in all clients.<a href="#ftn.d851e1112" class="footnote" name="d851e1112"><sup class="footnote">[1]</sup></a>
   </p><p>
    This guide describes how to install self-signed certificates,
    which are certainly fine for trying out the software
    and okay for deployments where you manage all clients
    that access OpenIG.
    If you need a well-known CA signed certificate instead,
    see the documentation for your container for details
    on requesting a CA signature and installing the CA signed certificate.
   </p><p>
    Once certificates are properly installed to allow client-server trust,
    also consider the cipher suites configured for use.
    The cipher suite used determines the security settings for the communication.
    Initial TLS negotiations bring the client and server to agreement on which
    cipher suite to use.
    Basically the client and server share their preferred cipher suites
    to compare and to choose.
    If you therefore have a preference concerning the cipher suites to use,
    you must set up your container to use only your preferred cipher suites.
    Otherwise the container is likely to inherit the list of cipher suites
    from the underlying Java environment.
   </p><p>
    The Java Secure Socket Extension (JSSE), part of the Java environment,
    provides security services that OpenIG uses to secure connections.
    You can set security and system properties to configure the JSSE.
    For example, you can set the key store and password,
    the trust store and password (useful when OpenIG acts as a client),
    the cipher suites to enable for use, and other properties.
    For a list of properties you can use to customize the JSSE in Oracle Java,
    see the <em class="citetitle">Customization</em> section of the
    <a class="link" href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/jsse/JSSERefGuide.html#Customization" target="_blank"><em class="citetitle">JSSE Reference Guide</em></a>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tomcat"></a>4.1.2.&nbsp;Configuring Apache Tomcat For OpenIG</h3></div></div></div><p>
    This section describes essential Apache Tomcat configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d851e1149"></a><p>
    Download and install a supported version of Apache Tomcat from
    <a class="link" href="http://tomcat.apache.org/" target="_blank">http://tomcat.apache.org/</a>.
   </p><p>
    Configure Tomcat to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Tomcat to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Tomcat to do so as well.
   </p><p>
    To configure Tomcat to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-cookie-domains"></a>4.1.2.1.&nbsp;Configuring Tomcat Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Tomcat to set domain cookies.
     To do this, add a session cookie domain context element
     that specifies the domain to
     <code class="filename">/path/to/conf/Catalina/<em class="replaceable"><code>server</code></em>/root.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Context sessionCookieDomain=".example.com" /&gt;

    </pre><p>
     Restart Tomcat to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-https"></a>4.1.2.2.&nbsp;Configuring Tomcat For HTTPS</h4></div></div></div><p>
     To get Tomcat up quickly on an SSL port
     add an entry similar to the following in
     <code class="filename">/path/to/tomcat/conf/server.xml</code>.
    </p><pre class="brush: xml;">
&lt;Connector
 port="8443"
 protocol="HTTP/1.1"
 SSLEnabled="true"
 maxThreads="150"
 scheme="https"
 secure="true"
 address="127.0.0.1"
 clientAuth="false"
 sslProtocol="TLS"
 keystoreFile="/path/to/tomcat/conf/keystore"
 keystorePass="password"
/&gt;

    </pre><p>
     Also create a key store holding a self-signed certificate.
    </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias tomcat \
 -keyalg RSA \
 -keystore /path/to/tomcat/conf/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
    </pre></div><p>
     Notice the key store file location and the key store password
     both match the configuration.
     By default, Tomcat looks for a certificate with alias <code class="literal">tomcat</code>.
    </p><p>
     Restart Tomcat to read the configuration changes.
    </p><p>
     Browsers generally do not trust self-signed certificates.
     To work with a certificate signed instead by a trusted CA,
     see the Apache Tomcat documentation on configuring HTTPS.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tomcat-mysql"></a>4.1.2.3.&nbsp;Configuring Tomcat to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Apache Tomcat to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/tomcat/lib/</code>
       so that it is on Tomcat's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/tomcat/conf/context.xml</code>.
      </p><pre class="brush: xml;">
&lt;Resource
 name="jdbc/forgerock"
 auth="Container"
 type="javax.sql.DataSource"
 maxActive="100"
 maxIdle="30"
 maxWait="10000"
 username="mysqladmin"
 password="password"
 driverClassName="com.mysql.jdbc.Driver"
 url="jdbc:mysql://localhost:3306/databasename"
/&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/tomcat/conf/web.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Tomcat to read the configuration changes.
      </p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jetty"></a>4.1.3.&nbsp;Configuring Jetty For OpenIG</h3></div></div></div><p>
    This section describes essential Jetty configuration
    that you need in order to run OpenIG.
   </p><a class="indexterm" name="d851e1249"></a><p>
    Download and install a supported version of Jetty from
    <a class="link" href="http://download.eclipse.org/jetty/" target="_blank">http://download.eclipse.org/jetty/</a>.
   </p><p>
    Configure Jetty to use the same protocol
    as the application you are protecting with OpenIG.
    If the protected application is on a remote system,
    configure Jetty to use the same port as well.
    If your application listens on both an HTTP and an HTTPS port,
    then you must configure Jetty to do so as well.
   </p><p>
    To configure Jetty to use an HTTP port other than 8080,
    modify the defaults in <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
    Search for the default value of 8080 and replace it with the new port number.
   </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-cookie-domains"></a>4.1.3.1.&nbsp;Configuring Jetty Cookie Domains</h4></div></div></div><p>
     If you use OpenIG for more than a single protected application
     and the protected applications are on different hosts,
     then you must configure Jetty to set domain cookies.
     To do this, add a session domain handler element
     that specifies the domain to
     <code class="filename">/path/to/jetty/etc/jetty.xml</code>,
     as in the following example.
    </p><pre class="brush: xml;">
&lt;Get name="sessionHandler"&gt;
    &lt;Get name="sessionManager"&gt;
        &lt;Set name="sessionDomain"&gt;.example.com&lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Get&gt;

    </pre><p>
     Restart Jetty to read the configuration changes.
    </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-https"></a>4.1.3.2.&nbsp;Configuring Jetty For HTTPS</h4></div></div></div><p>
    To get Jetty up quickly on an SSL port, follow the steps in this section.
   </p><p>
    These steps involve replacing the built-in key store with your own.
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
      If you have not done so already, remove the built-in key store.
     </p><div class="screen"><pre>
$ <strong>rm /path/to/jetty/etc/keystore</strong>
     </pre></div></li><li class="step"><p>
      Generate a new key pair with self-signed certificate in the key store.
     </p><div class="screen"><pre>
$ <strong>keytool \
 -genkey \
 -alias jetty \
 -keyalg RSA \
 -keystore /path/to/jetty/etc/keystore \
 -storepass password \
 -keypass password \
 -dname "CN=openig.example.com,O=Example Corp,C=FR"</strong>
     </pre></div></li><li class="step"><p>
      Find the obfuscated form of the password.
     </p><div class="screen"><pre>
$ <strong>java \
 -cp /path/to/jetty/lib/jetty-util-*.jar \
 org.eclipse.jetty.util.security.Password \
 password</strong>
<em>password
OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v
MD5:5f4dcc3b5aa765d61d8327deb882cf99</em>
     </pre></div></li><li class="step"><p>
      Edit the SSL Context Factory entry in the Jetty configuration file,
      <code class="filename">/path/to/jetty/etc/jetty-ssl.xml</code>.
     </p><pre class="brush: xml;">
&lt;New id="sslContextFactory" class="org.eclipse.jetty.http.ssl.SslContextFactory"&gt;
  &lt;Set name="KeyStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="KeyStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="KeyManagerPassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
  &lt;Set name="TrustStore"&gt;&lt;Property name="jetty.home" default="." /&gt;/etc/keystore&lt;/Set&gt;
  &lt;Set name="TrustStorePassword"&gt;OBF:1v2j1uum1xtv1zej1zer1xtn1uvk1v1v&lt;/Set&gt;
&lt;/New&gt;

   </pre></li><li class="step"><p>
      Uncomment the line specifying that configuration file in
      <code class="filename">/path/to/jetty/start.ini</code>.
     </p><pre class="brush: ini;">
etc/jetty-ssl.xml
     </pre></li><li class="step"><p>
      Restart Jetty.
     </p></li><li class="step"><p>
      Browse <a class="link" href="https://www.example.com:8443" target="_blank">https://www.example.com:8443</a>.
     </p><p>
      You should see a warning in the browser
      that the (self-signed) certificate is not recognized.
     </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jetty-mysql"></a>4.1.3.3.&nbsp;Configuring Jetty to Access MySQL Over JNDI</h4></div></div></div><p>
     If OpenIG accesses an SQL database,
     then you must configure Jetty to access the database over JNDI.
     To do so, you must add the driver jar for the database,
     set up a JNDI data source, and set up a reference to that data source.
    </p><div class="orderedlist"><p>
      The following steps are for MySQL Connector/J.
     </p><ol class="orderedlist" type="1"><li class="listitem"><p>
       Download the MySQL JDBC Driver Connector/J from
       <a class="link" href="http://dev.mysql.com/downloads/connector/j" target="_blank">http://dev.mysql.com/downloads/connector/j</a>.
      </p></li><li class="listitem"><p>
       Copy the driver .jar to <code class="filename">/path/to/jetty/lib/jndi/</code>
       so that it is on Jetty's class path.
      </p></li><li class="listitem"><p>
       Add a JNDI data source for your MySQL server and database in
       <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
      </p><pre class="brush: xml;">
&lt;New id="jdbc/forgerock" class="org.eclipse.jetty.plus.jndi.Resource"&gt;
  &lt;Arg&gt;&lt;/Arg&gt;
  &lt;Arg&gt;jdbc/forgerock&lt;/Arg&gt;
  &lt;Arg&gt;
    &lt;New class="com.mysql.jdbc.jdbc2.optional.MysqlConnectionPoolDataSource"&gt;
      &lt;Set name="Url"&gt;jdbc:mysql://localhost:3306/databasename&lt;/Set&gt;
      &lt;Set name="User"&gt;mysqladmin&lt;/Set&gt;
      &lt;Set name="Password"&gt;password&lt;/Set&gt;
    &lt;/New&gt;
  &lt;/Arg&gt;
&lt;/New&gt;

      </pre></li><li class="listitem"><p>
       Add a resource reference to the data source in
       <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
      </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;description&gt;MySQL Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

      </pre></li><li class="listitem"><p>
       Restart Jetty to read the configuration changes.
      </p></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-network"></a>4.2.&nbsp;Preparing the Network</h2></div></div></div><p>
   In order for OpenIG to function as a reverse proxy,
   browsers attempting to access the protected application
   must go through OpenIG instead.
  </p><p>
   Modify DNS or host file settings so that
   the host name of the protected application
   resolves to the IP address of OpenIG
   on the system where the browser runs.
  </p><p>
   Restart the browser after making this change.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install"></a>4.3.&nbsp;Installing OpenIG</h2></div></div></div><div class="procedure"><p>
    Follow these steps to install OpenIG.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Download the OpenIG.
    </p><div class="itemizedlist"><p>
      OpenIG can be downloaded from these locations.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.com/download-stack/" target="_blank">Enterprise Software Downloads</a> page
       provides thoroughly validated release builds
       for ForgeRock customers who run OpenIG in production deployments,
       and for those who want to try or test with release builds.
      </p><p>
       Use this build with officially released project documentation from
       <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.
      </p><p>
       Make sure you review and agree with
       the Software License and Subscription Agreement
       in order to use the software.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-builds/" target="_blank">Nightly Builds</a> page
       offers the very latest successful nightly build of the latest code.
      </p><p>
       Use this build to get a preview of the latest features and fixes,
       when reading along with the draft documentation.
      </p></li><li class="listitem"><p>
       The
       <a class="link" href="http://forgerock.org/downloads/openig-archive/" target="_blank">Archive</a> page
       makes older builds available.
      </p></li></ul></div></li><li class="step"><p>
     Deploy the OpenIG .war <span class="emphasis"><em>to the root context</em></span>
     of the web application container.
    </p><p>
     OpenIG must be deployed to the root context, not below.
    </p></li><li class="step"><p>
     Prepare your OpenIG configuration files.
    </p><div class="variablelist"><p>
      By default, OpenIG files are located under
      <code class="filename">$HOME/.openig</code> on Linux, Mac OS X, and UNIX systems,
      and <code class="filename">%appdata%\.openig</code> on Windows systems.
      OpenIG uses the following file system directories.
     </p><dl class="variablelist"><dt><span class="term"><code class="filename">$HOME/.openig/config</code>, </span><span class="term"><code class="filename">%appdata%\.openig\config</code></span></dt><dd><p>
        OpenIG configuration files,
        where the main configuration file is <code class="filename">config.json</code>.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/config/routes</code>, </span><span class="term"><code class="filename">%appdata%\.openig\config\routes</code></span></dt><dd><p>
        OpenIG configuration files,
        where the main configuration file is <code class="filename">config.json</code>.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML</code>, </span><span class="term"><code class="filename">%appdata%\.openig\SAML</code></span></dt><dd><p>
        OpenIG SAML 2.0 configuration files.
       </p><p>
        See the chapter,
        <a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">Using OpenIG Federation</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/scripts/groovy</code>, </span><span class="term"><code class="filename">%appdata%\.openig\scripts\groovy</code></span></dt><dd><p>
        OpenIG script files, for Groovy scripted filters and handlers.
       </p><p>
        See the chapter,
        <a href="../gateway-guide/index.html#chap-scripting" class="link"><em class="citetitle">Scripting Filters &amp; Handlers</em></a>,
        for more information.
       </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/tmp</code>, </span><span class="term"><code class="filename">%appdata%\.openig\SAML</code></span></dt><dd><p>
        OpenIG temporary files.
       </p><p>
        This location can be used for capture files and temporary storage.
       </p></dd></dl></div><div class="itemizedlist"><p>
      You can change <code class="filename">$HOME/.openig</code>
      (or <code class="filename">%appdata%\.openig</code>)
      from the default location in the following ways.
     </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Unpack the OpenIG .war,
       and edit the <code class="filename">WEB-INF/web.xml</code> application descriptor
       to set the <code class="literal">openig-base</code> initialization parameter
       to the full path to the base location for OpenIG files,
       as in the following example.
      </p><pre class="brush: xml;">

 &lt;servlet&gt;
   &lt;servlet-name&gt;GatewayServlet&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.forgerock.openig.servlet.GatewayServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
     &lt;param-name&gt;openig-base&lt;/param-name&gt;
     &lt;param-value&gt;/path/to/openig/files&lt;/param-value&gt;
   &lt;/init-param&gt;
 &lt;/servlet&gt;

      </pre></li><li class="listitem"><p>
       Set the <code class="literal">OPENIG_BASE</code> environment variable
       to the full path to the base location for OpenIG files.
      </p><div class="screen"><pre>
# On Linux, Mac OS X, and UNIX using Bash
$ <strong>export OPENIG_BASE=/path/to/openig/files</strong>

# On Windows
C:&gt;<strong>set OPENIG_BASE=c:\path\to\openig\files</strong>
      </pre></div></li><li class="listitem"><p>
       Set the <code class="literal">openig.base</code> Java system property
       to the full path to the base location for OpenIG files
       when starting the web application container where OpenIG runs,
       as in the following example that starts Jetty server in the foreground.
      </p><div class="screen"><pre>
$ <strong>java -Dopenig.base=/path/to/openig/files -jar start.jar</strong>
      </pre></div></li></ul></div><p>
     If you have not yet prepared configuration files, then start with the
     <a href="../gateway-guide/index.html#config-proxy-and-capture" class="link"><em class="citetitle">Configuration for Proxy &amp; Capture</em></a>.
    </p><p>
     Copy the template to <code class="filename">$HOME/.openig/config/config.json</code>.
     Replace the "baseURI" of the "DispatchHandler"
     with that of the protected application.
    </p><p>
     On Windows,
     copy the template to <code class="filename">%appdata%\.openig\config\config.json</code>.
     To locate the <code class="filename">%appdata%</code> folder
     for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create the <code class="filename">%appdata%\.openig\config</code> folder,
     and then add the configuration file.
    </p><p>
     On Windows,
     also edit the location of the capture log file.
    </p></li><li class="step"><p>
     Start the web container where OpenIG is deployed.
    </p></li><li class="step"><p>
     Browse to the protected application.
    </p><p>
     OpenIG should now proxy all traffic to the application.
    </p></li><li class="step"><p>
     Make sure the browser is going through OpenIG.
    </p><p>
     Verify this in one of the following ways.
    </p><ul class="stepalternatives">
     <li class="step"><ol type="a" class="substeps"><li class="step"><p>
         Stop the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you cannot browse to the protected application.
        </p></li><li class="step"><p>
         Start the OpenIG web container.
        </p></li><li class="step"><p>
         Verify that you can now browse to the protected application again.
        </p></li></ol></li>

     <li class="step"><p>
       Check the capture log to see that traffic is going through OpenIG.
      </p><p>
       The location for the capture log is set in <code class="filename">config.json</code>,
       by default <code class="filename">/tmp/gateway.log</code>.
      </p></li>
    </ul></li></ol></div></div><div class="footnotes"><br><hr class="footnote-hr"><div id="ftn.d851e1112" class="footnote"><p><a href="#d851e1112" class="para"><sup class="para">[1] </sup></a>
      When OpenIG acts as a client
      of a protected application or other server
      whose certificate is not recognized out of the box by the Java environment,
      then you must also install that certificate
      in the key store for the OpenIG web application container.
     </p><p>
      The following command installs a trusted signer's certificate,
      <code class="filename">ca.crt</code>, in a Java Key Store file.
     </p><div class="screen"><pre>
$ <strong>keytool \
 -import \
 -trustcacerts \
 -keystore /path/to/container/keystore \
 -file ca.crt \
 -alias ca-cert \
 -storepass password</strong>
     </pre></div><p>
      The <code class="option">-trustcacerts</code> option says
      to trust this as a signing certificate,
      and so works both with self-signed certificates
      and also with certificates used to sign server certificates.
     </p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-usecases"></a>Chapter&nbsp;5.&nbsp;Detailed Use Cases</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#portal-app-login">5.1. Portal Application Login</a></span></dt><dt><span class="section"><a href="#am-integration">5.2. OpenAM Integration</a></span></dt><dt><span class="section"><a href="#sp-initiated-sso">5.3. OpenIG Federation SP Initiated SAML 2.0 SSO</a></span></dt><dt><span class="section"><a href="#idp-initiated-sso">5.4. OpenIG Federation IDP Initiated SAML 2.0 SSO</a></span></dt></dl></div><p>This chapter diagrams and describes common use case request and
 response flows.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portal-app-login"></a>5.1.&nbsp;Portal Application Login</h2></div></div></div><a class="indexterm" name="d851e1636"></a><p>The figure below illustrates a sample flow with a description of each
  request from the browser to the back end application.
  This flow is based on the tutorial,
  <a href="../gateway-guide/index.html#tutorial-credentials-from-file" class="link"><em class="citetitle">Login With Credentials From a File</em></a>.
  Try the tutorial yourself to learn how
  OpenIG works. The Flat-File attribute store contains only one set of
  credentials. OpenIG makes the assumption this user is logging into the
  sample application. In a real deployment OpenIG would look up the user
  credentials using its own session, a SAML 2.0 assertion, or a header from an
  OpenAM policy agent. Use cases that follow show examples of these types
  of deployments.</p><div class="mediaobject" align="center"><a name="figure-portal-app-login"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/portal-app-login.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-portal-app-login.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>User accesses the Portal.</p></li><li class="listitem"><p>OpenIG intercepts request, finds no login page and passes it
    through.</p></li><li class="listitem"><p>Portal finds no local session and redirects to its login page for
    authentication.</p></li><li class="listitem"><p>OpenIG intercepts the redirect, finds a match for the login page,
    fetches the credentials from the flat file.</p></li><li class="listitem"><p>OpenIG creates the login form and POSTs it to the Portal login
    page.</p></li><li class="listitem"><p>Portal validates the credentials and redirects to the user's home
    page.</p></li><li class="listitem"><p>OpenIG passes the request through to the browser.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="am-integration"></a>5.2.&nbsp;OpenAM Integration</h2></div></div></div><a class="indexterm" name="d851e1676"></a><p>The figure below illustrates OpenIG integrated into an OpenAM
  deployment. In this deployment OpenIG is running in a container
  that is protected by an OpenAM policy agent. The agent is configured to
  forward a header, with the subject (user) of the single sign-on session, to
  OpenIG. OpenIG then uses the subject as the login credentials, or uses the
  subject as a reference to look up the login credentials in a database or
  directory. The HR application is integrated into the SSO deployment without
  an agent or any modification to the application or its deployment
  configuration.</p><div class="mediaobject" align="center"><a name="figure-am-integration"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/am-integration.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-am-integration.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>User browses to the Portal.</p></li><li class="listitem"><p>
     OpenAM policy agent intercepts the request,
     finds no valid OpenAM session, redirects the browser to...
    </p></li><li class="listitem"><p>
     ...an OpenAM login page.</p></li><li class="listitem"><p>
     OpenAM logs in the user and redirects...
    </p></li><li class="listitem"><p>
     ...back to the Portal.
    </p></li><li class="listitem"><p>OpenAM plugin finds a valid session, request goes through, OpenIG
    passes the request through to the Portal.
    </p></li><li class="listitem"><p>Portal finds no local session, redirects to the Portal login
    page.</p></li><li class="listitem"><p>OpenIG inspects the redirect, finds a match for the login page,
    creates the login form, and POSTs it to the Portal.</p></li><li class="listitem"><p>Portal validates the credentials and redirects to the Portal
    page.</p></li><li class="listitem"><p>OpenIG passes the request through to the browser.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sp-initiated-sso"></a>5.3.&nbsp;OpenIG Federation SP Initiated SAML 2.0 SSO</h2></div></div></div><a class="indexterm" name="d851e1721"></a><p>
   The figure below illustrates OpenIG Federation
   providing SAML 2.0 features acting as Service Provider (SP)
   in an SP-initiated single sign-on configuration.
   In this sample, the HR application is an outsourced provider of HR services
   and has started seeing increased demand for SAML 2.0 support
   in their core application.
   The companies to which they outsource are refusing proprietary means
   of authentication and demanding the widely-accepted SAML 2.0 standard.
   The HR application cannot be modified to support SAML 2.0
   nor do they have the time or money to integrate and deploy all of OpenAM.
   With OpenIG Federation, the HR application deploys OpenIG
   as a reverse proxy for their application,
   configures it as a SAML 2.0 Service Provider,
   and configures it to log users into the HR application
   upon successful verification of the SAML 2.0 authentication assertion
   from their customers' SAML 2.0 Identity Providers.
  </p><div class="mediaobject" align="center"><a name="figure-sp-initiated-sso"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/sp-initiated-sso.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-sp-initiated-sso.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>The user accesses the HR application through a bookmark in the
    browser.</p></li><li class="listitem"><p>OpenIG Federation inspects the request, no match is found for the
    HR application's login page so the request goes through.</p></li><li class="listitem"><p>HR application finds no HR session, sends a redirect to its login
    page.</p></li><li class="listitem"><p>
     OpenIG Federation intercepts the redirect,
     finds a match for the login page, and...
    </p></li><li class="listitem"><p>
     ...issues an SP-initiated SSO SAML 2.0 request to the organization's IDP.
    </p></li><li class="listitem"><p>
     The IDP receives the SAML 2.0 AuthN request and authenticates the user.
    </p></li><li class="listitem"><p>
     After authenticating the user the IDP sends a SAML 2.0 POST...
    </p></li><li class="listitem"><p>
     ...to OpenIG Federation using an auto-submitting form in the browser.
    </p><p>
     OpenIG Federation validates the assertion
     and makes the assertion attributes available to the OpenIG login chain.
    </p></li><li class="listitem"><p>OpenIG login chain gets the user credentials and POSTs the login form
    to the application.</p></li><li class="listitem"><p>The HR application verifies the credentials and redirects to its
    home page.</p></li><li class="listitem"><p>
     OpenIG Federation passes the HR application's redirect to the browser.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp-initiated-sso"></a>5.4.&nbsp;OpenIG Federation IDP Initiated SAML 2.0 SSO</h2></div></div></div><a class="indexterm" name="d851e1771"></a><p>
   The figure below illustrates OpenIG Federation
   providing SAML 2.0 features acting as Service Provider
   in an IDP-initiated single sign-on configuration.
  </p><div class="mediaobject" align="center"><a name="figure-idp-initiated-sso"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/idp-initiated-sso.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-idp-initiated-sso.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     User clicks the HR link on the company portal
     and is redirected to the company Identity Provider (IDP)
     for authentication.
    </p></li><li class="listitem"><p>IDP sends an AuthN Response to the HR application.</p></li><li class="listitem"><p>OpenIG Federation receives the POST, validates the assertion, and
    makes the attributes available to the OpenIG login chain.
    </p></li><li class="listitem"><p>OpenIG login chain retrieves the user credentials and POSTs the login
    form to the HR application.</p></li><li class="listitem"><p>HR application validates the credentials and redirects to the main
    page of the application.</p></li></ol></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-credentials-tutorial"></a>Chapter&nbsp;6.&nbsp;Tutorial On Looking Up Credentials</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#tutorial-before-you-start">6.1. Before You Start</a></span></dt><dt><span class="section"><a href="#tutorial-credentials-from-file">6.2. Login With Credentials From a File</a></span></dt><dt><span class="section"><a href="#tutorial-credentials-from-sql">6.3. Login With Credentials From a Database</a></span></dt></dl></div><a class="indexterm" name="d851e1803"></a><a class="indexterm" name="d851e1808"></a><p>
  In the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
  you learned how to configure OpenIG
  to proxy traffic and capture request and response data.
  You also learned how to configure OpenIG
  to use a static request to log in with hard-coded credentials.
 </p><p>
  This chapter shows you how OpenIG can look up credentials in external sources.
  For example, OpenIG can look up credentials in a file or in a relational database.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-before-you-start"></a>6.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   The initial OpenIG configuration file should look like the one used
   to login with a hard-coded username and password, see
   <a href="../gateway-guide/index.html#config-login-static-request" class="link"><em class="citetitle">Configuration for Hard-Coded Credentials</em></a>.
  </p><div class="tip"><h3 class="title">Tip</h3><p>
    If you get stuck running the following samples,
    know that you can activate OpenIG debug logging
    with a "ConsoleLogSink" configuration object.
    Add it as the first object in the array of configuration objects.
   </p><pre class="brush: javascript;">
{
    "name": "LogSink",
    "type": "ConsoleLogSink",
    "config": {
        "level": "DEBUG"
    }
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-credentials-from-file"></a>6.2.&nbsp;Login With Credentials From a File</h2></div></div></div><p>
   This sample shows you how to configure OpenIG to get credentials from a file.
  </p><p>
   The sample uses a comma-separated value file, <code class="filename">userfile</code>.
  </p><pre class="brush: java;">
username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com

  </pre><p>
   OpenIG looks up the user credentials based on the user's email address.
   OpenIG relies for this on
   a <code class="literal">FileAttributesFilter</code> configuration object.
  </p><div class="orderedlist"><p>
    Follow these steps to set up login with credentials from a file.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Add the user file on your system.
    </p><div class="screen"><pre>
$ <strong>vi /tmp/userfile</strong>
$ <strong>cat /tmp/userfile</strong>
<em>username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com
</em>
    </pre></div><p>
     On Windows systems, use an appropriate path
     such as <code class="filename">C:\Temp\userfile</code>.
    </p></li><li class="listitem"><p>
     Edit the OpenIG configuration file, <code class="filename">config.json</code>,
     to use the <code class="literal">FileAttributesFilter</code> configuration object.
    </p><div class="orderedlist"><p>
      To do this, make the following changes to the file.
     </p><ol class="orderedlist" type="a"><li class="listitem"><p>
       Before the "LoginRequest" object,
       add a new <code class="literal">FileAttributesFilter</code> configuration object.
      </p><p>
       The <code class="literal">FileAttributesFilter</code> configuration
       specifies the file to access and the fields of records in the file,
       the key and value to look up to retrieve the user's record,
       and where exchange to store the search results.
      </p><p>
       The new filter configuration object should look like this:
      </p><pre class="brush: javascript;">
{
    "name": "CredentialsFromFile",
    "type": "FileAttributesFilter",
    "config": {
        "target": "${exchange.credentials}",
        "file": "/tmp/userfile",
        "key": "email",
        "value": "george@example.com",
        "fields": [
            "username",
            "password",
            "fullname",
            "email"
        ]
    }
}
      </pre><p>
       Do not forget to add the comma after the object,
       so that your configuration file remains valid JSON.
      </p></li><li class="listitem"><p>
       Edit the list of filters in the "OutgoingChain" object
       to include your new filter before the "LoginRequest".
      </p><p>
       The full "OutgoingChain" object should now look like this:
      </p><pre class="brush: javascript;">
{
    "name": "OutgoingChain",
    "type": "Chain",
    "config": {
        "filters": [
            "CredentialsFromFile",
            "LoginRequest",
            "CaptureFilter"
        ],
        "handler": "DefaultHandler"
    }
}
      </pre></li><li class="listitem"><p>
       Edit the "LoginRequest" configuration object
       so that it retrieves the username and password values from the exchange.
      </p><p>
       The edited configuration object should look like this:
      </p><pre class="brush: javascript;">
{
    "name": "LoginRequest",
    "type": "StaticRequestFilter",
    "config": {
        "method": "POST",
        "uri": "http://www.example.com:8081",
        "form": {
            "username": [
                "${exchange.credentials.username}"
            ],
            "password": [
                "${exchange.credentials.password}"
            ]
        }
    }
}
      </pre></li></ol></div><p>
     You can find the entire configuration file in the example,
     <a href="../gateway-guide/index.html#config-login-from-file" class="link"><em class="citetitle">Configuration for Login With Credentials From a File</em></a>.
    </p></li><li class="listitem"><p>
     On Windows systems, edit the path names to the user file and the log file.
    </p></li><li class="listitem"><p>
     Verify that the configuration file is still valid JSON,
     and then save your work.
    </p></li><li class="listitem"><p>
     Restart the Jetty server where OpenIG is deployed.
    </p></li></ol></div><p>
   Now browse to
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
  </p><p>
   If everything is configured correctly, OpenIG logs you in as George.
  </p><p>
   What's happening behind the scenes?
  </p><div class="figure"><a name="figure-login-from-file"></a><div class="figure-title">Figure&nbsp;6.1.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/login-from-file.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d851e1949.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   OpenIG intercepts your browser's HTTP GET request.
   The OpenIG "FileAttributesFilter" looks up credentials in a file,
   and stores the credentials it finds in the exchange.
   OpenIG then calls the next filter in the chain, "StaticRequestFilter",
   passing the exchange object that now holds the credentials.
   The "StaticRequestFilter" filter pulls the credentials out of the exchange,
   builds the login form, and performs the HTTP POST request to the HTTP server.
   The HTTP server validates the credentials, and responds with a profile page.
   OpenIG then passes the response from the HTTP server to your browser.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-credentials-from-sql"></a>6.3.&nbsp;Login With Credentials From a Database</h2></div></div></div><p>
   This sample shows you how to configure OpenIG to get credentials from H2.
   This sample was developed with Jetty and with H2 1.4.178.
  </p><p>
   Although this sample uses H2, OpenIG also works with other database software.
   OpenIG relies on the application server where it runs
   to connect to the database.
   Configuring OpenIG to retrieve data from a database is therefore
   a question of configuring the application server to connect to the database,
   and configuring OpenIG to choose the appropriate data source,
   and to send the appropriate SQL request to the database.
   As a result, the OpenIG configuration depends more on the data structure
   than on any particular database drivers or connection configuration.
  </p><div class="procedure"><a name="sql-prepare-database"></a><div class="procedure-title">Procedure&nbsp;6.1.&nbsp;Preparing the Database</div><p>
    Follow these steps to prepare the database.
   </p><ol class="procedure" type="1"><li class="step"><p>
     On the system where OpenIG runs, download and unpack
     <a class="link" href="http://h2database.com" target="_blank">H2 database</a>.
    </p></li><li class="step"><p>
     Start H2.
    </p><div class="screen"><pre>
$ <strong>sh /path/to/h2/bin/h2.sh</strong>
    </pre></div><p>
     H2 starts, listening on port 8082, and opens a browser console page.
    </p></li><li class="step"><p>
     In the browser console page,
     select Generic H2 (Server) under Saved Settings.
     This sets the Driver Class, <code class="literal">org.h2.Driver</code>,
     the JDBC URL, <code class="literal">jdbc:h2:tcp://localhost/~/test</code>,
     the User Name, <code class="literal">sa</code>.
    </p><p>
     In the Password field, type <code class="literal">password</code>.
    </p><p>
     Then click Connect to access the console.
    </p></li><li class="step"><p>
     Run a statement to create a users table
     based on the user file from
     <a class="xref" href="#tutorial-credentials-from-file" title="6.2.&nbsp;Login With Credentials From a File">Section&nbsp;6.2, &#8220;Login With Credentials From a File&#8221;</a>.
    </p><p>
     If you have not created the user file on your system,
     put the following content in <code class="filename">/tmp/userfile</code>.
    </p><pre class="brush: java;">
username,password,fullname,email
george,costanza,George Costanza,george@example.com
kramer,newman,Kramer,kramer@example.com
bjensen,hifalutin,Babs Jensen,bjensen@example.com
demo,changeit,Demo User,demo@example.com
kvaughan,bribery,Kirsten Vaughan,kvaughan@example.com
scarter,sprain,Sam Carter,scarter@example.com

  </pre><p>
     Then create the users table through the H2 console:
    </p><pre class="brush: plain;">
DROP TABLE IF EXISTS USERS;
CREATE TABLE USERS AS SELECT * FROM CSVREAD('/tmp/userfile');
    </pre><p>
     On success, the table should contain the same users as the file.
     You can check this by running <code class="literal">SELECT * FROM users;</code>
     in the H2 console.
    </p></li></ol></div><div class="procedure"><a name="sql-connect-to-database"></a><div class="procedure-title">Procedure&nbsp;6.2.&nbsp;Preparing Jetty's Connection to the Database</div><p>
    Follow these steps to enable Jetty to connect to the database.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Configure Jetty for JNDI as described in the Jetty documentation on
     <a class="link" href="http://www.eclipse.org/jetty/documentation/current/jndi.html" target="_blank"><em class="citetitle">Configuring JNDI</em></a>.
    </p><p>
     For the version of Jetty used in this sample,
     stop Jetty and add the following lines to
     <code class="filename">/path/to/jetty/start.ini</code>.
    </p><pre class="brush: plain;">
# ===========================================================
# Enable JNDI
# -----------------------------------------------------------
OPTIONS=jndi

# ===========================================================
# Enable additional webapp environment configurators
# -----------------------------------------------------------
OPTIONS=plus
etc/jetty-plus.xml
    </pre></li><li class="step"><p>
     Copy the H2 library to the classpath for Jetty.
    </p><div class="screen"><pre>
$ <strong>cp /path/to/h2/bin/h2-*.jar /path/to/jetty/lib/ext/</strong>
    </pre></div></li><li class="step"><p>
     Define a JNDI resource for H2 in
     <code class="filename">/path/to/jetty/etc/jetty.xml</code>.
    </p><pre class="brush: xml;">
&lt;New id="jdbc/forgerock" class="org.eclipse.jetty.plus.jndi.Resource"&gt;
  &lt;Arg&gt;&lt;/Arg&gt;
  &lt;Arg&gt;jdbc/forgerock&lt;/Arg&gt;
  &lt;Arg&gt;
    &lt;New class="org.h2.jdbcx.JdbcDataSource"&gt;
      &lt;Set name="Url"&gt;jdbc:h2:tcp://localhost/~/test&lt;/Set&gt;
      &lt;Set name="User"&gt;sa&lt;/Set&gt;
      &lt;Set name="Password"&gt;password&lt;/Set&gt;
    &lt;/New&gt;
  &lt;/Arg&gt;
&lt;/New&gt;

     </pre></li><li class="step"><p>
     Add a resource reference to the data source in
     <code class="filename">/path/to/etc/webdefault.xml</code>.
    </p><pre class="brush: xml;">
&lt;resource-ref&gt;
    &lt;res-ref-name&gt;jdbc/forgerock&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

     </pre></li></ol></div><div class="procedure"><a name="sql-configure-openig"></a><div class="procedure-title">Procedure&nbsp;6.3.&nbsp;Preparing the OpenIG Configuration</div><p>
    Follow these steps to prepare the OpenIG configuration
    to look up credentials in the database.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Edit the OpenIG configuration file, <code class="filename">config.json</code>,
     to use an <code class="literal">SqlAttributesFilter</code> configuration object.
    </p><p>
     To do this, make the following changes to the file.
    </p><ol type="a" class="substeps"><li class="step"><p>
       Replace any content between the "OutgoingChain" and "LoginRequest" objects
       with a new <code class="literal">SqlAttributesFilter</code> configuration object.
      </p><p>
       The <code class="literal">SqlAttributesFilter</code> configuration
       specifies the data source configured in the application server,
       the SQL statement and parameters to request the data,
       and the target where OpenIG stores the results.
      </p><p>
       The new filter configuration object should look like this:
      </p><div class="informalexample"><pre class="brush: javascript;">
{
    "name": "CredentialsFromSql",
    "type": "SqlAttributesFilter",
    "config": {
        "target": "${exchange.credentials}",
        "dataSource": "java:comp/env/jdbc/forgerock",
        "preparedStatement": "SELECT username, password FROM users WHERE email = ?;",
        "parameters": [
            "george@example.com"
        ]
    }
}
       </pre></div><p>
       Do not forget to add the comma after the object,
       so that your configuration file remains valid JSON.
      </p></li><li class="step"><p>
       Edit the list of filters in the "OutgoingChain" object
       to include your new filter before the "LoginRequest".
      </p><p>
       The full "OutgoingChain" object should now look like this:
      </p><pre class="brush: javascript;">
{
    "name": "OutgoingChain",
    "type": "Chain",
    "config": {
        "filters": [
            "CredentialsFromSql",
            "LoginRequest",
            "CaptureFilter"
        ],
        "handler": "DefaultHandler"
    }
}
      </pre></li><li class="step"><p>
       Edit the "LoginRequest" configuration object
       so that it retrieves the username and password values from the exchange.
      </p><p>
       The edited configuration object should look like this:
      </p><pre class="brush: javascript;">
{
    "name": "LoginRequest",
    "type": "StaticRequestFilter",
    "config": {
        "method": "POST",
        "uri": "http://www.example.com:8081",
        "form": {
            "username": [
                "${exchange.credentials.USERNAME}"
            ],
            "password": [
                "${exchange.credentials.PASSWORD}"
            ]
        }
    }
}
      </pre><p>
       Notice that the request is for <code class="literal">username, password</code>,
       and that H2 returns the fields as
       <code class="literal">USERNAME</code> and <code class="literal">PASSWORD</code>.
       The configuration reflects this difference.
      </p></li></ol></li><li class="step"><p>
     Verify that the configuration file is still valid JSON,
     and then save your work.
    </p><p>
     You can find the entire configuration file in the example,
     <a href="../gateway-guide/index.html#config-login-from-sql" class="link"><em class="citetitle">Configuration for Login With Credentials From a Database</em></a>.
    </p></li></ol></div><div class="procedure"><a name="try-login-sql"></a><div class="procedure-title">Procedure&nbsp;6.4.&nbsp;To Try Logging In With Credentials From a Database</div><p>
    With H2, Jetty, and OpenIG correctly configured, you can try it out.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Restart Jetty.
    </p></li><li class="step"><p>
     Access the home page again,
     <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>.
    </p><p>
     OpenIG logs you in automatically as George.
    </p></li></ol></div><p>
   What's happening behind the scenes?
  </p><div class="figure"><a name="figure-login-from-sql"></a><div class="figure-title">Figure&nbsp;6.2.&nbsp;</div><div class="figure-contents"><div class="mediaobject" align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/login-from-sql.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="ld-d851e2156.html" target="longdesc">D</a>]</span></div></div></div></div><br class="figure-break"><p>
   OpenIG intercepts your browser's HTTP GET request.
   The OpenIG "SqlAttributesFilter" looks up credentials in H2,
   and stores the credentials it finds in the exchange.
   OpenIG then calls the next filter in the chain, "StaticRequestFilter",
   passing the exchange object that now holds the credentials.
   The "StaticRequestFilter" filter pulls the credentials out of the exchange,
   builds the login form, and performs the HTTP POST request to the HTTP server.
   The HTTP server validates the credentials, and responds with a profile page.
   OpenIG then passes the response from the HTTP server to your browser.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-password-capture-replay-tutorial"></a>Chapter&nbsp;7.&nbsp;Tutorial On OpenAM Password Capture &amp; Replay</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#capture-replay-flow">7.1. Detailed Flow</a></span></dt><dt><span class="section"><a href="#capture-replay-summary">7.2. Setup Summary</a></span></dt><dt><span class="section"><a href="#capture-replay-setup">7.3. Setup Details</a></span></dt><dt><span class="section"><a href="#capture-replay-try-it-out">7.4. Trying It Out</a></span></dt></dl></div><a class="indexterm" name="d851e2168"></a><p>
  This tutorial walks you through an OpenAM integration
  with OpenAM's password capture and replay feature.
  This feature of OpenAM is typically used to integrate
  with Microsoft Outlook Web Access (OWA) or SharePoint
  by capturing the password during OpenAM authentication,
  encrypting it, and adding to the session, which is later decrypted
  and used for Basic Authentication to OWA or SharePoint.
  This tutorial shows how you can configure OpenIG
  to use the user name and password from the OpenAM Authentication
  to log the user an application.
  This is also how you would achieve OWA or SharePoint integration.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-flow"></a>7.1.&nbsp;Detailed Flow</h2></div></div></div><p>
   The figure below illustrates the flow of requests
   for a user who is not yet logged in to OpenAM
   accessing a protected application.
   After successful authentication, the user is logged into the application
   with the username and password from the OpenAM login session.
  </p><div class="mediaobject" align="center"><a name="figure-password-capture-replay-tutorial"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/password-capture-replay-tutorial.png" align="middle" height="360"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-password-capture-replay-tutorial.html" target="longdesc">D</a>]</span></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     The user sends a browser request to access a protected application.
    </p></li><li class="listitem"><p>
     The OpenAM policy agent protecting OpenIG intercepts the request.
    </p></li><li class="listitem"><p>
     The policy agent redirects the browser to OpenAM.
    </p></li><li class="listitem"><p>
     OpenAM authenticates the user, capturing the login credentials,
     storing the password in encrypted form in the user's session.
    </p></li><li class="listitem"><p>
     After authentication, OpenAM redirects the browser...
    </p></li><li class="listitem"><p>
     ...back to the protected application.
    </p></li><li class="listitem"><p>
     The OpenAM policy agent protecting OpenIG intercepts the request,
     validates the user session with OpenAM (not shown here),
     adds the username and encrypted password to headers in the request,
     and passes the request to OpenIG.
    </p></li><li class="listitem"><p>
     OpenIG retrieves the credentials from the headers,
     and uses the username and decrypted password
     to replace the request with an HTTP POST of the login form.
    </p></li><li class="listitem"><p>
     The application validates the login credentials,
     and sends a response back to OpenIG.
    </p></li><li class="listitem"><p>
     OpenIG passes the response from the application back to the user's browser.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-summary"></a>7.2.&nbsp;Setup Summary</h2></div></div></div><p>
   This tutorial calls for you to set up several different software components.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     OpenAM is installed on
     <code class="literal">http://openam.example.com:8088/openam</code>.
    </p></li><li class="listitem"><p lang="en">
 Download and run the
 <a class="link" href="http://maven.forgerock.org/repo/releases/org/forgerock/openig/openig-doc-samples/3.0.0/openig-doc-samples-3.0.0-jar-with-dependencies.jar" target="_top">minimal HTTP server .jar</a>
 to use as the application to protect.
</p><p>
     The openig-doc-samples-3.0.0-jar-with-dependencies.jar application
     listens at <code class="literal">http://www.example.com:8081</code>.
     The minimal HTTP server is run
     with the <span class="command"><strong>java -jar openig-doc-samples-3.0.0-jar-with-dependencies.jar</strong></span> command,
     as described in the chapter on
     <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
    </p></li><li class="listitem"><p>
     OpenIG is deployed in Jetty as described in the chapter on
     <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
     OpenIG listens at <code class="literal">http://www.example.com:8080</code>.
    </p></li><li class="listitem"><p>
     OpenIG is protected by an OpenAM Java EE policy agent also deployed in Jetty.
     The policy agent is configured
     to add username and encrypted password headers to the HTTP requests.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-setup"></a>7.3.&nbsp;Setup Details</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#capture-relay-setup-openam">7.3.1. Setting Up OpenAM Server</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-pa-profile">7.3.2. Preparing the Policy Agent Profile</a></span></dt><dt><span class="section"><a href="#password-capture-configuration">7.3.3. Configuring Password Capture</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-openig-minimal-server">7.3.4. Installing OpenIG</a></span></dt><dt><span class="section"><a href="#capture-relay-setup-pa">7.3.5. Installing the Policy Agent</a></span></dt><dt><span class="section"><a href="#capture-relay-configure-openig">7.3.6. Configuring OpenIG</a></span></dt></dl></div><p>
   In this section, it is assumed that you are familiar
   with the components involved.
   For OpenAM documentation, see
   <a class="link" href="http://docs.forgerock.org/en/openam/" target="_blank">http://docs.forgerock.org/en/openam/</a>.
   For OpenAM policy agent documentation, see
   <a class="link" href="http://docs.forgerock.org/en/openam-pa/" target="_blank">http://docs.forgerock.org/en/openam-pa/</a>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-openam"></a>7.3.1.&nbsp;Setting Up OpenAM Server</h3></div></div></div><p>
    Install and configure OpenAM on
    <code class="literal">http://openam.example.com:8088/openam</code>
    with the default configuration.
    If you use a different configuration,
    make sure you substitute in the tutorial accordingly.
   </p><p>
    Create a sample user Subject in the top level realm with
    username <code class="literal">george</code> and password <code class="literal">costanza</code>.
    Test that you can login to OpenAM with this username and password.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-pa-profile"></a>7.3.2.&nbsp;Preparing the Policy Agent Profile</h3></div></div></div><div class="itemizedlist"><p>
     Create the Java EE agent profile in the top level realm
     with the following settings:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Server URL: <code class="literal">http://openam.example.com:8088/openam</code>
     </p></li><li class="listitem"><p>
      Agent URL: <code class="literal">http://www.example.com:8080/agentapp</code>
     </p></li></ul></div><div class="itemizedlist"><p>
     Edit the policy agent profile to add these settings,
     making sure to save your work when you finish.
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      On the Global settings tab page under General, change the Agent Filter Mode
      from <code class="literal">ALL</code> to <code class="literal">SSO_ONLY</code>.
     </p></li><li class="listitem"><p>
      On the Application tab page under Session Attributes Processing,
      change the Session Attribute Fetch Mode
      from <code class="literal">NONE</code> to <code class="literal">HTTP_HEADER</code>.
     </p></li><li class="listitem"><p>
      Also on the Application tab page under Session Attributes Processing,
      add <code class="literal">UserToken=username</code>
      and <code class="literal">sunIdentityUserPassword=password</code>
      to the Session Attribute Mapping list.
     </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="password-capture-configuration"></a>7.3.3.&nbsp;Configuring Password Capture</h3></div></div></div><p>
    Configure password capture in OpenAM as follows.
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      In the OpenAM console
      under Access Control &gt; / (Top Level Realm) &gt; Authentication,
      click All Core Settings,
      and then add
      <code class="literal">com.sun.identity.authentication.spi.ReplayPasswd</code>
      to the Authentication Post Processing Classes.
     </p></li><li class="listitem"><p>
      Run OpenAM's <span class="command"><strong>com.sun.identity.common.DESGenKey</strong></span> command
      to generate a shared key for the OpenAM Authentication plugin
      and for OpenIG.
     </p><p>
      To run this command using the <span class="command"><strong>java</strong></span> command,
      you must add OpenAM .jar file libraries to the Java class path.
      The library names depend on the version of OpenAM that you use.
     </p><p>
      When using OpenAM 11.0.0 for example, the libraries are
      <code class="filename">forgerock-util-1.1.0.jar</code>
      <code class="filename">openam-core-11.0.0.jar</code>,
      and <code class="filename">openam-shared-11.0.0.jar</code>.
      As an example,
      if OpenAM 11.0.0 is installed in Apache Tomcat under <code class="literal">/openam</code>
      you would run the command
      <span class="command"><strong>java -classpath
      /path/to/tomcat/webapps/openam/WEB-INF/lib/forgerock-util-1.1.0.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-core-11.0.0.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/openam-shared-11.0.0.jar
      com.sun.identity.common.DESGenKey</strong></span>.
     </p><p>
      When using OpenAM 10 and earlier, the libraries are
      <code class="filename">amserver.jar</code>
      and <code class="filename">opensso-sharedlib.jar</code>.
      As an example, if OpenAM 10 is installed in Apache Tomcat under <code class="literal">/openam</code>
      you would run the command
      <span class="command"><strong>java -classpath
      /path/to/tomcat/webapps/openam/WEB-INF/lib/amserver.jar:/path/to/tomcat/webapps/openam/WEB-INF/lib/opensso-sharedlib.jar
      com.sun.identity.common.DESGenKey</strong></span>.
     </p><p>
      The output of the command shows the generated key,
      as in the following example.
     </p><div class="screen"><pre>
$ <strong>cd /path/to/tomcat/webapps/openam/WEB-INF/lib</strong>
$ <strong>java -classpath \
 forgerock-util-1.1.0.jar:openam-core-11.0.0.jar:openam-shared-11.0.0.jar \
 com.sun.identity.common.DESGenKey</strong>
<em>Key ==&gt; ipvvZF2Mj0k</em>
     </pre></div></li><li class="listitem"><p>
      In the OpenAM console under Configuration &gt; Servers and Sites,
      click on the server name link,
      go to the Advanced tab
      and add <code class="literal">com.sun.am.replaypasswd.key</code>
      with the value of the key generated in the previous step.
     </p><p>
      Restart the OpenAM server after adding the Advanced property
      for the change to take effect.
     </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-openig-minimal-server"></a>7.3.4.&nbsp;Installing OpenIG</h3></div></div></div><p>
    Install OpenIG in Jetty and run the minimal HTTP server
    as described in the chapter on
    <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
   </p><p>
    When you finish, OpenIG should be running in Jetty,
    configured to access the minimal HTTP server as described in that chapter.
   </p><p>
    The initial OpenIG configuration file should look like the one used
    to proxy requests through to the HTTP server
    and to capture request and response data, see
    <a href="../gateway-guide/index.html#config-proxy-and-capture" class="link"><em class="citetitle">Configuration for Proxy &amp; Capture</em></a>.
   </p><p>
    To test your setup, access the HTTP server home page through OpenIG at
    <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
    Login as username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    You should see a page showing the username and some information about the request.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-setup-pa"></a>7.3.5.&nbsp;Installing the Policy Agent</h3></div></div></div><p>
    Install the OpenAM Java EE policy agent alongside OpenIG in Jetty,
    listening at <code class="literal">http://www.example.com:8080</code>,
    using the following hints.
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Jetty Server Config Directory : <code class="literal">/path/to/jetty/etc</code>
     </p></li><li class="listitem"><p>
      Jetty installation directory. : <code class="literal">/path/to/jetty</code>
     </p></li><li class="listitem"><p>
      OpenAM server URL : <code class="literal">http://openam.example.com:8088/openam</code>
     </p></li><li class="listitem"><p>
      Agent URL : <code class="literal">http://www.example.com:8080/agentapp</code>
     </p></li><li class="listitem"><p>
      After copying <code class="filename">agentapp.war</code>
      into <code class="filename">/path/to/jetty/webapps/</code>,
      also add the following filter configuration to
      <code class="filename">/path/to/jetty/etc/webdefault.xml</code>.
     </p><pre class="brush: xml;">
&lt;filter&gt;
  &lt;filter-name&gt;Agent&lt;/filter-name&gt;
  &lt;display-name&gt;Agent&lt;/display-name&gt;
  &lt;description&gt;OpenAM Policy Agent Filter&lt;/description&gt;
  &lt;filter-class&gt;com.sun.identity.agents.filter.AmAgentFilter&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
  &lt;filter-name&gt;Agent&lt;/filter-name&gt;
  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;
  &lt;dispatcher&gt;INCLUDE&lt;/dispatcher&gt;
  &lt;dispatcher&gt;FORWARD&lt;/dispatcher&gt;
  &lt;dispatcher&gt;ERROR&lt;/dispatcher&gt;
&lt;/filter-mapping&gt;

     </pre></li></ul></div><p>
    To test the configuration, start Jetty, and then browse to
    <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>.
    You should be redirected to OpenAM for authentication.
   </p><p>
    Login as user <code class="literal">george</code>, password <code class="literal">costanza</code>.
    OpenAM redirects you back to Jetty.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="capture-relay-configure-openig"></a>7.3.6.&nbsp;Configuring OpenIG</h3></div></div></div><div class="itemizedlist"><p>
     Follow these steps to configure OpenIG.
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Replace the existing OpenIG configuration file
      with the configuration including a "CryptoHeaderFilter" object
      and a "StaticRequestFilter" object, see
      <a href="../gateway-guide/index.html#config-capture-and-replay" class="link"><em class="citetitle">Configuration for Password Capture &amp; Replay</em></a>.
     </p><p>
      The "CryptoHeaderFilter" decrypts the password
      that OpenAM captured and encrypted,
      and that the OpenAM policy agent included in the headers for the request.
     </p><p>
      The "StaticRequestFilter" retrieves the username and password values,
      and replaces the original request by an HTTP POST with login form data.
     </p></li><li class="listitem"><p>
      Replace the <code class="literal">DESKEY</code> placeholder
      in the "CryptoHeaderFilter" configuration object
      with the key you generated in
      <a class="xref" href="#password-capture-configuration" title="7.3.3.&nbsp;Configuring Password Capture">Section&nbsp;7.3.3, &#8220;Configuring Password Capture&#8221;</a>.
     </p><p>
      The resulting "CryptoHeaderFilter" should look something like this,
      but using the "key" value that you generated:
     </p><pre class="brush: javascript;">
{
    "name": "CryptoHeaderFilter",
    "type": "CryptoHeaderFilter",
    "config": {
        "messageType": "REQUEST",
        "operation": "DECRYPT",
        "algorithm": "DES/ECB/NoPadding",
        "key": "ipvvZF2Mj0k",
        "keyType": "DES",
        "charSet": "utf-8",
        "headers": [
            "password"
        ]
    }
}
     </pre></li><li class="listitem"><p>
      Restart Jetty so that OpenIG takes the configuration changes into account.
     </p></li><li class="listitem"><p>
      Log out of OpenAM if you are logged in already.
     </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="capture-replay-try-it-out"></a>7.4.&nbsp;Trying It Out</h2></div></div></div><p>
   Access the application home page,
   <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>.
  </p><p>
   If you are not already logged into OpenAM
   you should be redirected to the OpenAM login page.
   Login with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
   After login you should be redirected back to the application.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-federation"></a>Chapter&nbsp;8.&nbsp;Using OpenIG Federation</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#federation-installation">8.1. Installation Overview</a></span></dt><dt><span class="section"><a href="#federation-configuration-files">8.2. Configuration File Overview</a></span></dt><dt><span class="section"><a href="#federation-configuration">8.3. Configuring the Federation Handler</a></span></dt><dt><span class="section"><a href="#federation-config-json">8.4. Federation Configuration Details</a></span></dt><dt><span class="section"><a href="#federation-example-settings">8.5. Example Settings</a></span></dt><dt><span class="section"><a href="#federation-idp-metadata">8.6. Identity Provider Metadata</a></span></dt></dl></div><p>
  The Federation component of OpenIG is
  a standards based authentication service used by OpenIG
  to validate a user and retrieve key attributes of the user
  in order to log them in to applications that OpenIG protects.
  The Federation component implements Security Assertion Markup Language 2.0.
 </p><p>
  Security Assertion Markup Language (SAML) 2.0 is a standard
  for exchanging security information across organizational boundaries.
  SAML 2.0 enables web single sign-on (SSO), for example,
  where the service managing the user's identity
  does not necessarily belong to the same organization
  and does not necessarily use the same software
  as the service that the user wants to access.
 </p><p>
  In SAML 2.0, the service managing the user's identity
  is called the <em class="firstterm">Identity Provider</em> (IDP).
  The service that the user wants to access
  is called the <em class="firstterm">Service Provider</em> (SP).
  Provider organizations agree on the security information they want to exchange,
  and then they mutually configure access to each others' services,
  so that the SAML 2.0 federation capability is ready for use.
  The group of providers sets up a <em class="firstterm">circle of trust</em>,
  which is a list of services participating in the federation.
  In order to be able to configure access to services in the circle of trust,
  the providers share SAML 2.0 <em class="firstterm">metadata</em>
  describing their services in an XML format defined by the SAML 2.0 standard.
 </p><p>
  OpenIG plays the role of SAML 2.0 SP.
  You must therefore configure OpenIG as SP to access IDP services
  in order for the Federation component to be operational.
 </p><p>
  For SAML 2.0 web SSO, the user authenticates with the IDP.
  This can start either with the user visiting the IDP site and logging in,
  or with the user visiting the SP site and being directed to the IDP to log in.
  On successful authentication, the IDP sends
  an assertion statement about the authentication to the SP.
  This assertion statement attests which user the IDP authenticated,
  when the authentication succeeded, how long the assertion is valid, and so forth.
  It can optionally contain attribute values for the user who authenticated.
  (OpenIG can then, for example, use the attribute values
  to log a user into a protected application.)
  The assertion can optionally be signed and encrypted.
 </p><div class="orderedlist"><p>
   There are two ways that the OpenIG federation component can be invoked:
  </p><ol class="orderedlist" type="1"><li class="listitem"><p>
    IDP initiated SSO,
    where the remote Identity Provider sends
    an unsolicited authentication statement to OpenIG
   </p></li><li class="listitem"><p>
    SP initiated SSO,
    where OpenIG calls the Federation component to
    initiate federated SSO with the Identity Provider
   </p></li></ol></div><p>
  In both cases, the job of the Federation component is
  to validate the user
  and to pass the required attributes to OpenIG
  so that it can log the user into protected applications.
 </p><p>
  See the
  <a href="../gateway-guide/index.html#chap-federation-tutorial" class="link"><em class="citetitle">Tutorial For OpenIG Federation</em></a>
  in order to try this out with OpenAM playing the role of Identity Provider.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-installation"></a>8.1.&nbsp;Installation Overview</h2></div></div></div><a class="indexterm" name="d851e2591"></a><div class="itemizedlist"><p>
    This section summarizes the steps needed to prepare OpenIG
    to act as a SAML 2.0 SP for your target application.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Install the OpenIG .war.
    </p></li><li class="listitem"><p>
     Configure OpenIG to proxy successfully, and even log a user in,
     to the target application.
     Getting this to work before configuring Federation
     makes the process much simpler to troubleshoot if anything goes wrong.
    </p></li><li class="listitem"><p>
     Add Federation configuration to the OpenIG configuration.
    </p></li><li class="listitem"><p>
     Include the assertion mapping, redirect URI,
     and any optional configuration settings you choose
     in the Federation configuration.
    </p></li><li class="listitem"><p>
     Export the Identity Provider metadata from the remote IDP,
     or use the metadata from an OpenAM-generated Fedlet.
     (An OpenAM Fedlet is a small web application that can act as SP.)
    </p></li><li class="listitem"><p>
     Import OpenIG metadata to your Identity Provider.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-configuration-files"></a>8.2.&nbsp;Configuration File Overview</h2></div></div></div><a class="indexterm" name="d851e2620"></a><p>
   You configure the Federation component by modifying
   both the OpenIG <code class="filename">config.json</code> file
   and also by including Federation-specific XML files with the configuration.
  </p><div class="itemizedlist"><p>
    The location of configuration information depends on
    the operating system where OpenIG runs,
    and on the user who runs the application server where OpenIG runs.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     On UNIX, Linux, and similar systems,
     where this user's home directory is referred to as <code class="filename">$HOME</code>,
     by default the Federation component looks
     in <code class="filename">$HOME/.openig/config</code> for <code class="filename">config.json</code>
     and in <code class="filename">$HOME/.openig/SAML</code> for the Federation XML configuration.
    </p></li><li class="listitem"><p>
     On Windows, by default the Federation component looks
     in <code class="filename">%appdata%\.openig\config</code>,
     and in <code class="filename">%appdata%\.openig\SAML</code>.
     To locate the <code class="filename">%appdata%</code> folder for your version of Windows,
     open Windows Explorer,
     type <code class="literal">%appdata%</code> as the file path,
     and press Enter.
     You must create
     the <code class="filename">%appdata%\.openig\config</code>
     and <code class="filename">%appdata%\.openig\SAML</code> folders,
     and then copy the configuration files into the folders.
    </p></li></ul></div><div class="variablelist"><p>The following is a description of the files:</p><dl class="variablelist"><dt><span class="term"><code class="filename">$HOME/.openig/config/config.json</code></span></dt><dd><p>
      This is the core configuration file for OpenIG.
      You must configure both this file
      and also the XML files specific to the Federation component.
      The reason there are two sets of configuration files
      is that the Federation component includes a federation library from OpenAM.
      In order to configure the Federation component you must tag swap the XML files.
      If you are familiar with the workflow in the OpenAM console
      you can instead generate a Fedlet and directly copy the configuration files
      into <code class="filename">$HOME/.openig/SAML</code>.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/FederationConfig.properties</code></span></dt><dd><p>
      Advanced features of the federation library from OpenAM.
      The defaults suffice in most deployments.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/gateway.cot</code></span></dt><dd><p>
      Circle of trust for OpenIG and the Identity Provider.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/idp.xml</code></span></dt><dd><p>
      This metadata file is generated by the Identity Provider.
      You must copy the generated metadata file into the configuration directory.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/idp-extended.xml</code></span></dt><dd><p>
      Standard metadata extensions generated by the Identity Provider.
     </p></dd><dt><span class="term"><code class="filename">$HOME/.openig/SAML/sp.xml</code>, </span><span class="term"><code class="filename">$HOME/.openig/SAML/sp-extended.xml</code></span></dt><dd><p>
      These are the standard metadata and metadata extensions
      for the OpenIG Federation component.
     </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-configuration"></a>8.3.&nbsp;Configuring the Federation Handler</h2></div></div></div><a class="indexterm" name="d851e2723"></a><p>
   The simplest way to configure the Federation component
   is to use the OpenAM task wizard to generate a Fedlet,
   and then copy the Fedlet configuration files to the correct locations.
   If you use the Fedlet configuration files,
   simply unpack <code class="filename">Fedlet.war</code>
   and copy all the files listed above into <code class="filename">$HOME/.openig/SAML</code>.
   You do not have to modify the files
   to do basic IDP and SP initiated SSO with OpenIG.
   When generating a Fedlet,
   know that the sample <code class="filename">config.json</code> templates
   uses <code class="literal">/saml</code> as the URI
   so your Fedlet end point should be specified as
   <code class="literal"><em class="replaceable"><code>protocol</code></em>://<em class="replaceable"><code>host</code></em>.<em class="replaceable"><code>domain</code></em>:<em class="replaceable"><code>port</code></em>/saml</code>.
  </p><p>
   If you do not use the Fedlet wizard,
   edit the configuration files for the unconfigured Fedlet,
   and then copy the Fedlet configuration files
   to the <code class="filename">$HOME/.openig/SAML</code> directory.
   You must still nevertheless get the metadata from the IDP,
   and then copy it to <code class="filename">idp.xml</code> in the same directory.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-config-json"></a>8.4.&nbsp;Federation Configuration Details</h2></div></div></div><p>
   The following sample configuration is corresponds to a scenario
   where OpenIG receives a SAML assertion from OpenAM,
   and then logs the user in to the protected application
   using the username and password from the assertion.
   Descriptions of the fields follow the example.
  </p><pre class="brush: javascript;">
{
    "name": "SamlFederationHandler",
    "type": "org.forgerock.openig.handler.saml.SamlFederationHandler",
    "config": {
        "assertionMapping": {
            "username": "mail",
            "password": "mailPassword"
        },
        "redirectURI": "/login",
        "logoutURI": "/logout"
    }
}
  </pre><div class="variablelist"><dl class="variablelist"><dt><span class="term">"name" (required)</span></dt><dd><p>
      Name of the Federation component of OpenIG.
      Do not modify this value.
     </p></dd><dt><span class="term">"type" (required)</span></dt><dd><p>
      Class name of the Federation handler.
      Do not modify this value.
     </p></dd><dt><span class="term">"assertionMapping" (required)</span></dt><dd><p>
      The "assertionMapping" defines how to transform attributes
      from the incoming assertion to attribute value pairs in OpenIG.
      Each entry in the <code class="literal">assertionMapping</code> is of the form
      <code class="literal"><em class="replaceable"><code>localName</code></em>:
       <em class="replaceable"><code>incomingName</code></em></code>,
      where <em class="replaceable"><code>incomingName</code></em>
      is used to fetch the value from the incoming assertion,
      and <em class="replaceable"><code>localName</code></em>
      is the name of the attribute set in the session.
     </p><p>
      The following statements correspond to the sample shown above.
     </p><p>
      If the incoming assertion contains the statement:</p><pre class="literallayout">mail = george@example.com</pre><pre class="literallayout">mailPassword = costanza</pre><p>Then the following values are set in the session:</p><pre class="literallayout">username = george@example.com</pre><pre class="literallayout">password = costanza</pre><p>
      For this to work,
      you must edit the &lt;Attribute name="attributeMap"&gt; element
      in the SP extended metadata file,
      <code class="filename">$HOME/.openig/SAML/sp-extended.xml</code>,
      so that it matches the assertion mapping configured in the IDP metadata.
     </p></dd><dt><span class="term">"redirectURI" (required)</span></dt><dd><p>
      Set this to the page that the filter used to HTTP POST a login form
      recognizes as the login page for the protected application.
     </p><p>
      This is how OpenIG and the Federation component work together
      to provide single sign-on.
      When OpenIG detects the login page of the protected application,
      it redirects to the Federation component.
      Once the Federation handler validates the SAML exchanges with the IDP,
      and sets the required session attributes,
      it redirects back to the login page of the protected application.
      This allows the filter used to HTTP POST a login form to finish the job
      by creating a login form to post to the application
      based on the credentials retrieved from the session attributes.
     </p></dd><dt><span class="term">"assertionConsumerEndpoint" (optional)</span></dt><dd><p>
      Default: "fedletapplication" (same as the Fedlet)
     </p><p>
      If you modify this attribute you must change the metadata to match.
     </p></dd><dt><span class="term">"authnContext" (optional)</span></dt><dd><p>
      An authentication context to use when sending the request to the IDP,
      such as <code class="literal">PasswordProtectedTransport</code>.
     </p></dd><dt><span class="term">"authnContextDelimiter" (optional)</span></dt><dd><p>
      The authentication context delimiter used
      when there are multiple authentication contexts in the assertion.
     </p><p>
      Default: <code class="literal">|</code>
     </p></dd><dt><span class="term">"logoutURI" (optional)</span></dt><dd><p>
      Set this to the URI that logs the user out of the protected application.
     </p><p>
      You only need to set this if the application
      uses the single logout feature of the Identity Provider.
     </p></dd><dt><span class="term">"sessionIndexMapping" (optional)</span></dt><dd><p>
      The IDP sends the <code class="literal">sessionIndex</code> for the user
      in the assertion.
      The value contained in the assertion is set as
      the value of the attribute <code class="literal">sessionIndex</code> in the session.
     </p></dd><dt><span class="term">"singleLogoutEndpoint" (optional)</span></dt><dd><p>
      Default: "fedletSLORedirect" (same as the Fedlet)
     </p><p>
      If you modify this attribute you must change the metadata to match.
     </p></dd><dt><span class="term">"singleLogoutEndpointSoap" (optional)</span></dt><dd><p>
      Default: "fedletSloSoap" (same as the Fedlet)
     </p><p>
      If you modify this attribute you must change the metadata to match.
     </p></dd><dt><span class="term">"SPinitiatedSLOEndpoint" (optional)</span></dt><dd><p>
      Default: "SPInitiatedSLO"
     </p><p>
      If you modify this attribute you must change the metadata to match.
     </p></dd><dt><span class="term">"SPinitiatedSSOEndpoint" (optional)</span></dt><dd><p>
      Default: "SPInitiatedSSO"
     </p><p>
      If you modify this attribute you must change the metadata to match.
     </p></dd><dt><span class="term">"subjectMapping" (optional)</span></dt><dd><p>
      The value contained in the assertion subject is set as
      the value of the attribute <code class="literal">subjectName</code> in the session.
     </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-example-settings"></a>8.5.&nbsp;Example Settings</h2></div></div></div><p>
   Application <code class="literal">myportal</code> requires a form
   with username and password for login.
   The username for <code class="literal">myportal</code>
   is the <code class="literal">mail</code> attribute at the user's Identity Provider.
   The password for <code class="literal">myportal</code>
   is the <code class="literal">mailPassword</code> attribute at the Identity Provider.
  </p><p>
   The incoming SAML2 assertion sent by the Identity Provider contains
   the <code class="literal">mail</code> and <code class="literal">mailPassword</code> attributes.
   The Federation component validates the incoming assertion,
   sets the session attributes
   <code class="literal">username</code> and <code class="literal">password</code>
   to the values of
   <code class="literal">mail</code> and <code class="literal">mailPassword</code>
   from the assertion attributes,
   and redirects the user to <code class="literal">/myportal/login</code>.
   A "LoginRequest" filter then retrieves the credentials
   and creates the form to log the user in to <code class="literal">myportal</code>.
  </p><p>
   The "SamlFederationHandler" configuration object looks like this:
  </p><pre class="brush: javascript;">
{
    "name": "SamlFederationHandler",
    "type": "org.forgerock.openig.saml.SamlFederationHandler",
    "config": {
        "assertionMapping": {
            "username": "mail",
            "password": "mailPassword"
        },
        "redirectURI": "/myportal/login",
        "logoutURI": "/myportal/logout"
    }
}
  </pre><p>
   The "LoginRequest" configuration object looks like this:
  </p><pre class="brush: javascript;">
{
    "name": "LoginRequest",
    "type": "StaticRequestFilter",
    "config": {
        "method": "POST",
        "uri": "https://www.myportal.com/myportal/login",
        "form": {
            "username": [
                "${exchange.session.username}"
            ],
            "password": [
                "${exchange.session.password}"
            ]
        }
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="federation-idp-metadata"></a>8.6.&nbsp;Identity Provider Metadata</h2></div></div></div><p>
   The Identity Provider metadata must be copied to
   the <code class="filename">$HOME/.openig/SAML/idp.xml</code> directory.
   See the documentation for your Identity Provider
   for instructions on how to get the metadata.
  </p><p>
   To export Identity Provider metadata from OpenAM,
   either save the response from the appropriate end point,
   such as <code class="literal">http://openam.example.com:8088/openam/saml2/jsp/exportmetadata.jsp</code>,
   or run an <span class="command"><strong>ssoadm</strong></span> command such as the following:
  </p><div class="screen"><pre>
$ <strong>ssoadm \
 export-entity \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --entityid http://openam.example.com:8088/openam \
 --meta-data-file /tmp/idp.xml</strong>
  </pre></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-federation-tutorial"></a>Chapter&nbsp;9.&nbsp;Tutorial For OpenIG Federation</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#fed-tutorial-before-you-start">9.1. Before You Start</a></span></dt><dt><span class="section"><a href="#fed-tutorial-configure-openam">9.2. Configuring OpenAM</a></span></dt><dt><span class="section"><a href="#fed-tutorial-configure-federation">9.3. Configuring OpenIG For Federation</a></span></dt><dt><span class="section"><a href="#fed-tutorial-testing">9.4. Trying It Out</a></span></dt></dl></div><a class="indexterm" name="d851e3001"></a><p>
  This tutorial demonstrates how to configure OpenIG
  as a SAML 2.0 federation service provider
  to log users in to a protected application.
 </p><p>
  When following this tutorial, you configure
  OpenAM to send a SAML 2.0 assertion to OpenIG containing user credentials,
  and OpenIG to validate the assertion and use the credentials
  to log the user in to the protected application.
 </p><p>
  In this tutorial, it is assumed that you are familiar
  with SAML 2.0 federation and with the components involved.
  For an overview, read the chapter on
  <a href="../gateway-guide/index.html#chap-federation" class="link"><em class="citetitle">Using OpenIG Federation</em></a>.
  For OpenAM documentation, see
  <a class="link" href="http://docs.forgerock.org/en/openam/" target="_blank">http://docs.forgerock.org/en/openam/</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-before-you-start"></a>9.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
  <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   The initial OpenIG configuration file should look like the one used
   to proxy requests through to the HTTP server
   and to capture request and response data, see
   <a href="../gateway-guide/index.html#config-proxy-and-capture" class="link"><em class="citetitle">Configuration for Proxy &amp; Capture</em></a>.
  </p><p>
   To test your setup, access the HTTP server home page through OpenIG at
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
   Login as username <code class="literal">george</code>, password <code class="literal">costanza</code>.
   You should see a page showing the username and some information about the request.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-configure-openam"></a>9.2.&nbsp;Configuring OpenAM</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard to create a hosted Identity Provider.
   This tutorial does not address PKI configuration for validation and encryption,
   though OpenIG is capable of handling both when properly configured,
   just as any OpenAM Fedlet can handle both.
   Configure the Attribute Mapping to map the
   the <code class="literal">mail</code> attribute to <code class="literal">mail</code>
   and the <code class="literal">employeenumber</code> attribute to <code class="literal">employeenumber</code>.
   You can use the <code class="literal">test</code> certificate
   in the Identity Provider configuration for signing in this example.
  </p><p>
   Then use the common task wizard to create a Fedlet.
   Set the Name to <code class="literal">OpenIG</code>.
   Set the Destination URL to <code class="literal">http://www.example.com:8080/saml</code>.
   Also configure the Attribute Mapping for the Fedlet to map the
   the <code class="literal">mail</code> attribute to <code class="literal">mail</code>
   and the <code class="literal">employeenumber</code> attribute to <code class="literal">employeenumber</code>.
  </p><p>
   Why map these attributes?
   The SAML 2.0 attribute mapping indicates that the SP, OpenIG,
   wants the IDP, OpenAM in this case,
   to get the values of these attributes from the user profile
   and then send them to the SP, OpenIG.
   OpenIG can then use the values of the attributes,
   in this case <code class="literal">mail</code> and <code class="literal">employeenumber</code>,
   to log the user in to the application it protects.
  </p><p>
   This tutorial uses <code class="literal">mail</code>
   and <code class="literal">employeenumber</code>
   for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses <code class="literal">mail</code> to hold the username,
   and <code class="literal">employeenumber</code> to hold the password.
   In a real deployment, you would no doubt use other attributes
   that depend on how the real user profiles are configured.
  </p><p>
   Use the OpenAM console to create a user subject in the top level realm
   with Email Address <code class="literal">george</code>
   and Employee Number <code class="literal">costanza</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-configure-federation"></a>9.3.&nbsp;Configuring OpenIG For Federation</h2></div></div></div><p>
   Replace the existing OpenIG configuration file
   with the new configuration from the example,
   <a href="../gateway-guide/index.html#config-federation" class="link"><em class="citetitle">Configuration for the Federation Tutorial</em></a>.
  </p><p>
   Unpack the configuration files from the Fedlet you created
   in <a class="xref" href="#fed-tutorial-configure-openam" title="9.2.&nbsp;Configuring OpenAM">Section&nbsp;9.2, &#8220;Configuring OpenAM&#8221;</a>.
   The Fedlet is packaged as a .zip file that contains a .war file
   that in turn contains the configuration files to unpack.
   OpenAM displays the location of the .zip file
   upon successful creation of the Fedlet.
   If you followed the instructions above, the .zip is
   <code class="filename">$HOME/openam/myfedlets/OpenIG/Fedlet.zip</code>
   on the system where OpenAM runs.
  </p><div class="screen"><pre>
$ <strong>cd $HOME/openam/myfedlets/OpenIG</strong>
$ <strong>unzip Fedlet.zip fedlet.war</strong>
$ <strong>unzip fedlet.war conf/*</strong>
$ <strong>mkdir $HOME/.openig/SAML</strong>
$ <strong>cp conf/* $HOME/.openig/SAML</strong>
$ <strong>ls -1 $HOME/.openig/SAML</strong>
<em>FederationConfig.properties
fedlet.cot
idp-extended.xml
idp.xml
sp-extended.xml
sp.xml</em>
  </pre></div><p>
   On Windows, the SAML configuration files belong in
   <code class="filename">%appdata%\.openig\SAML</code>.
   To locate the <code class="filename">%appdata%</code> folder for your version of Windows,
   open Windows Explorer,
   type <code class="literal">%appdata%</code> as the file path,
   and press Enter.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fed-tutorial-testing"></a>9.4.&nbsp;Trying It Out</h2></div></div></div><div class="itemizedlist"><p>
    Log out of OpenAM console,
    and then test whether everything is properly configured.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     For IDP initiated SSO, click
     <a class="link" href="http://openam.example.com:8088/openam/idpssoinit?NameIDFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:transient&amp;metaAlias=/idp&amp;spEntityID=OpenIG&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">this IDP initiated SSO link</a>,
     and then login to OpenAM
     with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    </p></li><li class="listitem"><p>
     For SP initiated SSO,
     either browse to OpenIG protecting the application,
     at <a class="link" href="http://www.example.com:8080/" target="_blank">http://www.example.com:8080/</a>,
     or click
     <a class="link" href="http://www.example.com:8080/saml/SPInitiatedSSO?metaAlias=/sp&amp;idpEntityID=http://openam.example.com:8088/openam&amp;binding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" target="_blank">this SP initiated SSO link</a>,
     and then login to OpenAM
     with username <code class="literal">george</code>, password <code class="literal">costanza</code>.
    </p></li></ul></div><p>
   However you initiate single sign-on,
   you should wind up viewing the page you normally see after logging in.
  </p><p>
   What is happening behind the scenes?
  </p><p>
   Consider the configuration, <code class="filename">$HOME/.openig/config/config.json</code>.
   In this configuration,
   the "DispatchHandler" is the entry point to OpenIG processing.
   The "DispatchHandler" provides an internal routing mechanism,
   based on the state of the exchange.
   If the incoming URI matches a SAML URI,
   then the "SamlFederationHandler" can process an incoming SAML 2.0 assertion,
   and also set the attributes from the assertion in the session.
   This condition is not met until the user has authenticated.
  </p><p>
   If no user name is set in the session of the exchange,
   the "DispatchHandler" considers that the user has not yet authenticated.
   This condition is met when the user has not yet authenticated.
   In this case the "DispatchHandler" dispatches to the static request handler,
   "SPInitiatedSSORedirectHandler",
   which redirects the user-agent to
   the Identity Provider for SAML 2.0 single sign-on.
   After authentication, the Identity Provider redirects the user-agent back to
   a SAML URI on the Service Provider (OpenIG),
   and so the request is dispatched to
   the "SamlFederationHandler" mentioned above.
  </p><p>
   Once the attributes from the assertion are set in the session,
   then the exchange is dispatched to the "LoginChain".
   The "LoginRequest" static request filter in the "LoginChain"
   uses the attribute values to replace the request
   with an HTTP POST of login form data
   to log the user in to the protected application.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-oauth-rs"></a>Chapter&nbsp;10.&nbsp;Configuring OpenIG as an OAuth 2.0 Resource Server</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-oauth2-rs">10.1. About OpenIG as an OAuth 2.0 Resource Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-before-you-start">10.2. Preparing the Tutorial</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-openam-config">10.3. Setting Up OpenAM as an Authorization Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-gateway-config">10.4. Configuring OpenIG as a Resource Server</a></span></dt><dt><span class="section"><a href="#oauth2-rs-tutorial-test">10.5. Trying It Out</a></span></dt></dl></div><p>
  This chapter explains how OpenIG acts as an OAuth 2.0 Resource Server,
  and follows with a tutorial
  that shows you how to use OpenIG as a resource server.
 </p><a class="indexterm" name="d851e3221"></a><a class="indexterm" name="d851e3226"></a><a class="indexterm" name="d851e3231"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oauth2-rs"></a>10.1.&nbsp;About OpenIG as an OAuth 2.0 Resource Server</h2></div></div></div><p>
   <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank">The OAuth 2.0 Authorization Framework</a> describes a way of
   allowing a third-party application to access a user's resources
   without having the user's credentials.
   When resources are protected with OAuth 2.0,
   users can use their credentials with an OAuth 2.0-compliant identity provider,
   such as OpenAM, Facebook, Google and others
   to access the resources, rather than setting up an account
   with yet another third-party application.
  </p><div class="itemizedlist"><p>
    In OAuth 2.0, there are four entities involved.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The <em class="firstterm">resource owner</em> is the end user
     who owns protected resources on a resource server.
    </p><p>
     For example, a resource owner has photos stored in a web service.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">resource server</em> provides
     the user's protected resources to authorized client applications.
    </p><p>
     In OAuth 2.0, an authorization server grants the client application
     authorization based on the resource owner's consent.
    </p><p>
     For example, a web service holds user's photos.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">client</em> is the application
     that needs access to the protected resources.
    </p><p>
     For example, a photo printing service needs access to the user's photos.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">authorization server</em> is the service
     responsible for authenticating resource owners and obtaining their consent
     to allow client applications to access their resources.
    </p><p>
     For example, OpenAM can act as the OAuth 2.0 authorization server
     to authenticate resource owners and obtain their consent.
     Other services can play this role as well.
     Google and Facebook for example provide OAuth 2.0 authorization services.
    </p></li></ul></div><p>
   In OAuth 2.0, there are different grant mechanisms
   whereby the client can obtain authorization.
   One grant mechanism involves the client redirecting the resource owner's browser
   to the authorization server to complete authentication and authorization.
   You might have experienced this grant mechanism yourself
   when logging in with your identity provider account to access a web service,
   rather than creating a new account directly with the web service.
   Whatever the grant mechanism,
   the client's aim is to get an
   OAuth 2.0 <em class="firstterm">access token</em> from the authorization server.
  </p><p>
   Access tokens are the credentials used to access protected resources.
   An access token is just a string that represents the authorization
   to access protected resources given by the authorization server.
   An access token, like cash, is a bearer token.
   This means that anyone who has the access token can use it to get the resources.
   Access tokens therefore must be protected,
   so requests involving them must go over HTTPS.
   The advantage of access tokens over passwords or other credentials
   is that access tokens can be granted and revoked
   without exposing the user's credentials.
  </p><p>
   When the client requests access to protected resources,
   it supplies the access token to the resource server housing the resources.
   The resource server must then validate the access token.
   If the access token is found to be valid,
   then the resource server can let the client have access to the resources.
  </p><p>
   When OpenIG acts therefore as an OAuth 2.0 resource server,
   its role is to validate access tokens.
   How an access token is validated is technically not covered
   in the specifications for OAuth 2.0.
   Typically the resource server validates an access token
   by submitting the token to a token information endpoint.
   The token information endpoint typically returns
   the access token, when it expires,
   and the OAuth 2.0 <em class="firstterm">scopes</em> associated with the token,
   potentially with other information.
   In OAuth 2.0, the token scopes are strings
   that can identify the scope of access authorized to the client,
   but can also be used for other purposes.
   For example, OpenAM maps them to user profile attribute values by default,
   and also allows custom scope handling plugins.
  </p><p>
   In the tutorial that follows,
   you configure OpenIG as a resource server,
   and use OpenAM as the OAuth 2.0 authorization server.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-before-you-start"></a>10.2.&nbsp;Preparing the Tutorial</h2></div></div></div><p>
   In the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
   you learned how to configure OpenIG
   to proxy traffic and capture request and response data.
   You also learned how to configure OpenIG
   to use a static request to log in with hard-coded credentials.
  </p><p>
   This tutorial shows you how OpenIG
   can act as an OAuth 2.0 resource server,
   validating OAuth 2.0 access tokens and including token info in the exchange.
  </p><p>
   This tutorial relies on OpenAM as an OAuth 2.0 authorization server.
   As an OAuth 2.0 client of OpenAM, you get an access token.
   You then submit the access token to OpenIG,
   and OpenIG acts as the resource server.
  </p><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   The initial OpenIG configuration file should look like the one used
   to login with a hard-coded username and password, see
   <a href="../gateway-guide/index.html#config-login-static-request" class="link"><em class="citetitle">Configuration for Hard-Coded Credentials</em></a>.
  </p><div class="tip"><h3 class="title">Tip</h3><p>
    If you get stuck running the following samples,
    know that you can activate OpenIG debug logging
    with a "ConsoleLogSink" configuration object.
    Add it as the first object in the array of configuration objects.
   </p><pre class="brush: javascript;">
{
    "name": "LogSink",
    "type": "ConsoleLogSink",
    "config": {
        "level": "DEBUG"
    }
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-openam-config"></a>10.3.&nbsp;Setting Up OpenAM as an Authorization Server</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
   Although this tutorial does not use HTTPS,
   you must use HTTPS to protect access tokens in production environments.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard, Configure OAuth2,
   to configure an OAuth 2.0 authorization server in / (Top Level Realm).
  </p><p>
   Also create an OAuth 2.0 Client profile in / (Top Level Realm).
   This allows you to request an OAuth 2.0 access token on behalf of the client.
   In OpenAM console, browse to
   Access Control &gt; / (Top Level Realm) &gt; Agents &gt; OAuth 2.0 Client,
   and then click New in the Agent table.
  </p><p>
   Create an OAuth 2.0 client profile with name <code class="literal">OpenIG</code>
   and password <code class="literal">password</code>.
   The name is the OAuth 2.0 client_id, and the password is the client_secret.
  </p><p>
   Edit the <code class="literal">OpenIG</code> client profile
   to add <code class="literal">mail</code> and <code class="literal">employeenumber</code> scopes
   to the Scope(s) list, and then save your work.
   In this tutorial,
   you overload these profile settings to pass credentials to OpenIG.
   This tutorial uses <code class="literal">mail</code>
   and <code class="literal">employeenumber</code>
   for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses <code class="literal">mail</code> to hold the username,
   and <code class="literal">employeenumber</code> to hold the password.
   In a real deployment, you would no doubt use other attributes
   that depend on how the real user profiles are configured.
  </p><p>
   Finally, edit the OpenAM demo user to set credentials in
   the Email Address and Employee Number fields of the demo user profile.
   In OpenAM console, browse to the user profile under
   Access Control &gt; / (Top Level Realm) &gt; Subjects &gt; User &gt; demo.
   Set Email Address to <code class="literal">george</code>
   and Employee Number to <code class="literal">costanza</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-gateway-config"></a>10.4.&nbsp;Configuring OpenIG as a Resource Server</h2></div></div></div><p>
   To configure OpenIG as an OAuth 2.0 resource server, you use an
   <a href="../reference/index.html#OAuth2ResourceServerFilter" class="link">OAuth2ResourceServerFilter</a>.
  </p><p>
   The filter expects an OAuth 2.0 access token
   in an incoming <code class="literal">Authorization</code> request header,
   such as the following.
  </p><pre class="brush: http;">
Authorization: Bearer 7af41ddd-47a4-40dc-b530-a9aa9f7ceda9
  </pre><p>
   The filter then uses the access token to validate the token
   and to retrieve token information from the authorization server.
   On successful validation, the filter injects
   the response from the authorization server into
   <code class="literal">exchange.oauth2AccessToken</code>.
  </p><p>
   If no access token is present in the request,
   or token validation does not complete successfully,
   the filter returns an HTTP error status to the user-agent,
   and OpenIG does not continue processing the exchange.
   This is done as specified in the RFC,
   <a class="link" href="http://tools.ietf.org/html/rfc6750" target="_blank">OAuth 2.0 Bearer Token Usage</a>.
  </p><p>
   You can therefore add additional filters and handlers to the chain
   directly after the <code class="literal">OAuth2ResourceServerFilter</code>,
   and expect to have the access token if the filter completes successfully.
  </p><p>
   To configure OpenIG as an OAuth 2.0 resource server,
   replace the <code class="filename">config.json</code> file
   with the new configuration from the example,
   <a href="../gateway-guide/index.html#config-oauth2-rs" class="link"><em class="citetitle">Configuration for an OAuth 2.0 Resource Server</em></a>.
  </p><p>
   Notice "ResourceServer" configuration.
   This configuration includes
   a client handler to send access token validation requests,
   the list of required scopes that the filter expects to find in access tokens,
   the OpenAM token info endpoint used to validate access tokens,
   and <code class="literal">"enforceHttps": false</code> to allow testing
   without having to set up keys and certificates.
   (In production environments, do use HTTPS to protect access tokens.)
  </p><p>
   When the "ResourceServer" filter
   has injected information for a valid access token into the exchange,
   the "CaptureTokenInfo" filter dumps the token information to the log.
   The "CaptureTokenInfo" filter also injects the credentials
   from the user profile in OpenAM into the exchange.
  </p><p>
   Finally, the "LoginRequestFilter" logs a user in to the minimal HTTP server
   by using the credentials injected from the token information.
   In this simple configuration, all requests result in login attempts
   against the minimal HTTP server.
  </p><p>
   After updating <code class="filename">config.json</code>,
   restart Jetty server so that OpenIG loads the new configuration.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2-rs-tutorial-test"></a>10.5.&nbsp;Trying It Out</h2></div></div></div><p>
   To try your configuration, you need an access token.
   Get an access token from OpenAM and use it to access OpenIG
   as in the following example,
   which uses the OAuth 2.0 resource owner password credentials authorization grant.
  </p><div class="screen"><pre>
$ <strong>curl \
 --user "OpenIG:password" \
 --data "grant_type=password&amp;username=demo&amp;password=changeit&amp;scope=mail%20employeenumber" \
 http://openam.example.com:8088/openam/oauth2/access_token</strong>
<em>{
    "scope": "mail employeenumber",
    "expires_in": 600,
    "token_type": "Bearer",
    "refresh_token": "7fe9b284-698e-4738-ad11-01b984920861",
    "access_token": "b8102957-486b-47f2-bd2b-54faa55ec363"
}</em>

$ <strong>curl \
 --header "Authorization: Bearer b8102957-486b-47f2-bd2b-54faa55ec363" \
 http://www.example.com:8080</strong>
<em>...
    &lt;h1&gt;User Information&lt;/h1&gt;

    &lt;dl&gt;
        &lt;dt&gt;Username&lt;/dt&gt;
        &lt;dd&gt;george&lt;/dd&gt;
    &lt;/dl&gt;

    &lt;h1&gt;Request Information&lt;/h1&gt;

    &lt;dl&gt;
        &lt;dt&gt;Method&lt;/dt&gt;
        &lt;dd&gt;POST&lt;/dd&gt;

        &lt;dt&gt;URI&lt;/dt&gt;
        &lt;dd&gt;/&lt;/dd&gt;

        &lt;dt&gt;Headers&lt;/dt&gt;
        &lt;dd style="font-family: monospace; font-size: small;"&gt;...&lt;/dd&gt;
    &lt;/dl&gt;
</em>
  </pre></div><p>
   Also look in the Jetty server output to see the raw token information.
   The raw token information looks something like the following.
  </p><pre class="brush: plain;">
2014-08-04T16:43:38Z:CaptureTokenInfo.CaptureTokenInfo:INFO:
{
    "access_token": "b8102957-486b-47f2-bd2b-54faa55ec363",
    "mail": "george",
    "employeenumber": "costanza",
    "grant_type": "password",
    "scope": [
        "mail",
        "employeenumber"
    ],
    "realm": "/",
    "token_type": "Bearer",
    "expires_in": 35
}
  </pre><p>
   What is happening behind the scenes?
  </p><p>
   After OpenIG gets the <span class="command"><strong>curl</strong></span> request,
   the resource server filter validates the access token with OpenAM,
   and injects the token information into the exchange.
   (If the access token was missing or invalid,
   then the resource server filter would have
   returned an error status to the user-agent.
   The OAuth 2.0 client would then have had to deal with the error.)
  </p><p>
   The "CaptureTokenInfo" filter logs the token information,
   and also extracts the credentials to inject them into the exchange.
   Finally the login filter uses the credentials to log the user in
   to the minimal HTTP server,
   which responds with the User Information page.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-oauth2-client"></a>Chapter&nbsp;11.&nbsp;Configuring OpenIG as an OAuth 2.0 Client</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-oauth2-client">11.1. About OpenIG as an OAuth 2.0 Client</a></span></dt><dt><span class="section"><a href="#about-oidc-rp">11.2. About OpenIG as an OpenID Connect 1.0 Relying Party</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-before-you-start">11.3. Preparing the Tutorial</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-openam-config">11.4. Setting Up OpenAM as an OpenID Provider</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-gateway-config">11.5. Configuring OpenIG as a Relying Party</a></span></dt><dt><span class="section"><a href="#oidc-rp-tutorial-test">11.6. Trying It Out</a></span></dt></dl></div><p>
  This chapter explains how OpenIG acts
  as an OAuth 2.0 client or OpenID Connect 1.0 relying party,
  and follows with a tutorial
  that shows you how to use OpenIG
  as an OpenID Connect 1.0 relying party.
 </p><a class="indexterm" name="d851e3471"></a><a class="indexterm" name="d851e3476"></a><a class="indexterm" name="d851e3481"></a><a class="indexterm" name="d851e3486"></a><a class="indexterm" name="d851e3491"></a><a class="indexterm" name="d851e3496"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oauth2-client"></a>11.1.&nbsp;About OpenIG as an OAuth 2.0 Client</h2></div></div></div><p>
   As described in the chapter on
   <a href="../gateway-guide/index.html#chap-oauth-rs" class="link"><em class="citetitle">Configuring OpenIG as an OAuth 2.0 Resource Server</em></a>,
   an OAuth 2.0 client is the third-party application that needs access
   to a user's protected resources.
   The client application therefore has the user (the OAuth 2.0 resource owner)
   delegate authorization by authenticating
   with an identity provider (the OAuth 2.0 authorization server)
   using an existing account,
   and then consenting to authorize access to protected resources
   (on an OAuth 2.0 resource server).
  </p><p>
   OpenIG can act as an OAuth 2.0 client when you configure an
   <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a>.
   The filter handles the process of allowing the user to select a provider,
   and redirecting the user through the authentication and authorization steps
   of an OAuth 2.0 authorization code grant,
   which results in the authorization server returning an access token to the filter.
   At the outcome of a successful authorization grant,
   the filter injects the access token data
   into a configurable target field of the exchange
   so that subsequent filters and handlers have access
   to the access token.
   Subsequent requests can use the access token without re-authentication.
  </p><p>
   If the protected application is an OAuth 2.0 resource server,
   then OpenIG can send the access token with the resource request.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-oidc-rp"></a>11.2.&nbsp;About OpenIG as an OpenID Connect 1.0 Relying Party</h2></div></div></div><p>
   The specifications available through the
   <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank">OpenID Connect</a> site describe an authentication layer built on OAuth 2.0,
   which is OpenID Connect 1.0.
  </p><p>
   OpenID Connect 1.0 is a specific implementation of OAuth 2.0
   where the identity provider holds the protected resource
   that the third-party application aims to access.
   This resource is the <em class="firstterm">UserInfo</em>,
   information about the authenticated end-user expressed in a standard format.
  </p><div class="itemizedlist"><p>
    In OpenID Connect 1.0, the key entities are the following.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     The <em class="firstterm">end user</em> (OAuth 2.0 resource owner)
     whose user information the application needs to access.
    </p><p>
     The end user wants to use an application
     through existing identity provider account
     without signing up to and creating credentials for yet another web service.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">Relying Party</em> (RP) (OAuth 2.0 client)
     needs access to the end user's protected user information.
    </p><p>
     For example, an online mail application needs to know which end user
     is accessing the application in order to present the correct inbox.
    </p><p>
     As another example, an online shopping site needs to know which end user
     is accessing the site in order to present
     the right offerings, account, and shopping cart.
    </p></li><li class="listitem"><p>
     The <em class="firstterm">OpenID Provider</em> (OP)
     (OAuth 2.0 authorization server and also resource server)
     that holds the user information and grants access.
    </p><p>
     The OP effectively has the end user consent to providing the RP
     with access to some of its user information.
     As OpenID Connect 1.0 defines unique identification for an account
     (subject identifier + issuer identifier),
     the RP can use this as a key to its own user profile.
    </p><p>
     In the case of the online mail application,
     this key could be used to access the mailboxes and related account information.
     In the case of the online shopping site,
     this key could be used to access the offerings, account, shopping cart and so forth.
     The key makes it possible to serve users as if they had local accounts.
    </p></li></ul></div><p>
   When OpenIG acts therefore as an OpenID Connect 1.0 relying party,
   its ultimate role is to retrieve user information from the OpenID provider,
   and then to inject that information into the exchange
   for use by subsequent filters and handlers.
  </p><p>
   In the tutorial that follows,
   you configure OpenIG as a relying party,
   and use OpenAM as the OpenID Provider.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-before-you-start"></a>11.3.&nbsp;Preparing the Tutorial</h2></div></div></div><p>
   In the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>,
   you learned how to configure OpenIG
   to proxy traffic and capture request and response data.
   You also learned how to configure OpenIG
   to use a static request to log in with hard-coded credentials.
  </p><p>
   This tutorial shows you how OpenIG
   can act as an OpenID Connect 1.0 relying party.
  </p><p>
   This tutorial relies on OpenAM as an OpenID Provider.
   As a relying party, OpenIG takes the end user to OpenAM
   for authorization and an access token.
   It then uses the access token to get end user information from OpenAM.
  </p><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><div class="tip"><h3 class="title">Tip</h3><p>
    If you get stuck running the following samples,
    know that you can activate OpenIG debug logging
    with a "ConsoleLogSink" configuration object.
    Add it as the first object in the array of configuration objects.
   </p><pre class="brush: javascript;">
{
    "name": "LogSink",
    "type": "ConsoleLogSink",
    "config": {
        "level": "DEBUG"
    }
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-openam-config"></a>11.4.&nbsp;Setting Up OpenAM as an OpenID Provider</h2></div></div></div><p>
   Install and configure OpenAM on
   <code class="literal">http://openam.example.com:8088/openam</code>
   with the default configuration.
   If you use a different configuration,
   make sure you substitute in the tutorial accordingly.
   Although this tutorial does not use HTTPS,
   you must use HTTPS to protect access tokens and user information
   in production environments.
  </p><p>
   Login to the OpenAM console as administrator,
   and use the common task wizard, Configure OAuth2,
   to configure an OAuth 2.0 authorization server in / (Top Level Realm).
   This also configures OpenAM as an OpenID Provider.
  </p><p>
   Also create an OAuth 2.0 Client profile in / (Top Level Realm).
   This allows OpenIG to communicate with OpenAM as an OAuth 2.0 client.
   In OpenAM console, browse to
   Access Control &gt; / (Top Level Realm) &gt; Agents &gt; OAuth 2.0 Client,
   and then click New in the Agent table.
  </p><p>
   Create an OAuth 2.0 client profile with name <code class="literal">OpenIG</code>
   and password <code class="literal">password</code>.
   The name is the "clientId" value, and the password is the "clientSecret" value
   that you use in the provider configuration in OpenIG.
  </p><p>
   Edit the <code class="literal">OpenIG</code> client profile
   to add the Redirection URI
   <code class="literal">http://www.example.com:8080/openid/callback</code>.
   Also add <code class="literal">openid</code> and <code class="literal">profile</code> scopes
   to the Scope(s) list, and then save your work.
   In this tutorial,
   you overload these profile settings to pass credentials to OpenIG.
   This tutorial uses Full Name and Last Name for the sake of simplicity.
   Both of those attributes are part of a user's profile
   out of the box with the default OpenAM configuration.
   Neither of the attributes are needed for anything else in this tutorial.
   So this tutorial uses Last Name to hold the username,
   and Full Name to hold the password.
   In a real deployment, you would no doubt use other attributes,
   depending upon the user profiles and on your requirements.
  </p><p>
   Finally, edit the OpenAM demo user to set credentials in
   the Last Name and Full Name fields of the demo user profile.
   In OpenAM console, browse to the user profile under
   Access Control &gt; / (Top Level Realm) &gt; Subjects &gt; User &gt; demo.
   Set Last Name to <code class="literal">george</code>
   and Full Name to <code class="literal">costanza</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-gateway-config"></a>11.5.&nbsp;Configuring OpenIG as a Relying Party</h2></div></div></div><p>
   To configure OpenIG as an OpenID Connect 1.0 relying party,
   replace the <code class="filename">config.json</code> file
   with the new configuration from the example,
   <a href="../gateway-guide/index.html#config-oidc-client" class="link"><em class="citetitle">Configuration for an OAuth 2.0 Resource Server</em></a>.
  </p><p>
   Also add the <code class="filename">DumpExchange.groovy</code> script from that section
   under <code class="filename">$HOME/.openig/scripts/groovy</code>
   (<code class="filename">%appdata%\.openig\scripts\groovy</code> on Windows).
   The script is called from the configuration on failure.
  </p><p>
   In the <code class="filename">config.json</code>,
   consider the "OpenIDConnectClient" filter.
   This configuration object has the
   <a href="../reference/index.html#OAuth2ClientFilter" class="link">OAuth2ClientFilter</a> type.
   This is the filter that enables OpenIG to act as a relying party.
  </p><p>
   The filter is configured to work only with a single provider,
   the OpenAM server you configured in
   <a class="xref" href="#oidc-rp-tutorial-openam-config" title="11.4.&nbsp;Setting Up OpenAM as an OpenID Provider">Section&nbsp;11.4, &#8220;Setting Up OpenAM as an OpenID Provider&#8221;</a>.
   If you had more than one provider configured,
   you would need a "loginHandler" as well to help end users pick a provider.
  </p><p>
   The "OpenIDConnectClient" filter has
   a base client endpoint of <code class="literal">/openid</code>.
   Incoming requests to <code class="literal">/openid/login</code>
   start the delegated authorization process.
   Incoming requests to <code class="literal">/openid/callback</code>
   are expected as redirects from the OP (as authorization server),
   so this is why you set the redirect URI in the client profile in OpenAM to
   <code class="literal">http://www.example.com:8080/openid/callback</code>.
  </p><p>
   The "OpenIDConnectClient" filter has <code class="literal">"requireHttps": false</code>
   as a convenience for testing.
   In production environments, require HTTPS.
  </p><p>
   The filter has <code class="literal">"requireLogin": true</code> to ensure you see
   the delegated authorization process when you make your request.
  </p><p>
   In the "OpenIDConnectClient" filter, the target
   for storing authorization state information is
   <code class="literal">${exchange.openid}</code>,
   so this is where subsequent filters and handlers can find
   access token and user information.
  </p><p>
   The scopes are set to "openid" and "profile" as allowed for OpenID Connect 1.0.
  </p><p>
   Notice that on failure the filter dumps the current information in the exchange
   into a web page response to the end user.
   While this is helpful to you for debugging purposes,
   it is not helpful to an end user.
   In production environments, return a more user-friendly failure page.
  </p><p>
   Also in the "OpenIDConnectClient" filter,
   the typical "ClientHandler" configures the HTTP client that communicates
   with the OpenID Provider.
  </p><p>
   Returning to the top of the configuration,
   notice that the "OpenIDConnectChain" invokes an "OutgoingChain" handler
   after the filter injects the access token and user information
   into <code class="literal">exchange.openid</code>.
   The "OutgoingChain" in this case
   extracts credentials from the user information by script ("GetCredentials"),
   and then uses the credentials to log the user in to the minimal HTTP server
   ("LoginRequestFilter").
  </p><p>
   In this simple configuration, all successful requests result in login attempts
   against the minimal HTTP server.
  </p><p>
   After updating <code class="filename">config.json</code>,
   restart Jetty server so that OpenIG loads the new configuration.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oidc-rp-tutorial-test"></a>11.6.&nbsp;Trying It Out</h2></div></div></div><p>
   To try your configuration, browse to OpenIG at
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
  </p><p>
   When redirected to the OpenAM login page,
   login as user <code class="literal">demo</code>, password <code class="literal">changeit</code>,
   and then allow the application access to user information.
  </p><p>
   If successful, OpenIG logs you into the minimal HTTP server
   as George Costanza, and the minimal HTTP server returns George's page.
  </p><p>
   What is happening behind the scenes?
  </p><p>
   After OpenIG gets the browser request,
   the "OpenIDConnectClient" filter redirects you to authenticate with OpenAM
   and consent to authorize access to user information.
   After you authorize access, OpenAM returns an access token to the filter.
   The filter then uses that access token to get the user information.
   Before handling the next filter or handler in the exchange,
   which is the "OutgoingChain",
   the filter injects the authorization state information into
   <code class="literal">exchange.openid</code>.
  </p><p>
   The "OutgoingChain" extracts credentials to re-inject them into the exchange.
   Its login filter then uses the credentials to log the user in
   to the minimal HTTP server, which responds with its User Information page.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-routing"></a>Chapter&nbsp;12.&nbsp;Routing Tutorial</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#routing-before-you-start">12.1. Before You Start</a></span></dt><dt><span class="section"><a href="#routing-route-setup">12.2. Configuring Routes</a></span></dt><dt><span class="section"><a href="#routing-router-setup">12.3. Configuring the Router</a></span></dt><dt><span class="section"><a href="#routing-try-it-out">12.4. Trying it Out</a></span></dt><dt><span class="section"><a href="#routing-lockdown">12.5. Locking Down Route Configurations</a></span></dt></dl></div><a class="indexterm" name="d851e3745"></a><a class="indexterm" name="d851e3748"></a><a class="indexterm" name="d851e3753"></a><a class="indexterm" name="d851e3758"></a><p>
  Other tutorials in this guide demonstrate use of a single configuration file
  for all of OpenIG.
  In those tutorials, you had to restart OpenIG
  to pick up configuration changes.
 </p><p>
  This tutorial instead demonstrates how you can use a
  <a href="../reference/index.html#Router" class="link">Router</a>
  and
  <a href="../reference/index.html#Route" class="link">Route</a> configurations to make changes at runtime.
  This tutorial also shows how to lock down the configurations for deployment
  so that accidental changes to configuration files
  do not affect servers running in production.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-before-you-start"></a>12.1.&nbsp;Before You Start</h2></div></div></div><p>
   Before you start this tutorial,
   prepare OpenIG and the minimal HTTP server as you did for the chapter on
   <a href="../gateway-guide/index.html#chap-quickstart" class="link"><em class="citetitle">Getting Started</em></a>.
  </p><p>
   OpenIG should be running in Jetty,
   configured to access the minimal HTTP server as described in that chapter.
  </p><p>
   The initial OpenIG configuration file should look like the one used
   to proxy requests through to the HTTP server
   and to capture request and response data, see
   <a href="../gateway-guide/index.html#config-proxy-and-capture" class="link"><em class="citetitle">Configuration for Proxy &amp; Capture</em></a>.
  </p><p>
   To test your setup, access the HTTP server home page through OpenIG at
   <a class="link" href="http://www.example.com:8080" target="_blank">http://www.example.com:8080</a>.
   Login as username <code class="literal">george</code>, password <code class="literal">costanza</code>.
   You should see a page showing the username and some information about the request.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-route-setup"></a>12.2.&nbsp;Configuring Routes</h2></div></div></div><p>
   Routes are configuration objects to handle a particular kind of Exchange.
  </p><p>
   The particular kind of an Exchange that a Route handles is
   an Exchange that fits the condition defined for the route.
   The condition is defined using a OpenIG
   <a href="../reference/index.html#Expressions" class="link">expression</a>, so it can be based on
   almost any characteristic of the Exchange.
   Another way to think of the Route is like an independent
   <a href="../reference/index.html#DispatchHandler" class="link">DispatchHandler</a>.
  </p><p>
   Routes can also have their own names, used to order them lexicographically.
   If no name is specified, the Route file name is used.
  </p><p>
   Routes can have a base URI to change the scheme, host, and port of the request.
  </p><p>
   Routes wrap a heap of configuration objects,
   and hand off any Exchange they accept to a handler.
   In this way each Route is much like one of
   the server-wide configuration files you have used in other tutorials.
  </p><p>
   If no condition is specified for the Route, the Route accepts any Exchange.
   The following is a basic default route that accepts any Exchange
   and forwards it on without changes.
   This object explicitly shows you all the fields of the Route object.
   (You could omit "condition" and "baseURI" here as they have no effect.)
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "ClientHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "name": "default",
    "condition": null,
    "baseURI": null,
    "handler": "ClientHandler"
}
  </pre><div class="orderedlist"><p>
    The rest of this section indicates how to set up Route configurations.
    Two of the Route configurations direct requests to
    ForgeRock.com and ForgeRock.org based on a parameter in form data.
    The third Route configuration directs request to
    the minimal HTTP server when the parameter is not set.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Create a file system directory where you store the Route configurations.
    </p><p>
     By default, Route configurations are stored in
     <code class="filename">$HOME/.openig/config/routes</code>
     (<code class="filename">%appdata%\.openig\config\routes</code> on Windows).
     Create that file system directory now.
    </p></li><li class="listitem"><p>
     Add a ForgeRock.com Route file in the directory,
     <code class="filename">forgerock.json</code>,
     that holds the following content.
    </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "ForgeRockChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "name": "ForgeRock",
    "handler": "ForgeRockChain",
    "condition": "${exchange.request.form.site[0] == 'forgerock'}",
    "baseURI": "http://forgerock.com:80/"
}

  </pre><p>
     This Route accepts the Exchange when the form data parameter,
     <code class="literal">site</code> matches <code class="literal">forgerock</code>.
     When this Route picks up an Exchange,
     it changes the request scheme, host, and port, and sends it to ForgeRock.com.
    </p></li><li class="listitem"><p>
     Add a ForgeRock.org community Route file in the directory,
     <code class="filename">community.json</code>,
     that holds the following content.
    </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "CommunityChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "name": "Community",
    "handler": "CommunityChain",
    "condition": "${exchange.request.form.site[0] == 'community'}",
    "baseURI": "http://forgerock.org:80/"
}

  </pre><p>
     This Route accepts the Exchange when the form data parameter,
     <code class="literal">site</code> matches <code class="literal">community</code>.
     When this Route picks up an Exchange,
     it changes the request scheme, host, and port, and sends it to ForgeRock.org.
    </p></li><li class="listitem"><p>
     Add a default Route file in the directory,
     <code class="filename">default.json</code>,
     that holds the following content.
    </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "george"
                        ],
                        "password": [
                            "costanza"
                        ]
                    }
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handler": "LoginChain",
    "name": "zDefault"
}

  </pre><p>
     This Route has no condition set, and so it accepts any Exchange.
     When this Route picks up an Exchange, it uses a static request filter
     to login George Costanza with hard-coded username and password.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-router-setup"></a>12.3.&nbsp;Configuring the Router</h2></div></div></div><p>
   At this point you have configured the Routes,
   but OpenIG does not route any traffic to them.
   To use the routes, you must configure a Router.
  </p><p>
   The Router is a handler that you can configure in the top-level
   <code class="filename">config.json</code> file for OpenIG.<a href="#ftn.d851e3889" class="footnote" name="d851e3889"><sup class="footnote">[2]</sup></a>
   The Router's job is to pass Exchanges to configured Routes,
   and to periodically reload changed route configurations.
   As Routes define the conditions on which they accept any given Exchange,
   the Router does not have to know about specific Routes in advance.
   In other words, you could configure the Router first and then add Routes
   while OpenIG is running.
  </p><div class="orderedlist"><p>
    Configure the Router as follows.
   </p><ol class="orderedlist" type="1"><li class="listitem"><p>
     Stop Jetty.
    </p></li><li class="listitem"><p>
     Replace the existing <code class="filename">config.json</code> file content
     with a simpler configuration that ends in a Router.
    </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "Router",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "Router",
                "type": "Router",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre><p>
     This configuration passes all Exchanges to the Router.
     using the default settings, meaning that the Router
     monitors <code class="filename">$HOME/.openig/config/routes</code> for Routes.
     When OpenIG receives a request,
     if more time has passed than the default scan interval of 10 seconds,
     then OpenIG rescans the Routes directory for changes
     and reloads any Routes changes it finds.
    </p></li><li class="listitem"><p>
     Restart Jetty.
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-try-it-out"></a>12.4.&nbsp;Trying it Out</h2></div></div></div><p>
   At this point you can try your new Router and Route configurations.
  </p><p>
   Make a request to hit the ForgeRock.com router.
  </p><div class="screen"><pre>
$ <strong>curl --data "site=forgerock" http://www.example.com:8080</strong>
<em>...HTML of ForgeRock.com home page...</em>
  </pre></div><p>
   Now make a request to hit the Community page.
  </p><div class="screen"><pre>
$ <strong>curl --data "site=community" http://www.example.com:8080</strong>
<em>...HTML of ForgeRock.org home page...</em>
  </pre></div><p>
   Now check that the default route still works.
  </p><div class="screen"><pre>
$ <strong>curl http://www.example.com:8080 | grep george</strong>
<em>
   &lt;title&gt;Howdy, george&lt;/title&gt;
        &lt;dd&gt;george&lt;/dd&gt;
</em>
  </pre></div><p>
   What happened behind the scenes?
  </p><p>
   When you issued your first request with HTTP POST form data "site=forgerock",
   the request matched the condition defined in the ForgeRock.com Route.
   OpenIG rebased the request and sent it along to
   <code class="literal">http://forgerock.com:80/</code>.
  </p><p>
   When you issued your second request with HTTP POST form data "site=community",
   the request matched the condition defined in the Community Route.
   OpenIG rebased the request and sent it along to
   <code class="literal">http://forgerock.org:80/</code>.
  </p><p>
   When the third request did not match either of the conditions defined,
   the Exchange was routed to the default Route (that accepts any Exchange).
   The static request filter in that route logged George in to the local server
   listening on <code class="literal">http://www.example.com:8081/</code>.
   The default Route has name "zDefault".
  </p><p>
   At this point, tinker with your Route configurations
   without stopping OpenIG, and notice that changes are picked up
   every 10 seconds.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-lockdown"></a>12.5.&nbsp;Locking Down Route Configurations</h2></div></div></div><p>
   Having the Route configurations automatically reloaded is great in the lab,
   but is perhaps not what you want in production.
  </p><p>
   In that case, stop the server, edit the Router "scanInterval", and restart.
   When "scanInterval" is set to -1, the Router only loads routes at startup.
  </p><pre class="brush: javascript;">
{
    "name": "Router",
    "type": "Router",
    "config": {
        "scanInterval": -1
    }
}
  </pre><p>
   You can also change the file system location to look for Routes.
  </p><pre class="brush: javascript;">
{
    "name": "Router",
    "type": "Router",
    "config": {
        "directory": "/path/to/safe/routes",
        "scanInterval": -1
    }
}
  </pre></div><div class="footnotes"><br><hr class="footnote-hr"><div id="ftn.d851e3889" class="footnote"><p><a href="#d851e3889" class="para"><sup class="para">[2] </sup></a>
     In fact you can add a Router wherever you can add a Handler,
     not only in the top-level configuration.
    </p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-gateway-templates"></a>Chapter&nbsp;13.&nbsp;Configuration Templates</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#template-proxy-capture">13.1. Proxy &amp; Capture</a></span></dt><dt><span class="section"><a href="#template-simple-login">13.2. Simple Login Form</a></span></dt><dt><span class="section"><a href="#template-login-cookie">13.3. Login Form With Cookie From Login Page</a></span></dt><dt><span class="section"><a href="#template-login-extract-cookie-filters">13.4. Login Form With Extract Filter &amp; Cookie Filter</a></span></dt><dt><span class="section"><a href="#template-login-hidden-value">13.5. Login Which Requires a Hidden Value From the Login Page</a></span></dt><dt><span class="section"><a href="#template-http-and-https">13.6. HTTP &amp; HTTPS Application</a></span></dt><dt><span class="section"><a href="#template-am-integration-headers">13.7. OpenAM Integration With Headers</a></span></dt><dt><span class="section"><a href="#template-owa-online">13.8. Microsoft Online Outlook Web Access</a></span></dt></dl></div><p>This chapter contains templates of common configurations. Start with one
 of our templates and then modify to suit your deployment. Read the summary of
 each template to find the right match for your application. If you are not
 sure about the characteristics of your application, start with the basic
 Application Capture template. This template allows you to setup basic proxying
 and capture the traffic of the login sequence in a flat file, which then
 allows you to analyze the application and subsequently choose the right
 template or add your own configuration.</p><div class="note"><h3 class="title">Note</h3><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>All templates have the <a href="../reference/index.html#CaptureFilter" class="link">CaptureFilter</a>
    enabled by default. Remove the capture filter from the outgoing chain
    before running the gateway in production. Capturing is typically used only
    for initial development or debugging and may rapidly fill up your available
    disk space if left enabled.</p></li><li class="listitem"><p>Substitute the <code class="literal">TARGETIP</code> tag with the IP address of
    your application.</p></li><li class="listitem"><p>Modify the <code class="literal">LoginRequest</code> filter to match the form
    required for login by your target application.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-proxy-capture"></a>13.1.&nbsp;Proxy &amp; Capture</h2></div></div></div><a class="indexterm" name="d851e4011"></a><p>Proxies all requests and captures them in a flat file. Use this
  template if you need to analyze the traffic for your application. Simply
  change the <code class="literal">baseURI</code> to be that of the target application,
  restart OpenIG, and login to the application. The entire sequence is logged
  to the flat file.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.scheme == 'http'}",
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "condition": "${exchange.request.uri.path == '/login'}",
                            "handler": "LoginChain",
                            "baseURI": "https://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "https://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Sends all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-simple-login"></a>13.2.&nbsp;Simple Login Form</h2></div></div></div><a class="indexterm" name="d851e4028"></a><p>Logs the user into the target application with hard-coded user name
  and password. This template intercepts the login page request and replaces
  it with the login form.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.path == '/login'}",
                            "handler": "LoginChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "https://TARGETIP/login",
                    "form": {
                        "USER": [
                            "myusername"
                        ],
                        "PASSWORD": [
                            "mypassword"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-cookie"></a>13.3.&nbsp;Login Form With Cookie From Login Page</h2></div></div></div><a class="indexterm" name="d851e4042"></a><p>For applications that expect a cookie from the login page to be sent
  in the login request form. This templates allows the login page request to
  go through to the target, intercepts the response, then creates the login
  form and adds the intercepted cookie to the POST.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.path == '/eum/login'}",
                            "handler": "LoginChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "SwitchFilter"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "SwitchFilter",
                "type": "SwitchFilter",
                "config": {
                    "onResponse": [
                        {
                            "handler": "LoginRequestHandler"
                        }
                    ]
                }
            },
            {
                "name": "LoginRequestHandler",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "https://TARGETIP/login",
                    "form": {
                        "USER": [
                            "myusername"
                        ],
                        "PASSWORD": [
                            "mypassword"
                        ]
                    },
                    "headers": {
                        "cookie": [
                            "${exchange.response.headers['Set-Cookie'][0]}"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-extract-cookie-filters"></a>13.4.&nbsp;Login Form With Extract Filter &amp; Cookie Filter</h2></div></div></div><a class="indexterm" name="d851e4056"></a><p>For applications that return the login page when the user tries to
  access a page without a valid session. This template shows how to use the
  <code class="literal">ExtractFilter</code> to find the login page on the response and
  use the <code class="literal">CookieFilter</code> to ensure the cookies from the
  application are replayed on each request. The sample application in this
  template is OpenAM. If you change the <code class="literal">TARGETIP:PORT</code> to be
  the IP address of OpenAM, the <code class="literal">TARGETDN:PORT</code> to be the
  fully qualified name and port of OpenAM and modify <code class="literal">USERNAME</code>
  and <code class="literal">PASSWORD</code> in the <code class="literal">LoginRequest</code> you
  automatically log <code class="literal">USERNAME</code> into OpenAM.</p><div class="note"><h3 class="title">Note</h3><p>Without the <code class="literal">CookieFilter</code> in the
   <code class="literal">OutgoingChain</code> the cookie set in the login page response
   would not get set in the browser since that request is intercepted before
   it gets to the browser. The simplest way to deal with this situation is to
   let OpenIG manage all the cookies by enabling the
   <code class="literal">CookieFilter</code>. The side effect of OpenIG managing
   cookies is none of the cookies are sent to the browser, but are managed
   locally by OpenIG.</p></div><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "FindLoginPageChain",
                            "baseURI": "http://TARGETIP:PORT"
                        }
                    ]
                }
            },
            {
                "name": "FindLoginPageChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "IsLoginPage",
                        "FindLoginPage"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "FindLoginPage",
                "type": "EntityExtractFilter",
                "config": {
                    "messageType": "response",
                    "target": "${exchange.isLoginPage}",
                    "bindings": [
                        {
                            "key": "found",
                            "pattern": "OpenAM\s\(Login\)",
                            "template": "true"
                        }
                    ]
                }
            },
            {
                "name": "IsLoginPage",
                "type": "SwitchFilter",
                "config": {
                    "onResponse": [
                        {
                            "condition": "${exchange.isLoginPage.found == 'true'}",
                            "handler": "LoginChain"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://TARGETIP:PORT/openam/UI/Login",
                    "form": {
                        "IDToken0": [
                            ""
                        ],
                        "IDToken1": [
                            "USERNAME"
                        ],
                        "IDToken2": [
                            "PASSWORD"
                        ],
                        "IDButton": [
                            "Log+In"
                        ],
                        "encoded": [
                            "false"
                        ]
                    },
                    "headers": {
                        "host": [
                            "TARGETFQDN:PORT"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CookieFilter",
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CookieFilter",
                "type": "CookieFilter",
                "config": {}
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": true,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "LogSink",
                "comment": "Default sink for logging information.",
                "type": "ConsoleLogSink",
                "config": {
                    "level": "DEBUG"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-login-hidden-value"></a>13.5.&nbsp;Login Which Requires a Hidden Value From the Login Page</h2></div></div></div><a class="indexterm" name="d851e4106"></a><p>Extracts a hidden value from the login page and includes it in the
  login form POSTed to the target application.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.path == '/login'}",
                            "handler": "LoginChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "HiddenValueExtract",
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "HiddenValueExtract",
                "type": "EntityExtractFilter",
                "config": {
                    "messageType": "response",
                    "target": "${exchange.hiddenValue}",
                    "bindings": [
                        {
                            "key": "value",
                            "pattern": "wpLoginToken\"\s.*value=\"(.*)\"",
                            "template": "$1"
                        }
                    ]
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "https://TARGETIP/login",
                    "form": {
                        "USER": [
                            "myusername"
                        ],
                        "PASSWORD": [
                            "mypassword"
                        ],
                        "hiddenValue": [
                            "${exchange.hiddenValue.value}"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-http-and-https"></a>13.6.&nbsp;HTTP &amp; HTTPS Application</h2></div></div></div><a class="indexterm" name="d851e4120"></a><p>Proxies traffic to an application listening on ports 80 and 443. The
  assumption is the application uses HTTPS for authentication and HTTP for the
  general application features. Assuming the login will all take place on
  port 443, you will need to add the login filters and handlers to the
  <code class="literal">LoginChain</code>. To get started quickly, modify the
  <code class="literal">baseURI</code> to be the <code class="literal">IPAddress</code> of your
  target application. This should allow you to proxy all traffic to the
  application. Then add the logic for the <code class="literal">LoginChain</code> using
  the flow from one of the login templates.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.scheme == 'http'}",
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "condition": "${exchange.request.uri.path == '/login'}",
                            "handler": "LoginChain",
                            "baseURI": "https://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "https://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-am-integration-headers"></a>13.7.&nbsp;OpenAM Integration With Headers</h2></div></div></div><p>Logs the user into the target application using the headers passed down
  from an OpenAM policy agent. This template assumes the user name and
  password are passed down by the OpenAM policy agent as headers. If the
  header passed in contains only a user name or subject and requires a lookup to
  an external data source, you must add an attribute filter to the chain to
  retrieve the credentials.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.path == '/login'}",
                            "handler": "LoginChain",
                            "baseURI": "http://TARGETIP"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://TARGETIP"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "https://TARGETIP/login",
                    "form": {
                        "USER": [
                            "${exchange.request.headers['username'][0]}"
                        ],
                        "PASSWORD": [
                            "${exchange.request.headers['password'][0]}"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "comment": "Responsible for sending all requests to remote servers.",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="template-owa-online"></a>13.8.&nbsp;Microsoft Online Outlook Web Access</h2></div></div></div><a class="indexterm" name="d851e4155"></a><p>A sample template used to log a user into Microsoft Online Outlook Web
  Access. This template shows how you would use OpenIG and the OpenAM
  password capture feature to integrate with OWA. You can follow the
  <a href="../gateway-guide/index.html#chap-password-capture-replay-tutorial" class="link">Tutorial On Password Capture
  &amp; Replay</a> tutorial and substitute this template.</p><div class="informalexample"><pre class="brush: javascript;">
    {
    "heap": {
        "objects": [
            {
                "name": "LogSink",
                "comment": "Default sink for logging information.",
                "type": "ConsoleLogSink",
                "config": {
                    "level": "DEBUG"
                }
            },
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${exchange.request.uri.path == '/owa/auth/logon.aspx'}",
                            "handler": "LoginChain",
                            "baseURI": "https://65.55.171.158"
                        },
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "https://65.55.171.158"
                        }
                    ]
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CryptoHeaderFilter",
                        "LoginRequest"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "CryptoHeaderFilter",
                "type": "CryptoHeaderFilter",
                "config": {
                    "messageType": "REQUEST",
                    "operation": "DECRYPT",
                    "algorithm": "DES/ECB/NoPadding",
                    "key": "DESKEY",
                    "keyType": "DES",
                    "charSet": "utf-8",
                    "headers": [
                        "password"
                    ]
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "https://65.55.171.158/owa/auth/owaauth.dll",
                    "headers": {
                        "Host": [
                            "red001.mail.microsoftonline.com"
                        ],
                        "Content-Type": [
                            "Content-Type:application/x-www-form-urlencoded"
                        ]
                    },
                    "form": {
                        "destination": [
                            "https://red001.mail.microsoftonline.com/owa/"
                        ],
                        "forcedownlevel": [
                            "0"
                        ],
                        "trusted": [
                            "0"
                        ],
                        "username": [
                            "${exchange.request.headers['username'][0]}"
                        ],
                        "password": [
                            "${exchange.request.headers['password'][0]}"
                        ],
                        "isUtf8": [
                            "1"
                        ]
                    }
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "HeaderFilter",
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "HeaderFilter",
                "type": "HeaderFilter",
                "config": {
                    "messageType": "REQUEST",
                    "remove": [
                        "password",
                        "username"
                    ]
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

   </pre></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-scripting"></a>Chapter&nbsp;14.&nbsp;Scripting Filters &amp; Handlers</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#scripting-dispatch">14.1. Scripting Dispatch</a></span></dt><dt><span class="section"><a href="#scripting-http-basic">14.2. Scripting HTTP Basic Authentication</a></span></dt><dt><span class="section"><a href="#scripting-ldap-auth">14.3. Scripting LDAP Authentication</a></span></dt><dt><span class="section"><a href="#scripting-sql">14.4. Scripting SQL Queries</a></span></dt></dl></div><a class="indexterm" name="d851e4173"></a><a class="indexterm" name="d851e4176"></a><p>
  To extend what you can do with Filters and Handlers,
  OpenIG supports dynamic scripting languages like Groovy
  through the use of <code class="literal">ScriptableFilter</code>
  and <code class="literal">ScriptableHandler</code> objects.
 </p><p>
  Interface Stability:
  <a href="../reference/index.html#interface-stability" class="link">Evolving</a>
 </p><p>
  You add these Filters and Handlers to your configuration in the same way
  as for other Filters and Handlers.
  Each takes as its configuration the script's Internet media "type"
  and either a "source" script included in the JSON configuration,
  or a "file" script that OpenIG reads from a file.
 </p><p>
  The following example defines a <code class="literal">ScriptableFilter</code>,
  written in the Groovy language,
  and stored in a file named <code class="filename">SimpleFormLogin.groovy</code>.
 </p><pre class="brush: java;">
{
    "name": "SimpleFormLogin",
    "type": "ScriptableFilter",
    "config": {
        "type": "application/x-groovy",
        "file": "SimpleFormLogin.groovy"
    }
}
 </pre><p>
  Relative paths in the "file" field depend on how OpenIG is installed.
  If OpenIG is installed in an application server,
  then paths for Groovy scripts are relative to
  <code class="filename">$HOME/.openig/scripts/groovy</code>.
 </p><p>
  This base location <code class="filename">$HOME/.openig/scripts/groovy</code>
  is on the classpath when the scripts are executed.
  If therefore some Groovy scripts are not in the default package,
  but instead have their own package names,
  they belong in the directory corresponding to their package name.
  For example, a script in package <code class="literal">com.example.groovy</code>
  belongs under <code class="filename">$HOME/.openig/scripts/groovy/com/example/groovy/</code>.
 </p><p>
  OpenIG provides scripts with several global variables at run time,
  enabling them to access the Exchange,
  to store variables across executions,
  to write messages to the logs,
  and to make requests to a web service or to an LDAP directory service,
  in addition to Groovy's built-in functionality.
  For details, see the reference documentation for
  <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>
  and
  <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a>.
 </p><p>
  This chapter demonstrates some of what you might do using scripts.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-dispatch"></a>14.1.&nbsp;Scripting Dispatch</h2></div></div></div><p>
   In order to route requests, especially when the conditions are complicated,
   you can use a <code class="literal">ScriptableHandler</code> instead of a
   <a href="../reference/index.html#DispatchHandler" class="link">DispatchHandler</a>.
  </p><p>
   The following script demonstrates a simple dispatch handler.
  </p><pre class="brush: java;">
import org.forgerock.openig.http.Response
import org.forgerock.openig.io.ByteArrayBranchingStream

/*
 * This simplistic dispatcher matches the path part of the HTTP request.
 * If the path is /login, it checks Username and Password headers,
 * accepting bjensen:hifalutin, and returning HTTP 403 Forbidden to others.
 * Otherwise it returns HTTP 401 Unauthorized.
 */

// Rather than get the response from an external source,
// this handler produces the response itself.
exchange.response = new Response();

switch (exchange.request.uri.path) {

    case "/login":

        if (exchange.request.headers.Username[0] == "bjensen" &amp;&amp;
                exchange.request.headers.Password[0] == "hifalutin") {

            exchange.response.status = 200
            exchange.response.entity = "&lt;html&gt;&lt;p&gt;Welcome back, Babs!&lt;/p&gt;&lt;/html&gt;"

        } else {

            exchange.response.status = 403
            exchange.response.entity = "&lt;html&gt;&lt;p&gt;Authorization required&lt;/p&gt;&lt;/html&gt;"

        }

        break

    default:

        exchange.response.status = 401
        exchange.response.entity = "&lt;html&gt;&lt;p&gt;Please &lt;a href='./login'&gt;log in&lt;/a&gt;.&lt;/p&gt;&lt;/html&gt;"

        break

}

  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-http-basic"></a>14.2.&nbsp;Scripting HTTP Basic Authentication</h2></div></div></div><p>
   HTTP Basic authentication calls for the user agent such as a browser
   to send a user name and password to the server in an Authorization header.
   HTTP Basic authentication relies on an encrypted connection
   to protect the user name and password credentials,
   which are base64-encoded in the Authorization header, not encrypted.
  </p><p>
   The following script, for use in a <code class="literal">ScriptableFilter</code>,
   adds an Authorization header based on a hard-coded username and password.
  </p><pre class="brush: java;">
/*
 * Perform basic authentication with a hard-coded user name and password.
 */

def credentials = "bjensen:hifalutin".getBytes().encodeBase64().toString()
exchange.request.headers.add("Authorization", "Basic ${credentials}" as String)

// Credentials are only base64-encoded, not encrypted: Set scheme to HTTPS.

/*
 * When connecting over HTTPS, by default the client tries to trust the server.
 * If the server has no certificate
 * or has a self-signed certificate unknown to the client,
 * then the most likely result is an SSLPeerUnverifiedException.
 *
 * To avoid an SSLPeerUnverifiedException,
 * set up HTTPS correctly on the server.
 * Either use a server certificate signed by a well-known CA,
 * or set up the gateway to trust the server certificate.
 *
 */
exchange.request.uri.scheme = "https"

// Call the next handler. This returns when the request has been handled.
next.handle(exchange)

  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-ldap-auth"></a>14.3.&nbsp;Scripting LDAP Authentication</h2></div></div></div><p>
   Many organizations use an LDAP directory service to store user profiles
   including authentication credentials.
   The LDAP directory service securely stores user passwords
   in a highly-available, central service capable of
   handling thousands of authentications per second.
  </p><p>
   The following script, for use in a <code class="literal">ScriptableFilter</code>,
   performs simple authentication against an LDAP server
   based on request form fields
   <code class="literal">username</code> and <code class="literal">password</code>.
  </p><pre class="brush: java;">
import org.forgerock.opendj.ldap.AuthenticationException
import org.forgerock.openig.http.Response
import org.forgerock.openig.io.ByteArrayBranchingStream

/*
 * Perform LDAP authentication based on user credentials from a form.
 *
 * If LDAP authentication succeeds, then call the next handler.
 * If there is a failure, send a response back to the user.
 */

username = exchange.request.form?.username[0]
password = exchange.request.form?.password[0]

// For testing purposes, the LDAP host and port are provided in the exchange.
// Edit as needed to match your directory service.
host = exchange.ldapHost ?: "localhost"
port = exchange.ldapPort ?: 1389

client = ldap.connect(host, port as Integer)
try {

    // Assume the username is an exact match of either
    // the user ID, the email address, or the user's full name.
    filter = "(|(uid=%s)(mail=%s)(cn=%s))"

    user = client.searchSingleEntry(
            "ou=people,dc=example,dc=com",
            ldap.scope.sub,
            ldap.filter(filter, username, username, username))

    client.bind(user.name as String, password?.toCharArray())

    // Authentication succeeded.

    // Set a header (or whatever else you want to do here).
    exchange.request.headers.add("Ldap-User-Dn", user.name)

    // Most LDAP attributes are multi-valued.
    // When you read multi-valued attributes, use the parse() method,
    // with an AttributeParser method
    // that specifies the type of object to return.
    exchange.session.cn = user.cn?.parse().asSetOfString()

    // When you write attribute values, set them directly.
    user.description = "New description set by my script"

    // Here is how you might read a single value of a multi-valued attribute:
    exchange.session.description = user.description?.parse().asString()

    // Call the next handler. This returns when the request has been handled.
    next.handle(exchange)

} catch (AuthenticationException e) {

    // LDAP authentication failed, so fail the exchange with
    // HTTP status code 403 Forbidden.

    exchange.response = new Response()
    exchange.response.status = 403
    exchange.response.reason = e.message
    exchange.response.entity = "&lt;html&gt;&lt;p&gt;Authentication failed: " + e.message + "&lt;/p&gt;&lt;/html&gt;"

} catch (Exception e) {

    // Something other than authentication failed on the server side,
    // so fail the exchange with HTTP 500 Internal Server Error.

    exchange.response = new Response()
    exchange.response.status = 500
    exchange.response.reason = e.message
    exchange.response.entity = "&lt;html&gt;&lt;p&gt;Server error: " + e.message + "&lt;/p&gt;&lt;/html&gt;"

} finally {
    client.close()
}

  </pre><p>
   For the list of methods to specify which type of objects to return,
   see the OpenDJ LDAP SDK Javadoc for
   <a class="link" href="http://docs.forgerock.org/en/opendj/2.6.0/apidocs/index.html?org/forgerock/opendj/ldap/AttributeParser.html" target="_blank">AttributeParser</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting-sql"></a>14.4.&nbsp;Scripting SQL Queries</h2></div></div></div><p>
   You can use a <code class="literal">ScriptableFilter</code>
   to look up information in a relational database
   and include the results in the Exchange.
  </p><p>
   The following filter looks up user credentials in a database
   given the user's email address,
   which is found in the form data of the request.
   The script then sets the credentials in headers,
   making sure the scheme is HTTPS to protect the request
   when it leaves the gateway.
  </p><pre class="brush: java;">
/*
 * Look up user credentials in a relational database
 * based on the user's email address provided in the request form data,
 * and set the credentials in the exchange headers for the next handler.
 */

def client = new SqlClient()
def credentials = client.getCredentials(exchange.request.form?.mail[0])
exchange.request.headers.add("Username", credentials.Username)
exchange.request.headers.add("Password", credentials.Password)

// The credentials are not protected in the headers, so use HTTPS.
exchange.request.uri.scheme = "https"

// Call the next handler. This returns when the request has been handled.
next.handle(exchange)

  </pre><p>
   The previous script demonstrates a <code class="literal">ScriptableFilter</code>
   that uses a <code class="literal">SqlClient</code> class defined in another script.
   The following code listing shows the <code class="literal">SqlClient</code> class.
  </p><pre class="brush: java;">
import groovy.sql.Sql

import javax.naming.InitialContext
import javax.sql.DataSource

/**
 * Access a database with a well-known structure,
 * in particular to get credentials given an email address.
 */
class SqlClient {

    // Get a DataSource from the container.
    InitialContext context = new InitialContext()
    DataSource dataSource = context.lookup("jdbc/forgerock") as DataSource
    def sql = new Sql(dataSource)

    // The expected table is laid out like the following.

    // Table USERS
    // ----------------------------------------
    // | USERNAME  | PASSWORD |   EMAIL   |...|
    // ----------------------------------------
    // | &lt;username&gt;| &lt;passwd&gt; | &lt;mail@...&gt;|...|
    // ----------------------------------------

    String tableName = "USERS"
    String usernameColumn = "USERNAME"
    String passwordColumn = "PASSWORD"
    String mailColumn = "EMAIL"

    /**
     * Get the Username and Password given an email address.
     *
     * @param mail Email address used to look up the credentials
     * @return Username and Password from the database
     */
    def getCredentials(mail) {
        def credentials = [:]
        def query = "SELECT " + usernameColumn + ", " + passwordColumn +
                " FROM " + tableName + " WHERE " + mailColumn + "='$mail';"

        sql.eachRow(query) {
            credentials.put("Username", it."$usernameColumn")
            credentials.put("Password", it."$passwordColumn")
        }
        return credentials
    }
}

  </pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-customizing"></a>Chapter&nbsp;15.&nbsp;Customizing OpenIG</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#extension-points">15.1. Key Extension Points</a></span></dt><dt><span class="section"><a href="#custom-filter">15.2. Implementing a Filter</a></span></dt><dt><span class="section"><a href="#custom-handler">15.3. Implementing a Handler</a></span></dt><dt><span class="section"><a href="#custom-heap-config">15.4. Heap Object Configuration</a></span></dt><dt><span class="section"><a href="#custom-sample-filter">15.5. Sample Filter</a></span></dt></dl></div><p>
  With
  <a href="../reference/index.html#ScriptableFilter" class="link">ScriptableFilter</a>
  and also
  <a href="../reference/index.html#ScriptableHandler" class="link">ScriptableHandler</a> objects,
  you can often avoid customizing OpenIG Java code
  by writing scripts instead.
  For examples, see
  <a href="../gateway-guide/index.html#chap-scripting" class="link">Scripting Filters &amp; Handlers</a>.
 </p><p>
  If scripting is not enough, be aware that
  OpenIG includes a complete
  <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/index.html" target="_blank">application programming interface</a>,
  designed to allow you to customize OpenIG as required.
  Customizing OpenIG can be used to perform complex server interactions
  or intensive data transformations
  that you cannot achieve with scripts or existing handlers, filters and
  <a href="../reference/index.html#Expressions" class="link">expressions</a>.
 </p><p>
  Interface Stability:
  <a href="../reference/index.html#interface-stability" class="link">Evolving</a>
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extension-points"></a>15.1.&nbsp;Key Extension Points</h2></div></div></div><a class="indexterm" name="d851e4340"></a><p>The two primary extension points are the interfaces: <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/filter/Filter.html" target="_blank">Filter</a> (for processing a request and/or response en
  route) and <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/handler/Handler.html" target="_blank">Handler</a> (for generating responses from requests).
  These interfaces are similar to the Java Enterprise Edition
  <code class="literal">Filter</code> and <code class="literal">Servlet</code> interfaces, with
  some differences in the semantics of messages. While you can simply implement
  these interfaces, there are also included convenience classes: <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/filter/GenericFilter.html" target="_blank">GenericFilter</a> and <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/handler/GenericHandler.html" target="_blank">GenericHandler</a> that you can use if you intend to make
  your extensions configurable through the OpenIG configuration
  resource.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-filter"></a>15.2.&nbsp;Implementing a Filter</h2></div></div></div><a class="indexterm" name="d851e4368"></a><p>The <code class="literal">Filter</code> interface exposes a <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/filter/Filter.html#filter(org.forgerock.openig.http.Exchange,%20org.forgerock.openig.handler.Handler)" target="_blank">filter</a> method, which takes an <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html" target="_blank">Exchange</a> object and the <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/filter/Chain.html" target="_blank">Chain</a> of remaining filters and handler to dispatch to. Initially,
  <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html#request" target="_blank">exchange.request</a> contains the request to be filtered. To pass the
  request to the next filter or handler in the chain, the filter calls
  <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/filter/Chain.html#handle(org.forgerock.openig.http.Exchange)" target="_blank">chain.handle(exchange)</a>. After this call, <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html#response" target="_blank">exchange.response</a> contains the response that can be filtered.</p><p>A filter might elect not to pass the request to the next filter or
  handler, and instead handle the request itself. It can achieve this by
  merely avoiding a call to <code class="literal">chain.handle(exchange)</code> and
  creating its own response object in the exchange. The filter is also at
  liberty to replace a response with another of its own. A filter can exist in
  more than one chain, therefore should make no assumptions or correlations
  using the chain it is supplied. The only valid use of a chain by a filter
  is to call its <code class="literal">handle</code> method to dispatch the exchange to
  the rest of the chain.</p><div class="note"><h3 class="title">Note</h3><p>If an existing response exists in the exchange object and the filter
   intends to replace it with its own, it must first check to see if the
   existing response has an <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Message.html#entity" target="_blank">entity</a>, and if it does, must call its <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/io/BranchingInputStream.html#close()" target="_blank">close</a> method in order to signal that the processing of the response
   from a remote server is complete.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-handler"></a>15.3.&nbsp;Implementing a Handler</h2></div></div></div><a class="indexterm" name="d851e4416"></a><p>The <code class="literal">Handler</code> interface exposes a <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/handler/Handler.html#handle(org.forgerock.openig.http.Exchange)" target="_blank">handle</a> method, which takes an <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html#response" target="_blank">Exchange</a> object. It processes the request in
  <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html#request" target="_blank">exchange.request</a> and produces a response in <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Exchange.html#response" target="_blank">exchange.response</a>. A handler can elect to dispatch the exchange to
  another handler or chain.</p><div class="note"><h3 class="title">Note</h3><p>If an existing response exists in the exchange object and the filter
   intends to replace it with its own, it must first check to see if the
   existing response has an <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/http/Message.html#entity" target="_blank">entity</a>, and if it does, must call its <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/io/BranchingInputStream.html#close()" target="_blank">close</a> method in order to signal that the processing of the response
   from a remote server is complete.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-heap-config"></a>15.4.&nbsp;Heap Object Configuration</h2></div></div></div><a class="indexterm" name="d851e4450"></a><p>Objects are added to the heap and supplied with configuration artifacts
  at initialization time. To be integrated with the configuration, a class must
  have an accompanying implementation of the <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/heap/Heaplet.html" target="_blank">Heaplet</a> interface. The easiest and most common way of exposing the
  heaplet is to extend the <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/heap/NestedHeaplet.html" target="_blank">NestedHeaplet</a> class in a nested class in the class you want to create
  and initialize and implementing its <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/heap/GenericHeaplet.html#create()" target="_blank">create</a> method.</p><p>Within the <code class="literal">create</code> method, you can access the
  object's configuration through the <a class="link" href="http://docs.forgerock.org/en/openig/3.0.0/apidocs/org/forgerock/openig/heap/GenericHeaplet.html#config" target="_blank">config</a> field.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-sample-filter"></a>15.5.&nbsp;Sample Filter</h2></div></div></div><p>The following sample filter sets an arbitrary header in the incoming
  request and outgoing response.</p><pre class="brush: java;">package com.example.filter;

// Java Standard Edition
import java.io.IOException;

// OpenIG Core Library
import org.forgerock.openig.filter.Chain;
import org.forgerock.openig.filter.GenericFilter;
import org.forgerock.openig.handler.HandlerException;
import org.forgerock.openig.heap.HeapException;
import org.forgerock.openig.heap.NestedHeaplet;
import org.forgerock.openig.http.Exchange;

public class HelloWorldFilter extends GenericFilter {

    public String name;
    public String value;

    @Override
    public void filter(Exchange exchange, Handler next)
            throws HandlerException, IOException {
        exchange.request.headers.put(name, value); // set header in request
        next.handle(exchange); // pass to remaining filters &amp; handler in chain
        exchange.response.headers.put(name, value); // set header in response
    }

    public static class Heaplet extends NestedHeaplet {

        @Override
        public Object create() throws HeapException {
            HelloWorldFilter filter = new HelloWorldFilter();
            filter.name = config.get("name").required().asString(); // required
            filter.value = config.get("value").required().asString(); // req'd
            return filter;
        }
    }
}</pre><p>The corresponding heap object configuration is as follows.</p><pre class="brush: javascript;">{
     "name": "HelloWorldFilter",
     "type": "com.example.filter.HelloWorldFilter",
     "config": {
         "name": "X-Hello",
         "value": "World" 
     }
}</pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-troubleshooting"></a>Chapter&nbsp;16.&nbsp;Troubleshooting</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#d851e4494">16.1. Object not found in heap</a></span></dt><dt><span class="section"><a href="#d851e4504">16.2. Unexpected character (x) at position 1103</a></span></dt><dt><span class="section"><a href="#d851e4514">16.3. The values in the flat file are incorrect</a></span></dt><dt><span class="section"><a href="#d851e4519">16.4. Problem accessing URL</a></span></dt><dt><span class="section"><a href="#d851e4535">16.5. StaticResponseHandler results in a blank page</a></span></dt><dt><span class="section"><a href="#d851e4542">16.6. OpenIG is not logging users in</a></span></dt><dt><span class="section"><a href="#d851e4551">16.7. Read timed out error when sending a request</a></span></dt></dl></div><a class="indexterm" name="d851e4489"></a><p>This chapter covers common problems and their solutions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4494"></a>16.1.&nbsp;Object not found in heap</h2></div></div></div><pre class="brush: plain;">
HTTP ERROR 500
org.forgerock.openig.model.NodeException:
 ['file:/Users/george/.openig/config/config.json'].heap.objects[2]
  .config.filterObjects[0]: object not found in heap
at org.forgerock.openig.heaplet.HeapUtil.getRequiredObject(HeapUtil.java:54)
at org.forgerock.openig.filter.Chain$Heaplet.create(Chain.java:49)
  </pre><p>You have a filter specified in the filterObjects list in the Chain
  object that is not in <code class="filename">config.json</code>.  Make sure you have
  added an entry for the Filter and have correctly spelled its name in the
  filterObjects list.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4504"></a>16.2.&nbsp;Unexpected character (x) at position 1103</h2></div></div></div><pre class="brush: plain;">
HTTP ERROR 500
Problem accessing /. Reason:

Unexpected character (x) at position 1103
  </pre><p>This error usually means a missing double quote or a missing bracket
  in the configuration file.  Use a JSON editor or JSON validation tool
  such as <a class="link" href="http://jsonlint.com/" target="_blank">JSONLint</a> to make sure your JSON is valid.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4514"></a>16.3.&nbsp;The values in the flat file are incorrect</h2></div></div></div><p>Ensure the flat file is readable by the user running the container for
  OpenIG. Values are all characters, including space and tabs, between the
  separator, so make sure the values are not padded with spaces.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4519"></a>16.4.&nbsp;Problem accessing URL</h2></div></div></div><pre class="brush: plain;">
HTTP ERROR 500

Problem accessing /myURL . Reason:

java.lang.String cannot be cast to java.util.List
Caused by:
java.lang.ClassCastException: java.lang.String cannot be cast to java.util.List
at org.forgerock.openig.filter.LoggingFilter.writeHeaders(LoggingFilter.java:132
at org.forgerock.openig.filter.LoggingFilter.logResponse(LoggingFilter.java:119)
at org.forgerock.openig.filter.LoggingFilter.filter(LoggingFilter.java:86)
at org.forgerock.openig.filter.Chain.handle(Chain.java:54)
  </pre><p>This error is typically encountered when using the <a href="../reference/index.html#AssignmentFilter" class="link">AssignmentFilter</a> and
  setting a string value for one of the Headers. All headers are stored in
  Lists so the header must be addressed with a subscript. For example, if you
  try to set <code class="literal">exchange.request.headers['Location']</code> for a
  redirect in the response object, you should instead set
  <code class="literal">exchange.request.headers['Location'][0]</code>. A header without
  a subscript leads to the error above.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4535"></a>16.5.&nbsp;StaticResponseHandler results in a blank page</h2></div></div></div><p>You must define an entity for the response. For example:</p><pre class="brush: javascript;">{
    "name": "AccessDeniedHandler",
    "type": "org.forgerock.openig.handler.StaticResponseHandler",
    "config": {
        "status": 403,
        "reason": "Forbidden",
        "entity": "&lt;html&gt;&lt;h2&gt;User does not have permission&lt;/h2&gt;&lt;/html&gt;"
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4542"></a>16.6.&nbsp;OpenIG is not logging users in</h2></div></div></div><p>
   If you are proxying to more than one application in multiple DNS domains,
   you must make sure your container is enabled for domain cookies.
   For details on your specific container, see the section on
   <a href="../gateway-guide/index.html#configure-container" class="link"><em class="citetitle">Configuring Deployment Containers</em></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d851e4551"></a>16.7.&nbsp;Read timed out error when sending a request</h2></div></div></div><p>
   If a "baseURI" configuration setting
   causes a request to come back to OpenIG,
   OpenIG never produces a response to the request.
   You then observe the following behavior.
  </p><p>
   You send a request and OpenIG seems to hang.
   Then you see a failure message,
   <code class="literal">HTTP Status 500 - Read timed out</code>,
   accompanied by OpenIG throwing an exception,
   <code class="literal">java.net.SocketTimeoutException: Read timed out</code>.
  </p><p>
   To fix this issue, make sure
   that "baseURI" configuration settings do not cause requests
   to come back to OpenIG.
  </p></div></div><div lang="en" class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="appendix-config"></a>Appendix&nbsp;A.&nbsp;Tutorial Configuration Files</h1></div></div></div><p>
  This appendix holds the following configuration files
  for tutorials in this guide.
 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="#config-proxy-and-capture" title="Example&nbsp;A.1.&nbsp;Configuration for Proxy &amp; Capture">Example&nbsp;A.1, &#8220;Configuration for Proxy &amp; Capture&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-login-static-request" title="Example&nbsp;A.2.&nbsp;Configuration for Hard-Coded Credentials">Example&nbsp;A.2, &#8220;Configuration for Hard-Coded Credentials&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-login-from-file" title="Example&nbsp;A.3.&nbsp;Configuration for Login With Credentials From a File">Example&nbsp;A.3, &#8220;Configuration for Login With Credentials From a File&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-login-from-sql" title="Example&nbsp;A.4.&nbsp;Configuration for Login With Credentials From a Database">Example&nbsp;A.4, &#8220;Configuration for Login With Credentials From a Database&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-capture-and-replay" title="Example&nbsp;A.5.&nbsp;Configuration for Password Capture &amp; Replay">Example&nbsp;A.5, &#8220;Configuration for Password Capture &amp; Replay&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-federation" title="Example&nbsp;A.6.&nbsp;Configuration for the Federation Tutorial">Example&nbsp;A.6, &#8220;Configuration for the Federation Tutorial&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#config-routing" title="Example&nbsp;A.9.&nbsp;Configuration for the Routing Tutorial">Example&nbsp;A.9, &#8220;Configuration for the Routing Tutorial&#8221;</a></p></li></ul></div><div class="example"><a name="config-proxy-and-capture"></a><div class="example-title">Example&nbsp;A.1.&nbsp;Configuration for Proxy &amp; Capture</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre></div></div><br class="example-break"><div class="example"><a name="config-login-static-request"></a><div class="example-title">Example&nbsp;A.2.&nbsp;Configuration for Hard-Coded Credentials</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest",
                        "CaptureFilter"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "demo"
                        ],
                        "password": [
                            "changeit"
                        ]
                    }
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre></div></div><br class="example-break"><div class="example"><a name="config-login-from-file"></a><div class="example-title">Example&nbsp;A.3.&nbsp;Configuration for Login With Credentials From a File</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CredentialsFromFile",
                        "LoginRequest",
                        "CaptureFilter"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "CredentialsFromFile",
                "type": "FileAttributesFilter",
                "config": {
                    "target": "${exchange.credentials}",
                    "file": "/tmp/userfile",
                    "key": "email",
                    "value": "george@example.com",
                    "fields": [
                        "username",
                        "password",
                        "fullname",
                        "email"
                    ]
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.credentials.username}"
                        ],
                        "password": [
                            "${exchange.credentials.password}"
                        ]
                    }
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre></div></div><br class="example-break"><div class="example"><a name="config-login-from-sql"></a><div class="example-title">Example&nbsp;A.4.&nbsp;Configuration for Login With Credentials From a Database</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CredentialsFromSql",
                        "LoginRequest",
                        "CaptureFilter"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "CredentialsFromSql",
                "type": "SqlAttributesFilter",
                "config": {
                    "target": "${exchange.credentials}",
                    "dataSource": "java:comp/env/jdbc/forgerock",
                    "preparedStatement": "SELECT username, password FROM users WHERE email = ?;",
                    "parameters": [
                        "george@example.com"
                    ]
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.credentials.USERNAME}"
                        ],
                        "password": [
                            "${exchange.credentials.PASSWORD}"
                        ]
                    }
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre></div></div><br class="example-break"><div class="example"><a name="config-capture-and-replay"></a><div class="example-title">Example&nbsp;A.5.&nbsp;Configuration for Password Capture &amp; Replay</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "OutgoingChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CryptoHeaderFilter",
                        "LoginRequest",
                        "HeaderFilter",
                        "CaptureFilter"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "CryptoHeaderFilter",
                "type": "CryptoHeaderFilter",
                "config": {
                    "messageType": "REQUEST",
                    "operation": "DECRYPT",
                    "algorithm": "DES/ECB/NoPadding",
                    "key": "DESKEY",
                    "keyType": "DES",
                    "charSet": "utf-8",
                    "headers": [
                        "password"
                    ]
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.request.headers['username'][0]}"
                        ],
                        "password": [
                            "${exchange.request.headers['password'][0]}"
                        ]
                    }
                }
            },
            {
                "name": "HeaderFilter",
                "type": "HeaderFilter",
                "config": {
                    "messageType": "REQUEST",
                    "remove": [
                        "password",
                        "username"
                    ]
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": true,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}
  </pre></div></div><br class="example-break"><div class="example"><a name="config-federation"></a><div class="example-title">Example&nbsp;A.6.&nbsp;Configuration for the Federation Tutorial</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "LogSink",
                "comment": "Default sink for logging information.",
                "type": "ConsoleLogSink",
                "config": {
                    "level": "DEBUG"
                }
            },
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "condition": "${matches(exchange.request.uri.path, '^/saml')}",
                            "handler": "SamlFederationHandler"
                        },
                        {
                            "condition": "${empty exchange.session.username}",
                            "handler": "SPInitiatedSSORedirectHandler",
                            "baseURI": "http://www.example.com:8081"
                        },
                        {
                            "handler": "LoginChain",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "SamlFederationHandler",
                "type": "org.forgerock.openig.handler.saml.SamlFederationHandler",
                "config": {
                    "assertionMapping": {
                        "username": "mail",
                        "password": "employeenumber"
                    },
                    "subjectMapping": "subjectName",
                    "redirectURI": "/"
                }
            },
            {
                "name": "SPInitiatedSSORedirectHandler",
                "type": "StaticResponseHandler",
                "config": {
                    "status": 302,
                    "reason": "Found",
                    "headers": {
                        "Location": [
                            "http://www.example.com:8080/saml/SPInitiatedSSO"
                        ]
                    }
                }
            },
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.session.username}"
                        ],
                        "password": [
                            "${exchange.session.password}"
                        ]
                    }
                }
            },
            {
                "name": "ClientHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}
  </pre></div></div><br class="example-break"><div class="example"><a name="config-oauth2-rs"></a><div class="example-title">Example&nbsp;A.7.&nbsp;Configuration for an OAuth 2.0 Resource Server</div><div class="example-contents"><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "ResourceServerChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter",
                        "ResourceServer",
                        "CaptureTokenInfo",
                        "LoginRequestFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": false,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ResourceServer",
                "type": "OAuth2ResourceServerFilter",
                "config": {
                    "httpHandler": "ClientHandler",
                    "requiredScopes": [
                        "mail",
                        "employeenumber"
                    ],
                    "tokenInfoEndpoint": "http://openam.example.com:8088/openam/oauth2/tokeninfo",
                    "enforceHttps": false
                }
            },
            {
                "name": "CaptureTokenInfo",
                "type": "ScriptableFilter",
                "config": {
                    "type": "application/x-groovy",
                    "source"
                          : "logger.info(exchange.oauth2AccessToken.rawInfo.toString());
                            exchange.username = exchange.oauth2AccessToken.rawInfo.get('mail').asString();
                            exchange.password = exchange.oauth2AccessToken.rawInfo.get('employeenumber').asString();
                            next.handle(exchange)"
                }
            },
            {
                "name": "LoginRequestFilter",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.username}"
                        ],
                        "password": [
                            "${exchange.password}"
                        ]
                    }
                }
            },
            {
                "name": "ClientHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "ResourceServerChain",
    "baseURI": "http://www.example.com:8081"
}

  </pre></div></div><br class="example-break"><div class="example"><a name="config-oidc-client"></a><div class="example-title">Example&nbsp;A.8.&nbsp;Configuration for an OpenID Connect 1.0 Client</div><div class="example-contents"><p>
   The following listing shows <code class="filename">config.json</code>
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "OpenIDConnectChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter",
                        "OpenIDConnectClient"
                    ],
                    "handler": "OutgoingChain"
                }
            },
            {
                "name": "OpenIDConnectClient",
                "type": "OAuth2ClientFilter",
                "config": {
                    "clientEndpoint": "/openid",
                    "requireHttps": false,
                    "requireLogin": true,
                    "target": "${exchange.openid}",
                    "scopes": [
                        "openid",
                        "profile"
                    ],
                    "failureHandler": "Dump",
                    "providerHandler": "ClientHandler",
                    "providers": [
                        {
                            "name": "openam",
                            "wellKnownConfiguration":
                              "http://openam.example.com:8088/openam/.well-known/openid-configuration",
                            "clientId": "${projectName}",
                            "clientSecret": "password"
                        }
                    ]
                }
            },
            {
                "name": "Dump",
                "type": "Chain",
                "config": {
                    "filters": [
                        "CaptureFilter"
                    ],
                    "handler": "DumpExchange"
                }
            },
            {
                "name": "DumpExchange",
                "type": "ScriptableHandler",
                "config": {
                    "type": "application/x-groovy",
                    "file": "DumpExchange.groovy"
                }
            },
            {
                "name": "OutgoingChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "GetCredentials",
                        "LoginRequestFilter",
                        "CaptureFilter"
                    ],
                    "handler": "ClientHandler"
                }
            },
            {
                "name": "GetCredentials",
                "type": "ScriptableFilter",
                "config": {
                    "type": "application/x-groovy",
                    "source": "exchange.username = exchange.openid.user_info.family_name;
                               exchange.password = exchange.openid.user_info.name;
                               next.handle(exchange)"
                }
            },
            {
                "name": "LoginRequestFilter",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "${exchange.username}"
                        ],
                        "password": [
                            "${exchange.password}"
                        ]
                    }
                }
            },
            {
                "name": "CaptureFilter",
                "type": "CaptureFilter",
                "config": {
                    "captureEntity": true,
                    "file": "/tmp/gateway.log"
                }
            },
            {
                "name": "ClientHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handlerObject": "OpenIDConnectChain"
}

  </pre><p>
   The following listing shows <code class="filename">DumpExchange.groovy</code>
  </p><pre class="brush: java;">
import org.forgerock.openig.http.Response
import groovy.json.JsonOutput

map = new LinkedHashMap(exchange)
map.remove("exchange")
map.remove("javax.servlet.http.HttpServletRequest")
map.remove("javax.servlet.http.HttpServletResponse")

json = JsonOutput.prettyPrint(JsonOutput.toJson(map))

exchange.response = new Response()
exchange.response.status = 200
exchange.response.entity = "&lt;html&gt;&lt;pre&gt;" + json + "&lt;/pre&gt;&lt;/html&gt;"

  </pre></div></div><br class="example-break"><div class="example"><a name="config-routing"></a><div class="example-title">Example&nbsp;A.9.&nbsp;Configuration for the Routing Tutorial</div><div class="example-contents"><p>
   The following listing shows <code class="filename">config.json</code>
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "DispatchHandler",
                "type": "DispatchHandler",
                "config": {
                    "bindings": [
                        {
                            "handler": "Router",
                            "baseURI": "http://www.example.com:8081"
                        }
                    ]
                }
            },
            {
                "name": "Router",
                "type": "Router",
                "config": {}
            }
        ]
    },
    "handlerObject": "DispatchHandler"
}

  </pre><p>
   The following listing shows <code class="filename">community.json</code>
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "CommunityChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "name": "Community",
    "handler": "CommunityChain",
    "condition": "${exchange.request.form.site[0] == 'community'}",
    "baseURI": "http://forgerock.org:80/"
}

  </pre><p>
   The following listing shows <code class="filename">default.json</code>
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "LoginChain",
                "type": "Chain",
                "config": {
                    "filters": [
                        "LoginRequest"
                    ],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "LoginRequest",
                "type": "StaticRequestFilter",
                "config": {
                    "method": "POST",
                    "uri": "http://www.example.com:8081",
                    "form": {
                        "username": [
                            "george"
                        ],
                        "password": [
                            "costanza"
                        ]
                    }
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "handler": "LoginChain",
    "name": "zDefault"
}

  </pre><p>
   The following listing shows <code class="filename">forgerock.json</code>
  </p><pre class="brush: javascript;">
{
    "heap": {
        "objects": [
            {
                "name": "ForgeRockChain",
                "type": "Chain",
                "config": {
                    "filters": [],
                    "handler": "DefaultHandler"
                }
            },
            {
                "name": "DefaultHandler",
                "type": "ClientHandler",
                "config": {}
            }
        ]
    },
    "name": "ForgeRock",
    "handler": "ForgeRockChain",
    "condition": "${exchange.request.form.site[0] == 'forgerock'}",
    "baseURI": "http://forgerock.com:80/"
}

  </pre></div></div><br class="example-break"></div><div class="index"><div class="titlepage"><div><div><h1 class="title"><a name="d851e4695"></a>Index</h1></div></div></div><div class="index"><div class="indexdiv"><h3>A</h3><dl><dt>Architecture, <a class="indexterm" href="#chap-howitworks">How OpenIG Works</a></dt></dl></div><div class="indexdiv"><h3>C</h3><dl><dt>Configuration</dt><dd><dl><dt>Federation, <a class="indexterm" href="#federation-configuration-files">Configuration File Overview</a>, <a class="indexterm" href="#federation-configuration">Configuring the Federation Handler</a></dt><dt>HTTP &amp; HTTPS, <a class="indexterm" href="#template-http-and-https">HTTP &amp; HTTPS Application</a></dt><dt>Login with cookie, <a class="indexterm" href="#template-login-cookie">Login Form With Cookie From Login Page</a></dt><dt>Login with filter, <a class="indexterm" href="#template-login-extract-cookie-filters">Login Form With Extract Filter &amp; Cookie Filter</a></dt><dt>Login with hidden value, <a class="indexterm" href="#template-login-hidden-value">Login Which Requires a Hidden Value From the Login Page</a></dt><dt>Microsoft Online Outlook Web Access, <a class="indexterm" href="#template-owa-online">Microsoft Online Outlook Web Access</a></dt><dt>Multiple applications, <a class="indexterm" href="#chap-routing">Routing Tutorial</a></dt><dt>OAuth 2.0, <a class="indexterm" href="#chap-oauth-rs">Configuring OpenIG as an OAuth 2.0 Resource Server</a>, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt><dt>OpenID Connect 1.0, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt><dt>Proxy &amp; capture, <a class="indexterm" href="#template-proxy-capture">Proxy &amp; Capture</a></dt><dt>Run time changes, <a class="indexterm" href="#chap-routing">Routing Tutorial</a></dt><dt>Simple login form, <a class="indexterm" href="#template-simple-login">Simple Login Form</a></dt></dl></dd><dt>Containers</dt><dd><dl><dt>Jetty, <a class="indexterm" href="#jetty">Configuring Jetty For OpenIG</a></dt><dt>Tomcat, <a class="indexterm" href="#tomcat">Configuring Apache Tomcat For OpenIG</a></dt></dl></dd><dt>Customizations</dt><dd><dl><dt>Extension points, <a class="indexterm" href="#extension-points">Key Extension Points</a></dt><dt>Filters, <a class="indexterm" href="#custom-filter">Implementing a Filter</a></dt><dt>Handlers, <a class="indexterm" href="#custom-handler">Implementing a Handler</a></dt><dt>Heap objects, <a class="indexterm" href="#custom-heap-config">Heap Object Configuration</a></dt><dt>Scripting, <a class="indexterm" href="#chap-scripting">Scripting Filters &amp; Handlers</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>I</h3><dl><dt>Installation, <a class="indexterm" href="#chap-install">Installing OpenIG</a></dt><dd><dl><dt>Federation, <a class="indexterm" href="#federation-installation">Installation Overview</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>O</h3><dl><dt>OAuth 2.0</dt><dd><dl><dt>Client, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt><dt>Resource server, <a class="indexterm" href="#chap-oauth-rs">Configuring OpenIG as an OAuth 2.0 Resource Server</a></dt></dl></dd><dt>OpenID Connect 1.0</dt><dd><dl><dt>Relying party, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>Routing, <a class="indexterm" href="#chap-routing">Routing Tutorial</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>Scripting, <a class="indexterm" href="#chap-scripting">Scripting Filters &amp; Handlers</a></dt></dl></div><div class="indexdiv"><h3>T</h3><dl><dt>Troubleshooting, <a class="indexterm" href="#chap-troubleshooting">Troubleshooting</a></dt><dt>Tutorials</dt><dd><dl><dt>Capture &amp; relay passwords, <a class="indexterm" href="#chap-password-capture-replay-tutorial">Tutorial On OpenAM Password Capture &amp; Replay</a></dt><dt>Credentials from a file, <a class="indexterm" href="#chap-credentials-tutorial">Tutorial On Looking Up Credentials</a></dt><dt>Credentials from a relational database, <a class="indexterm" href="#chap-credentials-tutorial">Tutorial On Looking Up Credentials</a></dt><dt>Federation, <a class="indexterm" href="#chap-federation-tutorial">Tutorial For OpenIG Federation</a></dt><dt>Getting started, <a class="indexterm" href="#chap-quickstart">Getting Started</a></dt><dt>OAuth 2.0, <a class="indexterm" href="#chap-oauth-rs">Configuring OpenIG as an OAuth 2.0 Resource Server</a>, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt><dt>OpenID Connect 1.0, <a class="indexterm" href="#chap-oauth2-client">Configuring OpenIG as an OAuth 2.0 Client</a></dt><dt>Routing, <a class="indexterm" href="#chap-routing">Routing Tutorial</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>U</h3><dl><dt>Use cases, <a class="indexterm" href="#portal-app-login">Portal Application Login</a>, <a class="indexterm" href="#am-integration">OpenAM Integration</a>, <a class="indexterm" href="#sp-initiated-sso">OpenIG Federation SP Initiated SAML 2.0 SSO</a>, <a class="indexterm" href="#idp-initiated-sso">OpenIG Federation IDP Initiated SAML 2.0 SSO</a></dt></dl></div></div></div></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10060&components=10220&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-14']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>