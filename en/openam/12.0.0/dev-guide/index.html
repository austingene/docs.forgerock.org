<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>OpenAM Developer's Guide</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="description" content="Guide to developing OpenAM client applications and service providers. OpenAM provides open source Authentication, Authorization, Entitlement and Federation software."><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="dev-guide"></a>OpenAM Developer's Guide</h1></div><div><h2 class="subtitle">Version 12.0.0</h2></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Mark </span> <span class="surname">Craig</span></h3></div><div class="author"><h3 class="author"><span class="firstname">David </span> <span class="surname">Goldsmith</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Gene </span> <span class="surname">Hirayama</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Mike </span> <span class="surname">Jang</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Chris </span> <span class="surname">Lee</span></h3></div><div class="author"><h3 class="author"><span class="firstname">Peter </span> <span class="surname">Major</span></h3><div lang="en" class="affiliation"><span class="orgname">ForgeRock AS<br></span><div class="address"><p><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="street">33&nbsp;New&nbsp;Montgomery&nbsp;St.</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="otheraddr">Suite&nbsp;1500</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="city">San&nbsp;Francisco</span>,&nbsp;<span class="state">CA</span>&nbsp;<span class="postcode">94105</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="country">USA</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="phone">+1&nbsp;415-599-1100&nbsp;(US)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<code class="uri">www.forgerock.com</code><br>
&nbsp;&nbsp;&nbsp;</p></div></div></div></div></div><div><p class="releaseinfo">Software release date: December 18, 2014</p></div><div><p class="copyright">Copyright &copy; 2011-2014 ForgeRock AS</p></div><div><a href="legalnotice.html">Legal Notice</a></div><div><p class="pubdate">Publication date: December 18, 2014</p></div><div><div class="abstract"><div class="abstract-title">Abstract</div><p>Guide to developing OpenAM client applications and service providers.
   OpenAM provides open source Authentication, Authorization, Entitlement and
   Federation software.</p></div></div></div><hr></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#chap-api-overview">1. OpenAM APIs and Protocols</a></span></dt><dt><span class="chapter"><a href="#chap-client-dev">2. Developing Client Applications</a></span></dt><dt><span class="chapter"><a href="#chap-rest">3. RESTful Web Services</a></span></dt><dt><span class="chapter"><a href="#chap-rest-authz-policy">4. RESTful Authorization and Policy Management Services</a></span></dt><dt><span class="chapter"><a href="#chap-rest-oauth2-oidc">5. RESTful OAuth 2.0 and OpenID Connect 1.0 Services</a></span></dt><dt><span class="chapter"><a href="#chap-rest-user-services">6. RESTful User Self-Service</a></span></dt><dt><span class="chapter"><a href="#chap-rest-identity-realm-mgmt">7. RESTful Identity and Realm Management Services</a></span></dt><dt><span class="chapter"><a href="#chap-rest-sts">8. RESTful Secure Token Service</a></span></dt><dt><span class="chapter"><a href="#chap-jdk">9. Using the OpenAM Java SDK</a></span></dt><dt><span class="chapter"><a href="#chap-authentication">10. Authenticating Using OpenAM Java SDK</a></span></dt><dt><span class="chapter"><a href="#chap-session">11. Handling Single Sign-On Using OpenAM Java SDK</a></span></dt><dt><span class="chapter"><a href="#chap-policy-decisions">12. Requesting Policy Decisions Using OpenAM Java SDK</a></span></dt><dt><span class="chapter"><a href="#chap-xacml">13. Requesting a XACML Policy Decision Using OpenAM Java SDK</a></span></dt><dt><span class="chapter"><a href="#chap-fedlet-java">14. Using Fedlets in Java Web Applications</a></span></dt><dt><span class="chapter"><a href="#chap-fedlet-dotnet">15. Using Fedlets in .NET Applications</a></span></dt><dt><span class="chapter"><a href="#chap-sae">16. Using Secure Attribute Exchange</a></span></dt><dt><span class="chapter"><a href="#chap-csdk">17. Using the OpenAM C API</a></span></dt><dt><span class="chapter"><a href="#chap-extending">18. Extending OpenAM</a></span></dt><dt><span class="chapter"><a href="#chap-custom-attr">19. Customizing Profile Attributes</a></span></dt><dt><span class="chapter"><a href="#chap-oauth2-scopes">20. Customizing OAuth 2.0 Scope Handling</a></span></dt><dt><span class="chapter"><a href="#chap-scripted-auth-module">21. Scripted Authentication</a></span></dt><dt><span class="chapter"><a href="#chap-auth-spi">22. Customizing Authentication Modules</a></span></dt><dt><span class="chapter"><a href="#chap-custom-quota-exhaustion-action">23. Customizing Session Quota Exhaustion Actions</a></span></dt><dt><span class="chapter"><a href="#chap-post-auth">24. Creating a Post Authentication Plugin</a></span></dt><dt><span class="chapter"><a href="#chap-policy-spi">25. Customizing Policy Evaluation</a></span></dt><dt><span class="chapter"><a href="#chap-identity-repo-spi">26. Customizing Identity Data Storage</a></span></dt><dt><span class="index"><a href="#d13846e14224">Index</a></span></dt></dl></div><div lang="en" class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="preface"></a>Preface</h1></div></div></div><p>This guide demonstrates how to handle sessions to permit single sign
 on and single log out in OpenAM client applications. This guide further
 demonstrates how to use the OpenAM APIs including both APIs for client
 applications, and also SPIs for authentication, policy, service management,
 delegation, and identity storage. Finally, this guide demonstrates how to
 write your own web policy agent.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d13846e175"></a>1.&nbsp;Who Should Use this Guide</h2></div></div></div><p>This guide is written for developers who adapt client applications
  to use OpenAM access management capabilities. It is also written for
  designers and developers extending and integrating OpenAM services for
  their organizations.</p><p>You do not need to be an OpenAM wizard to learn something from
  this guide, though a background in access management and developing
  web applications or developing for web and application servers can help.
  You can nevertheless get started with this guide, and then learn more as you
  go along.</p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="formatting-conventions"></a>2.&nbsp;Formatting Conventions</h2></div></div></div><p>
  Most examples in the documentation are created on GNU/Linux or Mac OS X.

  Where it is helpful to make a distinction between operating environments,
  examples for UNIX, GNU/Linux, Mac OS X, and so forth are labeled (UNIX).
  Mac OS X specific examples can be labeled (Mac OS X).
  Examples for Microsoft Windows can be labeled (Windows).

  To avoid repetition, however, file system directory names are
  often given only in UNIX format as in <code class="filename">/path/to/server</code>,
  even if the text applies to <code class="filename">C:\path\to\server</code> as well.
 </p><p>
  Absolute path names usually begin with the placeholder
  <code class="filename">/path/to/</code>.

  This path might translate to <code class="filename">/opt/</code>,
  <code class="filename">C:\Program Files\</code>, or somewhere else on your system.
 </p><p>
  Command line, terminal sessions are formatted as follows.
 </p><div class="screen"><pre>$ <strong>echo $JAVA_HOME</strong>
<em>/path/to/jdk</em></pre></div><p>
  Command output is sometimes formatted for narrower, more readable output
  even though formatting parameters are not shown in the command.
  In the following example, the query string parameter
  <code class="literal">_prettyPrint=true</code> is omitted.
 </p><div class="screen"><pre>
$ <strong>curl https://bjensen:hifalutin@opendj.example.com:8443/users/newuser</strong>
<em>{
  "_rev" : "000000005b337348",
  "schemas" : [ "urn:scim:schemas:core:1.0" ],
  "contactInformation" : {
    "telephoneNumber" : "+1 408 555 1212",
    "emailAddress" : "newuser@example.com"
  },
  "_id" : "newuser",
  "name" : {
    "familyName" : "New",
    "givenName" : "User"
  },
  "userName" : "newuser@example.com",
  "displayName" : "New User",
  "meta" : {
    "created" : "2014-06-03T09:58:27Z"
  },
  "manager" : [ {
    "_id" : "kvaughan",
    "displayName" : "Kirsten Vaughan"
  } ]
}</em>
 </pre></div><p>
  Program listings are formatted as follows.
 </p><pre class="brush: java;">class Test {
    public static void main(String [] args)  {
        System.out.println("This is a program listing.");
    }
}</pre></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="accessing-doc-online"></a>3.&nbsp;Accessing Documentation Online</h2></div></div></div><p>
  ForgeRock core documentation, such as what you are now reading, aims to be
  technically accurate and complete with respect to the software documented.
 </p><div class="itemizedlist"><p>
   Core documentation therefore follows a three-phase review process
   designed to eliminate errors.
  </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Product managers and software architects review project documentation design
    with respect to the users' software lifecycle needs.
   </p></li><li class="listitem"><p>
    Subject matter experts review proposed documentation changes for
    technical accuracy and completeness
    with respect to the corresponding software.
   </p></li><li class="listitem"><p>
    Quality experts validate implemented documentation changes for
    technical validity with respect to the software,
    technical completeness with respect to the scope of the document,
    and usability for the expected audience.
   </p></li></ul></div><p>
  The review process helps to ensure that documentation published for
  a ForgeRock release is technically accurate and complete.
 </p><p>
  Fully reviewed, published core documentation is available at
  <a class="link" href="http://docs.forgerock.org/" target="_blank">http://docs.forgerock.org/</a>.

  Use this documentation when working with a ForgeRock Enterprise release.
 </p><p>
  In-progress documentation can be found at each project site under the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> projects page.

  Use this documentation when trying a nightly build.
 </p><p>
  The ForgeRock <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a> and provide additional, user-created information.

  We encourage you to
  <a class="link" href="https://sso.forgerock.com/openam/UI/Login" target="_blank">join the community</a>, so that you can update the Wikis, too.
 </p></div><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="joining-the-community"></a>4.&nbsp;Joining the ForgeRock Community</h2></div></div></div><p>
  After you
  <a class="link" href="https://backstage.forgerock.com/#/account/register" target="_blank">sign up</a> to join the ForgeRock community,
  you can edit the
  <a class="link" href="https://wikis.forgerock.org/" target="_blank">Community Wikis</a>,
  and also log bugs and feature requests in the
  <a class="link" href="https://bugster.forgerock.org/" target="_blank">issue tracker</a>.
 </p><p>
  If you have a question regarding a project but cannot find an answer
  in the project documentation or Wiki, browse to the
  <a class="link" href="http://forgerock.org" target="_blank">Developer Community</a> page for the project,
  where you can find details on joining the project mailing lists,
  and find links to mailing list archives.

  You can also suggest updates to documentation through the
  <a class="link" href="https://lists.forgerock.org/mailman/listinfo/docs" target="_blank">ForgeRock docs mailing list</a>.
 </p><p>
  The Community Wikis describe how to check out and build source code.

  Should you want to contribute a patch, test, or feature,
  or want to author part of the core documentation,
  first have a look on the ForgeRock site at
  <a class="link" href="http://forgerock.org/get_involved.html" target="_blank">how to get involved</a>.
 </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-api-overview"></a>Chapter&nbsp;1.&nbsp;OpenAM APIs and Protocols</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#openam-apis">1.1. OpenAM APIs</a></span></dt><dt><span class="section"><a href="#openam-spis">1.2. OpenAM SPIs</a></span></dt><dt><span class="section"><a href="#openam-ipv">1.3. OpenAM, IPv4, and IPv6</a></span></dt></dl></div><p>Although policy agents and standards support make it possible for
 applications to use OpenAM for access management without changing your
 code, some deployments require tighter integration, or direct use of
 supported protocols and OpenAM APIs.</p><p>OpenAM supports a range of protocols and APIs that allow you not
 only to define specifically how access is managed in your client
 applications, but also to extend OpenAM capabilities to meet even
 those deployment requirements not yet covered in OpenAM.</p><p>This short chapter presents an overview of the APIs and protocols that
 OpenAM supports.</p><div class="mediaobject" align="center"><a name="figure-openam-apis-overview"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/openam-apis-overview.png" align="middle" height="360" alt="High-level view of OpenAM APIs and SPIs"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-openam-apis-overview.html" target="longdesc">D</a>]</span></div></div><p>This guide primarily covers the OpenAM client APIs and SPIs, with
 emphasis on the Java APIs.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="openam-apis"></a>1.1.&nbsp;OpenAM APIs</h2></div></div></div><p>OpenAM provides client application programming interfaces for a variety
  of needs.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The OpenAM Java APIs provided through the OpenAM Java SDK let your
    Java and Java EE applications call on OpenAM for authentication, and
    authorization in both OpenAM and federated environments.</p><p>Detailed reference information is provided in the <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Java SDK API Specification</em></a>.</p></li><li class="listitem"><p>The C SDK also provides APIs for native applications, such as new
    web server policy agents. The C SDK is delivered with OpenAM for Linux,
    Solaris, and Windows platforms.</p></li><li class="listitem"><p>OpenAM exposes a RESTful API that can return JSON or XML over HTTP,
    allowing you to access authentication, authorization, and identity
    services from your web applications using REST clients in the language of
    your choice.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="openam-spis"></a>1.2.&nbsp;OpenAM SPIs</h2></div></div></div><p>OpenAM provides Java based service provider interfaces to let you
  extend services for the requirements of your particular deployment.</p><div class="itemizedlist"><p>Some examples of the plugins you can write follow in the list below.
   This guide demonstrates how to implement such plugins.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Custom OAuth 2.0 scopes plugins define how OpenAM playing the role
    of authorization server handles scopes, including what token information to
    return regarding scopes set when authorization was granted.</p></li><li class="listitem"><p>Custom authentication plugins let OpenAM authenticate users against
    a new authentication service or an authentication service specific to your
    deployment</p></li><li class="listitem"><p>Post authentication plugins perform additional processing at the end
    of the authentication process, but before the subject is authenticated.
    Post authentication plugins can for example store information about the
    authentication in the user's profile, or call another system for audit
    logging purposes.</p></li><li class="listitem"><p>Policy evaluation plugins implement new policy conditions, send
    attributes from the user profile as part of a policy response, extend the
    definition of the subjects to whom the policy applies, or customize how
    policy management is delegated.</p></li><li class="listitem"><p>Identity repository plugins let OpenAM employ a new or custom user
    data store, other than a directory server or JDBC-accessible
    database.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="openam-ipv"></a>1.3.&nbsp;OpenAM, IPv4, and IPv6</h2></div></div></div><p>OpenAM provides functionality for IPv4, IPv6, and a hybrid of the two. 
  While the majority of the interaction is done on the backend, there are a few
  places where the GUI requires some inputs, such as setting up policy conditions.
  These areas follow the same standard that applies to IPv4 and IPv6. IPv4 uses a 32-bit 
  integer value, with a dot-decimal system. IPv6 uses a hexadecimal system, and the eight 
  groups of hexadecimal digits are separated by a colon.</p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-client-dev"></a>Chapter&nbsp;2.&nbsp;Developing Client Applications</h1></div></div></div><p>Client applications access OpenAM services for authentication,
 authorization, and single sign on/single log out through the use of
 sessions. Client applications can also be allowed to manage authorization
 policies.</p><p>Client application integration with OpenAM can be coupled loosely,
 as in the case of an application running in a web server with an OpenAM
 policy agent to handle interaction with OpenAM service, more directly,
 as in the case where the client interacts with OpenAM over protocol, or
 tightly, as in the case of an application using the OpenAM Java or C API
 to interact with OpenAM services.</p><p>This part of the guide covers client interaction with OpenAM
 over supported protocols and using OpenAM APIs.</p></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest"></a>Chapter&nbsp;3.&nbsp;RESTful Web Services</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-openam-rest-api">3.1. About the RESTful APIs</a></span></dt><dt><span class="section"><a href="#rest-api-versioning">3.2. REST API Versioning</a></span></dt><dt><span class="section"><a href="#c66-encoding">3.3. Token Encoding</a></span></dt><dt><span class="section"><a href="#rest-api-auth">3.4. Authentication &amp; Logout</a></span></dt><dt><span class="section"><a href="#rest-api-serverinfo">3.5. Server Information</a></span></dt><dt><span class="section"><a href="#rest-api-cookie-info">3.6. Cookie Information</a></span></dt><dt><span class="section"><a href="#rest-api-tokens">3.7. Token Validation and Session Information</a></span></dt><dt><span class="section"><a href="#rest-api-logging">3.8. Logging</a></span></dt><dt><span class="section"><a href="#rest-api-status-codes">3.9. REST Status Codes</a></span></dt></dl></div><a class="indexterm" name="d13846e381"></a><p>This chapter shows how to use the OpenAM RESTful interfaces for direct
 integration between web client applications and OpenAM.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-openam-rest-api"></a>3.1.&nbsp;About the RESTful APIs</h2></div></div></div><p>
   <a class="link" href="http://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">Representational State Transfer</a>(REST) is an architectural style
   that sets certain constraints for designing and building
   large-scale distributed hypermedia systems.
   As an architectural style, REST has very broad application.
   The designs of both HTTP 1.1 and also URIs follow RESTful principles.
   The World Wide Web is no doubt the largest and best known REST application.
   Many other web services also follow the REST architectural style.
   Examples include OAuth 2.0 and OpenID Connect 1.0.
  </p><p>
   ForgeRock Common REST (CREST) applies RESTful principles
   to define common verbs for HTTP-based APIs that access web resources
   and collections of web resources.
  </p><p>
   Native OpenAM REST APIs in version 11.0.0 and later use the CREST verbs.
   (In contrast, OAuth 2.0 and OpenID Connect 1.0 APIs follow the standards.)
   APIs covered in sections labelled (Legacy API) predate CREST,
   and do not use the CREST verbs.
  </p><p>
   When using a CREST API, you use the common verbs as query string parameters
   in resource and resource collection URIs.
  </p><div class="variablelist"><p>
    CREST APIs use these verbs.
   </p><dl class="variablelist"><dt><span class="term">_create</span></dt><dd><p>
      Add a new resource.
     </p><p>
      Create maps to HTTP PUT (or POST).
     </p></dd><dt><span class="term">_read</span></dt><dd><p>
      Retrieve a single resource.
     </p><p>
      Read maps to HTTP GET.
     </p></dd><dt><span class="term">_update</span></dt><dd><p>
      Replace an existing resource.
     </p><p>
      Update maps to HTTP PUT.
     </p></dd><dt><span class="term">_delete</span></dt><dd><p>
      Remove an existing resource.
     </p><p>
      Delete maps to HTTP DELETE.
     </p></dd><dt><span class="term">_patch</span></dt><dd><p>
      Modify part of an existing resource
     </p><p>
      Patch maps to HTTP PATCH.
     </p></dd><dt><span class="term">_action</span></dt><dd><p>
      Perform a predefined action.
     </p><p>
      Action maps to HTTP POST.
     </p><p>
      The generic _action verb extends what the API can do
      where none of the other standard CREST verbs fit,
      as in <code class="literal">_action=logout</code>.
     </p></dd><dt><span class="term">_query</span></dt><dd><p>
      Search a collection of resources.
     </p><p>
      Query maps to HTTP GET.
     </p></dd></dl></div><p>
   <acronym class="acronym">CRUDPAQ</acronym> is an acronym for the verbs.
   Notice that reserved words in CREST, such as the verbs,
   start with underscores (<code class="literal">_</code>).
  </p><p>
   In CREST, you can address resources in collections of resources
   by their unique identifiers, their IDs.
   IDs are exposed in the resource URIs
   as in <code class="literal">/users/<em class="replaceable"><code>id</code></em></code>
   and <code class="literal">/groups/<em class="replaceable"><code>id</code></em></code>.
   The ID is also in the "_id" field of the resource.
  </p><p>
   In CREST, resources are versioned using revision numbers.
   A revision is specified in the resource's "_rev" field.
   Revisions make it possible to figure out whether to apply changes
   without resource locking and without distributed transactions.
  </p><p>
   In CREST, you can explicitly request API versions.
   This means that OpenAM can continue to support older API versions
   as well as newer API versions as developers migrate their applications
   to take advantage of capabilities provided by newer APIs.
  </p><p>
   Interface Stability:
   <a href="../admin-guide/index.html#interface-stability" class="link">Evolving</a>
  </p><p>
   OpenAM offers RESTful APIs for these access and identity management operations:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="link" href="#rest-api-auth" title="3.4.&nbsp;Authentication &amp; Logout">Authentication</a> (login)</p></li><li class="listitem"><p><a class="link" href="#rest-api-auth" title="3.4.&nbsp;Authentication &amp; Logout">Logout</a></p></li><li class="listitem"><p><a class="link" href="#rest-api-cookie-info" title="3.6.&nbsp;Cookie Information">Cookie information</a></p></li><li class="listitem"><p><a class="link" href="#rest-api-tokens" title="3.7.&nbsp;Token Validation and Session Information">Token attribute retrieval</a></p></li><li class="listitem"><p><a class="link" href="#rest-api-tokens" title="3.7.&nbsp;Token Validation and Session Information">Token validation</a></p></li><li class="listitem"><p><a class="link" href="#rest-api-logging" title="3.8.&nbsp;Logging">Logging</a></p></li><li class="listitem"><p>
     <a href="../dev-guide/index.html#chap-rest-authz-policy" class="link">Authorization</a>
    </p></li><li class="listitem"><p>
     <a href="../dev-guide/index.html#chap-rest-oauth2-oidc" class="link">OAuth 2.0 Authorization</a>
    </p></li><li class="listitem"><p><a href="../dev-guide/index.html#chap-rest-oauth2-oidc" class="link">OpenID Connect 1.0</a></p></li><li class="listitem"><p>
     <a href="../dev-guide/index.html#chap-rest-user-services" class="link">User Self-Registration</a></p></li><li class="listitem"><p><a href="../dev-guide/index.html#chap-rest-user-services" class="link">Resetting Forgotten Passwords</a></p></li><li class="listitem"><p><a href="../dev-guide/index.html#chap-rest-user-services" class="link">Dashboard Service</a></p></li><li class="listitem"><p>
     <a href="../dev-guide/index.html#chap-rest-identity-realm-mgmt" class="link">Identity Management
      (creating, reading, updating, deleting identities)
     </a>
    </p></li><li class="listitem"><p><a href="../dev-guide/index.html#chap-rest-identity-realm-mgmt" class="link">Realm Management
     (creating, reading, updating, deleting realms)
    </a></p></li><li class="listitem"><p><a href="../dev-guide/index.html#chap-rest-sts" class="link">Secure Token Service (STS)
    </a></p></li></ul></div><p>This chapter also includes a section on <a class="link" href="#rest-api-status-codes" title="3.9.&nbsp;REST Status Codes">REST Status Codes</a>.</p><p>In this chapter, long URLs are wrapped to fit the printed page, as some
  of the output is formatted for easier reading.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-versioning"></a>3.2.&nbsp;REST API Versioning</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-versioning-supported-versions">3.2.1. Supported REST API Versions</a></span></dt><dt><span class="section"><a href="#rest-api-explicit-version">3.2.2. Specifying an Explicit REST API Version</a></span></dt><dt><span class="section"><a href="#rest-api-versioning-messages">3.2.3. REST API Versioning Messages</a></span></dt></dl></div><p>
   In OpenAM 12.0.0 and later, REST API features are assigned version numbers.
  </p><p>Providing version numbers in the REST API helps ensure compatibility
   between OpenAM releases. The version number of a feature increases when OpenAM
   introduces a non-backwards-compatible change that affects clients making use
   of the feature.</p><div class="variablelist"><p>
   OpenAM provides versions for the following aspects of the REST API.
  </p><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>resource</em></span></span></dt><dd><p>
     Any changes to the structure or syntax of a returned response will incur
     a <span class="emphasis"><em>resource</em></span> version change. For example changing
     <code class="literal">"errorMessage"</code> to <code class="literal">"message"</code> in a
     JSON response.
    </p></dd><dt><span class="term"><span class="emphasis"><em>protocol</em></span></span></dt><dd><p>
     Any changes to the methods used to make REST API calls will incur
     a <span class="emphasis"><em>protocol</em></span> version change. For example changing <code class="literal">_action</code>
     to <code class="literal">$action</code> in the required parameters of an API feature.
    </p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-versioning-supported-versions"></a>3.2.1.&nbsp;Supported REST API Versions</h3></div></div></div><p>The REST API version numbers supported in OpenAM 12.0.0
    are as follows:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>Supported protocol versions</em></span></span></dt><dd><p>The <span class="emphasis"><em>protocol</em></span> versions supported in OpenAM 12.0.0
      are:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">1.0</code></td></tr></table></dd><dt><span class="term"><span class="emphasis"><em>Supported resource versions</em></span></span></dt><dd><p>The <span class="emphasis"><em>resource</em></span> versions supported in OpenAM 12.0.0
      are shown in the following table.</p><div class="table"><a name="rest-api-supported-resource-versions"></a><div class="table-title">Table&nbsp;3.1.&nbsp;Supported <span class="emphasis"><em>resource</em></span> Versions</div><div class="table-contents"><table summary="Supported resource Versions" width="100%" border="0"><colgroup><col width="33%"><col width="33%"><col width="34%"></colgroup><thead><tr><th>Base</th><th>End Point</th><th>Supported Versions</th></tr></thead><tbody><tr><td>/json</td><td>/authenticate</td><td>1.1, 2.0</td></tr><tr><td> </td><td>/users</td><td>1.1, 2.0</td></tr><tr><td> </td><td>/groups</td><td>1.1, 2.0</td></tr><tr><td> </td><td>/agents</td><td>1.1, 2.0</td></tr><tr><td> </td><td>/realms</td><td>1.0</td></tr><tr><td> </td><td>/dashboard</td><td>1.0</td></tr><tr><td> </td><td>/sessions</td><td>1.1</td></tr><tr><td> </td><td>/serverinfo/*</td><td>1.1</td></tr><tr><td> </td><td>/users/<span class="emphasis"><em>{user-id}</em></span>/devices/trusted</td><td>1.0</td></tr><tr><td> </td><td>/applications</td><td>1.0</td></tr><tr><td> </td><td>/policies</td><td>1.0</td></tr><tr><td> </td><td>/applicationtypes</td><td>1.0</td></tr><tr><td> </td><td>/conditiontypes</td><td>1.0</td></tr><tr><td> </td><td>/subjecttypes</td><td>1.0</td></tr><tr><td> </td><td>/subjectattributes</td><td>1.0</td></tr><tr><td> </td><td>/decisioncombiners</td><td>1.0</td></tr><tr><td> </td><td>/subjectattributes</td><td>1.0</td></tr><tr><td>/xacml</td><td>/policies</td><td>1.0</td></tr><tr><td>/frrest</td><td>/token</td><td>1.0</td></tr><tr><td> </td><td>/client</td><td>1.0</td></tr></tbody></table></div></div><br class="table-break"></dd></dl></div><p>The <em class="citetitle">OpenAM Release Notes</em> section,
     <a href="../release-notes/index.html#chap-compatibility" class="link"><em class="citetitle">OpenAM Changes &amp; Deprecated Functionality</em></a>
     describes the differences between API versions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-explicit-version"></a>3.2.2.&nbsp;Specifying an Explicit REST API Version</h3></div></div></div><p>You can specify which version of the REST API to use by adding an
    <code class="literal">Accept-API-Version</code> header to the request, as in the
    following example, which is requesting <span class="emphasis"><em>resource</em></span> version
    2.0 and <span class="emphasis"><em>protocol</em></span> version 1.0.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 --header "Accept-API-Version: resource=2.0, protocol=1.0" \
 https://openam.example.com:8443/openam/json/authenticate</strong>
</pre></div><p>You can configure the default behavior OpenAM will take when a REST
    call does not specify explicit version information. For more
    information, see <a href="../admin-guide/index.html#chap-rest" class="link"><em class="citetitle">Configuring REST APIs</em></a>
    in the <em class="citetitle">OpenAM Administration Guide</em>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-versioning-messages"></a>3.2.3.&nbsp;REST API Versioning Messages</h3></div></div></div><p>OpenAM provides REST API version messages in the JSON response to a
   REST API call. You can also configure OpenAM to return version messages
   in the response headers. See <a href="../admin-guide/index.html#chap-rest" class="link"><em class="citetitle">Configuring REST APIs</em></a>
   in the <em class="citetitle">OpenAM Administration Guide</em></p><p>Messages include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Details of the REST API versions used to service a
    REST API call.</p></li><li class="listitem"><p>Warning messages if REST API version information is not specified
    or is incorrect in a REST API call.</p></li></ul></div><p>The <code class="literal">resource</code> and <code class="literal">protocol</code> version
   used to service a REST API call are returned in the
   <code class="literal">Content-API-Version</code> header, as shown below.</p><div class="screen"><pre>
$ <strong>curl \
 -i \
 --request POST \
 --header "Content-Type: application/json" \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 --header "Accept-API-Version: resource=2.0, protocol=1.0" \
 https://openam.example.com:8443/openam/json/authenticate</strong>

<em>HTTP/1.1 200 OK
Content-API-Version: protocol=1.0,resource=2.0
Server: Restlet-Framework/2.1.7
Content-Type: application/json;charset=UTF-8

{
 "tokenId":"AQIC5wM...TU3OQ*",
 "successUrl":"/openam/console"
}</em>
</pre></div><p>If the default REST API version behavior is set to <code class="literal">None</code>,
   and a REST API call does not include the <code class="literal">Accept-API-Version</code>
   header, or does not specify a <code class="literal">resource</code> version, then a
   <code class="literal">400 Bad Request</code> status code is returned,
   as shown below.</p><div class="screen"><pre>
$ <strong>curl \
 --header "Content-Type: application/json" \
 --header "Accept-API-Version: protocol=1.0" \
 https://openam.example.com:8443/openam/json/serverinfo/*</strong>

<em>{
 "code":400,
 "reason":"Bad Request",
 "message":"No requested version specified and behavior set to NONE."
}</em>
</pre></div><p>If a REST API call does include the <code class="literal">Accept-API-Version</code>
   header, but the specified <code class="literal">resource</code> or
   <code class="literal">protocol</code> version does not exist in OpenAM, then a
   <code class="literal">404 Not Found</code> status code is returned,
   as shown below.</p><div class="screen"><pre>
$ <strong>curl \
 --header "Content-Type: application/json" \
 --header "Accept-API-Version: protocol=1.0, resource=999.0" \
 https://openam.example.com:8443/openam/json/serverinfo/*</strong>

<em>{
 "code":404,
 "reason":"Not Found",
 "message":"Accept-API-Version: Requested version \"999.0\" does not match any routes."
}</em>
</pre></div><div class="tip"><h3 class="title">Tip</h3><p>For more information on setting the default REST API
   version behavior, see <a href="../admin-guide/index.html#chap-rest" class="link"><em class="citetitle">Configuring REST APIs</em></a>
    in the <em class="citetitle">OpenAM Administration Guide</em>.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="c66-encoding"></a>3.3.&nbsp;Token Encoding</h2></div></div></div><p>Valid tokens in OpenAM requires configuration either in percent encoding or in <span class="emphasis"><em>C66Encode</em></span>
  format. C66Encode format is encouraged. It is the default token format for OpenAM, and is used in this chapter.
  The following is an example token that has not been encoded:</p><pre class="literallayout">AQIC5wM2LY4SfczntBbXvEAOuECbqMY3J4NW3byH6xwgkGE=@AAJTSQACMDE=#</pre><p>This token includes reserved characters such as <code class="literal">+</code>, <code class="literal">/</code>,
  and <code class="literal">=</code> (The <code class="literal">@</code>, <code class="literal">#</code>, and <code class="literal">*</code> are not
  reserved characters per se, but substitutions are still required). To c66encode this token,
  you would substitute certain characters for others, as follows:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><span class="keycap"><strong>+</strong></span> is replaced with <span class="keycap"><strong>-</strong></span></td></tr><tr><td><span class="keycap"><strong>/</strong></span> is replaced with <span class="keycap"><strong>_</strong></span></td></tr><tr><td><span class="keycap"><strong>=</strong></span> is replaced with <span class="keycap"><strong>.</strong></span></td></tr><tr><td><span class="keycap"><strong>@</strong></span> is replaced with <span class="keycap"><strong>*</strong></span></td></tr><tr><td><span class="keycap"><strong>#</strong></span> is replaced with <span class="keycap"><strong>*</strong></span></td></tr><tr><td><span class="keycap"><strong>*</strong></span> (first instance) is replaced with <span class="keycap"><strong>@</strong></span></td></tr><tr><td><span class="keycap"><strong>*</strong></span> (subsequent instances) is replaced with <span class="keycap"><strong>#</strong></span></td></tr></table><p>In this case, the translated token would appear as shown here:</p><pre class="literallayout">AQIC5wM2LY4SfczntBbXvEAOuECbqMY3J4NW3byH6xwgkGE.*AAJTSQACMDE.*</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-auth"></a>3.4.&nbsp;Authentication &amp; Logout</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-auth-json">3.4.1. REST APIs for Authentication &amp; Logout</a></span></dt><dt><span class="section"><a href="#rest-api-auth-legacy">3.4.2. Authentication &amp; Logout (Legacy API)</a></span></dt></dl></div><a class="indexterm" name="d13846e1013"></a><a class="indexterm" name="d13846e1018"></a><p>OpenAM provides REST APIs for authentication and for logout.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under <code class="literal">/json/authenticate</code> and
    <code class="literal">/json/sessions</code>, you find the newer JSON-based APIs.</p><p>See <a class="xref" href="#rest-api-auth-json" title="3.4.1.&nbsp;REST APIs for Authentication &amp; Logout">Section&nbsp;3.4.1, &#8220;REST APIs for Authentication &amp; Logout&#8221;</a> below.</p></li><li class="listitem"><p>Under <code class="literal">/identity/authenticate</code> and
    <code class="literal">/identity/logout</code>, you find the backwards-compatible,
    legacy API.</p><p>See <a class="xref" href="#rest-api-auth-legacy" title="3.4.2.&nbsp;Authentication &amp; Logout (Legacy API)">Section&nbsp;3.4.2, &#8220;Authentication &amp; Logout (Legacy API)&#8221;</a> below.</p></li></ul></div><div class="tip"><h3 class="title">Tip</h3><p>
    When authentication depends on the client IP address,
    and OpenAM lies behind a load balancer or proxy layer,
    configure the load balancer or proxy to send the address
    by using the <code class="literal">X-Forwarded-For</code> header,
    and configure OpenAM to consume and forward the header as necessary.
    For details, see the <em class="citetitle">Installation Guide</em> section,
    <a href="../install-guide/index.html#handle-request-headers" class="link"><em class="citetitle">Handling HTTP Request Headers</em></a>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-auth-json"></a>3.4.1.&nbsp;REST APIs for Authentication &amp; Logout</h3></div></div></div><p>The simplest user name/password authentication returns a
   <code class="literal">tokenId</code> that applications can present as a cookie
   value for other operations that require authentication. In this case use
   HTTP POST to prevent the web container from logging the credentials.
   Pass the user name in an <code class="literal">X-OpenAM-Username</code> header, and
   the password in an <code class="literal">X-OpenAM-Password</code> header.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 --header "Content-Type: application/json" \
 --data "{}" \
 https://openam.example.com:8443/openam/json/authenticate</strong>
<em>{ "tokenId": "AQIC5w...NTcy*", "successUrl": "/openam/console" }</em>
   </pre></div><p>This "zero page login" mechanism works only for name/password
   authentication. If you include a POST body with the request, it must
   be an empty JSON string as shown in the example. Alternatively, you can
   leave the POST body empty. Otherwise, OpenAM interprets the body as a
   continuation of an existing authentication attempt, one that uses a
   supported callback mechanism.</p><p>The authentication service at <code class="literal">/json/authenticate</code>
   supports callback mechanisms that make it possible to perform other types of
   authentication in addition to simple user name/password login.</p><p>Callbacks that are not completed based on the content of the client
   HTTP request are returned in JSON as a response to the request. Each
   callback has an array of output suitable for displaying to the end user,
   and input which is what the client must complete and send back to
   OpenAM. The default is still user name/password authentication.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 https://openam.example.com:8443/openam/json/authenticate</strong>
<em>
{
    "authId": "...jwt-value...",
    "template": "",
    "stage": "DataStore1",
    "callbacks": [
        {
            "type": "NameCallback",
            "output": [
                {
                    "name": "prompt",
                    "value": " User Name: "
                }
            ],
            "input": [
                {
                    "name": "IDToken1",
                    "value": ""
                }
            ]
        },
        {
            "type": "PasswordCallback",
            "output": [
                {
                    "name": "prompt",
                    "value": " Password: "
                }
            ],
            "input": [
                {
                    "name": "IDToken2",
                    "value": ""
                }
            ]
        }
    ]
}</em>
   </pre></div><p>The "authId" value is a JSON Web Token (JWT) that uniquely identifies
   the authentication context to OpenAM, and so must also be sent back with the
   requests.</p><p>To respond to the callback, send back the JSON object with the missing
   values filled, as in this case where the user name is <code class="literal">demo</code>
   and the password is <code class="literal">changeit</code>.</p><div class="informalexample"><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{ "authId": "...jwt-value...", "template": "", "stage": "DataStore1",
   "callbacks": [ { "type": "NameCallback", "output": [ { "name": "prompt",
   "value": " User Name: " } ], "input": [ { "name": "IDToken1", "value": "demo" } ] },
   { "type": "PasswordCallback", "output": [ { "name": "prompt", "value": " Password: " } ],
   "input": [ { "name": "IDToken2", "value": "changeit" } ] } ] }' \
 https://openam.example.com:8443/openam/json/authenticate</strong>
<em>
{ "tokenId": "AQIC5wM2...U3MTE4NA..*", "successUrl": "/openam/console" }</em>
   </pre></div></div><p>The response is a token ID holding the SSO Token value.</p><p>Alternatively, you can authenticate without requesting a session
   using the <code class="literal">noSession</code> query string parameter.</p><div class="informalexample"><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{ "authId": "...jwt-value...", "template": "", "stage": "DataStore1",
   "callbacks": [ { "type": "NameCallback", "output": [ { "name": "prompt",
   "value": " User Name: " } ], "input": [ { "name": "IDToken1", "value": "demo" } ] },
   { "type": "PasswordCallback", "output": [ { "name": "prompt", "value": " Password: " } ],
   "input": [ { "name": "IDToken2", "value": "changeit" } ] } ] }' \
 https://openam.example.com:8443/openam/json/authenticate?noSession=true</strong>
<em>
{ "message": "Authentication Successful", "successUrl": "/openam/console" }</em>
   </pre></div></div><p>OpenAM can be configured to return a failure URL value when
   authentication fails. No failure URL is configured by default. The Default
   Failure Login URL can be configured for the <a href="../admin-guide/index.html#core-module-conf-hints" class="link">Core</a> authentication
   module. Alternatively, failure URLs can be configured per authentication
   chain, which your client can specify using the <code class="literal">service</code>
   parameter described below. On failure OpenAM then returns HTTP status
   code 401 Unauthorized, and the JSON in the reply indicates the failure
   URL.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: badpassword" \
 https://openam.example.com:8443/openam/json/authenticate</strong>
<em>{
  "code":401,
  "reason":"Unauthorized",
  "message":"Invalid Password!!",
  "failureUrl": "http://www.example.com/401.html"
}</em>
   </pre></div><p>To specify a realm in your request, first make sure that the name of your realm does not match
       an endpoint name to avoid any potential routing errors.
       Then, specify the realm in one of two ways. For example, if you have a realm
       titled "<code class="literal">myRealm</code>," you can use it in your request as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Using the realm in the URI to the endpoint (preferred method):</p><pre class="literallayout">https://openam.example.com:8443/openam/json/<code class="literal">myRealm</code>/authenticate</pre></li><li class="listitem"><p>Using the realm query string parameter:</p><pre class="literallayout">https://openam.example.com:8443/openam/json/authenticate?realm=<code class="literal">myRealm</code></pre></li></ul></div><div class="variablelist"><p>You can use the <code class="literal">authIndexType</code> and
    <code class="literal">authIndexValue</code> query string parameters as a pair
    to provide additional information about how you are authenticating.
    The <code class="literal">authIndexType</code> can be one of the following
    types:</p><dl class="variablelist"><dt><span class="term">composite</span></dt><dd><p>Set the value to a composite advice string.</p></dd><dt><span class="term">level</span></dt><dd><p>Set the value to the authentication level.</p></dd><dt><span class="term">module</span></dt><dd><p>Set the value to the name of an authentication module.</p></dd><dt><span class="term">resource</span></dt><dd><p>Set the value to a URL protected by an OpenAM policy.</p></dd><dt><span class="term">role</span></dt><dd><p>Set the value to an OpenAM role.</p></dd><dt><span class="term">service</span></dt><dd><p>Set the value to the name of an authentication chain.</p></dd><dt><span class="term">user</span></dt><dd><p>Set the value to an OpenAM user ID.</p></dd></dl></div><p>
    You can use the query string parameter,
    <code class="literal">sessionUpgradeSSOTokenId=<em class="replaceable"><code>tokenId</code></em></code>,
    to request session upgrade.
    For an explanation of session upgrade,
    see the <em class="citetitle">Administration Guide</em> section on,
    <a href="../admin-guide/index.html#session-upgrade" class="link"><em class="citetitle">Authentication Levels &amp; Session Upgrade</em></a>.
   </p><div class="itemizedlist"><p>OpenAM uses the following callback types depending on the
    authentication module in use.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">ChoiceCallback</code>:
      Used to display a list of choices and retrieve the selected choice
     </p></li><li class="listitem"><p>
      <code class="literal">ConfirmationCallback</code>:
      Used to ask for a confirmation such as Yes, No, or Cancel and retrieve the selection
     </p></li><li class="listitem"><p>
      <code class="literal">HiddenValueCallback</code>:
      Used to return form values that are not visually rendered to the end user
     </p></li><li class="listitem"><p>
      <code class="literal">HttpCallback</code>:
      Used for HTTP handshake negotiations
     </p></li><li class="listitem"><p>
      <code class="literal">LanguageCallback</code>:
      Used to retrieve the locale for localizing text presented to the end user
     </p></li><li class="listitem"><p>
      <code class="literal">NameCallback</code>:
      Used to retrieve a name string
     </p></li><li class="listitem"><p>
      <code class="literal">PasswordCallback</code>:
      Used to retrieve a password value
     </p></li><li class="listitem"><p>
      <code class="literal">RedirectCallback</code>:
      Used to redirect the client user-agent
     </p></li><li class="listitem"><p>
      <code class="literal">ScriptTextOutputCallback</code>:
      Used to insert a script into the page presented to the end user.
      The script can, for example, collect data about the user's environment.
     </p></li><li class="listitem"><p>
      <code class="literal">TextInputCallback</code>:
      Used to retrieve text input from the end user
     </p></li><li class="listitem"><p>
      <code class="literal">TextOutputCallback</code>:
      Used to display a message to the end user
     </p></li><li class="listitem"><p>
      <code class="literal">X509CertificateCallback</code>:
      Used to retrieve the content of an x.509 certificate
     </p></li></ul></div><p>Authenticated users can log out with the token cookie value and an HTTP
   POST to <code class="literal">/json/sessions/?_action=logout</code>.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iplanetDirectoryPro: AQIC5wM2...U3MTE4NA..*" \
 --header "Content-Type: application/json" \
 "https://openam.example.com:8443/openam/json/sessions/?_action=logout"</strong>
<em>
{"result":"Successfully logged out"}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-auth-legacy"></a>3.4.2.&nbsp;Authentication &amp; Logout (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>Simple authentication with a user name and password returns a
    token.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "username=bjensen&amp;password=hifalutin" \
 https://openam.example.com:8443/openam/identity/authenticate</strong>
<em>
token.id=AQIC5wM2LY4SfcxvdvHOXjtC_eWSs2RB54tgvgK8SuYi7aQ.*AAJTSQACMDE.*</em>
    </pre></div><p>If you must specify parameters as when authenticating to
    <code class="literal">/UI/Login</code>, you provide a percent encoded string of the
    parameters as the value of the <code class="literal">uri</code> parameter. The
    <code class="literal">/UI/Login</code> parameter deals with the <code class="literal">realm</code>,
    <code class="literal">module</code>, and <code class="literal">service</code> parameters. Setting the
    <code class="literal">client</code> parameter sets the user's IP address as part of the
    token following successful authentication. The default for the <code class="literal">client</code>
    parameter is the IP of the machine making the REST request.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "username=bjensen&amp;password=hifalutin&amp;uri=realm%3D%2F%26module%3DDataStore\
&amp;client=192.168.1.1" \
 https://openam.example.com:8443/openam/identity/authenticate</strong>
<em>
token.id=AQIC5wM2LY4SfcxvdvHOXjtC_eWSs2RB54tgvgK8SuYi7aQ.*AAJTSQACMDE.*</em>
    </pre></div><p>You log out using the token to end the user session.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "subjectid=AQIC5w...*AAJTSQACMDE.*" \
 https://openam.example.com:8443/openam/identity/logout</strong>
    </pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-serverinfo"></a>3.5.&nbsp;Server Information</h2></div></div></div><p>You can retrieve OpenAM server information by using HTTP GET on
   <code class="literal">/json/serverinfo/*</code>.</p><div class="screen"><pre>
$ <strong>curl https://openam.example.com:8443/openam/json/serverinfo/*</strong>
<em>{
    "domains": [
        ".example.com"
    ],
    "protectedUserAttributes": [],
    "cookieName": "iPlanetDirectoryPro",
    "forgotPassword": "false",
    "selfRegistration": "false",
    "lang": "en",
    "successfulUserRegistrationDestination": "default",
    "socialImplementations": [
        {
            "iconPath": "XUI/images/dashboard/facebook.png",
            "authnChain": "FacebookSocialAuthenticationService",
            "displayName": "Facebook",
            "valid": true
        }
    ],
    "referralsEnabled": "false",
    "zeroPageLogin": {
        "enabled": false,
        "refererWhitelist": [
            ""
        ],
        "allowedWithoutReferer": true
    },
    "FQDN": "openam.example.com"
}</em>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-cookie-info"></a>3.6.&nbsp;Cookie Information</h2></div></div></div><p>You can retrieve the cookie domains that OpenAM supports by HTTP GET on
  <code class="literal">/json/serverinfo/cookieDomains</code>.</p><div class="screen"><pre>
$ <strong>curl https://openam.example.com:8443/openam/json/serverinfo/cookieDomains</strong>
<em>{"domains":[".example.com"]}</em>
  </pre></div><p>You can retrieve the name of the cookie used for storing the session
  token. By default it is <code class="literal">iPlanetDirectoryPro</code>.</p><div class="screen"><pre>
$ <strong>curl https://openam.example.com:8443/openam/identity/getCookieNameForToken</strong>
<em>string=iPlanetDirectoryPro</em>
  </pre></div><p>You can also retrieve the name of the cookie used for storing the session
  token and the names of the cookies to forward with requests.</p><div class="screen"><pre>
$ <strong>curl https://openam.example.com:8443/openam/identity/getCookieNamesToForward</strong>
<em>string=iPlanetDirectoryPro
string=amlbcookie</em>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-tokens"></a>3.7.&nbsp;Token Validation and Session Information</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-token-validation">3.7.1. Token Validation</a></span></dt><dt><span class="section"><a href="#rest-api-session-information">3.7.2. Session Information</a></span></dt><dt><span class="section"><a href="#rest-api-tokens-legacy">3.7.3. Token Validation, Attribute Retrieval (Legacy API)</a></span></dt></dl></div><a class="indexterm" name="d13846e1448"></a><a class="indexterm" name="d13846e1453"></a><p>
   OpenAM provides REST APIs for validating SSO tokens and getting information
   about active sessions.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Under <code class="literal">/json/sessions</code>
     you find the newer JSON-based API.
    </p><p>
     See <a class="xref" href="#rest-api-token-validation" title="3.7.1.&nbsp;Token Validation">Section&nbsp;3.7.1, &#8220;Token Validation&#8221;</a>
     and <a class="xref" href="#rest-api-session-information" title="3.7.2.&nbsp;Session Information">Section&nbsp;3.7.2, &#8220;Session Information&#8221;</a> below.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/identity/isTokenValid</code>
     you find the backwards compatible, legacy APIs.
    </p><p>
     See <a class="xref" href="#rest-api-tokens-legacy" title="3.7.3.&nbsp;Token Validation, Attribute Retrieval (Legacy API)">Section&nbsp;3.7.3, &#8220;Token Validation, Attribute Retrieval (Legacy API)&#8221;</a> below.
    </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-token-validation"></a>3.7.1.&nbsp;Token Validation</h3></div></div></div><p>
    To check over REST whether a token is valid,
    perform an HTTP POST
    to the resource URL,
    <code class="literal">/json/sessions/<em class="replaceable"><code>tokenId</code></em></code>,
    using the <code class="literal">validate</code> action
    as shown in the following example:
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 http://openam.example.com:8080/openam/json/sessions/AQIC5...?_action=validate</strong>
<em>{"valid":true,"uid":"demo","realm":"/myRealm"}</em>
   </pre></div><p>
    An invalid token returns only information about the validity.
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 http://openam.example.com:8080/openam/json/sessions/AQIC5...?_action=validate</strong>
<em>{"valid":false}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-session-information"></a>3.7.2.&nbsp;Session Information</h3></div></div></div><p>
    You can use REST API calls to:

    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Identify whether a session is active
      </p></li><li class="listitem"><p>
       Check the maximum remaining amount of time a session has left before
       the user is required to reauthenticate
      </p></li><li class="listitem"><p>
       Determine the length of time a session has been idle
      </p></li><li class="listitem"><p>
       Reset a session's idle time to 0
      </p></li></ul></div><p>
   </p><p>
    For these REST endpoints, specify two SSO tokens. Provide the SSO token for the
    current authenticated user as the value of a header whose name is the name
    of the SSO token cookie, by default <code class="literal">iPlanetDirectoryPro</code>.
    Specify the SSO token about which you want information as the
    <code class="literal">tokenId</code> query string parameter of the REST URL.
    In the examples in this section, <code class="literal">AQIC5w...NTcy*</code> is the SSO
    token for the current authenticated user, while <code class="literal">BXCCq...NX*1*</code>
    is the token being queried.
   </p><p>
    To determine whether a session is active,
    perform an HTTP POST to the resource URL,
    <code class="literal">/json/sessions/</code>,
    using the <code class="literal">isActive</code> action
    as shown in the following example:
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 http://openam.example.com:8080/openam/json/sessions/?_action=isActive&amp;tokenId=BXCCq...NX*1*
  </strong>
<em>{"active":true}</em>
</pre></div><p>
    To check the maximum remaining time (in seconds) of a session,
    perform an HTTP POST to the resource URL,
    <code class="literal">/json/sessions/</code>,
    using the <code class="literal">getMaxTime</code> action
    as shown in the following example:
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 http://openam.example.com:8080/openam/json/sessions/?_action=getMaxTime&amp;tokenId=BXCCq...NX*1*
  </strong>
<em>{"maxtime":7022}</em>
</pre></div><p>
    To check the amount of time (in seconds) that a session has been idle,
    perform an HTTP POST to the resource URL,
    <code class="literal">/json/sessions/</code>,
    using the <code class="literal">getIdle</code> action
    as shown in the following example:
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 http://openam.example.com:8080/openam/json/sessions/?_action=getIdle&amp;tokenId=BXCCq...NX*1*
  </strong>
<em>{"idletime":355}</em>
</pre></div><p>
    To reset a session's idle time,
    perform an HTTP POST to the resource URL,
    <code class="literal">/json/sessions/</code>,
    using the <code class="literal">isActive</code> action with the
    <code class="literal">refresh=true</code>
    option as shown in the following example:
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 http://openam.example.com:8080/openam/json/sessions/?_action=isActive&amp;refresh=true&amp;tokenId=BXCCq...NX*1*
  </strong>
<em>{"active":true}</em>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-tokens-legacy"></a>3.7.3.&nbsp;Token Validation, Attribute Retrieval (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>You check whether a token is valid as follows:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "tokenid=AQIC5w...*AAJTSQACMDE.*" \
 https://openam.example.com:8443/openam/identity/isTokenValid</strong>
<em>boolean=true</em>
   </pre></div><p>An invalid token returns <code class="literal">boolean=false</code>.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "tokenid=INVALID" \
 https://openam.example.com:8443/openam/identity/isTokenValid</strong>
<em>boolean=false</em>
   </pre></div><p>With a valid token, you can retrieve attributes about the subject.
    OpenAM returns a series of <em class="replaceable"><code>name</code></em>,
    <em class="replaceable"><code>value</code></em> pairs.</p><p>The newer API for retrieving user information is demonstrated in
    <a href="../dev-guide/index.html#rest-api-read-identity" class="link">
     <em class="citetitle">Reading Identities</em></a>. What follows describes the
    legacy API.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "subjectid=AQIC5w...*AAJTSQACMDE.*" \
 https://openam.example.com:8443/openam/identity/attributes</strong>
<em>userdetails.token.id=
 AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*
userdetails.attribute.name=uid
userdetails.attribute.value=bjensen
userdetails.attribute.name=mail
userdetails.attribute.value=bjensen@example.com
userdetails.attribute.name=sn
userdetails.attribute.value=Jensen
userdetails.attribute.name=userpassword
userdetails.attribute.value={SSHA}rhusOfYpkapDWEHcfT2Y7y83LMuC++F4Abqvig==
userdetails.attribute.name=cn
userdetails.attribute.value=Babs Jensen
userdetails.attribute.value=Barbara Jensen
userdetails.attribute.name=givenname
userdetails.attribute.value=Barbara
userdetails.attribute.name=dn
userdetails.attribute.value=uid=bjensen,ou=people,dc=example,dc=com
userdetails.attribute.name=telephonenumber
userdetails.attribute.value=+1 408 555 1862
userdetails.attribute.name=objectclass
userdetails.attribute.value=organizationalPerson
userdetails.attribute.value=person
userdetails.attribute.value=posixAccount
userdetails.attribute.value=inetOrgPerson
userdetails.attribute.value=krbprincipalaux
userdetails.attribute.value=krbTicketPolicyAux
userdetails.attribute.value=top</em>
   </pre></div><p>You can specify attributes to limit what you retrieve.</p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/attributes?\
subjectid=AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*\
&amp;attributenames=mail\
&amp;attributenames=uid"</strong>
<em>userdetails.token.id=
 AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*
userdetails.attribute.name=uid
userdetails.attribute.value=bjensen
userdetails.attribute.name=mail
userdetails.attribute.value=bjensen@example.com</em>
   </pre></div><p>When retrieving attributes, you can refresh the session thus setting
    the idle time to 0, by adding the boolean parameter
    <code class="literal">refresh=true</code> to the query string.</p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/attributes?\
subjectid=AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*\
&amp;attributenames=cn\
&amp;refresh=true"</strong>
<em>userdetails.token.id=
 AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*
userdetails.attribute.name=cn
userdetails.attribute.value=Babs Jensen
userdetails.attribute.value=Barbara Jensen</em>
   </pre></div><p>
    You can specify the following attributes to retrieve information
    about the user's session time limits and current session:
    <code class="literal">maxsessiontime</code> (maximum length of a session),
    <code class="literal">maxidletime</code> (maximum idle time allowed during a session),
    <code class="literal">idletime</code> (actual idle time during the current session),
    <code class="literal">timeleft</code> (actual time left in session).
    The unit for maximum times is minutes.
    The unit for actual times is seconds.
   </p><p>
    Also use the parameter <code class="literal">refresh=false</code>
    to avoid changing the <code class="literal">idletime</code> with your request.
   </p><div class="screen"><pre>
$ <strong>curl \
--data "subjectid=AQIC5w....*AAJTSQACMDE.*\
 &amp;attributenames=idletime\
 &amp;attributenames=maxidletime\
 &amp;attributenames=timeleft\
 &amp;attributenames=maxsessiontime\
 &amp;refresh=false" \
 https://openam.example.com:8443/openam/identity/attributes</strong>
<em>
userdetails.token.id=AQIC5w....*AAJTSQACMDE.*
userdetails.attribute.name=maxsessiontime
userdetails.attribute.value=120
userdetails.attribute.name=maxidletime
userdetails.attribute.value=30
userdetails.attribute.name=idletime
userdetails.attribute.value=664
userdetails.attribute.name=timeleft
userdetails.attribute.value=6319</em>
  </pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-logging"></a>3.8.&nbsp;Logging</h2></div></div></div><p>
   OpenAM supports access and audit logging for any request going to
   a CREST endpoint and writes the data to two files:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>amRest.access</strong></span>. Records accesses to a
     CREST endpoint, regardless of whether the request successfully reached the
     endpoint through policy authorization.
    </p><p>
     An <code class="literal">amRest.access</code> example is as follows:
    </p><div class="screen"><pre>
$ <strong>cat openam/openam/log/amRest.access</strong>

<em>#Version: 1.0
#Fields: time  Data  LoginID  ContextID  IPAddr  LogLevel  Domain  LoggedBy  MessageID  ModuleName
NameID  HostName
"2011-09-14 16:38:17"   /home/user/openam/openam/log/ "cn=dsameuser,ou=DSAME Users,o=openam"
aa307b2dcb721d4201 "Not Available" INFO  o=openam   "cn=dsameuser,ou=DSAME Users,o=openam"
LOG-1  amRest.access  "Not Available"  192.168.56.2
"2011-09-14 16:38:17"  "Hello World"  id=bjensen,ou=user,o=openam 8a4025a2b3af291d01  "Not Available"
INFO  o=openam id=amadmin,ou=user,o=openam "Not Available" amRest.access "Not Available"
192.168.56.2</em>
    </pre></div></li><li class="listitem"><p><span class="bold"><strong>amRest.authz</strong></span>. Records all CREST
     authorization results regardless of success. If a request has an entry in the
     <code class="literal">amRest.access</code> log, but no corresponding entry in
     <code class="literal">amRest.authz</code>, then that
     endpoint was not protected by an authorization filter and therefore the
     request was granted access to the resource.
    </p><p>
     The <code class="literal">amRest.authz</code> file has a key field, the
     <code class="literal">Data</code> field, which specifies the authorization decision,
     resource, and type of action performed on that resource.
     The <code class="literal">Data</code> field has the following syntax:
    </p><pre class="brush: plain;">
("GRANT"||"DENY") &gt; "RESOURCE | ACTION"

where
  "GRANT &gt; " is prepended to the entry if the request was allowed
  "DENY  &gt; " is prepended to the entry if the request was not allowed
  "RESOURCE" is "ResourceLocation | ResourceParameter"
     where
       "ResourceLocation" is the endpoint location (e.g., subrealm/applicationtypes)
       "ResourceParameter" is the ID of the resource being touched
        (e.g., myApplicationType) if applicable. Otherwise, this field is empty
        if touching the resource itself, such as in a query.

  "ACTION" is "ActionType | ActionParameter"
     where
       "ActionType" is "CREATE||READ||UPDATE||DELETE||PATCH||ACTION||QUERY"
       "ActionParameter" is one of the following depending on the ActionType:
          For CREATE: the new resource ID
          For READ: empty
          For UPDATE: the revision of the resource to update
          For DELETE: the revision of the resource to delete
          For PATCH: the revision of the resource to patch
          For ACTION: the actual action performed (e.g., "forgotPassword")
          For QUERY: the query ID if any
    </pre><div class="screen"><pre>
$ <strong>cat openam/openam/log/amRest.authz</strong>

<em>#Version: 1.0
#Fields: time   Data  ContextID  LoginID  IPAddr  LogLevel  Domain  MessageID  LoggedBy  NameID
ModuleName    HostName
"2014-09-16 14:17:28"   /var/root/openam/openam/log/   7d3af9e799b6393301
"cn=dsameuser,ou=DSAME Users,dc=openam,dc=forgerock,dc=org" "Not Available" INFO
dc=openam,dc=forgerock,dc=org  LOG-1  "cn=dsameuser,ou=DSAME Users,dc=openam,dc=forgerock,dc=org"
"Not Available" amRest.authz    10.0.1.5
"2014-09-16 15:56:12"  "GRANT &gt; sessions|ACTION|logout|AdminOnlyFilter"  d3977a55a2ee18c201
id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org "Not Available" INFO  dc=openam,dc=forgerock,dc=org
OAuth2Provider-2  "cn=dsameuser,ou=DSAME Users,dc=openam,dc=forgerock,dc=org"  "Not Available"
amRest.authz    127.0.0.1
"2014-09-16 15:56:40"   "GRANT &gt; sessions|ACTION|logout|AdminOnlyFilter"  eedbc205bf51780001
id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org  "Not Available" INFO dc=openam,dc=forgerock,dc=org
OAuth2Provider-2  "cn=dsameuser,ou=DSAME Users,dc=openam,dc=forgerock,dc=org"  "Not Available"
amRest.authz    127.0.0.1</em>
    </pre></div></li></ul></div><p>
   OpenAM also provides additional information in its debug notifications for
   accesses to any endpoint,
   depending on the message type (error, warning or message) including realm,
   user, and result of the operation.
  </p><p>
   You can also send OpenAM messages to log, specifying the message content
   and the log file in which to write your message.
   Logging takes a valid <code class="literal">appid</code> token for the subject
   with access to log the message, and also a <code class="literal">subjectid</code> token
   for the user whom the message concerns. If the tokens are valid and the
   access rights correct, your message ends up in the log specified.
  </p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/log?\
appid=AQIC5wM2LY4SfcwyCZkk-1JXzx6q1EzgagabHfBjMidb5jI.*AAJTSQACMDE.*\
&amp;subjectid=AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*\
&amp;logname=amRest.access\
&amp;message=Hello%20World"</strong>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-status-codes"></a>3.9.&nbsp;REST Status Codes</h2></div></div></div><p>OpenAM REST APIs respond to successful requests with HTTP status codes
   in the 2xx range. OpenAM REST APIs respond to error conditions with HTTP
   status codes in the 4xx and 5xx range. Status codes used are described in
   the following list.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">200 OK</span></dt><dd><p>The request was successful and a resource returned, depending on the
      request. For example, a successful HTTP GET on
      <code class="literal">/users/myUser</code> returns a user profile and status code
      200, whereas a successful HTTP DELETE returns
      <code class="literal">{"success","true"}</code> and status code 200.</p></dd><dt><span class="term">201 Created</span></dt><dd><p>The request succeeded and the resource was created.</p></dd><dt><span class="term">400 Bad Request</span></dt><dd><p>The request was malformed. Either parameters required by the
       action were missing, or as in the following example incorrect data was
       sent in the payload for the action.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{"bad":"data"}' \
 https://openam.example.com:8443/openam/json/users?_action=forgotPassword
</strong>
<em>{
 "code":400,
 "reason":"Bad Request",
 "message":"Username or email not provided in request"
}</em>
</pre></div></dd><dt><span class="term">401 Unauthorized</span></dt><dd><p>The request requires user authentication as in the following
      example, which is missing an SSO Token value.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 https://openam.example.com:8443/openam/json/sessions?_action=logout
</strong>
<em>{
 "code": 401,
 "reason": "Unauthorized",
 "message": "Access denied"
}</em>
</pre></div></dd><dt><span class="term">403 Forbidden</span></dt><dd><p>Access was forbidden during an operation on a resource as in the
      following example, which has a regular user trying to read the OpenAM
      administrator profile.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 https://openam.example.com:8443/openam/json/authenticate
</strong>
<em>{ "tokenId": "AQIC5w...YyMA..*" }</em>

$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...YyMA..*" \
 https://openam.example.com:8443/openam/json/users/amadmin
</strong>
<em>{
 "code": 403,
 "reason": "Forbidden",
 "message": "Permission to perform the read operation denied to
             id=demo,ou=user,dc=openam,dc=forgerock,dc=org"
}</em>
</pre></div></dd><dt><span class="term">404 Not Found</span></dt><dd><p>The specified resource could not be found as in the following
      example, which is attempting to read a nonexistent user's profile.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 https://openam.example.com:8443/openam/json/users/missing
</strong>
<em>{
 "code":404,
 "reason":"Not Found",
 "message":"Resource cannot be found."
}</em>
</pre></div></dd><dt><span class="term">405 Method Not Allowed</span></dt><dd><p>The HTTP method is not allowed for the requested resource.</p></dd><dt><span class="term">406 Not Acceptable</span></dt><dd><p>The request contains parameters that are not acceptable as in
     the following example, which specifies an API version parameter that
     is not supported by OpenAM.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 --header "Accept-API-Version: protocol=1.0, resource=999.0" \
 https://openam.example.com:8443/openam/json/authenticate</strong>

<em>{
 "code":406,
 "reason":"Not Acceptable",
 "message":"Accept-API-Version: Requested version \"999.0\" does not match any routes."
}</em>
</pre></div></dd><dt><span class="term">409 Conflict</span></dt><dd><p>The request would have resulted in a conflict with the current
      state of the resource. For example using the Forgot Password feature
       and specifying the user's email address as in the following
       example, where multiple users have the same email address.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{"email":"demo@example.com"}' \
 https://openam.example.com:8443/openam/json/users?_action=forgotPassword
</strong>
<em>{
 "code":409,
 "reason":"Conflict",
 "message":"Multiple users found"
}</em>
</pre></div></dd><dt><span class="term">410 Gone</span></dt><dd><p>The requested resource is no longer available, and will not
       become available again. The URI returned for resetting a password may
       have expired as in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{"username": "demo"}' \
 https://openam.example.com:8443/openam/json/users/?_action=forgotPassword
</strong>
<em>{
 "code":410,
 "reason":"Gone",
 "message":"Token not found"
}</em>
</pre></div></dd><dt><span class="term">415 Unsupported Media Type</span></dt><dd><p>The request is in a format not supported by the requested resource
      for the requested method as in the following example, which is attempting
      to pass basic authentication credentials as form-encoded data rather than
      query string parameters.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "username=demo&amp;password=changeit" \
 https://openam.example.com:8443/openam/json/authenticate
</strong>
<em>...
HTTP Status 415
...
The server refused this request because the request entity is in a
format not supported by the requested resource for the requested method
...</em>
</pre></div></dd><dt><span class="term">500 Internal Server Error</span></dt><dd><p>The server encountered an unexpected condition which prevented it
      from fulfilling the request. This could be caused by an invalid
       configuration in the Email Service, or as in the following example the
       specified user account not  having an associated email address to send
       the Forgot Password URI to.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{"username": "demo"}' \
 https://openam.example.com:8443/openam/json/users/?_action=forgotPassword
</strong>
<em>{
 "code":500,
 "reason":"Internal Server Error",
 "message":"No email provided in profile."
}</em>
</pre></div></dd><dt><span class="term">501 Not Implemented</span></dt><dd><p>The resource does not support the functionality required to fulfill
      the request as in the following example, which is attempting to delete
      an entry as a delete action instead of using an HTTP DELETE request.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iplanetDirectoryPro: AQIC5w...NTcy*" \
 https://openam.example.com:8443/openam/json/users/demo?_action=delete
</strong>
<em>{
 "code": 501,
 "reason": "Not Implemented",
 "message": "Actions are not supported for resource instances"
}</em>
</pre></div></dd><dt><span class="term">503 Service Unavailable</span></dt><dd><p>The requested resource was temporarily unavailable. The
       service may have been disabled, as in the following example,
       where the Forgot Password functionality has been disabled.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{"username": "demo"}' \
 https://openam.example.com:8443/openam/json/users/?_action=forgotPassword
</strong>
<em>{
 "code":503,
 "reason":"Service Unavailable",
 "message":"Forgot password is not accessible."
}</em>
</pre></div></dd></dl></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest-authz-policy"></a>Chapter&nbsp;4.&nbsp;RESTful Authorization and Policy Management Services</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#rest-api-authz">4.1. About the REST Policy Endpoints</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policy-decisions">4.2. Requesting Policy Decisions</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policies">4.3. Managing Policies</a></span></dt><dt><span class="section"><a href="#rest-api-manage-xacml">4.4. XACML 3.0 Export and Import</a></span></dt><dt><span class="section"><a href="#rest-api-authz-applications">4.5. Defining Applications</a></span></dt><dt><span class="section"><a href="#rest-api-authz-application-types">4.6. Viewing Application Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-condition-types">4.7. Viewing Environment Condition Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-subject-types">4.8. Viewing Subject Condition Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-subject-attributes">4.9. Viewing Subject Attributes</a></span></dt><dt><span class="section"><a href="#rest-api-authz-decision-combiners">4.10. Viewing Decision Combiners</a></span></dt><dt><span class="section"><a href="#rest-api-authz-referrals">4.11. Managing Referrals</a></span></dt><dt><span class="section"><a href="#rest-api-authz-legacy">4.12. Authorization (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management">4.13. Managing Policies (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management-create">4.14. Creating Policies (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management-read">4.15. Reading Policies (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management-update">4.16. Updating Policies (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management-delete">4.17. Deleting Policies (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-policy-management-query">4.18. Querying Policies (Legacy API)</a></span></dt></dl></div><a class="indexterm" name="d13846e1988"></a><p>This chapter shows how to use the OpenAM RESTful interfaces for authorization
  and policy management.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz"></a>4.1.&nbsp;About the REST Policy Endpoints</h2></div></div></div><a class="indexterm" name="d13846e1996"></a><p>
   OpenAM provides REST APIs both for requesting policy decisions,
   and also for administering policy definitions.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Under <code class="literal">/json[/<em class="replaceable"><code>realm</code></em>]/policies</code>,
     you find the newer JSON-based APIs for policy management and evaluation.
    </p></li><li class="listitem"><p>
     Under
     <code class="literal">/json[/<em class="replaceable"><code>realm</code></em>]/applications</code>
     and <code class="literal">/json/applicationtypes</code>
     you find JSON-based APIs
     for administering applications and reading application types.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/json/conditiontypes</code> you find a JSON-based API
     for viewing what types of conditions you can use when defining policies.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/json/subjecttypes</code> you find a JSON-based API
     for viewing what types of subjects you can use when defining policies.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/json/subjectattributes</code> you find a JSON-based API
     for viewing subjects' attributes you can use when defining response
     attributes in policies.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/json/decisioncombiners</code> you find a JSON-based API
     for viewing implementations you can use when defining policies
     to specify how to combine results when multiple policies apply.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/json[/<em class="replaceable"><code>realm</code></em>]/referrals</code>
     you find a JSON-based API for managing policy referrals.
    </p></li><li class="listitem"><p>
     Under <code class="literal">/identity/authorize</code>
     and <code class="literal">/ws/1/entitlement/</code>,
     you find the backwards-compatible, legacy APIs.
     See <a class="xref" href="#rest-api-authz-legacy" title="4.12.&nbsp;Authorization (Legacy API)">Section&nbsp;4.12, &#8220;Authorization (Legacy API)&#8221;</a> below.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-policy-decisions"></a>4.2.&nbsp;Requesting Policy Decisions</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-policy-decision-concrete">4.2.1. Requesting Policy Decisions For Specific Resources</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policy-decision-advice">4.2.2. Policy Decision Advice</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policy-decision-subtree">4.2.3. Requesting Policy Decisions For a Tree of Resources</a></span></dt></dl></div><p>
   You can request policy decisions from OpenAM
   by using the REST APIs described in this section.
   OpenAM evaluates requests
   based on the context and the policies configured,
   and returns decisions that indicate what actions are allowed or denied,
   as well as any attributes or advice
   for the resources specified.
  </p><p>
   To request decisions for specific resources,
   see <a class="xref" href="#rest-api-authz-policy-decision-concrete" title="4.2.1.&nbsp;Requesting Policy Decisions For Specific Resources">Section&nbsp;4.2.1, &#8220;Requesting Policy Decisions For Specific Resources&#8221;</a>.
  </p><p>
   To request decisions for a resource and all resources beneath it,
   see <a class="xref" href="#rest-api-authz-policy-decision-subtree" title="4.2.3.&nbsp;Requesting Policy Decisions For a Tree of Resources">Section&nbsp;4.2.3, &#8220;Requesting Policy Decisions For a Tree of Resources&#8221;</a>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policy-decision-concrete"></a>4.2.1.&nbsp;Requesting Policy Decisions For Specific Resources</h3></div></div></div><p>
    This section shows how you can request a policy decision over REST
    for specific resources.
   </p><p>
    To request policy decisions for specific resources,
    perform an HTTP POST using the evaluation action
    to the appropriate path under the URI where OpenAM is deployed,
    <code class="literal">/json[/<em class="replaceable"><code>realm</code></em>][/
     <em class="replaceable"><code>subrealm</code></em>]/policies?_action=evaluate</code>,
    where <em class="replaceable"><code>realm</code></em> and
    <em class="replaceable"><code>subrealm</code></em>
    optionally specifies the realm.
    The payload for the HTTP POST is a JSON object
    that specifies at least the resources,
    and takes the following form.
   </p><pre class="brush: javascript;">
{
    "resources": [
        "resource1",
        "resource2",
        ...,
        "resourceN"
    ],
    "application": "defaults to iPlanetAMWebAgentService if not specified",
    "subject": {
        "ssoToken": "SSO token ID string",
        "jwt": "JSON Web Token string",
        "claims": {
            "key": "value",
            ...
        }
    },
    "environment": {
        "optional key1": [
            "value",
            "another value",
            ...
        ],
        "optional key2": [
            "value",
            "another value",
            ...
        ],
        ...
    }
}
     </pre><div class="variablelist"><p>
     The values for the fields shown above are explained below:
    </p><dl class="variablelist"><dt><span class="term"><code class="literal">"resources"</code></span></dt><dd><p>
       This required field specifies the list of resources
       for which to return decisions.
      </p><p>
       For example, when using the default application,
       <code class="literal">"iPlanetAMWebAgentService"</code>,
       you can request decisions for resource URLs.
      </p><pre class="brush: javascript;">
{
    "resources": [
        "http://www.example.com/index.html",
        "http://www.example.com/do?action=run"
    ]
}
      </pre></dd><dt><span class="term"><code class="literal">"application"</code></span></dt><dd><p>
       This field holds the name of the application,
       and defaults to <code class="literal">"iPlanetAMWebAgentService"</code>
       if not specified.
      </p><p>
       For more on applications,
       see <a class="xref" href="#rest-api-authz-applications" title="4.5.&nbsp;Defining Applications">Section&nbsp;4.5, &#8220;Defining Applications&#8221;</a>.
      </p></dd><dt><span class="term"><code class="literal">"subject"</code></span></dt><dd><p>
      </p><div class="variablelist"><p>
        This optional field holds an object that represents the subject.
        You can specify one or more of the following keys.
        If you specify multiple keys,
        the subject can have multiple associated principals,
        and you can use subject conditions corresponding to any type in the request.
       </p><dl class="variablelist"><dt><span class="term">"ssoToken"</span></dt><dd><p>
          The value is the SSO token ID string for the subject,
          returned for example on successful authentication as described in
          <a href="../dev-guide/index.html#rest-api-auth-json" class="link"><em class="citetitle">REST APIs for Authentication &amp; Logout</em></a>.
         </p></dd><dt><span class="term">"jwt"</span></dt><dd><p>
          The value is a JWT string.
         </p></dd><dt><span class="term">"claims"</span></dt><dd><p>
          The value is an object (map) of JWT claims to their values.
         </p></dd></dl></div><p>
       If you do not specify the subject,
       OpenAM uses the SSO token ID of the subject making the request.
      </p></dd><dt><span class="term"><code class="literal">"environment"</code></span></dt><dd><p>
       This optional field holds a map of keys to lists of values.
      </p><p>
       If you do not specify the environment, the default is an empty map.
      </p></dd></dl></div><p>
    The example below requests policy decisions for two URL resources.
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5..." \
 --header "Content-Type: application/json" \
 --data '{
    "resources": [
        "http://www.example.com/index.html",
        "http://www.example.com/do?action=run"
    ],
    "application": "iPlanetAMWebAgentService"
 }' \
 https://openam.example.com:8443/openam/json/policies?_action
    =evaluate
[ {
  "resource" : "http://www.example.com/do?action=run",
  "actions" : {
  },
  "attributes" : {
  },
  "advices" : {
    "AuthLevelConditionAdvice" : [ "3" ]
  }
}, {
  "resource" : "http://www.example.com/index.html",
  "actions" : {
    "POST" : false,
    "GET" : true
  },
  "attributes" : {
    "cn" : [ "demo" ]
  },
  "advices" : {
  }
} ]
     </pre><div class="variablelist"><p>
     In the JSON list of decisions returned for each resource,
     OpenAM includes these fields.
    </p><dl class="variablelist"><dt><span class="term"><code class="literal">"resource"</code></span></dt><dd><p>
       A resource specified in the request.
      </p><p>
       The decisions returned are not guaranteed
       to be in the same order as the resources were requested.
      </p></dd><dt><span class="term"><code class="literal">"actions"</code></span></dt><dd><p>
       A map of action name keys
       to Boolean values that indicate whether
       the action is allowed (<code class="literal">true</code>)
       or denied (<code class="literal">false</code>)
       for the specified resource.
      </p><p>
       In the example,
       for resource <code class="literal">http://www.example.com:80/index.html</code>
       HTTP GET is allowed, whereas HTTP POST is denied.
      </p></dd><dt><span class="term"><code class="literal">"attributes"</code></span></dt><dd><p>
       A map of attribute names to their values,
       if any response attributes are returned
       according to applicable policies.
      </p><p>
       In the example, the policy that applies
       to <code class="literal">http://www.example.com:80/index.html</code>
       causes that the value of the subject's "cn" profile attribute
       to be returned.
      </p></dd><dt><span class="term"><code class="literal">"advices"</code></span></dt><dd><p>
       A map of advice names to their values,
       if any advice is returned according to applicable policies.
      </p><p>
       The <code class="literal">"advices"</code> field can provide hints
       regarding what OpenAM needs to take the authorization decision.
      </p><p>
       In the example, the policy that applies
       to <code class="literal">http://www.example.com:80/do?action=run</code>
       requests that the subject be authenticated
       at an authentication level of at least 3.
      </p><pre class="brush: javascript;">
{
    "advices": {
        "AuthLevelConditionAdvice": [
            "3"
        ]
    }
}
      </pre><p>
       See <a class="xref" href="#rest-api-authz-policy-decision-advice" title="4.2.2.&nbsp;Policy Decision Advice">Section&nbsp;4.2.2, &#8220;Policy Decision Advice&#8221;</a> for details.
      </p></dd></dl></div><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policy-decision-advice"></a>4.2.2.&nbsp;Policy Decision Advice</h3></div></div></div><p>
    When OpenAM returns a policy decision,
    the JSON for the decision can include an "advices" field.
    This field contains hints for the policy enforcement point.
   </p><pre class="brush: javascript;">
{
    "advices": {
        "type": [
            "advice"
        ]
    }
}
   </pre><p>
    The "advices" returned depend on policy conditions. For more
    information about OpenAM policy conditions, see
    <a class="xref" href="#rest-api-authz-policies" title="4.3.&nbsp;Managing Policies">Section&nbsp;4.3, &#8220;Managing Policies&#8221;</a>.
   </p><p>
    This section shows examples of the different types
    of policy decision advice
    and the conditions that cause OpenAM to return the advice.
   </p><p>
    <code class="literal">"AuthLevel"</code>
    and
    <code class="literal">"LEAuthLevel"</code>
    condition failures can result in advice
    showing the expected or maximum possible authentication level.
    For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "AuthLevel",
    "authLevel": 2
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthLevelConditionAdvice": [
        "2"
    ]
}
   </pre><p>
    An
    <code class="literal">"AuthScheme"</code>
    condition failure can result in advice
    showing one or more required authentication modules.
    For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "AuthScheme",
    "authScheme": [
        "HOTP"
    ],
    "applicationName": "iPlanetAMWebAgentService",
    "applicationIdleTimeout": 10
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthSchemeConditionAdvice": [
        "HOTP"
    ]
}
   </pre><p>
    An
    <code class="literal">"AuthenticateToRealm"</code>
    condition failure can result in advice
    showing the name of the realm to which authentication
    is required. For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "AuthenticateToRealm",
    "authenticateToRealm": "MyRealm"
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthenticateToRealmConditionAdvice": [
        "/myRealm"
    ]
}
   </pre><p>
    An
    <code class="literal">"AuthenticateToService"</code>
    condition failure can result in advice
    showing the name of the required authentication chain.
    For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "AuthenticateToService",
    "authenticateToService": "MyAuthnChain"
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthenticateToServiceConditionAdvice": [
        "MyAuthnChain"
    ]
}
   </pre><p>
    A
    <code class="literal">"ResourceEnvIP"</code>
    condition failure can result in advice
    showing that indicates corrective action to be taken
    to resolve the problem. The advice varies, depending on what the condition
    tests. For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "ResourceEnvIP",
    "resourceEnvIPConditionValue": [
        "IF IP=[127.0.0.12] THEN authlevel=4"
    ]
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthLevelConditionAdvice": [
        "4"
    ]
}
   </pre><p>
    Failure against a different type of
    <code class="literal">"ResourceEnvIP"</code>
    condition such as the following:
   </p><pre class="brush: javascript;">
{
    "type": "ResourceEnvIP",
    "resourceEnvIPConditionValue": [
        "IF IP=[127.0.0.11] THEN service=MyAuthnChain"
    ]
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "AuthenticateToServiceConditionAdvice": [
        "MyAuthnChain"
    ]
}
   </pre><p>
    A
    <code class="literal">"Session"</code>
    condition failure can result in advice
    showing that access has been denied because
    the user's session has been active
    longer than allowed by the condition.
    The advice will also show if the the user's session
    was terminated and reauthentication is required.
    For example, failure against the following condition:
   </p><pre class="brush: javascript;">
{
    "type": "Session",
    "maxSessionTime": "10",
    "terminateSession": false
}
   </pre><p>
    Leads to this advice:
   </p><pre class="brush: javascript;">
{
    "SessionConditionAdvice": [
        "deny"
    ]
}
   </pre><p>
    When policy evaluation denials occur against the following conditions,
    OpenAM does not return any advice:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">IPv4</code>
      </p></li><li class="listitem"><p>
       <code class="literal">IPv6</code>
      </p></li><li class="listitem"><p>
       <code class="literal">LDAPFilter</code>
      </p></li><li class="listitem"><p>
       <code class="literal">OAuth2Scope</code>
      </p></li><li class="listitem"><p>
       <code class="literal">SessionProperty</code>
      </p></li><li class="listitem"><p>
       <code class="literal">SimpleTime</code>
      </p></li></ul></div><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policy-decision-subtree"></a>4.2.3.&nbsp;Requesting Policy Decisions For a Tree of Resources</h3></div></div></div><p>
    This section shows how you can request policy decisions over REST
    for a resource and all other resources in the subtree beneath it.
   </p><p>
    To request policy decisions for a tree of resources,
    perform an HTTP POST using the evaluation action to the appropriate path
    under the URI where OpenAM is deployed,
    <code class="literal">/json[/<em class="replaceable"><code>realm</code></em>]/policies?_action=evaluateTree</code>,
    where <em class="replaceable"><code>realm</code></em> optionally specifies the realm.
    The payload for the HTTP POST is a JSON object that specifies
    at least the root resource, and takes the following form.
   </p><pre class="brush: javascript;">
{
    "resource": "resource string",
    "application": "defaults to iPlanetAMWebAgentService if not specified",
    "subject": {
        "ssoToken": "SSO token ID string",
        "jwt": "JSON Web Token string",
        "claims": {
            "key": "value",
            ...
        }
    },
    "environment": {
        "optional key1": [
            "value",
            "another value",
            ...
        ],
        "optional key2": [
            "value",
            "another value",
            ...
        ],
        ...
    }
}
   </pre><div class="variablelist"><p>
     The values for the fields shown above are explained below:
    </p><dl class="variablelist"><dt><span class="term"><code class="literal">"resource"</code></span></dt><dd><p>
       This required field specifies the root resource
       for the decisions to return.
      </p><p>
       For example, when using the default application,
       <code class="literal">"iPlanetAMWebAgentService"</code>,
       you can request decisions for resource URLs.
      </p><pre class="brush: javascript;">
{
    "resource": "http://www.example.com/"
}
      </pre></dd><dt><span class="term"><code class="literal">"application"</code></span></dt><dd><p>
       This field holds the name of the application,
       and defaults to <code class="literal">"iPlanetAMWebAgentService"</code>
       if not specified.
      </p><p>
       For more on applications,
       see <a class="xref" href="#rest-api-authz-applications" title="4.5.&nbsp;Defining Applications">Section&nbsp;4.5, &#8220;Defining Applications&#8221;</a>.
      </p></dd><dt><span class="term"><code class="literal">"subject"</code></span></dt><dd><p>
      </p><div class="variablelist"><p>
        This optional field holds an object that represents the subject.
        You can specify one or more of the following keys.
        If you specify multiple keys,
        the subject can have multiple associated principals,
        and you can use subject conditions corresponding to any type in the request.
       </p><dl class="variablelist"><dt><span class="term">"ssoToken"</span></dt><dd><p>
          The value is the SSO token ID string for the subject,
          returned for example on successful authentication as described in,
          <a href="../dev-guide/index.html#rest-api-auth-json" class="link"><em class="citetitle">REST APIs for Authentication &amp; Logout</em></a>.
         </p></dd><dt><span class="term">"jwt"</span></dt><dd><p>
          The value is a JWT string.
         </p></dd><dt><span class="term">"claims"</span></dt><dd><p>
          The value is an object (map) of JWT claims to their values.
         </p></dd></dl></div><p>
       If you do not specify the subject,
       OpenAM uses the SSO token ID of the subject making the request.
      </p></dd><dt><span class="term"><code class="literal">"environment"</code></span></dt><dd><p>
       This optional field holds a map of keys to lists of values.
      </p><p>
       If you do not specify the environment, the default is an empty map.
      </p></dd></dl></div><p>
    The example below requests policy decisions
    for <code class="literal">http://www.example.com/</code>.
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation,
    and the subject takes the SSO token of the user
    who wants to access a resource.
   </p><pre class="brush: plain;">
$ curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5...NDU1*" \
 --header "Content-Type: application/json" \
 --data '{
    "resource": "http://www.example.com/",
    "subject": { "ssoToken": "AQIC5...zE4*" }
 }' \
 https://openam.example.com:8443/openam/json/policies?_action=evaluateTree
[ {
  "resource" : "http://www.example.com/",
  "actions" : {
    "GET" : true,
    "OPTIONS" : true,
    "HEAD" : true
  },
  "attributes" : {
  },
  "advices" : {
  }
}, {
  "resource" : "http://www.example.com/*",
  "actions" : {
    "POST" : false,
    "PATCH" : false,
    "GET" : true,
    "DELETE" : true,
    "OPTIONS" : true,
    "HEAD" : true,
    "PUT" : true
  },
  "attributes" : {
    "myStaticAttr" : [ "myStaticValue" ]
  },
  "advices" : {
  }
}, {
  "resource" : "http://www.example.com/*?*",
  "actions" : {
    "POST" : false,
    "PATCH" : false,
    "GET" : false,
    "DELETE" : false,
    "OPTIONS" : true,
    "HEAD" : false,
    "PUT" : false
  },
  "attributes" : {
  },
  "advices" : {
    "AuthLevelConditionAdvice" : [ "3" ]
  }
} ]
  </pre><p>
    Notice that OpenAM returns decisions not only for the specified resource,
    but also for matching resource names
    in the tree whose root is the specified resource.
   </p><div class="variablelist"><p>
     In the JSON list of decisions returned for each resource,
     OpenAM includes these fields.
    </p><dl class="variablelist"><dt><span class="term"><code class="literal">"resource"</code></span></dt><dd><p>
       A resource name whose root is the resource specified in the request.
      </p><p>
       The decisions returned are not guaranteed
       to be in the same order as the resources were requested.
      </p></dd><dt><span class="term"><code class="literal">"actions"</code></span></dt><dd><p>
       A map of action name keys
       to Boolean values that indicate whether
       the action is allowed (<code class="literal">true</code>)
       or denied (<code class="literal">false</code>)
       for the specified resource.
      </p><p>
       In the example, for matching resources with a query string
       only HTTP OPTIONS is allowed according to the policies configured.
      </p></dd><dt><span class="term"><code class="literal">"attributes"</code></span></dt><dd><p>
       A map of attribute names to their values,
       if any response attributes are returned
       according to applicable policies.
      </p><p>
       In the example, the policy that applies
       to <code class="literal">http://www.example.com:80/*</code>
       causes a static attribute to be returned.
      </p></dd><dt><span class="term"><code class="literal">"advices"</code></span></dt><dd><p>
       A map of advice names to their values,
       if any advice is returned according to applicable policies.
      </p><p>
       The <code class="literal">"advices"</code> field can provide hints
       regarding what OpenAM needs to take the authorization decision.
      </p><p>
       In the example, the policy that applies
       to resources with a query string
       requests that the subject be authenticated
       at an authentication level of at least 3.
      </p><p>
       Notice that with the <code class="literal">"advices"</code> field
       present, no <code class="literal">"advices"</code> appear in the
       JSON response.
      </p><pre class="brush: javascript;">
{
    "advices": {
        "AuthLevelConditionAdvice": [ "3" ]
    }
}
      </pre></dd></dl></div><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-policies"></a>4.3.&nbsp;Managing Policies</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-policies-create">4.3.1. Creating Policies</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policies-read">4.3.2. Reading Policies</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policies-update">4.3.3. Updating Policies</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policies-delete">4.3.4. Deleting Policies</a></span></dt><dt><span class="section"><a href="#rest-api-authz-policies-query">4.3.5. Listing Policies</a></span></dt></dl></div><p>
   Policy resources are represented in JSON and take the following form.
   Policy resources are built from standard JSON objects and values
   (strings, numbers, objects, arrays, <code class="literal">true</code>,
   <code class="literal">false</code>, and <code class="literal">null</code>).
  </p><pre class="brush: javascript;">
{
   "name": "test",
   "active": true,
   "description": "A test policy",
   "resources": [
           "http://www.example.com:80/*"
   ],
   "applicationName": "application name",
   "actionValues": {
       "read": true,
       "write": false
   },
   "subject": {
       "a subject or": "a composite of subjects"
   },
   "condition": {
       "a condition or": "a composite of conditions"
   },
   "resourceAttributes": [
       {
           "type": "Static",
           "propertyName": "name",
           "propertyValues": [
               "value"
           ]
       },
       {
           "type": "User",
           "propertyName": "profile attribute",
       },
   ]
}
  </pre><div class="variablelist"><p>
    The values for the fields shown in the example are explained below:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"name"</code></span></dt><dd><p>
      String matching the name
      in the URL used when creating the policy by HTTP PUT
      or in the body when creating the policy by HTTP POST.
     </p></dd><dt><span class="term"><code class="literal">"active"</code></span></dt><dd><p>
      Boolean indicating whether OpenAM considers the policy active
      for evaluation purposes, defaults to <code class="literal">false</code>.
     </p></dd><dt><span class="term"><code class="literal">"description"</code></span></dt><dd><p>
      String describing the policy.
     </p></dd><dt><span class="term"><code class="literal">"resources"</code></span></dt><dd><p>
      List of the resource name pattern strings
      to which the policy applies.
     </p></dd><dt><span class="term"><code class="literal">"applicationName"</code></span></dt><dd><p>
      String application name,
      such as <code class="literal">"iPlanetAMWebAgentService"</code>,
      <code class="literal">"crestPolicyService"</code>,
      or some other application name.
     </p></dd><dt><span class="term"><code class="literal">"actionValues"</code></span></dt><dd><p>
      Set of string action names,
      each set to a boolean indicating whether the action is allowed.
     </p><p>
      Action values can also be expressed as numeric values. When using
      numeric values, use the value <code class="literal">0</code> for
      <code class="literal">false</code> and use any non-zero numeric
      value for <code class="literal">true</code>.
     </p></dd><dt><span class="term"><code class="literal">"subject"</code></span></dt><dd><p>
      Specifies the subject conditions to which the policy applies,
      where subjects can be combined by using the built-in types
      <code class="literal">"AND"</code>, <code class="literal">"OR"</code>,
      and <code class="literal">"NOT"</code>,
      and where subject implementations are pluggable.
     </p><p>
      Subjects are shown as JSON objects
      with <code class="literal">"type"</code> set to the name of the implementation
      (using a short name for all registered subject implementations),
      and also other fields depending on the implementation.
      The subject types registered by default include the following:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">"AuthenticatedUsers"</code>,
        meaning any user that has successfully authenticated to OpenAM.
       </p><pre class="brush: javascript;">
{
    "type": "AuthenticatedUsers"
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"Identity"</code>
        to specify one or more users from an OpenAM identity repository:
       </p><pre class="brush: javascript;">
{
   "type": "Identity",
   "subjectValues": [
       "uid=scarter,ou=People,dc=example,dc=com",
       "uid=ahall,ou=People,dc=example,dc=com"
   ]
}
       </pre><p>
        You can also use the
        <code class="literal">"Identity"</code>
        subject type to specify one or more groups from an identity repository:
       </p><pre class="brush: javascript;">
{
    "type": "Identity",
    "subjectValues": [
        "cn=HR Managers,ou=Groups,dc=example,dc=com"
    ]
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"JwtClaim"</code>
        to specify a claim in a
        user's JSON web token (JWT).
       </p><pre class="brush: javascript;">
{
    "type": "JwtClaim",
    "claimName": "sub",
    "claimValue": "scarter"
}
      </pre></li><li class="listitem"><p>
        <code class="literal">"NONE"</code>,
        meaning never match any subject. The result is not that access is denied, but
        rather that the policy itself does not match and therefore cannot be
        evaluated in order to allow access.
       </p></li></ul></div><p>
      The following example defines the subject
      either as the user Sam Carter from an OpenAM identity repository,
      or as a user with a JWT claim with a subject claim with the value
      scarter:
     </p><pre class="brush: javascript;">
"subject": {
    "type": "OR",
    "subjects": [
       {
           "type": "Identity",
           "subjectValues": [
               "uid=scarter,ou=People,dc=example,dc=com"
           ]
       },
       {
           "type": "JwtClaim",
           "claimName": "sub",
           "claimValue": "scarter"
       }
   ]
}
     </pre><p>
      To read a single subject type description,
      or to list all the available subject types,
      see <a class="xref" href="#rest-api-authz-subject-types" title="4.8.&nbsp;Viewing Subject Condition Types">Section&nbsp;4.8, &#8220;Viewing Subject Condition Types&#8221;</a>.
     </p></dd><dt><span class="term"><code class="literal">"condition"</code></span></dt><dd><p>
      Specifies environment conditions, where conditions can be combined
      by using the built-in types <code class="literal">"AND"</code>,
      <code class="literal">"OR"</code>, and <code class="literal">"NOT"</code>,
      and where condition implementations are pluggable.
     </p><p>
      Conditions are shown as JSON objects
      with <code class="literal">"type"</code> set to the name of the implementation
      (using a short name for all registered condition implementations),
      and also other fields depending on the implementation.
      The condition types registered by default include the following.
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">"AMIdentityMembership"</code>
       to specify a list of OpenAM users and groups.
      </p><pre class="brush: javascript;">
{
    "type": "AMIdentityMembership",
    "amIdentityName": [
        "id=scarter,ou=People,dc=example,dc=com"
    ]
}
      </pre></li><li class="listitem"><p>
        <code class="literal">"AuthLevel"</code>
        to specify the authentication level.
       </p><pre class="brush: javascript;">
{
    "type": "AuthLevel",
    "authLevel": 2
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"AuthScheme"</code>
        to specify the authentication module used to authenticate and
        the application name, and to set a timeout for application
        authentication.
       </p><pre class="brush: javascript;">
{
    "type": "AuthScheme",
    "authScheme": [
        "DataStore"
    ],
    "applicationName": "iPlanetAMWebAgentService",
    "applicationIdleTimeout": 10
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"AuthenticateToRealm"</code>
        to specify the realm to which the user authenticated.
       </p><pre class="brush: javascript;">
{
    "type": "AuthenticateToRealm",
    "authenticateToRealm": "MyRealm"
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"AuthenticateToService"</code>
        to specify the authentication chain that was used
        to authenticate.
       </p><pre class="brush: javascript;">
{
    "type": "AuthenticateToService",
    "authenticateToService": "MyAuthnChain"
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"IPv4"</code>
        or
        <code class="literal">"IPv6"</code>
        to specify an IP address range from which
        the request originated.
       </p><pre class="brush: javascript;">
{
   "type": "IPv4",
   "startIp": "127.0.0.1",
   "endIp": "127.0.0.255"
}
       </pre><p>
        You can also use the
        <code class="literal">"IPv4"</code>
        and
        <code class="literal">"IPv6"</code>
        conditions with the
        <code class="literal">"dnsName"</code>
        field to specify domain names from which the request originated. Omit
        <code class="literal">"startIp"</code>
        and
        <code class="literal">"endIp"</code>
        when using
        <code class="literal">"dnsName"</code>.
       </p><pre class="brush: javascript;">
{
    "type": "IPv4",
    "dnsName": [
        "*.example.com"
    ]
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"LDAPFilter"</code>
        to specify an LDAP search filter. The user's entry is tested
        against the search filter in the directory configured in the
        Policy Configuration Service.
       </p><pre class="brush: javascript;">
{
    "type": "LDAPFilter",
    "ldapFilter": "(&amp;(c=US)(preferredLanguage=en-us))"
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"LEAuthLevel"</code>
        to specify a maximum acceptable authentication level.
       </p><pre class="brush: javascript;">
{
    "type": "LEAuthLevel",
    "authLevel": 2
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"OAuth2Scope"</code>
        to specify a list of attributes that
        must be present in the user profile.
       </p><pre class="brush: javascript;">
{
    "type": "OAuth2Scope",
    "requiredScopes": [
        "name",
        "address",
        "email"
    ]
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"ResourceEnvIP"</code>
        to specify a complex condition such as whether the user is making a
        request from a given host and has authenticated with a given
        authentication level. For example:
       </p><pre class="brush: javascript;">
{
    "type": "ResourceEnvIP",
    "resourceEnvIPConditionValue": [
        "IF IP=[127.168.10.*] THEN authlevel=4"
    ]
}
       </pre><p>
        Entries must take the form of one or more IF...ELSE statements.
        If the IF statement is true,
        the THEN statement must also be true for the condition to be fulfilled.
        The IF statement can specify either IP to match the user's IP address,
        or dnsName to match their DNS name.
        The IP address can be IPv4 or IPv6 format, or a hybrid of the two, and
        can include wildcard characters.
       </p><p>
         The available parameters for the THEN statement are as follows:
       </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">module</code>
         </span></dt><dd><p>
           The module that was used to authenticate the user,
           for example DataStore.
          </p></dd><dt><span class="term">
          <code class="literal">service</code>
         </span></dt><dd><p>
           The authentication chain that was used to authenticate the user.
          </p></dd><dt><span class="term">
          <code class="literal">authlevel</code>
         </span></dt><dd><p>
           The minimum required authentication level.
          </p></dd><dt><span class="term">
          <code class="literal">role</code>
         </span></dt><dd><p>
           The role of the authenticated user.
          </p></dd><dt><span class="term">
          <code class="literal">user</code>
         </span></dt><dd><p>
           The name of the authenticated user.
          </p></dd><dt><span class="term">
          <code class="literal">redirectURL</code>
         </span></dt><dd><p>
           The URL from which the user was redirected.
          </p></dd><dt><span class="term">
          <code class="literal">realm</code>
         </span></dt><dd><p>
           The realm to which the user authenticated.
          </p></dd></dl></div></li><li class="listitem"><p>
        <code class="literal">"Session"</code>
        to specify how long the user's session has been active,
        and to terminate the session if deemed too old,
        such that the user must authenticate again.
       </p><pre class="brush: javascript;">
{
    "type": "Session",
    "maxSessionTime": "10",
    "terminateSession": false
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"SessionProperty"</code>
        to specify attributes set in the user's session.
       </p><pre class="brush: javascript;">{
    "type": "SessionProperty",
    "ignoreValueCase": true,
    "properties": {
        "CharSet": [
            "UTF-8"
        ],
        "clientType": [
            "genericHTML"
        ]
    }
}
       </pre></li><li class="listitem"><p>
        <code class="literal">"SimpleTime"</code>
        to specify a time range, where
        <code class="literal">"type"</code>
        is the only required field.
       </p><pre class="brush: javascript;">
{
    "type": "SimpleTime",
    "startTime": "07:00",
    "endTime": "19:00",
    "startDay": "mon",
    "endDay": "fri",
    "startDate": "2015:01:01",
    "endDate": "2015:12:31",
    "enforcementTimeZone": "GMT+0:00"
}
       </pre></li></ul></div><p>
      The following example defines the condition as
      neither Saturday or Sunday, nor certain client IP addresses.
     </p><pre class="brush: javascript;">
{
    "type": "NOT",
    "condition": {
        "type": "OR",
        "conditions": [
            {
                "type": "SimpleTime",
                "startDay": "sat",
                "endDay": "sun",
                "enforcementTimeZone": "GMT+8:00"
            },
            {
                "type": "IPv4",
                "startIp": "192.168.0.1",
                "endIp": "192.168.0.255"
            }
        ]
    }
}
     </pre><p>
       To read a single condition type description,
       or to list all the available condition types,
       see <a class="xref" href="#rest-api-authz-condition-types" title="4.7.&nbsp;Viewing Environment Condition Types">Section&nbsp;4.7, &#8220;Viewing Environment Condition Types&#8221;</a>.
      </p></dd><dt><span class="term"><code class="literal">"resourceAttributes"</code></span></dt><dd><p>
      List of attributes to return with decisions. These attributes
      are known as <em class="firstterm">response attributes</em>.
     </p><p>The response attribute provider is pluggable.
      The default implementation provides
      for statically defined attributes
      and for attributes retrieved from user profiles.
     </p><p>
      Attributes are shown as JSON objects
      with <code class="literal">"type"</code> set to the name of the implementation
      (by default either
      <code class="literal">"Static"</code> for statically defined attributes
      or <code class="literal">"User"</code> for attributes from the user profile),
      <code class="literal">"propertyName"</code> set to the attribute names.
      For static attributes, <code class="literal">"propertyValues"</code>
      holds the attribute values.
      For user attributes, <code class="literal">"propertyValues"</code>
      is not used; the property values are determined at evaluation time.
     </p></dd></dl></div><p>
   The examples above do not show the fields added to a policy by OpenAM
   to indicate when the policy was created and last updated, and by whom.
   Those field are
   <code class="literal">"createdBy"</code> and <code class="literal">"lastModifiedBy"</code>,
   which take strings holding universal identifier DNs as their values,
   and <code class="literal">"creationDate"</code> and <code class="literal">"lastModified"</code>,
   which take strings holding ISO-8601 timestamps.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policies-create"></a>4.3.1.&nbsp;Creating Policies</h3></div></div></div><p>
    To create a policy,
    either perform an HTTP PUT indicating the full path to the resource
    and the name in the resource matching the name in the path,
    or perform an HTTP POST with the name to use specified in the resource.
   </p><p>
    The HTTP PUT form includes the policy definition as the JSON resource data,
    with the header <code class="literal">Content-Type: application/json</code>
    and uses the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><p lang="en">
  Do not use special characters within policy, application or referral names
  (for example, "my+referral") using the Policy Editor or REST endpoints as
  OpenAM returns a 400 Bad Request error.
  The special characters are: double quotes ("), plus sign (+), comma (,),
  less than (&lt;), equals (=), greater than (&gt;), backslash (\), and
  null (\u0000).
 </p><pre class="brush: plain;">
$ curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 --header "If-None-Match: *" \
 --header "Content-Type: application/json" \
 --data '{
    "name": "example",
    "active": true,
    "description": "Example Policy",
    "resources": [
        "http://www.example.com:80/*",
        "http://www.example.com:80/*?*"
    ],
    "actionValues": {
        "POST": false,
        "GET": true
    },
    "subject": {
        "type": "Identity",
        "subjectValues": [
            "uid=scarter,ou=People,dc=example,dc=com"
        ]
    }
}' \
 https://openam.example.com:8443/openam/json/policies/example

{
  "name" : "example",
  "active" : true,
  "description" : "Example Policy",
  "applicationName" : "iPlanetAMWebAgentService",
  "actionValues" : {
    "POST" : false,
    "GET" : true
  },
  "resources" : [
    "http://www.example.com:80/*",
    "http://www.example.com:80/*?*"
  ],
  "subject" : {
   "type": "Identity",
    "subjectValues": [
      "uid=scarter,ou=People,dc=example,dc=com"
    ]
  },
  "lastModifiedBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "lastModified" : "2014-04-24T16:23:34Z",
  "createdBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "creationDate" : "2014-04-24T16:23:34Z"
}
   </pre><p>
       You can use the query string parameters
       <code class="literal">_prettyPrint=true</code> to make the output easier to read,
       and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
       to limit the fields returned in the output.
      </p><p>
       The HTTP POST form includes the policy definition as the JSON resource data,
       with the header <code class="literal">Content-Type: application/json</code>
       and uses the <code class="literal">_action=create</code> operation.
      </p><p>
       The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
       for a user who has access to perform the operation.
      </p><pre class="brush: plain;">
$ curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "example",
    "active": true,
    "description": "Example Policy",
    "resources": [
        "http://www.example.com:80/*",
        "http://www.example.com:80/*?*"
    ],
    "actionValues": {
        "POST": false,
        "GET": true
    },
    "subject": {
        "type": "Identity",
        "subjectValues": [
            "uid=scarter,ou=People,dc=example,dc=com"
        ]
    }
}' \
 https://openam.example.com:8443/openam/json/policies?_action=create
      
{
  "name" : "example",
  "active" : true,
  "description" : "Example Policy",
  "applicationName" : "iPlanetAMWebAgentService",
  "actionValues" : {
    "POST" : false,
    "GET" : true
  },
  "resources" : [
    "http://www.example.com:80/*",
    "http://www.example.com:80/*?*"
  ],
  "subject" : {
    "type": "Identity",
    "subjectValues": [
      "uid=scarter,ou=People,dc=example,dc=com"
    ]
  },
  "lastModifiedBy" :
   "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "lastModified" : "2014-04-29T07:33:54Z",
  "createdBy" :
   "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "creationDate" : "2014-04-29T07:33:54Z"
}
      </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policies-read"></a>4.3.2.&nbsp;Reading Policies</h3></div></div></div><p>
    To read a policy definition, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/policies/example

{
  "name" : "example",
  "active" : true,
  "description" : "Example Policy",
  "applicationName" : "iPlanetAMWebAgentService",
  "actionValues" : {
    "POST" : false,
    "GET" : true
  },
  "resources" : [
    "http://www.example.com:80/*",
    "http://www.example.com:80/*?*"
  ],
  "subject" : {
    "type": "Identity",
    "subjectValues": [
      "uid=scarter,ou=People,dc=example,dc=com"
    ]
  },
  "lastModifiedBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "lastModified" : "2014-04-24T16:23:34Z",
  "createdBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "creationDate" : "2014-04-24T16:23:34Z"
}
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policies-update"></a>4.3.3.&nbsp;Updating Policies</h3></div></div></div><p>
    To update a policy definition, perform an HTTP PUT
    specifying the resource name
    with the policy definition as the JSON resource data,
    and with the header <code class="literal">Content-Type: application/json</code>.
    This is essentially the same as creating a policy,
    but without the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "example",
    "active": true,
    "description": "Updated example policy",
    "resources": [
        "http://www.example.com:80/*",
        "http://www.example.com:80/*?*"
    ],
    "actionValues": {
        "POST": true,
        "GET": true
    },
    "subject": {
        "type": "Identity",
        "subjectValues": [
            "uid=scarter,ou=People,dc=example,dc=com"
        ]
    }
}' \
 https://openam.example.com:8443/openam/json/policies/example

{
  "name" : "example",
  "active" : true,
  "description" : "Updated example policy",
  "applicationName" : "iPlanetAMWebAgentService",
  "actionValues" : {
    "POST" : true,
    "GET" : true
  },
  "resources" : [
    "http://www.example.com:80/*",
    "http://www.example.com:80/*?*"
  ],
  "subject" : {
    "type": "Identity",
    "subjectValues": [
      "uid=scarter,ou=People,dc=example,dc=com"
    ]
  },
  "lastModifiedBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "lastModified" : "2014-04-24T16:44:01Z",
  "createdBy" :
  "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
  "creationDate" : "2014-04-24T16:23:34Z"
}
   </pre><div class="tip"><h3 class="title">Tip</h3><p>You can rename a policy by sending a new value in the
     <span class="emphasis"><em>name</em></span> attribute of the JSON body,
     as shown below.</p><pre class="brush: plain;">
$ curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 --header "Content-Type: application/json" \
 --data '{
     "name": "new-example",
     "active": true,
     "description": "Renamed example policy",
     "resources": [
         "http://www.example.com:80/*",
         "http://www.example.com:80/*?*"
     ],
     "actionValues": {
         "POST": true,
         "GET": true
     },
     "subject": {
         "type": "Identity",
         "subjectValues": [
             "uid=scarter,ou=People,dc=example,dc=com"
         ]
     }
 }' \
 https://openam.example.com:8443/openam/json/policies/example

{
    "name" : "new-example",
    "active" : true,
    "description" : "Renamed example policy",
    "applicationName" : "iPlanetAMWebAgentService",
    "actionValues" : {
        "POST" : true,
        "GET" : true
    },
    "resources" : [
        "http://www.example.com:80/*",
        "http://www.example.com:80/*?*"
    ],
    "subject" : {
        "type": "Identity",
        "subjectValues": [
            "uid=scarter,ou=People,dc=example,dc=com"
        ]
    },
    "lastModifiedBy" :
    "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
    "lastModified" : "2014-04-24T16:48:01Z",
    "createdBy" :
    "id=demo,ou=user,o=realm,ou=services,dc=openam,dc=forgerock,dc=org",
    "creationDate" : "2014-04-24T16:23:34Z"
}
   </pre></div><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policies-delete"></a>4.3.4.&nbsp;Deleting Policies</h3></div></div></div><p>
    To delete a policy definition, perform an HTTP DELETE
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 --request DELETE \
 https://openam.example.com:8443/openam/json/policies/myPolicy
{}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-policies-query"></a>4.3.5.&nbsp;Listing Policies</h3></div></div></div><p>
    To list policy definitions, perform an HTTP GET on the endpoint, setting
    the <code class="literal">_queryFilter</code> query string parameter.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 https://openam.example.com:8443/openam/json/policies?_queryFilter=true
   
{
  "result" : [ ...policies... ],
  "resultCount" : 0,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : -1
}
   </pre><p>
    The <code class="literal">_queryFilter</code> parameter can take
    <code class="literal">true</code> to match every policy,
    <code class="literal">false</code> to match no policies,
    or a filter of the following form to match field values:
    <code class="literal"><em class="replaceable"><code>field</code></em> <em class="replaceable"><code>operator</code></em> <em class="replaceable"><code>value</code></em></code>
    where <em class="replaceable"><code>field</code></em> represents the field name,
    <em class="replaceable"><code>operator</code></em> is the operator code,
    <em class="replaceable"><code>value</code></em> is the value to match,
    and the entire filter is URL-encoded.
    Supported operators are as follows:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">eq</code>: equals
     </p></li><li class="listitem"><p>
      <code class="literal">ge</code>: greater than or equal to
     </p></li><li class="listitem"><p>
      <code class="literal">gt</code>: greater than
     </p></li><li class="listitem"><p>
      <code class="literal">le</code>: less than or equal to
     </p></li><li class="listitem"><p>
      <code class="literal">lt</code>: less than
     </p></li></ul></div><div class="itemizedlist"><p>
     The <code class="literal"><em class="replaceable"><code>field</code></em></code> value
     can take the following values:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">"name"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"description"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"applicationName"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"createdBy"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModifiedBy"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"creationDate"</code> (all comparisons are supported;
      the date is either an
      <a class="link" href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a> string,
      or a integer number of seconds from the UNIX epoch)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModified"</code> (all comparisons are supported;
      the date is either an
      <a class="link" href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a> string,
      or a integer number of seconds from the UNIX epoch)
     </p></li></ul></div><p>
    Filters can be composed of multiple expressions
    by a using boolean operator <code class="literal">AND</code>,
    
    and by using parentheses,
    <code class="literal">(<em class="replaceable"><code>expression</code></em>)</code>,
    to group expressions.
    You must URL encode the filter expression
    in <code class="literal">_queryFilter=<em class="replaceable"><code>filter</code></em></code>.
   </p><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p><p>
    You can use <code class="literal">_pageSize=<em class="replaceable"><code>integer</code></em></code>
    to limit the number of results returned, as shown in the following example
    that returns only the first of three policies.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5w..." \
 https://openam.example.com:8443/openam/json/policies?_queryFilter=true\&amp;_fields=name\&amp;_pageSize=1
{
  "result" : [ {
    "name" : "My Other Policy"
  } ],
  "resultCount" : 1,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : 2
}
   </pre><p>
    You can use <code class="literal">_sortKeys=[+-]<em class="replaceable"><code>field</code></em>[,<em class="replaceable"><code>field</code></em>...]</code>
    to sort the results returned,
    where <em class="replaceable"><code>field</code></em> represents a field
    in the JSON policy objects returned.
    Optionally use the <code class="literal">+</code> prefix to sort in ascending order
    (the default),
    or <code class="literal">-</code> to sort in descending order.
    The following example sorts the policy objects by their names.
   </p><pre class="brush: plain;">
$ curl \
  --header "iPlanetDirectoryPro: AQIC5w..." \
 https://openam.example.com:8443/openam/json/policies?_queryFilter=true\&amp;_sortKeys=name
  {
  "result" : [ {
    "name" : "Another Example Policy",
    ...
  }, {
    "name" : "My Other Policy",
    ...
  }, {
    "name" : "Sample Policy",
    ...
  } ],
  "resultCount" : 3,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : 0
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-manage-xacml"></a>4.4.&nbsp;XACML 3.0 Export and Import</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#xacml-export">4.4.1. Exporting from OpenAM to XACML</a></span></dt><dt><span class="section"><a href="#xacml-import">4.4.2. Importing from XACML to OpenAM</a></span></dt></dl></div><p>
   OpenAM supports the ability to export policies to
   eXtensible Access Control Markup Language (XACML) 3.0-based
   formatted policy sets
   through its <code class="literal">/xacml/policies</code> REST endpoint.
   You can also import XACML 3.0 policy sets back into OpenAM by using the
   same endpoint.
   The endpoint's functionally is identical to that of the
   
   <code class="literal">ssoadm</code> <code class="literal">import-xacml</code> and
   <code class="literal">export-xacml</code> commands.
   For more information, see
   <a href="../admin-guide/index.html#script-policy" class="link">Importing and Exporting Policies</a>
  </p><div class="note"><h3 class="title">Note</h3><p>
   OpenAM can only import XACML 3.0 policy sets that were either created by an
   OpenAM instance, or that have had minor manual modifications,
   due to the reuse of some XACML 3.0 parameters for non-standard information.
   </p></div><p>
   When exporting OpenAM policies to XACML 3.0 policy sets, OpenAM maps its
   policies to XACML 3.0 policy elements. The
   mappings are as follows:
  </p><div class="table"><a name="xacml-mappings"></a><div class="table-title">Table&nbsp;4.1.&nbsp;OpenAM Policies to XACML Mappings</div><div class="table-contents"><table summary="OpenAM Policies to XACML Mappings" border="0"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr><th>OpenAM Policy</th><th>XACML Policy</th></tr></thead><tbody><tr><td>Policy Name</td><td>Policy ID</td></tr><tr><td>Description</td><td>Description</td></tr><tr><td>Current Time (yyyy.MM.dd.HH.mm.ss.SSS)</td><td>Version</td></tr><tr><td>xacml rule target</td><td>entitlement excluded resource names</td></tr><tr><td>Rule Deny Overrides</td><td>Rule Combining Algorithm ID</td></tr><tr><td>
       <p>Any of:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Entitlement Subject</p></li><li class="listitem"><p>Resource Names</p></li><li class="listitem"><p>Application Names</p></li><li class="listitem"><p>Action Values</p></li></ul></div><p>
       </p>
      </td><td>Target</td></tr><tr><td>
       <p>Any of:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Application Name</p></li><li class="listitem"><p>Entitlement Name</p></li><li class="listitem"><p>Privilege Created By</p></li><li class="listitem"><p>Privilege Modified By</p></li><li class="listitem"><p>Privilege Creation Date</p></li><li class="listitem"><p>Privilege Last Modification Date</p></li></ul></div><p>
       </p>
      </td><td>Variable Definitions</td></tr><tr><td>
       Single Level Permit/Deny Actions converted
       to Policy Rules
      </td><td>Rules</td></tr></tbody></table></div></div><br class="table-break"><div class="note"><h3 class="title">Note</h3><p>
    XACML obligation is not supported. Also, only one XACML match is defined for
    each privilege action, and only one XACML rule for each privilege action value.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xacml-export"></a>4.4.1.&nbsp;Exporting from OpenAM to XACML</h3></div></div></div><p>
    OpenAM supports exporting policies into XACML 3.0 format.

    OpenAM only exports a policy set that contains policy definitions. No other
    types can be included in the policy set, such as sub-policy sets or rules.
    The policy set mapping is as follows:
   </p><div class="table"><a name="xacml-export-mappings"></a><div class="table-title">Table&nbsp;4.2.&nbsp;Policy Set Mappings</div><div class="table-contents"><table summary="Policy Set Mappings" border="0"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>OpenAM</th><th>XACML</th></tr></thead><tbody><tr><td>Realm:&lt;timestamp&gt;(yyyy.MM.dd.HH.mm.ss.SSS)</td><td>PolicySet ID</td></tr><tr><td>Current Time (yyyy.MM.dd.HH.mm.ss.SSS)</td><td>Version</td></tr><tr><td>Deny Overrides</td><td>Policy Combining Algorithm ID</td></tr><tr><td>No targets defined</td><td>Target</td></tr></tbody></table></div></div><br class="table-break"><p>
    The export service is accessible at the <code class="literal">/xacml/policies</code>
    endpoint using a HTTP GET request
    at the following endpoint for the root realm or a specific realm:
   </p><pre class="brush: plain;">
http://openam.example.com:8080/openam/xacml/policies
http://openam.example.com:8080/openam/xacml/{realm}/policies

  where {realm} is the name of a specific realm
   </pre><p>
    You can filter your XACML exports using query search filters. Note the
    following points about the search filters:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>LDAP-based Searches</strong></span>.
     The search filters follow the standard
     guidelines for LDAP searches as they are applied to the
     entitlements index in the LDAP configuration backend, located at:
     <code class="literal">ou=default,ou=OrganizationalConfig,ou=1.0,ou=sunEntitlementIndexes,
      ou=services,dc=openam,dc=forgerock,dc=org</code>.
    </p></li><li class="listitem"><p>
     <span class="bold"><strong>Search Filter Format</strong></span>. You can specify
     a single search filter or multiple filters in the HTTP URL parameters.
     The format for the search filter is as follows:
    </p><pre class="brush: plain;">
[attribute name][operator][attribute value]
    </pre><p>
     If you specify multiple search filters, they are logically ANDed: the
     search results meet the criteria specified in all the
     search filters.
    </p><div class="table"><a name="export-search-filter-format"></a><div class="table-title">Table&nbsp;4.3.&nbsp;XACML Export Search Filter Format</div><div class="table-contents"><table summary="XACML Export Search Filter Format" border="0"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Element</th><th>Description</th></tr></thead><tbody><tr><td>Attribute Name</td><td>
         <p>
          The name of the attribute to be searched for. The only permissible
          values are: <code class="literal">application</code>, <code class="literal">createdby</code>,
          <code class="literal">lastmodifiedby</code>, <code class="literal">creationdate</code>,
          <code class="literal">lastmodifieddate</code>, <code class="literal">name</code>,
          <code class="literal">description</code>.
         </p>
        </td></tr><tr><td>Operator</td><td>
         <p>The type of comparison operation to perform.</p>
         <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>= Equals (text)</p></li><li class="listitem"><p>&lt; Less Than or Equal To (numerical)</p></li><li class="listitem"><p>&gt; Greater Than or Equal To (numerical)</p></li></ul></div>
        </td></tr><tr><td>Attribute Value</td><td>
         <p>
          The matching value. Asterisk wildcards are supported.
         </p>
        </td></tr></tbody></table></div></div><br class="table-break"></li></ul></div><div class="procedure"><a name="export-policies"></a><div class="procedure-title">Procedure&nbsp;4.1.&nbsp;To Export Policies</div><ul class="procedure"><li class="step"><p>
     Use the <code class="literal">/xacml/policies</code> endpoint to export the OpenAM entitlement
     policies into XACML 3.0 format. The following curl command exports the policies
     and returns the XACML response (truncated for display purposes).
    </p><pre class="brush: plain;">
$ curl \
  --request GET \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/json" \
  http://openam.example.com:8080/openam/xacml/policies
  
  
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;PolicySet xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17"
 PolicyCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides"
 Version="2014.10.08.21.59.39.231" PolicySetId="/:2014.10.08.21.59.39.231"&gt;
 &lt;Target/&gt;
 &lt;Policy RuleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides"
  Version="2014.10.08.18.01.03.626"
  PolicyId="Rockshop_Checkout_https://forgerock-rockshop.openrock.org:443/wp-login.php*?*"&gt;
  ...
    </pre></li></ul></div><div class="procedure"><a name="export-policies-search-filter"></a><div class="procedure-title">Procedure&nbsp;4.2.&nbsp;To Export Policies with Search Filters</div><ol class="procedure" type="1"><li class="step"><p>
     Use the <code class="literal">/xacml/policies</code> endpoint to export the policies
     into XACML 3.0 format with a search filter. This command only exports policies
     that were created by "amadmin".
    </p><pre class="brush: plain;">
$ curl \
  --request GET \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/json" \
  http://openam.example.com:8080/openam/xacml/policies?filter=createdby=amadmin
  
   </pre></li><li class="step"><p>
     You can also specify more than one search filter by logically ANDing the filters
     as follows:
    </p><pre class="brush: plain;">
$ curl \
  --request GET \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/json" \
  http://openam.example.com:8080/openam/xacml/policies?filter=createdby=amadmin&amp;
  filter=creationdate=135563832
    </pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xacml-import"></a>4.4.2.&nbsp;Importing from XACML to OpenAM</h3></div></div></div><p>
    OpenAM supports the import of XACML 3.0-based policy sets into
    OpenAM policies using the REST <code class="literal">/xacml/policies</code>
    endpoint.
    To test an import, OpenAM provides a dry-run feature that runs an import
    without saving the changes to the database. The dry-run feature provides a
    summary of the import so that you can troubleshoot any potential mismatches
    prior to the actual import.
   </p><p>
    You can import a XACML policy using an HTTP POST request for the root realm
    or a specific realm at the following endpoints:
   </p><pre class="brush: plain;">
http://openam.example.com:8080/openam/xacml/policies
http://openam.example.com:8080/openam/xacml/{realm}/policies

where {realm} is the name of a specific realm
   </pre><div class="procedure"><a name="procedure-xacml-import"></a><div class="procedure-title">Procedure&nbsp;4.3.&nbsp;To Import a XACML 3.0 Policy</div><ol class="procedure" type="1"><li class="step"><p>You can do a dry run using the <code class="literal">dryrun=true</code> query to
      test the import. The dry-run option outputs in JSON format and displays the status
      of each import policy, where "U" indicates "Updated"; "A" for "Added". The
      dry-run does not actually update to the database. When you are ready for an
      actual import, you need to re-run the command
      without the <code class="literal">dryrun=true</code> query.
     </p><pre class="brush: plain;">
$ curl \
  --request POST \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/xml" \
  --data @xacml-policy.xml
  http://openam.example.com:8080/openam/xacml/policies?dryrun=true
[
 {
   "status":"U",
   "name":"testHelpDeskreferralpolicy"
 },
 {
   "status":"U",
   "name":"test_Referral"
 },
 {
   "status":"U",
   "name":"testexternalreferralpolicy"
 },
 {
   "status":"U",
   "name":"testregexternalreferralpolicy"
 }
]
     </pre></li><li class="step"><p>
Use the <code class="literal">/xacml/policies</code> endpoint to import a XACML policy:
     </p><pre class="brush: plain;">
$ curl \
  --request POST \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/xml" \
  --data @xacml-policy.xml
  http://openam.example.com:8080/openam/xacml/policies
     </pre></li></ol></div><div class="tip"><h3 class="title">Tip</h3><p>You can import a XACML policy into a realm as follows:</p><pre class="brush: plain;">
$ curl \
  --request POST \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/xml" \
  --data @xacml-policy.xml
  http://openam.example.com:8080/openam/xacml/{realm}/policies
     </pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-applications"></a>4.5.&nbsp;Defining Applications</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-applications-create">4.5.1. Creating Applications</a></span></dt><dt><span class="section"><a href="#rest-api-authz-applications-read">4.5.2. Reading Applications</a></span></dt><dt><span class="section"><a href="#rest-api-authz-applications-update">4.5.3. Updating Applications</a></span></dt><dt><span class="section"><a href="#rest-api-authz-applications-delete">4.5.4. Deleting Applications</a></span></dt><dt><span class="section"><a href="#rest-api-authz-applications-query">4.5.5. Listing Applications</a></span></dt></dl></div><p>
   Application definitions set constraints
   for the policies that can be defined for a particular application.
   The default built-in application is the <code class="literal">iPlanetAMWebAgentService</code>,
   which OpenAM policy agents use to allow policy management through the console.
  </p><p>
   Application resources are represented in JSON and take the following form.
   Application resources are built from standard JSON objects and values
   (strings, numbers, objects, arrays, <code class="literal">true</code>,
   <code class="literal">false</code>, and <code class="literal">null</code>).
  </p><p lang="en">
  Do not use special characters within policy, application or referral names
  (for example, "my+referral") using the Policy Editor or REST endpoints as
  OpenAM returns a 400 Bad Request error.
  The special characters are: double quotes ("), plus sign (+), comma (,),
  less than (&lt;), equals (=), greater than (&gt;), backslash (\), and
  null (\u0000).
 </p><pre class="brush: javascript;">
{
  "name": "application name string",
  "resources": [
     "resource name pattern",
     ...
  ],
  "actions": {
     "action name string": true,
     "other action name string": false,
     ...
  },
  "conditions": [
     "condition type",
     ...
  ],
  "realm": "the realm in which the application is defined",
  "applicationType": "application type name string",
  "description": "string describing application",
  "resourceComparator": "resource comparator class name",
  "subjects": [
     "subject type",
     ...
  ],
  "entitlementCombiner": "decision combiner",
  "saveIndex": "save index class name",
  "searchIndex": "search index class name",
  "attributeNames": [
     "attribute implementation class name",
     ...
  ]
}
  </pre><div class="variablelist"><p>
    The values for the fields shown in the description are explained below:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"name"</code></span></dt><dd><p>
      String matching the name
      in the URL used when creating the application by HTTP PUT
      or in the body when creating the application by HTTP POST.
     </p></dd><dt><span class="term"><code class="literal">"resources"</code></span></dt><dd><p>
      Strings specifying resource name patterns as in the following example:
     </p><pre class="brush: javascript;">
{
    "resources": [
        "http://www.example.com:8080/*",
        "http://www.example.com:8080/*?*"
    ]
}
     </pre></dd><dt><span class="term"><code class="literal">"actions"</code></span></dt><dd><p>
      Set of string action names,
      each set to a boolean indicating whether the action is allowed
      in the context of this application as in the following example:
     </p><pre class="brush: javascript;">
{
    "actions": {
        "UPDATE": true,
        "PATCH": true,
        "QUERY": true,
        "CREATE": true,
        "DELETE": true,
        "READ": true,
        "ACTION": true
    }
}
     </pre></dd><dt><span class="term"><code class="literal">"conditions"</code></span></dt><dd><p>
      Condition types allowed in the context of this application.
     </p><p>
      The following condition types are available:
     </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"AND"</code></td></tr><tr><td><code class="literal">"OR"</code></td></tr><tr><td><code class="literal">"NOT"</code></td></tr><tr><td><code class="literal">"AMIdentityMembership"</code></td></tr><tr><td><code class="literal">"AuthLevel"</code></td></tr><tr><td><code class="literal">"AuthScheme"</code></td></tr><tr><td><code class="literal">"AuthenticateToRealm"</code></td></tr><tr><td><code class="literal">"AuthenticateToService"</code></td></tr><tr><td><code class="literal">"IPv4"</code></td></tr><tr><td><code class="literal">"IPv6"</code></td></tr><tr><td><code class="literal">"LDAPFilter"</code></td></tr><tr><td><code class="literal">"LEAuthLevel"</code></td></tr><tr><td><code class="literal">"OAuth2Scope"</code></td></tr><tr><td><code class="literal">"ResourceEnvIP"</code></td></tr><tr><td><code class="literal">"Session"</code></td></tr><tr><td><code class="literal">"SessionProperty"</code></td></tr><tr><td><code class="literal">"SimpleTime"</code></td></tr></table><p>
      For more on condition types,
      see <a class="xref" href="#rest-api-authz-policies" title="4.3.&nbsp;Managing Policies">Section&nbsp;4.3, &#8220;Managing Policies&#8221;</a> and
      <a class="xref" href="#rest-api-authz-condition-types" title="4.7.&nbsp;Viewing Environment Condition Types">Section&nbsp;4.7, &#8220;Viewing Environment Condition Types&#8221;</a>.
     </p></dd><dt><span class="term"><code class="literal">"realm"</code></span></dt><dd><p>
      Name of the realm where this application is defined. You must specify the
      realm in the application resource JSON even though it can be derived from
      the URL that is used when creating the application using an HTTP PUT call.
     </p></dd><dt><span class="term"><code class="literal">"applicationType"</code></span></dt><dd><p>
      Name of the application type used as a template for this application.
     </p></dd><dt><span class="term"><code class="literal">"description"</code></span></dt><dd><p>
      String describing the application.
     </p></dd><dt><span class="term"><code class="literal">"resourceComparator"</code></span></dt><dd><p>
      Class name of the resource comparator implementation used
      in the context of this application.
     </p><p>
      The following implementations are available:
     </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"com.sun.identity.entitlement.ExactMatchResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.PrefixResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.RegExResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.URLResourceName"</code></td></tr></table></dd><dt><span class="term"><code class="literal">"subjects"</code></span></dt><dd><p>
      Subject types allowed in the context of this application.
     </p><p>
      The following subject types are available:
     </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"AND"</code></td></tr><tr><td><code class="literal">"OR"</code></td></tr><tr><td><code class="literal">"NOT"</code></td></tr><tr><td><code class="literal">"AuthenticatedUsers"</code></td></tr><tr><td><code class="literal">"Identity"</code></td></tr><tr><td><code class="literal">"JwtClaim"</code></td></tr><tr><td><code class="literal">"NONE"</code></td></tr></table><p>
      For more on subject types,
      see <a class="xref" href="#rest-api-authz-policies" title="4.3.&nbsp;Managing Policies">Section&nbsp;4.3, &#8220;Managing Policies&#8221;</a> and
      <a class="xref" href="#rest-api-authz-subject-types" title="4.8.&nbsp;Viewing Subject Condition Types">Section&nbsp;4.8, &#8220;Viewing Subject Condition Types&#8221;</a>.
     </p></dd><dt><span class="term"><code class="literal">"entitlementCombiner"</code></span></dt><dd><p>
      Name of the decision combiner, such as <code class="literal">"DenyOverride"</code>.
     </p><p>
      For more on decision combiners,
      see <a class="xref" href="#rest-api-authz-decision-combiners" title="4.10.&nbsp;Viewing Decision Combiners">Section&nbsp;4.10, &#8220;Viewing Decision Combiners&#8221;</a>.
     </p></dd><dt><span class="term"><code class="literal">"saveIndex"</code></span></dt><dd><p>
      Class name of the implementation for creating indexes for resource names,
      such as <code class="literal">"com.sun.identity.entitlement.util.ResourceNameIndexGenerator"</code>
      for URL resource names.
     </p></dd><dt><span class="term"><code class="literal">"searchIndex"</code></span></dt><dd><p>
      Class name of the implementation for searching indexes for resource names,
      such as <code class="literal">"com.sun.identity.entitlement.util.ResourceNameSplitter"</code>
      for URL resource names.
     </p></dd><dt><span class="term"><code class="literal">"attributeNames"</code></span></dt><dd><p>
      A list of attribute names such as
      <code class="literal">cn</code>.
      The list is used to aid policy indexing and lookup.
     </p></dd></dl></div><p>
   The examples above do not show the fields added by OpenAM
   to indicate when the application was created and last updated, and by whom.
   Those field are
   <code class="literal">"createdBy"</code> and <code class="literal">"lastModifiedBy"</code>,
   which take strings holding universal identifier DNs as their values,
   and <code class="literal">"creationDate"</code> and <code class="literal">"lastModifiedDate"</code>,
   which an integer number of seconds since the Unix epoch.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-applications-create"></a>4.5.1.&nbsp;Creating Applications</h3></div></div></div><p>
    To create an application definition,
    either perform an HTTP PUT indicating the full path to the resource
    and the name in the resource matching the name in the path,
    or perform an HTTP POST with the name to use specified in the resource.
   </p><p>
    The HTTP PUT form includes the application definition
    as the JSON resource data,
    with the header <code class="literal">Content-Type: application/json</code>
    and uses the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><p lang="en">
  Do not use special characters within policy, application or referral names
  (for example, "my+referral") using the Policy Editor or REST endpoints as
  OpenAM returns a 400 Bad Request error.
  The special characters are: double quotes ("), plus sign (+), comma (,),
  less than (&lt;), equals (=), greater than (&gt;), backslash (\), and
  null (\u0000).
 </p><pre class="brush: plain;">
$ curl \
 --request PUT \
 --header "If-None-Match: *" \
 --header "iPlanetDirectoryPro: AQIC5..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "myApplication",
    "resources": [
        "http://www.example.com:8080/*",
        "http://www.example.com:8080/*?*"
    ],
    "actions": {
        "UPDATE": true,
        "PATCH": true,
        "QUERY": true,
        "CREATE": true,
        "DELETE": true,
        "READ": true,
        "ACTION": true
    },
    "conditions": [
        "AND",
        "OR",
        "NOT",
        "AMIdentityMembership",
        "AuthLevel",
        "AuthScheme",
        "AuthenticateToRealm",
        "AuthenticateToService",
        "IPv4",
        "IPv6",
        "LDAPFilter",
        "LEAuthLevel",
        "OAuth2Scope",
        "ResourceEnvIP",
        "Session",
        "SessionProperty",
        "SimpleTime"
    ],
    "realm": "/",
    "applicationType": "iPlanetAMWebAgentService",
    "description": "An example application",
    "resourceComparator": "com.sun.identity.entitlement.URLResourceName",
    "subjects": [
        "AND",
        "OR",
        "NOT",
        "AuthenticatedUsers",
        "Identity",
        "JwtClaim"
    ],
    "entitlementCombiner": "DenyOverride",
    "saveIndex": null,
    "searchIndex": null,
    "attributeNames": []
}
' \
 https://openam.example.com:8443/openam/json/applications/myApplication
{
  "name" : "myApplication",
  "resources" : [
    "http://www.example.com:8080/*",
    "http://www.example.com:8080/*?*"
  ],
  "actions" : {
    "UPDATE" : true,
    "PATCH" : true,
    "QUERY" : true,
    "CREATE" : true,
    "DELETE" : true,
    "READ" : true,
    "ACTION" : true
  },
  "conditions": [
    "AND",
    "OR",
    "NOT",
    "AMIdentityMembership",
    "AuthLevel",
    "AuthScheme",
    "AuthenticateToRealm",
    "AuthenticateToService",
    "IPv4",
    "IPv6",
    "LDAPFilter",
    "LEAuthLevel",
    "OAuth2Scope",
    "ResourceEnvIP",
    "Session",
    "SessionProperty",
    "SimpleTime"
  ],
  "realm" : "/",
  "creationDate" : 1398761708295,
  "lastModifiedDate" : 1398761708295,
  "createdBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "lastModifiedBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "applicationType" : "iPlanetAMWebAgentService",
  "description" : "An example application",
  "resourceComparator" : "com.sun.identity.entitlement.URLResourceName",
  "subjects" : [
    "AND",
    "OR",
    "NOT",
    "AuthenticatedUsers",
    "Identity",
    "JwtClaim"
  ],
  "entitlementCombiner" : "DenyOverride",
  "saveIndex" : null,
  "searchIndex" : null,
  "attributeNames" : [ ]
}
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p><p>
    The HTTP POST form includes the application definition
    as the JSON resource data,
    with the header <code class="literal">Content-Type: application/json</code>
    and uses the <code class="literal">_action=create</code> operation.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "myApplication",
    "resources": [
        "http://www.example.com:8080/*",
        "http://www.example.com:8080/*?*"
    ],
    "actions": {
        "UPDATE": true,
        "PATCH": true,
        "QUERY": true,
        "CREATE": true,
        "DELETE": true,
        "READ": true,
        "ACTION": true
    },
    "conditions": [
        "AND",
        "OR",
        "NOT",
        "AMIdentityMembership",
        "AuthLevel",
        "AuthScheme",
        "AuthenticateToRealm",
        "AuthenticateToService",
        "IPv4",
        "IPv6",
        "LDAPFilter",
        "LEAuthLevel",
        "OAuth2Scope",
        "ResourceEnvIP",
        "Session",
        "SessionProperty",
        "SimpleTime"
    ],
    "realm": "/",
    "applicationType": "iPlanetAMWebAgentService",
    "description": "An example application",
    "resourceComparator": "com.sun.identity.entitlement.URLResourceName",
    "subjects": [
        "AND",
        "OR",
        "NOT",
        "AuthenticatedUsers",
        "Identity",
        "JwtClaim"
    ],
    "entitlementCombiner": "DenyOverride",
    "saveIndex": null,
    "searchIndex": null,
    "attributeNames": []
}' \
 https://openam.example.com:8443/openam/json/applications/?_action=create
{
  "name" : "myApplication",
  "resources" : [
    "http://www.example.com:8080/*",
    "http://www.example.com:8080/*?*"
  ],
  "actions" : {
    "UPDATE" : true,
    "PATCH" : true,
    "QUERY" : true,
    "CREATE" : true,
    "DELETE" : true,
    "READ" : true,
    "ACTION" : true
  },
  "conditions": [
    "AND",
    "OR",
    "NOT",
    "AMIdentityMembership",
    "AuthLevel",
    "AuthScheme",
    "AuthenticateToRealm",
    "AuthenticateToService",
    "IPv4",
    "IPv6",
    "LDAPFilter",
    "LEAuthLevel",
    "OAuth2Scope",
    "ResourceEnvIP",
    "Session",
    "SessionProperty",
    "SimpleTime"
  ],
  "realm" : "/",
  "creationDate" : 1398762452667,
  "lastModifiedDate" : 1398762452667,
  "createdBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "lastModifiedBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "applicationType" : "iPlanetAMWebAgentService",
  "description" : "An example application",
  "resourceComparator" : "com.sun.identity.entitlement.URLResourceName",
  "subjects" : [
    "AND",
    "OR",
    "NOT",
    "AuthenticatedUsers",
    "Identity",
    "JwtClaim"
  ],
  "entitlementCombiner" : "DenyOverride",
  "saveIndex" : null,
  "searchIndex" : null,
  "attributeNames" : [ ]
}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-applications-read"></a>4.5.2.&nbsp;Reading Applications</h3></div></div></div><p>
    To read an application definition, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/applications/myApplication
{
  "name" : "myApplication",
  "resources" : [
    "http://www.example.com:8080/*",
    "http://www.example.com:8080/*?*"
  ],
  "actions" : {
    "POST" : true,
    "PATCH" : true,
    "GET" : true,
    "DELETE" : true,
    "OPTIONS" : true,
    "PUT" : true,
    "HEAD" : true
  },
  "conditions": [
    "AND",
    "OR",
    "NOT",
    "AMIdentityMembership",
    "AuthLevel",
    "AuthScheme",
    "AuthenticateToRealm",
    "AuthenticateToService",
    "IPv4",
    "IPv6",
    "LDAPFilter",
    "LEAuthLevel",
    "OAuth2Scope",
    "ResourceEnvIP",
    "Session",
    "SessionProperty",
    "SimpleTime"
  ],
  "realm" : "/",
  "creationDate" : 1398760362341,
  "lastModifiedDate" : 1398760362341,
  "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
  "lastModifiedBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
  "applicationType" : "iPlanetAMWebAgentService",
  "description" : null,
  "resourceComparator" : "com.sun.identity.entitlement.URLResourceName",
  "subjects" : [
    "AND",
    "OR",
    "NOT",
    "AuthenticatedUsers",
    "Identity",
    "JwtClaim"
  ],
  "entitlementCombiner" : "DenyOverride",
  "saveIndex" : null,
  "searchIndex" : null,
  "attributeNames" : [ ]
}
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-applications-update"></a>4.5.3.&nbsp;Updating Applications</h3></div></div></div><p>
    To update an application definition, perform an HTTP PUT
    specifying the resource name
    with the application definition as the JSON resource data,
    and with the header <code class="literal">Content-Type: application/json</code>.
    This is essentially the same as creating an application definition,
    but without the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "myApplication",
    "resources": [
        "http://www.example.com:8080/*",
        "http://www.example.com:8080/*?*"
    ],
    "actions": {
        "UPDATE": false,
        "PATCH": false,
        "QUERY": true,
        "CREATE": false,
        "DELETE": false,
        "READ": true,
        "ACTION": false
    },
    "conditions": [
        "SimpleTime"
    ],
    "realm": "/",
    "applicationType": "iPlanetAMWebAgentService",
    "description": "Updated application with fewer conditions and subjects",
    "resourceComparator": "com.sun.identity.entitlement.URLResourceName",
    "subjects": [
        "AuthenticatedUsers",
        "JwtClaim"
    ],
    "entitlementCombiner": "DenyOverride",
    "saveIndex": null,
    "searchIndex": null,
    "attributeNames": []
}' \
 https://openam.example.com:8443/openam/json/applications/myApplication
{
  "name" : "myApplication",
  "resources" : [
    "http://www.example.com:8080/*",
    "http://www.example.com:8080/*?*"
  ],
  "actions" : {
    "UPDATE" : false,
    "PATCH" : false,
    "QUERY" : true,
    "CREATE" : false,
    "DELETE" : false,
    "READ" : true,
    "ACTION" : false
  },
  "conditions" : [
    "SimpleTime"
  ],
  "realm" : "/",
  "creationDate" : 1398762194628,
  "lastModifiedDate" : 1398762194628,
  "createdBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "lastModifiedBy" : "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org",
  "applicationType" : "iPlanetAMWebAgentService",
  "description" : "Updated application with fewer conditions and subjects",
  "resourceComparator" : "com.sun.identity.entitlement.URLResourceName",
  "subjects" : [
    "AuthenticatedUsers",
    "JwtClaim"
  ],
  "entitlementCombiner" : "DenyOverride",
  "saveIndex" : null,
  "searchIndex" : null,
  "attributeNames" : [ ]
}
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-applications-delete"></a>4.5.4.&nbsp;Deleting Applications</h3></div></div></div><p>
    To delete an application definition, perform an HTTP DELETE
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --request DELETE \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/applications/myApplication
{}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-applications-query"></a>4.5.5.&nbsp;Listing Applications</h3></div></div></div><p>
    To list application definitions, perform an HTTP GET on the endpoint,
    setting the <code class="literal">_queryFilter</code> query string parameter.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/applications?_queryFilter=true
   
{
  "result" : [ {
    "name" : "myApplication",
    "resources" : [
      "http://www.example.com:8080/*",
      "http://www.example.com:8080/*?*"
    ],
    "actions" : {
      "POST" : true,
      "PATCH" : true,
      "GET" : true,
      "DELETE" : true,
      "OPTIONS" : true,
      "PUT" : true,
      "HEAD" : true
    },
    "conditions" : [
      "SimpleTime"
    ],
    "attributeNames" : [
    ],
    "realm":"/",
    "creationDate":1416428109115,
    "lastModifiedDate":1416428109115,
    "lastModifiedBy":"id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "subjects":[
      "JwtClaim",
      "AuthenticateUsers"
    ],
    "description":"Updated application with fewer conditions and subjects",
    "createdBy":id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "applicationType":"iPlanetAMWebServices",
    "entitlementCombiner":"DenyOverride",
    },
  ],
  "resultCount":1,
  "pagedResultsCookie":null,
  "remainingPagedResults":0
}
   </pre><p>
    The <code class="literal">_queryFilter</code> parameter can take
    <code class="literal">true</code> to match every policy,
    <code class="literal">false</code> to match no policies,
    or a filter of the following form to match field values:
    <code class="literal"><em class="replaceable"><code>field</code></em> <em class="replaceable"><code>operator</code></em>
    <em class="replaceable"><code>value</code></em></code>
    where <em class="replaceable"><code>field</code></em> represents the field name,
    <em class="replaceable"><code>operator</code></em> is the operator code,
    <em class="replaceable"><code>value</code></em> is the value to match,
    and the entire filter is URL-encoded.
    Supported operators are as follows:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">eq</code>: equals (for matching strings)
     </p></li><li class="listitem"><p>
      <code class="literal">ge</code>: greater than or equal to (for matching integers)
     </p></li><li class="listitem"><p>
      <code class="literal">gt</code>: greater than (for matching integers)
     </p></li><li class="listitem"><p>
      <code class="literal">le</code>: less than or equal to (for matching integers)
     </p></li><li class="listitem"><p>
      <code class="literal">lt</code>: less than (for matching integers)
     </p></li></ul></div><div class="itemizedlist"><p>
     The <code class="literal"><em class="replaceable"><code>field</code></em></code> value
     can take the following values:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">"name"</code> (string)
     </p></li><li class="listitem"><p>
      <code class="literal">"description"</code> (string)
     </p></li><li class="listitem"><p>
      <code class="literal">"createdBy"</code> (string)
     </p></li><li class="listitem"><p>
      <code class="literal">"creationDate"</code> (date)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModifiedBy"</code> (string)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModified"</code> (date)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModified"</code>
     </p></li></ul></div><p>
    The String fields only support the <code class="literal">eq</code> operator, which is
    implemented using regular expression pattern matching.
   </p><p>
    The Date files support the <code class="literal">eq</code>, <code class="literal">ge</code>,
    <code class="literal">gt</code>, <code class="literal">le</code>, and <code class="literal">lt</code>
    operators. The implementation of <code class="literal">eq</code> for the Date fields
    do not use regular expression pattern matching.
   </p><p>
    Filters can be composed of multiple expressions
    by a using boolean operator <code class="literal">AND</code>,
    and by using parentheses,
    <code class="literal">(<em class="replaceable"><code>expression</code></em>)</code>,
    to group expressions.
    You must URL encode the filter expression
    in <code class="literal">_queryFilter=<em class="replaceable"><code>filter</code></em></code>.
   </p><p>
    Since regular expressions are implemented for some operators, you can specify
    a filter that can include or exclude specified elements. For example,
    the following query searches for application names containing 'iPlanet'.
    The <code class="literal">queryFilter</code> string is URL-encoded.
   </p><pre class="brush: plain;">
$ curl --header "iPlanetDirectoryPro" AQIC5..." \
https://openam.example.com:8443/openam/json/applications?_queryFilter=name%20eq%20%22iPlanet.*%22
   </pre><div class="note"><h3 class="title">Note</h3><p>While some operators use regular expressions as its underlying
    mechanism, CREST endpoints do not use regular expressions.
   </p></div><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p><p>
    You can use <code class="literal">_pageSize=<em class="replaceable"><code>integer</code></em></code>
    to limit the number of results returned.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-application-types"></a>4.6.&nbsp;Viewing Application Types</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-application-types-read">4.6.1. Reading Application Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-application-types-query">4.6.2. Listing Application Types</a></span></dt></dl></div><p>
   Application types act as templates for creating applications.
  </p><p>
   The default application type that represents web resources
   is <code class="literal">iPlanetAMWebAgentService</code>,
   which defines resources as URL patterns and actions as HTTP methods.
   OpenAM policy agents use a default application type based on this type,
   which is called <code class="literal">iPlanetAMWebAgentService</code>.
   This is the application type for policies
   that you edit through OpenAM console.
  </p><p>
   OpenAM supports other application types as well, such as CREST types,
   that you can manage over the policy REST endpoints.
  </p><p>
   Applications types are server-wide, and do not differ by realm.
   Hence the URI for the application types API
   does not contain a realm component,
   but is <code class="literal">/json/applicationtypes</code>.
  </p><p>
   Application type resources are represented in JSON and take the following form.
   Application type resources are built from standard JSON objects and values
   (strings, numbers, objects, arrays, <code class="literal">true</code>,
   <code class="literal">false</code>, and <code class="literal">null</code>).
  </p><pre class="brush: javascript;">
{
  "name": "application type name string",
  "actions": {
     "action name string": true,
     "other action name string": false,
     ...
  },
  "resourceComparator": "resource comparator class name",
  "saveIndex": "save index class name",
  "searchIndex": "search index class name",
  "applicationClassName": "com.sun.identity.entitlement.Application"
}
  </pre><div class="variablelist"><p>
    The values for the fields shown in the description are explained below:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"name"</code></span></dt><dd><p>
      String matching the name
      in the URL used when creating the application type by HTTP PUT
      or in the body when creating the application type by HTTP POST.
     </p></dd><dt><span class="term"><code class="literal">"actions"</code></span></dt><dd><p>
      Set of string action names,
      each set to a boolean indicating whether the action is allowed
      as in the following example:
     </p><pre class="brush: javascript;">
{
    "actions": {
        "UPDATE": true,
        "PATCH": true,
        "QUERY": true,
        "CREATE": true,
        "DELETE": true,
        "READ": true,
        "ACTION": true
    }
}
     </pre></dd><dt><span class="term"><code class="literal">"resourceComparator"</code></span></dt><dd><p>
      Class name of the resource comparator implementation used
      in the context of this application.
     </p><p>
      The following implementations are available:
     </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="literal">"com.sun.identity.entitlement.ExactMatchResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.PrefixResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.RegExResourceName"</code></td></tr><tr><td><code class="literal">"com.sun.identity.entitlement.URLResourceName"</code></td></tr></table></dd><dt><span class="term"><code class="literal">"saveIndex"</code></span></dt><dd><p>
      Class name of the implementation for creating indexes for resource names,
      such as <code class="literal">"com.sun.identity.entitlement.util.ResourceNameIndexGenerator"</code>
      for URL resource names.
     </p></dd><dt><span class="term"><code class="literal">"searchIndex"</code></span></dt><dd><p>
      Class name of the implementation for searching indexes for resource names,
      such as <code class="literal">"com.sun.identity.entitlement.util.ResourceNameSplitter"</code>
      for URL resource names.
     </p></dd><dt><span class="term"><code class="literal">"applicationClassName"</code></span></dt><dd><p>
      Class name of the application implementation,
      such as <code class="literal">"com.sun.identity.entitlement.Application"</code>.
     </p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-application-types-read"></a>4.6.1.&nbsp;Reading Application Types</h3></div></div></div><p>
    To read an application type, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/applicationtypes/crestPolicyService
{
  "name" : "crestPolicyService",
  "actions" : {
    "UPDATE" : true,
    "PATCH" : true,
    "QUERY" : true,
    "CREATE" : true,
    "DELETE" : true,
    "READ" : true,
    "ACTION" : true
  },
  "resourceComparator" : "com.sun.identity.entitlement.URLResourceName",
  "saveIndex" : "org.forgerock.openam.entitlement.indextree.TreeSaveIndex",
  "searchIndex" : "org.forgerock.openam.entitlement.indextree.TreeSearchIndex",
  "applicationClassName" : "com.sun.identity.entitlement.Application"
}

   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-application-types-query"></a>4.6.2.&nbsp;Listing Application Types</h3></div></div></div><p>
    To list application types, perform an HTTP GET on the endpoint,
    setting the <code class="literal">_queryFilter</code> query string parameter
    as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/applicationtypes?_queryFilter=true
{
  "result" : [ ... application types ... ],
  "resultCount" : 8,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : -1
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-condition-types"></a>4.7.&nbsp;Viewing Environment Condition Types</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-condition-types-read">4.7.1. Reading Environment Condition Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-condition-types-query">4.7.2. Listing Environment Condition Types</a></span></dt></dl></div><p>
   Environment condition types describe the JSON representation
   of environment conditions that you can use in policy definitions.
  </p><p>
   Environment condition types are server-wide, and do not differ by realm.
   Hence the URI for the condition types API
   does not contain a realm component,
   but is <code class="literal">/json/conditiontypes</code>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-condition-types-read"></a>4.7.1.&nbsp;Reading Environment Condition Types</h3></div></div></div><p>
    To read a environment condition type, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><p>
    You can use the query string parameter
    <code class="literal">_prettyPrint=true</code> to make the output easier to read.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/conditiontypes/IPv4
{
  "title" : "IPv4",
  "logical" : false,
  "config" : {
    "type" : "object",
    "properties" : {
      "startIp" : {
        "type" : "string"
      },
      "endIp" : {
        "type" : "string"
      },
      "dnsName" : {
        "type" : "array",
        "items" : {
          "type" : "string"
        }
      }
    }
  }
}
   </pre><p>
    Notice that the environment condition type has a title,
    a "logical" field
    that indicates whether the type is a logical operator or takes a predicate,
    and a configuration specification.
    The configuration specification in this case indicates
    that an IPv4 environment condition has two properties, "startIp" and "endIp",
    that each take a single string value, and a third property, "dnsName," that
    takes an array of string values.
    In other words, a concrete IP environment condition specification
    without a DNS name constraint
    could be represented in a policy definition as in the following example:
   </p><pre class="brush: javascript;">
{
   "type": "IPv4",
   "startIp": "127.0.0.1",
   "endIp": "127.0.0.255"
}
   </pre><p>
    The configuration is what differs the most across environment condition types.
    The NOT condition, for example, takes a single condition object
    as the body of its configuration.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/conditiontypes
    /NOT
{
  "title" : "NOT",
  "logical" : true,
  "config" : {
    "type" : "object",
    "properties" : {
      "condition" : {
        "type" : "object",
        "properties" : {
        }
      }
    }
  }
}
   </pre><p>
    The concrete NOT condition therefore takes the following form.
   </p><pre class="brush: javascript;">
{
    "type": "NOT",
    "condition": {
        ...
    }
}
   </pre><p>
    The OR condition takes an array of conditions.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/conditiontypes/OR
{
  "title" : "OR",
  "logical" : true,
  "config" : {
    "type" : "object",
    "properties" : {
      "conditions" : {
        "type" : "array",
        "items" : {
          "type" : "any"
        }
      }
    }
  }
}
   </pre><p>
    A corresponding concrete OR condition thus takes the following form.
   </p><pre class="brush: javascript;">
{
    "type": "OR",
    "conditions": [
        {
            ...
        },
        {
            ...
        },
        ...
    ]
}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-condition-types-query"></a>4.7.2.&nbsp;Listing Environment Condition Types</h3></div></div></div><p>
    To list all environment condition types, perform an HTTP GET on the endpoint,
    setting the query string parameter, <code class="literal">_queryFilter=true</code>,
    as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/conditiontypes?_queryFilter=true
{
  "result" : [ ... condition types ... ],
  "resultCount" : 18,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : 0
}
   </pre><p>
    You can use the query string parameter
    <code class="literal">_prettyPrint=true</code> to make the output easier to read.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-subject-types"></a>4.8.&nbsp;Viewing Subject Condition Types</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-subject-types-read">4.8.1. Reading Subject Condition Types</a></span></dt><dt><span class="section"><a href="#rest-api-authz-subject-types-query">4.8.2. Listing Subject Condition Types</a></span></dt></dl></div><p>
   Subject types describe the JSON representation
   of subject conditions that you can use in policy definitions.
  </p><p>
   Subject condition types are server-wide, and do not differ by realm.
   Hence the URI for the subject types API
   does not contain a realm component,
   but is <code class="literal">/json/subjecttypes</code>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-subject-types-read"></a>4.8.1.&nbsp;Reading Subject Condition Types</h3></div></div></div><p>
    To read a subject condition type, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><p>
    You can use the query string parameter
    <code class="literal">_prettyPrint=true</code> to make the output easier to read.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/subjecttypes/Identity
{
  "title" : "Identity",
  "logical" : false,
  "config" : {
    "type" : "object",
    "properties" : {
      "subjectValues" : {
        "type" : "array",
        "items" : {
          "type" : "string"
        }
      }
    }
  }
}
   </pre><p>
    Notice that the subject type has a title,
    a "logical" field
    that indicates whether the type is a logical operator or takes a predicate,
    and a configuration specification.
    The configuration specification in this case indicates
    that an Identity subject condition has one property,
    "subjectValues", which takes an array of string values.
    In other words, a concrete Identity subject condition specification
    is represented in a policy definition as in the following example:
   </p><pre class="brush: javascript;">
{
   "type": "Identity",
   "subjectValues": [
       "uid=scarter,ou=People,dc=example,dc=com"
   ]
}
   </pre><p>
    The configuration is what differs the most across subject condition types.
    The AND condition, for example, takes an array of subject condition objects
    as the body of its configuration.
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/subjecttypes/AND
{
  "title" : "AND",
  "logical" : true,
  "config" : {
    "type" : "object",
    "properties" : {
      "subjects" : {
        "type" : "array",
        "items" : {
          "type" : "any"
        }
      }
    }
  }
}
   </pre><p>
    The concrete AND subject condition therefore takes the following form.
   </p><pre class="brush: javascript;">
{
    "type": "AND",
    "subject": [
      {
        ...
      },
      ...
    ]
}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-subject-types-query"></a>4.8.2.&nbsp;Listing Subject Condition Types</h3></div></div></div><p>
    To list all subject condition types, perform an HTTP GET on the endpoint,
    setting the query string parameter, <code class="literal">_queryFilter=true</code>,
    as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/subjecttypes/?_queryFilter=true
{
  "result" : [ ... subject types ... ],
  "resultCount" : 8,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : 0
}
   </pre><p>
    You can use the query string parameter
    <code class="literal">_prettyPrint=true</code> to make the output easier to read.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-subject-attributes"></a>4.9.&nbsp;Viewing Subject Attributes</h2></div></div></div><p>
   When you define a policy subject condition, the condition can depend on values
   of subject attributes stored in a user's profile. The list of possible subject
   attributes that you can use depends on the LDAP User Attributes configured for
   the Identity data store where OpenAM looks up the user's profile.
  </p><p>
   Subject attributes derive from the list of LDAP user attributes configured
   for the Identity data store. For more information, see
   <a href="../admin-guide/index.html#config-data-store" class="link">Configuring Data Stores</a>.

  </p><p>
   You can get a listing of all subject attribute
   names using the <code class="literal">/json/subjectattributes/?_queryFilter=true</code>
   command on the endpoint.
   There are no restrictions on the search and no pagination cookie is set.
   The subject
   attribute names are all returned as one in a "result" array.
  </p><pre class="brush: plain;">
$ curl \
  --request GET \
  --header "iPlanetDirectoryPro: AQIC5..." \
  --header "Content-Type: application/json" \
  https://openam.example.com:8443/openam/json/subjectattributes/?_queryFilter=true

{
 "result" : [ ... subject attribute types ... ],
 "resultCount": 87,
 "pagedResultsCookie": null,
 "remainingPagedResults": 0
}

  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-decision-combiners"></a>4.10.&nbsp;Viewing Decision Combiners</h2></div></div></div><p>
   Decision combiners describe how to resolve policy decisions
   when multiple policies apply.
  </p><p>
   Decision combiners are server-wide, and do not differ by realm.
   Hence the URI for the condition types API
   does not contain a realm component,
   but is <code class="literal">/json/decisioncombiners</code>.
  </p><p>
   To list all decision combiners, perform an HTTP GET on the endpoint,
   setting the query string parameter, <code class="literal">_queryFilter=true</code>,
   as in the following example:
  </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/decisioncombiners/?_queryFilter=true
{
  "result" : [ {
    "title" : "DenyOverride"
  } ],
  "resultCount" : 1,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : 0
}
  </pre><p>
   You can use the query string parameter
   <code class="literal">_prettyPrint=true</code> to make the output easier to read.
  </p><p>
   To view an individual decision combiner, perform an HTTP GET on its resource.
  </p><pre class="brush: plain;">
$ curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/decisioncombiners/DenyOverride
{
  "title" : "DenyOverride"
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-referrals"></a>4.11.&nbsp;Managing Referrals</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-authz-referrals-create">4.11.1. Creating Referrals</a></span></dt><dt><span class="section"><a href="#rest-api-authz-referrals-read">4.11.2. Reading Referrals</a></span></dt><dt><span class="section"><a href="#rest-api-authz-referrals-update">4.11.3. Updating Referrals</a></span></dt><dt><span class="section"><a href="#rest-api-authz-referrals-delete">4.11.4. Deleting Referrals</a></span></dt><dt><span class="section"><a href="#rest-api-authz-referrals-query">4.11.5. Listing Referrals</a></span></dt></dl></div><p>
   Referrals are represented in JSON. They
   use standard JSON objects and values
   (strings, numbers, objects, arrays, <code class="literal">true</code>,
   <code class="literal">false</code>, and <code class="literal">null</code>) as follows:
  </p><pre class="brush: javascript;">
   {
     "name": "MyReferral",
     "description": "Look for policies in two additional subrealms to protect HR pages",
     "resources": {
       "iPlanetAMWebAgentService" : [ "http://example.com/hr/*"]
     },
     "realms" : ["/MySubrealm", "/MySubrealm/ChildSubrealm"]
   }
  </pre><div class="variablelist"><p>
    The values for the fields shown in the example are explained below:
   </p><dl class="variablelist"><dt><span class="term"><code class="literal">"name"</code></span></dt><dd><p>
      String matching the name
      in the URL used when creating the referral by HTTP PUT
      or in the body when creating the referral by HTTP POST.
     </p></dd><dt><span class="term"><code class="literal">"description"</code></span></dt><dd><p>
      String describing the referral.
     </p></dd><dt><span class="term"><code class="literal">"resources"</code></span></dt><dd><p>
      The application and resource pattern strings
      to which the referral applies.
     </p></dd><dt><span class="term"><code class="literal">"realms"</code></span></dt><dd><p>
      One or more realms to search for policies that might protect
      the resource.
     </p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-referrals-create"></a>4.11.1.&nbsp;Creating Referrals</h3></div></div></div><p>
    To create a referral,
    either perform an HTTP PUT indicating the full path to the resource
    and the name in the resource matching the name in the path,
    or perform an HTTP POST with the name to use specified in the resource.
   </p><p lang="en">
  Do not use special characters within policy, application or referral names
  (for example, "my+referral") using the Policy Editor or REST endpoints as
  OpenAM returns a 400 Bad Request error.
  The special characters are: double quotes ("), plus sign (+), comma (,),
  less than (&lt;), equals (=), greater than (&gt;), backslash (\), and
  null (\u0000).
 </p><p>
    The HTTP PUT form includes the referral definition as the JSON resource data,
    with the header <code class="literal">Content-Type: application/json</code>
    and uses the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><p>
    The following example creates a referral named <code class="literal">MyReferral</code>
    in the top-level realm. The referral causes OpenAM policy evaluation to
    search for policies defined in the <code class="literal">/MySubrealm</code> and
    <code class="literal">/MySubrealm/ChildSubrealms</code> realms
    that have application type <code class="literal">iPlanetAMWebAgentService</code> and
    protect pages under <code class="literal">http://example.com/hr/</code>.
   </p><pre class="brush: plain;">
    $ curl \
    --request PUT \
    --header "iPlanetDirectoryPro: AQIC5w..." \
    --header "If-None-Match: *" \
    --header "Content-Type: application/json" \
    --data '{
      "name": "MyReferral",
      "description": "Look for policies in two additional subrealms to protect HR pages",
      "resources": {
        "iPlanetAMWebAgentService" : [ "http://example.com/hr/*"]
      },
      "realms" : ["/MySubrealm", "/MySubrealm/ChildSubrealm"]
    }' \
    https://openam.example.com:8443/openam/json/referrals/MyReferral
   
    {
     "creationDate" : 1416956012949,
     "lastModifiedDate" : 1416956012949,
     "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
     "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "resources" : {
       "iPlanetAMWebAgentService" : [ "http://example.com/hr/*" ]
     },
     "name" : "MyReferral"
    }
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>
    [,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p><p>
    The HTTP POST form includes the referral definition as the JSON resource data,
    with the header <code class="literal">Content-Type: application/json</code>
    and uses the <code class="literal">_action=create</code> operation.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
    $ curl \
    --request POST \
    --header "iPlanetDirectoryPro: AQIC5..." \
    --header "Content-Type: application/json" \
    --data '{
      "name": "MyReferralTwo",
      "description": "Look for policies in two additional subrealms to protect IT pages",
      "resources": {
        "iPlanetAMWebAgentService" : [ "http://example.com/it/*"]
      },
      "realms" : ["/MySubrealm", "/MySubrealm/ChildSubrealm"]
    }' \
    https://openam.example.com:8443/openam/json/referrals?_action=create
   
   
   {
     "creationDate" : 1416956884965,
     "lastModifiedDate" : 1416956884965,
     "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
     "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "resources" : {
       "iPlanetAMWebAgentService" : [ "http://example.com/it/*" ]
     },
     "name" : "MyReferralTwo"
   }
   
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-referrals-read"></a>4.11.2.&nbsp;Reading Referrals</h3></div></div></div><p>
    To read a referral definition, perform an HTTP GET
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
    $ curl \
    --header "iPlanetDirectoryPro: AQIC5..." \
    https://openam.example.com:8443/openam/json/referrals/MyReferral
   
   
   {
     "creationDate" : 1416956012949,
     "lastModifiedDate" : 1416956012949,
     "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
     "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "resources" : {
       "iPlanetAMWebAgentService" : [ "http://example.com/hr/*" ]
     },
     "name" : "MyReferral"
   }
   </pre><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>
    [,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-referrals-update"></a>4.11.3.&nbsp;Updating Referrals</h3></div></div></div><p>
    To update a referral, perform an HTTP PUT
    specifying the resource name
    with the referral definition as the JSON resource data,
    and with the header <code class="literal">Content-Type: application/json</code>.
    This is essentially the same as creating a referral,
    but without the <code class="literal">If-None-Match: *</code> header.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
    $ curl \
    --request PUT \
    --header "iPlanetDirectoryPro: AQIC5w..." \
    --header "Content-Type: application/json" \
    --data '{
      "name": "MyReferral",
      "description": "Update referral to protect HR US pages only",
      "resources": {
        "iPlanetAMWebAgentService" : [ "http://example.com/hr/us/*"]
      },
      "realms" : ["/MySubrealm", "/MySubrealm/ChildSubrealm"]
    }' \
    https://openam.example.com:8443/openam/json/referrals/MyReferral
   
   
   {
     "creationDate" : 1416959024216,
     "lastModifiedDate" : 1416959024216,
     "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
     "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
     "resources" : {
       "iPlanetAMWebAgentService" : [ "http://example.com/hr/us/*" ]
     },
     "name" : "MyReferral"
   }
   
   </pre><div class="tip"><h3 class="title">Tip</h3><p>You can rename a referral by sending a new value in the
    <span class="emphasis"><em>name</em></span> attribute of the JSON body,
    as shown below.</p><pre class="brush: plain;">
     $ curl \
     --request PUT \
     --header "iPlanetDirectoryPro: AQIC5w..." \
     --header "Content-Type: application/json" \
     --data '{
       "name": "MyReferralHRUS",
       "description": "Update referral to protect HR US pages only",
       "resources": {
         "iPlanetAMWebAgentService" : [ "http://example.com/hr/us/*"]
       },
       "realms" : ["/MySubrealm", "/MySubrealm/ChildSubrealm"]
     }' \
     https://openam.example.com:8443/openam/json/referrals/MyReferral
    
    
    {
      "creationDate" : 1416959240491,
      "lastModifiedDate" : 1416959240491,
      "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
      "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
      "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
      "resources" : {
        "iPlanetAMWebAgentService" : [ "http://example.com/hr/us/*" ]
      },
      "name" : "MyReferralHRUS"
    }
    </pre></div><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    and <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>
    [,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-referrals-delete"></a>4.11.4.&nbsp;Deleting Referrals</h3></div></div></div><p>
    To delete a referral, perform an HTTP DELETE
    specifying the resource name.
   </p><p>
    The <code class="literal">iPlanetDirectoryPro</code> header sets the SSO token
    for a user who has access to perform the operation.
   </p><pre class="brush: plain;">
    $ curl \
    --header "iPlanetDirectoryPro: AQIC5w..." \
    --request DELETE \
    https://openam.example.com:8443/openam/json/referrals/MyReferralHRUS
    {}
   </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-authz-referrals-query"></a>4.11.5.&nbsp;Listing Referrals</h3></div></div></div><p>
    To list referrals, perform an HTTP GET on the endpoint, setting
    the <code class="literal">_queryFilter</code> query string parameter.
   </p><pre class="brush: plain;">
    $ curl \
    --header "iPlanetDirectoryPro: AQIC5w..." \
    https://openam.example.com:8443/openam/json/referrals?_queryFilter=true
   
   
   {
     "result" : [ {
       "creationDate" : 1416956689230,
       "lastModifiedDate" : 1416956689230,
       "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
       "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
       "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
       "resources" : {
         "iPlanetAMWebAgentService" : [ "http://example.com/it/*" ]
       },
       "name" : "MyReferralOne"
       }, {
       "creationDate" : 1416956884965,
       "lastModifiedDate" : 1416956884965,
       "realms" : [ "/MySubrealm", "/MySubrealm/ChildSubrealm" ],
       "createdBy" : "id=amadmin,ou=user,dc=example,dc=com",
       "lastModifiedBy" : "id=amadmin,ou=user,dc=example,dc=com",
       "resources" : {
         "iPlanetAMWebAgentService" : [ "http://example.com/finance/*" ]
       },
       "name" : "MyReferralTwo"
     } ],
     "resultCount" : 2,
     "pagedResultsCookie" : null,
     "remainingPagedResults" : 2
   }
   
   </pre><p>
    The <code class="literal">_queryFilter</code> parameter can take
    <code class="literal">true</code> to match every referral,
    <code class="literal">false</code> to match no referrals,
    or a filter of the following form to match field values:
    <code class="literal"><em class="replaceable"><code>field</code></em> <em class="replaceable"><code>operator</code></em> <em class="replaceable"><code>value</code></em></code>
    where <em class="replaceable"><code>field</code></em> represents the field name,
    <em class="replaceable"><code>operator</code></em> is the operator code,
    <em class="replaceable"><code>value</code></em> is the value to match,
    and the entire filter is URL-encoded.
    Supported operators are as follows:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">eq</code>: equals
     </p></li><li class="listitem"><p>
      <code class="literal">ge</code>: greater than or equal to
     </p></li><li class="listitem"><p>
      <code class="literal">gt</code>: greater than
     </p></li><li class="listitem"><p>
      <code class="literal">le</code>: less than or equal to
     </p></li><li class="listitem"><p>
      <code class="literal">lt</code>: less than
     </p></li></ul></div><div class="itemizedlist"><p>
     The <code class="literal"><em class="replaceable"><code>field</code></em></code> value
     can take the following values:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <code class="literal">"name"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"description"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"applicationName"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"createdBy"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModifiedBy"</code> (string equality only)
     </p></li><li class="listitem"><p>
      <code class="literal">"creationDate"</code> (all comparisons are supported;
      the date is either an
      <a class="link" href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a>
      string, or a integer number of seconds from the UNIX epoch)
     </p></li><li class="listitem"><p>
      <code class="literal">"lastModified"</code> (all comparisons are supported;
      the date is either an
      <a class="link" href="http://www.w3.org/TR/NOTE-datetime" target="_blank">ISO-8601</a>
      string, or a integer number of seconds from the UNIX epoch)
     </p></li></ul></div><p>
    Filters can be composed of multiple expressions
    by a using boolean operator
    <code class="literal">AND</code>,
    
    and by using parentheses,
    <code class="literal">(<em class="replaceable"><code>expression</code></em>)</code>,
    to group expressions.
    You must URL encode the filter expression
    in <code class="literal">_queryFilter=<em class="replaceable"><code>filter</code></em></code>.
   </p><p>
    You can use the query string parameters
    <code class="literal">_prettyPrint=true</code> to make the output easier to read,
    <code class="literal">_fields=<em class="replaceable"><code>field-name</code></em>[,<em class="replaceable"><code>field-name</code></em>...]</code>
    to limit the fields returned in the output.
   </p><p>
    You can use <code class="literal">_pageSize=<em class="replaceable"><code>integer</code></em></code>
    to limit the number of results returned.
   </p><p>
    You can use <code class="literal">_sortKeys=[+-]<em class="replaceable"><code>field</code></em>[,<em class="replaceable"><code>field</code></em>...]</code>
    to sort the results returned,
    where <em class="replaceable"><code>field</code></em> represents a field
    in the JSON referral objects returned.
    Optionally use the <code class="literal">+</code> prefix to sort in ascending order
    (the default),
    or <code class="literal">-</code> to sort in descending order.
    The following example sorts the referrals by their names in descending order.
   </p><pre class="brush: plain;">
    $ curl \
    --header "iPlanetDirectoryPro: AQIC5w..." \
    https://openam.example.com:8443/openam/json/referrals?_queryFilter=true\&amp;_sortKeys=-name
    
    {
      "result" : [ {
        "name" : "MyReferralTwo"
       }, {
         "name" : "MyReferralOne"
       } ],
       "resultCount" : 2,
       "pagedResultsCookie" : null,
       "remainingPagedResults" : 2
     }
    
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-authz-legacy"></a>4.12.&nbsp;Authorization (Legacy API)</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-policy-decisions">4.12.1. Requesting Policy Decisions (Legacy API)</a></span></dt></dl></div><p>You can call on OpenAM to decide whether to authorize access to a
   protected resource based on a valid token. Of course, you must percent
   encode the resource URI.
  </p><p>Interface Stability:
   <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a>
  </p><pre class="brush: plain;">
$ curl "https://openam.example.com:8443/openam/identity/authorize?\
uri=http%3A%2F%2Fwww.example.com%3A8080%2Fexamples%2Findex.html\
&amp;subjectid=AQIC5wM2LY4SfcxuxIP0VnP2lVjs7ypEM6VDx6srk56CN1Q.*AAJTSQACMDE.*"
boolean=true
  </pre><p>
   To indicate access denied, OpenAM returns
   <code class="literal">boolean=false</code>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-policy-decisions"></a>4.12.1.&nbsp;Requesting Policy Decisions (Legacy API)</h3></div></div></div><p>OpenAM provides additional REST APIs for requesting policy
    decisions.
   </p><div class="itemizedlist"><p>The policy decision interfaces use the following path suffixes and
     query string parameters.
    </p><p>
     Path suffixes for policy decision requests include the following:
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">ws/1/entitlement/decision</code>. Request a decision
      pertaining to a single resource.</p></li><li class="listitem"><p><code class="literal">ws/1/entitlement/decisions</code>. Request decisions
     pertaining to multiple resources.</p></li><li class="listitem"><p>
      <code class="literal">ws/1/entitlement/entitlement</code>. Request decisions
      for a specified resource URL.
     </p></li><li class="listitem"><p>
      <code class="literal">ws/1/entitlement/entitlements</code>. Request decisions
      for a specified resource URL and all resources underneath.
     </p></li></ul></div><div class="itemizedlist"><p>
     Query string parameters for policy decision requests include the
     following.
    </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">subject=<em class="replaceable"><code>encoded-token</code></em></code>,
      where the token is encoded using the method implemented in
      <a class="link" href="http://sources.forgerock.org/browse/~raw,r=6/openam/trunk/opensso/www/public/use/docs/fampdf/Encoder.java" target="_blank"><code class="filename">Encoder.java</code></a>.
     </p><p>
      In the examples for this section, the token ID obtained during
      authentication for <code class="literal">amadmin</code> is abbreviated as
      <code class="literal">AQIC5...DU3*</code> and the encoded token ID for the subject
      is <code class="literal">MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=</code>.
     </p></li><li class="listitem"><p>
      <code class="literal">action=get</code>, or <code class="literal">action=post</code>,
      which identifies the user agent action when requesting a decision.
     </p></li><li class="listitem"><p>
      <code class="literal">application=iPlanetAMWebAgentService</code>
      or <code class="literal">application=crestPolicyService</code>
     </p></li><li class="listitem"><p>
      <code class="literal">resource=<em class="replaceable"><code>resource-url</code></em></code>,
     or multiple <code class="literal">resources=<em class="replaceable"><code>resource-url</code></em></code>
     parameters for multiple decisions.
     </p></li><li class="listitem"><p>
      <code class="literal">env=<em class="replaceable"><code>requestDnsName%3Dfqdn</code></em></code>,
      <code class="literal">env=<em class="replaceable"><code>requestIP%3Ddotted-quads</code></em></code>,
      <code class="literal">env=<em class="replaceable"><code>requestTime%3Dseconds-since-epoch</code></em></code>,
      and <code class="literal">env=<em class="replaceable"><code>requestDnsName%3Dtime-zone</code></em></code>
      where <em class="replaceable"><code>time-zone</code></em> is from Java
      <code class="literal">TimeZone.getTimeZone().getID()</code>. The
      <code class="literal">env</code> parameters thus express conditions.
     </p><p>
      In order to express a condition that specifies OAuth 2.0 scopes,
      set the value of the parameter
      to <code class="literal">scope=<em class="replaceable"><code>scopes</code></em></code>.
      To set scopes to <code class="literal">openid</code> and <code class="literal">profile</code>,
      use <code class="literal">env=scope%3Dopenid%20profile</code> for example.
  &nbsp;&nbsp; </p></li></ul></div><p>
    Authentication for these interfaces uses cookies, so if your
    application is not running in a browser, first authenticate as described in
    <a href="../dev-guide/index.html#rest-api-auth-json" class="link">REST APIs for Authentication &amp; Logout</a>.
   </p><p>
    To request a decision for a single resource, use an HTTP GET on
    <code class="literal">/ws/1/entitlement/decision</code> as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 "https://openam.example.com:8443/openam/ws/1/entitlement/decision\
?subject=MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=&amp;action=GET\
&amp;application=iPlanetAMWebAgentService\
&amp;resource=http%3A%2F%2Fwww.example.com%2Findex.html"
allow
   </pre><p>
    If access is denied, the result is <code class="literal">deny</code>.
   </p><p>
    To request decisions for multiple resources, use an HTTP GET on
     <code class="literal">/ws/1/entitlement/decisions</code> as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 "https://openam.example.com:8443/openam/ws/1/entitlement/decisions\
?subject=MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=&amp;action=GET\
&amp;application=iPlanetAMWebAgentService\
&amp;resources=http%3A%2F%2Fwww.example.com%2Findex.html\
&amp;resources=http%3A%2F%2Fwww.example.com%2Ffavicon.ico"
{
    "statusCode": 200,
    "body": {
        "results": [
            {
                "actionsValues": {
                    "POST": true,
                    "GET": true
                },
                "attributes": {},
                "advices": {},
                "resourceName": "http://www.example.com:80/index.html"
            },
            {
                "actionsValues": {
                    "POST": true,
                    "GET": true
                },
                "attributes": {},
                "advices": {},
                "resourceName": "http://www.example.com:80/favicon.ico"
            }
        ]
    },
    "statusMessage": "OK"
}
   </pre><p>
    To request decisions for a given resource,
    use an HTTP GET on <code class="literal">/ws/1/entitlement/entitlement</code>
    as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 "https://openam.example.com:8443/openam/ws/1/entitlement/entitlement\
?subject=MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=\
&amp;application=iPlanetAMWebAgentService\
&amp;resource=http%3A%2F%2Fwww.example.com%2F*"
{
    "statusCode": 200,
    "body": {
        "actionsValues": {
            "POST": true,
            "GET": true
        },
        "attributes": {},
        "advices": {},
        "resourceName": "http://www.example.com:80/*"
    },
    "statusMessage": "OK"
}
   </pre><p>
    To request decisions for all resources underneath a given resource,
    use an HTTP GET on <code class="literal">/ws/1/entitlement/entitlements</code>
    as in the following example:
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 "https://openam.example.com:8443/openam/ws/1/entitlement/entitlements\
?subject=MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=\
&amp;application=iPlanetAMWebAgentService\
&amp;resource=http%3A%2F%2Fwww.example.com%2F"
{
    "statusCode": 200,
    "body": {
        "results": [
            {
                "actionsValues": {},
                "resourceName": "http://www.example.com:80/"
            },
            {
                "actionsValues": {
                    "POST": true,
                    "GET": true
                },
                "advices": {},
                "resourceName": "http://www.example.com:80/*"
            },
            {
                "actionsValues": {
                    "POST": true,
                    "GET": true
                },
                "attributes": {},
                "advices": {},
                "resourceName": "http://www.example.com:80/*?*"
            }
        ]
    },
    "statusMessage": "OK"
}
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management"></a>4.13.&nbsp;Managing Policies (Legacy API)</h2></div></div></div><p>
   OpenAM exposes a REST API through the
   <code class="literal">/ws/1/entitlement/privilege</code> endpoint under the
   deployment URI. The API lets you create, read, update, delete, and query
   policies.
  </p><p>
   Authentication for these interfaces uses cookies, so if your
   application is not running in a browser, first authenticate as described in
   <a href="../dev-guide/index.html#rest-api-auth-json" class="link">REST APIs for Authentication &amp; Logout</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management-create"></a>4.14.&nbsp;Creating Policies (Legacy API)</h2></div></div></div><p>
    You create a policy by using an HTTP POST of the JSON representation
    to the endpoint. You must URL encode the JSON before passing it to
    OpenAM.
   </p><pre class="brush: plain;">
$ cat entitlement.json
{
    "name": "Example HTTP",
    "eSubject": {
        "state": {
            "className": "com.sun.identity.policy.plugins.AuthenticatedUsers",
            "exclusive": false,
            "name": "All Authenticated Users",
            "values": []
        },
        "className": "com.sun.identity.entitlement.opensso.PolicySubject"
    },
    "entitlement": {
        "actionsValues": {
            "POST": true,
            "GET": true
        },
        "applicationName": "iPlanetAMWebAgentService",
        "name": "authorize",
        "resourceNames": [
            "http://www.example.com:80/*"
        ]
    }
}
$ curl \
 --request POST \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 --data-urlencode "privilege.json@entitlement.json" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege
{"statusCode":201,"body":"Created","statusMessage":"Created"}

$ cat entitlement2.json
{
    "name": "Example HTTPS",
    "eSubject": {
        "state": {
            "className": "com.sun.identity.policy.plugins.AuthenticatedUsers",
            "exclusive": false,
            "name": "All Authenticated Users",
            "values": []
        },
        "className": "com.sun.identity.entitlement.opensso.PolicySubject"
    },
    "entitlement": {
        "actionsValues": {
            "POST": false,
            "GET": true
        },
        "applicationName": "iPlanetAMWebAgentService",
        "name": "authorize",
        "resourceNames": [
            "https://www.example.com:443/*?*"
        ]
    }
}

$ curl \
 --request POST \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 --data-urlencode "privilege.json@entitlement2.json" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege
{"statusCode":201,"body":"Created","statusMessage":"Created"}
   </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management-read"></a>4.15.&nbsp;Reading Policies (Legacy API)</h2></div></div></div><p>
    To read a policy, use an HTTP GET on the endpoint followed by
    the URL-encoded name of the policy.
   </p><p>
    Notice that the "state" is returned as a long string, and so is not
    shown here in full.
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege/Example%20HTTP
{
    "statusCode": 200,
    "body": {
        "results": {
            "name": "Example HTTP",
            "eSubject": {
                "state": "{\n  \"className\": \"com.sun.identity.policy...}",
                "className": "com.sun.identity.entitlement.opensso.PolicySubject"
            },
            "entitlement": {
                "actionsValues": {
                    "POST": true,
                    "GET": true
                },
                "applicationName": "iPlanetAMWebAgentService",
                "name": "authorize",
                "resourceNames": [
                    "http://www.example.com:80/*"
                ]
            }
        }
    },
    "statusMessage": "OK"
}

$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege/Example%20HTTPS
{
    "statusCode": 200,
    "body": {
        "results": {
            "name": "Example HTTPS",
            "eSubject": {
                "state": "{\n  \"className\": \"com.sun.identity.policy...}",
                "className": "com.sun.identity.entitlement.opensso.PolicySubject"
            },
            "entitlement": {
                "actionsValues": {
                    "POST": false,
                    "GET": true
                },
                "applicationName": "iPlanetAMWebAgentService",
                "name": "authorize",
                "resourceNames": [
                    "https://www.example.com:443/*?*"
                ]
            }
        }
    },
    "statusMessage": "OK"
}
   </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management-update"></a>4.16.&nbsp;Updating Policies (Legacy API)</h2></div></div></div><p>
    To update a policy, use an HTTP PUT on the endpoint followed by the
    URL-encoded name of the policy.
   </p><pre class="brush: plain;">
$ cat update.json
{
    "name": "Example HTTP",
    "eSubject": {
        "state": {
            "className": "com.sun.identity.policy.plugins.AuthenticatedUsers",
            "exclusive": false,
            "name": "All Authenticated Users",
            "values": []
        },
        "className": "com.sun.identity.entitlement.opensso.PolicySubject"
    },
    "entitlement": {
        "actionsValues": {
            "POST": false,
            "GET": true
        },
        "applicationName": "iPlanetAMWebAgentService",
        "name": "authorize",
        "resourceNames": [
            "http://www.example.com:80/*?*"
        ]
    }
}

$ curl \
 --request PUT \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 --data-urlencode "privilege.json@update.json" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege/Example%20HTTP
{"statusCode":200,"body":"OK","statusMessage":"OK"}
   </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management-delete"></a>4.17.&nbsp;Deleting Policies (Legacy API)</h2></div></div></div><p>
    To delete a policy, use an HTTP DELETE on the endpoint followed by
    the URL-encoded name of the policy.
   </p><pre class="brush: plain;">
$ curl \
 --request DELETE \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege/Example%20HTTPS
{"statusCode":200,"body":"OK","statusMessage":"OK"}
   </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-policy-management-query"></a>4.18.&nbsp;Querying Policies (Legacy API)</h2></div></div></div><p>
    To get the names of policies, use an HTTP GET on the endpoint.
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 https://openam.example.com:8443/openam/ws/1/entitlement/privilege
{
    "statusCode": 200,
    "body": {
        "results": [
            "Example HTTPS",
            "Example HTTP"
        ]
    },
    "statusMessage": "OK"
}
   </pre><p>
    You can pass a filter query parameter to get only policies
    that match the filter. Make sure you URL encode the filter value.
   </p><pre class="brush: plain;">
$ curl \
 --request GET \
 --cookie "iPlanetDirectoryPro=AQIC5...DU3*" \
 "https://openam.example.com:8443/openam/ws/1/entitlement/privilege\
?subject=MJ3QFTr4ZV2QrtlJvXlg0Q2dMRM=&amp;filter=name%3D*HTTP"
{
    "statusCode": 200,
    "body": {
        "results": [
            "Example HTTP"
        ]
    },
    "statusMessage": "OK"
}
   </pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest-oauth2-oidc"></a>Chapter&nbsp;5.&nbsp;RESTful OAuth 2.0 and OpenID Connect 1.0 Services</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#rest-api-oauth2">5.1. OAuth 2.0 Authorization</a></span></dt><dt><span class="section"><a href="#rest-api-openid-connect">5.2. OpenID Connect 1.0</a></span></dt></dl></div><a class="indexterm" name="d13846e5504"></a><p>This chapter shows how to use the OpenAM RESTful interfaces for OAuth 2.0
  and OpenID Connect 1.0.</p><p>In this chapter, long URLs are wrapped to fit the printed page, as some
  of the output is formatted for easier reading.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-oauth2"></a>5.1.&nbsp;OAuth 2.0 Authorization</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-oauth2-client-endpoints">5.1.1. OAuth 2.0 Client &amp; Resource Server Endpoints</a></span></dt><dt><span class="section"><a href="#rest-api-oauth2-token-admin-endpoint">5.1.2. OAuth 2.0 Token Administration Endpoint</a></span></dt><dt><span class="section"><a href="#rest-api-oauth2-client-admin-endpoint">5.1.3. OAuth 2.0 Client Administration Endpoint</a></span></dt></dl></div><a class="indexterm" name="d13846e5514"></a><div class="itemizedlist"><p>OpenAM exposes the following REST endpoints for different OAuth 2.0
   purposes.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Endpoints for <a class="link" href="#rest-api-oauth2-client-endpoints" title="5.1.1.&nbsp;OAuth 2.0 Client &amp; Resource Server Endpoints">OAuth
    2.0 clients and resource servers</a>, mostly defined in RFC 6749,
    <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank"><em class="citetitle">The OAuth 2.0 Authorization Framework</em></a>, with
    an additional <code class="literal">tokeninfo</code> endpoint useful to resource
    servers.</p></li><li class="listitem"><p>An endpoint for <a class="link" href="#rest-api-oauth2-token-admin-endpoint" title="5.1.2.&nbsp;OAuth 2.0 Token Administration Endpoint">OAuth 2.0 token administration</a>. This is specific to OpenAM.</p></li><li class="listitem"><p>An endpoint for <a class="link" href="#rest-api-oauth2-client-admin-endpoint" title="5.1.3.&nbsp;OAuth 2.0 Client Administration Endpoint">OAuth 2.0 client administration</a>. This is specific to OpenAM.</p></li></ul></div><p>When accessing the APIs, browser-based REST clients can rely on OpenAM
  to handle the session as usual. First authenticate with OpenAM. Then perform
  the operations in the browser session.</p><p>Clients not running in a browser can authenticate as described in
   <a href="../dev-guide/index.html#rest-api-auth" class="link">
     <em class="citetitle">Authorization &amp; Policy Management</em></a>, whereby
   OpenAM returns a
   <code class="literal">token.id</code> value. Clients pass the
   <code class="literal">token.id</code> value in a header named after the
   authentication cookie, by default <code class="literal">iplanetDirectoryPro</code>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-oauth2-client-endpoints"></a>5.1.1.&nbsp;OAuth 2.0 Client &amp; Resource Server Endpoints</h3></div></div></div><p>As described in the <em class="citetitle">Administration Guide</em> chapter
   on <a href="../admin-guide/index.html#chap-oauth2" class="link"><em class="citetitle">Managing OAuth
   2.0 Authorization</em></a>, OpenAM exposes REST endpoints for
   making calls to OpenAM acting as an authorization server.</p><div lang="en" class="variablelist"><p>In addition to the standard authorization and token endpoints
 described in RFC 6749, OpenAM also exposes a token information endpoint
 for resource servers to get information about access tokens so they can
 determine how to respond to requests for protected resources. OpenAM as
 authorization server exposes the following endpoints for clients and
 resource servers.</p><dl class="variablelist"><dt><span class="term"><code class="literal">/oauth2/authorize</code></span></dt><dd><p>Authorization endpoint defined in RFC 6749, used to obtain an
   authorization grant from the resource owner</p><p>Example: <code class="literal">https://openam.example.com:8443/openam/oauth2/authorize</code></p></dd><dt><span class="term"><code class="literal">/oauth2/access_token</code></span></dt><dd><p>Token endpoint defined in RFC 6749, used to obtain an access token
   from the authorization server</p><p>Example: <code class="literal">https://openam.example.com:8443/openam/oauth2/access_token</code></p></dd><dt><span class="term"><code class="literal">/oauth2/tokeninfo</code></span></dt><dd><p>Endpoint not defined in RFC 6749, used to validate tokens, and to
   retrieve information such as scopes</p><p>Given an access token, a resource server can perform an HTTP GET on
   <code class="literal">/oauth2/tokeninfo?access_token=<em class="replaceable"><code>token-id</code></em></code>
   to retrieve a JSON object indicating <code class="literal">token_type</code>,
   <code class="literal">expires_in</code>, <code class="literal">scope</code>, and the
   <code class="literal">access_token</code> ID.</p><p>Example: <code class="literal">https://openam.example.com:8443/openam/oauth2/tokeninfo</code></p></dd></dl></div><p>The <code class="literal">/oauth2/authorize</code>, and
   <code class="literal">/oauth2/access_token</code> endpoints function as described
   in RFC 6749.</p><p>The <code class="literal">/oauth2/authorize</code> endpoint is protected by the
   policy created during OAuth 2.0 authorization server configuration, which
   grants all authenticated users access.</p><p>The <code class="literal">/oauth2/tokeninfo</code> endpoint takes an HTTP GET
   on <code class="literal">/oauth2/tokeninfo?access_token=<em class="replaceable"><code>token-id</code></em></code>, and returns information about the
   token.</p><p>Resource servers &#8212; or any party having the token ID &#8212; can
   get token information through this endpoint without authenticating. This
   means any application or user can validate the token without having to be
   registered with OpenAM.</p><p>The following example shows OpenAM issuing an access token, and
   then returning token information:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --user "myClientID:password" \
 --data "grant_type=password&amp;username=demo&amp;password=changeit&amp;scope=cn%20mail" \
 https://openam.example.com:8443/openam/oauth2/access_token</strong>
<em>{
    "expires_in": 599,
    "token_type": "Bearer",
    "refresh_token": "f6dcf133-f00b-4943-a8d4-ee939fc1bf29",
    "access_token": "f9063e26-3a29-41ec-86de-1d0d68aa85e9"
}</em>

$ <strong>curl https://openam.example.com:8443/openam/oauth2/tokeninfo\
?access_token=f9063e26-3a29-41ec-86de-1d0d68aa85e9</strong>
<em>{
    "mail": "demo@example.com",
    "scope": [
        "mail",
        "cn"
    ],
    "cn": "demo",
    "realm": "/",
    "token_type": "Bearer",
    "expires_in": 577,
    "access_token": "f9063e26-3a29-41ec-86de-1d0d68aa85e9"
}</em>
   </pre></div><p>The resource server making decisions about whether the token is valid
   can thus use the <code class="literal">/oauth2/tokeninfo</code> endpoint to retrieve
   expiration information about the token. Depending on the scopes
   implementation, the JSON response about the token can also contain scope
   information. As described in the <em class="citetitle">Administration Guide</em>,
   the default scopes implementation in OpenAM considers scopes to be names of
   attributes in the resource owner's user profile. Notice that the JSON
   response contains the values for those attributes from the user's profile,
   as in the preceding example, with scopes set to <code class="literal">mail</code> and
   <code class="literal">cn</code>.</p><p>
    Both the <code class="literal">/oauth2/authorize</code> and
    <code class="literal">/oauth2/access_token</code> endpoints
    can take additional parameters.
    In particular you must specify the realm using
    the <code class="literal">realm=<em class="replaceable"><code>realm-name</code></em></code> parameter
    if the OpenAM OAuth 2.0 provider is configured for a subrealm
    rather than / (Top-Level Realm).
    For example, if the OAuth 2.0 provider is configured
    for the <code class="literal">/customers</code> realm,
    then use <code class="literal">/oauth2/authorize?realm=/customers</code>
    and <code class="literal">/oauth2/access_token?realm=/customers</code>.
    The realm can be passed either as a URL query string parameter as shown here,
    or as parameters in the POST data.
   </p><p>The <code class="literal">/oauth2/authorize</code> endpoint can also take
   <code class="literal">module</code> and <code class="literal">service</code> parameters. Use
   either as described in <a href="../admin-guide/index.html#authn-from-browser" class="link"><em class="citetitle">Authenticating
   To OpenAM</em></a>, where <code class="literal">module</code> specifies the
   authentication module instance to use or <code class="literal">service</code>
   specifies the authentication chain to use when authenticating the resource
   owner.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-oauth2-token-admin-endpoint"></a>5.1.2.&nbsp;OAuth 2.0 Token Administration Endpoint</h3></div></div></div><p>The OpenAM-specific OAuth 2.0 token administration endpoint lets
   administrators read, list, and delete OAuth 2.0 tokens. OAuth 2.0 clients
   can also manage their own tokens.</p><p>OpenAM exposes the token administration endpoint at
   <code class="literal">/frrest/oauth2/token</code>, such as
   <code class="literal">https://openam.example.com:8443/openam/frrest/oauth2/token</code>.</p><div class="note"><h3 class="title">Note</h3><p>This endpoint location is likely to change in the future.</p></div><p>To get a token, perform an HTTP GET on
   <code class="literal">/frrest/oauth2/token/<em class="replaceable"><code>token-id</code></em></code>,
   as in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --user "myClientID:password" \
 --data "grant_type=password&amp;username=demo&amp;password=changeit&amp;scope=cn" \
 https://openam.example.com:8443/openam/oauth2/access_token</strong>
<em>{
    "scope": "cn",
    "expires_in": 60,
    "token_type": "Bearer",
    "access_token": "f5fb4833-ba3d-41c8-bba4-833b49c3fe2c"
}</em>

$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5wM2LY4Sfcxs...EwNDU2NjE0*" \
 https://openam.example.com:8443/openam/frrest/oauth2/token/9c6a48fc...fba468b0f</strong>
<em>{
    "expireTime": [
        "1418818601396"
    ],
    "tokenName": [
        "access_token"
    ],
    "scope": [
        "cn"
    ],
    "grant_type": [
        "password"
    ],
    "clientID": [
        "myClientID"
    ],
    "parent": [],
    "id": [
        "f5fb4833-ba3d-41c8-bba4-833b49c3fe2c"
    ],
    "tokenType": [
        "Bearer"
    ],
    "redirectURI": [],
    "nonce": [],
    "realm": [
        "/"
    ],
    "userName": [
        "demo"
    ]
}</em>
   </pre></div><p>
    To list tokens, perform an HTTP GET on
    <code class="literal">/frrest/oauth2/token/?_queryId=<em class="replaceable"><code>string</code></em></code>,
    where <em class="replaceable"><code>string</code></em> is
    either <code class="literal">access_token</code> to request the list of access tokens
    for the current user or all users if requested by <code class="literal">amAdmin</code>,
    or any other string to request the list of access tokens and refresh tokens.
   </p><p>
    The following example shows a search for the demo user's access tokens.
   </p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5wM2LY4Sfcw..." \
 https://openam.example.com:8443/openam/frrest/oauth2/token/?_queryId=access_token</strong>
<em>{
    "result": [
        {
            "expireTime": "Dec 17, 2014 1:02 PM",
            "tokenName": [
                "access_token"
            ],
            "scope": [
                "cn"
            ],
            "grant_type": [
                "password"
            ],
            "clientID": [
                "myClientID"
            ],
            "parent": [],
            "id": [
                "d2bbd4f9-955f-4683-bb83-bc0d7523b0f9"
            ],
            "tokenType": [
                "Bearer"
            ],
            "redirectURI": [],
            "nonce": [],
            "realm": [
                "/"
            ],
            "userName": [
                "demo"
            ],
            "display_name": "",
            "scopes": "cn"
        },
        {
            "expireTime": "Dec 17, 2014 1:02 PM",
            "tokenName": [
                "access_token"
            ],
            "scope": [
                "cn"
            ],
            "grant_type": [
                "password"
            ],
            "clientID": [
                "myClientID"
            ],
            "parent": [],
            "id": [
                "12f9907f-dbfb-4c4c-a231-2b24964fee8b"
            ],
            "tokenType": [
                "Bearer"
            ],
            "redirectURI": [],
            "nonce": [],
            "realm": [
                "/"
            ],
            "userName": [
                "demo"
            ],
            "display_name": "",
            "scopes": "cn"
        }
    ],
    "resultCount": 2,
    "pagedResultsCookie": null,
    "remainingPagedResults": -1
}</em>
   </pre></div><p>To delete a token, perform an HTTP DELETE on
   <code class="literal">/frrest/oauth2/token/<em class="replaceable"><code>token-id</code></em></code>,
   as in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "grant_type=client_credentials&amp;username=demo&amp;password=changeit\
&amp;client_id=myClientID&amp;client_secret=password&amp;scope=cn%20mail" \
 https://openam.example.com:8443/openam/oauth2/access_token</strong>
<em>{
    "expires_in": 599,
    "token_type": "Bearer",
    "access_token": "867aaab2-61d7-4b78-9b80-4f9098034540"
}</em>

$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5wM2LY4Sfcxs...EwNDU2NjE0*" \
 https://openam.example.com:8443/openam/frrest/oauth2/token/867aaab2..098034540</strong>
<em>{
    "success": "true"
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-oauth2-client-admin-endpoint"></a>5.1.3.&nbsp;OAuth 2.0 Client Administration Endpoint</h3></div></div></div><p>The OAuth 2.0 administration endpoint lets OpenAM administrators and
   agent administrators create (that is, register) and delete OAuth 2.0
   clients.</p><p>OpenAM exposes this endpoint at <code class="literal">/frrest/oauth2/client</code>,
   such as
   <code class="literal">https://openam.example.com:8443/openam/frrest/oauth2/client</code>.</p><div class="note"><h3 class="title">Note</h3><p>This endpoint location is likely to change in the future.</p></div><p>To create an OAuth 2.0 client, perform an HTTP POST to
   <code class="literal">/frrest/oauth2/client/?_action=create</code>
   with a JSON object fully specifying the client, as in the following
   example.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iplanetDirectoryPro: AQIC5wM...3MTYxOA..*" \
 --header "Content-Type: application/json" \
 --data \
 '{"client_id":["testClient"],
   "realm":["/"],
   "userpassword":["secret12"],
   "com.forgerock.openam.oauth2provider.clientType":["Confidential"],
   "com.forgerock.openam.oauth2provider.redirectionURIs":
     ["www.client.com","www.example.com"],
   "com.forgerock.openam.oauth2provider.scopes":["cn","sn"],
   "com.forgerock.openam.oauth2provider.defaultScopes":["cn"],
   "com.forgerock.openam.oauth2provider.name":["My Test Client"],
   "com.forgerock.openam.oauth2provider.description":["OAuth 2.0 Client"]
  }' \
 https://openam.example.com:8443/openam/frrest/oauth2/client/?_action=create</strong>
<em>{"success":"true"}</em>
   </pre></div><div class="variablelist"><p>When creating an OAuth 2.0 client, use the following fields in your
    JSON object.</p><dl class="variablelist"><dt><span class="term"><code class="literal">"client_id"</code></span></dt><dd><p>(Required) This field takes an array containing the client
      identifier as defined in RFC 6749.</p></dd><dt><span class="term"><code class="literal">"realm"</code></span></dt><dd><p>(Required) This field takes an array containing the OpenAM realm
      in which to create the client as defined in RFC 6749.</p></dd><dt><span class="term"><code class="literal">"userpassword"</code></span></dt><dd><p>(Required) This field takes an array containing the client
      secret as defined in RFC 6749.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.clientType"</code></span></dt><dd><p>(Required) This field takes an array containing the client
      type, either <code class="literal">"Confidential"</code> or
      <code class="literal">"Public"</code> as defined in RFC 6749.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.redirectionURIs"</code></span></dt><dd><p>(Optional for confidential clients) This field takes an array of
      client redirection endpoints as defined in RFC 6749.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.scopes"</code></span></dt><dd><p>(Optional) This field takes an array of scopes as defined in RFC
      6749. The default scopes implementation takes scopes to be names of
      attributes in the resource owner profile.</p><p>Specify localized scopes in <code class="literal"><em class="replaceable"><code>scope</code></em>|<em class="replaceable"><code>locale</code></em>|<em class="replaceable"><code>localized description</code></em></code> format.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.defaultScopes"</code></span></dt><dd><p>(Optional) This field takes an array of default scopes set
      automatically when tokens are issued.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.name"</code></span></dt><dd><p>(Optional) This field takes an array containing the client name to
      display to the resource owner when the resource owner must authorize
      client access to protected resources.</p><p>Specify localized names in <code class="literal"><em class="replaceable"><code>locale</code></em>|<em class="replaceable"><code>localized name</code></em></code>
      format.</p></dd><dt><span class="term"><code class="literal">"com.forgerock.openam.oauth2provider.description"</code></span></dt><dd><p>(Optional) This field takes an array containing the description to
      display to the resource owner when the resource owner must authorize
      client access to protected resources.</p><p>Specify localized descriptions in <code class="literal"><em class="replaceable"><code>locale</code></em>|<em class="replaceable"><code>localized description</code></em></code>
      format.</p></dd></dl></div><p>To delete an OAuth 2.0 client, perform an HTTP DELETE on
   <code class="literal">/frrest/oauth2/client/<em class="replaceable"><code>client-id</code></em></code>,
   as in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5wM...3MTYxOA..*" \
 https://openam.example.com:8443/openam/frrest/oauth2/client/myClient</strong>
<em>{"success":"true"}</em>
   </pre></div><div class="tip"><h3 class="title">Tip</h3><p>To delete an OAuth 2.0 client from a subrealm, add the name of the
    subrealm in a query parameter named <code class="literal">realm</code>, as
    in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5wM...3MTYxOA..*" \
 https://openam.example.com:8443/openam/frrest/oauth2/client/myClient?realm=myRealm</strong>
<em>{"success":"true"}</em></pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-openid-connect"></a>5.2.&nbsp;OpenID Connect 1.0</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-openid-connect-discovery">5.2.1. Discovering OpenID Connect 1.0 Configuration</a></span></dt><dt><span class="section"><a href="#rest-api-openid-connect-dynamic-registration">5.2.2. Registering OpenID Connect 1.0 Clients</a></span></dt><dt><span class="section"><a href="#rest-api-openid-connect-authorization">5.2.3. Performing OpenID Connect 1.0 Client Authorization</a></span></dt><dt><span class="section"><a href="#rest-api-openid-connect-session">5.2.4. Managing OpenID Connect 1.0 Sessions</a></span></dt></dl></div><a class="indexterm" name="d13846e5979"></a><p>OpenID Connect 1.0 extends OAuth 2.0 so the client can verify claims
  about the identity of the end user, get profile information about the end
  user, and log the user out at the end of the OpenAM session.</p><div class="itemizedlist"><p>OpenAM exposes the following REST endpoints for <a class="link" href="http://openid.net/connect/" target="_blank">OpenID Connect 1.0</a>
   purposes.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Endpoints for <a class="link" href="#rest-api-openid-connect-discovery" title="5.2.1.&nbsp;Discovering OpenID Connect 1.0 Configuration">discovering information</a>.</p></li><li class="listitem"><p>An endpoint for <a class="link" href="#rest-api-openid-connect-dynamic-registration" title="5.2.2.&nbsp;Registering OpenID Connect 1.0 Clients">registering client applications</a>.</p></li><li class="listitem"><p>Endpoints for <a class="link" href="#rest-api-openid-connect-authorization" title="5.2.3.&nbsp;Performing OpenID Connect 1.0 Client Authorization">client authorization</a>.</p></li><li class="listitem"><p>Endpoints for <a class="link" href="#rest-api-openid-connect-session" title="5.2.4.&nbsp;Managing OpenID Connect 1.0 Sessions">session management</a>.</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-openid-connect-discovery"></a>5.2.1.&nbsp;Discovering OpenID Connect 1.0 Configuration</h3></div></div></div><p>OpenAM exposes endpoints for discovering information about the provider
   configuration, and about the provider for a given end user.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">/.well-known/openid-configuration</code> allows clients
     to retrieve OpenID Provider configuration by HTTP GET as specified by
     OpenID Connect Discovery 1.0.</p></li><li class="listitem"><p><code class="literal">/.well-known/webfinger</code> allows clients to retrieve
     the provider URL for an end user by HTTP GET as specified by OpenID Connect
     Discovery 1.0.</p></li></ul></div><p>For examples, see <a href="../admin-guide/index.html#configure-openid-connect-discovery" class="link"><em class="citetitle">Configuring
   OpenAM For OpenID Connect Discovery</em></a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-openid-connect-dynamic-registration"></a>5.2.2.&nbsp;Registering OpenID Connect 1.0 Clients</h3></div></div></div><p>OpenAM allows both static and dynamic registration of OpenID Connect
   client applications. For dynamic registration according to the OpenID Connect
   Dynamic Client Registration 1.0 specification, the endpoint is
   <code class="literal">/oauth2/connect/register</code>. See <a href="../admin-guide/index.html#register-openid-connect-client-dynamic" class="link"><em class="citetitle">To Register a
   Client Dynamically</em></a> for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-openid-connect-authorization"></a>5.2.3.&nbsp;Performing OpenID Connect 1.0 Client Authorization</h3></div></div></div><p>Registered clients can request authorization through OpenAM.</p><p>OpenID Connect 1.0 supports both a Basic Client Profile using the
   OAuth 2.0 authorization code grant, and an Implicit Client Profile using the
   OAuth 2.0 implicit grant. These client profiles rely on the OAuth 2.0
   endpoints for authorization. Those endpoints are described in
   <a class="xref" href="#rest-api-oauth2-client-endpoints" title="5.1.1.&nbsp;OAuth 2.0 Client &amp; Resource Server Endpoints">Section&nbsp;5.1.1, &#8220;OAuth 2.0 Client &amp; Resource Server Endpoints&#8221;</a>.</p><p>In addition, authorized clients can access end user information through
   the OpenID Connect 1.0 specific endpoint
   <code class="literal">/oauth2/userinfo</code>.</p><p>For examples, see <a href="../admin-guide/index.html#openid-connect-examples" class="link"><em class="citetitle">Client
   Examples</em></a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-openid-connect-session"></a>5.2.4.&nbsp;Managing OpenID Connect 1.0 Sessions</h3></div></div></div><p>Registered clients can use OpenID Connect Session Management 1.0 to
   handle end user logout actions.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">/oauth2/connect/checkSession</code> allows clients
     to retrieve session status notifications.</p></li><li class="listitem"><p><code class="literal">/oauth2/connect/endSession</code> allows clients to
     terminate end user sessions.</p></li></ul></div><p>For an example, see <a href="../admin-guide/index.html#manage-sessions-openid-connect" class="link"><em class="citetitle">Managing User
   Sessions</em></a>.</p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest-user-services"></a>Chapter&nbsp;6.&nbsp;RESTful User Self-Service</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#rest-api-self-registration">6.1. User Self-Registration</a></span></dt><dt><span class="section"><a href="#rest-api-password-reset">6.2. Resetting Forgotten Passwords</a></span></dt><dt><span class="section"><a href="#rest-dashboard">6.3. Displaying Dashboard Applications</a></span></dt></dl></div><a class="indexterm" name="d13846e6096"></a><p>This chapter shows how to use the OpenAM RESTful interfaces for user
   self-service functionality: user self-registration and forgotten password reset.
  </p><p>In this chapter, long URLs are wrapped to fit the printed page, as some
   of the output is formatted for easier reading.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-self-registration"></a>6.1.&nbsp;User Self-Registration</h2></div></div></div><a class="indexterm" name="d13846e6106"></a><p>
   The OpenAM REST API for users provides an action for self-registration.
   The feature works by sending an email to the user in response to RESTful
   HTTP POST requesting registration with an email address. When the user clicks
   the link received by mail, an application intercepts the HTTP GET,
   transforms the query string values into an HTTP POST to confirm the operation.
   OpenAM responds to the application with a JSON object that the application
   can further use to request creation of the user account to complete the
   transaction.
  </p><div class="procedure"><a name="setup-user-self-registration"></a><div class="procedure-title">Procedure&nbsp;6.1.&nbsp;To Set Up User Self-Registration</div><ol class="procedure" type="1"><li class="step"><p>Configure the Email Service.</p><p>You must configure the Email Service to send mail
     notifications to users who self-register. You can configure these globally
     in OpenAM console at Configuration &gt; Global &gt; Email Service.
    </p><p>Alternatively, you can configure them for an individual realm under
    Access Control &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Services.</p></li><li class="step"><p>Configure User Self Service.</p><p>
     You must enable self-registration in the User Self Service
     service. You can configure these globally in OpenAM console at
     Configure &gt; Global &gt; User Self Service. On the User Self Service page, click
     the <code class="literal">Enabled</code> checkbox next to Self-Registration for Users,
     and then click Save.
    </p><p>
     At this point users can self-register.
     The starting screen for self-registration is
     at <code class="literal">/XUI/#register/</code>
     under the base URL where OpenAM is installed.
     The default confirmation URI is <code class="literal">/XUI/confirm.html</code>.
    </p></li><li class="step"><p>Perform an HTTP POST on <code class="literal">/json/users?_action=register</code>
    with the new user's mail.</p><p>
     To use a subject and message other than those configured in the Email Service,
     you can optionally set the mail subject and message content
     by including "subject" and "message" strings in the JSON data.

     For example, the following POST results in a mail with
     subject <code class="literal">Confirm registration with OpenAM</code>
     and content <code class="literal">Follow this link to confirm your registration</code>
     in addition to the confirmation link.
    </p><p>
     Notice that authentication is not required.
    </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data \
 '{
   "email": "newuser@example.com",
   "subject": "Confirm registration with OpenAM",
   "message": "Follow this link to confirm your registration"
 }' \
 https://openam.example.com:8443/openam/json/users?_action=register</strong>
<em>{}</em>
    </pre></div><p>On success, the response is an empty JSON object <code class="literal">{}</code>
    as shown in the example.</p></li><li class="step"><p>
     The user receives an email message that includes a URL
     similar to the following example, but all on one line.
     The user has self-registered in the root realm:
    </p><pre class="literallayout">https://openam.example.com:8443/openam/XUI/confirm.html?
     confirmationId=f4x0Dh6iZCXtX8nhiSb3xahNxrg=
     &amp;email=newuser@example.com
     &amp;tokenId=yA26LZ6SxFEgNuF86/SIXfimGlg=
     &amp;realm=/</pre></li><li class="step"><p>Intercept the HTTP GET request to this URL when the user clicks the
    link.</p><p>Your application must use the confirmation link to construct an HTTP
    POST to <code class="literal">/json/users?_action=confirm</code> from the query string
    parameters as shown in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data \
 '{
   "email": "newuser@example.com",
   "tokenId": "yA26LZ6SxFEgNuF86/SIXfimGlg=",
   "confirmationId": "f4x0Dh6iZCXtX8nhiSb3xahNxrg="
 }' \
 https://openam.example.com:8443/openam/json/users?_action=confirm</strong>
<em>{
    "email": "newuser@example.com",
    "tokenId": "yA26LZ6SxFEgNuF86/SIXfimGlg=",
    "confirmationId": "f4x0Dh6iZCXtX8nhiSb3xahNxrg="
}</em>
    </pre></div><p>The response is a further confirmation that the account can be
    created.</p></li><li class="step"><p>Using the confirmation, your application must make an authenticated
    HTTP POST to <code class="literal">/json/users?_action=anonymousCreate</code> to
    create the user as shown in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data \
 '{
   "email": "newuser@example.com",
   "tokenId": "yA26LZ6SxFEgNuF86/SIXfimGlg=",
   "confirmationId": "f4x0Dh6iZCXtX8nhiSb3xahNxrg=",
   "username": "newuser",
   "userpassword": "password"
 }' \
 https://openam.example.com:8443/openam/json/users?_action=anonymousCreate</strong>
<em>{
    "username": "newuser",
    "realm": "/",
    "uid": [
        "newuser"
    ],
    "mail": [
        "newuser@example.com"
    ],
    "sn": [
        "newuser"
    ],
    "userPassword": [
        "{SSHA}dAiONYMxqFiNilXeLXUQoDpHlePYtiJcjYw8Dw=="
    ],
    "cn": [
        "newuser"
    ],
    "inetUserStatus": [
        "Active"
    ],
    "dn": [
        "uid=newuser,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "objectClass": [
        "devicePrintProfilesContainer",
        "person",
        "sunIdentityServerLibertyPPService",
        "inetorgperson",
        "sunFederationManagerDataStore",
        "iPlanetPreferences",
        "iplanet-am-auth-configuration-service",
        "organizationalperson",
        "sunFMSAML2NameIdentifier",
        "inetuser",
        "forgerock-am-dashboard-service",
        "iplanet-am-managed-person",
        "iplanet-am-user-service",
        "sunAMAuthAccountLockout",
        "top"
    ],
    "universalid": [
        "id=newuser,ou=user,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
    </pre></div><p>At this point, the user is registered, active, and can authenticate
     with OpenAM.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-password-reset"></a>6.2.&nbsp;Resetting Forgotten Passwords</h2></div></div></div><a class="indexterm" name="d13846e6211"></a><p>
   The OpenAM REST API provides an action
   for handling forgotten passwords
   as long as the user has a valid email address in their profile.
   This is an alternative to the password reset capability described in
   the <em class="citetitle">Administration Guide</em> chapter,
   <a href="../admin-guide/index.html#chap-pwd-reset" class="link"><em class="citetitle">Configuring Password Reset</em></a>.
  </p><div class="tip"><h3 class="title">Tip</h3><p>If the current password is known, use the
   <a href="../dev-guide/index.html#rest-api-change-password" class="link"><em class="citetitle">Change Password</em></a>
   feature to change a password.</p></div><p>The option is disabled by default. You can enable it in the OpenAM Console
  globally by using Configuration &gt; Global &gt; User Self Service.</p><p>Alternatively, you can enable it for an individual realm under
  Access Control &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Services &gt; Add &gt;
  User Self Service.</p><div class="orderedlist"><p>An example follows, showing the steps in more detail.</p><ol class="orderedlist" type="1"><li class="listitem"><p>Configure the Email Service.</p><p>In particular, you must configure the Email Service to send mail
    allowing the user to reset the forgotten password.</p><p>You can configure the service globally in the OpenAM Console via
    Configuration &gt; Global &gt; Email Service.</p><p>Alternatively, you can configure it for an individual realm under
    Access Control &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Services.</p><p>
     At this point users with mail addresses can reset their forgotten passwords.
     The starting screen for forgotten password reset is
     at <code class="literal">/XUI/#forgotPassword/</code>
     under the base URL where OpenAM is installed.
     The default confirmation URI is <code class="literal">/XUI/confirm.html</code>.
    </p><p>
     The steps that follow show how to use the REST API directly.
    </p></li><li class="listitem"><p>
     Perform an HTTP POST on <code class="literal">/json/users?_action=forgotPassword</code>
     with the user's ID.
    </p><p>
     To use a subject and message other than those configured in the Email Service,
     you can optionally set the mail subject and message content
     by including "subject" and "message" strings in the JSON data.

     For example, the following POST results in a mail with
     subject <code class="literal">Reset your forgotten password with OpenAM</code>
     and content <code class="literal">Follow this link to reset your password</code>
     in addition to the confirmation link.
    </p><p>
     Notice that authentication is not required.
    </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{
   "username": "demo",
   "subject": "Reset your forgotten password with OpenAM",
   "message": "Follow this link to reset your password"
 }' \
 https://openam.example.com:8443/openam/json/users/?_action=forgotPassword</strong>
<em>{}</em>
    </pre></div><p>Note that you can also use the <code class="literal">email</code> attribute
     to locate the user. If both <code class="literal">username</code> and <code class="literal">mail</code>
     attributes are used, then a request error is issued. If more
     than one account has been registered with the same email address,
     the password reset process does not start.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{
   "email": "demo@example.com",
   "subject": "Reset your forgotten password with OpenAM",
   "message": "Follow this link to reset your password"
 }' \
 https://openam.example.com:8443/openam/json/users/?_action=forgotPassword</strong>
<em>{}</em>
    </pre></div><p>On success, the response is an empty JSON object <code class="literal">{}</code>
    as shown in the example.</p></li><li class="listitem"><p>OpenAM looks up the email address in the user profile, and sends an
    email message that includes a URL as in the following example,
    but all on one line.</p><pre class="literallayout">https://openam.example.com:8443/openam/json/XUI/confirm.html
     ?confirmationId=sdfsfeM+URcWVQ7vvCDnx4N5Vut7SBIY=
     &amp;tokenId=vkm+5v58cTs1yQcQl5HCQGOsuQk=
     &amp;username=demo&amp;realm=/</pre></li><li class="listitem"><p>Intercept the HTTP GET request to this URL when the user clicks the
     link.</p><p>Your application must use the confirmation link to construct an HTTP
     POST to <code class="literal">/json/users?_action=confirm</code> from the query string
     parameters as shown in the following example:</p><div class="screen"><pre>
     $ <strong>curl \
     --request POST \
     --header "Content-Type: application/json" \
     --data \
     '{
     "username":"demo",
     "tokenId":"vkm+5v58cTs1yQcQl5HCQGOsuQk=",
     "confirmationId":"sdfsfeM+URcWVQ7vvCDnx4N5Vut7SBIY="
     }' \
     https://openam.example.com:8443/openam/json/users?_action=confirm</strong>
     <em>{
      "username": "demo",
      "tokenId": "vkm+5v58cTs1yQcQl5HCQGOsuQk=",
      "confirmationId": "sdfsfeM+URcWVQ7vvCDnx4N5Vut7SBIY="
      }</em>
    </pre></div><p>The response is a further confirmation that the request is
     valid, has not expired, and the password can be reset.</p></li><li class="listitem"><p>Using the confirmation, your application must construct an HTTP
    POST to <code class="literal">/json/users?_action=forgotPasswordReset</code> to
     reset the password as shown in the following example.</p><p>Your POST includes the new password as the value of the "userpassword"
     field in the JSON payload. You can also use the <code class="literal">email</code>
     attribute instead of <code class="literal">username</code>.
    </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "Content-Type: application/json" \
 --data '{
 "username":"demo",
 "userpassword":"password",
 "tokenId":"vkm+5v58cTs1yQcQl5HCQGOsuQk=",
 "confirmationId":"sdfsfeM+URcWVQ7vvCDnx4N5Vut7SBIY="
 }' \
 https://openam.example.com:8443/openam/json/users?_action=forgotPasswordReset</strong>
<em>{}</em>
    </pre></div><p>On success or failure, the REST call returns an empty message, so that
     information is not leaked.
    </p></li></ol></div><p>At this point the user can authenticate with the new password.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-dashboard"></a>6.3.&nbsp;Displaying Dashboard Applications</h2></div></div></div><a class="indexterm" name="d13846e6364"></a><p>OpenAm lets administrators configure online applications to display
    applications on user Dashboards. You can used exposed REST API to display
    information about the online applications.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">/dashboard/assigned</code></span></dt><dd><p>This endpoint retrieves the list of applications assigned to the 
       authenticated user.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/dashboard/assigned</strong>
<em>{
  "google": {
      "dashboardIcon": [
          "Google.gif"
      ],
      "dashboardName": [
          "Google"
      ],
      "dashboardLogin": [
          "http://www.google.com"
      ],
      "ICFIdentifier": [
          ""
      ],
      "dashboardDisplayName": [
          "Google"
      ],
      "dashboardClassName": [
          "SAML2ApplicationClass"
      ]
   }
}</em>
      </pre></div></dd><dt><span class="term"><code class="literal">/dashboard/available</code></span></dt><dd><p>This endpoint retrieves the list of applications available in the
       authenticated user's realm. The example is based on two of the default 
       Dashboard applications: Google and Salesforce.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/dashboard/available</strong>
<em>{
  "google": {
      "dashboardIcon": [
          "Google.gif"
      ],
      "dashboardName": [
          "Google"
      ],
      "dashboardLogin": [
          "http://www.google.com"
      ],
      "ICFIdentifier": [
          ""
      ],
      "dashboardDisplayName": [
          "Google"
      ],
      "dashboardClassName": [
          "SAML2ApplicationClass"
      ]
  }
  "salesforce": {
      "dashboardIcon": [
          "salesforce.gif"
      ],
      "dashboardName": [
          "Salesforce"
      ],
      "dashboardLogin": [
          "http://salesforce.com"
      ],
      "ICFIdentifier": [
          ""
      ],
      "dashboardDisplayName": [
          "Salesforce"
      ],
      "dashboardClassName": [
          "SAML2ApplicationClass"
      ]
  }
}</em>
      </pre></div></dd><dt><span class="term"><code class="literal">/dashboard/defined</code></span></dt><dd><p>This endpoint retrieves the list of all applications available defined
       for the OpenAM Dashboard service. The example is based on the three default 
       Dashboard applications: Google, Salesforce, and Zendesk.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/dashboard/defined</strong>
<em>{
    "google": {
        "dashboardIcon": [
            "Google.gif"
        ],
        "dashboardName": [
            "Google"
        ],
        "dashboardLogin": [
            "http://www.google.com"
        ],
        "ICFIdentifier": [
            "idm magic 34"
        ],
        "dashboardDisplayName": [
            "Google"
        ],
        "dashboardClassName": [
            "SAML2ApplicationClass"
        ]
    },
    "salesforce": {
        "dashboardIcon": [
            "salesforce.gif"
        ],
        "dashboardName": [
            "SalesForce"
        ],
        "dashboardLogin": [
            "http://www.salesforce.com"
        ],
        "ICFIdentifier": [
            "idm magic 12"
        ],
        "dashboardDisplayName": [
            "Salesforce"
        ],
        "dashboardClassName": [
            "SAML2ApplicationClass"
        ]
    },
    "zendesk": {
        "dashboardIcon": [
            "ZenDesk.gif"
        ],
        "dashboardName": [
            "ZenDesk"
        ],
        "dashboardLogin": [
            "http://www.ZenDesk.com"
        ],
        "ICFIdentifier": [
            "idm magic 56"
        ],
        "dashboardDisplayName": [
            "ZenDesk"
        ],
        "dashboardClassName": [
            "SAML2ApplicationClass"
        ]
    }
}</em>
      </pre></div></dd></dl></div><p>If your application runs in a user-agent such as a browser, you can
    rely on OpenAM to handle authentication.</p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest-identity-realm-mgmt"></a>Chapter&nbsp;7.&nbsp;RESTful Identity and Realm Management Services</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#rest-api-crud-identity">7.1. Identity Management</a></span></dt><dt><span class="section"><a href="#rest-api-crud-realm">7.2. Realm Management</a></span></dt></dl></div><a class="indexterm" name="d13846e6421"></a><p>This chapter shows how to use the OpenAM RESTful interfaces for identity
  and realm management.
 </p><p>In this chapter, long URLs are wrapped to fit the printed page, as some
  of the output is formatted for easier reading.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-crud-identity"></a>7.1.&nbsp;Identity Management</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-create-identity">7.1.1. Creating Identities</a></span></dt><dt><span class="section"><a href="#rest-api-read-identity">7.1.2. Reading Identities</a></span></dt><dt><span class="section"><a href="#rest-api-update-identity">7.1.3. Updating Identities</a></span></dt><dt><span class="section"><a href="#rest-api-delete-identity">7.1.4. Deleting Identities</a></span></dt><dt><span class="section"><a href="#rest-api-query-identity">7.1.5. Listing Identities</a></span></dt><dt><span class="section"><a href="#rest-api-retrieve-identity-using-session-cookie">7.1.6. Retrieving Identities Using the Session Cookie</a></span></dt><dt><span class="section"><a href="#rest-api-change-password">7.1.7. Changing Passwords</a></span></dt><dt><span class="section"><a href="#rest-api-create-legacy">7.1.8. Creating Identities (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-read-legacy">7.1.9. Reading &amp; Searching for Identities (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-update-legacy">7.1.10. Updating Identities (Legacy API)</a></span></dt><dt><span class="section"><a href="#rest-api-delete-legacy">7.1.11. Deleting Identities (Legacy API)</a></span></dt></dl></div><a class="indexterm" name="d13846e6431"></a><p>This section shows how to create, read, update, delete, and list
  identities using the RESTful APIs.</p><div class="important"><h3 class="title">Important</h3><p>OpenAM is not primarily an identity data store, nor is it provisioning
   software. For storing identity data, consider <a class="link" href="http://forgerock.com/what-we-offer/open-identity-stack/opendj/" target="_blank">OpenDJ</a>.
   For provisioning, consider <a class="link" href="http://forgerock.com/what-we-offer/open-identity-stack/openidm/" target="_blank">OpenIDM</a>.
   Both of these products provide REST APIs as well.</p></div><div class="itemizedlist"><p>OpenAM has two REST APIs for managing identities.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under the <code class="literal">/json/agents</code>,
    <code class="literal">/json/groups</code>, and <code class="literal">/json/users</code>,
    you find the newer JSON-based APIs. The newer APIs follow the ForgeRock
    common REST pattern creating, reading, updating, deleting, and querying
    resources.</p><p>Examples in this section do not repeat the authentication shown
    in <a href="../dev-guide/index.html#rest-api-auth" class="link">Authorization &amp; Policy Management</a>.

    For browser-based clients, you
    can rely on OpenAM cookies rather than construct the header in your
    application. Managing agent profiles, groups, realms, and users with
    these APIs of course require authorization. The examples shown in this
    section were performed with the token ID gained after authenticating
    as OpenAM administrator.</p><p>Although the examples here show user management, you can use
    <code class="literal">/json/agents</code>, <code class="literal">/json/groups</code>,
    <code class="literal">/json/realms</code> in similar fashion. See
    <a class="xref" href="#rest-api-crud-realm" title="7.2.&nbsp;Realm Management">Section&nbsp;7.2, &#8220;Realm Management&#8221;</a> for examples related to realms.</p><div class="itemizedlist"><p>The following sections cover this JSON-based API.</p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><a class="xref" href="#rest-api-create-identity" title="7.1.1.&nbsp;Creating Identities">Section&nbsp;7.1.1, &#8220;Creating Identities&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-read-identity" title="7.1.2.&nbsp;Reading Identities">Section&nbsp;7.1.2, &#8220;Reading Identities&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-update-identity" title="7.1.3.&nbsp;Updating Identities">Section&nbsp;7.1.3, &#8220;Updating Identities&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-delete-identity" title="7.1.4.&nbsp;Deleting Identities">Section&nbsp;7.1.4, &#8220;Deleting Identities&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-query-identity" title="7.1.5.&nbsp;Listing Identities">Section&nbsp;7.1.5, &#8220;Listing Identities&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-change-password" title="7.1.7.&nbsp;Changing Passwords">Section&nbsp;7.1.7, &#8220;Changing Passwords&#8221;</a></p></li></ul></div></li><li class="listitem"><p>Under the <code class="literal">/identity</code> endpoint, you find the
    backwards-compatible, legacy API.</p><div class="itemizedlist"><p>The following sections cover this backwards-compatible API.</p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><a class="xref" href="#rest-api-create-legacy" title="7.1.8.&nbsp;Creating Identities (Legacy API)">Section&nbsp;7.1.8, &#8220;Creating Identities (Legacy API)&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-read-legacy" title="7.1.9.&nbsp;Reading &amp; Searching for Identities (Legacy API)">Section&nbsp;7.1.9, &#8220;Reading &amp; Searching for Identities (Legacy API)&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-update-legacy" title="7.1.10.&nbsp;Updating Identities (Legacy API)">Section&nbsp;7.1.10, &#8220;Updating Identities (Legacy API)&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-delete-legacy" title="7.1.11.&nbsp;Deleting Identities (Legacy API)">Section&nbsp;7.1.11, &#8220;Deleting Identities (Legacy API)&#8221;</a></p></li></ul></div></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-create-identity"></a>7.1.1.&nbsp;Creating Identities</h3></div></div></div><p>OpenAM lets administrators create a user profile by making 
   an HTTP POST of the JSON representation of the profile to
   <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/?_action=create</code>.
   To add a user to the Top Level Realm, you do not need to specify the realm.</p><p>The following example shows an administrator creating a new user. The
   only required fields are <code class="literal">username</code> and
   <code class="literal">userpassword</code>. If no other name is provided, the entry
   you make for <code class="literal">username</code> defaults to both the user id and the
   user's last name.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data \
 '{
   "username": "bjensen",
   "userpassword": "secret12",
   "mail": "bjensen@example.com"
 }' \
 https://openam.example.com:8443/openam/json/users/?_action=create</strong>
<em>{
    "username": "bjensen",
    "realm": "/",
    "uid": [
        "bjensen"
    ],
    "mail": [
        "bjensen@example.com"
    ],
    "sn": [
        "bjensen"
    ],
    "userpassword": [
        "{SSHA}0pXpKLPRKCGY7g3YqZygJmKMW6IC2BLJimmlwg=="
    ],
    "cn": [
        "bjensen"
    ],
    "inetuserstatus": [
        "Active"
    ],
    "dn": [
        "uid=bjensen,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "person",
        "sunIdentityServerLibertyPPService",
        "sunFederationManagerDataStore",
        "inetorgperson",
        "iPlanetPreferences",
        "iplanet-am-auth-configuration-service",
        "organizationalperson",
        "sunFMSAML2NameIdentifier",
        "inetuser",
        "iplanet-am-managed-person",
        "sunAMAuthAccountLockout",
        "iplanet-am-user-service",
        "top"
    ],
    "universalid": [
        "id=bjensen,ou=user,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
   </pre></div><p>Alternatively, administrators can create user profiles with specific
    user IDs by doing an HTTP PUT of the JSON representation of the changes to
    <code class="literal">/json/users/<em class="replaceable"><code>user-id</code></em></code>, as
    shown in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --header "If-None-Match: *" \
 --data \
 '{
   "username": "janedoe",
   "userpassword": "secret12",
   "mail": "janedoe@example.com"
 }' \
 https://openam.example.com:8443/openam/json/users/janedoe</strong>
<em>{
    "username": "janedoe",
    "realm": "/",
    "uid": [
        "janedoe"
    ],
    "mail": [
        "janedoe@example.com"
    ],
    "sn": [
        "janedoe"
    ],
    "userpassword": [
        "{SSHA}e4DJoxvYVW/nsp62XJf29ZADE16YQgrxK+XuKA=="
    ],
    "cn": [
        "janedoe"
    ],
    "inetuserstatus": [
        "Active"
    ],
    "dn": [
        "uid=janedoe,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "devicePrintProfilesContainer",
        "person",
        "sunIdentityServerLibertyPPService",
        "inetorgperson",
        "sunFederationManagerDataStore",
        "iPlanetPreferences",
        "iplanet-am-auth-configuration-service",
        "organizationalperson",
        "sunFMSAML2NameIdentifier",
        "inetuser",
        "forgerock-am-dashboard-service",
        "iplanet-am-managed-person",
        "iplanet-am-user-service",
        "sunAMAuthAccountLockout",
        "top"
    ],
    "universalid": [
        "id=janedoe,ou=user,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
    </pre></div><p>As shown in the examples, OpenAM returns the JSON representation of
    the profile on successful creation. On failure, OpenAM returns a JSON
    representation of the error including the
    <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>. For example,
    version 2.0 of the CREST <code class="literal">/json/users</code>, <code class="literal">/json/groups</code>,
    and <code class="literal">/json/agents</code> endpoints return 403 if the user making
    the request is not authorized to do so.
   </p><p>The same HTTP POST and PUT mechanisms also work for other objects
   such as policy agent profiles and groups.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data \
 '{
   "name":"myWebAgent","realm":"/",
   "com.sun.identity.agents.config.fqdn.default":["www.example.com"],
   "sunidentityserverdevicekeyvalue":
     ["agentRootURL=http://www.example.com:80/"],
   "com.sun.identity.agents.config.remote.logfile":
     ["amAgent_www_example_com_80.log"],
   "com.sun.identity.agents.config.repository.location":["centralized"],
   "agenttype":["WebAgent"],
    "com.sun.identity.agents.config.cdsso.cdcservlet.url":
     ["[0]=https://openam.example.com:8443/openam/cdcservlet"],
   "com.sun.identity.client.notification.url":
     ["http://www.example.com:80/UpdateAgentCacheServlet?shortcircuit=false"],
   "com.sun.identity.agents.config.agenturi.prefix":
     ["http://www.example.com:80/amagent"],
   "userpassword":["password"],
   "com.sun.identity.agents.config.login.url":
     ["[0]=https://openam.example.com:8443/openam/UI/Login"],
   "com.sun.identity.agents.config.logout.url":
     ["[0]=https://openam.example.com:8443/openam/UI/Logout"],
   "sunidentityserverdevicestatus":["Active"]
 }' \
 https://openam.example.com:8443/openam/json/agents/?_action=create</strong>
<em>{
    "name": "myWebAgent",
    "realm": "/",
    "com.sun.identity.agents.config.cdsso.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.cdsso.cookie.domain": [
        "[0]="
    ],
    "com.sun.identity.agents.config.get.client.host.name": [
        "false"
    ],
    "com.sun.identity.agents.config.profile.attribute.fetch.mode": [
        "NONE"
    ],
    "com.sun.identity.agents.config.notenforced.ip": [
        "[0]="
    ],
    "com.sun.identity.agents.config.fqdn.check.enable": [
        "true"
    ],
    "com.sun.identity.agents.config.cleanup.interval": [
        "30"
    ],
    "com.sun.identity.agents.config.notenforced.url.attributes.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.ignore.preferred.naming.url": [
        "true"
    ],
    "com.sun.identity.agents.config.client.ip.header": [],
    "com.sun.identity.agents.config.session.attribute.mapping": [
        "[]="
    ],
    "com.sun.identity.agents.config.audit.accesstype": [
        "LOG_NONE"
    ],
    "com.sun.identity.agents.config.proxy.override.host.port": [
        "false"
    ],
    "com.sun.identity.agents.config.load.balancer.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.encode.url.special.chars.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.convert.mbyte.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.domino.check.name.database": [
        "false"
    ],
    "com.sun.identity.agents.config.iis.owa.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.override.port": [
        "false"
    ],
    "com.sun.identity.agents.config.policy.clock.skew": [
        "0"
    ],
    "com.sun.identity.agents.config.sso.only": [
        "false"
    ],
    "com.sun.identity.agents.config.iis.owa.enable.session.timeout.url": [],
    "com.sun.identity.agents.config.domino.ltpa.config.name": [
        "LtpaToken"
    ],
    "com.sun.identity.agents.config.cookie.reset": [
        "[0]="
    ],
    "com.sun.identity.agents.config.fqdn.default": [
        "www.example.com"
    ],
    "sunIdentityServerDeviceKeyValue": [
        "agentRootURL=http://www.example.com:80/"
    ],
    "com.sun.identity.agents.config.domino.ltpa.cookie.name": [
        "LtpaToken"
    ],
    "com.sun.identity.agents.config.iis.password.header": [
        "false"
    ],
    "com.sun.identity.agents.config.response.attribute.mapping": [
        "[]="
    ],
    "com.sun.identity.agents.config.userid.param.type": [
        "session"
    ],
    "com.sun.identity.agents.config.url.comparison.case.ignore": [
        "true"
    ],
    "com.sun.identity.agents.config.profile.attribute.cookie.maxage": [
        "300"
    ],
    "com.sun.identity.agents.config.remote.logfile": [
        "amAgent_www_example_com_80.log"
    ],
    "com.sun.identity.agents.config.domino.ltpa.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.notenforced.url": [
        "[0]="
    ],
    "com.sun.identity.agents.config.notification.enable": [
        "true"
    ],
    "com.sun.identity.agents.config.profile.attribute.cookie.prefix": [
        "HTTP_"
    ],
    "com.sun.identity.agents.config.logout.cookie.reset": [
        "[0]="
    ],
    "com.sun.identity.agents.config.polling.interval": [
        "60"
    ],
    "com.sun.identity.agents.config.attribute.multi.value.separator": [
        "|"
    ],
    "com.sun.identity.agents.config.debug.file.rotate": [
        "true"
    ],
    "com.sun.identity.agents.config.debug.level": [
        "Error"
    ],
    "com.sun.identity.agents.config.local.log.rotate": [
        "false"
    ],
    "com.sun.identity.agents.config.repository.location": [
        "centralized"
    ],
    "com.sun.identity.agents.config.client.ip.validation.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.override.protocol": [
        "false"
    ],
    "AgentType": [
        "WebAgent"
    ],
    "com.sun.identity.agents.config.logout.redirect.url": [],
    "com.sun.identity.agents.config.ignore.path.info": [
        "false"
    ],
    "com.sun.identity.agents.config.override.notification.url": [
        "false"
    ],
    "com.sun.identity.agents.config.session.attribute.fetch.mode": [
        "NONE"
    ],
    "com.sun.identity.agents.config.policy.cache.polling.interval": [
        "3"
    ],
    "com.sun.identity.agents.config.cdsso.cdcservlet.url": [
        "[0]=https://openam.example.com:8443/openam/cdcservlet"
    ],
    "com.sun.identity.agents.config.cookie.name": [
        "iPlanetDirectoryPro"
    ],
    "com.sun.identity.agents.config.profile.attribute.mapping": [
        "[]="
    ],
    "com.sun.identity.agents.config.iis.filter.priority": [
        "HIGH"
    ],
    "com.sun.identity.agents.config.iis.auth.type": [],
    "com.sun.identity.client.notification.url": [
        "http://www.example.com:80/UpdateAgentCacheServlet?shortcircuit=false"
    ],
    "com.sun.identity.agents.config.cookie.secure": [
        "false"
    ],
    "com.sun.identity.agents.config.ignore.path.info.for.not.enforced.list": [
        "true"
    ],
    "com.sun.identity.agents.config.remote.log.interval": [
        "5"
    ],
    "com.sun.identity.agents.config.notenforced.url.invert": [
        "false"
    ],
    "universalid": [
        "id=myWebAgent,ou=agent,dc=openam,dc=forgerock,dc=org"
    ],
    "com.sun.identity.agents.config.replaypasswd.key": [],
    "com.sun.identity.agents.config.iis.owa.enable.change.protocol": [
        "false"
    ],
    "com.sun.identity.agents.config.userid.param": [
        "UserToken"
    ],
    "userpassword": [
        "{SHA-1}W6ph5Mm5Pz8GgiULbPgzG37mj9g="
    ],
    "com.sun.identity.agents.config.response.attribute.fetch.mode": [
        "NONE"
    ],
    "com.sun.identity.agents.config.freeformproperties": [
        "sunidentityserverdevicestatus=Active",
        "sunidentityserverdevicekeyvalue=agentRootURL=http://www.example.com:80/",
        "realm=/",
        "name=myWebAgent"
    ],
    "com.sun.identity.agents.config.postdata.preserve.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.log.disposition": [
        "REMOTE"
    ],
    "com.sun.identity.agents.config.agenturi.prefix": [
        "http://www.example.com:80/amagent"
    ],
    "com.sun.identity.agents.config.override.host": [
        "false"
    ],
    "com.sun.identity.agents.config.cookie.reset.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.local.log.size": [
        "52428800"
    ],
    "com.sun.identity.agents.config.access.denied.url": [],
    "com.sun.identity.agents.config.debug.file.size": [
        "10000000"
    ],
    "com.sun.identity.agents.config.change.notification.enable": [
        "true"
    ],
    "com.sun.identity.agents.config.anonymous.user.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.domino.ltpa.org.name": [],
    "com.sun.identity.agents.config.agent.logout.url": [
        "[0]="
    ],
    "com.sun.identity.agents.config.poll.primary.server": [
        "5"
    ],
    "com.sun.identity.agents.config.fqdn.mapping": [
        "[]="
    ],
    "com.sun.identity.agents.config.auth.connection.timeout": [
        "2"
    ],
    "com.sun.identity.agents.config.client.hostname.header": [],
    "com.sun.identity.agents.config.iis.logonuser": [
        "false"
    ],
    "com.sun.identity.agents.config.ignore.server.check": [
        "false"
    ],
    "com.sun.identity.agents.config.fetch.from.root.resource": [
        "false"
    ],
    "com.sun.identity.agents.config.login.url": [
        "[0]=https://openam.example.com:8443/openam/UI/Login"
    ],
    "com.sun.identity.agents.config.redirect.param": [
        "goto"
    ],
    "com.sun.identity.agents.config.logout.url": [
        "[0]=https://openam.example.com:8443/openam/UI/Logout"
    ],
    "sunIdentityServerDeviceStatus": [
        "Active"
    ],
    "com.sun.identity.agents.config.sso.cache.polling.interval": [
        "3"
    ],
    "com.sun.identity.agents.config.anonymous.user.id": [
        "anonymous"
    ],
    "com.sun.identity.agents.config.encode.cookie.special.chars.enable": [
        "false"
    ],
    "com.sun.identity.agents.config.locale": [
        "en_US"
    ],
    "com.sun.identity.agents.config.postcache.entry.lifetime": [
        "10"
    ]
}</em>
   </pre></div><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data '{
   "username":"newGroup",
   "uniquemember":["uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"]
 }' \
 https://openam.example.com:8443/openam/json/groups?_action=create</strong>
<em>{
    "username": "newGroup",
    "realm": "/",
    "uniqueMember": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "cn": [
        "newGroup"
    ],
    "dn": [
        "cn=newGroup,ou=groups,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "groupofuniquenames",
        "top"
    ],
    "universalid": [
        "id=newGroup,ou=group,dc=openam,dc=forgerock,dc=org"
    ]
}</em>

$ <strong>curl \
 --request PUT \
 --header "If-None-Match: *" \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data '{
   "username":"anotherGroup",
   "uniquemember":["uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"]
 }' \
 https://openam.example.com:8443/openam/json/groups/anotherGroup</strong>
<em>{
    "username": "anotherGroup",
    "realm": "/",
    "uniqueMember": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "cn": [
        "anotherGroup"
    ],
    "dn": [
        "cn=anotherGroup,ou=groups,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "groupofuniquenames",
        "top"
    ],
    "universalid": [
        "id=anotherGroup,ou=group,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-read-identity"></a>7.1.2.&nbsp;Reading Identities</h3></div></div></div><p>OpenAM lets users and administrators read profiles by requesting an HTTP
   GET on <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/<em class="replaceable"><code>user-id</code></em></code>.
   This allows users and administrators to verify user data, status, and directory.
   If users or administrators see missing or incorrect information, they can write 
   down the correct information and add it using <a class="xref" href="#rest-api-update-identity" title="7.1.3.&nbsp;Updating Identities">Section&nbsp;7.1.3, &#8220;Updating Identities&#8221;</a>.
   To read a profile on the Top Level Realm, you do not need to specify the realm.</p><p>Users can review the data associated with their accounts and administrators 
   can read other user's profiles. The following example shows an administrator 
   accessing user data. Users can view their information by changing
   <code class="literal">username=amadmin</code> to <code class="literal"><em class="replaceable"><code>user-id</code></em></code>.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/users/demo</strong>
<em>{
    "username": "demo",
    "realm": "dc=openam,dc=forgerock,dc=org",
    "uid": [
        "demo"
    ],
    "userpassword": [
        "{SSHA}BKPAKRS3QKkvQRw25MfXbVC4VEuVNUf+yCaejg=="
    ],
    "sn": [
        "demo"
    ],
    "cn": [
        "demo"
    ],
    "inetuserstatus": [
        "Active"
    ],
    "dn": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "devicePrintProfilesContainer",
        "person",
        "sunIdentityServerLibertyPPService",
        "inetorgperson",
        "sunFederationManagerDataStore",
        "iPlanetPreferences",
        "iplanet-am-auth-configuration-service",
        "organizationalperson",
        "sunFMSAML2NameIdentifier",
        "inetuser",
        "forgerock-am-dashboard-service",
        "iplanet-am-managed-person",
        "iplanet-am-user-service",
        "sunAMAuthAccountLockout",
        "top"
    ],
    "universalid": [
        "id=demo,ou=user,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
    </pre></div><p>Use the <code class="literal">_fields</code> query string parameter to restrict
   the list of attributes returned. This parameter takes a comma-separated list
   of JSON object fields to include in the result.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/users/demo?_fields=username,uid</strong>
<em>{"username":"demo","uid":["demo"]}</em>
   </pre></div><p>As shown in the examples, OpenAM returns the JSON representation of the
   profile on success. On failure, OpenAM returns a JSON representation of the
   error including the
   <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p><p>Using HTTP GET to read also works for other objects such as agent
   profiles and groups.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/agents/myClientID</strong>
<em>{
    "username": "myClientID",
    "realm": "dc=openam,dc=forgerock,dc=org",
    "com.forgerock.openam.oauth2provider.accesstoken": [],
    "com.forgerock.openam.oauth2provider.clientsessionuri": [],
    "com.forgerock.openam.oauth2provider.defaultscopes": [
        "[0]="
    ],
    "com.forgerock.openam.oauth2provider.clientname": [],
    "com.forgerock.openam.oauth2provider.clienttype": [
        "Confidential"
    ],
    "universalid": [
        "id=myClientID,ou=agent,dc=openam,dc=forgerock,dc=org"
    ],
    "com.forgerock.openam.oauth2provider.responsetypes": [
        "[6]=code token id_token",
        "[0]=code",
        "[2]=id_token",
        "[4]=token id_token",
        "[3]=code token",
        "[1]=token",
        "[5]=code id_token"
    ],
    "userpassword": [
        "{SHA-1}W6ph5Mm5Pz8GgiULbPgzG37mj9g="
    ],
    "com.forgerock.openam.oauth2provider.name": [
        "[0]="
    ],
    "com.forgerock.openam.oauth2provider.redirectionuris": [
        "[0]="
    ],
    "com.forgerock.openam.oauth2provider.idtokensignedresponsealg": [
        "HS256"
    ],
    "com.forgerock.openam.oauth2provider.scopes": [
        "[0]="
    ],
    "com.forgerock.openam.oauth2provider.postlogoutredirecturi": [],
    "sunidentityserverdevicestatus": [
        "Active"
    ],
    "agenttype": [
        "OAuth2Client"
    ],
    "com.forgerock.openam.oauth2provider.description": [
        "[0]="
    ]
}</em>
   </pre></div><p>The <code class="literal">_prettyPrint</code> query string parameter can make
   the resulting JSON easier to read when you are viewing the resulting JSON
   directly.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/groups/myGroup?_prettyPrint=true</strong>
<em>{
    "username": "myGroup",
    "realm": "dc=openam,dc=forgerock,dc=org",
    "uniquemember": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "cn": [
        "myGroup"
    ],
    "dn": [
        "cn=myGroup,ou=groups,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "groupofuniquenames",
        "top"
    ],
    "universalid": [
        "id=myGroup,ou=group,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-update-identity"></a>7.1.3.&nbsp;Updating Identities</h3></div></div></div><p>OpenAM lets users update their own profiles, and lets administrators
   update other users' profiles. To update an identity do an HTTP PUT of the JSON 
   representation of the changes to <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/<em class="replaceable"><code>user-id</code></em></code>.
   To update a profile on the Top Level Realm, you do not need to specify the realm.</p><p>The following example shows how users can update their own
    profiles.</p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iplanetDirectoryPro: AQIC5...Y3MTAx*" \
 --header "Content-Type: application/json" \
 --data '{ "mail": "demo@example.com" }' \
 https://openam.example.com:8443/openam/json/users/demo</strong>
<em>{
    "username": "demo",
    "realm": "/",
    "uid": [
        "demo"
    ],
    "mail": [
        "demo@example.com"
    ],
    "sn": [
        "demo"
    ],
    "userpassword": [
        "{SSHA}S14oR2gusLWtiDkAS4twj63slXNNaMKpwrOWdw=="
    ],
    "cn": [
        "demo"
    ],
    "inetuserstatus": [
        "Active"
    ],
    "dn": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "person",
        "sunIdentityServerLibertyPPService",
        "sunFederationManagerDataStore",
        "inetorgperson",
        "iPlanetPreferences",
        "iplanet-am-auth-configuration-service",
        "organizationalperson",
        "sunFMSAML2NameIdentifier",
        "inetuser",
        "iplanet-am-managed-person",
        "sunAMAuthAccountLockout",
        "iplanet-am-user-service",
        "top"
    ],
    "universalid": [
        "id=demo,ou=user,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
    </pre></div><p>As shown in the example, OpenAM returns the JSON representation of the
   profile on success. On failure, OpenAM returns a JSON representation of the
   error including the
   <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p><p>
    You can use HTTP PUT to update other objects as well,
    such as policy agent profiles and groups.
   </p><p>
    The following example creates a web policy agent profile.
   </p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5...Y3MTAx*" \
 --header "Content-Type: application/json" \
 --header "If-None-Match: *" \
 --data '{
  "username" : "myWebAgent",
  "realm" : "/",
  "com.sun.identity.agents.config.fqdn.default" : [ "www.example.com" ],
  "sunIdentityServerDeviceKeyValue" :
   [ "agentRootURL=http://www.example.com:80/" ],
  "com.sun.identity.agents.config.remote.logfile" :
   [ "amAgent_www_example_com_80.log" ],
  "com.sun.identity.agents.config.repository.location" : [ "centralized" ],
  "AgentType" : [ "WebAgent" ],
  "com.sun.identity.agents.config.cdsso.cdcservlet.url" :
   [ "[0]=https://openam.example.com:8443/openam/cdcservlet" ],
  "com.sun.identity.client.notification.url" :
   [ "http://www.example.com:80/UpdateAgentCacheServlet?shortcircuit=false" ],
  "universalid" : [ "id=myWebAgent,ou=agent,dc=openam,dc=forgerock,dc=org" ],
  "userpassword" : [ "changeit" ],
  "com.sun.identity.agents.config.agenturi.prefix" :
   [ "http://www.example.com:80/amagent" ],
  "com.sun.identity.agents.config.login.url" :
   [ "[0]=https://openam.example.com:8443/openam/UI/Login" ],
  "com.sun.identity.agents.config.logout.url" :
   [ "[0]=https://openam.example.com:8443/openam/UI/Logout" ],
  "sunIdentityServerDeviceStatus" : [ "Active" ]
 }' \
 https://openam.example.com:8443/openam/json/agents/myWebAgent?_prettyPrint=true</strong>
   </pre></div><p>
    When you create a policy agent profile,
    OpenAM returns the full profile in JSON format.
   </p><p>Notice in the following example that updates <code class="literal">myGroup</code>
   the object class value is not included in the JSON sent to OpenAM.</p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5...Y3MTAx*" \
 --header "Content-Type: application/json" \
 --data '{
   "name":"myGroup",
   "realm":"/",
   "uniquemember":["uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"],
   "cn":["myGroup"],
   "description":["Updated the group"]
 }' \
 https://openam.example.com:8443/openam/json/groups/myGroup</strong>
<em>{
    "name": "myGroup",
    "realm": "/",
    "uniqueMember": [
        "uid=demo,ou=people,dc=openam,dc=forgerock,dc=org"
    ],
    "cn": [
        "myGroup"
    ],
    "dn": [
        "cn=myGroup,ou=groups,dc=openam,dc=forgerock,dc=org"
    ],
    "objectclass": [
        "groupofuniquenames",
        "top"
    ],
    "universalid": [
        "id=myGroup,ou=group,dc=openam,dc=forgerock,dc=org"
    ]
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-delete-identity"></a>7.1.4.&nbsp;Deleting Identities</h3></div></div></div><p>OpenAM lets administrators delete a user profile by making an HTTP DELETE 
   call to <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/<em class="replaceable"><code>user-id</code></em></code>.
   To delete a user from the Top Level Realm, you do not need to specify the realm.</p><p>The following example removes a user from the top level
   realm. Only administrators should delete users. The user id is the only
   field required to delete a user.</p><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/users/bjensen</strong>
<em>{"success":"true"}</em>
   </pre></div><p>On success, OpenAM returns a JSON object indicating success. On
   failure, OpenAM returns a JSON representation of the error including the
   <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p><p>You can use this same logic for other resources such as performing an
   HTTP DELETE of an agent profile or of a group.</p><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/agents/myOAuth2ClientAgent</strong>
<em>{"success":"true"}</em>
   </pre></div><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/groups/myGroup</strong>
<em>{"success":"true"}</em>
   </pre></div><div class="note"><h3 class="title">Note</h3><p>Deleting a user does not automatically remove any of the user's sessions.
    After deleting a user, check for any sessions for the user and remove them under the Console's Sessions tab.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-query-identity"></a>7.1.5.&nbsp;Listing Identities</h3></div></div></div><p>OpenAM lets administrators list identities by making an HTTP GET
   call to <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/?_queryId=*</code>. To query the Top Level Realm, you do not need
   to specify the realm.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 "https://openam.example.com:8443/openam/json/users?_queryID=*"</strong>
<em>{
  "result" : [ "amAdmin", "demo", "anonymous" ],
  "resultCount" : 3,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : -1
}</em>
   </pre></div><p>This also works for other types of objects, such as agent profiles and
   groups.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 "https://openam.example.com:8443/openam/json/agents?_queryID=*"</strong>
<em>{
  "result" : [ "wsp", "wsc", "agentAuth", "SecurityTokenService" ],
  "resultCount" : 4,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : -1
}</em>
   </pre></div><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5w...2NzEz*" \
 "https://openam.example.com:8443/openam/json/groups?_queryID=*"</strong>
<em>{
  "result" : [ "myOtherGroup", "myGroup" ],
  "resultCount" : 2,
  "pagedResultsCookie" : null,
  "remainingPagedResults" : -1
}</em>
   </pre></div><p>As the result lists include all objects, this capability to list
   identity names is mainly useful in testing.</p><p>As shown in the examples, OpenAM returns the JSON representation of
   the resource list if successful. On failure, OpenAM returns a JSON
   representation of the error including the
   <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-retrieve-identity-using-session-cookie"></a>7.1.6.&nbsp;Retrieving Identities Using the Session Cookie</h3></div></div></div><p>If you only have access to the <code class="literal">iPlanetDirectoryPro</code>
    session cookie, you can retrieve the user ID by performing an HTTP POST
    operation on the <code class="literal">/json/users</code>
    endpoint using the <code class="literal">idFromSession</code> action.
   </p><div class="screen"><pre>
$ <strong>curl \
 --verbose \
 --request POST \
 --header "iplanetdirectorypro: AQIC5wM2LY4SfczUFNs-TJwFrCVAKgR0NulIAyNaIkQmjis.*AAJTSQACMDEA
 AlNLABQtNTQ3NDE2Njc5ODk4MjYzMzA2MQ..*" \
 --header "Content-Type: application/json" http://openam.example.com:8080/openam/json/users?_action=idFromSession</strong>
<em>
{
  "id":"demo",
  "realm":"/",
  "dn":"id=demo,ou=user,dc=openam,dc=forgerock,dc=org",
  "successURL":"/openam/console",
  "fullLoginURL":null
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-change-password"></a>7.1.7.&nbsp;Changing Passwords</h3></div></div></div><a class="indexterm" name="d13846e6848"></a><a class="indexterm" name="d13846e6853"></a><p>
   A user can change their own password
    with an HTTP POST to <code class="literal">/json/<em class="replaceable"><code>subrealm</code></em>/users/<em class="replaceable"><code>username</code></em>?_action=changePassword</code>
    including the new password as the value of <code class="literal">userpassword</code> in the request
    data.</p><p> A user must provide the current password, which is set in the request
    as the value of the <code class="literal">currentpassword</code>.</p><p>For the case where the user has forgotten their password, see
    <a href="../dev-guide/index.html#rest-api-password-reset" class="link">Resetting Forgotten Passwords</a> instead.
   </p><p>
    The following example shows a successful request to change the <span class="emphasis"><em>demo</em></span>
    user's password to <span class="emphasis"><em>password</em></span>.
   </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5w...NTcy*" \
 --header "Content-Type: application/json" \
 --data '{
     "currentpassword":"changeit",
     "userpassword":"password"
 }' \
 https://openam.example.com:8443/openam/json/users/demo?_action=changePassword</strong>
<em>{}</em>
   </pre></div><p>
    On success, the response is an empty JSON object {} as shown in the
    example.</p><p>On failure, OpenAM returns a JSON representation of the error including the
    <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>. See also <a href="../dev-guide/index.html#rest-api-status-codes" class="link">REST Status Codes</a>
    for more information.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-create-legacy"></a>7.1.8.&nbsp;Creating Identities (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>OpenAM lets you create user profiles, and also create web and J2EE
   policy agent profiles. When you create an entry, you must provide the
   following parameters.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">admin</span></dt><dd><p>Valid token for the user with permissions to add the identity</p></dd><dt><span class="term">identity_name</span></dt><dd><p>A unique name for the identity to create</p></dd><dt><span class="term">identity_attribute_names</span></dt><dd><p>LDAP attribute names for attributes to create</p></dd><dt><span class="term">identity_attribute_values_<em class="replaceable"><code>name</code></em></span></dt><dd><p>LDAP attribute values for the identity to create. For example,
      <code class="literal">identity_attribute_names=sn&amp;identity_attribute_values_sn=Jensen</code>.</p></dd><dt><span class="term">identity_realm</span></dt><dd><p>The realm in which to create the identity</p></dd><dt><span class="term">identity_type</span></dt><dd><p>Either <code class="literal">user</code> or <code class="literal">AgentOnly</code></p></dd></dl></div><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/create?\
admin=AQIC5wM2LY4SfcxSYA8eG-vrNHb_W7nG8XkfAGyRyuaebDY.*AAJTSQACMDE.*\
&amp;identity_name=testuser\
&amp;identity_attribute_names=cn\
&amp;identity_attribute_values_cn=Test%20User\
&amp;identity_attribute_names=sn\
&amp;identity_attribute_values_sn=User\
&amp;identity_attribute_names=userpassword\
&amp;identity_attribute_values_userpassword=secret12\
&amp;identity_realm=%2F\
&amp;identity_type=user"</strong>
    </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-read-legacy"></a>7.1.9.&nbsp;Reading &amp; Searching for Identities (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>Reading is similar to attribute retrieval, as described in
    <a href="../dev-guide/index.html#rest-api-tokens" class="link">Token Validation</a>,
   but obtained using the token of
   a user with permissions to perform the search, as shown in the following
   example.</p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/read?\
admin=AQIC5wM2LY4SfcxSYA8eG-vrNHb_W7nG8XkfAGyRyuaebDY.*AAJTSQACMDE.*\
&amp;name=testuser\
&amp;attributes_names=realm\
&amp;attributes_values_realm=%2F"</strong>
<em>identitydetails.name=testuser
identitydetails.type=user
identitydetails.realm=o=openam
identitydetails.attribute=
identitydetails.attribute.name=uid
identitydetails.attribute.value=testuser
identitydetails.attribute=
identitydetails.attribute.name=sn
identitydetails.attribute.value=User
identitydetails.attribute=
identitydetails.attribute.name=userpassword
identitydetails.attribute.value={SSHA}AzpT+N1sjrQhL1wfX2ETWh/Aqbd+lH9LOlhDqg==
identitydetails.attribute=
identitydetails.attribute.name=cn
identitydetails.attribute.value=Test User
identitydetails.attribute=
identitydetails.attribute.name=inetuserstatus
identitydetails.attribute.value=Active
identitydetails.attribute=
identitydetails.attribute.name=dn
identitydetails.attribute.value=uid=testuser,ou=people,dc=example,dc=com
identitydetails.attribute=
identitydetails.attribute.name=objectclass
identitydetails.attribute.value=person
identitydetails.attribute.value=sunIdentityServerLibertyPPService
identitydetails.attribute.value=inetorgperson
identitydetails.attribute.value=sunFederationManagerDataStore
identitydetails.attribute.value=iPlanetPreferences
identitydetails.attribute.value=iplanet-am-auth-configuration-service
identitydetails.attribute.value=organizationalperson
identitydetails.attribute.value=sunFMSAML2NameIdentifier
identitydetails.attribute.value=inetuser
identitydetails.attribute.value=iplanet-am-managed-person
identitydetails.attribute.value=iplanet-am-user-service
identitydetails.attribute.value=sunAMAuthAccountLockout
identitydetails.attribute.value=top
identitydetails.attribute=
identitydetails.attribute.name=universalid
identitydetails.attribute.value=id=testuser,ou=user,o=openam</em>
   </pre></div><p>You can search for user IDs by providing the following
   parameters.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">admin</span></dt><dd><p>Valid token for the user with access to perform the search</p></dd><dt><span class="term">attributes_names</span></dt><dd><p>LDAP attribute names for attributes to search</p></dd><dt><span class="term">attributes_values_<em class="replaceable"><code>name</code></em></span></dt><dd><p>LDAP attribute values for the identity to search. For example,
      <code class="literal">attribute_names=sn&amp;attribute_values_sn=Jensen</code>.</p></dd><dt><span class="term">filter</span></dt><dd><p>Additional LDAP filter component to limit the search results
      returned</p></dd></dl></div><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/search?\
admin=AQIC5wM2LY4SfcxSYA8eG-vrNHb_W7nG8XkfAGyRyuaebDY.*AAJTSQACMDE.*\
&amp;attributes_names=sn\
&amp;attributes_values_sn=Jensen\
&amp;attributes_names=mail\
&amp;attributes_values_mail=bjensen*\
&amp;attributes_names=realm\
&amp;attributes_values_realm=%2F"</strong>
<em>string=bjensen</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-update-legacy"></a>7.1.10.&nbsp;Updating Identities (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>You can update an identity with the same parameters used to create
   identities, provided the token corresponds to a user with access to
   update the identity.</p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/update?\
admin=AQIC5wM2LY4SfcxSYA8eG-vrNHb_W7nG8XkfAGyRyuaebDY.*AAJTSQACMDE.*\
&amp;identity_name=testuser\
&amp;identity_attribute_names=mail\
&amp;identity_attribute_values_mail=testuser%40example.com\
&amp;identity_realm=%2F\
&amp;identity_type=user"</strong>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-delete-legacy"></a>7.1.11.&nbsp;Deleting Identities (Legacy API)</h3></div></div></div><p>Interface Stability: <a href="../admin-guide/index.html#interface-stability" class="link">Deprecated</a></p><p>You can also delete an identity.</p><div class="screen"><pre>
$ <strong>curl "https://openam.example.com:8443/openam/identity/delete?\
admin=AQIC5wM2LY4SfcxSYA8eG-vrNHb_W7nG8XkfAGyRyuaebDY.*AAJTSQACMDE.*\
&amp;identity_name=testuser\
&amp;identity_realm=%2F\
&amp;identity_type=user"</strong>
   </pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-api-crud-realm"></a>7.2.&nbsp;Realm Management</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-api-parameters-realm">7.2.1. Default Parameters for Realms</a></span></dt><dt><span class="section"><a href="#rest-api-create-realm">7.2.2. Creating Realms</a></span></dt><dt><span class="section"><a href="#rest-api-read-realm">7.2.3. Reading Realms</a></span></dt><dt><span class="section"><a href="#rest-api-list-realm">7.2.4. Listing Realms</a></span></dt><dt><span class="section"><a href="#rest-api-update-realm">7.2.5. Updating Realms</a></span></dt><dt><span class="section"><a href="#rest-api-delete-realm">7.2.6. Deleting Realms</a></span></dt></dl></div><a class="indexterm" name="d13846e7060"></a><p>This section shows how to create, read, update, and delete realms 
  using the RESTful APIs.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under the <code class="literal">/json/realms</code> endpoint, you find the 
    newer JSON-based API.</p><div class="itemizedlist"><p>The following sections cover this JSON-based API.</p><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p><a class="xref" href="#rest-api-parameters-realm" title="7.2.1.&nbsp;Default Parameters for Realms">Section&nbsp;7.2.1, &#8220;Default Parameters for Realms&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-create-realm" title="7.2.2.&nbsp;Creating Realms">Section&nbsp;7.2.2, &#8220;Creating Realms&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-read-realm" title="7.2.3.&nbsp;Reading Realms">Section&nbsp;7.2.3, &#8220;Reading Realms&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-list-realm" title="7.2.4.&nbsp;Listing Realms">Section&nbsp;7.2.4, &#8220;Listing Realms&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-update-realm" title="7.2.5.&nbsp;Updating Realms">Section&nbsp;7.2.5, &#8220;Updating Realms&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#rest-api-delete-realm" title="7.2.6.&nbsp;Deleting Realms">Section&nbsp;7.2.6, &#8220;Deleting Realms&#8221;</a></p></li></ul></div></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-parameters-realm"></a>7.2.1.&nbsp;Default Parameters for Realms</h3></div></div></div><p>Realms have a number of fields entered with the default loading.
    The following table provides information on what the default realm settings are,
    and these settings can be updated, added, or deleted when updating
    a realm.</p><div class="table"><a name="realm-parameter"></a><div class="table-title">Table&nbsp;7.1.&nbsp;Realm Parameters for JSON-based API</div><div class="table-contents"><table summary="Realm Parameters for JSON-based API" width="100%" border="0"><colgroup><col width="33%"><col width="33%"><col width="34%"></colgroup><thead><tr><th>Realm Parameter</th><th>Default</th><th>Purpose</th></tr></thead><tbody><tr><td>realm</td><td>None - the only required field to add a realm</td><td><p>The name of the realm</p>
         <p>Example: <code class="literal">myRealm</code></p></td></tr><tr><td>sunOrganizationStatus</td><td>Active</td><td><p>The status of the realm</p>
         <p><code class="literal">Active</code> or <code class="literal">Inactive</code></p></td></tr><tr><td>sunOrganizationAliases</td><td>None</td><td><p>Any applicable aliases associated with the realm. Be aware that
        an alias can only be used once. Entering an alias used by another realm
        will remove the alias from that realm and you will lose configuration.</p>
         <p>Example: <code class="literal">opensso.example.com</code></p></td></tr><tr><td>serviceNames</td><td><code class="literal">sunAMAuthHOTPService</code>
        <code class="literal">iPlanetAMAuthConfiguration</code>        
        <code class="literal">sunAMAuthFederationService</code>
        <code class="literal">sunIdentityRepositoryService</code>
        <code class="literal">iPlanetAMPolicyConfigService</code>
        <code class="literal">iPlanetAMAuthService</code>
        <code class="literal">iPlanetAMAuthLDAPService</code>
        <code class="literal">sunAMAuthDataStoreService</code>
        <code class="literal">sunAMAuthSAEService</code>
        <code class="literal">sunAMDelegationService</code>
        <code class="literal">sunAMAuthWSSAuthModuleService</code>
        <code class="literal">iPlanetAMAuthOATHService</code>
        </td><td>Services needed for the realm, including authentication modules</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-create-realm"></a>7.2.2.&nbsp;Creating Realms</h3></div></div></div><p>OpenAM lets administrators create a realm by making 
   an HTTP POST of the JSON representation of the profile to
   <code class="literal">/json/realms/?_action=create</code>.</p><p>You can create realms using an HTTP POST of the JSON representation 
    of the profile to <code class="literal">/json/realms/?_action=create</code>, as shown in 
    the following example. The only required field is <code class="literal">realm</code>, 
    but the realm will not be active if the status is not set.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data '{ "realm": "myRealm" }' \
 https://openam.example.com:8443/openam/json/realms/?_action=create</strong>
<em>{"realmCreated":"/myRealm"}</em>
     </pre></div><div class="note"><h3 class="title">Note</h3><p>Do not use the names of OpenAM REST endpoints as the name of a realm.
    The OpenAM REST endpoint names that should not be used includes: "users",
    "groups", "realms", "policies" and "applications".</p></div><p>You can also set the <code class="literal">sunOrganizationAliases</code> parameter,
    but it can only be assigned to one realm (usually the top level realm). Before
    setting this parameter, make sure it is not already assigned elsewhere. If you 
    replace remove it from another realm, you will lose your configuration.</p><p>Alternatively, administrators can create realms by the specific realm
    name using the HTTP PUT of the JSON representation of the changes to 
    <code class="literal">/json/realms/<em class="replaceable"><code>realm-id</code></em></code>, as
    shown in the following example:</p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 --header "Content-Type: application/json" \
 --data '{ }' \
 https://openam.example.com:8443/openam/json/realms/myRealm</strong>
     </pre></div><p>
     OpenAM returns the JSON representation of the profile on success.
     On failure, OpenAM returns a JSON representation of the error including the
     <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-read-realm"></a>7.2.3.&nbsp;Reading Realms</h3></div></div></div><p>OpenAM lets administrators read realms by requesting an HTTP GET on 
   <code class="literal">/json/realms/<em class="replaceable"><code>realm-id</code></em></code>. This 
   allows administrators to review all active realm services for the realm, 
   like policy configuration and modules. If users or administrators see missing 
   information (such as Active status) or incorrect information, they can write 
   down the correct information and add it using <a class="xref" href="#rest-api-update-realm" title="7.2.5.&nbsp;Updating Realms">Section&nbsp;7.2.5, &#8220;Updating Realms&#8221;</a></p><p>The following example shows an administrator receiving information about
    a realm called <code class="literal">myRealm</code>.</p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/realms/myRealm</strong>
<em>{
    "serviceNames":[
      "sunAMAuthHOTPService",
      "iPlanetAMAuthConfiguration",
      "sunAMAuthFederationService",
      "sunIdentityRepositoryService",
      "iPlanetAMPolicyConfigService",
      "iPlanetAMAuthService",
      "iPlanetAMAuthLDAPService",
      "sunAMAuthDataStoreService",
      "sunAMAuthSAEService",
      "sunAMDelegationService",
      "sunAMAuthWSSAuthModuleService",
      "iPlanetAMAuthOATHService"
    ]
}</em>
    </pre></div><p>As shown in the example, OpenAM returns the JSON representation of the
    profile on success. On failure, OpenAM returns a JSON representation of the
    error including the
    <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p><p>
    To read the top-level realm,
    use <code class="literal">toplevelrealm</code> with the
    <code class="literal">realms</code> endpoint.
   </p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/realms/toplevelrealm</strong>
<em>{
      "serviceNames" : [
       "sunAMAuthFederationService",
       "sunEntitlementIndexes",
       "iPlanetAMAuthService",
       "sunAMAuthDataStoreService",
       "sunAMAuthWSSAuthModuleService",
       "sunAMDelegationService",
       "iPlanetAMAuthOATHService",
       "iPlanetAMAuthConfiguration",
       "sunAMAuthHOTPService",
       "sunIdentityRepositoryService",
       "iPlanetAMPolicyConfigService",
       "iPlanetAMAuthLDAPService",
       "sunEntitlementService",
       "iPlanetAMPolicyService",
       "sunAMAuthSAEService",
       "AgentService" ]
}</em>
   </pre></div><p>
    If the realm you want to read is not an immediate subrealm
    of the top-level realm,
    specify its parent realm to the left
    of <code class="literal">realms</code> in the URL, and specify
    the realm's final qualifier to the right of <code class="literal">realms</code>. For example,
    to read the <code class="literal">/myRealm/myRealmsChildRealm</code> realm:
   </p><div class="screen"><pre>
$ <strong>curl \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/myRealm/realms/myRealmsChildRealm</strong>
<em>{
      "serviceNames" : [
       "sunAMAuthHOTPService",
       "iPlanetAMAuthConfiguration",
       "sunAMAuthFederationService",
       "sunIdentityRepositoryService",
       "iPlanetAMPolicyConfigService",
       "iPlanetAMAuthService",
       "iPlanetAMAuthLDAPService",
       "sunAMAuthDataStoreService",
       "sunAMAuthSAEService",
       "sunAMDelegationService",
       "sunAMAuthWSSAuthModuleService",
       "iPlanetAMAuthOATHService"
      ]
}</em>
   </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-list-realm"></a>7.2.4.&nbsp;Listing Realms</h3></div></div></div><p>
    To list a realm and its subrealms, perform an HTTP GET on the endpoint,
    setting the <code class="literal">_queryFilter</code> query string parameter
    as in the following example, which lists the top-level realm and all of
    its subrealms:
   </p><div class="screen"><pre>
 $ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/realms?_queryFilter=true</strong>
 <em>{
     "result" : [ "/", "/myRealm", "/myRealm/myRealmsChildRealm" ],
     "resultCount" : 3,
     "pagedResultsCookie" : null,
     "remainingPagedResults" : -1
 }</em>
   </pre></div><p>
    You can start listing realms from below the top-level realm by placing the
    starting realm name in the URL. The following example lists the realm
    <code class="literal">myRealm</code> and all of its subrealms.
   </p><div class="screen"><pre>
$ <strong>curl \
 --header "iPlanetDirectoryPro: AQIC5..." \
 https://openam.example.com:8443/openam/json/myRealm/realms?_queryFilter=true</strong>
 <em>{
     "result" : [ "/myRealm", "/myRealm/myRealmsChildRealm" ],
     "resultCount" : 2,
     "pagedResultsCookie" : null,
     "remainingPagedResults" : -1
 }</em>
 </pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-update-realm"></a>7.2.5.&nbsp;Updating Realms</h3></div></div></div><p>OpenAM lets administrators update realms. To update a realm, do an HTTP PUT 
   of the JSON representation of the changes to
   <code class="literal">/json/realms/<em class="replaceable"><code>realm-id</code></em></code>.</p><p>The following example shows how to update a realm called
     <code class="literal">myRealm</code>. The example command sets the realm's
     status to Inactive.
    </p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iplanetDirectoryPro: AQIC5...Y3MTAx*" \
 --header "Content-Type: application/json" \
 --data '{ "sunOrganizationStatus": "Inactive" }' \
 https://openam.example.com:8443/openam/json/realms/myRealm</strong>
     </pre></div><p>OpenAM returns the JSON representation of the
    profile on success. On failure, OpenAM returns a JSON representation of the
    error including the
    <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-api-delete-realm"></a>7.2.6.&nbsp;Deleting Realms</h3></div></div></div><p>OpenAM lets administrators delete a realm by making an HTTP DELETE call to
   <code class="literal">/json/realms/<em class="replaceable"><code>realm-id</code></em></code>.</p><p>The following example deletes a realm called <code class="literal">myRealm</code>.
     The top level realm cannot be deleted. Only administrators
     should delete realms. The name of the realm is the only field required to
     delete the realm.</p><p>Make sure that you do not have any information you need within a realm 
    before deleting it. Once a realm is deleted, the only way to restore it is 
    to return to a backed up deployment of OpenAM.</p><div class="screen"><pre>
$ <strong>curl \
 --request DELETE \
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/realms/myRealm</strong>
<em>{"success":"true"}</em>
    </pre></div><p>On success, OpenAM returns a JSON object indicating success. On
    failure, OpenAM returns a JSON representation of the error including the
    <a class="link" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank">HTTP status code</a>.</p><p>
    If the realm you want to delete is not an immediate subrealm
    of the top-level realm,
    specify its parent realm to the left
    of <code class="literal">realms</code> in the URL, and specify
    the realm's final qualifier to the
    right of <code class="literal">realms</code>. For example,
    to delete the <code class="literal">/myRealm/myRealmsChildRealm</code> realm:
   </p><div class="screen"><pre>
 $ <strong>curl \
 --request DELETE
 --header "iplanetDirectoryPro: AQIC5w...2NzEz*" \
 https://openam.example.com:8443/openam/json/myRealm/realms/myRealmsChildRealm</strong>
 <em>{ "success":"true" }</em>
   </pre></div></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-rest-sts"></a>Chapter&nbsp;8.&nbsp;RESTful Secure Token Service</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#rest-sts-intro">8.1. Introduction</a></span></dt><dt><span class="section"><a href="#rest-sts-saml-config">8.2. REST STS Configuration</a></span></dt><dt><span class="section"><a href="#rest-sts-token-transformations">8.3. Token Transformations</a></span></dt><dt><span class="section"><a href="#rest-sts-publish-service">8.4. The Publish Service</a></span></dt><dt><span class="section"><a href="#rest-sts-code-examples">8.5. REST STS Code Examples</a></span></dt></dl></div><a class="indexterm" name="d13846e7416"></a><p>
  OpenAM provides a RESTful Security Token Service (STS)
  that allows OpenAM to bridge identities across web and enterprise identity
  access management (IAM) systems through its token transformation process.
 </p><p>
  If you are unfamiliar with STS, you can read the
  <a class="link" href="http://docs.oasis-open.org/ws-sx/ws-trust/v1.4/ws-trust.html" target="_blank">specification</a>,
  which is part of the WS-Trust extensions to the Oasis WS-Security
  standard, governing the management of security tokens in secure message
  exchanges.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-sts-intro"></a>8.1.&nbsp;Introduction</h2></div></div></div><p>
   OpenAM's REST STS framework provides
   a programmatic means to create STS instances, extending single
   sign-on (SSO) and other features across token boundaries and systems. You can
   also create STS instances using the Admin console.
  </p><p>
   How does it work? In simple terms, the claims in an x509 or OpenID Connect token
   are used to map to a subject in the OpenAM datastore, and the state associated
   with this principal is used to create the claims in the issued SAML2 assertion.
   Specifically, the process of
   authenticating the input token type involves mapping an input token state to a
   principal (for example, for a &lt;username, password&gt; combination).
   The issued SAML2 assertion asserts the
   identity of this subject, which can contain AttributeStatements that assert claims
   related to LDAP attribute state associated with this subject.
  </p><p>
   For example, you can create a REST
   STS instance programmatically or through the Admin console
   to transform a validated OpenID Connect (OIDC) 1.0 access token,
   whose principal is mapped to a new SAML 2.0 token, asserting claims mapped
   in the OIDC access token's scope.
  </p><p>
   The following token transformations are currently supported:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>OpenAM-&gt;SAML2</p></li><li class="listitem"><p>UsernameToken-&gt;SAML2</p></li><li class="listitem"><p>OpenID Connect ID Token-&gt;SAML2</p></li><li class="listitem"><p>X509-&gt;SAML2</p></li></ul></div><p>
  The generated SAML 2.0 token supports assertion signing and encryption as well
  as with the Bearer, Holder of Key, or Sender Vouches Subject confirmation:
 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>Holder of Key</strong></span>. Specifies that the subject
    must contain one or more
    <code class="literal">KeyInfo</code> elements
    within the <code class="literal">subjectConfirmationData</code> element so that
    service provider can validate that the requesting entity is in the possession
    of the key(s).
   </p></li><li class="listitem"><p><span class="bold"><strong>Bearer</strong></span>. Specifies that the subject does
    not contain key material but the
    subject is considered an acceptable attesting entity. The service
    provider can accept the assertion or not, and optionally invoke other means or constraints
    specified in the <code class="literal">subjectConfirmationData</code> element.
   </p></li><li class="listitem"><p><span class="bold"><strong>Sender Vouches</strong></span>. Specifies that the
    subject does not contain key material.
    The service provider can optionally invoke other methods to accept the
    assertion or not.</p></li></ul></div><p>
   You can publish REST STS instances in a given realm, each with different
   configuration characteristics, or update an existing STS instance using the
   Admin Console (click Access Control &gt; <em class="replaceable"><code>Realm Name</code></em>
   &gt; STS) or programmatically using the Client SDK.
 </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-sts-saml-config"></a>8.2.&nbsp;REST STS Configuration</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-sts-instance-config">8.2.1. Instance Configuration</a></span></dt><dt><span class="section"><a href="#signing-n-encryption">8.2.2. Signing and Encryption</a></span></dt><dt><span class="section"><a href="#rest-sts-plugins">8.2.3. Custom Plug-ins</a></span></dt><dt><span class="section"><a href="#rest-sts-authncontext">8.2.4. AuthnContext</a></span></dt><dt><span class="section"><a href="#rest-sts-mapping">8.2.5. SAML Attribute Mapping</a></span></dt></dl></div><p>The following sections presents points about the REST STS configuration.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-instance-config"></a>8.2.1.&nbsp;Instance Configuration</h3></div></div></div><p>
    Each REST STS instance issues SAML 2.0 assertions for a single ServiceProvider.
    As a result, each REST STS instance is configured with the following elements:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>Issuer</strong></span>. Corresponds to the
      Identity Provider (IdP) EntityID.</p></li><li class="listitem"><p><span class="bold"><strong>Service Provider (SP) EntityID</strong></span>. Used in the
      <code class="literal">AudienceRestriction</code> element of the
      <code class="literal">Conditions</code> of the issued assertion.</p></li><li class="listitem"><p><span class="bold"><strong>SP Assertion Consumer Service URL</strong></span>.
      Used as the <code class="literal">Recipient</code>
      attribute of the <code class="literal">SubjectConfirmation</code> element in
      <code class="literal">Subject</code> elements, as required
      for Bearer assertions according to the
      <a class="link" href="http://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf" target="_blank">Web SSO profile</a>.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="signing-n-encryption"></a>8.2.2.&nbsp;Signing and Encryption</h3></div></div></div><p>
    For signing and encryption support, each REST STS instance has a configuration
    state specifying the keystore location containing the signing and encryption keys.
   </p><p>
    If you configure assertion signing, you must specify the keystore path and password,
    as well as the alias and password corresponding to the
    private key used to sign the assertion.
   </p><p>
    If you configure assertion encryption,
    you must specify the keystore path and password, as well as the alias
    corresponding to the SP&#8217;s X509 certificate, which encapsulates the public
    key used to encrypt the symmetric key that encrypted the generated assertion.
   </p><div class="note"><h3 class="title">Note</h3><p>
     You can specify the keystore location using an absolute path on the
     local filesystem or a path relative to the OpenAM classpath.
    </p></div><p>
    You can encrypt the
    entire assertion, or the <code class="literal">NameID</code> and/or
    the <code class="literal">AttributeStatement</code> attributes.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-plugins"></a>8.2.3.&nbsp;Custom Plug-ins</h3></div></div></div><p>
    All statements constituting a SAML 2.0 assertion can be fully customized.
    For each REST STS instance, you can write custom plug-ins for the
    <code class="literal">Conditions</code>, <code class="literal">Subject</code>,
    <code class="literal">AuthenticationStatements</code>,
    <code class="literal">AttributeStatements</code>, and
    <code class="literal">AuthorizationDecisionStatements</code> classes.
    If you specify the classes in the configuration of the published REST STS instance,
    these custom classes are consulted to provide the specific statements.
    See the interfaces in the
    
    <code class="literal">org.forgerock.openam.sts.tokengeneration.saml2.statements</code>
    package for details.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-authncontext"></a>8.2.4.&nbsp;AuthnContext</h3></div></div></div><p>
    Each REST STS instance must specify the <code class="literal">AuthnContext</code>
    in the <code class="literal">AuthenticationStatements</code> of the generated assertion.
    This <code class="literal">AuthnContext</code> allows the generated SAML 2.0 assertion
    to specify the manner in which the assertion&#8217;s
    subject was authenticated. For a token transformation,
    this <code class="literal">AuthnContext</code> is a function of the input token type.
   </p><p>
    By default, the following <code class="literal">AuthnContext</code>
    string is included in the SAML2 assertion, generated as part of the
    transformation of the following input token types:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>OpenAM: <code class="literal">urn:oasis:names:tc:SAML:2.0:ac:classes:PreviousSession</code></p></li><li class="listitem"><p>UsernameToken and OpenID Connect ID Token:
      <code class="literal">urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</code></p></li><li class="listitem"><p>X509 Token: <code class="literal">urn:oasis:names:tc:SAML:2.0:ac:classes:X509</code></p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>
     You can override these default mappings by implementing the
     <code class="literal">org.forgerock.openam.sts.token.provider.AuthnContextMapper</code> interface, and
     specifying the name of this implementation in the configuration of the
     published REST STS instance.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-mapping"></a>8.2.5.&nbsp;SAML Attribute Mapping</h3></div></div></div><p>
    You can set the mapping of SAML attribute
    names (Map keys) to local OpenAM attributes (Map values) using
    the <code class="literal">org.forgerock.openam.sts.tokengeneration.saml2.statements.DefaultAttributeMapper</code>
    class, which looks at profile attributes in the data stores or in the
    session properties for each published REST STS instance.
    The keys define the name of the
    attributes in the Assertion Attribute statements, and the values define
    these attribute names.
    REST STS pulls the data from the subject's directory entry or from the session
    state that corresponds to the map value.
   </p><p>
    The keys can have the following format:
   </p><div class="screen"><pre>
[NameFomatURI|]SAML ATTRIBUTE NAME
   </pre></div><p>
    If the attribute value is enclosed in
    quotes, that quoted value is included in the attribute without mapping.
    Binary attributes should be followed by <code class="literal">;binary</code>
    as seen in the following example:
   </p><div class="screen"><pre>
EmailAddress=mail,
Address=postaladdress,
urn:oasis:names:tc:SAML:2.0:attrname-format:uri|urn:mace:dir:attribute-def:cn=cn,
partnerID="staticPartnerIDValue",
urn:oasis:names:tc:SAML:2.0:attrname-format:uri|nameID="staticNameIDValue",
photo=photo;binary,
urn:oasis:names:tc:SAML:2.0:attrname-format:uri|photo=photo;binary
  </pre></div><p>
   If this attribute mapping is insufficient, implement the
   <code class="literal">org.forgerock.openam.sts.tokengeneration.saml2.statements.AttributeMapper</code>
   interface and specify the name of the custom <code class="literal">AttributeMapper</code> in the
   configuration corresponding to your published REST STS instance.
  </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-sts-token-transformations"></a>8.3.&nbsp;Token Transformations</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#rest-sts-auth">8.3.1. Authentication</a></span></dt><dt><span class="section"><a href="#transform-oidc">8.3.2. Transforming OpenID Connect Tokens</a></span></dt><dt><span class="section"><a href="#transform-x509-cert">8.3.3. Transforming X509 Certificate</a></span></dt><dt><span class="section"><a href="#rest-sts-auth-x509">8.3.4. Authentication x509</a></span></dt><dt><span class="section"><a href="#rest-sts-auth-username">8.3.5. Authentication: Username</a></span></dt><dt><span class="section"><a href="#rest-sts-auth-oidc">8.3.6. Authentication: OpenID Connect</a></span></dt></dl></div><p>
   You can configure each REST STS instance with a distinct set of token
   transformations prgrammatically using the Client SDK or using the Admin Console.
   You select the transformations under
   the Supported Token Transforms under General Configuration, where
   you select a token transformation from a supported list.
  </p><p>
   Each transformation has the format:
  </p><pre class="brush: plain;">
X-&gt;Y;(don&#8217;t) invalidate interim OpenAM session
  where
    "X" refers to the input token type
    "Y" refers to the output token type (currently limited to SAML 2.0)
    "(don't) invalidate interim OpenAM session" specifies whether the interim
     OpenAM session, created during the authentication of the presented input token
     type, should be invalidated following the creation of the output token type.
     This setting allows a REST STS instance to support token transformations
     with or without a residual OpenAM session remaining after the token
     transformation.
  </pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-auth"></a>8.3.1.&nbsp;Authentication</h3></div></div></div><p>
   The input tokens in REST STS token transformations are authenticated via
   OpenAM&#8217;s restful authentication context. This context needs to be configured
   for every input token type in the set of token transformations. For example,
   if you select the transformation <code class="literal">OPENIDCONNECT-&gt;SAML2</code>,
   the STS instance must be configured with information specifying which elements
   of the OpenAM restful authentication context needs to be consumed to validate
   the <code class="literal">OPENIDCONNECT</code> token.
  </p><p>
   The elements of the configuration tuple are separated by '|'.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The first element
     is the input token type in the token transform:
     i.e. X509, OPENIDCONNECT, USERNAME, or OPENAM.</p></li><li class="listitem"><p>The second element is the
     authentication target, either <code class="literal">module</code> or
     <code class="literal">service</code>.</p></li><li class="listitem"><p>The third element
     is the name of the authentication module or service.</p></li><li class="listitem"><p>The fourth
     element (optional) provides the STS authentication context information about the
     to-be-consumed authentication context.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transform-oidc"></a>8.3.2.&nbsp;Transforming OpenID Connect Tokens</h3></div></div></div><p>
   When transforming OpenID Connect ID
   tokens, the OpenID Connect authentication module must be consumed, and thus a
   deployed REST STS instance must be configured with the name of the header/cookie
   element where the OpenID Connect ID token is placed.
   For example, the following Admin Console string defines these
   configurations:
  </p><div class="screen"><pre>
OPENIDCONNECT|module|oidc|oidc_id_token_auth_target_header_key=oidc_id_token.
  </pre></div><p>
   In this case, <code class="literal">oidc</code> is the name of the OpenID Connect
   authentication module created to authenticate OpenID Connect tokens.
   REST STS looks for the name of the header key in the string
   <code class="literal">oidc_id_token_auth_target_header_key</code>, which is the
   header where the <code class="literal">oidc</code> module expects to find the OpenID
   Connect ID Token.
  </p><div class="note"><h3 class="title">Note</h3><p>
    You can create these configurations in a more intuitive,
    fluent way by using the builders supporting the programmatic publishing of REST STS instances.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transform-x509-cert"></a>8.3.3.&nbsp;Transforming X509 Certificate</h3></div></div></div><p>
   When transforming a X509 Certificate, the Certificate module must be consumed,
   and the published REST STS instance must be configured with the name of the
   Certificate module (or the service containing the module), and the header name
   configured for the Certificate module corresponding to where the Certificate
   module can expect to find the to-be-validated Certificate.
  </p><p>
   The following
   Admin Console string would define these configurations (note that these configurations
   can be created in a more intuitive, fluent way using the builders supporting
   the programmatic publishing of REST STS instances):
  </p><div class="screen"><pre>
X509|module|cert_module|x509_token_token_auth_target_header_key=client_cert
  </pre></div><p>
   In this case <code class="literal">cert_module</code> is the name of the Certificate module, and
   <code class="literal">client_cert</code> is the header name where Certificate module
   has been configured to find the client's Certificate.
   REST STS looks for the name of the header key in the string
   <code class="literal">x509_token_token_auth_target_header_keyy</code>, which is the
   header x509 ID Token.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-auth-x509"></a>8.3.4.&nbsp;Authentication x509</h3></div></div></div><p>
   An x509 Certificate is a representation of subject identity only
   when ownership of the associated private key is demonstrated, as performed by
   the TLS-handshake, and described in the AsymmetricBinding examples 2.2.1 and 2.2.2 in
   <a class="link" href="http://docs.oasis-open.org/ws-sx/security-policy/examples/ws-sp-usecases-examples.html" target="_blank">WS-SecurityPolicy</a>.
  </p><p>
   Because the REST STS is not protected by
   WS-SecurityPolicy bindings (this is the domain of the SOAP STS), a REST STS
   token transformation, which defines an x509 Certificate as an input token, can
   only be consumed by two-way TLS. Here the client must present their certificate,
   with the TLS handshake certifying that the private key corresponding to the
   presented certificate is in the possession of the certificate presenter.
   In such a deployment, REST STS obtains the client's certificate from
   the <code class="literal">javax.servlet.request.X509Certificate</code> attribute in the
   <code class="literal">ServletRequest</code>.
  </p><p>
   However, if OpenAM is deployed in a TLS-offloaded context,
   REST STS obtains the client's certificate from the
   header key defined in the published REST STS instance.
   The header key is specified in the
   "Client Certificate Header Key" under the "Deployment Configuration" section
   of a REST STS instance in the Admin Console, or in the
   <code class="literal">org.forgerock.openam.sts.rest.config.user.
   RestDeploymentConfig.RestDeploymentConfigBuilder#offloadedTwoWayTLSHeaderKey</code> method.
  </p><p>
   If a header key referencing a client's certificate is defined, then only this
   header is examined for the client's certificate. If this header is
   undefined, only the <code class="literal">javax.servlet.request.X509Certificate</code>
   ServletRequest attribute is examined.
   Note that the token transformation definition specifying an
   x509 input token does not actually encapsulate the
   caller's certificate. This token state only triggers REST STS to
   consult one of the two locations described above.
  </p><p>
   If the REST STS is configured to pull the client&#8217;s certificate out of a specified header, the
   set of hosts trusted to set this header must also be specified. See the
   "Trusted Remote Hosts" list in the "Deployment Configuration" section of the
   Admin Console or the <code class="literal">org.forgerock.openam.sts.rest.config.user.RestDeploymentConfig.
   RestDeploymentConfigBuilder#tlsOffloadEngineHostIpAddrs</code> method.
  </p><div class="note"><h3 class="title">Note</h3><p>
    An entry of &#8216;any&#8217; in this list causes any caller to be trusted.
   </p></div><p>
   Authentication of the client-presented certificate is performed by the
   Certificate module. This module optionally performs certificate revocation list
   (CRL) or Online Certificate Status Protocol (OCSP) checking,
   and optionally checks to see that the specified certificate is in a LDAP
   datastore.
  </p><p>
   The Certificate module also expects to reference the
   caller's certificate in a specified header value, and that the IP addresses
   of hosts trusted to provide this information must also be specified. See the
   "Trusted Remote Hosts" and the "Http Header Name for Client Certificate" in
   the Certificate module configuration at
   <a href="../admin-guide/index.html#cert-module-conf-hints" class="link">Hints for the
   Certificate Authentication module</a>. This header must be
   specified in the Authentication Target Mapping definition for X509 tokens for
   the published REST STS instance, so that the REST STS instance can know which
   header should reference the client&#8217;s x509 certificate when consuming the
   Certificate module.
  </p><p>
   For example, given the following authentication target mapping:
  </p><pre class="brush: plain;">
X509|module|cert_module|x509_token_token_auth_target_header_key=client_cert
  </pre><p>
   X509 specifies that for X509 input tokens, a module named <code class="literal">cert_module</code> should
   be invoked, and that this module expects to find the client&#8217;s X509
   Certificate in a header named <code class="literal">client_cert</code>.
   Thus the string <code class="literal">client_cert</code> must
   appear in the HTTP Header Name for Client Certificate configuration field for
   the Certificate module named <code class="literal">cert_module</code>.
   Also, the IP address of the
   OpenAM deployment must be added to the Trusted Remote Hosts configuration of
   the targeted Certificate module.
  </p><p>
   For more information on
   mapping x509 Certificate state to a subject in the OpenAM datastore, see
   <a href="../admin-guide/index.html#cert-module-conf-hints" class="link">Hints for the
         Certificate Authentication module</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-auth-username"></a>8.3.5.&nbsp;Authentication: Username</h3></div></div></div><p>
   The Username token passed to the REST STS represents the &lt;username, password&gt;
   combination in clear text. This means that REST STS instances that support
   Username Token-based token transformations should only be deployed on TLS.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rest-sts-auth-oidc"></a>8.3.6.&nbsp;Authentication: OpenID Connect</h3></div></div></div><p>
   REST STS instances must be configured to consume an appropriately-configured
   OpenID Connect authentication module for OpenID Connect-based token transformations.
   The OIDC authentication module expects to reference the <code class="literal">id</code>
   token in a header value.
   Thus, the <code class="literal">AuthTargetMapping</code> of the published REST STS
   instance must be configured with the name of the header configured for the
   referenced OIDC authentication module.
  </p><p>
   The OIDC authentication module must be configured with
   either the discovery URL, the jwk URL or the client secret corresponding to the
   issuer, and the issuer name must be set (for OpenAM issued OIDC tokens, the
   issuer name corresponds to the OpenAM deployment url).
  </p><p>
   The OIDC authentication
   module also checks the authorized party (<code class="literal">azp</code>) and
   audience (<code class="literal">aud</code>) claims.
   The OIDC token <code class="literal">aud</code> claim must match that configured for
   the OIDC authentication module (that is, set to the OAuth2 client's ID).
   If the OIDC token has a
   <code class="literal">azp</code> claim, it must match that configured for the OIDC
   authentication module (again, set to the OAuth2 client ID).
   You must configure the attribute mappings, so that jwk claim state is mapped
   to an entry in the OpenAM user data store.
  </p><p>
   For additional details on the OpenID Connect authentication
   module, <a href="../admin-guide/index.html#oidc-module-conf-hints" class="link">
   Hints for the OpenID Connect Module</a>.
  </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-sts-publish-service"></a>8.4.&nbsp;The Publish Service</h2></div></div></div><p>
   REST STS instances configured via the Admin Console or programmatically, are
   published via the REST STS publish service, exposed at
   <code class="literal">&lt;server-root&gt;/rest-sts-publish/publish</code>.
   This restful interface can only
   be consumed by administrators.
  </p><p>
   Performing a GET on the <code class="literal">/rest-sts-publish/publish</code> URL
   returns the json representation of the configuration state corresponding to
   all published REST STS instances. Only administrators can perform this GET
   operation, that is, admin users with the iPDP cookie can receive the return
   state.
  </p><p>
   A particular REST STS instance is identified by:
  </p><pre class="brush: plain;">
Realm Name/{deployment_url_element},
  where
    Realm Name is the realm in which the REST STS instance is published.
    {deployment_url_element} is the "Deployment Url Element" set in the Admin
      Console or via the
      RestSTSDeploymentConfig.RestDeploymentConfigBuilder#uriElement(String uriElement
      method.
  </pre><p>
   All published REST STS instances are exposed relative to
   <code class="literal">/rest-sts</code>, so if OpenAM is exposed at
   <code class="literal">https://host.com:443/openam</code>, and the REST STS instance is published
   in a realm called "accounting" with a Deployment URl element of
   <code class="literal">accountingsts</code>, then the URL would be:
  </p><pre class="brush: plain;">
https://host.com:443/openam/rest-sts/accounting/accountingsts
  </pre><p>
   A json representation of this instance&#8217;s configuration state could be examined
   by a GET method to:
  </p><pre class="brush: plain;">
https://host.com:443/openam/rest-sts-publish/publish/accounting/accountingsts
  </pre><p>
   This instance could be deleted by performing a DELETE on
   <code class="literal">https://host.com:443/openam/rest-sts-publish/publish/accounting/accountingsts</code>.
  </p><div class="note"><h3 class="title">Note</h3><p>
    The REST STS Publish and Consume examples are contained within their own maven
    module (<code class="literal">openam-client-sts</code>), and the contents of this module
    are added to the <code class="literal">client-sdk</code>. To get the examples to work,
    there are a number of maven dependencies, specified in the
    <code class="literal">META-INF/maven/org.forgerock.openam/openam/client-sts/pom.xml</code>
    file in the <code class="literal">client-sdk.jar</code>. You should review these
    dependencies prior to setting up the examples.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-sts-code-examples"></a>8.5.&nbsp;REST STS Code Examples</h2></div></div></div><p>
   The code example shows how to programmatically publish REST STS instances.
  </p><pre class="brush: plain;">
package org.forgerock.openam.sts.rest;
import org.forgerock.json.fluent.JsonException;
import org.forgerock.json.fluent.JsonValue;
import org.forgerock.openam.shared.sts.SharedSTSConstants;
import org.forgerock.openam.sts.AMSTSConstants;
import org.forgerock.openam.sts.config.user.AuthTargetMapping;
import org.forgerock.openam.sts.TokenType;
import org.forgerock.openam.sts.config.user.SAML2Config;
import org.forgerock.openam.sts.rest.config.user.RestDeploymentConfig;
import org.forgerock.openam.sts.rest.config.user.RestSTSInstanceConfig;
import org.forgerock.openam.sts.token.UrlConstituentCatenatorImpl;
import org.forgerock.openam.utils.IOUtils;
import org.forgerock.openam.utils.JsonValueBuilder;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import static org.forgerock.json.fluent.JsonValue.field;
import static org.forgerock.json.fluent.JsonValue.json;
import static org.forgerock.json.fluent.JsonValue.object;

/**
 * This class provides an example of how to programatically publish REST STS
 * instances. It does not provide an exhaustive enumeration of configuration options,
 * but rather provides an indication of how to consume the various classes used to
 * build the configuration state corresponding to a published REST STS instance.
 */

public class RestSTSInstancePublisher {

    private static final String COOKIE = "Cookie";
    private static final String EQUALS = "=";
    private final String publishEndpoint;
    private final String spEntityId;
    private final String idpEntityId;
    private final String stsClientCertHeaderName;
    private final String spACSEndpoint;
    private final String adminSessionId;
    private final String createAction;

 /**
  *
  * @param publishEndpoint         The url of the publish service. For example,
  *                                http://myhost.com:8080/openam/rest-sts-publish/publish
  * @param spEntityId              The entity id of the Service Provider consuming the
  *                                created SAML2 assertions
  * @param idpEntityId             The entity id of the Identity Provider for which the
  *                                REST STS instance is issuing assertions
  * @param stsClientCertHeaderName If x509-&gt;SAML2 token transformations are being
  *                                provided in a tls-offloaded context, this value
  *                                specifies the header name that these offload
  *                                engines places the client's certificate.
  *                                Can be null.
  * @param spACSEndpoint           The url of the Service Provider's Assertion Consumer
  *                                Service. Required for Bearer assertions to conform to the
  *                                web-sso profile.
  * @param adminSessionId          The valid session id (iPlanetDirectoryPro cookie value)
  *                                for an OpenAM administrator. Required as only admins
  *                                can consume the REST STS publish service.
  * @param createAction            Used to append onto the end of the publishEndpoint string,
  *                                to specify a publish action. The value is ?_action=create
  */

  public RestSTSInstancePublisher(String publishEndpoint, String spEntityId,
                                  String idpEntityId, String stsClientCertHeaderName,
                                  String spACSEndpoint, String adminSessionId,
                                  String createAction) {
        this.publishEndpoint = publishEndpoint;
        this.spEntityId = spEntityId;
        this.idpEntityId = idpEntityId;
        this.stsClientCertHeaderName = stsClientCertHeaderName;
        this.spACSEndpoint = spACSEndpoint;
        this.adminSessionId = adminSessionId;
        this.createAction = createAction;
  }

  /**
  An example of the json posted as part of this method invocation:
  {
     "invocation_context": "invocation_context_client_sdk",
     "instance_state": {
        "issuer-name": "http://macbook.dirk.internal.forgerock.com:8080/openam",
        "saml2-config": {
           "saml2-name-id-format": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
           "saml2-token-lifetime-seconds": "600",
           "saml2-custom-conditions-provider-class-name": null,
           "saml2-custom-subject-provider-class-name": null,
           "saml2-custom-attribute-statements-provider-class-name": null,
           "saml2-custom-attribute-mapper-class-name": null,
           "saml2-custom-authn-context-mapper-class-name": null,
           "saml2-custom-authentication-statements-provider-class-name": null,
           "saml2-custom-authz-decision-statements-provider-class-name": null,
           "saml2-sign-assertion": "true",
           "saml2-encrypt-assertion": "true",
           "saml2-encrypt-attributes": "false",
           "saml2-encrypt-nameid": "false",
           "saml2-encryption-algorithm": "http://www.w3.org/2001/04/xmlenc#aes128-cbc",
           "saml2-encryption-algorithm-strength": "128",
           "saml2-attribute-map": {
              "email": "mail"
           },
           "saml2-keystore-filename": "/Users/DirkHogan/openam/openam/keystore.jks",
           "saml2-keystore-password": "changeit",
           "saml2-sp-acs-url": "http://macbook.dirk.internal.forgerock.com:18080/
                                openam/Consumer/metaAlias/sp",
           "saml2-sp-entity-id": "http://macbook.dirk.internal.forgerock.com:18080/
                                  openam",
           "saml2-signature-key-alias": "test",
           "saml2-signature-key-password": "changeit",
           "saml2-encryption-key-alias": "test"
        },
        "deployment-config": {
           "deployment-url-element": "inst458259670",
           "deployment-realm": "/",
           "deployment-auth-target-mappings": {
              "[Ljava.security.cert.X509Certificate;": {
                 "mapping-auth-index-type": "module",
                 "mapping-auth-index-value": "cert_module",
                 "mapping-context": {
                    "x509_token_token_auth_target_header_key": "client_cert"
              }
           },
           "org.forgerock.openam.sts.token.model.OpenIdConnectIdToken": {
              "mapping-auth-index-type": "module",
              "mapping-auth-index-value": "oidc", "mapping-context": {
                 "oidc_id_token_auth_target_header_key": "oidc_id_token"
              }
           },
           "org.apache.ws.security.message.token.UsernameToken": {
              "mapping-auth-index-type": "service",
              "mapping-auth-index-value": "ldapService"
           }
        },
        "deployment-offloaded-two-way-tls-header-key": "client_cert",
        "deployment-tls-offload-engine-hosts": [
           "192.168.1.2",
           "127.0.0.1"
        ]
     },
     "supported-token-transforms": [
        {
           "inputTokenType": "OPENIDCONNECT",
           "outputTokenType": "SAML2",
           "invalidateInterimOpenAMSession": true
        },
        {
           "inputTokenType": "USERNAME",
           "outputTokenType": "SAML2",
           "invalidateInterimOpenAMSession": true
        },
        {
           "inputTokenType": "OPENAM",
           "outputTokenType": "SAML2",
           "invalidateInterimOpenAMSession": false
        },
        {
           "inputTokenType": "X509",
           "outputTokenType": "SAML2",
           "invalidateInterimOpenAMSession": true
        }
     ]
   }
  }
  */

  public String publishInstance(final String urlElement, String realm) throws Exception {
      RestSTSInstanceConfig instanceConfig = createRestSTSInstanceConfig(urlElement, realm);
      String jsonString = buildPublishInvocationJsonValue(instanceConfig).toString();
      String response = invokeRestSTSInstancePublish(jsonString);
      return parseInstanceUrl(response);
  }

  /**
    The fullSTSId should be the string returned by publishInstance.
  */

  public String removeInstance(final String fullSTSId) throws Exception {
      return invokeRestSTSInstanceDeletion(getPublishRemoveInstanceUri(fullSTSId));
  }

  public List&lt;RestSTSInstanceConfig&gt; getPublishedInstances() throws Exception {
      String response = getPublishedRestSTSInstancesConfigContent(publishEndpoint);
      List&lt;RestSTSInstanceConfig&gt; instanceConfigs = new ArrayList&lt;RestSTSInstanceConfig&gt;();
      JsonValue json;
      try {
          json = JsonValueBuilder.toJsonValue(response);
      } catch (JsonException e) {
          System.out.println("JsonException parsing response: " + response + "\n Exception: "
           + e);
          throw e;
      }
      for (String key : json.asMap().keySet()) {
          JsonValue value = json.get(key);
          JsonValue jsonInstanceConfig = null;
          try {
              jsonInstanceConfig = JsonValueBuilder.toJsonValue(value.asString());
          } catch (JsonException e) {
              System.out.println("JsonException caught parsing json for instance.
               The value: " + value.asString() + "\n Exception: " + e);
          }
          RestSTSInstanceConfig instanceConfig
           = RestSTSInstanceConfig.fromJson(jsonInstanceConfig);
          instanceConfigs.add(instanceConfig);
      }
      return instanceConfigs;
  }

  private String getPublishedRestSTSInstancesConfigContent(String publishEndpoint)
      throws Exception {
      HttpURLConnection connection
       = (HttpURLConnection)new URL(publishEndpoint).openConnection();
      connection.setRequestMethod("GET");
      connection.connect();
      return readInputStream(connection.getInputStream());
  }

  private String invokeRestSTSInstancePublish(String invocationPayload)
      throws IOException {
      HttpURLConnection connection
       = (HttpURLConnection)getPublishAddInstanceUri().openConnection();
      connection.setDoOutput(true);
      connection.setRequestMethod("POST");
      connection.setRequestProperty(SharedSTSConstants.CONTENT_TYPE,
                                    SharedSTSConstants.APPLICATION_JSON);
      connection.setRequestProperty(COOKIE, getAdminSessionTokenCookie());
      OutputStreamWriter writer = new OutputStreamWriter(connection.getOutputStream());
      writer.write(invocationPayload);
      writer.close();

      if (connection.getResponseCode() == HttpURLConnection.HTTP_CREATED) {
          return getSuccessMessage(connection);
      } else {
          return getErrorMessage(connection);
      }
  }

  private String invokeRestSTSInstanceDeletion(String deletionUrl)
      throws IOException {
      HttpURLConnection connection
       = (HttpURLConnection)new URL(deletionUrl).openConnection();
      connection.setDoOutput(true);
      connection.setRequestMethod("DELETE");
      connection.setRequestProperty(SharedSTSConstants.CONTENT_TYPE,
                                    SharedSTSConstants.APPLICATION_JSON);
      connection.setRequestProperty(COOKIE, getAdminSessionTokenCookie());
      connection.connect();

      if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
          return getSuccessMessage(connection);
      } else {
          return getErrorMessage(connection);
      }
  }

  private String getSuccessMessage(HttpURLConnection connection) throws IOException {
      return readInputStream(connection.getInputStream());
  }

  private String getErrorMessage(HttpURLConnection connection) throws IOException {
      if (connection.getErrorStream() != null) {
          return readInputStream(connection.getErrorStream());
      } else {
          return readInputStream(connection.getInputStream());
      }
  }

  private String getAdminSessionTokenCookie() {
      return "iPlanetDirectoryPro" + EQUALS + adminSessionId;
  }

  private String readInputStream(InputStream inputStream) throws IOException {
      if (inputStream == null) {
          return "Empty error stream";
      } else {
          return IOUtils.readStream(inputStream);
      }
  }

  private String parseInstanceUrl(String publishResponse) throws Exception {
      Object responseContent;
      try {
          org.codehaus.jackson.JsonParser parser =
           new org.codehaus.jackson.map.ObjectMapper()
               .getJsonFactory()
               .createJsonParser(publishResponse);
          responseContent = parser.readValueAs(Object.class);
      } catch (IOException e) {
          throw new Exception("Could not map the response from the PublishService
          to a json object. The response: " + publishResponse + "; The exception: " + e);
      }
      return new JsonValue(responseContent).get("url_element").asString();
  }

  private URL getPublishAddInstanceUri() throws MalformedURLException {
      return new URL(publishEndpoint + createAction);
  }

  private String getPublishRemoveInstanceUri(String stsId) throws URISyntaxException {
      return new UrlConstituentCatenatorImpl().catenateUrlConstituents(publishEndpoint,
                                                                       stsId);
  }

  private JsonValue buildPublishInvocationJsonValue(RestSTSInstanceConfig instanceConfig) {
     return json(object(field(AMSTSConstants.REST_STS_PUBLISH_INVOCATION_CONTEXT,
                              AMSTSConstants.REST_STS_PUBLISH_INVOCATION_CONTEXT_CLIENT_SDK),
                        field(AMSTSConstants.REST_STS_PUBLISH_INSTANCE_STATE,
                              instanceConfig.toJson())));
  }

  /**
   * This method creates the RestSTSInstanceConfig instance which determines the
   * nature of the published rest sts instance. Note that this method does not
   * take parameters corresponding to all options. It is there only to demonstrate
   * some of the options which could be set.
   * @param urlElement  The deployment url of the REST STS instance.
   * @param realm       The realm in which the rests-sts instance is deployed.
   *                    Note that the url of the published REST STS instance is
   *                    composed of the OpenAM deploymentUrl + realm + /urlElement.
   * @return            A RestSTSInstanceConfig configuring the published REST STS instance
   * @throws Exception  If something goes wrong
   */

   private RestSTSInstanceConfig createRestSTSInstanceConfig(String urlElement,
                                                             String realm) throws Exception {

   /**
       If you want to target a specific module or service for a particular token
       type, add it via the addMapping call below.
       See org.forgerock.openam.forgerockrest.authn.core.AuthIndexType for the
       list of valid authIndexType values (the second parameter in addMapping).
       The third parameter is simply the name of the specified module, service, etc.
       If you want to target the default service, don't add a mapping, or add a
       mapping corresponding to the default service, as below.
   */
   /**
       Build the context necessary for the OIDC token validation. The value in
       the map must correspond to the header which the OIDC module consults
       to obtain the oidc id token.
   */

   Map&lt;String, String&gt; oidcContext = new HashMap&lt;String, String&gt;();
   oidcContext.put(AMSTSConstants.OPEN_ID_CONNECT_ID_TOKEN_AUTH_TARGET_HEADER_KEY,
                   "oidc_id_token");
   /**
       Build the context necessary for Cert validation. The value in the map must
       correspond to the header which the Cert module consults to obtain the
       client's Certificate.
   */

   Map&lt;String, String&gt; certContext = new HashMap&lt;String, String&gt;();
   certContext.put(AMSTSConstants.X509_TOKEN_AUTH_TARGET_HEADER_KEY, "client_cert");
   AuthTargetMapping mapping = AuthTargetMapping.builder()
       .addMapping(TokenType.USERNAME, "service", "ldapService")
       .addMapping(TokenType.OPENIDCONNECT, "module", "oidc", oidcContext)
       .addMapping(TokenType.X509, "module", "cert_module", certContext)
       .build();
   RestDeploymentConfig.RestDeploymentConfigBuilder deploymentConfigBuilder =
    RestDeploymentConfig.builder()
       .uriElement(urlElement)
       .authTargetMapping(mapping)
       .realm(realm);

   /**
   If the clientCertHeader field is specified, this implies that the client cert
   for x509 transformations should be specified in a header field. If this is the
   case, then the set of IP addrs corresponding to the TLS offload engines must
   also be specified. Simply specify the ip addr of this client, as it is
   the one invoking token transformation functionality. If all hosts should be
   trusted, add 'any' to the list.
   */
   if (stsClientCertHeaderName != null) {
       Set&lt;String&gt; offloadHostsSet = new HashSet&lt;String&gt;();
       offloadHostsSet.add(InetAddress.getLocalHost().getHostAddress());
       offloadHostsSet.add("127.0.0.1");
       deploymentConfigBuilder
           .offloadedTwoWayTLSHeaderKey(stsClientCertHeaderName)
           .tlsOffloadEngineHostIpAddrs(offloadHostsSet);
   }
   RestDeploymentConfig deploymentConfig = deploymentConfigBuilder.build();
   SAML2Config saml2Config;
   try {
       Map&lt;String, String&gt; attributeMapping = new HashMap&lt;String, String&gt;();
       attributeMapping.put("email", "mail");
       saml2Config =
           SAML2Config.builder()
             .keystoreFile("/Users/DirkHogan/openam/openam/keystore.jks")  //Mac
           //.keystoreFile("/home/dhogan/openam/openam/keystore.jks") //linux
             .keystorePassword("changeit".getBytes(AMSTSConstants.UTF_8_CHARSET_ID))
             .encryptionKeyAlias("test")
             .signatureKeyAlias("test")
             .signatureKeyPassword("changeit".getBytes(AMSTSConstants.UTF_8_CHARSET_ID))
             .signAssertion(true)
             .encryptAssertion(true)
             .encryptionAlgorithm("http://www.w3.org/2001/04/xmlenc#aes128-cbc")
             .encryptionAlgorithmStrength(128)
             .attributeMap(attributeMapping)
             .nameIdFormat("urn:oasis:names:tc:SAML:2.0:nameid-format:persistent")
             .spEntityId(spEntityId)
             .spAcsUrl(spACSEndpoint)
             //custom statement providers could also be specified.
             .build();
   } catch (UnsupportedEncodingException e) {
       throw new Exception(e);
   }
   return RestSTSInstanceConfig.builder()
       .deploymentConfig(deploymentConfig)
       .saml2Config(saml2Config)
       .issuerName(idpEntityId)
       .addSupportedTokenTranslation(
           TokenType.USERNAME,
           TokenType.SAML2,
           AMSTSConstants.INVALIDATE_INTERIM_OPENAM_SESSION)
       .addSupportedTokenTranslation(
           TokenType.OPENAM,
           TokenType.SAML2,
           !AMSTSConstants.INVALIDATE_INTERIM_OPENAM_SESSION)
       .addSupportedTokenTranslation(
           TokenType.OPENIDCONNECT,
           TokenType.SAML2,
           AMSTSConstants.INVALIDATE_INTERIM_OPENAM_SESSION)
       .addSupportedTokenTranslation(
           TokenType.X509,
           TokenType.SAML2,
           AMSTSConstants.INVALIDATE_INTERIM_OPENAM_SESSION)
       .build();
   }
}
  </pre><p>
   The following code example shows how to consume REST STS token transformations.
  </p><pre class="brush: plain;">
package org.forgerock.openam.sts.rest;
import org.forgerock.json.fluent.JsonValue;
import org.forgerock.openam.shared.sts.SharedSTSConstants;
import org.forgerock.openam.sts.AMSTSConstants;
import org.forgerock.openam.sts.service.invocation.OpenAMTokenState;
import org.forgerock.openam.sts.service.invocation.OpenIdConnectTokenState;
import org.forgerock.openam.sts.service.invocation.ProofTokenState;
import org.forgerock.openam.sts.service.invocation.RestSTSServiceInvocationState;
import org.forgerock.openam.sts.service.invocation.SAML2TokenState;
import org.forgerock.openam.sts.service.invocation.UsernameTokenState;
import org.forgerock.openam.sts.service.invocation.X509TokenState;
import org.forgerock.openam.sts.token.SAML2SubjectConfirmation;
import org.forgerock.openam.utils.IOUtils;
import org.forgerock.util.encode.Base64;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.security.cert.X509Certificate;

/**
 * This class demonstrates consumption of REST STS token transformations.
 */

public class RestSTSConsumer {
    private static final boolean INSERT_X509_CERT_IN_HEADER = true;
    private final URL restSTSInstanceUrl;
    private final String stsClientCertHeaderName;
    /**
     *
     * @param restSTSInstanceTranslateUrl The full url of the REST STS instance,
     *        with the translate action specified. For example, for a REST STS
     *        instance with a deployment url of instanceId, published to the root
     *        realm, the url would be:
     *        http://amhost.com:8080/openam/rest-sts/instanceId?_action=translate
     *        A REST STS instance published to realm fred with a deployment
     *        url of instanceId2, the url would be:
     *        http://amhost.com:8080/openam/rest-sts/fred/instanceId2?_action=translate
     *        A REST STS instance published to realm bobo, a subrealm of fred
     *        with a deployment url of instanceId3, the url would be:
     *        http://amhost.com:8080/openam/rest-sts/fred/bobo/instanceId3?_action=translate
     * @param stsClientCertHeaderName The header name, configured for the REST STS instance,
     *                                where this instance expects to find the client's cert.
     *                                Necessary for x509-&gt;SAML2 token transformations
     * @throws MalformedURLException  In case the specified restSTSInstanceTranslateUrl
     *                                is mal-formed.
     */
   public RestSTSConsumer(String restSTSInstanceTranslateUrl,
                          String stsClientCertHeaderName) throws MalformedURLException {
       this.stsClientCertHeaderName = stsClientCertHeaderName;
       restSTSInstanceUrl = new URL(restSTSInstanceTranslateUrl);
       System.out.println("RestSTSConsumer consumes the REST STS at url: "
        + restSTSInstanceUrl.toString());
   }
   /**
   * Invokes a UsernameToken-&gt;SAML2 token transformation.
   *
   * Sample json posted at the REST STS instance in this method:
   * {
   *    "input_token_state": {
   *       "token_type": "USERNAME",
   *       "username": "user",
   *       "password": "userpassword"
   *    },
   *    "output_token_state": {
   *       "token_type": "SAML2",
   *       "subject_confirmation": "BEARER"
   *    }
   * }
   *
   * @param username The username in the UsernameToken
   * @param password The password in the UsernameToken
   * @param subjectConfirmation The SAML2 SubjectConfirmation.
   *                            For HoK, the certificate in the file /cert.jks
   *                            on the classpath is included.
   * @return The string representation of the SAML2 Assertion
   * @throws Exception If transformation fails
   */

   public String transformUntToSAML2(String username, String password,
                                     SAML2SubjectConfirmation subjectConfirmation)
                                     throws Exception {
       UsernameTokenState untState = UsernameTokenState.builder()
           .username(username.getBytes(AMSTSConstants.UTF_8_CHARSET_ID))
           .password(password.getBytes(AMSTSConstants.UTF_8_CHARSET_ID))
           .build();
   RestSTSServiceInvocationState invocationState = RestSTSServiceInvocationState.builder()
       .inputTokenState(untState.toJson())
       .outputTokenState(buildSAML2TokenState(subjectConfirmation).toJson())
       .build();
   final String response = invokeTokenTranslation(invocationState.toJson().toString(),
                                                  !INSERT_X509_CERT_IN_HEADER);
   return parseTokenResponse(response);
   }

   /**
   * Invokes a OpenAMToken-&gt;SAML2 token transformation.
   *
   * Sample json posted at the REST STS instance in this method:
   * {
   *    "input_token_state": {
   *       "token_type": "OPENAM",
   *       "session_id": "AQI...NDI4NTUxMTQ3NDY5Ng..*"
   *    },
   *    "output_token_state": {
   *       "token_type": "SAML2",
   *       "subject_confirmation": "BEARER"
   *    }
   * }
   *
   * @param sessionId the OpenAM session ID. Corresponds to the iPlanetDirectoryPro
   *                                         (or equivalent) cookie.
   * @param subjectConfirmation The SAML2 SubjectConfirmation. For HoK, the certificate
   *                            in the file /cert.jks on the classpath is included.
   * @return The string representation of the SAML2 Assertion
   * @throws Exception If transformation fails
   */

   public String transformOpenAMToSAML2(String sessionId,
                                        SAML2SubjectConfirmation subjectConfirmation)
                                        throws Exception {
       OpenAMTokenState sessionState = OpenAMTokenState.builder()
           .sessionId(sessionId)
           .build();
       RestSTSServiceInvocationState invocationState = RestSTSServiceInvocationState
           .builder()
           .inputTokenState(sessionState.toJson())
           .outputTokenState(buildSAML2TokenState(subjectConfirmation).toJson())
           .build();
   final String response = invokeTokenTranslation(invocationState.toJson().toString(),
                                                  !INSERT_X509_CERT_IN_HEADER);
   return parseTokenResponse(response);
   }

   /**
   * Invokes a OIDCToken-&gt;SAML2 token transformation
   * Sample json posted at the REST STS instance in this method (HoK SubjectConfirmation,
   * with token elements truncated):
   * {
   *    "input_token_state": {
   *       "token_type": "OPENIDCONNECT",
   *       "oidc_id_token": "eyAiYWxQ.euTNnNDExNTkyMjEyIH0.kuNlKwyvZJqaC8EYpDyPJMiEcII"
   *    },
   *    "output_token_state": {
   *       "token_type": "SAML2",
   *       "subject_confirmation": "HOLDER_OF_KEY",
   *       "proof_token_state": {
   *        "base64EncodedCertificate": "MIMbFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5pimrW0Y0Q=="
   *       }
   *    }
   * }
   * @param oidcTokenValue The OpenIdConnect ID token. Note that the targeted
   *                       REST STS instance has to be deployed with a
   *                       AuthTargetMapping which references an instance of the
   *                       OIDC module with configuration state necessary to
   *                       validate an OIDC token from a specific issuer.
   * @param subjectConfirmation The SAML2 SubjectConfirmation. For HoK, the
   *                            certificate in the file /cert.jks on the
   *                            classpath is included.
   * @return The string representation of the SAML2 Assertion
   * @throws Exception If transformation fails
   */
   public String transformOpenIdConnectToSAML2(SAML2SubjectConfirmation subjectConfirmation,
                                               String oidcTokenValue)
                                               throws Exception {
       OpenIdConnectTokenState tokenState = OpenIdConnectTokenState
           .builder()
           .tokenValue(oidcTokenValue)
           .build();
       RestSTSServiceInvocationState invocationState = RestSTSServiceInvocationState
           .builder()
           .inputTokenState(tokenState.toJson())
           .outputTokenState(buildSAML2TokenState(subjectConfirmation).toJson())
           .build();
       final String response = invokeTokenTranslation(invocationState.toJson().toString(),
                                                      !INSERT_X509_CERT_IN_HEADER);
       return parseTokenResponse(response);
   }

   /**
   * Invokes a X509-&gt;SAML2 token transformation
   *
   * Sample json posted at the REST STS instance in this method:
   * {
   *    "input_token_state": {
   *       "token_type": "X509"
   *    },
   *    "output_token_state": {
   *       "token_type": "SAML2",
   *       "subject_confirmation": "SENDER_VOUCHES"
   *    }
   * }
   *
   * Note that the targeted REST STS module has to be deployed with an
   * AuthTargetMapping that references an instance of the Certificate module
   * configured to reference the client's certificate from the header specified
   * in the AuthTargetMapping, and configured to trust the local OpenAM instance.
   * In addition, the "Certificate Field Used to Access User Profile" should be set
   * to subject CN. The CN used in the test cert deployed with OpenAM, and used
   * in this integration test, is 'test', so a subject with a uid of "test" has
   * to be created for account mapping to work. Likewise the published REST STS
   * instance must also be configured to trust the host running this test, and must
   * be configured to reference the client's certificate in the header specified
   * by stsClientCertHeaderName (unless the REST STS is being consumed via
   * two-way-TLS, in which case the stsClientCertHeaderName is irrelevant,
   * as the REST STS references the client's certificate via the
   * javax.servlet.request.X509Certificate ServletRequest attribute.
   *
   * @param subjectConfirmation The SAML2 SubjectConfirmation. For HoK, the certificate
   *                            in the file /cert.jks on the classpath is included.
   * @return The string representation of the SAML2 Assertion
   * @throws Exception If transformation fails
   */

   public String transformX509ToSAML2(SAML2SubjectConfirmation subjectConfirmation)
    throws Exception {
       X509TokenState tokenState = new X509TokenState();
       RestSTSServiceInvocationState invocationState = RestSTSServiceInvocationState
           .builder()
           .inputTokenState(tokenState.toJson())
           .outputTokenState(buildSAML2TokenState(subjectConfirmation).toJson())
           .build();
       final String response = invokeTokenTranslation(invocationState.toJson().toString(),
                                                      INSERT_X509_CERT_IN_HEADER);
       return parseTokenResponse(response);
   }
   private SAML2TokenState buildSAML2TokenState(SAML2SubjectConfirmation subjectConfirmation)
    throws Exception {
       if (SAML2SubjectConfirmation.HOLDER_OF_KEY.equals(subjectConfirmation)) {
           ProofTokenState proofTokenState = ProofTokenState
               .builder()
               .x509Certificate(getCertificate())
               .build();
           return SAML2TokenState.builder()
               .saml2SubjectConfirmation(subjectConfirmation)
               .proofTokenState(proofTokenState)
               .build();
       } else {
           return SAML2TokenState.builder()
               .saml2SubjectConfirmation(subjectConfirmation)
               .build();
       }
   }

   private String getEncodedCertificate() throws IOException, CertificateException {
       return Base64.encode(getCertificate().getEncoded());
   }

   private X509Certificate getCertificate() throws IOException, CertificateException {
       return (X509Certificate) CertificateFactory.getInstance("X.509")
                                    .generateCertificate(getClass()
                                    .getResourceAsStream("/cert.jks"));
   }

   private String invokeTokenTranslation(String invocationPayload,
                                         boolean insertX509CertInHeader)
    throws IOException, CertificateException {
       HttpURLConnection connection = (HttpURLConnection)restSTSInstanceUrl.openConnection();
       connection.setDoOutput(true);
       connection.setRequestMethod("POST");
       connection.setRequestProperty(SharedSTSConstants.CONTENT_TYPE,
                                     SharedSTSConstants.APPLICATION_JSON);
       if (insertX509CertInHeader) {
           connection.setRequestProperty(stsClientCertHeaderName, getEncodedCertificate());
       }
       OutputStreamWriter writer = new OutputStreamWriter(connection.getOutputStream());
       writer.write(invocationPayload);
       writer.close();
       if (connection.getResponseCode() == HttpURLConnection.HTTP_CREATED) {
           return getSuccessMessage(connection);
       } else {
           return getErrorMessage(connection);
       }
   }

   private String getSuccessMessage(HttpURLConnection connection) throws IOException {
       return readInputStream(connection.getInputStream());
   }

   private String getErrorMessage(HttpURLConnection connection) throws IOException {
       if (connection.getErrorStream() != null) {
           return readInputStream(connection.getErrorStream());
       } else {
           return readInputStream(connection.getInputStream());
       }
   }

   private String readInputStream(InputStream inputStream) throws IOException {
       if (inputStream == null) {
           return "Empty error stream";
       } else {
           return IOUtils.readStream(inputStream);
       }
   }

   private String parseTokenResponse(String response) throws Exception {
       Object responseContent;
       try {
           org.codehaus.jackson.JsonParser parser =
            new org.codehaus.jackson.map.ObjectMapper()
                .getJsonFactory()
                .createJsonParser(response);
           responseContent = parser.readValueAs(Object.class);
       } catch (IOException e) {
           throw new Exception("Could not map the response from the rest-sts instance at url "
              + restSTSInstanceUrl + " to a json object. The response: "
              + response + "; The exception: " + e);
       }
       JsonValue assertionJson =
        new JsonValue(responseContent).get(AMSTSConstants.ISSUED_TOKEN);
       if (assertionJson.isNull() || !assertionJson.isString()) {
           throw new Exception("The json response returned from the rest-sts instance at url "
              + restSTSInstanceUrl + " did not have a non-null string  element for the "
              + AMSTSConstants.ISSUED_TOKEN + " key. The json: "
              + responseContent.toString());
       }
       return assertionJson.asString();
   }
}
  </pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-jdk"></a>Chapter&nbsp;9.&nbsp;Using the OpenAM Java SDK</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#install-jdk-samples">9.1. Installing OpenAM Client SDK Samples</a></span></dt><dt><span class="section"><a href="#about-jdk">9.2. About the OpenAM Java SDK</a></span></dt></dl></div><p>This chapter introduces OpenAM Java SDK. OpenAM Java SDK is delivered
 with the full version of OpenAM,
 <code class="filename">OpenAM-12.0.0.zip</code>.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install-jdk-samples"></a>9.1.&nbsp;Installing OpenAM Client SDK Samples</h2></div></div></div><a class="indexterm" name="d13846e7904"></a><p>The full OpenAM download,
  <code class="filename">OpenAM-12.0.0.zip</code>, contains the Java Client
  SDK library, <code class="filename">ClientSDK-12.0.0.jar</code>, as well as
  samples for use on the command line in
  <code class="filename">ExampleClientSDK-CLI-12.0.0.zip</code>, and samples in a
  web application, <code class="filename">ExampleClientSDK-WAR-12.0.0.war</code>.
  The <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Java
  SDK API Specification</em></a> provides a reference to the public
  APIs.</p><div class="procedure"><a name="deploy-client-sdk-war"></a><div class="procedure-title">Procedure&nbsp;9.1.&nbsp;To Deploy the Sample Web Application</div><p>The sample web application deploys in your container to show you
   the client SDK samples in action.</p><ol class="procedure" type="1"><li class="step"><p>Deploy the .war in your Java web application container such as
    Apache Tomcat or JBoss.</p><div class="screen"><pre>
$ <strong>cp ExampleClientSDK-WAR-12.0.0.war /path/to/tomcat/webapps/client.war</strong>
    </pre></div></li><li class="step"><p>
     If you have run this procedure before, make sure to deploy a fresh
     copy of the .war file to a different location, such as
     <code class="filename">/path/to/tomcat/webapps/client1.war</code>
    </p></li><li class="step"><p>Browse to the location where you deployed the client, and configure
    the application to access OpenAM using the application user name,
    <code class="literal">UrlAccessAgent</code>, and password configured when you set up
    OpenAM.</p><div class="mediaobject" align="center"><a name="figure-config-client-sdk-war"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/config-client-sdk-war.png" align="middle" height="360" alt="Sample web app configuration screen"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-config-client-sdk-war.html" target="longdesc">D</a>]</span></div></div><div class="variablelist"><p>Use the following hints to complete the configuration.</p><dl class="variablelist"><dt><span class="term">Server Protocol</span></dt><dd><p>Protocol to access OpenAM (<code class="literal">http</code> or
       <code class="literal">https</code>)</p></dd><dt><span class="term">Server Host</span></dt><dd><p>Fully qualified domain name for OpenAM, such as
       <code class="literal">openam.example.com</code></p></dd><dt><span class="term">Server Port</span></dt><dd><p>OpenAM port number such as 8080 or 8443</p></dd><dt><span class="term">Server Deployment URI</span></dt><dd><p>URI entry point to OpenAM such as <code class="literal">/openam</code></p></dd><dt><span class="term">Debug directory</span></dt><dd><p>Where to write the debug messages for the client samples</p></dd><dt><span class="term">Application user name</span></dt><dd><p>An user agent configured to access OpenAM, such as
       <code class="literal">UrlAccessAgent</code> set up when OpenAM was installed</p></dd><dt><span class="term">Application user password</span></dt><dd><p>The user agent password</p></dd></dl></div><p>The sample client writes configuration information under
    <code class="filename">$HOME/OpenAMClient/</code>, where $HOME is that of the user
    running the web application container.</p></li><li class="step"><p>Verify that you have properly configured the sample web application.</p><ol type="a" class="substeps"><li class="step"><p>In another browser tab page of the same browser instance, login to
      OpenAM as the OpenAM Administrator, <code class="literal">amadmin</code>.</p><p>This signs you into OpenAM, storing the cookie in your browser.</p></li><li class="step"><p>On the Samples tab page, click the link under Single Sign On Token
      Verification Servlet.</p><p>If the sample web application is properly configured, you should
      see something like the following text in your browser.</p><pre class="brush: plain;">SSOToken host name: 127.0.0.1
SSOToken Principal name: id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org
Authentication type used: DataStore
IPAddress of the host: 127.0.0.1
SSO Token validation test succeeded
The token id is AQIC5...CMDEAAlNLABQtODY0Mjc5MDUwNDQzOTA2MzYxNg..*
...
User Attributes: {... givenName=[amAdmin], ...roles=[Top-level Admin Role], ...}</pre></li></ol></li></ol></div><div class="procedure"><a name="build-cli-samples"></a><div class="procedure-title">Procedure&nbsp;9.2.&nbsp;To Build the Command-Line Sample Applications</div><p>Follow these steps to set up the command-line examples.</p><ol class="procedure" type="1"><li class="step"><p>Unpack the sample applications and related libraries.</p><div class="screen"><pre>
$ <strong>mkdir sdk &amp;&amp; cd sdk</strong>
$ <strong>unzip ~/Downloads/ExampleClientSDK-CLI-12.0.0.zip</strong>
    </pre></div></li><li class="step"><p>Configure the samples to access OpenAM.</p><div class="screen"><pre>
$ <strong>sh scripts/setup.sh</strong>
<em>Debug directory (make sure this directory exists):</em> <strong>/Users/me/openam/openam/debug</strong>
<em>Application user (e.g. URLAccessAgent) password:</em> <strong>secret12</strong>
<em>Protocol of the server:</em> <strong>http</strong>
<em>Host name of the server:</em> <strong>openam.example.com</strong>
<em>Port of the server:</em> <strong>8080</strong>
<em>Server's deployment URI:</em> <strong>openam</strong>
<em>Naming URL (hit enter to accept default value,
 http://openam.example.com:8080/openam/namingservice):</em>
$</pre></div></li><li class="step"><p>Verify that you have properly configured the samples.</p><div class="screen"><pre>
$ <strong>sh scripts/Login.sh</strong>
<em>Realm (e.g. /):</em> <strong>/</strong>
<em>Login module name (e.g. DataStore or LDAP):</em> <strong>DataStore</strong>
<em>Login locale (e.g. en_US or fr_FR):</em> <strong>fr_FR</strong>
<em>DataStore: Obtained login context</em>
<em>Nom d'utilisateur&nbsp;:</em><strong>demo</strong>
<em>Mot de passe&nbsp;:</em><strong>changeit</strong>
<em>Login succeeded.
Logged Out!!</em></pre></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-jdk"></a>9.2.&nbsp;About the OpenAM Java SDK</h2></div></div></div><div class="itemizedlist"><p>After installing the Java SDK command line samples, you see the
   following content.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">lib/</code>: SDK and other libraries</p></li><li class="listitem"><p><code class="filename">resources/</code>: properties configuration files for
    the SDK and samples</p></li><li class="listitem"><p><code class="filename">scripts/</code>: scripts to run the samples</p></li><li class="listitem"><p><code class="filename">source/</code>: sample code</p></li></ul></div><p>After deploying the Java SDK web application archive, you find the
  following content where the .war file was unpacked.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">META-INF/</code>: build information</p></li><li class="listitem"><p><code class="filename">WEB-INF/</code>: sample classes and libraries</p></li><li class="listitem"><p><code class="filename">console/</code>: images for sample UI</p></li><li class="listitem"><p><code class="filename">index.html</code>: sample home page</p></li><li class="listitem"><p><code class="filename">keystore.jks</code>: OpenAM test certificate, alias:
    <code class="literal">test</code>, key store password: <code class="literal">changeit</code></p></li><li class="listitem"><p><code class="filename">policy/</code>: Policy Evaluator Client Sample page</p></li><li class="listitem"><p><code class="filename">saml2/</code>: Secure Attribute Exchange example</p></li><li class="listitem"><p><code class="filename">sample.css</code>: sample styles</p></li><li class="listitem"><p><code class="filename">sm/</code>: Service Configuration sample</p></li><li class="listitem"><p><code class="filename">um/</code>: User Profile sample</p></li></ul></div><div class="itemizedlist"><a name="jdk-shutdown-hooks"></a><div class="itemizedlist-title">Registering Your Java SDK Client to Shut Down Gracefully</div><p>When writing a client using the OpenAM Java SDK, make sure you register
    hooks to make sure the application can be shut down gracefully. How you
    register for shutdown depends on the type of application.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For Java EE applications, make sure the OpenAM client SDK shuts down
    successfully by including the following context listener in your
    application's <code class="filename">web.xml</code> file.</p><pre class="brush: xml;">&lt;listener&gt;
 &lt;listener-class&gt;
  com.sun.identity.common.ShutdownServletContextListener
 &lt;/listener-class&gt;
&lt;/listener&gt;</pre></li><li class="listitem"><p>For standalone applications, set the following JVM property.</p><pre class="literallayout">-Dopenam.runtime.shutdown.hook.enabled=true</pre></li></ul></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-authentication"></a>Chapter&nbsp;10.&nbsp;Authenticating Using OpenAM Java SDK</h1></div></div></div><a class="indexterm" name="d13846e8252"></a><p>This chapter looks at authentication with the OpenAM Java SDK and at the
 sample client, <code class="filename">Login.java</code>, which demonstrates
 authenticating to OpenAM from a client application, provided a realm, user
 name, and password. This is the sample you ran to test installation of the
 command-line SDK samples. The class shown in this chapter is
 <code class="literal">com.sun.identity.samples.authentication.Login</code>.</p><p>Before you continue, make sure that the packages described in the
  <a href="../dev-guide/index.html#chap-jdk" class="link">Using the OpenAM Java SDK</a>
  chapter are installed.</p><div class="orderedlist"><p>With OpenAM, your client application performs the following steps
  to handle authentication.</p><ol class="orderedlist" type="1"><li class="listitem"><p>Sets up an <code class="literal">AuthContext</code>, based on the realm in
   which the user authenticates.</p></li><li class="listitem"><p>Starts the login process by calling the <code class="literal">AuthContext</code>
   <code class="literal">login()</code> method.</p></li><li class="listitem"><p>Handling authentication callbacks to retrieve credentials from the
   user who is authenticating.</p><p>Your application loops through the authentication callbacks by using
   the <code class="literal">AuthContext</code> <code class="literal">getRequirements()</code> and
   <code class="literal">hasMoreRequirements()</code> methods. Each time it finishes
   populating a callback with the credentials retrieved, your application calls
   <code class="literal">submitRequirements()</code> to send the credentials to
   OpenAM's Authentication Service.</p></li><li class="listitem"><p>After handling all authentication callbacks, your application
   calls the <code class="literal">AuthContext</code> <code class="literal">getStatus()</code>
   method.</p><p>On login success, OpenAM sets up an <code class="literal">SSOToken</code> that
   holds information about the authentication, and also about the user's
   environment and session.</p></li><li class="listitem"><p>When the user logs out, your application can end the session by
   calling the <code class="literal">AuthContext</code> <code class="literal">logout()</code>
   method.</p></li></ol></div><p>The <code class="literal">AuthContext</code> class is provided by the
 <code class="literal">com.sun.identity.authentication</code> package, part of the
 OpenAM client API. Callback classes are provided by the
 <code class="literal">javax.security.auth.callback</code> package, which provides
 callbacks for choices, confirmations, locales, names, passwords, text input,
 and text output.</p><p>See the <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Public API JavaDoc</em></a> for
 reference.</p><p>As the sample client gets the realm (called organization in the sample),
 locale, and authentication module to set up the authentication context,
 there is not need for a language callback to get the local afterwards. The
 <code class="filename">Login.java</code> example does, however, show simple ways of
 handling callbacks for the command-line context. The implementation of
 the sample client follows.</p><pre class="brush: java;">package com.sun.identity.samples.authentication;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.ChoiceCallback;
import javax.security.auth.callback.NameCallback;
import javax.security.auth.callback.PasswordCallback;
import javax.security.auth.callback.TextInputCallback;
import javax.security.auth.callback.TextOutputCallback;
import javax.security.auth.callback.UnsupportedCallbackException;
import com.sun.identity.authentication.AuthContext;
import com.sun.identity.authentication.spi.AuthLoginException;
import com.sun.identity.shared.debug.Debug;

public class Login {
    private String loginIndexName;
    private String orgName;
    private String locale;
    
    private Login(String loginIndexName, String orgName) {
        this.loginIndexName = loginIndexName;
        this.orgName = orgName;
    }
    
    private Login(String loginIndexName, String orgName, String locale) {
        this.loginIndexName = loginIndexName;
        this.orgName = orgName;
        this.locale = locale;
    }
    
    protected AuthContext getAuthContext()
        throws AuthLoginException {
        AuthContext lc = new AuthContext(orgName);
        AuthContext.IndexType indexType = AuthContext.IndexType.MODULE_INSTANCE;
        if (locale == null || locale.length() == 0) {
            lc.login(indexType, loginIndexName);
        } else {
            lc.login(indexType, loginIndexName, locale);
        }
        debugMessage(loginIndexName + ": Obtained login context");
        return lc;
    }
    
    private void addLoginCallbackMessage(Callback[] callbacks)
    throws UnsupportedCallbackException {
        int i = 0;
        try {
            for (i = 0; i &lt; callbacks.length; i++) {
                if (callbacks[i] instanceof TextOutputCallback) {
                    handleTextOutputCallback((TextOutputCallback)callbacks[i]);
                } else if (callbacks[i] instanceof NameCallback) {
                    handleNameCallback((NameCallback)callbacks[i]);
                } else if (callbacks[i] instanceof PasswordCallback) {
                    handlePasswordCallback((PasswordCallback)callbacks[i]);
                } else if (callbacks[i] instanceof TextInputCallback) {
                    handleTextInputCallback((TextInputCallback)callbacks[i]);
                } else if (callbacks[i] instanceof ChoiceCallback) {
                    handleChoiceCallback((ChoiceCallback)callbacks[i]);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
            throw new UnsupportedCallbackException(callbacks[i],e.getMessage());
        }
    }
    
    private void handleTextOutputCallback(TextOutputCallback toc) {
        debugMessage("Got TextOutputCallback");
        // display the message according to the specified type
        
        switch (toc.getMessageType()) {
            case TextOutputCallback.INFORMATION:
                debugMessage(toc.getMessage());
                break;
            case TextOutputCallback.ERROR:
                debugMessage("ERROR: " + toc.getMessage());
                break;
            case TextOutputCallback.WARNING:
                debugMessage("WARNING: " + toc.getMessage());
                break;
            default:
                debugMessage("Unsupported message type: " +
                    toc.getMessageType());
        }
    }
    
    private void handleNameCallback(NameCallback nc)
        throws IOException {
        // prompt the user for a username
        System.out.print(nc.getPrompt());
        System.out.flush();
        nc.setName((new BufferedReader
            (new InputStreamReader(System.in))).readLine());
    }
    
    private void handleTextInputCallback(TextInputCallback tic)
        throws IOException {
        // prompt for text input
        System.out.print(tic.getPrompt());
        System.out.flush();
        tic.setText((new BufferedReader
            (new InputStreamReader(System.in))).readLine());
    }
    
    private void handlePasswordCallback(PasswordCallback pc)
        throws IOException {
        // prompt the user for sensitive information
        System.out.print(pc.getPrompt());
        System.out.flush();
        String passwd = (new BufferedReader(new InputStreamReader(System.in))).
            readLine();
        pc.setPassword(passwd.toCharArray());
    }
    
    private void handleChoiceCallback(ChoiceCallback cc)
        throws IOException {
        // ignore the provided defaultValue
        System.out.print(cc.getPrompt());
        
        String[] strChoices = cc.getChoices();
        for (int j = 0; j &lt; strChoices.length; j++) {
            System.out.print("choice[" + j + "] : " + strChoices[j]);
        }
        System.out.flush();
        cc.setSelectedIndex(Integer.parseInt((new BufferedReader
            (new InputStreamReader(System.in))).readLine()));
    }
    
    protected boolean login(AuthContext lc)
        throws UnsupportedCallbackException {
        boolean succeed = false;
        Callback[] callbacks = null;
        
        // get information requested from module
        while (lc.hasMoreRequirements()) {
            callbacks = lc.getRequirements();
            if (callbacks != null) {
                addLoginCallbackMessage(callbacks);
                lc.submitRequirements(callbacks);
            }
        }
        
        if (lc.getStatus() == AuthContext.Status.SUCCESS) {
            System.out.println("Login succeeded.");
            succeed = true;
        } else if (lc.getStatus() == AuthContext.Status.FAILED) {
            System.out.println("Login failed.");
        } else {
            System.out.println("Unknown status: " + lc.getStatus());
        }
        
        return succeed;
    }
    
    protected void logout(AuthContext lc)
        throws AuthLoginException {
        lc.logout();
        System.out.println("Logged Out!!");
    }
    
    static void debugMessage(String msg) {
        System.out.println(msg);
    }
    
    public static void main(String[] args) {
        try {
            System.out.print("Realm (e.g. /): ");
            String orgName = (new BufferedReader(
                new InputStreamReader(System.in))).readLine();

            System.out.print("Login module name (e.g. DataStore or LDAP): ");
            String moduleName = (new BufferedReader(
                new InputStreamReader(System.in))).readLine();
            
            System.out.print("Login locale (e.g. en_US or fr_FR): ");
            String locale = (new BufferedReader(
                new InputStreamReader(System.in))).readLine();
            
            Login login = new Login(moduleName, orgName, locale);
            AuthContext lc = login.getAuthContext();
            if (login.login(lc)) {
                login.logout(lc);
            }
        } catch (IOException e) {
            e.printStackTrace();
        } catch (AuthLoginException e) {
            e.printStackTrace();
        } catch (UnsupportedCallbackException e) {
            e.printStackTrace();
        }
        System.exit(0);
    }
}</pre></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-session"></a>Chapter&nbsp;11.&nbsp;Handling Single Sign-On Using OpenAM Java SDK</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#session-receiving-notifications">11.1. Receiving Notifications</a></span></dt></dl></div><a class="indexterm" name="d13846e8356"></a><p>This chapter looks at handling session tokens with the OpenAM Java SDK.
 The class shown in this chapter is
 <code class="literal">com.sun.identity.samples.sso.SSOTokenSample</code>.</p><p>When a user authenticates successfully, OpenAM sets up a single sign-on
 (SSO) session for the user. The session is associated with an SSO token that
 holds information about the authentication, and also about the user's
 environment and session. OpenAM deletes the session when the authentication
 context <code class="literal">logout()</code> method is called, or when a session timeout
 is reached. At that point the SSO token is no longer valid.</p><p>Before you continue, make sure that the packages described in the
   <a href="../dev-guide/index.html#chap-jdk" class="link">Using the OpenAM Java SDK</a>
   chapter are installed.</p><p>When your application has an <code class="literal">AuthContext</code> after
 successful authentication, you can retrieve the SSO token from the context.
 You also can get the token as shown in the sample client by passing an SSO
 token ID from OpenAM to an <code class="literal">SSOTokenManager</code>.</p><p>If your application needs to be notified of changes, you can register
 an <code class="literal">SSOTokenListener</code> on the token by using the token's
 <code class="literal">addSSOTokenListener()</code> method. OpenAM then calls your
 <code class="literal">SSOTokenListener</code> <code class="literal">ssoTokenChanged()</code>
 method when the session times out, is disposed of, or has a property that
 changes.</p><p>The sample client takes an SSO token ID to get the token from OpenAM,
 and then displays some information from the SSO token. The implementation of
 the sample client follows.</p><pre class="brush: java;">package com.sun.identity.samples.sso;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.IOException;
import java.net.InetAddress;
import com.iplanet.sso.SSOException;
import com.iplanet.sso.SSOToken;
import com.iplanet.sso.SSOTokenID;
import com.iplanet.sso.SSOTokenManager;

public class SSOTokenSample {
    private SSOTokenManager manager;
    private SSOToken token;

    private SSOTokenSample(String tokenID)
        throws SSOException
    {
        if (validateToken(tokenID)) {
            setGetProperties(token);
        }
    }

    private boolean validateToken(String tokenID)
        throws SSOException
    {
        boolean validated = false;
        manager = SSOTokenManager.getInstance();
        token = manager.createSSOToken(tokenID);

        // isValid method returns true for valid token.
        if (manager.isValidToken(token)) {
                // let us get all the values from the token
            String host = token.getHostName();
            java.security.Principal principal = token.getPrincipal();
            String authType = token.getAuthType();
            int level = token.getAuthLevel();
            InetAddress ipAddress = token.getIPAddress();
            long maxTime = token.getMaxSessionTime();
            long idleTime = token.getIdleTime();
            long maxIdleTime = token.getMaxIdleTime();
                
            System.out.println("SSOToken host name: " + host);
            System.out.println("SSOToken Principal name: " +
                principal.getName());
            System.out.println("Authentication type used: " + authType);
            System.out.println("IPAddress of the host: " +
                ipAddress.getHostAddress());
            validated = true;
        }

        return validated;
    }

    private void setGetProperties(SSOToken token)
        throws SSOException
    {
        /*
         * Validate the token again, with another method
         * if token is invalid, this method throws an exception
         */
        manager.validateToken(token);
        System.out.println("SSO Token validation test Succeeded.");
            
        // Get the SSOTokenID associated with the token and print it.
        SSOTokenID id = token.getTokenID();
        String tokenId = id.toString();
        System.out.println("Token ID: " + tokenId);

        // Set and get properties in the token.
        token.setProperty("TimeZone", "PST");
        token.setProperty("County", "SantaClara");
        String tZone = token.getProperty("TimeZone");
        String county = token.getProperty("County");

        System.out.println("Property: TimeZone: " + tZone); 
        System.out.println("Property: County: " + county); 
    }

    public static void main(String[] args) {
        try {
            System.out.print("Enter SSOToken ID: ");
            String ssoTokenID = (new BufferedReader(
                new InputStreamReader(System.in))).readLine();
            new SSOTokenSample(ssoTokenID.trim());
        } catch (SSOException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
        System.exit(0);
    }

}</pre><p>Before you run the script that calls the sample, authenticate to OpenAM
 in order to have OpenAM generate the SSO token ID. To see the SSO token ID,
 use the RESTful <code class="literal">authenticate</code> command as shown in the
 following example, or alternatively run the
 <code class="literal">SSOTokenSampleServlet</code> web-based sample.</p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "username=demo&amp;password=changeit" \
 http://openam.example.com:8080/openam/identity/authenticate</strong>
<em>token.id=AQIC5wM2LY4Sfcyy10grl...AlNLABQtNjI4OTkyNTUxNTc4MDQ3NzEzOQ..*</em>
$ <strong>sh scripts/SSOTokenSample.sh</strong>
<em>Enter SSOToken ID:</em> <strong>AQIC5wM2LY4Sfcyy10grl...AlNLABQtNjI4OTkyNTUxNTc4MDQ3NzEzOQ..*</strong>
<em>SSOToken host name: 172.16.203.239
SSOToken Principal name: id=demo,ou=user,dc=openam,dc=forgerock,dc=org
Authentication type used: DataStore
IPAddress of the host: 172.16.203.239
SSO Token validation test Succeeded.
Token ID: AQIC5wM2LY4Sfcyy10grl...AlNLABQtNjI4OTkyNTUxNTc4MDQ3NzEzOQ..*
Property: TimeZone: PST
Property: County: SantaClara</em>
 </pre></div><p>Notice both the properties populated by OpenAM, and also the two
 properties, <code class="literal">TimeZone</code> and <code class="literal">County</code>, that
 are set by the sample client.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="session-receiving-notifications"></a>11.1.&nbsp;Receiving Notifications</h2></div></div></div><p>If your application implements a listener for change notification, such
  as a <code class="literal">SessionListener</code> to handle notification when a session
  is invalidated, then you must configure the following settings in the
  <code class="filename">AMConfig.properties</code> configuration file for your
  application.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">com.iplanet.am.notification.url</span></dt><dd><p>Set this parameter to
     <code class="literal">http://<em class="replaceable"><code>host</code></em>:<em class="replaceable"><code>port</code></em>/<em class="replaceable"><code>context</code></em>/notificationservice</code>.</p></dd><dt><span class="term">com.iplanet.am.sdk.caching.enabled</span></dt><dd><p>Set this parameter to <code class="literal">true</code>.</p></dd><dt><span class="term">com.iplanet.am.serverMode</span></dt><dd><p>Set this parameter to <code class="literal">false</code>.</p></dd><dt><span class="term">com.sun.identity.client.notification.url</span></dt><dd><p>Set this parameter to
     <code class="literal">http://<em class="replaceable"><code>host</code></em>:<em class="replaceable"><code>port</code></em>/<em class="replaceable"><code>context</code></em>/notificationservice</code>.</p></dd><dt><span class="term">com.sun.identity.idm.cache.enabled</span></dt><dd><p>Set this parameter to <code class="literal">true</code>.</p></dd><dt><span class="term">com.sun.identity.idm.remote.notification.enabled</span></dt><dd><p>Set this parameter to <code class="literal">true</code>.</p></dd><dt><span class="term">com.sun.identity.sm.cache.enabled</span></dt><dd><p>Set this parameter to <code class="literal">true</code>.</p></dd><dt><span class="term">com.sun.identity.sm.enableDataStoreNotification</span></dt><dd><p>Set this parameter to <code class="literal">true</code>.</p></dd></dl></div><p>The above configuration to access the notification service also applies
  for other types of listeners, such as <code class="literal">ServiceListener</code>, and
  <code class="literal">IdEventListener</code> implementations. See the <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Java SDK API
  Specification</em></a> for details on the available listener
  interfaces.</p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-policy-decisions"></a>Chapter&nbsp;12.&nbsp;Requesting Policy Decisions Using OpenAM Java SDK</h1></div></div></div><a class="indexterm" name="d13846e8556"></a><p>This chapter shows how to request policy decision by using OpenAM Java
 SDK. The chapter focuses on the sample client,
 <code class="filename">source/samples/policy/PolicyEvaluationSample.java</code>, which
 demonstrates making a request to OpenAM for a policy decision about access to
 a web resource.</p><p>Before you continue, make sure that the packages described in the
   <a href="../dev-guide/index.html#chap-jdk" class="link">Using the OpenAM Java SDK</a>
   chapter are installed.</p><p>OpenAM centralizes policy administration, policy evaluation, and policy
 decision making so that your applications do not have to do so. In many
 deployments, OpenAM policy agents and the Open Identity gateway can handle
 policy enforcement independently from your application code.</p><p>If your application does need to request a policy decision from OpenAM,
 then your application can retrieve a <code class="literal">PolicyEvaluator</code> from
 a client-side <code class="literal">PolicyEvaluatorFactory</code>, and then call the
 <code class="literal">PolicyEvaluator</code> <code class="literal">getPolicyDecision()</code>
 method. For boolean decisions such as allow or deny, your application can also
 call the <code class="literal">isAllowed()</code> method.</p><p>To make a policy decision, OpenAM needs an <code class="literal">SSOToken</code>,
 the resource to access, the action the user wants to perform on the resource
 such as HTTP <code class="literal">GET</code> or <code class="literal">POST</code>, and a
 <code class="literal">Map</code> of environment settings you can use to specify
 conditions and attributes in the session or can pass back as an empty
 <code class="literal">Map</code> if your policy does not include conditions and
 response attributes.</p><p>The <code class="literal">PolicyEvaluationSample</code> class takes as its
 configuration the user credentials, service name, resource, and action that
 you provide in a Java properties file. It then authenticates the user to get
 an <code class="literal">SSOToken</code> using the <code class="filename">TokenUtils.java</code>
 helper methods. At that point it has sufficient information to request a
 policy decision.</p><p>The implementation of the sample client follows.</p><pre class="brush: java;">package samples.policy;

import com.iplanet.sso.SSOToken;
import com.iplanet.sso.SSOTokenManager;

import com.sun.identity.policy.PolicyDecision;
import com.sun.identity.policy.client.PolicyEvaluator;
import com.sun.identity.policy.client.PolicyEvaluatorFactory;

import samples.policy.TokenUtils;

import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.HashSet;
import java.util.Properties;
import java.util.MissingResourceException;
import java.util.ResourceBundle;
import java.util.Set;

public class PolicyEvaluationSample {


    public PolicyEvaluationSample() {
    }

    public static void main(String[] args) throws Exception {
        PolicyEvaluationSample clientSample = new PolicyEvaluationSample();
        clientSample.runSample(args);
        System.exit(0);
    }

    public void runSample(String[] args) throws Exception {
        if (args.length == 0 || args.length &gt; 1) {
            System.out.println("Missing argument:"
                    + "properties file name not specified");
        } else {
            System.out.println("Using properties file:" + args[0]);
            Properties sampleProperties = getProperties(args[0]);
            SSOToken ssoToken = getSSOToken(
                (String)sampleProperties.get("user.name"),
                (String)sampleProperties.get("user.password")
            );
            getPolicyDecision(
                ssoToken,
                (String)sampleProperties.get("service.name"),
                (String)sampleProperties.get("resource.name"),
                (String)sampleProperties.get("action.name")
            );
        }
    }

    private SSOToken getSSOToken(
            String userName, String password) throws Exception {
        System.out.println("Entering getSSOToken():"
                + "userName=" + userName + ","
                + "password=" + password);
        SSOToken ssoToken = TokenUtils.getSessionToken("/",
                userName, password);
        System.out.println("TokenID:" + ssoToken.getTokenID().toString());
        System.out.println("returning from getSSOToken()");
        return ssoToken;
    }

    private void getPolicyDecision(
            SSOToken ssoToken,
            String serviceName,
            String resourceName,
            String actionName)
            throws Exception {

        System.out.println("Entering getPolicyDecision():"
                + "resourceName=" + resourceName + ","
                + "serviceName=" + serviceName + ","
                + "actionName=" + actionName);
        PolicyEvaluator pe = PolicyEvaluatorFactory.getInstance().
                    getPolicyEvaluator(serviceName);

        Map env = new HashMap();
        Set attrSet = new HashSet();
        Set actions = new HashSet();
        actions.add(actionName);
        PolicyDecision pd = pe.getPolicyDecision(ssoToken, resourceName,
                actions, env);
        System.out.println("policyDecision:" + pd.toXML());

        System.out.println("returning from getPolicyDecision()");
    }

    private Properties getProperties(String file)
      throws MissingResourceException {
        Properties properties = new Properties();
        ResourceBundle bundle = ResourceBundle.getBundle(file);
        Enumeration e = bundle.getKeys();
        System.out.println("sample properties:");
        while (e.hasMoreElements()) {
            String key = (String) e.nextElement();
            String value = bundle.getString(key);
            properties.put(key, value);
            System.out.println(key + ":" + value);
        }
        return properties;
    }
}</pre><p>Before you run the script that calls the sample, edit the properties
 file, <code class="filename">resources/policyEvaluationSample.properties</code>, to
 indicate the user credentials, resource to access, and HTTP method to
 use. You can use a resource that might not exist for the purposes of this
 example, but you will need to set up a policy for that resource to get
 meaningful results.</p><pre class="brush: java;">user.name=demo
user.password=changeit
service.name=iPlanetAMWebAgentService
resource.name=http://www.example.com:80/banner.html
action.name=GET</pre><p>Also, set up a policy in OpenAM that corresponds to the resource in
 question. You can set up the policy in OpenAM console under Access Control
 &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Policies. Concerning the
 <em class="replaceable"><code>Realm Name</code></em>, notice that unless you change the code,
 the sample uses the top-level realm, <code class="literal">/</code> to authenticate the
 user.</p><p>With the properties configured and policy in place, get the decision
 from OpenAM using the script,
 <code class="filename">scripts/run-policy-evaluation-sample.sh</code>.</p><div class="screen"><pre>
$ <strong>sh scripts/run-policy-evaluation-sample.sh</strong>
<em>Using properties file:policyEvaluationSample
sample properties:
user.password:changeit
service.name:iPlanetAMWebAgentService
user.name:demo
resource.name:http://www.example.com:80/banner.html
action.name:GET
------------------------------------------------------------------------------:
Entering getSSOToken():userName=demo,password=changeit
TokenID:AQIC5wM2LY4Sfcx3aQGFRKu5-r1a-Vfyjb...5ODM4NDY0MzE0ODYzODQ1*
returning from getSSOToken()
Entering getPolicyDecision():resourceName=http://www.example.com:80/banner.html,
 serviceName=iPlanetAMWebAgentService,actionName=GET
policyDecision:&lt;PolicyDecision&gt;
&lt;ResponseAttributes&gt;
&lt;/ResponseAttributes&gt;
&lt;ActionDecision timeToLive="9223372036854775807"&gt;
&lt;AttributeValuePair&gt;
&lt;Attribute name="GET"/&gt;
&lt;Value&gt;allow&lt;/Value&gt;
&lt;/AttributeValuePair&gt;
&lt;Advices&gt;
&lt;/Advices&gt;
&lt;/ActionDecision&gt;
&lt;/PolicyDecision&gt;

returning from getPolicyDecision()</em>
 </pre></div><p>As you see, the policy decision response is formatted here as an XML
 document.<a href="#ftn.d13846e8655" class="footnote" name="d13846e8655"><sup class="footnote">[1]</sup></a> Notice here the line showing that
 OpenAM has allowed access to the resource.</p><pre class="literallayout">&lt;Value&gt;allow&lt;/Value&gt;</pre><div class="footnotes"><br><hr class="footnote-hr"><div id="ftn.d13846e8655" class="footnote"><p><a href="#d13846e8655" class="para"><sup class="para">[1] </sup></a>The <code class="literal">PolicyDecision</code> element is
 defined in
 <code class="filename"><em class="replaceable"><code>openam</code></em>/WEB-INF/remoteInterface.dtd</code>
 where <em class="replaceable"><code>openam</code></em> is the location where the OpenAM web
 application is deployed.</p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-xacml"></a>Chapter&nbsp;13.&nbsp;Requesting a XACML Policy Decision Using OpenAM Java SDK</h1></div></div></div><p>This chapter shows how to request a XACML policy decision with OpenAM
 Java SDK, using the sample client,
 <code class="filename">source/samples/xacml/XACMLClientSample.java</code>.
 The sample client relies on an OpenAM server acting as a policy decision point
 and another OpenAM server acting as a policy enforcement point.</p><p>Before you continue, make sure that the packages described in the
   <a href="../dev-guide/index.html#chap-jdk" class="link">Using the OpenAM Java SDK</a>
   chapter are installed.</p><p>The sample client uses the XACML <code class="literal">ContextFactory</code> to
 create the XACML request. It then uses the
 <code class="literal">XACMLRequestProcessor</code> to get a decision as XACML
 <code class="literal">Response</code> from OpenAM. Most of the work in the sample
 is done setting up the request.</p><p>The implementation of the <code class="literal">XACMLClientSample</code> class
 follows.</p><pre class="brush: java;">package samples.xacml;

import com.sun.identity.saml2.common.SAML2Exception;

import com.sun.identity.xacml.client.XACMLRequestProcessor;
import com.sun.identity.xacml.common.XACMLConstants;
import com.sun.identity.xacml.common.XACMLException;
import com.sun.identity.xacml.context.ContextFactory;
import com.sun.identity.xacml.context.Action;
import com.sun.identity.xacml.context.Attribute;
import com.sun.identity.xacml.context.Environment;
import com.sun.identity.xacml.context.Request;
import com.sun.identity.xacml.context.Resource;
import com.sun.identity.xacml.context.Response;
import com.sun.identity.xacml.context.Subject;

import java.net.URI;
import java.net.URISyntaxException;

import java.io.PrintWriter;

import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.MissingResourceException;
import java.util.Properties;
import java.util.ResourceBundle;

public class XACMLClientSample {


    public XACMLClientSample() {
    }

    public static void main(String[] args) throws Exception {
        XACMLClientSample clientSample = new XACMLClientSample();
        clientSample.runSample(args);
        System.exit(0);
    }

    public void runSample(String[] args) throws Exception {
        if (args.length == 0 || args.length &gt; 1) {
            System.out.println("Missing argument:"
                    + "properties file name not specified");
        } else {
            System.out.println("Using properties file:" + args[0]);
            Properties sampleProperties = getProperties(args[0]);
            testProcessRequest(
                (String)sampleProperties.get("pdp.entityId"),
                (String)sampleProperties.get("pep.entityId"),
                (String)sampleProperties.get("subject.id"),
                (String)sampleProperties.get("subject.id.datatype"),
                (String)sampleProperties.get("subject.category"),
                (String)sampleProperties.get("resource.id"),
                (String)sampleProperties.get("resource.id.datatype"),
                (String)sampleProperties.get("resource.servicename"),
                (String)sampleProperties.get("resource.servicename.datatype"),
                (String)sampleProperties.get("action.id"),
                (String)sampleProperties.get("action.id.datatype")
            );
        }
    }

    private void testProcessRequest(
            String pdpEntityId, String pepEntityId,
            String subjectId, String subjectIdType,
            String subjectCategory,
            String resourceId, String resourceIdType,
            String serviceName, String serviceNameType,
            String actionId, String actionIdType) 
            throws XACMLException, SAML2Exception, 
            URISyntaxException, Exception {

        Request xacmlRequest = createSampleXacmlRequest(
            subjectId, subjectIdType,
            subjectCategory,
            resourceId, resourceIdType,
            serviceName, serviceNameType,
            actionId, actionIdType); 

        System.out.println("\ntestProcessRequest():xacmlRequest:\n" 
                + xacmlRequest.toXMLString(true, true));

        Response xacmlResponse = XACMLRequestProcessor.getInstance()
                .processRequest(xacmlRequest, pdpEntityId, pepEntityId);

        System.out.println("testProcessRequest():xacmlResponse:\n"
                + xacmlResponse.toXMLString(true, true));
    }

    private Request createSampleXacmlRequest(
            String subjectId, String subjectIdType,
            String subjectCategory,
            String resourceId, String resourceIdType,
            String serviceName, String serviceNameType,
            String actionId, String actionIdType) 
            throws XACMLException, URISyntaxException {

        Request request = ContextFactory.getInstance().createRequest();

        //Subject
        Subject subject = ContextFactory.getInstance().createSubject();
        subject.setSubjectCategory(new URI(subjectCategory));

        //set subject id
        Attribute attribute = ContextFactory.getInstance().createAttribute();
        attribute.setAttributeId(new URI(XACMLConstants.SUBJECT_ID));
        attribute.setDataType(new URI(subjectIdType));
        List valueList = new ArrayList();
        valueList.add(subjectId); 
        attribute.setAttributeStringValues(valueList);
        List attributeList = new ArrayList();
        attributeList.add(attribute);
        subject.setAttributes(attributeList);


        //set Subject in Request
        List subjectList = new ArrayList();
        subjectList.add(subject);
        request.setSubjects(subjectList);

        //Resource
        Resource resource = ContextFactory.getInstance().createResource();

        //set resource id
        attribute = ContextFactory.getInstance().createAttribute();
        attribute.setAttributeId(new URI(XACMLConstants.RESOURCE_ID));
        attribute.setDataType( new URI(resourceIdType));
        valueList = new ArrayList();
        valueList.add(resourceId);
        attribute.setAttributeStringValues(valueList);
        attributeList = new ArrayList();
        attributeList.add(attribute);

        //set serviceName
        attribute = ContextFactory.getInstance().createAttribute();
        attribute.setAttributeId(new URI(XACMLConstants.TARGET_SERVICE));
        attribute.setDataType(new URI(serviceNameType));
        valueList = new ArrayList();
        valueList.add(serviceName);
        attribute.setAttributeStringValues(valueList);
        attributeList.add(attribute);
        resource.setAttributes(attributeList);

        //set Resource in Request
        List resourceList = new ArrayList();
        resourceList.add(resource);
        request.setResources(resourceList);

        //Action
        Action action = ContextFactory.getInstance().createAction();
        attribute = ContextFactory.getInstance().createAttribute();
        attribute.setAttributeId(new URI(XACMLConstants.ACTION_ID));
        attribute.setDataType(new URI(actionIdType));

        //set actionId
        valueList = new ArrayList();
        valueList.add(actionId);
        attribute.setAttributeStringValues(valueList);
        attributeList = new ArrayList();
        attributeList.add(attribute);
        action.setAttributes(attributeList);

        //set Action in Request
        request.setAction(action);

        //Environment, our PDP does not use environment now
        Environment environment = ContextFactory.getInstance()
            .createEnvironment();
        request.setEnvironment(environment);
        return request;
    }

    private Properties getProperties(String file)
        throws MissingResourceException {
        Properties properties = new Properties();
        ResourceBundle bundle = ResourceBundle.getBundle(file);
        Enumeration e = bundle.getKeys();
        System.out.println("sample properties:");
        while (e.hasMoreElements()) {
            String key = (String) e.nextElement();
            String value = bundle.getString(key);
            properties.put(key, value);
            System.out.println(key + ":" + value);
        }
        return properties;
    }
}</pre><p>Before running the sample client, you must set up the configuration as
 described in the comments at the outset of the
 <code class="filename">scripts/run-xacml-client-sample.sh</code> script.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    Check <code class="filename">resources/AMConfig.properties</code>
    to see which OpenAM server the SDK is configured to use.
   </p><p>
    The relevant settings from <code class="filename">resources/AMConfig.properties</code>
    specify the server protocol, host, port and deployment URI.
   </p><pre class="brush: ini;">com.iplanet.am.server.protocol=http
com.iplanet.am.server.host=openam.example.com
com.iplanet.am.server.port=8080
com.iplanet.am.services.deploymentDescriptor=openam</pre><p>
    For the purpose of this example, the XACML policy decision point (PDP)
    and the XACML policy enforcement point (PEP) are configured on this server.
   </p></li><li class="listitem"><p>Edit <code class="filename">resources/xacmlClientSample.properties</code>
   and <code class="filename">resources/policyEvaluationSample.properties</code>
   to set up the configuration for the sample client.</p><p>The relevant settings from
   <code class="filename">resources/xacmlClientSample.properties</code> are the
   following.</p><pre class="brush: ini;">pdp.entityId=xacmlPdpEntity
pep.entityId=xacmlPepEntity
subject.id=id=demo,ou=user,dc=openam,dc=forgerock,dc=org
subject.id.datatype=urn:oasis:names:tc:xacml:1.0:data-type:x500Name
subject.category=urn:oasis:names:tc:xacml:1.0:subject-category:access-subject
resource.id=http://www.example.com:80/banner.html
resource.id.datatype=http://www.w3.org/2001/XMLSchema#string
resource.servicename=iPlanetAMWebAgentService
resource.servicename.datatype=http://www.w3.org/2001/XMLSchema#string
action.id=GET
action.id.datatype=http://www.w3.org/2001/XMLSchema#string</pre><p>The relevant settings from
   <code class="filename">resources/policyEvaluationSample.properties</code> are the
   following.</p><pre class="brush: ini;">user.name=demo
user.password=changeit
service.name=iPlanetAMWebAgentService
resource.name=http://www.example.com:80/banner.html
action.name=GET</pre><p>
    These settings use the default <code class="literal">demo</code> user as the subject,
    who has ID <code class="literal">id=demo,ou=user,dc=openam,dc=forgerock,dc=org</code>,
    and password <code class="literal">changeit</code>.
    If you choose a different subject, then change
    the <code class="literal">subject.id</code> value
    in <code class="filename">resources/xacmlClientSample.properties</code>,
    and the <code class="literal">user.name</code> and <code class="literal">user.password</code> values
    in <code class="filename">resources/policyEvaluationSample.properties</code>.
   </p></li><li class="listitem"><p>The client accesses an OpenAM server acting as the policy enforcement
    point, configured in a circle of trust with the OpenAM server acting as the
    policy decision point. When you set up the sample clients, you pointed them
    to an OpenAM server. For this example, configure that server to function
    as a policy enforcement point and also as a policy decision point.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In OpenAM console, browse to Configuration &gt; Global &gt; SAMLv2
      SOAP Binding, and configure a new request handler with Key
      <code class="literal">/xacmlPdpEntity</code> and Class
      <code class="literal">com.sun.identity.xacml.plugins.XACMLAuthzDecisionQueryHandler</code>.</p></li><li class="listitem"><p>Set up the circle of trust, and then create and import the metadata
      for the policy enforcement point and the policy decision point. In the
      following simplified example, both the policy enforcement point and policy
      decision point are hosted on the same OpenAM server. You could also set
      up the policy enforcement point and policy decision point on separate
      servers, as long as the circles of trust on both servers each include both
      the policy enforcement point and the policy decision point. You can
      set up the trust relationship between the two entities either by using
      the <span class="command"><strong>ssoadm</strong></span> command as shown below, or by using the
      <code class="literal">ssoadm.jsp</code> page, which you can activate as described in
      <a href="../admin-guide/index.html#openam-ssoadm-jsp-overview" class="link"><em class="citetitle">OpenAM
      ssoadm.jsp</em></a>.</p><div class="screen"><pre>
$ <strong>ssoadm \
 create-cot \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --cot cot</strong>

<em>Circle of trust, cot was created.</em>
$ <strong>ssoadm \
 create-metadata-templ \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --entityid xacmlPepEntity \
 --xacmlpep /xacmlPepEntity \
 --meta-data-file xacmlPep.xml \
 --extended-data-file xacmlPep-extended.xml</strong>

<em>Hosted entity configuration was written to xacmlPep-extended.xml.
Hosted entity descriptor was written to xacmlPep.xml.</em>
$ <strong>ssoadm \
 import-entity \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --cot cot \
 --meta-data-file xacmlPep.xml \
 --extended-data-file xacmlPep-extended.xml</strong>

<em>Import file, xacmlPep.xml.
Import file, xacmlPep-extended.xml.</em>
$ <strong>ssoadm \
 create-metadata-templ \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --entityid xacmlPdpEntity \
 --xacmlpdp /xacmlPdpEntity \
 --meta-data-file xacmlPdp.xml \
 --extended-data-file xacmlPdp-extended.xml</strong>

<em>Hosted entity configuration was written to xacmlPdp-extended.xml.
Hosted entity descriptor was written to xacmlPdp.xml.</em>
$ <strong>ssoadm \
 import-entity \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --cot cot \
 --meta-data-file xacmlPdp.xml \
 --extended-data-file xacmlPdp-extended.xml</strong>

<em>Import file, xacmlPdp.xml.
Import file, xacmlPdp-extended.xml.</em>
      </pre></div></li></ol></div></li><li class="listitem"><p>Create a policy that allows
   authenticated users to perform an HTTP <code class="literal">GET</code> on the sample
   <code class="literal">resource.id</code> URL you configured, such as
   <code class="literal">http://www.example.com:80/banner.html</code>.</p><p>See <span class="olink"><em class="citetitle">Configuring Policies</em></span> for details.</p></li></ul></div><p>After you have configured OpenAM and the properties files, run the
 sample client script, and observe the XACML request and response.</p><div class="screen"><pre>
$ <strong>sh scripts/run-xacml-client-sample.sh</strong>
<em>Using properties file:xacmlClientSample
sample properties:
subject.id.datatype:urn:oasis:names:tc:xacml:1.0:data-type:x500Name
pdp.entityId:xacmlPdpEntity
resource.servicename.datatype:http://www.w3.org/2001/XMLSchema#string
resource.id:http://www.example.com:80/banner.html
resource.servicename:iPlanetAMWebAgentService
action.id.datatype:http://www.w3.org/2001/XMLSchema#string
resource.id.datatype:http://www.w3.org/2001/XMLSchema#string
action.id:GET
subject.category:urn:oasis:names:tc:xacml:1.0:subject-category:access-subject
pep.entityId:xacmlPepEntity
subject.id:id=demo,ou=user,dc=openam,dc=forgerock,dc=org

testProcessRequest():xacmlRequest:

&lt;xacml-context:Request
 xmlns:xacml-context="urn:oasis:names:tc:xacml:2.0:context:schema:os"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="urn:oasis:names:tc:xacml:2.0:context:schema:os
  http://docs.oasis-open.org/xacml/access_control-xacml-2.0-context-schema-os.xsd"&gt;
&lt;Subject SubjectCategory=
 "urn:oasis:names:tc:xacml:1.0:subject-category:access-subject"&gt;
&lt;Attribute
 AttributeId="urn:oasis:names:tc:xacml:1.0:subject:subject-id"
 DataType="urn:oasis:names:tc:xacml:1.0:data-type:x500Name" &gt;
&lt;AttributeValue
 &gt;id=demo,ou=user,dc=openam,dc=forgerock,dc=org&lt;/AttributeValue&gt;
&lt;/Attribute&gt;
&lt;/Subject&gt;
&lt;xacml-context:Resource&gt;
&lt;Attribute
 AttributeId="ResourceId"
 DataType="http://www.w3.org/2001/XMLSchema#string" &gt;
&lt;AttributeValue&gt;http://www.example.com:80/banner.html&lt;/AttributeValue&gt;
&lt;/Attribute&gt;
&lt;Attribute
  AttributeId="urn:sun:names:xacml:2.0:resource:target-service"
  DataType="http://www.w3.org/2001/XMLSchema#string" &gt;
&lt;AttributeValue&gt;iPlanetAMWebAgentService&lt;/AttributeValue&gt;
&lt;/Attribute&gt;
&lt;/xacml-context:Resource&gt;
&lt;xacml-context:Action&gt;
&lt;Attribute
 AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id"
 DataType="http://www.w3.org/2001/XMLSchema#string" &gt;
&lt;AttributeValue&gt;GET&lt;/AttributeValue&gt;
&lt;/Attribute&gt;
&lt;/xacml-context:Action&gt;
&lt;xacml-context:Environment&gt;&lt;/xacml-context:Environment&gt;
&lt;/xacml-context:Request&gt;

testProcessRequest():xacmlResponse:
&lt;xacml-context:Response
 xmlns:xacml-context="urn:oasis:names:tc:xacml:2.0:context:schema:os" &gt;
&lt;xacml-context:Result ResourceId="http://www.example.com:80/banner.html"&gt;
&lt;xacml-context:Decision&gt;Permit&lt;/xacml-context:Decision&gt;
&lt;xacml-context:Status&gt;
&lt;xacml-context:StatusCode
 Value="urn:oasis:names:tc:xacml:1.0:status:ok"&gt;
&lt;/xacml-context:StatusCode&gt;
&lt;xacml-context:StatusMessage&gt;ok&lt;/xacml-context:StatusMessage&gt;
&lt;xacml-context:StatusDetail
 xmlns:xacml-context="urn:oasis:names:tc:xacml:2.0:context:schema:cd:04"&gt;
&lt;xacml-context:StatusDetail/&gt;&lt;/xacml-context:StatusDetail&gt;
&lt;/xacml-context:Status&gt;
&lt;/xacml-context:Result&gt;
&lt;/xacml-context:Response&gt;</em>
 </pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-fedlet-java"></a>Chapter&nbsp;14.&nbsp;Using Fedlets in Java Web Applications</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#create-install-java-fedlet">14.1. Creating &amp; Installing a Java Fedlet</a></span></dt><dt><span class="section"><a href="#fedlet-signing-encryption">14.2. Signing &amp; Encryption For a Fedlet</a></span></dt><dt><span class="section"><a href="#customize-java-fedlet">14.3. Customizing a Java Fedlet</a></span></dt></dl></div><a class="indexterm" name="d13846e8864"></a><p>This chapter introduces OpenAM Fedlets, and shows how to use the Fedlet
 as part of your Java web application.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="create-install-java-fedlet"></a>14.1.&nbsp;Creating &amp; Installing a Java Fedlet</h2></div></div></div><p>An OpenAM <em class="firstterm">Fedlet</em> is a small web application that
  can do federation in your service provider application with OpenAM acting as
  the identity provider. The Fedlet does not require an entire OpenAM
  installation alongside your application, but instead can redirect to OpenAM
  for single sign on, and to retrieve SAML assertions.</p><p>The process for creating and installing a Java Fedlet is divided into several procedures.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="#create-a-java-fedlet" title="Procedure&nbsp;14.1.&nbsp;To Create a Fedlet">Procedure&nbsp;14.1, &#8220;To Create a Fedlet&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#install-fedlet-as-demo" title="Procedure&nbsp;14.2.&nbsp;To Install the Fedlet as a Demo Application">Procedure&nbsp;14.2, &#8220;To Install the Fedlet as a Demo Application&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#try-fedlet-attribute-query" title="Procedure&nbsp;14.3.&nbsp;To Try the Fedlet Attribute Query">Procedure&nbsp;14.3, &#8220;To Try the Fedlet Attribute Query&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#try-fedlet-xacml-query" title="Procedure&nbsp;14.4.&nbsp;To Try the Fedlet XACML Query">Procedure&nbsp;14.4, &#8220;To Try the Fedlet XACML Query&#8221;</a></p></li></ul></div><div class="procedure"><a name="create-a-java-fedlet"></a><div class="procedure-title">Procedure&nbsp;14.1.&nbsp;To Create a Fedlet</div><p>The OpenAM administrator running the identity provider server creates
   a <code class="filename">Fedlet.zip</code> file for your service provider application,
   and then sends you the .zip.</p><ol class="procedure" type="1"><li class="step"><p>Before creating the Fedlet, create a Hosted Identity Provider if
    you have not already done so, using the test certificate for the signing
    key.</p><p>The single sign-on and single logout features that the Java Fedlet
    demonstrates do work with the Hosted Identity Provider you create starting
    from the Common Tasks page. The Java Fedlet Attribute Query and XACML Query
    tests require additional configuration, however.</p><p>See <a class="xref" href="#try-fedlet-attribute-query" title="Procedure&nbsp;14.3.&nbsp;To Try the Fedlet Attribute Query">Procedure&nbsp;14.3, &#8220;To Try the Fedlet Attribute Query&#8221;</a> and
    <a class="xref" href="#try-fedlet-xacml-query" title="Procedure&nbsp;14.4.&nbsp;To Try the Fedlet XACML Query">Procedure&nbsp;14.4, &#8220;To Try the Fedlet XACML Query&#8221;</a> for details.</p></li><li class="step"><p>On the Common Tasks page of the OpenAM console, click Create
    Fedlet.</p></li><li class="step"><p>Note that the Circle of Trust includes your hosted identity provider,
    and that Identity Provider is set to your to hosted identity
    provider.</p></li><li class="step"><p>Name the Fedlet, and also set the Destination URL.</p><p>You can use the deployment URL, such as
    <code class="literal">http://openam.example.com:8080/fedlet</code> as both the name and
    the destination URL.</p></li><li class="step"><p>Click create to generate the Fedlet.zip file, such as
    <code class="filename">$HOME/openam/myfedlets/httpopenamexamplecom8080fedlet/Fedlet.zip</code>.</p></li><li class="step"><p>Provide the Fedlet to the service provider, or install it yourself to
    demonstrate the Fedlet's features.</p></li></ol></div><div class="procedure"><a name="install-fedlet-as-demo"></a><div class="procedure-title">Procedure&nbsp;14.2.&nbsp;To Install the Fedlet as a Demo Application</div><p><code class="filename">Fedlet.zip</code> includes the
   <code class="filename">fedlet.war</code> archive corresponding to the identity
   provider, and a <code class="filename">README</code> file.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The <code class="filename">fedlet.war</code> archive contains both the Fedlet
     as a demo web application, and also the files you use to include the Fedlet
     in your service provider application.</p></li><li class="listitem"><p>The README file describes how to use the Fedlet.</p></li></ul></div><p>Perform the following steps to try single sign-on and single logout
   tests. For the attribute query and XACML query tests, additional configuration
   is required.</p><ol class="procedure" type="1"><li class="step"><p>Deploy the Fedlet in your web container.</p><div class="screen"><pre>
$ <strong>unzip Fedlet.zip</strong>
$ <strong>mv fedlet.war /path/to/tomcat/webapps</strong>
    </pre></div></li><li class="step"><p>Browse to the Fedlet URL, and then click the links to set up the
    configuration directory in <code class="filename">$HOME/fedlet</code>, where $HOME
    corresponds to the user running the web application container.</p></li><li class="step"><p>Try one or more examples from the Fedlet home page to validate Fedlet
    setup.</p><div class="mediaobject" align="center"><a name="figure-fedlet-demo"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-demo.png" align="middle" height="360" alt="Home page for demo Fedlet"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-demo.html" target="longdesc">D</a>]</span></div></div><p>After setting up OpenAM with the default subjects, you can login on
    the identity provider with user name <code class="literal">demo</code> and password
    <code class="literal">changeit</code>.</p></li></ol></div><div class="procedure"><a name="try-fedlet-attribute-query"></a><div class="procedure-title">Procedure&nbsp;14.3.&nbsp;To Try the Fedlet Attribute Query</div><p>To try the Fedlet Attribute Query test, the Identity Provider
   must be configured with the Attribute Authority (<code class="literal">AttrAuth</code>)
   type and should sign responses. The Fedlet must be configured to deal with
   signed responses. Furthermore, map the attributes to request in both the
   Identity Provider and the Fedlet configurations.</p><ol class="procedure" type="1"><li class="step"><p>Add the Attribute Authority type to the hosted Identity Provider.</p><ol type="a" class="substeps"><li class="step"><p>On OpenAM where the Identity Provider is hosted, log in to OpenAM
      console as <code class="literal">amadmin</code>.</p></li><li class="step"><p>Under Federation &gt; Entity Providers, select the Identity Provider,
      and then click New..., even though you plan to change the configuration
      rather than create a new provider.</p></li><li class="step"><p>Select the protocol of the provider: SAMLv2.</p></li><li class="step"><p>In the Create SAMLv2 Entity Provider page, do the following.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Set the Realm.</p></li><li class="listitem"><p>Set the Entity Identifier to the same entity identifier you
        selected in the previous screen.</p></li><li class="listitem"><p>In the Attribute Authority section, set the Meta Alias for example
        to <code class="literal">/attra</code>, and set the Signing certificate alias and
        Encryption certificate alias values to <code class="literal">test</code> (to use
        the test certificate).</p></li><li class="listitem"><p>Click Create to save your changes.</p><p>Disregard any error messages stating that the entity already
        exists.</p></li></ul></div><p><code class="literal">AttrAuth</code> now appears in the list of Types for
      your Identity Provider.</p></li></ol></li><li class="step"><p>Under Federation &gt; Entity Providers, click the Identity Provider
    link to open the provider's configuration.</p></li><li class="step"><p>Make sure attributes for the query are mapped on the Identity
    Provider.</p><p>Under IDP &gt; Attribute Mapper, add the following values to the
    Attribute Map if they are not yet present.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cn=cn</code></p></li><li class="listitem"><p><code class="literal">sn=sn</code></p></li><li class="listitem"><p><code class="literal">uid=uid</code></p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>Make sure to use thread-safe code if you implement the AttributeAuthorityMapper.
     You can use the attributes on the HttpRequest instead of synchronizing them. The 
     default AttributeAuthorityMapper uses an attribute on the HttpServletRequest to
     pass information to the AttributeQueryUtil.</p></div><p>Click Save to save your changes.</p></li><li class="step"><p>Create the Fedlet as described in <a class="xref" href="#create-a-java-fedlet" title="Procedure&nbsp;14.1.&nbsp;To Create a Fedlet">Procedure&nbsp;14.1, &#8220;To Create a Fedlet&#8221;</a>,
    making sure you map the attributes.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cn=cn</code></p></li><li class="listitem"><p><code class="literal">sn=sn</code></p></li><li class="listitem"><p><code class="literal">uid=uid</code></p></li></ul></div><p>This step creates a Fedlet with updated Identity Provider metadata.
    If you already created a Fedlet, either use a different name, or delete
    the existing Fedlet.</p></li><li class="step"><p>Deploy the new Fedlet .war as described in <a class="xref" href="#install-fedlet-as-demo" title="Procedure&nbsp;14.2.&nbsp;To Install the Fedlet as a Demo Application">Procedure&nbsp;14.2, &#8220;To Install the Fedlet as a Demo Application&#8221;</a>.</p></li><li class="step"><p>Edit the new Fedlet configuration to request signing and encryption,
    and replace the existing configuration in OpenAM with the edited
    configuration.</p><ol type="a" class="substeps"><li class="step"><p>Copy the test key store from OpenAM, and prepare password files.</p><div class="screen"><pre>
$ <strong>scp user@openam:/home/user/openam/openam/keystore.jks ~/fedlet/</strong>
      </pre></div><p>The Fedlet uses password files when accessing the keystore. These
      password files contain encoded passwords, where the encoding is specific
      to the Fedlet.</p><p>To encode the password, use <code class="literal">fedletEncode.jsp</code>.
      <code class="literal">fedletEncode.jsp</code> is in the deployed Fedlet, for example
      <code class="literal">http://openam.example.com:8080/fedlet/fedletEncode.jsp</code>.
      The only password to encode for OpenAM's test keystore is
      <code class="literal">changeit</code>, because the key store and private key
      passwords are both the same.</p><p>Use the encoded value to create the password files as in the
      following example.</p><div class="screen"><pre>
$ <strong>echo AQIC5BHNSjLwT303GqndmHbyYvzP9Tz7OAnK &gt; ~/fedlet/.storepass</strong>
$ <strong>echo AQIC5BHNSjLwT303GqndmHbyYvzP9Tz7OAnK &gt; ~/fedlet/.keypass</strong>
      </pre></div></li><li class="step"><p>Edit <code class="filename">~/fedlet/sp.xml</code> to use the test
      certificate for the attribute query.</p><p>Change the following:</p><pre class="brush: xml;">&lt;RoleDescriptor xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
    xsi:type="query:AttributeQueryDescriptorType"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
 &lt;/RoleDescriptor&gt;</pre><p>To:</p><pre class="brush: xml;"> &lt;RoleDescriptor xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
    xsi:type="query:AttributeQueryDescriptorType"
    protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;KeyDescriptor use="signing"&gt;
   &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
    &lt;ds:X509Data&gt;
     &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
     &lt;/ds:X509Certificate&gt;
    &lt;/ds:X509Data&gt;
   &lt;/ds:KeyInfo&gt;
  &lt;/KeyDescriptor&gt;
  &lt;KeyDescriptor use="encryption"&gt;
   &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
    &lt;ds:X509Data&gt;
     &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
     &lt;/ds:X509Certificate&gt;
    &lt;/ds:X509Data&gt;
   &lt;/ds:KeyInfo&gt;
   &lt;EncryptionMethod Algorithm="http://www.w3.org/2001/04/xmlenc#aes128-cbc"&gt;
    &lt;xenc:KeySize xmlns:xenc="http://www.w3.org/2001/04/xmlenc#"
      &gt;128&lt;/xenc:KeySize&gt;
   &lt;/EncryptionMethod&gt;
  &lt;/KeyDescriptor&gt;
 &lt;/RoleDescriptor&gt;</pre></li><li class="step"><p>Edit <code class="filename">~/fedlet/sp-extended.xml</code> to use the test
      certificate for the attribute query.</p><p>Change the following, assuming your Circle of Trust is called
      <code class="literal">cot</code>:</p><pre class="brush: xml;">&lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
    &lt;Attribute name="signingCertAlias"&gt;
        &lt;Value&gt;&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="encryptionCertAlias"&gt;
        &lt;Value&gt;&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="wantNameIDEncrypted"&gt;
        &lt;Value&gt;&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="cotlist"&gt;
        &lt;Value&gt;cot&lt;/Value&gt;
    &lt;/Attribute&gt;
&lt;/AttributeQueryConfig&gt;</pre><p>To:</p><pre class="brush: xml;">&lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
    &lt;Attribute name="signingCertAlias"&gt;
        &lt;Value&gt;test&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="encryptionCertAlias"&gt;
        &lt;Value&gt;test&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="wantNameIDEncrypted"&gt;
        &lt;Value&gt;true&lt;/Value&gt;
    &lt;/Attribute&gt;
    &lt;Attribute name="cotlist"&gt;
        &lt;Value&gt;cot&lt;/Value&gt;
    &lt;/Attribute&gt;
&lt;/AttributeQueryConfig&gt;</pre></li><li class="step"><p>In OpenAM Console, under Federation &gt; Entity Providers, delete
      the existing configuration for your new Fedlet.</p></li><li class="step"><p>
       Make a copy of <code class="filename">sp-extended.xml</code>
       called <code class="filename">sp-extended-copy.xml</code>
       and set <code class="literal">hosted="0"</code> in the root element of the copy.
      </p><p>
       Use the copy, <code class="filename">sp-extended-copy.xml</code>,
       when importing the Fedlet configuration into OpenAM.
       OpenAM must register the Fedlet
       as a <span class="emphasis"><em>remote</em></span> service provider.
      </p></li><li class="step"><p>Under Federation &gt; Entity Providers, click Import Entity... and
      import your updated Fedlet configuration.</p><p>This ensures OpenAM has the correct service provider configuration
      for your new Fedlet.</p></li><li class="step"><p>Restart the Fedlet or the container where it is deployed.</p></li></ol></li><li class="step"><p>Try the Attribute Query test.</p><ol type="a" class="substeps"><li class="step"><p>Access the Fedlet.</p><div class="mediaobject" align="center"><a name="figure-fedlet-sso-request"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-sso-request.png" align="middle" height="360" alt="Home page for demo Fedlet"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-sso-request.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Try SSO with user name <code class="literal">demo</code>, password
      <code class="literal">changeit</code>.</p><div class="mediaobject" align="center"><a name="figure-fedlet-sso-response"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-sso-response.png" align="middle" height="360" alt="Fedlet SSO response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-sso-response.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Click Fedlet Attribute Query, set the attributes in the Attribute
      Query page to match the mapped attributes, and then click Submit.</p><div class="mediaobject" align="center"><a name="figure-fedlet-attr-query-request"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-attr-query-request.png" align="middle" height="360" alt="Fedlet Attribute Query request page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-attr-query-request.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Check that you see the attribute values in the response.</p><div class="mediaobject" align="center"><a name="figure-fedlet-attr-query-response"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-attr-query-response.png" align="middle" height="360" alt="Fedlet Attribute Query response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-attr-query-response.html" target="longdesc">D</a>]</span></div></div></li></ol></li></ol></div><div class="procedure"><a name="try-fedlet-xacml-query"></a><div class="procedure-title">Procedure&nbsp;14.4.&nbsp;To Try the Fedlet XACML Query</div><p>To try the Fedlet XACML Query test, the Identity Provider
   must have a policy configured, must be configured with the Policy Decision
   Point (<code class="literal">XACML PDP</code>) type, and must have a SAMLv2 SOAP Binding
   PDP handler configured.</p><ol class="procedure" type="1"><li class="step"><p>Configure a policy on the hosted Identity Provider.</p><p>OpenAM uses the policy to make the decision whether to permit or deny
    access to a resource. For the purpose of the demonstration, configure a
    simple policy that allows all authenticated users HTTP GET access on
    <code class="literal">http://www.example.com/</code>.</p><ol type="a" class="substeps"><li class="step"><p>Log in to OpenAM console as <code class="literal">amadmin</code>.</p></li><li class="step"><p>
       Access the policy editor under
       Access Control &gt; <em class="replaceable"><code>realm-name</code></em> &gt; Policies.
      </p></li><li class="step"><p>
       Choose an application that allows the resource pattern
       <code class="literal">http://www.example.com/*</code>,
       and HTTP GET as an action.
      </p><p>
       If no application exists in the realm, add a new application
       for the resource pattern <code class="literal">http://www.example.com/*</code>.
      </p></li><li class="step"><p>
       Add a new policy with the following characteristics.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         Resource pattern: <code class="literal">http://www.example.com/*</code>
        </p></li><li class="listitem"><p>
         Actions: allow <code class="literal">GET</code>
        </p></li><li class="listitem"><p>
         Subject conditions: <code class="literal">Authenticated Users</code>
        </p></li></ul></div></li></ol></li><li class="step"><p>Add the Policy Decision Point type to the Identity Provider.</p><ol type="a" class="substeps"><li class="step"><p>Under Federation &gt; Entity Providers, select the Identity Provider,
      and then click New..., even though you plan to change the configuration
      rather than create a new provider.</p></li><li class="step"><p>Select the protocol of the provider: SAMLv2.</p></li><li class="step"><p>In the Create SAMLv2 Entity Provider page, do the following.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Set the Realm.</p></li><li class="listitem"><p>Set the Entity Identifier to the entity identifier for the hosted
        Identity Provider.</p></li><li class="listitem"><p>In the XACML Policy Decision Point section, set the Meta Alias for
        example to <code class="literal">/pdp</code>.</p></li><li class="listitem"><p>Click Create to save your changes.</p><p>Disregard any error messages stating that the entity already
        exists.</p></li></ul></div><p><code class="literal">XACML PDP</code> now appears in the list of Types for
      your identity provider.</p></li></ol></li><li class="step"><p>Add the PDP handler for the SAMLv2 SOAP Binding.</p><ol type="a" class="substeps"><li class="step"><p>Under Configuration &gt; Global &gt; SAMLv2 SOAP Binding, click
      New...</p></li><li class="step"><p>Set the new key to match the meta alias you used when adding the
      XACML PDP type to the Identity Provider configuration, for example
      <code class="literal">/pdp</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Key: <code class="literal">/pdp</code></p></li><li class="listitem"><p>Class: <code class="literal">com.sun.identity.xacml.plugins.XACMLAuthzDecisionQueryHandler</code></p></li></ul></div><p>Click OK. (Your changes are not saved, yet.)</p></li><li class="step"><p>Click Save to actually save the new Key:Class pair.</p></li></ol></li><li class="step"><p>Create the Fedlet as described in <a class="xref" href="#create-a-java-fedlet" title="Procedure&nbsp;14.1.&nbsp;To Create a Fedlet">Procedure&nbsp;14.1, &#8220;To Create a Fedlet&#8221;</a>.</p><p>This step creates a Fedlet with updated identity provider metadata.
    If you already created a Fedlet, either use a different name, or delete
    the existing Fedlet.</p></li><li class="step"><p>Deploy the new Fedlet .war as described in <a class="xref" href="#install-fedlet-as-demo" title="Procedure&nbsp;14.2.&nbsp;To Install the Fedlet as a Demo Application">Procedure&nbsp;14.2, &#8220;To Install the Fedlet as a Demo Application&#8221;</a>.</p></li><li class="step"><p>Try the XACML Query test.</p><ol type="a" class="substeps"><li class="step"><p>Access the Fedlet.</p><div class="mediaobject" align="center"><a name="figure-fedlet-sso-request-xacml"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-sso-request.png" align="middle" height="360" alt="Home page for demo Fedlet"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-sso-request-xacml.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Try SSO with user name <code class="literal">demo</code>, password
      <code class="literal">changeit</code>.</p><div class="mediaobject" align="center"><a name="figure-fedlet-sso-response-xacml"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-sso-response.png" align="middle" height="360" alt="Fedlet SSO response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-sso-response-xacml.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Click XACML Attribute Query, set the Resource URL in the XACML
      Query page to <code class="literal">http://www.example.com/</code>, and then
      click Submit.</p><div class="mediaobject" align="center"><a name="figure-fedlet-xacml-query-request"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-xacml-query-request.png" align="middle" height="360" alt="Fedlet XACML Query request page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-xacml-query-request.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Check that you see the permit decision in the response.</p><div class="mediaobject" align="center"><a name="figure-fedlet-xacml-query-response"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/fedlet-xacml-query-response.png" align="middle" height="360" alt="Fedlet XACML Query response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-fedlet-xacml-query-response.html" target="longdesc">D</a>]</span></div></div></li></ol></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="fedlet-signing-encryption"></a>14.2.&nbsp;Signing &amp; Encryption For a Fedlet</h2></div></div></div><p>By default when you create the Java Fedlet, signing and encryption are
  not configured. You can however set up OpenAM and the fedlet to sign and
  to verify XML signatures and to encrypt and to decrypt data such as SAML
  assertions. If you have tried the Attribute Query demonstration, then you
  have already configured the Fedlet to request signing and encryption using
  the test keys from the identity provider.</p><div class="itemizedlist"><p>Enable signing and encryption for the Java Fedlet involves the
   following high level stages.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Before you create the Fedlet, configure the IDP to sign and encrypt
    data. See Federation &gt; Entity Providers &gt; <em class="replaceable"><code>IDP
    Name</code></em> &gt; Signing and Encryption in the OpenAM console.</p><p>For evaluation, you can use the <code class="literal">test</code> certificate
    delivered with OpenAM.</p></li><li class="listitem"><p>Initially deploy and configure the Fedlet, but do not use the Fedlet
    until you finish.</p></li><li class="listitem"><p>On the Fedlet side set up a JKS keystore used for signing and
    encryption. For evaluation, you can use copy the
    <code class="filename">keystore.jks</code> file delivered with OpenAM. You can find
    the file under the configuration directory for OpenAM, such as
    <code class="filename">$HOME/openam/openam/</code> for a server instance with
    base URI <code class="literal">openam</code>. The built-in keystore includes the
    <code class="literal">test</code> certificate.</p><p>You must also set up <code class="filename">.storepass</code> and
    <code class="filename">.keypass</code> files using the
    <code class="filename">fedletEncode.jsp</code> page, such as
    <code class="literal">http://openam.example.com:8080/fedlet/fedletEncode.jsp</code>, to
    encode passwords on the Fedlet side. The passwords for the test key store
    and private key are both <code class="literal">changeit</code>.</p></li><li class="listitem"><p>Configure the Fedlet to perform signing and encryption by ensuring
    the Fedlet has access to the key store, and by updating the SP metadata
    for the Fedlet.</p></li><li class="listitem"><p>Import the updated SP metadata into the IDP to replace the default
    Fedlet configuration.</p></li><li class="listitem"><p>Restart the Fedlet or container in which the Fedlet runs for the
    changes you made on the Fedlet side to take effect.</p></li></ul></div><div class="procedure"><a name="fedlet-conf-signing-encryption"></a><div class="procedure-title">Procedure&nbsp;14.5.&nbsp;To Configure the Fedlet For Signing &amp; Encryption</div><p>The <code class="filename">FederationConfig.properties</code> file specifies
   the paths to the JKS keystore holding the signing or encryption keys for
   the Fedlet, the keystore password file, and the private key password
   file.</p><ol class="procedure" type="1"><li class="step"><p>After setting up your keystore and password files as described above,
    edit the properties file in the configuration directory, such as
    <code class="filename">$HOME/fedlet/FederationConfig.properties</code>, to point
    to the keystore and password files.</p></li><li class="step"><p>Export the certificate to use for signing and encryption
    purposes.</p><div class="screen"><pre>
$ <strong>keytool -export -rfc -keystore keystore.jks -alias test</strong>
<em>Enter keystore password:
-----BEGIN CERTIFICATE-----
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==</em>
    </pre></div></li><li class="step"><p>Edit the standard metadata file for the Fedlet, such as
    <code class="filename">$HOME/fedlet/sp.xml</code>, to include the certificate
    in KeyDescriptor elements, that are children of the SPSSODescriptor
    element.</p><pre class="brush: xml;">&lt;EntityDescriptor
 xmlns="urn:oasis:names:tc:SAML:2.0:metadata"
 entityID="http://www.example.com:8080/fedlet"&gt;
 &lt;SPSSODescriptor
  AuthnRequestsSigned="true"
  WantAssertionsSigned="true"
  protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
  &lt;KeyDescriptor use="signing"&gt;
   &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
    &lt;ds:X509Data&gt;
     &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
     &lt;/ds:X509Certificate&gt;
    &lt;/ds:X509Data&gt;
   &lt;/ds:KeyInfo&gt;
  &lt;/KeyDescriptor&gt;
  &lt;KeyDescriptor use="encryption"&gt;
   &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
    &lt;ds:X509Data&gt;
     &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
     &lt;/ds:X509Certificate&gt;
    &lt;/ds:X509Data&gt;
   &lt;/ds:KeyInfo&gt;
   &lt;EncryptionMethod Algorithm="http://www.w3.org/2001/04/xmlenc#aes128-cbc"&gt;
    &lt;xenc:KeySize xmlns:xenc="http://www.w3.org/2001/04/xmlenc#"&gt;
     128
    &lt;/xenc:KeySize&gt;
   &lt;/EncryptionMethod&gt;
  &lt;/KeyDescriptor&gt;
  &lt;SingleLogoutService
   Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
   Location="http://www.example.com:8080/fedlet/fedletSloRedirect"
   ResponseLocation="http://www.example.com:8080/fedlet/fedletSloRedirect" /&gt;
  &lt;SingleLogoutService
   Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
   Location="http://www.example.com:8080/fedlet/fedletSloPOST"
   ResponseLocation="http://www.example.com:8080/fedlet/fedletSloPOST" /&gt;
  &lt;SingleLogoutService
   Binding="urn:oasis:names:tc:SAML:2.0:bindings:SOAP"
   Location="http://www.example.com:8080/fedlet/fedletSloSoap" /&gt;
  &lt;NameIDFormat&gt;
   urn:oasis:names:tc:SAML:2.0:nameid-format:transient
  &lt;/NameIDFormat&gt;
  &lt;AssertionConsumerService
   index="0"
   isDefault="true"
   Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
   Location="http://www.example.com:8080/fedlet/fedletapplication" /&gt;
  &lt;AssertionConsumerService
   index="1"
   Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact"
   Location="http://www.example.com:8080/fedlet/fedletapplication" /&gt;
 &lt;/SPSSODescriptor&gt;
 &lt;RoleDescriptor
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
  xsi:type="query:AttributeQueryDescriptorType"
  protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
 &lt;/RoleDescriptor&gt;
 &lt;XACMLAuthzDecisionQueryDescriptor
  WantAssertionsSigned="false"
  protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol" /&gt;
&lt;/EntityDescriptor&gt;</pre></li><li class="step"><p>Edit the extended metadata file for the Fedlet, such as
    <code class="filename">$HOME/fedlet/sp-extended.xml</code>, to set the certificate
    alias names to the alias for the Fedlet certificate, and the
    <code class="literal">want*Signed</code> and <code class="literal">want*Encrypted</code> values
    to <code class="literal">true</code>.</p><p>If you reformat the file, take care not to add white space around
    string values in elements.</p><pre class="brush: xml;">
&lt;EntityConfig xmlns="urn:sun:fm:SAML:2.0:entityconfig"
 xmlns:fm="urn:sun:fm:SAML:2.0:entityconfig" hosted="1"
 entityID="http://www.example.com:8080/fedlet"&gt;
 &lt;SPSSOConfig metaAlias="/sp"&gt;
  &lt;Attribute name="description"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="signingCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="encryptionCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthOn"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthUser"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthPassword"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="autofedEnabled"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="autofedAttribute"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="transientUser"&gt;
   &lt;Value&gt;anonymous&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAdapter"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAdapterEnv"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="fedletAdapter"&gt;
   &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultFedletAdapter&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="fedletAdapterEnv"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAccountMapper"&gt;
   &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultLibrarySPAccountMapper&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="useNameIDAsSPUserID"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAttributeMapper"&gt;
   &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAttributeMapper&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAuthncontextMapper"&gt;
   &lt;Value&gt;com.sun.identity.saml2.plugins.DefaultSPAuthnContextMapper&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAuthncontextClassrefMapping"&gt;
   &lt;Value
   &gt;urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport|0|default&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spAuthncontextComparisonType"&gt;
   &lt;Value&gt;exact&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="attributeMap"&gt;
   &lt;Value&gt;*=*&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="saml2AuthModuleName"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="localAuthURL"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="intermediateUrl"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="defaultRelayState"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="appLogoutUrl"&gt;
   &lt;Value&gt;http://www.example.com:8080/fedlet/logout&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="assertionTimeSkew"&gt;
   &lt;Value&gt;300&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantAttributeEncrypted"&gt;
   &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantAssertionEncrypted"&gt;
   &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantNameIDEncrypted"&gt;
   &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantPOSTResponseSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantArtifactResponseSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantLogoutRequestSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantLogoutResponseSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantMNIRequestSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantMNIResponseSigned"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="responseArtifactMessageEncoding"&gt;
   &lt;Value&gt;URI&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="cotlist"&gt;
   &lt;Value&gt;fedlet-cot&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="saeAppSecretList"&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="saeSPUrl"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="saeSPLogoutUrl"&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="ECPRequestIDPListFinderImpl"&gt;
   &lt;Value&gt;com.sun.identity.saml2.plugins.ECPIDPFinder&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="ECPRequestIDPList"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="ECPRequestIDPListGetComplete"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="enableIDPProxy"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="idpProxyList"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="idpProxyCount"&gt;
   &lt;Value&gt;0&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="useIntroductionForIDPProxy"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="spSessionSyncEnabled"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="relayStateUrlList"&gt;
  &lt;/Attribute&gt;
 &lt;/SPSSOConfig&gt;
 &lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
  &lt;Attribute name="signingCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="encryptionCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantNameIDEncrypted"&gt;
   &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="cotlist"&gt;
   &lt;Value&gt;fedlet-cot&lt;/Value&gt;
  &lt;/Attribute&gt;
 &lt;/AttributeQueryConfig&gt;
 &lt;XACMLAuthzDecisionQueryConfig metaAlias="/pep"&gt;
  &lt;Attribute name="signingCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="encryptionCertAlias"&gt;
   &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthOn"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthUser"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="basicAuthPassword"&gt;
   &lt;Value&gt;&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantXACMLAuthzDecisionResponseSigned"&gt;
   &lt;Value&gt;false&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantAssertionEncrypted"&gt;
   &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="cotlist"&gt;
   &lt;Value&gt;fedlet-cot&lt;/Value&gt;
  &lt;/Attribute&gt;
 &lt;/XACMLAuthzDecisionQueryConfig&gt;
&lt;/EntityConfig&gt;</pre></li><li class="step"><p>
     Make a copy of <code class="filename">sp-extended.xml</code>
     called <code class="filename">sp-extended-copy.xml</code>
     and set <code class="literal">hosted="0"</code> in the root element of the copy.
    </p><p>
     Use the copy, <code class="filename">sp-extended-copy.xml</code>,
     when importing the Fedlet configuration into OpenAM.
     OpenAM must register the Fedlet
     as a <span class="emphasis"><em>remote</em></span> service provider.
    </p></li><li class="step"><p>In OpenAM console delete the original SP entity configuration for the
    Fedlet, and then import the updated metadata for the new configuration into
    OpenAM on the IDP side.</p></li><li class="step"><p>Restart the Fedlet or the container in which it runs in order for
    the Fedlet to pick up the changes to the configuration properties and the
    metadata.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customize-java-fedlet"></a>14.3.&nbsp;Customizing a Java Fedlet</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#fedlet-perform-sso">14.3.1. Performing Single Sign-On</a></span></dt><dt><span class="section"><a href="#fedlet-perform-slo">14.3.2. Performing Single Logout</a></span></dt><dt><span class="section"><a href="#fedlet-perform-attr-query">14.3.3. Performing Attribute Queries</a></span></dt><dt><span class="section"><a href="#fedlet-perform-xacml-query">14.3.4. Performing XACML Queries</a></span></dt></dl></div><p>You can customize the Java Fedlet to perform many of the SAML 2.0
  service provider operations. The Java Fedlet has the SAML 2.0 capabilities
  identified in the table in the <em class="citetitle">Administration Guide</em>,
  <a href="../admin-guide/index.html#fedlet-saml2-features" class="link"><em class="citetitle">Fedlet Support for
  SAML 2.0 Features</em></a>.</p><div class="procedure"><a name="hello-world-with-fedlet"></a><div class="procedure-title">Procedure&nbsp;14.6.&nbsp;To Add Your Application</div><div class="variablelist"><p>The Fedlet includes the following files that you use when building
    your own service provider application based on the demo web application,
    including a set of JavaServer Pages (JSP) examples.</p><dl class="variablelist"><dt><span class="term"><code class="filename">conf/</code></span></dt><dd><p>Configuration files copied to <code class="filename">$HOME/fedlet</code> when
      you first deploy and configure the Fedlet. When deploying your application,
      you can move these to an alternate location passed to the Java virtual
      machine for the web application container at startup. For example, if
      you store the configuration under <code class="filename">/export/fedlet/</code>,
      then you could pass the following property to the JVM.</p><pre class="literallayout">-Dcom.sun.identity.fedlet.home=/export/fedlet/conf</pre><p>You do not need to include these files in your application.</p></dd><dt><span class="term"><code class="filename">fedletAttrQuery.jsp</code>, </span><span class="term"><code class="filename">fedletAttrResp.jsp</code></span></dt><dd><p>Sample SAML attribute query and response handlers.</p></dd><dt><span class="term"><code class="filename">fedletEncode.jsp</code></span></dt><dd><p>Utility JSP to encode a password, such as the password used to
      protect a Java keystore</p></dd><dt><span class="term"><code class="filename">fedletSampleApp.jsp</code>, </span><span class="term"><code class="filename">index.jsp</code></span></dt><dd><p>Demo application. You can remove these before deployment to replace
      them with your application.</p></dd><dt><span class="term"><code class="filename">fedletXACMLQuery.jsp</code>, </span><span class="term"><code class="filename">fedletXACMLResp.jsp</code></span></dt><dd><p>Sample SAML XACML query and response handlers.</p></dd><dt><span class="term"><code class="filename">logout.jsp</code></span></dt><dd><p>Utility page to perform single log out</p></dd><dt><span class="term"><code class="filename">saml2/jsp/</code></span></dt><dd><p>JSPs to initiate single sign on and single logout, and to handle
      errors, and also a JSP for obtaining Fedlet metadata,
      <code class="filename">saml2/jsp/exportmetadata.jsp</code></p></dd><dt><span class="term"><code class="filename">WEB-INF/classes/</code></span></dt><dd><p>Localized Java properties files for strings used in the Fedlet user
      interface</p></dd><dt><span class="term"><code class="filename">WEB-INF/lib/</code></span></dt><dd><p>Fedlet libraries required by your application</p></dd><dt><span class="term"><code class="filename">WEB-INF/web.xml</code></span></dt><dd><p>Fedlet web application configuration, showing how JSPs map to URLs
      used in the Fedlet. Add mappings for your application before
      deployment.</p><p>In the <code class="filename">web.xml</code> mappings, your application must
      be mapped to <code class="literal">/fedletapplication</code>, as this is the
      assertion consumer URL set in the Fedlet metadata.</p><pre class="brush: xml;">&lt;servlet&gt;
    &lt;servlet-name&gt;yourApp&lt;/servlet-name&gt;
    &lt;jsp-file&gt;/fedletSampleApp.jsp&lt;/jsp-file&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;yourApp&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/fedletapplication&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre></dd></dl></div><p>Follow these steps for a very simple demonstration of how to customize
   the Fedlet.</p><ol class="procedure" type="1"><li class="step"><p>Backup <code class="filename">fedletSampleApp.jsp</code>.</p><div class="screen"><pre>
$ <strong>cd /path/to/tomcat/webapps/fedlet/</strong>
$ <strong>cp fedletSampleApp.jsp fedletSampleApp.jsp.orig</strong>
    </pre></div></li><li class="step"><p>Edit <code class="filename">fedletSampleApp.jsp</code> to reduce it to a single
    redirection to <code class="filename">myapp.jsp</code>. An implementation of the
    &lt;html&gt; element of the file follows below.</p><pre class="brush: html;">&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Fedlet Sample Application&lt;/title&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;%
    // BEGIN : following code is a must for Fedlet (SP) side application
    Map map;
    try {
        // invoke the Fedlet processing logic. this will do all the
        // necessary processing conforming to SAMLv2 specifications,
        // such as XML signature validation, Audience and Recipient
        // validation etc.
        map = SPACSUtils.processResponseForFedlet(request, response);
        response.sendRedirect("myapp.jsp");
    } catch (SAML2Exception sme) {
        SAMLUtils.sendError(request, response,
            response.SC_INTERNAL_SERVER_ERROR, "failedToProcessSSOResponse",
            sme.getMessage());
        return;
    } catch (IOException ioe) {
        SAMLUtils.sendError(request, response,
            response.SC_INTERNAL_SERVER_ERROR, "failedToProcessSSOResponse",
            ioe.getMessage());
        return;
    } catch (SessionException se) {
        SAMLUtils.sendError(request, response,
            response.SC_INTERNAL_SERVER_ERROR, "failedToProcessSSOResponse",
            se.getMessage());
        return;
    } catch (ServletException se) {
        SAMLUtils.sendError(request, response,
            response.SC_BAD_REQUEST, "failedToProcessSSOResponse",
            se.getMessage());
        return;
    }
    // END : code is a must for Fedlet (SP) side application
%&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></li><li class="step"><p>Add a <code class="filename">myapp.jsp</code> page to the Fedlet, such as the
    following.</p><pre class="brush: html;">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;My Application&lt;/title&gt;
&lt;meta http-equiv="Content-Type" content="text/html" /&gt;
&lt;/head&gt;

&lt;body&gt;

&lt;h1&gt;My Application&lt;/h1&gt;

&lt;p&gt;After you change the &lt;code&gt;fedletSampleApp.jsp&lt;/code&gt;,
   all it does is redirect to this home page after
   successful login.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;</pre></li><li class="step"><p>Browse to the Fedlet URL, such as
    <code class="literal">http://openam.example.com:8080/fedlet/</code>, and try one
    of the login methods.</p><p>After login you are redirected to <code class="filename">myapp.jsp</code>.</p></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fedlet-perform-sso"></a>14.3.1.&nbsp;Performing Single Sign-On</h3></div></div></div><p>The Java Fedlet includes a JSP file,
   <code class="filename">saml2/jsp/fedletSSOInit.jsp</code>, that you can call to
   initiate single sign-on from the Fedlet (SP) side. The Fedlet home page,
   <code class="filename">index.jsp</code>, calls this page when the user does
   Fedlet-initiated single sign-on.</p><p>When calling this JSP, the parameters to use are those also used by
   <code class="filename">saml2/jsp/spSSOInit.jsp</code> in OpenAM. Those parameters are
   described in the <em class="citetitle">Administration Guide</em> section,
   <a href="../admin-guide/index.html#spssoinit-parameters" class="link"><em class="citetitle"><code class="filename">spSSOInit.jsp</code> Parameters</em></a>.</p><p>For IDP-initiated single sign-on, call the appropriate page on the
   Identity Provider. OpenAM's page is described in the
   <em class="citetitle">Administration Guide</em> section,
   <a href="../admin-guide/index.html#idpssoinit-parameters" class="link"><em class="citetitle"><code class="filename">idpSSOInit.jsp</code> Parameters</em></a>.</p><p>After single sign-on, the user-agent is directed by default to the
   assertion consumer URI set in the Fedlet metadata, which by default is
   <code class="literal">/fedletapplication</code>. Also by default that URI points to
   the JSP, <code class="filename">fedletSampleApp.jsp</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fedlet-perform-slo"></a>14.3.2.&nbsp;Performing Single Logout</h3></div></div></div><p>The Java Fedlet includes a JSP file,
   <code class="filename">saml2/jsp/spSingleLogoutInit.jsp</code>, that you can call to
   initiate single logout from the Fedlet (SP) side. The Fedlet assertion
   consumer page, <code class="filename">fedletSampleApp.jsp</code>, calls this when
   the user does Fedlet-initiated single logout.</p><p>When calling this JSP, the parameters to use are those also used by
   <code class="filename">saml2/jsp/spSingleLogoutInit.jsp</code> in OpenAM. Those
   parameters are described in the <em class="citetitle">Administration Guide</em>
   section, <a href="../admin-guide/index.html#spsloinit-parameters" class="link"><em class="citetitle"><code class="filename">spSingleLogoutInit.jsp</code> Parameters</em></a>.</p><p>For IDP-initiated single logout, call the appropriate page on the
   Identity Provider. OpenAM's page is described in the
   <em class="citetitle">Administration Guide</em> section,
   <a href="../admin-guide/index.html#idpsloinit-parameters" class="link"><em class="citetitle"><code class="filename">idpSingleLogoutInit.jsp</code> Parameters</em></a>.</p><p>Set the <code class="literal">RelayState</code> parameter when initiating logout
   to redirect the user-agent appropriately when the process is complete.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fedlet-perform-attr-query"></a>14.3.3.&nbsp;Performing Attribute Queries</h3></div></div></div><p>As seen in the procedure, <a class="xref" href="#try-fedlet-attribute-query" title="Procedure&nbsp;14.3.&nbsp;To Try the Fedlet Attribute Query">Procedure&nbsp;14.3, &#8220;To Try the Fedlet Attribute Query&#8221;</a>,
   an attribute query allows the Fedlet to get profile information about a
   subject from the Attribute Authority. The Fedlet must be configured to deal
   with responses from the Attribute Authority, including configuration for
   signing and encryption. Also, an Identity Provider and Attribute Authority
   is likely to share only those attributes that the Fedlet absolutely requires
   to provide service, such as, for example, a name to customize a page. The
   attributes must then be mapped in the Attribute Authority and Fedlet
   metadata.</p><p>The Java Fedlet includes a JSP file,
   <code class="filename">fedletAttrQuery.jsp</code>, which is used in the procedure
   described above to prepare an attribute query using the transient subject
   identifier obtained during single sign-on. The
   <code class="filename">fedletAttrQuery.jsp</code> also supports using the Subject
   name from an X.509 identity certificate.</p><p>Another JSP file, <code class="filename">fedletAttrResp.jsp</code>, sends the
   query to the Attribute Authority using
   <code class="literal">com.sun.identity.saml2.profile.AttributeQueryUtil.html.getAttributesForFedlet()</code>,
   and if successful processes the result, which is a
   <code class="literal">java.util.Map</code> of the attribute types and their
   values.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fedlet-perform-xacml-query"></a>14.3.4.&nbsp;Performing XACML Queries</h3></div></div></div><p>As seen in the procedure, <a class="xref" href="#try-fedlet-xacml-query" title="Procedure&nbsp;14.4.&nbsp;To Try the Fedlet XACML Query">Procedure&nbsp;14.4, &#8220;To Try the Fedlet XACML Query&#8221;</a>,
   a XACML query allows the Fedlet to request a policy decision from a XACML
   PDP. You can configure OpenAM to respond to such queries as described in that
   procedure.</p><p>The Java Fedlet includes a JSP file,
   <code class="filename">fedletXACMLQuery.jsp</code>, which is used in the procedure
   described above to prepare a XACML query, identifying a resource URL and a
   type of HTTP operation to perform, and specifying the subject identifier
   obtained during single sign-on.</p><p>Another JSP file, <code class="filename">fedletXACMLResp.jsp</code>, sends the
   query to the XACML PDP using
   <code class="literal">com.sun.identity.saml2.profile.XACMLQueryUtil.getPolicyDecisionForFedlet()</code>,
   and if successful processes the result, which is a
   <code class="literal">java.lang.String</code> representing the decision, such as
   <code class="literal">Permit</code> if the decision is to allow access, or
   <code class="literal">Deny</code> if the decision is to deny access.</p></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-fedlet-dotnet"></a>Chapter&nbsp;15.&nbsp;Using Fedlets in .NET Applications</h1></div></div></div><a class="indexterm" name="d13846e9901"></a><p>This chapter explains how to use the Fedlet in your .NET application.
 You must configure the OpenAM .NET Fedlet to work with the identity
 provider.</p><p>Before you try the .NET Fedlet with OpenAM, create a hosted identity
 provider in a Circle of Trust to which you plan to add the Fedlet. You can
 perform these steps using the Create Hosted Identity Provider wizard on the
 Common Tasks page of the OpenAM console. The .NET Fedlet demo requires a
 signing key for the Identity Provider. For evaluation, use the
 <code class="literal">test</code> certificate installed with OpenAM.</p><p>Before configuring the .NET Fedlet, prepare Microsoft IIS 7 with ASP.NET
 v4. Import and configure access on Windows to any certificates and private
 keys the .NET Fedlet needs. Also prepare Windows to allow the .NET Fedlet to
 log messages to Windows Event Log.</p><div class="itemizedlist"><p>This chapter covers the following topics.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="#prepare-iis-for-fedlet" title="Procedure&nbsp;15.1.&nbsp;To Prepare IIS For Installing the .NET Fedlet">Procedure&nbsp;15.1, &#8220;To Prepare IIS For Installing the .NET Fedlet&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#import-fedlet-key-pairs-windows" title="Procedure&nbsp;15.2.&nbsp;To Import Test Key Pairs on Windows">Procedure&nbsp;15.2, &#8220;To Import Test Key Pairs on Windows&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#prepare-windows-dotnet-fedlet-event-log" title="Procedure&nbsp;15.3.&nbsp;To Prepare Windows For .NET Fedlet Event Logging">Procedure&nbsp;15.3, &#8220;To Prepare Windows For .NET Fedlet Event Logging&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#install-dotnet-fedlet" title="Procedure&nbsp;15.4.&nbsp;To Install the .NET Fedlet as a Demo Application">Procedure&nbsp;15.4, &#8220;To Install the .NET Fedlet as a Demo Application&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#try-dotnet-fedlet-attribute-query" title="Procedure&nbsp;15.5.&nbsp;To Try the .NET Fedlet Attribute Query">Procedure&nbsp;15.5, &#8220;To Try the .NET Fedlet Attribute Query&#8221;</a></p></li></ul></div><div class="procedure"><a name="prepare-iis-for-fedlet"></a><div class="procedure-title">Procedure&nbsp;15.1.&nbsp;To Prepare IIS For Installing the .NET Fedlet</div><p>Microsoft Internet Information Server must be installed with ASP.NET v4
  in order to support the .NET Fedlet application. The following steps describe
  how to set up IIS on Windows Server 2008 R2 to support the .NET Fedlet.</p><ol class="procedure" type="1"><li class="step"><p>Logon to the Windows server as Administrator.</p></li><li class="step"><p>In Server Manager, add the IIS 7 role to install IIS 7.</p><p>When adding the IIS 7 role, the wizard presents you with additional
   installation options. Under Application Development, select ASP.NET.</p></li><li class="step"><p>Under Roles &gt; Web Server (IIS) &gt; Internet Information Services (IIS)
   Manager &gt; <em class="replaceable"><code>server-name</code></em> &gt; Application Pools,
   change .NET Framework Version for your application pools to v4.0.</p></li></ol></div><div class="procedure"><a name="import-fedlet-key-pairs-windows"></a><div class="procedure-title">Procedure&nbsp;15.2.&nbsp;To Import Test Key Pairs on Windows</div><p>OpenAM ships with a test key pair unpacked during deployment into a
  Java Key Store under OpenAM's configuration directory. You can import this
  key pair on Windows, so that the .NET Fedlet demo can use the certificate and
  private key to perform signing, encryption, and logging in Windows Event Log.
  The following steps describe how to get the key pair imported and available
  to the .NET Fedlet on Windows Server 2008 R2.</p><p>See Windows documentation for instructions on using your own key
  pair when you plan to deploy the .NET Fedlet in production.</p><ol class="procedure" type="1"><li class="step"><p>Move the key pair from the Java Key Store to a PKCS#12 key store.</p><div class="screen"><pre>
C:&gt; <strong>keytool ^
 -importkeystore ^
 -srckeystore keystore.jks ^
 -destkeystore keystore.p12 ^
 -srcstoretype JKS ^
 -deststoretype PKCS12 ^
 -srcstorepass changeit ^
 -deststorepass changeit ^
 -srcalias test ^
 -destalias test ^
 -srckeypass changeit ^
 -destkeypass changeit ^
 -noprompt</strong>
   </pre></div><p>You can use the Java <span class="command"><strong>keytool</strong></span> command to perform
   this step on the system where OpenAM is installed if you do not have the
   command installed on the Windows system.</p><div class="screen"><pre>
$ <strong>keytool \
 -importkeystore \
 -srckeystore keystore.jks \
 -destkeystore keystore.p12 \
 -srcstoretype JKS \
 -deststoretype PKCS12 \
 -srcstorepass changeit \
 -deststorepass changeit \
 -srcalias test \
 -destalias test \
 -srckeypass changeit \
 -destkeypass changeit \
 -noprompt</strong>
   </pre></div></li><li class="step"><p>If necessary, copy the resulting <code class="filename">keystore.p12</code> file
   to the Windows system.</p></li><li class="step"><p>Open Microsoft Management Console.</p><p>Select Start &gt; Run, then enter <code class="literal">mmc</code>.</p></li><li class="step"><p>In the console, add the Certificates snap-in for the Local Computer
   store.</p></li><li class="step"><p>Select Certificates &gt; Personal &gt; More Actions &gt; All Tasks &gt; Import...</p></li><li class="step"><p>In the Certificate Import Wizard select the
   <code class="filename">keystore.p12</code> file to import the keys. The password is
   <code class="literal">changeit</code>.</p><p>Also select Mark this key as exportable.</p><p>Accept other defaults until you click Finish.</p></li><li class="step"><p>In Certificates &gt; Personal &gt; Certificates &gt; test &gt; More Actions &gt;
   Properties, make sure the Friendly name is test.</p></li><li class="step"><p>Certificates &gt; Personal &gt; Certificates &gt; test &gt; More Actions &gt; All
   Tasks &gt; Manage Private Keys, add access for Everyone (or at least the
   IIS 7 account, IUSR).</p></li></ol></div><div class="procedure"><a name="prepare-windows-dotnet-fedlet-event-log"></a><div class="procedure-title">Procedure&nbsp;15.3.&nbsp;To Prepare Windows For .NET Fedlet Event Logging</div><p>After importing the key pair for the .NET Fedlet, edit the registry
  to add the key that allows the .NET Fedlet to write to the Windows
  Event Log, and create an Event Log Custom View for the .NET Fedlet.</p><ol class="procedure" type="1"><li class="step"><p>Edit the Windows registry.</p><ol type="a" class="substeps"><li class="step"><p>Open the Windows registry editor.</p><p>Select Start &gt; Run, then enter <code class="literal">regedit</code>.</p></li><li class="step"><p>Browse to
     <code class="literal">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Eventlog\Application</code>.</p></li><li class="step"><p>Add a new key named <code class="literal">Fedlet</code>.</p><p>Right-click Application &gt; New &gt; Key.</p></li><li class="step"><p>Close the Windows registry editor.</p></li></ol></li><li class="step"><p>Add the Event Log Custom View.</p><ol type="a" class="substeps"><li class="step"><p>Select Start &gt; Administrative Tools &gt; Event Viewer.</p></li><li class="step"><p>Select Action &gt; Create Custom View...</p></li><li class="step"><p>Select all Event level options.</p></li><li class="step"><p>Select By source, and then in the drop-down menu, select Fedlet.</p></li><li class="step"><p>Click OK to finish creating the custom view.</p><p>When the .NET Fedlet logs messages, you can read them under Event
     Viewer (Local) &gt; Custom Views &gt; Fedlet.</p></li></ol></li></ol></div><div class="procedure"><a name="install-dotnet-fedlet"></a><div class="procedure-title">Procedure&nbsp;15.4.&nbsp;To Install the .NET Fedlet as a Demo Application</div><p>Follow these steps to configure and install the .NET Fedlet demo
  application. These instructions are sufficient to test single sign-on and
  single logout. If you want to try the attribute query test, see the procedure,
  <a class="xref" href="#try-dotnet-fedlet-attribute-query" title="Procedure&nbsp;15.5.&nbsp;To Try the .NET Fedlet Attribute Query">Procedure&nbsp;15.5, &#8220;To Try the .NET Fedlet Attribute Query&#8221;</a>.</p><ol class="procedure" type="1"><li class="step"><p>Download the .NET Fedlet (<code class="filename">Fedlet-aspnet.zip</code>) from
   the OpenAM <a class="link" href="http://forgerock.org/openam.html" target="_blank">nightly builds page</a>.
   Contact <a class="link" href="mailto:info@forgerock.com" target="_top">info@forgerock.com</a>
   if you need .NET Fedlet support.</p><p>Next, unpack the contents of the .zip file into a working directory.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="filename">bin\</code></span></dt><dd><p>This folder contains the <code class="filename">Fedlet.dll</code> library,
      that you copy to your application's <code class="filename">bin\</code>
      folder.</p></dd><dt><span class="term"><code class="filename">conf\</code></span></dt><dd><p>This folder contains the templates you edit to prepare your Fedlet
      configuration, including the identity provider and Fedlet (SP) metadata
      for federation. The completed configuration files belong in your
      application's <code class="filename">App_Data\</code> folder.</p></dd><dt><span class="term"><code class="filename">readme.txt</code></span></dt><dd><p>This file describes how to set up and configure .NET Fedlets.</p></dd><dt><span class="term"><code class="filename">SampleApp\</code></span></dt><dd><p>This folder contains the demo application.</p></dd></dl></div></li><li class="step"><p>To ensure the .NET Fedlet can write messages to Windows Event Log,
   edit <code class="filename">SampleApp\Web.config</code>, to make sure that the
   certificate alias reflects the key pair installed in the Windows Local
   Computer Store and available to the IIS 7 application pool user.</p><p>Default settings set the log level to write informational messages, and
   use the test key pair shipped with OpenAM.</p><pre class="brush: xml;">&lt;appSettings&gt;
    &lt;add key="fedletLogLevel" value="info" /&gt;
    &lt;add key="fedletMutualAuthCertAlias" value="test" /&gt;
&lt;/appSettings&gt;</pre><p>The key pair specified by the
   <code class="literal">fedletMutualAuthCertAlias</code> is used for SSL Mutual
   Certificate authentication when the certificate based authentication is
   required by and configured for the web container where the Identity
   Provider is deployed.</p></li><li class="step"><p>Edit the template files in the <code class="filename">SampleApp\App_Data\</code>
   folder based on where you deploy the Fedlet demo application, and on how your
   identity provider is configured.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Edit <code class="filename">fedlet.cot</code> to set
     <code class="literal">cot-name</code> to the name of the Circle of Trust, and to set
     <code class="literal">sun-fm-trusted-providers</code> to include the entity ID of
     the identity provider, and the entity ID of the Fedlet service
     provider.</p></li><li class="listitem"><p>Edit <code class="filename">sp.xml</code> and
     <code class="filename">sp-extended.xml</code> to configure the entity IDs, URLs,
     and Circle of Trust names to correspond to your sample application.</p></li></ul></div><div class="itemizedlist"><p>Example files for a .NET Fedlet deployed at
   <code class="literal">http://openam.example.com/fedlet</code> and an Identity Provider
   in OpenAM deployed at <code class="literal">http://openam.example.com:8080/openam</code>
   are available on the OpenAM Community Site. The Circle of Trust name in the
   examples is <code class="literal">cot</code>, and both entities use the test key
   pair.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/fedlet.cot" target="_blank">fedlet.cot</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/idp.xml" target="_blank">idp.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/idp-extended.xml" target="_blank">idp-extended.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/sp.xml" target="_blank">sp.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/sp-extended.xml" target="_blank">sp-extended.xml</a></p></li></ul></div></li><li class="step"><p>Export the identity provider metadata from OpenAM, and copy the
   resulting <code class="filename">idp.xml</code> and
   <code class="filename">idp-extended.xml</code> metadata to the Fedlet
   <code class="filename">SampleApp\App_Data\</code> folder.</p><div class="screen"><pre>
$ <strong>ssoadm \
 create-metadata-templ \
 --entityid "http://openam.example.com:8080/openam" \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --identityprovider /idp \
 --meta-data-file idp.xml \
 --extended-data-file idp-extended.xml \
 --idpscertalias test</strong>

<em>Hosted entity configuration was written to idp-extended.xml.
Hosted entity descriptor was written to idp.xml.</em>
   </pre></div><p>You can also perform this step using <code class="literal">ssoadm.jsp</code>
   if it is enabled.</p></li><li class="step"><p>Register the Fedlet with OpenAM as a remote service provider using the
   <code class="filename">sp.xml</code> and <code class="filename">sp-extended.xml</code>
   metadata.</p><p>
    Before importing <code class="filename">sp-extended.xml</code>,
    make a copy called <code class="filename">sp-extended-copy.xml</code>
    and set <code class="literal">hosted="0"</code> in the root element of the copy.
   </p><p>
    Use the copy, <code class="filename">sp-extended-copy.xml</code>,
    when importing the Fedlet configuration into OpenAM.
    OpenAM must register the Fedlet
    as a <span class="emphasis"><em>remote</em></span> service provider.
   </p><div class="screen"><pre>
$ <strong>ssoadm \
 import-entity \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --cot fedlet-cot \
 --meta-data-file sp.xml \
 --extended-data-file sp-extended-copy.xml</strong>

<em>Import file, sp.xml.
Import file, sp-extended-copy.xml.</em>
   </pre></div><p>You can also perform this step in OpenAM console by selecting
   Federation &gt; Entity Providers &gt; Import Entity...</p></li><li class="step"><p>Deploy the .NET Fedlet demo application in IIS.</p><ol type="a" class="substeps"><li class="step"><p>Add read and execute permissions for <code class="literal">Everyone</code> to
     the <code class="filename">SampleApp</code> folder.</p></li><li class="step"><p>Add the .NET Fedlet as an application.</p><p>Select IIS console &gt; <em class="replaceable"><code>server-name</code></em> &gt; Sites &gt;
     Default Web Site &gt; View Applications &gt; Add Applications.</p><p>In the window to add the application, Alias is the deployment URI to
     the .NET Fedlet, so <code class="literal">fedlet</code> for
     <code class="literal">/fedlet</code>. Physical path is the file system path to the
     <code class="filename">SampleApp</code> folder.</p></li><li class="step"><p>Restart IIS.</p></li></ol></li><li class="step"><p>Try the demo application links to run .NET Fedlet initiated single
   sign-on.</p><p>At first try the .NET Fedlet as Administrator using Internet Explorer
   on the Windows system where you installed the Fedlet. This allows you to see
   more explicit error messages should any such messages appear.</p><ol type="a" class="substeps"><li class="step"><p>Access the .NET Fedlet.</p><div class="mediaobject" align="center"><a name="figure-dotnet-fedlet-sso-request"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/dotnet-fedlet-sso-request.png" align="middle" height="360" alt="Home page for demo .NET Fedlet"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-dotnet-fedlet-sso-request.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Try SSO with user name <code class="literal">demo</code>, password
     <code class="literal">changeit</code>.</p><div class="mediaobject" align="center"><a name="figure-dotnet-fedlet-sso-response"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/dotnet-fedlet-sso-response.png" align="middle" height="360" alt=".NET Fedlet SSO response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-dotnet-fedlet-sso-response.html" target="longdesc">D</a>]</span></div></div><p>If you instead get HTTP 500.19 error status, ASP.NET did not register
     correctly. Register ASP.NET v4 manually as Administrator.</p><div class="screen"><pre>
PS C:\&gt; <strong>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -i</strong>
<em>Start installing ASP.NET (4.0.30319).
....
Finished installing ASP.NET (4.0.30319).</em>
     </pre></div></li></ol></li></ol></div><div class="procedure"><a name="try-dotnet-fedlet-attribute-query"></a><div class="procedure-title">Procedure&nbsp;15.5.&nbsp;To Try the .NET Fedlet Attribute Query</div><p>To try the .NET Fedlet Attribute Query test, the Identity Provider
  must be configured with the Attribute Authority (<code class="literal">AttrAuth</code>)
  type and should sign responses. The Fedlet must be configured to deal with
  signed and encrypted responses. Furthermore, map the attributes to request
  in both the Identity Provider and the Fedlet configurations.</p><ol class="procedure" type="1"><li class="step"><p>Add the Attribute Authority type to the hosted Identity Provider.</p><ol type="a" class="substeps"><li class="step"><p>On OpenAM where the Identity Provider is hosted, log in to OpenAM
     console as <code class="literal">amadmin</code>.</p></li><li class="step"><p>Under Federation &gt; Entity Providers, select the Identity Provider,
     and then click New..., even though you plan to change the configuration
     rather than create a new provider.</p></li><li class="step"><p>Select the protocol of the provider: SAMLv2.</p></li><li class="step"><p>In the Create SAMLv2 Entity Provider page, do the following.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Set the Realm.</p></li><li class="listitem"><p>Set the Entity Identifier to the same entity identifier you
       selected in the previous screen.</p></li><li class="listitem"><p>In the Attribute Authority section, set the Meta Alias for example
       to <code class="literal">/attra</code>, and set the Signing certificate alias and
       Encryption certificate alias values to <code class="literal">test</code> (to use
       the test certificate).</p></li><li class="listitem"><p>Click Create to save your changes.</p><p>Disregard any error messages stating that the entity already
       exists.</p></li></ul></div><p><code class="literal">AttrAuth</code> now appears in the list of Types for
     your Identity Provider.</p></li></ol></li><li class="step"><p>Under Federation &gt; Entity Providers, click the Identity Provider
   link to open the provider's configuration.</p></li><li class="step"><p>Make sure attributes for the query are mapped on the Identity
   Provider.</p><p>Under IDP &gt; Attribute Mapper, add the following values to the
   Attribute Map if they are not yet present.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">cn=cn</code></p></li><li class="listitem"><p><code class="literal">sn=sn</code></p></li><li class="listitem"><p><code class="literal">uid=uid</code></p></li></ul></div><p>Click Save to save your changes.</p></li><li class="step"><p>As described in the procedure, <a class="xref" href="#install-dotnet-fedlet" title="Procedure&nbsp;15.4.&nbsp;To Install the .NET Fedlet as a Demo Application">Procedure&nbsp;15.4, &#8220;To Install the .NET Fedlet as a Demo Application&#8221;</a>,
   export the Identity Provider metadata from OpenAM, and copy the
   resulting <code class="filename">idp.xml</code> and
   <code class="filename">idp-extended.xml</code> metadata to the .NET Fedlet
   <code class="filename">SampleApp\App_Data\</code> folder.</p></li><li class="step"><p>Update the .NET Fedlet configuration and metadata.</p><ol type="a" class="substeps"><li class="step"><p>To ensure the .NET Fedlet can write messages to Windows Event Log,
     edit <code class="filename">SampleApp\Web.config</code>, to make sure that the
     certificate alias reflects the key pair installed in the Windows Local
     Computer Store and available to the IIS 7 application pool user.</p><p>Default settings set the log level to write informational messages,
     and use the test key pair shipped with OpenAM.</p><pre class="brush: xml;">&lt;appSettings&gt;
    &lt;add key="fedletLogLevel" value="info" /&gt;
    &lt;add key="fedletMutualAuthCertAlias" value="test" /&gt;
&lt;/appSettings&gt;</pre><p>The key pair specified by the
     <code class="literal">fedletMutualAuthCertAlias</code> is used for SSL Mutual
     Certificate authentication when the certificate based authentication is
     required by and configured for the web container where the Identity
     Provider is deployed.</p></li><li class="step"><p>Edit the .NET Fedlet metadata files in
     <code class="filename">SampleApp\App_Data</code>, <code class="filename">fedlet.cot</code>,
     <code class="filename">sp.xml</code>, and <code class="filename">sp-extended.xml</code> to
     replace the following if you have not already done so.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Replace <code class="literal">FEDLET_COT</code> with the name of the
       Circle of Trust.</p></li><li class="listitem"><p>Replace <code class="literal">FEDLET_ENTITY_ID</code> with the entity
       identifier such as <code class="literal">http://openam.example.com/fedlet</code>.</p></li><li class="listitem"><p>Replace <code class="literal">FEDLET_DEPLOY_URI</code> with the URL to the
       .NET Fedlet, generally the same as the entity identifier.</p></li><li class="listitem"><p>Replace <code class="literal">IDP_ENTITY_ID</code> with the entity identifier
       of the Identity Provider such as
       <code class="literal">http://openam.example.com:8080/openam</code>.</p></li></ul></div></li><li class="step"><p>Set up signing and encryption in <code class="filename">sp.xml</code> for
     the .NET Fedlet.</p><p>The Attribute Authority encrypts the response with the Fedlet's
     public key, and the Fedlet decrypts the response with its private key. You
     can set up both signing and encryption by adding a &lt;KeyDescriptor&gt; as
     the first element in the &lt;SSODescriptor&gt;, as in the following
     example.</p><pre class="brush: xml;">&lt;KeyDescriptor use="signing"&gt;
      &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
          &lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
    &lt;/KeyDescriptor&gt;
    &lt;KeyDescriptor use="encryption"&gt;
      &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
          &lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
      &lt;EncryptionMethod
        Algorithm="http://www.w3.org/2001/04/xmlenc#aes128-cbc"&gt;
        &lt;xenc:KeySize
          xmlns:xenc="http://www.w3.org/2001/04/xmlenc#"
          &gt;128&lt;/xenc:KeySize&gt;
      &lt;/EncryptionMethod&gt;
    &lt;/KeyDescriptor&gt;</pre><p>For the Attribute Query feature, add a &lt;RoleDescriptor&gt; to the
     &lt;EntityDescriptor&gt; after the &lt;SSODescriptor&gt;. The &lt;RoleDescriptor&gt;
     describes the certificates that are used for signing and encryption.</p><pre class="brush: xml;">&lt;RoleDescriptor
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:query="urn:oasis:names:tc:SAML:metadata:ext:query"
        xsi:type="query:AttributeQueryDescriptorType"
        protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
    &lt;KeyDescriptor use="signing"&gt;
      &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
          &lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
    &lt;/KeyDescriptor&gt;
    &lt;KeyDescriptor use="encryption"&gt;
      &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;
MIICQDCCAakCBEeNB0swDQYJKoZIhvcNAQEEBQAwZzELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNh
bGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMQwwCgYDVQQKEwNTdW4xEDAOBgNVBAsTB09w
ZW5TU08xDTALBgNVBAMTBHRlc3QwHhcNMDgwMTE1MTkxOTM5WhcNMTgwMTEyMTkxOTM5WjBnMQsw
CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExDDAK
BgNVBAoTA1N1bjEQMA4GA1UECxMHT3BlblNTTzENMAsGA1UEAxMEdGVzdDCBnzANBgkqhkiG9w0B
AQEFAAOBjQAwgYkCgYEArSQc/U75GB2AtKhbGS5piiLkmJzqEsp64rDxbMJ+xDrye0EN/q1U5Of+
RkDsaN/igkAvV1cuXEgTL6RlafFPcUX7QxDhZBhsYF9pbwtMzi4A4su9hnxIhURebGEmxKW9qJNY
Js0Vo5+IgjxuEWnjnnVgHTs1+mq5QYTA7E6ZyL8CAwEAATANBgkqhkiG9w0BAQQFAAOBgQB3Pw/U
QzPKTPTYi9upbFXlrAKMwtFf2OW4yvGWWvlcwcNSZJmTJ8ARvVYOMEVNbsT4OFcfu2/PeYoAdiDA
cGy/F2Zuj8XJJpuQRSE6PtQqBuDEHjjmOQJ0rV/r8mO1ZCtHRhpZ5zYRjhRC9eCbjx9VrFax0JDC
/FfwWigmrW0Y0Q==
          &lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
      &lt;EncryptionMethod
        Algorithm="http://www.w3.org/2001/04/xmlenc#aes128-cbc"&gt;
        &lt;xenc:KeySize
          xmlns:xenc="http://www.w3.org/2001/04/xmlenc#"
          &gt;128&lt;/xenc:KeySize&gt;
      &lt;/EncryptionMethod&gt;
    &lt;/KeyDescriptor&gt;
  &lt;/RoleDescriptor&gt;</pre></li><li class="step"><p>Edit <code class="filename">sp-extended.xml</code> for your configuration.</p><p>Set the signing and encryption certificate aliases.</p><pre class="brush: xml;">&lt;Attribute name="signingCertAlias"&gt;
  &lt;Value&gt;test&lt;/Value&gt;
&lt;/Attribute&gt;
&lt;Attribute name="encryptionCertAlias"&gt;
  &lt;Value&gt;test&lt;/Value&gt;
&lt;/Attribute&gt;</pre><p>Update the attribute map in to coincide with the mapped attributes
     on the Identity Provider.</p><pre class="brush: xml;">&lt;Attribute name="attributeMap"&gt;
   &lt;Value&gt;cn=cn&lt;/Value&gt;
   &lt;Value&gt;sn=sn&lt;/Value&gt;
   &lt;Value&gt;uid=uid&lt;/Value&gt;
&lt;/Attribute&gt;</pre><p>Add a logout URL.</p><pre class="brush: xml;">&lt;Attribute name="appLogoutUrl"&gt;
   &lt;Value&gt;http://openam.example.com/fedlet/logout.aspx&lt;/Value&gt;
&lt;/Attribute&gt;</pre><p>Add an &lt;AttributeQueryConfig&gt; to the &lt;EntityDescriptor&gt; that
     references the certificate aliases.</p><pre class="brush: xml;">&lt;AttributeQueryConfig metaAlias="/attrQuery"&gt;
  &lt;Attribute name="signingCertAlias"&gt;
    &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="encryptionCertAlias"&gt;
    &lt;Value&gt;test&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="wantNameIDEncrypted"&gt;
    &lt;Value&gt;true&lt;/Value&gt;
  &lt;/Attribute&gt;
  &lt;Attribute name="cotlist"&gt;
    &lt;Value&gt;cot&lt;/Value&gt;
  &lt;/Attribute&gt;
&lt;/AttributeQueryConfig&gt;</pre></li><li class="step"><p>Check your work by comparing and contrasting your configuration with
     the sample configuration files on the OpenAM Community Site.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/fedlet.cot" target="_blank">fedlet.cot</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/idp.xml" target="_blank">idp.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/idp-extended.xml" target="_blank">idp-extended.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/sp.xml" target="_blank">sp.xml</a></p></li><li class="listitem"><p><a class="link" href="http://openam.forgerock.org/dotnet-fedlet/sp-extended.xml" target="_blank">sp-extended.xml</a></p></li></ul></div></li><li class="step"><p>In OpenAM console where the hosted Identity Provider is configured,
     under Federation &gt; Entity Providers delete the .NET Fedlet configuration
     if it exists.</p></li><li class="step"><p>
      Make a copy of <code class="filename">sp-extended.xml</code>
      called <code class="filename">sp-extended-copy.xml</code>
      and set <code class="literal">hosted="0"</code> in the root element of the copy.
     </p><p>
      Use the copy, <code class="filename">sp-extended-copy.xml</code>,
      when importing the Fedlet configuration into OpenAM.
      OpenAM must register the Fedlet
      as a <span class="emphasis"><em>remote</em></span> service provider.
     </p></li><li class="step"><p>Under Federation &gt; Entity Providers, click Import Entity..., and
     then import the .NET Fedlet configuration using your
     <code class="filename">sp.xml</code> and <code class="filename">sp-extended-copy.xml</code>
     metadata files.</p></li></ol></li><li class="step"><p>Deploy the .NET Fedlet as described in the deploy step of the procedure,
   <a class="xref" href="#install-dotnet-fedlet" title="Procedure&nbsp;15.4.&nbsp;To Install the .NET Fedlet as a Demo Application">Procedure&nbsp;15.4, &#8220;To Install the .NET Fedlet as a Demo Application&#8221;</a>, making sure you restart IIS.</p></li><li class="step"><p>Try the .NET Fedlet Attribute Query test.</p><p>At first try the .NET Fedlet as Administrator using Internet Explorer
   on the Windows system where you installed the Fedlet. This allows you to see
   more explicit error messages should any such messages appear.</p><ol type="a" class="substeps"><li class="step"><p>Access the .NET Fedlet.</p><div class="mediaobject" align="center"><a name="figure-dotnet-fedlet-sso-request-attr-query"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/dotnet-fedlet-sso-request.png" align="middle" height="360" alt="Home page for demo .NET Fedlet"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-dotnet-fedlet-sso-request-attr-query.html" target="longdesc">D</a>]</span></div></div></li><li class="step"><p>Try SSO with user name <code class="literal">demo</code>, password
     <code class="literal">changeit</code>.</p><div class="mediaobject" align="center"><a name="figure-dotnet-fedlet-sso-response-attr-query"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/dotnet-fedlet-sso-response.png" align="middle" height="360" alt=".NET Fedlet SSO response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-dotnet-fedlet-sso-response-attr-query.html" target="longdesc">D</a>]</span></div></div><p>If you instead get HTTP 500.19 error status, ASP.NET did not register
     correctly. Register ASP.NET v4 manually as Administrator.</p><div class="screen"><pre>
PS C:\&gt; <strong>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -i</strong>
<em>Start installing ASP.NET (4.0.30319).
....
Finished installing ASP.NET (4.0.30319).</em>
     </pre></div></li><li class="step"><p>At the bottom of the web page, et the attributes in the Attribute
      Query page to match the mapped attributes, and then click Send.</p></li><li class="step"><p>Check that you see the attribute values in the response page.</p><div class="mediaobject" align="center"><a name="figure-dotnet-fedlet-attr-query-response"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/dotnet-fedlet-attr-query-response.png" align="middle" height="360" alt=".NET Fedlet Attribute Query response page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-dotnet-fedlet-attr-query-response.html" target="longdesc">D</a>]</span></div></div></li></ol></li><li class="step"><p>Adapt the SSL/TLS protocol version used by the .NET Fedlet client to
   the needs of your deployment. The default setting for .NET v4 is to use
   either SSLv3 or TLSv1 depending on what the remote peer supports.</p><p>For IIS 6 on Windows Server 2003, see the Windows Server
   documentation on <a class="link" href="http://technet.microsoft.com/en-us/library/cc776467%28WS.10%29.aspx" target="_blank"><em class="citetitle">TLS/SSL Tools and Settings</em></a>.</p><p>For IIS 7.5 on Windows Server 2008 R2, also consider the explanation
   in an online article, <a class="link" href="http://www.derekseaman.com/2010/06/enable-tls-12-aes-256-and-sha-256-in.html" target="_blank"><em class="citetitle">Enable TLS 1.2 Ciphers in IIS 7.5, Server 2008 R2</em></a>.</p><p>For reference, Microsoft Developer Network has an article describing
   <a class="link" href="http://msdn.microsoft.com/en-us/library/aa374757(VS.85).aspx" target="_blank"><em class="citetitle">Cipher Suites in Schannel</em></a>.</p></li></ol></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-sae"></a>Chapter&nbsp;16.&nbsp;Using Secure Attribute Exchange</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#sae-install-prerequisites">16.1. Installing the Samples</a></span></dt><dt><span class="section"><a href="#sae-security-prerequisites">16.2. Preparing to Secure SAE Communications</a></span></dt><dt><span class="section"><a href="#sae-secure-idp">16.3. Securing the Identity Provider Side</a></span></dt><dt><span class="section"><a href="#sae-secure-sp">16.4. Securing the Service Provider Side</a></span></dt><dt><span class="section"><a href="#sae-trying-it-out">16.5. Trying It Out</a></span></dt></dl></div><a class="indexterm" name="d13846e10685"></a><p>Most deployments can rely on OpenAM to handle authentication and provide
 identity assertions. Not only does OpenAM support a wide variety of
 authentication scenarios out of the box, but OpenAM also makes it possible to
 add custom authentication modules. Furthermore OpenIG lets you integrate
 legacy systems into your access management deployment.</p><p>In a deployment where you need OpenAM to act as a SAML 2.0 gateway to a
 legacy application that serves as an identity provider, you can use OpenAM
 Secure Attribute Exchange (SAE). On the identity provider side, SAE lets
 OpenAM retrieve the information needed to create assertions from an external
 authentication service, bypassing OpenAM authentication and trusting the
 external service as the authoritative source of authentication. On the service
 provider side, SAE lets OpenAM securely provide attributes to an application
 that makes its own policy decision based on the attributes rather than rely on
 OpenAM for the policy decision.</p><div class="mediaobject" align="center"><a name="figure-sae"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/sae.png" align="middle" height="360" alt="External applications use SAE to participate in federation."></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-sae.html" target="longdesc">D</a>]</span></div></div><p>When you use SAE on the identity provider side, an external application
 acts as the authoritative source of authentication. After a user authenticates
 successfully, the application lets OpenAM know to create a session by sending
 a secure HTTP GET or POST to OpenAM that asserts the identity of the user.
 OpenAM processes the assertion to create a session for the user. If the user
 is already authenticated and comes back to access the application, the
 application sends a secure HTTP POST to OpenAM to assert both the user's
 identity and also any necessary attributes related to the user. OpenAM
 processes the assertion to create the session for the user and populate the
 attributes in the user's session. When the user logs out, the external
 authentication application can initiate single logout from the identity
 provider OpenAM server by sending the <code class="literal">sun.cmd=logout</code>
 attribute to OpenAM using SAE.</p><p>On the service provider side OpenAM communicates using SAML 2.0 with
 OpenAM on the identity provider side. OpenAM can use SAE to transmit
 attributes to an application through a secure HTTP POST.</p><p>SAE relies either on shared keys and symmetric encryption, or on public
 and private keys and asymmetric encryption to protect attributes communicated
 between OpenAM and external applications.</p><p>OpenAM ships with sample JSPs that demonstrate secure attribute
 exchange. In order to try the sample, you must set up an OpenAM circle of
 trust to include an identity provider and a service provider, install the SDK
 sample web application on each provider and then configure the providers
 appropriately as described in this chapter to secure communications with the
 sample SAE applications on both the identity provider and service provider
 sides.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sae-install-prerequisites"></a>16.1.&nbsp;Installing the Samples</h2></div></div></div><p>Set up an OpenAM server as an identity provider, and another as a
  service provider, connecting the two in a circle of trust called
  <code class="literal">samplesaml2cot</code>. Configure both the hosted providers and
  also the remote providers as described in <a href="../admin-guide/index.html#set-up-federation" class="link"><em class="citetitle">Setting Up SAML
  2.0 SSO</em></a>. This chapter assumes you set up the hosted
  identity provider at <code class="literal">http://idp.example.com:8080/openam</code>
  and the hosted service provider at
  <code class="literal">http://sp.example.com:8080/openam</code>. Use Common Tasks &gt;
  Test Federation Connectivity in OpenAM console to make sure Federation is
  working before you add secure attribute exchange applications that rely
  on functioning SAML 2.0 communications between the providers.</p><p>Set up the sample web application as described in <a href="../dev-guide/index.html#install-jdk-samples" class="link"><em class="citetitle">Installing OpenAM
  Client SDK Samples</em></a>, both on the identity provider side
  and also on the service provider side. The SAE samples are found under
  <code class="filename">/saml2/sae</code> where you installed the samples.
  <code class="filename">saeIDPApp.jsp</code> is the identity provider side external
  application. <code class="filename">saeSPApp.jsp</code> is the service provider side
  external application.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sae-security-prerequisites"></a>16.2.&nbsp;Preparing to Secure SAE Communications</h2></div></div></div><p>In order for SAE to be secure, you must both set up a trust
  relationship between the application on the identity provider side and
  the OpenAM server acting as identity provider, and also set up a trust
  relationship between the application on the service provider side and
  the OpenAM server acting as the service provider. These trust
  relationships can be based on a shared secret and symmetric encryption,
  or on public and private key pairs and asymmetric encryption. The trust
  relationships on either side are independent. In other words you can for
  example use a shared secret on the identity provider side and
  certificates on the service provider side if you chose.</p><p>When using symmetric encryption, you must define a shared secret
  string used both for the application and the provider. The sample uses
  <code class="literal">secret12</code> as the shared secret. To simplify
  configuration, the sample uses the same shared secret, and thus
  symmetric encryption, for both trust relationships.</p><p>When using symmetric encryption, you must also use the encoded
  version of your shared secret. To get the encoded version of a shared
  secret string, use the <code class="filename">encode.jsp</code> page on the
  provider, as in
  <code class="literal">http://idp.example.com:8080/openam/encode.jsp</code> and
  <code class="literal">http://sp.example.com:8080/openam/encode.jsp</code>. An
  encoded version of <code class="literal">secret12</code> looks something like
  <code class="literal">AQICEcFhDWmb6sVmMuCJuVh43306HVacDte9</code>.</p><p>When using asymmetric encryption, you must obtain a public-private
  key pair for the application, and store the keys in a key store on the
  application side. Also store the public key from OpenAM which is acting
  as the provider in the application's key store. Make note of the
  certificate aliases for your application's private key, and for OpenAM's
  public key. Also note the path to the key store for your application,
  the key store password, and the private key password.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sae-secure-idp"></a>16.3.&nbsp;Securing the Identity Provider Side</h2></div></div></div><p>This configuration uses the default sample settings with a shared
  secret of <code class="literal">secret12</code>, without encryption of the
  attributes.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Login as <code class="literal">amadmin</code> to the OpenAM server console
    where you set up the hosted identity provider (IDP).</p></li><li class="listitem"><p>As the sample includes a <code class="literal">branch</code> attribute not
    found in user profiles by default, under Access Control &gt;
    <em class="replaceable"><code>Realm Name</code></em> &gt; Authentication &gt; All Core
    Settings..., set User Profile to Ignored, and then Save your work.</p></li><li class="listitem"><div class="itemizedlist"><p>Under Federation &gt; Entity Providers, click the name for the
     Hosted IDP in order to access the IDP configuration.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under Assertion Processing &gt; Attribute Mapper, add both
      <code class="literal">mail=mail</code> and <code class="literal">branch=branch</code> to
      the attribute map, and then Save your work.</p></li><li class="listitem"><p>Under Advanced &gt; SAE Configuration, make sure the IDP URL
      reflects an endpoint on the IDP such as
      <code class="literal">http://idp.example.com:8080/openam/idpsaehandler/metaAlias/idp</code>,
      and then Save your work.</p></li><li class="listitem"><p>Also under Advanced &gt; SAE Configuration &gt; Application
      Security Configuration, add the URL value for the kind of encryption you
      are using, and then Save your work.</p><p>When using the defaults, the value is something like
      <code class="literal">url=http://idp.example.com:8080/samples/saml2/sae/saeIDPApp.jsp|type=symmetric|secret=<em class="replaceable"><code>encoded-secret</code></em></code>, where the OpenAM SDK sample web
      application is deployed on the IDP side with context root
      <code class="literal">/samples</code> and the
      <em class="replaceable"><code>encoded-secret</code></em> is something like
      <code class="literal">AQICEcFhDWmb6sVmMuCJuVh43306HVacDte9</code>.</p><p>If you use a different mechanism to secure the communications
      between the SAE application and the provider, read the online help in the
      console to see how to construct your URL value.</p></li></ul></div></li><li class="listitem"><div class="itemizedlist"><p>Under Federation &gt; Entity Providers, click the name for the
     Remote SP in order to access the SP configuration on the IDP side.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under Assertion Processing &gt; Attribute Mapper, add both
      <code class="literal">mail=mail</code> and <code class="literal">branch=branch</code> to
      the attribute map, and then Save your work.</p></li><li class="listitem"><p>Under Advanced &gt; SAE Configuration, make sure the SP URL
      reflects an endpoint on the SP such as
      <code class="literal">http://sp.example.com:8080/openam/spsaehandler/metaAlias/sp</code>,
      and then Save your work.</p></li><li class="listitem"><p>Also under Advanced &gt; SAE Configuration, add the URL to the
      sample SAE application as the SP Logout URL such as
      <code class="literal">http://sp.example.com:8080/samples/saml2/sae/saeSPApp.jsp</code>,
      and then Save your work.</p></li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sae-secure-sp"></a>16.4.&nbsp;Securing the Service Provider Side</h2></div></div></div><p>This configuration uses the default sample setting of symmetric
  encryption, with a shared secret of <code class="literal">secret12</code>.</p><div class="orderedlist"><p>Login as <code class="literal">amadmin</code> to the OpenAM server console where
   you set up the hosted service provider (SP).</p><ol class="orderedlist" type="1"><li class="listitem"><p>As the sample includes a <code class="literal">branch</code> attribute not
    found in user profiles by default, under Access Control &gt;
    <em class="replaceable"><code>Realm Name</code></em> &gt; Authentication &gt; All Core
    Settings..., set User Profile to Ignored, and then Save your work.</p></li><li class="listitem"><div class="itemizedlist"><p>Under Federation &gt; Entity Providers, click the name for the
     Hosted SP in order to access the SP configuration.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Under Assertion Processing &gt; Attribute Mapper, add both
      <code class="literal">mail=mail</code> and <code class="literal">branch=branch</code> to
      the attribute map, and then Save your work.</p></li><li class="listitem"><p>Also under Assertion Processing &gt; Attribute Mapper &gt; Auto
      Federation, select Enabled, set the Attribute to <code class="literal">mail</code>,
      and then Save your work.</p></li><li class="listitem"><p>Under Advanced &gt; SAE Configuration, make sure the SP URL
      reflects an endpoint on the SP such as
      <code class="literal">http://sp.example.com:8080/openam/spsaehandler/metaAlias/sp</code>,
      and then Save your work.</p></li><li class="listitem"><p>Furthermore, under Advanced &gt; SAE Configuration, add the URL to
      the sample SAE application as the SP Logout URL such as
      <code class="literal">http://sp.example.com:8080/samples/saml2/sae/saeSPApp.jsp</code>,
      and then Save your work.</p></li><li class="listitem"><p>Also under Advanced &gt; SAE Configuration &gt; Application Security
      Configuration, add the URL value for the kind of encryption you are using,
      and then Save your work.</p><p>When using the defaults, the value is something like
      <code class="literal">url=http://sp.example.com:8080/samples/saml2/sae/saeSPApp.jsp|type=symmetric|secret=<em class="replaceable"><code>encoded-secret</code></em></code>, where the OpenAM SDK sample web
      application is deployed on the IDP side with context root
      <code class="literal">/samples</code> and the
      <em class="replaceable"><code>encoded-secret</code></em> is something like
      <code class="literal">AQICkX24RbZboAVgr2FG1kWoqRv1zM2a6KEH</code>.</p><p>If you use a different mechanism to secure the communications
      between the SAE application and the provider, read the online help in the
      console to see how to construct your URL value.</p></li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sae-trying-it-out"></a>16.5.&nbsp;Trying It Out</h2></div></div></div><p>After completing the setup described above, navigate to the IDP side
  SAE application, for example at
  <code class="literal">http://idp.example.com:8080/samples/saml2/sae/saeIDPApp.jsp</code>.</p><div class="variablelist"><p>Make sure you set at least the "SP App URL" and "SAE URL on IDP end"
   to fit your configuration. For example if you used the settings above then
   use the following values.</p><dl class="variablelist"><dt><span class="term">SP App URL</span></dt><dd><p><code class="literal">http://sp.example.com:8080/samples/saml2/sae/saeSPApp.jsp</code></p></dd><dt><span class="term">SAE URL on IDP end</span></dt><dd><p><code class="literal">http://idp.example.com:8080/openam/idpsaehandler/metaAlias/idp</code></p></dd></dl></div><p>Check the settings, and then click Generate URL to open the Secure
  Attributes Exchange IDP APP SAMPLE page.</p><p>Click the <code class="literal">ssourl</code> link in the page to start the
  exchange.</p><p>The resulting web page shows the attributes exchanged, including the
  mail and branch values used. The text of that page is something like the
  following.</p><pre class="brush: plain;">SAE SP APP SAMPLE

Secure Attrs :
mail            testuser@foo.com
sun.idpentityid http://idp.example.com:8080/openam
sun.spentityid  http://sp.example.com:8080/openam
branch          mainbranch
sun.authlevel   0</pre></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-csdk"></a>Chapter&nbsp;17.&nbsp;Using the OpenAM C API</h1></div></div></div><a class="indexterm" name="d13846e10978"></a><p>This chapter introduces OpenAM C SDK. OpenAM C SDK is available for
 selected platforms on the OpenAM <a class="link" href="http://forgerock.org/openam.html" target="_blank">nightly builds page</a>.
 Contact <a class="link" href="mailto:info@forgerock.com" target="_top">info@forgerock.com</a>
 if you need OpenAM C SDK support.</p><p>To prepare to install OpenAM C SDK, first download the version for your
 platform and unpack the archive as in the following example.</p><div class="screen"><pre>
$ <strong>mkdir -p /path/to/openam-client</strong>
$ <strong>cd /path/to/openam-client</strong>
$ <strong>unzip ~/Downloads/common_3_0_Linux_64bit.zip</strong>
 </pre></div><p>All C SDK deliveries are .zip files, and the filenames are self-explanatory.
 The <code class="filename">SunOS</code> in some of the .zip files refer to the Solaris
 OS.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">common_3_0_Linux.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_Linux_64bit.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_windows.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_windows_64bit.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_SunOS_x86.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_SunOS_64bit.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_SunOS_sparc.zip</code></p></li><li class="listitem"><p><code class="filename">common_3_0_SunOS_sparc_64bit.zip</code></p></li></ul></div><div class="variablelist"><p>Once unpacked, you have several directories that include
  the SDK, and also sample client applications.</p><dl class="variablelist"><dt><span class="term"><code class="filename">bin/</code></span></dt><dd><p>The <span class="command"><strong>crypt_util</strong></span> or <span class="command"><strong>cryptit.exe</strong></span>
    command for encrypting passwords</p></dd><dt><span class="term"><code class="filename">config/</code></span></dt><dd><p>Configuration data for the SDK</p></dd><dt><span class="term"><code class="filename">include/</code></span></dt><dd><p>Header files for the SDK</p></dd><dt><span class="term"><code class="filename">lib/</code></span></dt><dd><p>SDK and other required libraries</p></dd><dt><span class="term"><code class="filename">samples/</code></span></dt><dd><p>Sample code</p></dd></dl></div><div class="procedure"><a name="build-openam-csdk-client"></a><div class="procedure-title">Procedure&nbsp;17.1.&nbsp;To Build OpenAM C SDK Samples</div><ol class="procedure" type="1"><li class="step"><p>Review the <code class="filename">samples/README.TXT</code> file to complete
   any specific instructions required for your platform. The two commands
   shown here confirm that the specified system is a 64-bit Linux OS. Make
   sure it matches the C SDK package that you have downloaded.</p><div class="screen"><pre>
$ <strong>uname -s</strong>
<em>Linux</em>
$ <strong>uname -m</strong>
<em>x86_64</em>
   </pre></div></li><li class="step"><p>Set up <code class="filename">OpenSSOAgentBootstrap.properties</code>
   and <code class="filename">OpenSSOAgentConfiguration.properties</code> as appropriate
   for your environment.</p><p>Base your work on the template files in the
   <code class="filename">config/</code> directory. You can find the Password Encryption
   Key in the OpenAM console under Configuration &gt; Servers and Sites &gt;
   <em class="replaceable"><code>Server Name</code></em> &gt; Security.</p></li><li class="step"><p>Try one of the samples you built to test your build.</p><div class="screen"><pre>
$ <strong>LD_LIBRARY_PATH=../lib \
 ./am_auth_test \
 -f ../config/OpenSSOAgentBootstrap.properties \
 -u demo \
 -p changeit \
 -o /</strong>
<em>   Login  1 Succeeded!
      SSOToken = AQIC5wM2LY4SfcxZfk4EzC9Y46P9cXG9ogwf2ixnYOeZ0K0.*AAJTSQACMDE.*
      Organization = /
      Module Instance Name [0] = SAE
      Module Instance Name [1] = LDAP
      Module Instance Name [2] = WSSAuthModule
      Module Instance Name [3] = Federation
      Module Instance Name [4] = HOTP
      Module Instance Name [5] = DataStore
   Logout 1 Succeeded!</em>
   </pre></div></li></ol></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-extending"></a>Chapter&nbsp;18.&nbsp;Extending OpenAM</h1></div></div></div><p>OpenAM services solve a wide range of access and federation
 management problems out of the box. Yet, OpenAM also exposes APIs and
 SPIs that enable you extend OpenAM services when built-in functionality
 does not fit your deployment.</p><p>This part of the guide covers OpenAM mechanisms for plugging in
 additional functionality not available out of the box.</p></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-custom-attr"></a>Chapter&nbsp;19.&nbsp;Customizing Profile Attributes</h1></div></div></div><a class="indexterm" name="d13846e11150"></a><p>You can extend user profiles by adding custom attributes. This chapter
 demonstrates how to add a custom attribute to a user profile when storing
 user profiles in the embedded LDAP directory.</p><p>Adding a custom attribute involves both updating the
 <code class="literal">iPlanetAMUserService</code>, and also updating the identity
 repository schema to hold the new attribute. Furthermore, to allow users
 to update the attribute in their own profiles, you must also update the
 OpenAM policy configuration stored in the configuration directory.</p><div class="itemizedlist"><p>This chapter includes the following procedures.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="#add-attr-to-service-description" title="Procedure&nbsp;19.1.&nbsp;To Update the AMUser Service For the New Attribute">Procedure&nbsp;19.1, &#8220;To Update the AMUser Service For the New Attribute&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#add-attr-to-identity-repository" title="Procedure&nbsp;19.2.&nbsp;To Update the Identity Repository For the New Attribute">Procedure&nbsp;19.2, &#8220;To Update the Identity Repository For the New Attribute&#8221;</a></p></li><li class="listitem"><p><a class="xref" href="#allow-users-to-update-attr" title="Procedure&nbsp;19.3.&nbsp;To Allow Users To Update the New Attribute">Procedure&nbsp;19.3, &#8220;To Allow Users To Update the New Attribute&#8221;</a></p></li></ul></div><div class="procedure"><a name="add-attr-to-service-description"></a><div class="procedure-title">Procedure&nbsp;19.1.&nbsp;To Update the AMUser Service For the New Attribute</div><p>Follow the steps below to create a custom attribute in OpenAM.</p><ol class="procedure" type="1"><li class="step"><p>Create a backup copy of the configuration file for the
   <code class="literal">iPlanetAmUserService</code>.</p><div class="screen"><pre>
$ <strong>cp ~/openam/config/xml/amUser.xml ~/openam/config/xml/amUser.xml.orig</strong>
   </pre></div></li><li class="step"><p>Edit the file to add your attribute as one of the list of
   <code class="literal">&lt;User&gt;</code> attributes.</p><pre class="brush: xml;">&lt;AttributeSchema name="customAttribute"
    type="single"
    syntax="string"
    any="display"
    i18nKey="Custom Attribute"&gt;
&lt;/AttributeSchema&gt;</pre><p>Here, the name refers to the attribute type name used in LDAP. The
   <code class="literal">i18nKey</code> holds either the reference, or in this case the
   content, of the text that appears in the user interface.</p></li><li class="step"><p>Delete <code class="literal">iPlanetAMUserService</code>, and then create it
   from your updated configuration file.</p><div class="screen"><pre>
$ <strong>cd /path/to/tools/openam/bin/</strong>
$ <strong>ssoadm \
 delete-svc \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --servicename iPlanetAMUserService</strong>

<em>Service was deleted.</em>
$ <strong>ssoadm \
 create-svc \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --xmlfile $HOME/openam/config/xml/amUser.xml</strong>

<em>Service was added.</em>
   </pre></div></li></ol></div><div class="procedure"><a name="add-attr-to-identity-repository"></a><div class="procedure-title">Procedure&nbsp;19.2.&nbsp;To Update the Identity Repository For the New Attribute</div><p>Follow the steps below to update the identity repository LDAP schema
  for the custom attribute, and then update OpenAM to use the custom attribute
  and object class.</p><p>If you are adding an existing attribute that is already allowed on
  user profile entries, you can skip this procedure.</p><div class="tip"><h3 class="title">Tip</h3><p>If you are using OpenDJ as the identity repository, you can update the
   schema through OpenDJ Control Panel &gt; Schema &gt; Manage Schema, as
   described in the <a class="link" href="http://docs.forgerock.org/en/opendj/2.6.0/admin-guide/#update-schema" target="_blank">OpenDJ documentation</a>.</p></div><ol class="procedure" type="1"><li class="step"><p>Prepare the attribute type object class definitions in LDIF
   format.</p><div class="screen"><pre>
$ <strong>cat custom-attr.ldif</strong>
<em>dn: cn=schema
changetype: modify
add: attributeTypes
attributeTypes: ( temp-custom-attr-oid NAME 'customAttribute' EQUALITY case
 IgnoreMatch ORDERING caseIgnoreOrderingMatch SUBSTR caseIgnoreSubstrings
 Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 USAGE userApplications )
-
add: objectClasses
objectClasses: ( temp-custom-oc-oid NAME 'customObjectclass' SUP top AUXILIARY
  MAY customAttribute )</em>
   </pre></div></li><li class="step"><p>Add the schema definitions to the directory.</p><div class="screen"><pre>
$ <strong>/path/to/opendj/bin/ldapmodify \
 --port 1389 \
 --hostname openam.example.com \
 --bindDN "cn=Directory Manager" \
 --bindPassword password \
 --filename custom-attr.ldif</strong>
<em>Processing MODIFY request for cn=schema
MODIFY operation successful for DN cn=schema</em>
   </pre></div></li><li class="step"><p>In OpenAM console, browse to Access Control &gt; <em class="replaceable"><code>Realm
   Name</code></em> &gt; Data Stores &gt; <em class="replaceable"><code>Data Store
   Name</code></em>.</p></li><li class="step"><p>Add the object class, here <code class="literal">customObjectclass</code>, to
   the LDAP User Object Class list.</p></li><li class="step"><p>Add the attribute type, here <code class="literal">customAttribute</code>, to
   the LDAP User Attributes list.</p></li><li class="step"><p>Save your work.</p></li></ol></div><div class="procedure"><a name="allow-users-to-update-attr"></a><div class="procedure-title">Procedure&nbsp;19.3.&nbsp;To Allow Users To Update the New Attribute</div><p>Follow these steps to make the new attribute editable by users. The
  steps imply use of the embedded configuration directory. If you use a
  different directory server to store the configuration, then adapt them for
  your tools.</p><ol class="procedure" type="1"><li class="step"><p>Login to the control panel for the embedded configuration
   directory.</p><div class="screen"><pre>
$ <strong>./openam/opends/bin/control-panel &amp;</strong>
   </pre></div><p>Connect using bind DN <code class="literal">cn=Directory Manager</code> and the
   the password for <code class="literal">amadmin</code>.</p></li><li class="step"><p>Select Manage Entries to open the LDAP browser.</p></li><li class="step"><p>Search with <code class="literal">LDAP Filter:</code> set to
   <code class="literal">ou=SelfWriteAttributes</code>, and then expand the tree views
   to see the two entries found.</p></li><li class="step"><p>In the entry under <code class="literal">iPlanetAMPolicyService</code>, edit
   the <code class="literal">sunKeyValue</code> attribute to add your custom attribute to
   the list of self-writable attributes, as in
   <code class="literal">&lt;Value&gt;customAttribute&lt;/Value&gt;</code>.</p></li><li class="step"><p>In the entry under <code class="literal">sunEntitlementIndexes</code>, edit
   the <code class="literal">sunKeyValue</code> attribute to add your custom attribute to
   the list of self-writable attributes, as in replacing the last
   <code class="literal">\n</code> in the list with <code class="literal">,\n
   \"customAttribute\"\n</code>.</p></li><li class="step"><p>Restart OpenAM or the web container where it runs. The following example applies to Tomcat.</p><div class="screen"><pre>
$ <strong>/path/to/tomcat/bin/shutdown.sh</strong>
$ <strong>/path/to/tomcat/bin/startup.sh</strong>
   </pre></div></li><li class="step"><p>Login to OpenAM console as a user to check that a user can save a
   value for your new, custom attribute.</p><div class="mediaobject" align="center"><a name="figure-bjensen-with-custom-attribute"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/bjensen-with-custom-attribute.png" align="middle" height="360" alt="Saving Babs Jensen's profile with a custom attribute"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-bjensen-with-custom-attribute.html" target="longdesc">D</a>]</span></div></div></li></ol></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-oauth2-scopes"></a>Chapter&nbsp;20.&nbsp;Customizing OAuth 2.0 Scope Handling</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#design-oauth2-scopes-plugin">20.1. Designing an OAuth 2.0 Scope Validator Plugin</a></span></dt><dt><span class="section"><a href="#build-oauth2-scopes-plugin">20.2. Building the OAuth 2.0 Scope Validator Sample Plugin</a></span></dt><dt><span class="section"><a href="#configure-oauth2-scopes-plugin">20.3. Configuring OpenAM to Use the Plugin</a></span></dt><dt><span class="section"><a href="#try-oauth2-scopes-plugin">20.4. Trying the Sample Plugin</a></span></dt></dl></div><a class="indexterm" name="d13846e11371"></a><p>
  RFC 6749, <a class="link" href="http://tools.ietf.org/html/rfc6749" target="_blank"><em class="citetitle">The OAuth 2.0 Authorization Framework</em></a>,
  describes access token scopes as a set of case-sensitive strings
  defined by the authorization server.
  Clients can request scopes, and resource owners can authorize them.
 </p><p>
  The default scopes implementation in OpenAM treats scopes
  as profile attributes for the resource owner.
  When a resource server or other entity uses the access token
  to get token information from OpenAM,
  OpenAM populates the scopes with profile attribute values.
  For example, if one of the scopes is <code class="literal">mail</code>,
  OpenAM sets <code class="literal">mail</code> to the resource owner's email address
  in the token information returned.
 </p><p>
  You can change this behavior by writing your own scope validator plugin.
  This chapter shows how to write a custom OAuth 2.0 scope validator plugin
  for use in an OAuth 2.0 provider (authorization server) configuration.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="design-oauth2-scopes-plugin"></a>20.1.&nbsp;Designing an OAuth 2.0 Scope Validator Plugin</h2></div></div></div><p>
   A scope validator plugin implements the
   <code class="literal">org.forgerock.oauth2.core.ScopeValidator</code> interface.
   As described in the API specification, the
   <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/?org/forgerock/oauth2/core/ScopeValidator.html" target="_blank"><code class="literal">ScopeValidator</code> interface</a>
   has several methods that your plugin overrides.
  </p><p>
   The following example plugin sets whether
   <code class="literal">read</code> and <code class="literal">write</code> permissions were granted.
  </p><pre class="brush: java;">
package org.forgerock.openam.examples;

import org.forgerock.oauth2.core.AccessToken;
import org.forgerock.oauth2.core.ClientRegistration;
import org.forgerock.oauth2.core.OAuth2Request;
import org.forgerock.oauth2.core.ScopeValidator;
import org.forgerock.oauth2.core.Token;
import org.forgerock.oauth2.core.exceptions.InvalidClientException;
import org.forgerock.oauth2.core.exceptions.ServerException;
import org.forgerock.oauth2.core.exceptions.UnauthorizedClientException;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

/**
 * Custom scope validators implement the
 * {@link org.forgerock.oauth2.core.ScopeValidator} interface.
 *
 * &lt;p&gt;
 * This example sets read and write permissions according to the scopes set.
 * &lt;/p&gt;
 *
 * &lt;ul&gt;
 *
 * &lt;li&gt;
 * The {@code validateAuthorizationScope} method
 * adds default scopes, or any allowed scopes provided.
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code validateAccessTokenScope} method
 * adds default scopes, or any allowed scopes provided.
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code validateRefreshTokenScope} method
 * adds the scopes from the access token,
 * or any requested scopes provided that are also in the access token scopes.
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code getUserInfo} method
 * populates scope values and sets the resource owner ID to return.
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code evaluateScope} method
 * populates scope values to return.
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code additionalDataToReturnFromAuthorizeEndpoint} method
 * returns no additional data (an empty Map).
 * &lt;/li&gt;
 *
 * &lt;li&gt;
 * The {@code additionalDataToReturnFromTokenEndpoint} method
 * adds no additional data.
 * &lt;/li&gt;
 *
 * &lt;/ul&gt;
 */
public class CustomScopeValidator implements ScopeValidator {
    @Override
    public Set&lt;String&gt; validateAuthorizationScope(
            ClientRegistration clientRegistration,
            Set&lt;String&gt; scope) {
        if (scope == null || scope.isEmpty()) {
            return clientRegistration.getDefaultScopes();
        }

        Set&lt;String&gt; scopes = new HashSet&lt;String&gt;(
                clientRegistration.getAllowedScopes());
        scopes.retainAll(scope);
        return scopes;
    }

    @Override
    public Set&lt;String&gt; validateAccessTokenScope(
            ClientRegistration clientRegistration,
            Set&lt;String&gt; scope,
            OAuth2Request request) {
        if (scope == null || scope.isEmpty()) {
            return clientRegistration.getDefaultScopes();
        }

        Set&lt;String&gt; scopes = new HashSet&lt;String&gt;(
                clientRegistration.getAllowedScopes());
        scopes.retainAll(scope);
        return scopes;
    }

    @Override
    public Set&lt;String&gt; validateRefreshTokenScope(
            ClientRegistration clientRegistration,
            Set&lt;String&gt; requestedScope,
            Set&lt;String&gt; tokenScope,
            OAuth2Request request) {
        if (requestedScope == null || requestedScope.isEmpty()) {
            return tokenScope;
        }

        Set&lt;String&gt; scopes = new HashSet&lt;String&gt;(tokenScope);
        scopes.retainAll(requestedScope);
        return scopes;
    }

    /**
     * Set read and write permissions according to scope.
     *
     * @param token The access token presented for validation.
     * @return The map of read and write permissions,
     *         with permissions set to {@code true} or {@code false},
     *         as appropriate.
     */
    private Map&lt;String,Object&gt; mapScopes(AccessToken token) {
        Set&lt;String&gt; scopes = token.getScope();
        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        final String[] permissions = {"read", "write"};

        for (String scope : permissions) {
            if (scopes.contains(scope)) {
                map.put(scope, true);
            } else {
                map.put(scope, false);
            }
        }
        return map;
    }

    @Override
    public Map&lt;String, Object&gt; getUserInfo(
            AccessToken token,
            OAuth2Request request)
            throws UnauthorizedClientException {
        Map&lt;String, Object&gt; response = mapScopes(token);
        response.put("sub", token.getResourceOwnerId());
        return response;
    }

    @Override
    public Map&lt;String, Object&gt; evaluateScope(AccessToken token) {
        return mapScopes(token);
    }

    @Override
    public Map&lt;String, String&gt; additionalDataToReturnFromAuthorizeEndpoint(
            Map&lt;String, Token&gt; tokens,
            OAuth2Request request) {
        return new HashMap&lt;String, String&gt;(); // No special handling
    }

    @Override
    public void additionalDataToReturnFromTokenEndpoint(
            AccessToken token,
            OAuth2Request request)
            throws ServerException, InvalidClientException {
        // No special handling
    }
}
  </pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="build-oauth2-scopes-plugin"></a>20.2.&nbsp;Building the OAuth 2.0 Scope Validator Sample Plugin</h2></div></div></div><p>
   The
   <a class="link" href="https://github.com/markcraig/openam-scope-sample" target="_blank">sample scope validator plugin source</a>
   is available online.
   Get a local clone so that you can try the sample on your system.
   In the sources you find the following files.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="filename">pom.xml</code></span></dt><dd><p>
      Apache Maven project file for the module
     </p><p>
      This file specifies how to build the sample scope validator plugin,
      and also specifies its dependencies on OpenAM components.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/CustomScopeValidator.java</code></span></dt><dd><p>
      Core class for the sample OAuth 2.0 scope validator plugin
     </p><p>
      See <a class="xref" href="#design-oauth2-scopes-plugin" title="20.1.&nbsp;Designing an OAuth 2.0 Scope Validator Plugin">Section&nbsp;20.1, &#8220;Designing an OAuth 2.0 Scope Validator Plugin&#8221;</a> for a listing.
     </p></dd></dl></div><p>
   Build the module using Apache Maven.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/openam-scope-sample</strong>
$ <strong>mvn install</strong>
<em>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building openam-scope-sample 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

...

[INFO]
[INFO] --- maven-jar-plugin:2.3.2:jar (default-jar) @ openam-scope-sample ---
[INFO] Building jar: .../target/openam-scope-sample-1.0.0-SNAPSHOT.jar

...

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.827s
[INFO] Finished at: Tue Jun 03 10:40:31 CEST 2014
[INFO] Final Memory: 27M/357M
[INFO] ------------------------------------------------------------------------</em>
  </pre></div><p>
   After you successfully build the module,
   you find the .jar in the <code class="filename">target/</code> directory of the project.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-oauth2-scopes-plugin"></a>20.3.&nbsp;Configuring OpenAM to Use the Plugin</h2></div></div></div><p>
   After building your plugin .jar file, copy the .jar file
   under <code class="filename">WEB-INF/lib/</code> where you deployed OpenAM.
  </p><p>
   Restart OpenAM or the container in which it runs.
  </p><p>
   In OpenAM console, you can either
   configure a specific OAuth 2.0 provider to use your plugin,
   or configure your plugin as the default for new OAuth 2.0 providers.
   In either case, you need the class name of your plugin.
   The class name for the sample plugin is
   <code class="literal">org.forgerock.openam.examples.CustomScopeValidator</code>.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     To configure a specific OAuth 2.0 provider to use your plugin,
     add the class name of your scopes plugin under Access Control &gt;
     <em class="replaceable"><code>Realm Name</code></em> &gt; Services &gt; <em class="replaceable"><code>OAuth2 Provider Name</code></em> &gt; Scope Implementation Class.
    </p></li><li class="listitem"><p>
     To configure your plugin as the default for new OAuth 2.0 providers,
     add the class name of your scopes plugin under Configuration &gt;
     Global &gt; OAuth2 Provider &gt; Scope Implementation Class.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="try-oauth2-scopes-plugin"></a>20.4.&nbsp;Trying the Sample Plugin</h2></div></div></div><p>
   In order to try the sample plugin,
   make sure you have configured an OAuth 2.0 provider to use the sample plugin.
   Also, set up an OAuth 2.0 client of the provider
   that takes scopes <code class="literal">read</code> and <code class="literal">write</code>.
  </p><p>
   Next try the provider as shown in the following example.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --data "grant_type=client_credentials&amp;username=demo&amp;password=changeit\
&amp;client_id=myClientID&amp;client_secret=password&amp;scope=read" \
 https://openam.example.com:8443/openam/oauth2/access_token</strong>

<em>{
    "scope": "read",
    "expires_in": 59,
    "token_type": "Bearer",
    "access_token": "c8860442-daba-4af0-a1d9-b607c03e5a0b"
}</em>

$ <strong>curl https://openam.example.com:8443/openam/oauth2/tokeninfo\
?access_token=0d492486-11a7-4175-b116-2fc1cbff6d78</strong>
<em>{
    "scope": [
        "read"
    ],
    "grant_type": "client_credentials",
    "realm": "/",
    "write": false,
    "read": true,
    "token_type": "Bearer",
    "expires_in": 24,
    "access_token": "c8860442-daba-4af0-a1d9-b607c03e5a0b"
}</em>
  </pre></div><p>
   As seen in this example, the requested scope <code class="literal">read</code> is
   authorized, but the <code class="literal">write</code> scope has not been authorized.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-scripted-auth-module"></a>Chapter&nbsp;21.&nbsp;Scripted Authentication</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#scripted-auth-module-about">21.1. About Authentication Module Scripts</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-api">21.2. Authentication Script API</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-javascript-example">21.3. Example JavaScript Authentication Module</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-groovy-example">21.4. Example Groovy Authentication Module</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-try-it-out">21.5. Trying It Out</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-sandbox">21.6. Scripted Authentication Sandbox</a></span></dt></dl></div><p>
  This chapter demonstrates how to develop scripts
  for a scripted authentication module.
 </p><a class="indexterm" name="d13846e11529"></a><p>
  A scripted authentication module allows you to develop
  a custom authentication module by adding Groovy or JavaScript
  to the module configuration.
  Scripted authentication modules are an alternative to developing
  custom authentication modules in Java as described in
  <a href="../dev-guide/index.html#chap-auth-spi" class="link"><em class="citetitle">Customizing Authentication Modules</em></a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-about"></a>21.1.&nbsp;About Authentication Module Scripts</h2></div></div></div><p>
   This section explains how client-side and server-side scripts
   cooperate to perform authentication.
  </p><p>
   A scripted authentication module runs scripts to authenticate a user.
   The configuration for the module can hold two scripts,
   one to include in the web page run on the client user-agent,
   another to run in OpenAM on the server side.
  </p><p>
   The client-side script is intended to retrieve data from the user-agent.
   This must be in a language the the user-agent, such as JavaScript,
   even if the server-side script is written in Groovy.
  </p><p>
   The client-side script data is returned to OpenAM by self-submitting form.
   This makes the client-side data available to the server-side script.
   The client-side script does this by adding data to a String object,
   <code class="literal">clientScriptOutputData</code>.
  </p><p>
   The server-side script is intended to handle authentication.
  </p><p>
   The server-side script runs after the client-side script has completed.
   The server-side script has access both
   to information added by the client-side script to
   <code class="literal">clientScriptOutputData</code>,
   and also to several objects from OpenAM
   described in <a class="xref" href="#scripted-auth-module-api" title="21.2.&nbsp;Authentication Script API">Section&nbsp;21.2, &#8220;Authentication Script API&#8221;</a>,
   allowing it to make an authentication decision.
   The server-side script thus must at minimum set the authentication state
   to success or failure.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-api"></a>21.2.&nbsp;Authentication Script API</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#scripted-auth-module-auth-state">21.2.1. Accessing Authentication State</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-client-data">21.2.2. Access Client-Side Script Output Data</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-http-client">21.2.3. Accessing HTTP Services</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-id-repo">21.2.4. Accessing Profile Data</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-logger">21.2.5. Logging</a></span></dt><dt><span class="section"><a href="#scripted-auth-module-request-data">21.2.6. Accessing Request Data</a></span></dt></dl></div><p>
   Client-side scripts have access only to the user-agent API.
   That API of course depends on the user agent.
  </p><div class="itemizedlist"><p>
    Server-side scripts have access to objects from OpenAM
    for the following uses.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-auth-state" title="21.2.1.&nbsp;Accessing Authentication State">Section&nbsp;21.2.1, &#8220;Accessing Authentication State&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-client-data" title="21.2.2.&nbsp;Access Client-Side Script Output Data">Section&nbsp;21.2.2, &#8220;Access Client-Side Script Output Data&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-http-client" title="21.2.3.&nbsp;Accessing HTTP Services">Section&nbsp;21.2.3, &#8220;Accessing HTTP Services&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-id-repo" title="21.2.4.&nbsp;Accessing Profile Data">Section&nbsp;21.2.4, &#8220;Accessing Profile Data&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-logger" title="21.2.5.&nbsp;Logging">Section&nbsp;21.2.5, &#8220;Logging&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="#scripted-auth-module-request-data" title="21.2.6.&nbsp;Accessing Request Data">Section&nbsp;21.2.6, &#8220;Accessing Request Data&#8221;</a>
    </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-auth-state"></a>21.2.1.&nbsp;Accessing Authentication State</h3></div></div></div><p>
    OpenAM passes <code class="literal">authState</code> and <code class="literal">sharedState</code>
    to server-side scripts in order for the scripts
    to access authentication state.
   </p><p>
    Server-side scripts can access the current authentication state
    through the <code class="literal">authState</code> object.
   </p><p>
    The <code class="literal">authState</code> value is <code class="literal">SUCCESS</code>
    if the authentication is currently successful,
    or <code class="literal">FAILED</code> if authentication has failed.
    Server-side scripts must set a value for <code class="literal">authState</code>
    before completing.
   </p><p>
    If an earlier authentication module in the authentication chain
    has set the login name of the user,
    server-side scripts can access the login name
    through <code class="literal">username</code>.
    This is shared by
    Anonymous,
    Certificate,
    Data Store,
    Federation,
    HTTP Basic,
    JDBC,
    LDAP,
    Membership,
    RADIUS,
    <span lang="en" class="phrase">
SecurID,
</span>
    Windows Desktop SSO,
    &amp; Windows NT
    authentication modules.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-client-data"></a>21.2.2.&nbsp;Access Client-Side Script Output Data</h3></div></div></div><p>
    Client-side scripts add data they gather into a String object
    named <code class="literal">clientScriptOutputData</code>.
    Client-side scripts then cause the user-agent automatically
    to return the data to OpenAM by HTTP POST of a self-submitting form.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-http-client"></a>21.2.3.&nbsp;Accessing HTTP Services</h3></div></div></div><p>
    OpenAM passes an HTTP client object, <code class="literal">httpClient</code>,
    to server-side scripts.
    Server-side scripts can call HTTP services
    with the <code class="literal">httpClient.get</code>
    and <code class="literal">httpClient.post</code> methods.
    The methods return an <code class="literal">HttpClientResponse</code>.
   </p><div class="table"><a name="scripted-auth-module-http-client-methods"></a><div class="table-title">Table&nbsp;21.1.&nbsp;HTTP Client Methods</div><div class="table-contents"><table summary="HTTP Client Methods" width="100%" border="0"><colgroup><col width="12%"><col width="25%"><col width="25%"><col width="38%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">get</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>uri</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>requestData</code></em></code> (type:
         <code class="literal">Map</code>)
        </p>
       </td><td>
        <p>
         <code class="literal">HttpClientResponse</code>
        </p>
       </td><td>
        <p>
         Perform an HTTP GET on the specified URI
         with the specified request data,
         and return the response retrieved.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">post</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>uri</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>body</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>requestData</code></em></code> (type:
         <code class="literal">Map</code>)
        </p>
       </td><td>
        <p>
         <code class="literal">HttpClientResponse</code>
        </p>
       </td><td>
        <p>
         Perform an HTTP POST to the specified URI
         with the specified body and request data,
         and return the response retrieved.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"><p>
    The <code class="literal">requestData</code> object is a map where the keys are
    <code class="literal">cookies</code> and <code class="literal">headers</code>. OpenAM ignores other keys.
   </p><p>
    The <code class="literal">cookies</code> value, specifying the cookie headers in the
    request, is a list of Maps where the keys are <code class="literal">domain</code>,
    <code class="literal">field</code>, and <code class="literal">value</code>.
   </p><p>
    The <code class="literal">headers</code> value, specifying the headers in the request,
    is a list of Maps where the keys are <code class="literal">field</code>, and
    <code class="literal">value</code>.
   </p><p>An example <code class="literal">requestData</code> JavaScript object using GET
    would be as follows:</p><pre class="brush: javascript;">
var response = httpClient.get("http://example.com:8080/openam/json/users" + username,
 {
   cookies:[
    {
       "domain": ".example.com",
       "field": "iPlanetDirectoryPro,
       "value": "E8cDkvlad83kdKDodkIEIxqJ938DKSDLIE31djkiefjekda.*DLEDLKJKD09dkleuhDK3kEJKj"
    }
   ],
   headers:[
    {
       "field": "Content-type",
       "value": "application/json"
    }
   ]
 });
   </pre><p>An example <code class="literal">requestData</code> JavaScript object using POST
    would be as follows:</p><pre class="brush: javascript;">
var response = httpClient.post("http://example.com:8080/openam/json/authenticate","{
  "authId": "eyAiYWxnIjogIkhTMjU2IiwgInR5cCI6ICJqd3QiIH0.eyAib3RrIjogIm03ODVzN2x
   sbnR1bjZvbGZ1MHZhOGVtYTQxIiwgInNlc3Npb25JZCI6ICJBUUlDNXdNMkxZNFNmY3lEeDY3QnB
   PdzJtRU9rUzNpLWhfNDdRWlMwNHBEN1ppdy4qQUFKVFNRQUNNREVBQWxOTEFCUXROak15TURjNU1
   UZzROVFUwTXpnNE5qRTNNQS4uKiIsICJyZWFsbSI6ICJkYz1vcGVuYW0sZGM9Zm9yZ2Vyb2NrLGR
   jPW9yZyIgfQ.VDRqaekQuXBm2lNI29hfwVADLxjepezuO0241VNDsIM",
  "template": "",
  "stage": "DataStore1",
  "callbacks": [
    {
      "type": "NameCallback",
      "output": [
        {
          "name": "prompt",
          "value": "User Name:"
        }
       ],
      "input": [
        {
          "name": "IDToken1",
          "value": "demo"
        }
       ]
    },
    {
      "type": "PasswordCallback",
      "output": [
        {
          "name": "prompt",
          "value": "Password:"
        }
       ],
      "input": [
        {
          "name": "IDToken2",
          "value": "changeit"
        }
      ]
    }
  ]
 }",
 {
   cookies:[
   ],
   headers:[
    {
      "field": "Content-Type",
      "value": "application/json"
    }
   ]
 });
</pre><div class="note"><h3 class="title">Note</h3><p>To get the form data, you can access the <code class="literal">sharedState</code>
    object to get the data that previous modules in the chain have obtained.
    For example, if you have a DataStore module in your chain, you can get the
    username and password from the <code class="literal">sharedState</code> object in the
    script.
   </p></div><p>
    HTTP client requests are synchronous, blocking until they return.
    You can, however, set a global timeout for server-side scripts.
    For details, see the <em class="citetitle">Administration Guide</em> section,
    <a href="../admin-guide/index.html#scripted-module-conf-hints" class="link"><em class="citetitle">Hints For Scripted Authentication Modules</em></a>.
   </p><p>
    Server-side scripts can access response data by using the methods
    listed in the table below.
   </p><div class="table"><a name="scripted-auth-module-http-client-response-methods"></a><div class="table-title">Table&nbsp;21.2.&nbsp;HTTP Client Response Methods</div><div class="table-contents"><table summary="HTTP Client Response Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getCookies</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Map&lt;String, String&gt;</code>
        </p>
       </td><td>
        <p>
         Get the cookies for the returned response, if any exist.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getEntity</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Get the entity of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Map&lt;String, String&gt;</code>
        </p>
       </td><td>
        <p>
         Get the headers for the returned response, if any exist.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getReasonPhrase</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Get the reason phrase of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getStatusCode</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Integer</code>
        </p>
       </td><td>
        <p>
         Get the status code of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">hasCookies</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         Indicates whether the returned response had any cookies.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">hasHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         Indicates whether the returned response had any headers.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-id-repo"></a>21.2.4.&nbsp;Accessing Profile Data</h3></div></div></div><p>
    Server-side scripts can access profile data through
    the methods of the <code class="literal">idRepository</code> object.
   </p><div class="table"><a name="scripted-auth-module-id-repo-methods"></a><div class="table-title">Table&nbsp;21.3.&nbsp;Profile Data Methods</div><div class="table-contents"><table summary="Profile Data Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         Set
        </p>
       </td><td>
        <p>
         Return the values of the named attribute for the named user.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">setAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeValue</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Set the named attribute to the specified value for the named user,
         and persist the result in the user's profile.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">addAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeValue</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Adds an attribute value to the list of attribute values associated with the
         attribute name for a particular user.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-logger"></a>21.2.5.&nbsp;Logging</h3></div></div></div><p>
    Server-side scripts can log messages to OpenAM debug logs
    by using the methods of the <code class="literal">logger</code> object.
   </p><p>
    By default, OpenAM does not log debug messages from scripts.
    You can configure OpenAM to log such messages
    by setting the debug log level for the <code class="literal">amScript</code> service.
    For details, see the <em class="citetitle">Administration Guide</em> section,
    <a href="../admin-guide/index.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
   </p><p>
    The following table lists the <code class="literal">logger</code> methods.
   </p><div class="table"><a name="scripted-auth-module-logger-methods"></a><div class="table-title">Table&nbsp;21.4.&nbsp;Logger Methods</div><div class="table-contents"><table summary="Logger Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">error</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if ERROR level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">errorEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when ERROR level debug messages are enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">message</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if MESSAGE level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">messageEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when MESSAGE level debug messages are enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">warning</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if WARNING level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">warningEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when WARNING level debug messages are enabled.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-request-data"></a>21.2.6.&nbsp;Accessing Request Data</h3></div></div></div><p>
    Server-side scripts can get access to the login request
    by using the methods of the <code class="literal">requestData</code> object.
   </p><p>
    The following table lists the methods
    of the <code class="literal">requestData</code> object. Note that this object differs
    from the client-side <code class="literal">requestData</code> object (see
     <a class="xref" href="#scripted-auth-module-http-client-methods" title="Table&nbsp;21.1.&nbsp;HTTP Client Methods">Table&nbsp;21.1, &#8220;HTTP Client Methods&#8221;</a>)
    and contains information about the original authentication request made by the user.
   </p><div class="table"><a name="scripted-auth-module-request-data-methods"></a><div class="table-title">Table&nbsp;21.5.&nbsp;Request Data Methods</div><div class="table-contents"><table summary="Request Data Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getHeader</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Return the String value of the named request header,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String[]</code>
        </p>
       </td><td>
        <p>
         Return the array of String values of the named request header,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getParameter</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Return the String value of the named request parameter,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getParameters</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String[]</code>
        </p>
       </td><td>
        <p>
         Return the array of String values of the named request parameter,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-javascript-example"></a>21.3.&nbsp;Example JavaScript Authentication Module</h2></div></div></div><p>
   This section demonstrates an authentication module
   with server-side JavaScript.
  </p><p>
   Before you start, make sure OpenAM is installed and configured,
   and create a new Scripted Module authentication module configuration
   in the realm / (Top Level Realm), called <code class="literal">JavaScript</code>.
  </p><p>
   To create the module configuration, browse in OpenAM Console
   to Access Control &gt; / (Top Level Realm) &gt; Authentication &gt; Module Instances,
   and then click New.
   The name of your new module should be <code class="literal">JavaScript</code>,
   and the type should be <code class="literal">Scripted Module</code>.
  </p><p>
   Next, browse to the new authentication module configuration in OpenAM console
   under Module Instances &gt; JavaScript.
  </p><p>
   You notice that an example server-side script already exists.
   Replace that script with the following program listing.
  </p><pre class="brush: javascript;">
var START_TIME = 9;  // 9am
var END_TIME   = 17; // 5pm

logger.message("Starting server-side JavaScript");
logger.message("User: " + username);

var now = new Date();
logger.message("Current time: " + now.getHours());

if (now.getHours() &lt; START_TIME || now.getHours() &gt; END_TIME) {
    logger.error("Login forbidden outside work hours!");
    authState = FAILED;
} else {
    logger.message("Authentication allowed!");
    authState = SUCCESS;
}
  </pre><p>
   This server-side script simply allows users to authenticate successfully
   if they login between 9 AM and 5 PM (according to the server time zone).
   It demonstrates logging messages to OpenAM debug logs.
  </p><p>
   If you are trying this script outside "work hours",
   then edit the <code class="literal">START_TIME</code> or <code class="literal">END_TIME</code>.
  </p><p>
   In addition, debug logging for server-side scripts is not enabled by default.
   Configure message-level debug logging for scripted authentication modules
   by setting the debug log level for the <code class="literal">amScript</code> service.
   For details, see the <em class="citetitle">Administration Guide</em> section,
   <a href="../admin-guide/index.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
  </p><p>
   At this point, the authentication module is ready for use.
   You can either add an example Groovy scripted authentication module as well
   as described in <a class="xref" href="#scripted-auth-module-groovy-example" title="21.4.&nbsp;Example Groovy Authentication Module">Section&nbsp;21.4, &#8220;Example Groovy Authentication Module&#8221;</a>,
   or use the current module alone
   as described in <a class="xref" href="#scripted-auth-module-try-it-out" title="21.5.&nbsp;Trying It Out">Section&nbsp;21.5, &#8220;Trying It Out&#8221;</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-groovy-example"></a>21.4.&nbsp;Example Groovy Authentication Module</h2></div></div></div><p>
   This section demonstrates an authentication module
   with a server-side Groovy script.
  </p><p>
   Create a new Scripted Module authentication module
   for a server-side Groovy script as described for the JavaScript module
   in <a class="xref" href="#scripted-auth-module-javascript-example" title="21.3.&nbsp;Example JavaScript Authentication Module">Section&nbsp;21.3, &#8220;Example JavaScript Authentication Module&#8221;</a>.
   The name of your new module should be <code class="literal">Groovy</code>,
   and the type should be <code class="literal">Scripted Module</code>.
  </p><p>
   Next, browse to the new authentication module configuration in OpenAM console
   under Module Instances &gt; Groovy.
  </p><p>
   Set the Server-Side Script Language to Groovy.
  </p><p>
   Also notice that an example server-side script already exists.
   Replace that script with the following program listing.
  </p><pre class="brush: java;">
START_TIME = 9   // 9am
END_TIME   = 17  // 5pm

logger.message("Starting server-side Groovy script")
logger.message("User: " + username)

now = new Date()
logger.message("Current time: " + now.getHours())

if (now.getHours() &lt; START_TIME || now.getHours() &gt; END_TIME) {
    logger.error("Login forbidden outside work hours!")
    authState = FAILED
} else {
    logger.message("Authentication allowed!")
    authState = SUCCESS
}
  </pre><p>
   This server-side script simply allows users to authenticate successfully
   if they login between 9 AM and 5 PM (according to the server time zone).
   It demonstrates logging messages to OpenAM debug logs.
  </p><p>
   If you are trying this script outside "work hours",
   then edit the <code class="literal">START_TIME</code> or <code class="literal">END_TIME</code>.
  </p><p>
   In addition, debug logging for server-side scripts is not enabled by default.
   If you have not already done so,
   configure message-level debug logging for scripted authentication modules
   by setting the debug log level for the <code class="literal">amScript</code> service.
   For details, see the <em class="citetitle">Administration Guide</em> section,
   <a href="../admin-guide/index.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
  </p><p>
   At this point, the authentication module is ready for use.
   You can use the module as described in
   <a class="xref" href="#scripted-auth-module-try-it-out" title="21.5.&nbsp;Trying It Out">Section&nbsp;21.5, &#8220;Trying It Out&#8221;</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-try-it-out"></a>21.5.&nbsp;Trying It Out</h2></div></div></div><p>
   You can put the example scripted authentication modules
   into an authentication chain, and then try them out.
  </p><p>
   First create a new authentication chain.
   In OpenAM console under
   Access Control &gt; / (Top Level Realm) &gt; Authentication &gt; Authentication Chaining
   click New, and then name your new chain <code class="literal">scripted</code>.
  </p><p>
   After creating the chain, click Authentication Chaining &gt; scripted
   to edit the configuration for the chain.
  </p><p>
   Add a DataStore module as REQUIRED to the chain first.
   The DataStore module checks the user credentials,
   whereas the scripted authentication modules do not check credentials,
   but instead only check that the authentication request
   is processed during working hours.
   Without the DataStore module, therefore, the <code class="literal">username</code>
   in the scripted authentication modules could not be determined.
  </p><p>
   After the DataStore module, add as REQUIRED either or both
   of the example scripted authentication modules you configured to the chain.
   For example, if you add both the JavaScript and Groovy modules,
   then your <code class="literal">scripted</code> chain would have three REQUIRED modules,
   first the DataStore module, and then JavaScript and Groovy modules.
   Make sure you save the chain configuration.
  </p><p>
   To try the new authentication chain, first log out of OpenAM.
   Next, browse to the login URI for the chain
   <code class="literal">/XUI/#login/&amp;service=scripted</code>,
   where the full URL depends on your deployment,
   and is something like
   <code class="literal">http://openam.example.com:8080/openam/XUI/#login/&amp;service=scripted</code>.
  </p><p>
   Login as the sample user having
   username <code class="literal">demo</code> and password <code class="literal">changeit</code>.
  </p><p>
   When you complete the login process successfully, you should see
   the sample user profile page.
   You should also see messages such as the following
   in the <code class="filename">debug/Authentication</code> log file.
  </p><pre class="brush: plain;">
amScript:07/08/2014 11:31:21:835 AM CEST: Thread[pool-19-thread-5,5,main]
Starting server-side JavaScript
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
User: demo
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
Current time: 11
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
Authentication allowed!
amScript:07/08/2014 11:31:22:567 AM CEST: Thread[pool-19-thread-6,5,main]
Starting server-side Groovy script
amScript:07/08/2014 11:31:22:567 AM CEST: Thread[pool-19-thread-6,5,main]
User: demo
amScript:07/08/2014 11:31:22:568 AM CEST: Thread[pool-19-thread-6,5,main]
Current time: 11
amScript:07/08/2014 11:31:22:568 AM CEST: Thread[pool-19-thread-6,5,main]
Authentication allowed!
  </pre><p>
   If the login process fails due to errors in your scripts,
   then see the same log file for information about the errors.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-sandbox"></a>21.6.&nbsp;Scripted Authentication Sandbox</h2></div></div></div><p>The OpenAM console provides a sandboxing feature to test your Javascript
   or Groovy scripted authentication modules, ensuring that malicious Java classes
   are not directly called.

   The sandbox validates the script by checking that all directly-called Java
   classes match those in a whitelist of classes that are allowed to be invoked.
  </p><p>You can configure the sandbox in the console by navigating to Configuration &gt;
   Authentication &gt; Scripted Module.
  </p><p>The sandbox supports the following features:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>Java Class Whitelist</strong></span>. Specifies the list
     of class-name patterns allowed to be invoked by the script. Every class
     accessed by the script must match at least one of these patterns. You can
     specify the classes as is or use "*" wildcards. The default whitelist values
     are stored in the <code class="literal">amAuthScripted.xml</code> file.
    </p></li><li class="listitem"><p><span class="bold"><strong>Java Class Blacklist</strong></span>. Specifies the list
     of class-name patterns that are NOT allowed to be invoked by the script.
     The blacklist is applied AFTER the whitelist to exclude those classes.

     You can specify the classes to exclude as is or use "*" wildcards.
     The default blacklist values are stored in the <code class="literal">amAuthScripted.xml</code> file.
    </p></li><li class="listitem"><p><span class="bold"><strong>Using System SecurityManager</strong></span>. If enabled,
     the sandbox will make an additional call to
     <code class="literal">System.getSecurityManager().checkPackageAccess(...)</code>
     for each class that is accessed. The method throws a SecurityException
     if the calling thread is not allowed to access the package.
     This feature only takes effect if the security manager is enabled for the JVM.
    </p></li></ul></div><div class="variablelist"><div class="variablelist-title">Points about the Scripted Authentication Sandbox</div><dl class="variablelist"><dt><span class="term">Sandbox only validates directly accessible classes.</span></dt><dd><p>The sandbox only applies to classes that the script <span class="emphasis"><em>directly</em></span>
      accesses. If the script calls <code class="literal">Foo.a()</code> and then that method
      calls Bar.b(), then the sandbox will allow it. You must consider the whole
      chain of accessible classes from each white-listed class.
     </p><div class="note"><h3 class="title">Note</h3><p>"Access" means importing/loading a class,
      accessing any instance of that class (for example, passed as a parameter
      to the script), calling a static method on that class, calling a method on
      an instance of that class, accessing a method or field that returns an
      instance of that class, etc.
     </p></div></dd><dt><span class="term">All Java reflection classes are blacklisted by default.</span></dt><dd><p>All Java reflection classes (<code class="literal">java.lang.Class, java.lang.reflect.*</code>)
      are blacklisted by default to avoid bypassing the sandbox.
      Do not enable these reflection classes.
     </p></dd><dt><span class="term"><code class="literal">java.security.AccessController</code> is blacklisted by default.</span></dt><dd><p>The <code class="literal">java.security.AccessController</code> is blacklisted by default
      to prevent access to the <code class="literal">doPrivileged()</code> methods.
     </p></dd><dt><span class="term">No knowledge about inheritance.</span></dt><dd><p>The whitelist patterns apply only to the exact class or package names
      involved. The sandbox does not know anything about inheritance, so it is
      best to white list known, specific classes.
     </p></dd></dl></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-auth-spi"></a>Chapter&nbsp;22.&nbsp;Customizing Authentication Modules</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-custom-auth-module">22.1. About the Sample Authentication Module</a></span></dt><dt><span class="section"><a href="#properties-sample-auth-module">22.2. Sample Auth Properties</a></span></dt><dt><span class="section"><a href="#callbacks-file-sample-auth-module">22.3. Sample Auth Callbacks</a></span></dt><dt><span class="section"><a href="#authentication-logic-sample-auth-module">22.4. The Sample Authentication Logic</a></span></dt><dt><span class="section"><a href="#principal-sample-auth-module">22.5. The Sample Auth Principal</a></span></dt><dt><span class="section"><a href="#service-conf-sample-auth-module">22.6. The Sample Auth Service Configuration</a></span></dt><dt><span class="section"><a href="#build-config-sample-auth-module">22.7. Building &amp; Installing the Sample Auth Module</a></span></dt><dt><span class="section"><a href="#configuring-testing-sample-auth-module">22.8. Configuring &amp; Testing the Sample Auth Module</a></span></dt></dl></div><a class="indexterm" name="d13846e12865"></a><p>This chapter shows how to customize authentication with a sample custom
 authentication module. For deployments with particular requirements not met by
 existing OpenAM authentication modules, determine whether you can adapt one of
 the built-in or extension modules for your needs. If not, build the
 functionality into a custom authentication module.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-custom-auth-module"></a>22.1.&nbsp;About the Sample Authentication Module</h2></div></div></div><p>The sample authentication module prompts for a user name and password
  to authenticate the user, and handles error conditions. The sample shows how
  you integrate an authentication module into OpenAM such that you can
  configure the module through OpenAM console, and also localize the user
  interface.</p><div class="variablelist"><p>The <a class="link" href="https://github.com/markcraig/openam-auth-sample" target="_blank">sample authentication module source</a> is available
   online. Get a local clone so that you can try the sample on your system.
   In the sources you find the following files.</p><dl class="variablelist"><dt><span class="term"><code class="filename">pom.xml</code></span></dt><dd><p>Apache Maven project file for the module</p><p>This file specifies how to build the sample authentication module,
     and also specifies its dependencies on OpenAM components and on the
     Java Servlet API.</p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleAuth.java</code></span></dt><dd><p>Core class for the sample authentication module</p><p>This class is called by OpenAM to initialize the module and to
     process authentication. See
     <a class="xref" href="#authentication-logic-sample-auth-module" title="22.4.&nbsp;The Sample Authentication Logic">Section&nbsp;22.4, &#8220;The Sample Authentication Logic&#8221;</a> for details.</p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleAuthPrincipal.java</code></span></dt><dd><p>Class implementing <code class="literal">java.security.Principal</code>
     interface that defines how to map credentials to identities</p><p>This class is used to process authentication. See
     <a class="xref" href="#principal-sample-auth-module" title="22.5.&nbsp;The Sample Auth Principal">Section&nbsp;22.5, &#8220;The Sample Auth Principal&#8221;</a> for details.</p></dd><dt><span class="term"><code class="filename">src/main/resources/amAuthSampleAuth.properties</code></span></dt><dd><p>Properties file mapping UI strings to property values</p><p>This file makes it easier to localize the UI. See
     <a class="xref" href="#properties-sample-auth-module" title="22.2.&nbsp;Sample Auth Properties">Section&nbsp;22.2, &#8220;Sample Auth Properties&#8221;</a> for details.</p></dd><dt><span class="term"><code class="filename">src/main/resources/amAuthSampleAuth.xml</code></span></dt><dd><p>Configuration file for the sample authentication service</p><p>This file is used when registering the authentication module with
     OpenAM. See <a class="xref" href="#service-conf-sample-auth-module" title="22.6.&nbsp;The Sample Auth Service Configuration">Section&nbsp;22.6, &#8220;The Sample Auth Service Configuration&#8221;</a> for details.</p></dd><dt><span class="term"><code class="filename">src/main/resources/config/auth/default/SampleAuth.xml</code></span></dt><dd><p>Callback file for OpenAM classic UI authentication pages</p><p>The sample authentication module does not include localized versions
     of this file. See <a class="xref" href="#callbacks-file-sample-auth-module" title="22.3.&nbsp;Sample Auth Callbacks">Section&nbsp;22.3, &#8220;Sample Auth Callbacks&#8221;</a> for
     details.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="properties-sample-auth-module"></a>22.2.&nbsp;Sample Auth Properties</h2></div></div></div><p>OpenAM uses a Java properties file per locale to retrieve the
   appropriate, localized strings for the authentication module.</p><p>The following is the Sample Authentication Module properties file,
   <code class="filename">amAuthSampleAuth.properties</code>.</p><pre class="brush: java;">sampleauth-service-description=Sample Authentication Module
a500=Authentication Level
a501=Service Specific Attribute

sampleauth-ui-login-header=Login
sampleauth-ui-username-prompt=User Name:
sampleauth-ui-password-prompt=Password:

sampleauth-error-1=Error 1 occurred during the authentication
sampleauth-error-2=Error 2 occurred during the authentication</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="callbacks-file-sample-auth-module"></a>22.3.&nbsp;Sample Auth Callbacks</h2></div></div></div><p>OpenAM callbacks XML files are used to build the classic UI to prompt
  the user for identity information needed to process the authentication.
  The document type for a callback XML file is described in
  <code class="filename">WEB-INF/Auth_Module_Properties.dtd</code> where OpenAM is
  deployed.</p><div class="example"><a name="full-callbacks-file"></a><div class="example-title">Example&nbsp;22.1.&nbsp;Sample Auth Callbacks File</div><div class="example-contents"><p>The following is the <code class="filename">SampleAuth.xml</code> callbacks
   file.</p><pre class="brush: xml;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE ModuleProperties PUBLIC
 "=//iPlanet//Authentication Module Properties XML Interface 1.0 DTD//EN"
        "jar://com/sun/identity/authentication/Auth_Module_Properties.dtd"&gt;

&lt;ModuleProperties moduleName="SampleAuth" version="1.0" &gt;
    &lt;Callbacks length="0" order="1" timeout="600" header="#NOT SHOWN#" /&gt;
    &lt;Callbacks length="2" order="2" timeout="600" header="#TO BE SUBSTITUTED#"&gt;
        &lt;NameCallback isRequired="true"&gt;
            &lt;Prompt&gt;#USERNAME#&lt;/Prompt&gt;
        &lt;/NameCallback&gt;
        &lt;PasswordCallback echoPassword="false" &gt;
            &lt;Prompt&gt;#PASSWORD#&lt;/Prompt&gt;
        &lt;/PasswordCallback&gt;
    &lt;/Callbacks&gt;
    &lt;Callbacks length="1" order="3" timeout="600" header="#TO BE SUBSTITUTED#"
        error="true" &gt;
        &lt;NameCallback&gt;
            &lt;Prompt&gt;#THE DUMMY WILL NEVER BE SHOWN#&lt;/Prompt&gt;
        &lt;/NameCallback&gt;
    &lt;/Callbacks&gt;
&lt;/ModuleProperties&gt;</pre><div class="orderedlist"><p>This file specifies three states.</p><ol class="orderedlist" type="1"><li class="listitem"><p>The initial state (order="1") is used dynamically to replace the
     dummy strings shown between hashes (for example,
     <code class="literal">#USERNAME#</code>) by the
     <code class="literal">substituteUIStrings()</code> method in
     <code class="filename">SampleAuth.java</code>.</p></li><li class="listitem"><p>The next state (order="2") handles prompting the user for
     authentication information.</p></li><li class="listitem"><p>The last state (order="3") has the attribute
     <code class="literal">error="true"</code>. If the authentication module state
     machine reaches this order then the authentication has failed. The
     <code class="literal">NameCallback</code> is not used and not displayed to user.
     OpenAM requires that the callbacks array have at least one element.
     Otherwise OpenAM does not permit header substitution.</p></li></ol></div></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authentication-logic-sample-auth-module"></a>22.4.&nbsp;The Sample Authentication Logic</h2></div></div></div><p>An OpenAM authentication module must extend the
  <code class="literal">com.sun.identity.authentication.spi.AMLoginModule</code> abstract
  class, and must implement the methods shown below.</p><p>See the <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Java SDK API Specification</em></a> for
  reference.</p><pre class="brush: java;">
// OpenAM calls the init() method once when the module is created.
public void init(Subject subject, Map sharedState, Map options)

// OpenAM calls the process() method when the user submits authentication
// information. The process() method determines what happens next:
// success, failure, or the next state specified by the order
// attribute in the callbacks XML file.
public int process(Callback[] callbacks, int state) throws LoginException

// OpenAM expects the getPrincipal() method to return an implementation of
// the java.security.Principal interface.
public Principal getPrincipal()</pre><p>OpenAM does not reuse authentication module instances. This means that
  you can store information specific to the authentication process in the
  instance.</p><p>The implementation, <code class="filename">SampleAuth.java</code>, is shown
  below.</p><div class="informalexample"><pre class="brush: java;">/**
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
 *
 * Copyright (c) 2011-2013 ForgeRock AS. All Rights Reserved
 *
 * The contents of this file are subject to the terms
 * of the Common Development and Distribution License
 * (the License). You may not use this file except in
 * compliance with the License.
 *
 * You can obtain a copy of the License at
 * http://forgerock.org/license/CDDLv1.0.html
 * See the License for the specific language governing
 * permission and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL
 * Header Notice in each file and include the License file
 * at http://forgerock.org/license/CDDLv1.0.html
 * If applicable, add the following below the CDDL Header,
 * with the fields enclosed by brackets [] replaced by
 * your own identifying information:
 * "Portions Copyrighted [year] [name of copyright owner]"
 *
 */

package org.forgerock.openam.examples;

import java.security.Principal;
import java.util.Map;
import java.util.ResourceBundle;

import javax.security.auth.Subject;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.NameCallback;
import javax.security.auth.callback.PasswordCallback;
import javax.security.auth.login.LoginException;

import com.sun.identity.authentication.spi.AMLoginModule;
import com.sun.identity.authentication.spi.AuthLoginException;
import com.sun.identity.authentication.spi.InvalidPasswordException;
import com.sun.identity.authentication.util.ISAuthConstants;
import com.sun.identity.shared.datastruct.CollectionHelper;
import com.sun.identity.shared.debug.Debug;



public class SampleAuth extends AMLoginModule
{

    // Name for the debug-log
    private final static String DEBUG_NAME = "SampleAuth";

    // Name of the resource bundle
    private final static String amAuthSampleAuth = "amAuthSampleAuth";

    // User names for authentication logic
    private final static String USERNAME = "demo";
    private final static String ERROR_1_NAME = "test1";
    private final static String ERROR_2_NAME = "test2";

    // Orders defined in the callbacks file
    private final static int STATE_BEGIN = 1;
    private final static int STATE_AUTH = 2;
    private final static int STATE_ERROR = 3;

    private final static Debug debug = Debug.getInstance(DEBUG_NAME);

    private Map options;
    private ResourceBundle bundle;



    public SampleAuth()
    {
        super();
    }



    @Override
    // This method stores service attributes and localized properties
    // for later use.
    public void init(Subject subject, Map sharedState, Map options)
    {
        if (debug.messageEnabled())
        {
            debug.message("SampleAuth::init");
        }
        this.options = options;
        bundle = amCache.getResBundle(amAuthSampleAuth, getLoginLocale());
    }



    @Override
    public int process(Callback[] callbacks, int state) throws LoginException
    {

        if (debug.messageEnabled())
        {
            debug.message("SampleAuth::process state: " + state);
        }

        switch (state)
        {

            case STATE_BEGIN:
                // No time wasted here - simply modify the UI and
                // proceed to next state
                substituteUIStrings();
                return STATE_AUTH;

            case STATE_AUTH:
                // Get data from callbacks. Refer to callbacks XML file.
                NameCallback nc = (NameCallback) callbacks[0];
                PasswordCallback pc = (PasswordCallback) callbacks[1];
                String username = nc.getName();
                String password = new String(pc.getPassword());

                // First errorstring is stored in "sampleauth-error-1" property.
                if (username.equals(ERROR_1_NAME))
                {
                    setErrorText("sampleauth-error-1");
                    return STATE_ERROR;
                }

                // Second errorstring is stored in "sampleauth-error-2" property.
                if (username.equals(ERROR_2_NAME))
                {
                    setErrorText("sampleauth-error-2");
                    return STATE_ERROR;
                }

                if (username.equals(USERNAME) &amp;&amp; password.equals("changeit"))
                {
                    return ISAuthConstants.LOGIN_SUCCEED;
                }

                throw new InvalidPasswordException("password is wrong", USERNAME);

            case STATE_ERROR:
                return STATE_ERROR;
            default:
                throw new AuthLoginException("invalid state");

        }
    }



    @Override
    public Principal getPrincipal()
    {
        return new SampleAuthPrincipal(USERNAME);
    }



    private void setErrorText(String err) throws AuthLoginException
    {
        // Receive correct string from properties and substitute the
        // header in callbacks order 3.
        substituteHeader(STATE_ERROR, bundle.getString(err));
    }



    private void substituteUIStrings() throws AuthLoginException
    {
        // Get service specific attribute configured in OpenAM
        String ssa = CollectionHelper.getMapAttr(options,
                "sampleauth-service-specific-attribute");

        // Get property from bundle
        String new_hdr = ssa + " "
                + bundle.getString("sampleauth-ui-login-header");
        substituteHeader(STATE_AUTH, new_hdr);

        Callback[] cbs_phone = getCallback(STATE_AUTH);

        replaceCallback(STATE_AUTH, 0, new NameCallback(bundle
                .getString("sampleauth-ui-username-prompt")));

        replaceCallback(STATE_AUTH, 1, new PasswordCallback(bundle
                .getString("sampleauth-ui-password-prompt"), false));
    }

}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="principal-sample-auth-module"></a>22.5.&nbsp;The Sample Auth Principal</h2></div></div></div><p>The implementation, <code class="filename">SampleAuthPrincipal.java</code>, is
  shown below.</p><div class="informalexample"><pre class="brush: java;">/**
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
 *
 * Copyright (c) 2011-2013 ForgeRock AS. All Rights Reserved
 *
 * The contents of this file are subject to the terms
 * of the Common Development and Distribution License
 * (the License). You may not use this file except in
 * compliance with the License.
 *
 * You can obtain a copy of the License at
 * http://forgerock.org/license/CDDLv1.0.html
 * See the License for the specific language governing
 * permission and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL
 * Header Notice in each file and include the License file
 * at http://forgerock.org/license/CDDLv1.0.html
 * If applicable, add the following below the CDDL Header,
 * with the fields enclosed by brackets [] replaced by
 * your own identifying information:
 * "Portions Copyrighted [year] [name of copyright owner]"
 *
 */

package org.forgerock.openam.examples;



import java.io.Serializable;
import java.security.Principal;



public class SampleAuthPrincipal implements Principal, Serializable
{
    private final String name;
    private final static String CLASSNAME = "SampleAuthPrincipal";
    private final static String COLON = " : ";



    public SampleAuthPrincipal(String name)
    {
        if (name == null)
        {
            throw new NullPointerException("illegal null input");
        }

        this.name = name;
    }



    /**
     * Return the LDAP username for this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     *
     * @return the LDAP username for this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;
     */
    @Override
    public String getName()
    {
        return name;
    }



    /**
     * Return a string representation of this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     *
     * @return a string representation of this
     *         &lt;code&gt;TestAuthModulePrincipal&lt;/code&gt;.
     */
    @Override
    public String toString()
    {
        return new StringBuilder().append(CLASSNAME).append(COLON)
                .append(name).toString();
    }



    /**
     * Compares the specified Object with this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;
     * for equality. Returns true if the given object is also a
     * &lt;code&gt; SampleAuthPrincipal &lt;/code&gt; and the two SampleAuthPrincipal have
     * the same username.
     *
     * @param o Object to be compared for equality with this
     *          &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     * @return true if the specified Object is equal equal to this
     *         &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     */
    @Override
    public boolean equals(Object o)
    {
        if (o == null)
        {
            return false;
        }

        if (this == o)
        {
            return true;
        }

        if (!(o instanceof SampleAuthPrincipal))
        {
            return false;
        }
        SampleAuthPrincipal that = (SampleAuthPrincipal) o;

        if (this.getName().equals(that.getName()))
        {
            return true;
        }
        return false;
    }



    /**
     * Return a hash code for this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     *
     * @return a hash code for this &lt;code&gt; SampleAuthPrincipal &lt;/code&gt;.
     */
    @Override
    public int hashCode()
    {
        return name.hashCode();
    }
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-conf-sample-auth-module"></a>22.6.&nbsp;The Sample Auth Service Configuration</h2></div></div></div><p>OpenAM requires that all authentication modules be configured by means
  of an OpenAM service. At minimum, the service must include an authentication
  level attribute. Your module can access these configuration attributes in
  the <code class="literal">options</code> parameter passed to the
  <code class="literal">init()</code> method.</p><div class="itemizedlist"><p>Some observations about the service configuration file follow in the
   list below.</p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The document type for a service configuration file is described in
    <code class="filename">WEB-INF/sms.dtd</code> where OpenAM is deployed.</p></li><li class="listitem"><p>The service name is taken from the module name:
    <code class="literal">iPlanetAMAuth<em class="replaceable"><code>module-name</code></em>Service</code>.
    In this case, the service name is
    <code class="literal">iPlanetAMAuthSampleAuthService</code>.</p></li><li class="listitem"><p>The service must have a localized description, retrieved from a
    properties file.</p></li><li class="listitem"><p>The <code class="literal">i18nFileName</code> attribute in the service
    configuration holds the default (non-localized) base name of the Java
    properties file. The <code class="literal">i18nKey</code> attributes indicate
    properties keys to string values in the Java properties file.</p></li><li class="listitem"><p>The authentication level attribute name is taken from the module name:
    <code class="literal">iplanet-am-auth-<em class="replaceable"><code>module-name</code></em>-auth-level</code>,
    where the <em class="replaceable"><code>module-name</code></em> is all lower case. Here,
    the authentication level attribute is named
    <code class="literal">iplanet-am-auth-sampleauth-auth-level</code>.</p></li><li class="listitem"><p>The Sample Auth service configuration includes an example
    <code class="literal">sampleauth-service-specific-attribute</code>, which can be
    configured through OpenAM console.</p></li></ul></div><p>The service configuration file,
  <code class="filename">amAuthSampleAuth.xml</code>, is shown below.
   Save a local copy of this file, which you use when registering the module.
  </p><pre class="brush: xml;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
   DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.

   Copyright (c) 2011 ForgeRock AS. All Rights Reserved

   The contents of this file are subject to the terms
   of the Common Development and Distribution License
   (the License). You may not use this file except in
   compliance with the License.

   You can obtain a copy of the License at
   http://forgerock.org/license/CDDLv1.0.html
   See the License for the specific language governing
   permission and limitations under the License.

   When distributing Covered Code, include this CDDL
   Header Notice in each file and include the License file
   at http://forgerock.org/license/CDDLv1.0.html
   If applicable, add the following below the CDDL Header,
   with the fields enclosed by brackets [] replaced by
   your own identifying information:
   "Portions Copyrighted [year] [name of copyright owner]"
--&gt;
&lt;!DOCTYPE ServicesConfiguration
    PUBLIC "=//iPlanet//Service Management Services (SMS) 1.0 DTD//EN"
    "jar://com/sun/identity/sm/sms.dtd"&gt;

&lt;ServicesConfiguration&gt;
 &lt;Service name="iPlanetAMAuthSampleAuthService" version="1.0"&gt;
  &lt;Schema
   serviceHierarchy="/DSAMEConfig/authentication/iPlanetAMAuthSampleAuthService"
   i18nFileName="amAuthSampleAuth" revisionNumber="10"
   i18nKey="sampleauth-service-description"&gt;
   &lt;Organization&gt;
    &lt;AttributeSchema name="iplanet-am-auth-sampleauth-auth-level"
     type="single" syntax="number_range" rangeStart="0" rangeEnd="2147483647"
     i18nKey="a500"&gt;
     &lt;DefaultValues&gt;
      &lt;Value&gt;1&lt;/Value&gt;
     &lt;/DefaultValues&gt;
    &lt;/AttributeSchema&gt;

    &lt;AttributeSchema name="sampleauth-service-specific-attribute"
     type="single" syntax="string" validator="no" i18nKey="a501"&gt;
     &lt;DefaultValues&gt;
      &lt;Value&gt;&lt;/Value&gt;
     &lt;/DefaultValues&gt;
    &lt;/AttributeSchema&gt;

    &lt;SubSchema name="serverconfig" inheritance="multiple"&gt;
     &lt;AttributeSchema name="iplanet-am-auth-sampleauth-auth-level"
      type="single" syntax="number_range" rangeStart="0" rangeEnd="2147483647"
      i18nKey="a500"&gt;
      &lt;DefaultValues&gt;
       &lt;Value&gt;1&lt;/Value&gt;
      &lt;/DefaultValues&gt;
     &lt;/AttributeSchema&gt;

     &lt;AttributeSchema name="sampleauth-service-specific-attribute"
      type="single" syntax="string" validator="no" i18nKey="a501"&gt;
      &lt;DefaultValues&gt;
       &lt;Value&gt;&lt;/Value&gt;
      &lt;/DefaultValues&gt;
     &lt;/AttributeSchema&gt;

    &lt;/SubSchema&gt;
   &lt;/Organization&gt;
  &lt;/Schema&gt;
 &lt;/Service&gt;
&lt;/ServicesConfiguration&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="build-config-sample-auth-module"></a>22.7.&nbsp;Building &amp; Installing the Sample Auth Module</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#building-sample-auth-module">22.7.1. Building the Module</a></span></dt><dt><span class="section"><a href="#installing-sample-auth-module">22.7.2. Installing the Module</a></span></dt></dl></div><p>Build the module with Apache Maven, and install the module in
  OpenAM.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="building-sample-auth-module"></a>22.7.1.&nbsp;Building the Module</h3></div></div></div><p>Build the module using Apache Maven.</p><div class="screen"><pre>
$ <strong>cd /path/to/openam-auth-sample</strong>
$ <strong>mvn install</strong>
<em>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building openam-auth-sample 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
...

[INFO]
[INFO] --- maven-jar-plugin:2.3.1:jar (default-jar) @ openam-auth-sample ---
[INFO] Building jar: ...target/openam-auth-sample-1.0.0-SNAPSHOT.jar
...
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 3.651s
[INFO] Finished at: Thu Oct 03 11:19:07 CEST 2013
[INFO] Final Memory: 20M/226M
[INFO] ------------------------------------------------------------------------</em>
   </pre></div><p>After you successfully build the module, you find the .jar in
   the <code class="filename">target/</code> directory of the project.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="installing-sample-auth-module"></a>22.7.2.&nbsp;Installing the Module</h3></div></div></div><p>Installing the sample authentication module consists of copying the
   .jar to OpenAM's <code class="filename">WEB-INF/lib/</code> directory, registering
   the module with OpenAM, and then restarting OpenAM or the web application
   container where it runs.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Copy the sample authentication module .jar file to
     <code class="filename">WEB-INF/lib/</code> where OpenAM is deployed.</p><div class="screen"><pre>
$ <strong>cp target/openam-auth-sample*.jar /path/to/tomcat/webapps/openam/WEB-INF/lib/</strong>
     </pre></div></li><li class="listitem"><p>Register the module with OpenAM using the <span class="command"><strong>ssoadm</strong></span>
     command.</p><div class="screen"><pre>
$ <strong>ssoadm \
 create-svc \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --xmlfile /path/to/amAuthSampleAuth.xml</strong>

<em>Service was added.</em>
$ <strong>ssoadm \
 register-auth-module \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --authmodule org.forgerock.openam.examples.SampleAuth</strong>

<em>Authentication module was registered.</em>
     </pre></div><p>See the <a href="../reference/index.html#ssoadm-1" class="link"><span class="command"><strong>ssoadm</strong></span>
     reference</a> a full list of Authentication Service Management
     subcommands.</p></li><li class="listitem"><p>Restart OpenAM or the container in which it runs.</p><p>For example if you deployed OpenAM in Apache Tomcat, then you shut
     down Tomcat and start it again.</p><div class="screen"><pre>
$ <strong>/path/to/tomcat/bin/shutdown.sh</strong>
$ <strong>/path/to/tomcat/bin/startup.sh</strong>
$ <strong>tail -1 /path/to/tomcat/logs/catalina.out</strong>
<em>INFO: Server startup in 14736 ms</em>
     </pre></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuring-testing-sample-auth-module"></a>22.8.&nbsp;Configuring &amp; Testing the Sample Auth Module</h2></div></div></div><p>Authentication modules are registered as services with OpenAM globally,
  and then set up for use in a particular realm. In this example, you set up
  the sample authentication module for use in the realm / (Top Level Realm).</p><p>Login to OpenAM Console as OpenAM administrator,
  <code class="literal">amadmin</code>, and browse to Access Control
  &gt; / (Top Level Realm) &gt; Authentication &gt; Module Instances.
  Then click New, and create an instance of the Sample Authentication Module.
  Name the module <code class="literal">Sample</code>.</p><div class="mediaobject" align="center"><a name="figure-register-sample-auth"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/register-sample-auth.png" align="middle" height="360" alt="Sample authentication module registration"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-register-sample-auth.html" target="longdesc">D</a>]</span></div></div><p>After creating the module, click the name in the Module Instances
  list, and configure as appropriate.</p><div class="mediaobject" align="center"><a name="figure-sampleauth-conf"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/sampleauth-conf.png" align="middle" height="360" alt="Sample authentication module configuration"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-sampleauth-conf.html" target="longdesc">D</a>]</span></div></div><p>Now that the module is configured, logout of OpenAM console.</p><p>Finally, try the module by specifying the <code class="literal">Sample</code>
  module using a query string parameter. Browse to the login URL such as
  <code class="literal">http://openam.example.com:8080/openam/UI/Login?module=Sample</code>,
  and then authenticate with user name <code class="literal">demo</code> and password
  <code class="literal">changeit</code>.</p><div class="mediaobject" align="center"><a name="figure-openam-auth-sample-login"></a><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="images/openam-auth-sample-login.png" align="middle" height="360" alt="Sample authentication module login page"></td></tr></table><div class="longdesc-link" align="right"><br clear="all"><span class="longdesc-link">[<a href="figure-openam-auth-sample-login.html" target="longdesc">D</a>]</span></div></div><p>After authentication you are redirected to the end user page for
  the demo user. You can logout of OpenAM console, and then try the
  authentication as users <code class="literal">test1</code> or <code class="literal">test2</code>
  to see what the error handling looks like to the user.</p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-custom-quota-exhaustion-action"></a>Chapter&nbsp;23.&nbsp;Customizing Session Quota Exhaustion Actions</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#create-custom-quota-exhaustion-action">23.1. Creating &amp; Installing a Custom Session Quota Exhaustion Action</a></span></dt><dt><span class="section"><a href="#list-custom-quota-exhaustion-actions">23.2. Listing Session Quota Exhaustion Actions</a></span></dt><dt><span class="section"><a href="#remove-custom-quota-exhaustion-actions">23.3. Removing a Session Quota Exhaustion Action</a></span></dt></dl></div><p>
  This chapter demonstrates a custom session quota exhaustion action plugin.
  OpenAM calls a session quota exhaustion action plugin
  when a user tries to open more sessions than their quota allows.
 </p><p>
  You only need a custom session quota exhaustion action plugin
  if the built-in actions, described in the <em class="citetitle">Administration
  Guide</em> procedure, <a href="../admin-guide/index.html#session-quotas-and-exhaustion-actions" class="link"><em class="citetitle">To Configure
  Session Quotas &amp; Exhaustion Actions</em></a>, are not flexible
  enough for your deployment.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="create-custom-quota-exhaustion-action"></a>23.1.&nbsp;Creating &amp; Installing a Custom Session Quota Exhaustion Action</h2></div></div></div><p>
   You build custom session quota exhaustion actions into a .jar
   that you then plug in to OpenAM.
   You must also add your new action to the Session service configuration,
   and restart OpenAM in order to be able to configure it for your use.
  </p><p>
   Your custom session quota exhaustion action implements the
   <code class="literal">com.iplanet.dpro.session.service.QuotaExhaustionAction</code>
   interface, overriding the <code class="literal">action</code> method.
   The <code class="literal">action</code> method performs the action
   when the session quota is met, and returns <code class="literal">true</code>
   only if the request for a new session should <span class="emphasis"><em>not</em></span> be granted.
  </p><p>
   The example in this chapter simply removes the first session it finds
   as the session quota exhaustion action.
  </p><pre class="brush: java;">package org.forgerock.openam.examples.quotaexhaustionaction;

import com.iplanet.dpro.session.Session;
import com.iplanet.dpro.session.SessionException;
import com.iplanet.dpro.session.SessionID;
import com.iplanet.dpro.session.service.InternalSession;
import com.iplanet.dpro.session.service.QuotaExhaustionAction;
import com.iplanet.dpro.session.service.SessionService;
import com.sun.identity.shared.debug.Debug;
import java.util.Map;

/**
 * This is a sample {@link QuotaExhaustionAction} implementation,
 * which randomly kills the first session it finds.
 */
public class SampleQuotaExhaustionAction implements QuotaExhaustionAction {

    private static Debug debug = SessionService.sessionDebug;

    /**
     * Check if the session quota for a given user has been exhausted and
     * if so perform the necessary actions. This implementation randomly
     * destroys the first session it finds.
     *
     * @param is               The InternalSession to be activated.
     * @param existingSessions All existing sessions that belong to the same
     *                         uuid (Map:sid-&gt;expiration_time).
     * @return true If the session activation request should be rejected,
     *              otherwise false.
     */
    @Override
    public boolean action(
            InternalSession is,
            Map&lt;String, Long&gt; existingSessions) {
        for (Map.Entry&lt;String, Long&gt; entry : existingSessions.entrySet()) {
            try {
                // Get an actual Session instance based on the session ID.
                Session session =
                        Session.getSession(new SessionID(entry.getKey()));
                // Use the session to destroy itself.
                session.destroySession(session);
                // Only destroy the first session.
                break;
            } catch (SessionException se) {
                if (debug.messageEnabled()) {
                    debug.message("Failed to destroy existing session.", se);
                }
                // In this case, deny the session activation request.
                return true;
            }
        }
        return false;
    }
}
</pre><p>
   The <a class="link" href="https://github.com/markcraig/openam-examples-quotaexhaustionaction/" target="_blank">sample plugin source</a> is available online.
   Get a local clone so that you can try the sample on your system.
   In the sources you find the following files.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="filename">pom.xml</code></span></dt><dd><p>
      Apache Maven project file for the module
     </p><p>
      This file specifies how to build the sample plugin,
      and also specifies its dependencies on OpenAM components
      and on the Servlet API.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/quotaexhaustionaction/SampleQuotaExhaustionAction.java</code></span></dt><dd><p>
      Core class for the sample quota exhaustion action plugin
     </p></dd></dl></div><p>
   Build the module using Apache Maven.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/openam-examples-quotaexhaustionaction</strong>
$ <strong>mvn install</strong>
<em>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building OpenAM Example Quota Exhaustion Action 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

...

[INFO]
[INFO] --- maven-jar-plugin:2.3.1:jar (default-jar) @ quotaexhaustionaction ---
[INFO] Building jar: .../target/quotaexhaustionaction-1.0.0-SNAPSHOT.jar

...

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 10.138s
[INFO] Finished at: Mon Nov 25 15:59:10 CET 2013
[INFO] Final Memory: 18M/129M
[INFO] ------------------------------------------------------------------------</em>
  </pre></div><p>
   Copy the .jar to <code class="filename">WEB-INF/lib/</code> where OpenAM is deployed.
  </p><div class="screen"><pre>
$ <strong>cp target/*.jar /path/to/tomcat/webapps/openam/WEB-INF/lib/</strong>
  </pre></div><p>
   Using the <span class="command"><strong>ssoadm</strong></span> command
   or the <code class="literal">ssoadm.jsp</code> page in OpenAM Console,
   update the Session service configuration.
  </p><div class="screen"><pre>
$ <strong>ssoadm \
 set-attr-choicevals \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --servicename iPlanetAMSessionService \
 --schematype Global \
 --attributename iplanet-am-session-constraint-handler \
 --add \
 --choicevalues myKey=\
org.forgerock.openam.examples.quotaexhaustionaction.SampleQuotaExhaustionAction</strong>

<em>Choice Values were set.</em>
  </pre></div><p>
   Extract <code class="filename">amSession.properties</code>
   and if necessary the localized versions of this file
   from <code class="filename">openam-core-12.0.0.jar</code>
   to <code class="filename">WEB-INF/classes/</code> where OpenAM is deployed.
   For example, if OpenAM is deployed under
   <code class="filename">/path/to/tomcat/webapps/openam</code>,
   then you could run the following commands.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/tomcat/webapps/openam/WEB-INF/classes/</strong>
$ <strong>jar -xvf ../lib/openam-core-12.0.0.jar amSession.properties</strong>
 <em>inflated: amSession.properties</em>
  </pre></div><p>
   Add the following line to <code class="filename">amSession.properties</code>.
  </p><pre class="brush: ini;">myKey=Randomly Destroy Session</pre><p>
   Restart OpenAM or the container in which it runs.
  </p><p>
   You can now use the new session quota exhaustion action in OpenAM Console
   under Configuration &gt; Global &gt; Session &gt;
   Resulting behavior if session quota exhausted.
  </p><p>
   Before moving to your test and production environments,
   be sure to add your .jar and updates to <code class="filename">amSession.properties</code>
   into a custom .war that you can then deploy.
   You must still update the Session service configuration
   in order to use your custom session quota exhaustion action.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="list-custom-quota-exhaustion-actions"></a>23.2.&nbsp;Listing Session Quota Exhaustion Actions</h2></div></div></div><p>
   List session quota exhaustion actions
   by using the <span class="command"><strong>ssoadm</strong></span> command
   or by using the <code class="literal">ssoadm.jsp</code> page.
  </p><div class="screen"><pre>
$ <strong>ssoadm \
 get-attr-choicevals \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --servicename iPlanetAMSessionService \
 --schematype Global \
 --attributename iplanet-am-session-constraint-handler</strong>
<em>
I18n Key                  Choice Value
------------------------- ---...-----------------------------------------
choiceDestroyOldSession   org...session.service.DestroyOldestAction
choiceDenyAccess          org...session.service.DenyAccessAction
choiceDestroyNextExpiring org...session.service.DestroyNextExpiringAction
choiceDestroyAll          org...session.service.DestroyAllAction
myKey                     org...examples...SampleQuotaExhaustionAction</em>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remove-custom-quota-exhaustion-actions"></a>23.3.&nbsp;Removing a Session Quota Exhaustion Action</h2></div></div></div><p>
   Remove a session quota exhaustion action
   by using the <span class="command"><strong>ssoadm</strong></span> command
   or by using the <code class="literal">ssoadm.jsp</code> page.
  </p><div class="screen"><pre>
$ <strong>ssoadm \
 remove-attr-choicevals \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --servicename iPlanetAMSessionService \
 --schematype Global \
 --attributename iplanet-am-session-constraint-handler \
 --choicevalues \
 org.forgerock.openam.examples.quotaexhaustionaction.SampleQuotaExhaustionAction</strong>

<em>Choice Values were removed.</em>
  </pre></div></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-post-auth"></a>Chapter&nbsp;24.&nbsp;Creating a Post Authentication Plugin</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#design-post-authentication-plugin">24.1. Designing Your Post Authentication Plugin</a></span></dt><dt><span class="section"><a href="#build-post-authentication-plugin">24.2. Building Your Sample Post Authentication Plugin</a></span></dt><dt><span class="section"><a href="#configure-post-authentication-plugin">24.3. Configuring Your Post Authentication Plugin</a></span></dt><dt><span class="section"><a href="#test-post-authentication-plugin">24.4. Testing Your Post Authentication Plugin</a></span></dt></dl></div><a class="indexterm" name="d13846e13463"></a><p>Post authentication plugins (PAP) let you include custom processing at
 the end of the authentication process, immediately before the subject is
 authenticated. Common uses of post authentication plugins include setting
 cookies and session variables. Post authentication plugins are often used in
 conjunction with policy agents. The post authentication plugin sets custom
 session properties, and then the policy agent injects the custom properties
 into the request header to the protected application.</p><p>This chapter explains how to create a post authentication plugin.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="design-post-authentication-plugin"></a>24.1.&nbsp;Designing Your Post Authentication Plugin</h2></div></div></div><p>Your post authentication plugin class implements the
  <code class="literal">AMPostAuthProcessInterface</code> interface, and in particular
  the following three methods.</p><pre class="brush: java;">public void onLoginSuccess(
  Map requestParamsMap, 
  HttpServletRequest request,
  HttpServletResponse response,
  SSOToken token
) throws AuthenticationException

public void onLoginFailure(
  Map requestParamsMap, 
  HttpServletRequest request,
  HttpServletResponse response
) throws AuthenticationException

public void onLogout(
  HttpServletRequest request, 
  HttpServletResponse response,
  SSOToken token
) throws AuthenticationException</pre><p>OpenAM calls the <code class="literal">onLoginSuccess()</code> and
  <code class="literal">onLoginFailure()</code> methods immediately before informing the
  user of login success or failure, respectively. OpenAM calls the
  <code class="literal">onLogout()</code> method only when the user actively logs out,
  not when a user's session times out.</p><p>See the <a class="link" href="http://docs.forgerock.org/en/openam/12.0.0/apidocs/" target="_blank"><em class="citetitle">OpenAM Java SDK API Specification</em></a> for
  reference.</p><p>These methods can perform whatever processing you require. Yet, know
  that OpenAM calls your methods synchronously as part of the authentication
  process. Therefore, if your methods take a long time to complete, you will
  keep users waiting. Minimize the processing done in your post authentication
  methods.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="build-post-authentication-plugin"></a>24.2.&nbsp;Building Your Sample Post Authentication Plugin</h2></div></div></div><p>The following example post authentication plugin sets a session
  property during successful login, writing to its debug log if the operation
  fails.</p><pre class="brush: java;">package com.forgerock.openam.examples;

import java.util.Map;

import com.iplanet.sso.SSOException;
import com.iplanet.sso.SSOToken;

import com.sun.identity.authentication.spi.AMPostAuthProcessInterface;
import com.sun.identity.authentication.spi.AuthenticationException;
import com.sun.identity.shared.debug.Debug;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class SamplePAP implements AMPostAuthProcessInterface {
    private final static String PROP_NAME = "MyProperty";
    private final static String PROP_VALUE = "MyValue";
    private final static String DEBUG_FILE = "SamplePAP";

    protected Debug debug = Debug.getInstance(DEBUG_FILE);

    public void onLoginSuccess(
            Map requestParamsMap,
            HttpServletRequest request,
            HttpServletResponse response,
            SSOToken token
    ) throws AuthenticationException {
        try {
            token.setProperty(PROP_NAME, PROP_VALUE);
        } catch (SSOException e) {
            debug.error("Unable to set property");
        }
    }

    public void onLoginFailure(
            Map requestParamsMap,
            HttpServletRequest request,
            HttpServletResponse response
    ) throws AuthenticationException {
        // Not used
    }

    public void onLogout(
            HttpServletRequest request,
            HttpServletResponse response,
            SSOToken token
    ) throws AuthenticationException {
        // Not used
    }
}
</pre><p>
   The <a class="link" href="https://github.com/markcraig/openam-post-auth-sample" target="_blank">sample post authentication plugin source</a>
   is available online.
   Get a local clone so that you can try the sample on your system.
   In the sources you find the following files.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="filename">pom.xml</code></span></dt><dd><p>
      Apache Maven project file for the module
     </p><p>
      This file specifies how to build the sample post authentication plugin,
      and also specifies its dependencies on OpenAM components
      and on the Servlet API.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/com/forgerock/openam/examples/SamplePAP.java</code></span></dt><dd><p>
      Core class for the sample post authentication plugin
     </p></dd></dl></div><p>
   Build the module using Apache Maven.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/openam-post-auth-sample</strong>
$ <strong>mvn install</strong>
<em>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building openam-post-auth-sample 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

...

[INFO]
[INFO] --- maven-jar-plugin:2.3.1:jar (default-jar) @ openam-post-auth-sample --
[INFO] Building jar: .../target/openam-post-auth-sample-1.0.0-SNAPSHOT.jar

...

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 6.727s
[INFO] Finished at: Mon Nov 25 17:07:23 CET 2013
[INFO] Final Memory: 20M/227M
[INFO] ------------------------------------------------------------------------</em>
  </pre></div><p>
   Copy the .jar to the <code class="filename">WEB-INF/lib</code> directory
   where you deployed OpenAM.
  </p><div class="screen"><pre>
$ <strong>cp target/*.jar /path/to/tomcat/webapps/openam/WEB-INF/lib/</strong>
  </pre></div><p>
   Restart OpenAM or the container in which it runs.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configure-post-authentication-plugin"></a>24.3.&nbsp;Configuring Your Post Authentication Plugin</h2></div></div></div><p>
   You can configure the post authentication plugin for a realm,
   for a service (authentication chain), or for a role.
   Where you configure the plugin depends on the scope
   to which the plugin should apply.
   Configuring the plugin at the realm level as shown here, for example,
   ensures that OpenAM calls your plugin for all authentications to the realm.
  </p><p>
   In OpenAM Console, browse to Access Control &gt; <em class="replaceable"><code>Realm
   Name</code></em> &gt; Authentication &gt; All Core Settings.
   In the Authentication Post Processing Classes list,
   add the sample plugin class,
   <code class="literal">com.forgerock.openam.examples.SamplePAP</code>,
   and then click Save.
  </p><p>
   Alternatively, you can configure sample plugin for the realm
   by using the <span class="command"><strong>ssoadm</strong></span> command.
  </p><div class="screen"><pre>
$ <strong>ssoadm
 set-svc-attrs
 --adminid amadmin
 --password-file /tmp/pwd.txt
 --servicename iPlanetAMAuthService
 --realm /myRealm
 --attributevalues iplanet-am-auth-post-login-process-class=
 com.forgerock.openam.examples.SamplePAP</strong>

<em>iPlanetAMAuthService under /myRealm was
 modified.</em>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-post-authentication-plugin"></a>24.4.&nbsp;Testing Your Post Authentication Plugin</h2></div></div></div><p>
   To test the sample post authentication plugin,
   login successfully to OpenAM in the scope where the plugin is configured.
   For example, if you configured your plugin for the realm,
   <code class="literal">/myRealm</code>, specify the realm in the login URL.
  </p><pre class="literallayout">http://openam.example.com:8080/openam/UI/Login?realm=myRealm</pre><p>
   Although as a user you do not notice anywhere in the user interface
   that OpenAM calls your plugin,
   a policy agent or custom client code could retrieve the session property
   that your plugin added to the user session.
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-policy-spi"></a>Chapter&nbsp;25.&nbsp;Customizing Policy Evaluation</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-sample-policy-plugins">25.1. About the Sample Plugin</a></span></dt><dt><span class="section"><a href="#configuring-sample-policy-plugin">25.2. Configuring a Sample Policy Plugin</a></span></dt><dt><span class="section"><a href="#add-custom-policy-impl-to-existing-apps">25.3. Adding Custom Policy Implementations to Existing Policy Applications</a></span></dt><dt><span class="section"><a href="#trying-sample-policy-plugin">25.4. Trying the Sample Subject and Environment Conditions</a></span></dt><dt><span class="section"><a href="#trying-custom-policy-resource-attributes">25.5. Trying the Sample Resource Attributes</a></span></dt><dt><span class="section"><a href="#extend-ssoadm-classpath">25.6. Extending the ssoadm Classpath</a></span></dt></dl></div><a class="indexterm" name="d13846e13598"></a><p>OpenAM policies let you restrict access to resources based both on
 identity and group membership, and also on a range of conditions including
 session age, authentication chain or module used, authentication level, realm,
 session properties, IP address and DNS name, user profile content, resource
 environment, date, day, time of day, and time zone. Yet, some deployments
 require further distinctions for policy evaluation. This chapter explains how
 to customize policy evaluation for deployments with particular requirements
 not met by built-in OpenAM functionality.</p><p>
  This chapter shows how to build and use a custom policy plugin
  that implements a subject condition, an environment condition,
  and resource attributes.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-sample-policy-plugins"></a>25.1.&nbsp;About the Sample Plugin</h2></div></div></div><p>
   The OpenAM policy framework lets you build plugins that extend
   subject conditions, environment conditions, and resource attributes.
   The <a class="link" href="https://github.com/markcraig/openam-policy-eval-sample" target="_blank">sample policy plugin source</a>
   is available online.
   Get a local clone so that you can read the source and try the sample on your system.
   In the sources you find the following files.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="filename">pom.xml</code></span></dt><dd><p>
      Apache Maven project file for the module
     </p><p>
      This file specifies how to build the sample policy evaluation plugin,
      and also specifies its dependencies on OpenAM components.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleAttributeType.java</code></span></dt><dd><p>
      Extends the <code class="literal">com.sun.identity.entitlement.ResourceAttribute</code> interface,
      and shows an implementation of a resource attribute provider
      to send an attribute with the response.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleConditionType.java</code></span></dt><dd><p>
      Extends the <code class="literal">com.sun.identity.entitlement.EntitlementCondition</code> interface,
      and shows an implementation of a condition that is the length of the user name.
     </p><p>
      A condition influences whether the policy applies for a given access request.
      If the condition is fulfilled,
      then OpenAM includes the policy in the set of policies to evaluate
      in order to respond to a policy decision request.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleSubjectType.java</code></span></dt><dd><p>
      Extends the <code class="literal">com.sun.identity.entitlement.EntitlementSubject</code> interface,
      and shows an implementation that defines a user to whom the policy applies.
     </p><p>
      A subject, like a condition, influences whether the policy applies.
      If the subject matches in the context of a given access request,
      then the policy applies.
     </p></dd><dt><span class="term"><code class="filename">src/main/java/org/forgerock/openam/examples/SampleEntitlementModule.java</code>, </span><span class="term"><code class="filename">src/main/resources/META-INF/services/org.forgerock.openam.entitlement.EntitlementModule</code></span></dt><dd><p>
      These files serve to register the plugin with OpenAM.
     </p><p>
      The Java class, <code class="literal">SampleEntitlementModule</code>, implements the
      <code class="literal">org.forgerock.openam.entitlement.EntitlementModule</code> interface.
      In the sample,
      this class registers "SampleAttribute", "SampleCondition", and "SampleSubject".
     </p><p>
      The services file,
      <code class="filename">org.forgerock.openam.entitlement.EntitlementModule</code>,
      holds the fully qualified class name of the <code class="literal">EntitlementModule</code>
      that registers the custom implementations.
      In this case, <code class="literal">org.forgerock.openam.entitlement.EntitlementModule</code>.
     </p></dd></dl></div><div class="procedure"><a name="building-a-sample-plugin"></a><div class="procedure-title">Procedure&nbsp;25.1.&nbsp;To Build a Sample Plugin</div><ol class="procedure" type="1"><li class="step"><p>
   Build the module using Apache Maven.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/openam-policy-eval-sample</strong>
$ <strong>mvn install</strong>
<em>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building openam-policy-eval-sample 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

...

[INFO] --- maven-jar-plugin:2.3.2:jar (default-jar) @ openam-policy-eval-sample
[INFO] Building jar: .../target/openam-policy-eval-sample-1.0.0-SNAPSHOT.jar
[INFO]

...

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.480s
[INFO] Finished at: Tue Dec 09 11:45:54 CET 2014
[INFO] Final Memory: 16M/257M
[INFO] ------------------------------------------------------------------------</em>
   </pre></div></li><li class="step"><p>
   Copy the .jar to the <code class="filename">WEB-INF/lib</code> directory
   where you deployed OpenAM.
   </p><div class="screen"><pre>
$ <strong>cp target/*.jar /path/to/tomcat/webapps/openam/WEB-INF/lib/</strong>
   </pre></div></li><li class="step"><p>
    Restart OpenAM or the container in which it runs.
   </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuring-sample-policy-plugin"></a>25.2.&nbsp;Configuring a Sample Policy Plugin</h2></div></div></div><p>
   This section shows how to edit OpenAM policy editor settings
   to allow policy administrators to configure policies
   that use the custom subject condition and custom environment condition.
  </p><div class="procedure"><a name="configure-the-sample-policy-plugin"></a><div class="procedure-title">Procedure&nbsp;25.2.&nbsp;To Configure the Sample Policy Plugin</div><p>
    OpenAM policy editor retrieves resources from the JSON file
    <code class="filename">policyEditor/locales/<em class="replaceable"><code>locale</code></em>/translation.json</code>,
    where the default <em class="replaceable"><code>locale</code></em> is <code class="literal">en</code>.
    The file is located under the directory where the OpenAM war file
    is unpacked for deployment,
    such as <code class="filename">/path/to/tomcat/webapps/openam</code>.
   </p><ol class="procedure" type="1"><li class="step"><p>
     Open the <code class="filename">translation.json</code> file for editing.
    </p><p>
     If your editor does not perform JSON syntax checking,
     then use a service such as
     <a class="link" href="http://jsonlint.com" target="_blank">http://jsonlint.com</a>
     to make sure your edits result in valid JSON.
    </p></li><li class="step"><p>
     In the <code class="literal">policy.subjectTypes</code> object,
     add an object defining the strings for the policy editor to use
     when displaying the custom subject condition.
    </p><pre class="brush: javascript;">
"subjectTypes": {
  "SampleSubject": {
    "title": "Sample Subject",
    "props": {
      "name": "Name"
    }
  },
    </pre></li><li class="step"><p>
     In the <code class="literal">policy.conditionTypes</code> object,
     add an object defining the strings for the policy editor to use
     when displaying the custom environment condition.
    </p><pre class="brush: javascript;">
"conditionTypes": {
  "SampleCondition": {
    "title": "Sample Condition",
    "props": {
      "nameLength": "Min. username length"
    }
  },
    </pre></li><li class="step"><p>
     When satisfied the JSON is correct, save the file.
    </p><p>
     Your custom policy plugin can now be used for new policy applications.
    </p></li></ol></div><p>
   In order to use your custom policy plugin with an existing policy application,
   see <a class="xref" href="#add-custom-policy-impl-to-existing-apps" title="25.3.&nbsp;Adding Custom Policy Implementations to Existing Policy Applications">Section&nbsp;25.3, &#8220;Adding Custom Policy Implementations to Existing Policy Applications&#8221;</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="add-custom-policy-impl-to-existing-apps"></a>25.3.&nbsp;Adding Custom Policy Implementations to Existing Policy Applications</h2></div></div></div><p>
   In order to use your custom policy in existing applications,
   you must update the applications.
   Note that you cannot update an application that already has policies configured.
   When there are already policies configured for an application,
   you must instead first delete the policies, and then update the application.
  </p><p>
   The following example updates
   the <code class="literal">iPlanetAMWebAgentService</code> application
   in the top level realm of a fresh installation.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "X-OpenAM-Username: amadmin" \
 --header "X-OpenAM-Password: password" \
 --header "Content-Type: application/json" \
 --data "{}" \
 https://openam.example.com:8443/openam/json/authenticate</strong>
<em>{"tokenId":"AQIC5wM2...","successUrl":"/openam/console"}</em>

$ <strong>curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5wM2..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "iPlanetAMWebAgentService",
    "resources": [
        "*://*:*/*?*",
        "*://*:*/*"
    ],
    "actions": {
        "POST": true,
        "PATCH": true,
        "GET": true,
        "DELETE": true,
        "OPTIONS": true,
        "HEAD": true,
        "PUT": true
    },
    "description": "The built-in Application used by OpenAM Policy Agents.",
    "realm": "/",
    "conditions": [
        "AuthenticateToService",
        "AuthLevelLE",
        "AuthScheme",
        "IPv6",
        "SimpleTime",
        "OAuth2Scope",
        "IPv4",
        "AuthenticateToRealm",
        "OR",
        "AMIdentityMembership",
        "LDAPFilter",
        "AuthLevel",
        "SessionProperty",
        "Session",
        "NOT",
        "AND",
        "ResourceEnvIP",
        "SampleCondition"
    ],
    "resourceComparator": null,
    "applicationType": "iPlanetAMWebAgentService",
    "subjects": [
        "JwtClaim",
        "AuthenticatedUsers",
        "Identity",
        "NOT",
        "AND",
        "NONE",
        "OR",
        "SampleSubject"
    ],
    "attributeNames": [],
    "saveIndex": null,
    "searchIndex": null,
    "entitlementCombiner": "DenyOverride"
}' https://openam.example.com:8443/openam/json/applications/iPlanetAMWebAgentService</strong>
  </pre></div><p>
   Notice that the command adds "SampleCondition" to "conditions",
   and "SampleSubject" to "subjects".
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trying-sample-policy-plugin"></a>25.4.&nbsp;Trying the Sample Subject and Environment Conditions</h2></div></div></div><p>
   Using OpenAM policy editor, create a policy
   in the "iPlanetAMWebAgentService" of the top level realm
   that allows HTTP GET access to "http://www.example.com:80/*"
   and that makes use of the custom subject and environment conditions.
  </p><p>
   The following listing shows a JSON representation of the policy.
  </p><pre class="brush: javascript;">
{
    "name": "Sample Policy",
    "active": true,
    "description": "Try sample policy plugin",
    "resources": [
        "http://www.example.com:80/*"
    ],
    "applicationName": "iPlanetAMWebAgentService",
    "actionValues": {
        "GET": true
    },
    "subject": {
        "type": "SampleSubject",
        "name": "demo"
    },
    "condition": {
        "type": "SampleCondition",
        "nameLength": 4
    }
}
  </pre><p>
   With the policy in place, authenticate
   both as a user who can request policy decisions
   and also as a user trying to access a resource.
   Both of these calls return "tokenId" values
   for use in the policy decision request.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "X-OpenAM-Username: amadmin" \
 --header "X-OpenAM-Password: password" \
 --header "Content-Type: application/json" \
 --data "{}" \
 https://openam.example.com:8443/openam/json/authenticate</strong>

<em>{"tokenId":"AQIC5wM2LY4Sfcw...","successUrl":"/openam/console"}</em>

$ <strong>curl \
 --request POST \
 --header "X-OpenAM-Username: demo" \
 --header "X-OpenAM-Password: changeit" \
 --header "Content-Type: application/json" \
 --data "{}" \
 https://openam.example.com:8443/openam/json/authenticate</strong>

<em>{"tokenId":"AQIC5wM2LY4Sfcy...","successUrl":"/openam/console"}</em>
  </pre></div><p>
   Use the administrator token ID as the header of the policy decision request,
   and the user token Id as the subject "ssoToken" value.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5wM2LY4Sfcw..." \
 --header "Content-Type: application/json" \
 --data '{
    "subject": {
      "ssoToken": "AQIC5wM2LY4Sfcy..."},
    "resources": [
        "http://www.example.com:80/index.html"
    ],
    "application": "iPlanetAMWebAgentService"
 }' \
 https://openam.example.com:8443/openam/json/policies?_action=evaluate</strong>
<em>
[
   {
       "resource": "http://www.example.com:80/index.html",
       "actions": {
           "GET": true
       },
       "attributes": {},
       "advices": {}
   }
]
   </em>
  </pre></div><p>
   Notice that the "actions" are set in accordance with the policy.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trying-custom-policy-resource-attributes"></a>25.5.&nbsp;Trying the Sample Resource Attributes</h2></div></div></div><p>
   The sample custom policy plugin can
   have OpenAM return an attribute with the policy decision.
   In order to make this work, update your policy to return a "test" attribute.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request PUT \
 --header "iPlanetDirectoryPro: AQIC5wM2LY4Sfcw..." \
 --header "Content-Type: application/json" \
 --data '{
    "name": "Sample Policy",
    "active": true,
    "description": "Try sample policy plugin",
    "resources": [
        "http://www.example.com:80/*"
    ],
    "applicationName": "iPlanetAMWebAgentService",
    "actionValues": {
        "GET": true
    },
    "subject": {
        "type": "SampleSubject",
        "name": "demo"
    },
    "condition": {
        "type": "SampleCondition",
        "nameLength": 4
    },
    "resourceAttributes": [
        {
            "type": "SampleAttribute",
            "propertyName": "test"
        }
    ]
}' http://openam.example.com:8088/openam/json/policies/Sample%20Policy</strong>
  </pre></div><p>
   When you now request the same policy decision as before,
   OpenAM returns the "test" attribute that you configured in the policy.
  </p><div class="screen"><pre>
$ <strong>curl \
 --request POST \
 --header "iPlanetDirectoryPro: AQIC5wM2LY4Sfcw..." \
 --header "Content-Type: application/json" \
 --data '{
    "subject": {
      "ssoToken": "AQIC5wM2LY4Sfcy..."},
    "resources": [
        "http://www.example.com:80/index.html"
    ],
    "application": "iPlanetAMWebAgentService"
 }' \
 http://openam.example.com:8080/openam/json/policies?_action=evaluate</strong>
<em>
[
    {
        "resource": "http://www.example.com/profile",
        "actions": {
            "GET": true
        },
        "attributes": {
            "test": [
                "sample"
            ]
        },
        "advices": {}
    }
]</em>
  </pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extend-ssoadm-classpath"></a>25.6.&nbsp;Extending the ssoadm Classpath</h2></div></div></div><p>
   After customizing your OpenAM deployment to use policy evaluation plugins,
   inform <span class="command"><strong>ssoadm</strong></span> users to add the jar file containing the
   plugins to the classpath before running policy management subcommands.
  </p><p>
   To add a jar file to the <span class="command"><strong>ssoadm</strong></span> classpath, set the
   <code class="literal">CLASSPATH</code> environment variable before running the
   <span class="command"><strong>ssoadm</strong></span> command.
   </p><div class="screen"><pre>
$ <strong>export CLASSPATH=<em><strong>/path/to/jarfile</strong></em>:$CLASSPATH</strong>
$ <strong>ssoadm ...</strong>
   </pre></div><p>
  </p></div></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-identity-repo-spi"></a>Chapter&nbsp;26.&nbsp;Customizing Identity Data Storage</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="#about-idrepo-plugin">26.1. About the Identity Repository Plugin</a></span></dt><dt><span class="section"><a href="#idrepo-plugin-implementation">26.2. Identity Repository Plugin Implementation</a></span></dt><dt><span class="section"><a href="#idrepo-plugin-deployment">26.3. Identity Repository Plugin Deployment</a></span></dt></dl></div><a class="indexterm" name="d13846e13894"></a><p>OpenAM maps user and group identities into a realm using data stores.
 An OpenAM data store relies on a Java identity repository (IdRepo) plugin to
 implement interaction with the identity repository where the users and groups
 are stored.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="about-idrepo-plugin"></a>26.1.&nbsp;About the Identity Repository Plugin</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="#idrepo-plugin-inheritance">26.1.1. IdRepo Inheritance</a></span></dt><dt><span class="section"><a href="#idrepo-plugin-lifecycle">26.1.2. IdRepo Lifecycle</a></span></dt><dt><span class="section"><a href="#idrepo-plugin-capabilities">26.1.3. IdRepo Plugin Capabilities</a></span></dt></dl></div><p>This chapter describes how to create a custom identity repository plugin.
  OpenAM includes built-in support for LDAP and JDBC identity repositories. For
  most deployments, you therefore do not need to create your own custom identity
  repository plugin. Only create custom identity repository plugins for
  deployments with particular requirements not met by built-in OpenAM
  functionality.</p><div class="tip"><h3 class="title">Tip</h3><p>Before creating your own identity repository plugin, start by reading
   the OpenAM source code for the <code class="literal">FilesRepo</code> or
   <code class="literal">DatabaseRepo</code> plugins under
   <code class="literal">com.sun.identity.idm.plugins</code>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idrepo-plugin-inheritance"></a>26.1.1.&nbsp;IdRepo Inheritance</h3></div></div></div><p>Your identity repository plugin class must extend the
   <code class="literal">com.sun.identity.idm.IdRepo</code> abstract class, and must
   include a constructor method that takes no arguments.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idrepo-plugin-lifecycle"></a>26.1.2.&nbsp;IdRepo Lifecycle</h3></div></div></div><p>When OpenAM instantiates your IdRepo plugin, it calls the
   <code class="literal">initialize()</code> method.</p><pre class="brush: java;">public void initialize(Map configParams)</pre><p>The <code class="literal">configParams</code> are service configuration
   parameters for the realm where the IdRepo plugin is configured. The
   <code class="literal">configParams</code> normally serve to set up communication with
   the underlying identity data store. OpenAM calls the
   <code class="literal">initialize()</code> method once, and considers the identity
   repository ready for use.</p><p>If you encounter errors or exceptions during initialization, catch
   and store them in your plugin for use later when OpenAM calls other plugin
   methods.</p><p>After initialization, OpenAM calls the <code class="literal">addListener()</code>
   and <code class="literal">removeListener()</code> methods to register listeners that
   inform OpenAM client code of changes to identities managed by your
   IdRepo.</p><pre class="brush: java;">public int addListener(SSOToken token, IdRepoListener listener)
public void removeListener()</pre><p>You must handle listener registration in your IdRepo plugin, and also
   return events to OpenAM through the <code class="literal">IdRepoListener</code>.</p><p>When stopping, OpenAM calls your IdRepo plugin
   <code class="literal">shutdown()</code> method.</p><pre class="brush: java;">public void shutdown()</pre><p>You are not required to implement <code class="literal">shutdown()</code> unless
   your IdRepo plugin has shut down work of its own to do, such as close
   connections to the underlying identity data store.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idrepo-plugin-capabilities"></a>26.1.3.&nbsp;IdRepo Plugin Capabilities</h3></div></div></div><p>Your IdRepo plugin provides OpenAM with a generic means to manage
   subjects&#8212;including users and groups but also special types such as
   roles, realms, and agents&#8212; and to create, read, update, delete, and
   search subjects. In order for OpenAM to determine your plugin's capabilities,
   it calls the methods described in this section.</p><pre class="brush: java;">public Set getSupportedTypes()</pre><p>The <code class="literal">getSupportedTypes()</code> method returns a set of
   <code class="literal">IdType</code> objects, such as <code class="literal">IdType.USER</code>
   and <code class="literal">IdType.GROUP</code>. You can either hard-code the supported
   types into your plugin, or make them configurable through the IdRepo
   service.</p><pre class="brush: java;">public Set getSupportedOperations(IdType type)</pre><p>The <code class="literal">getSupportedOperations()</code> method returns a set
   of <code class="literal">IdOperation</code> objects, such as
   <code class="literal">IdOperation.CREATE</code> and
   <code class="literal">IdOperation.EDIT</code>. You can also either hard-code these, or
   make them configurable.</p><pre class="brush: java;">public boolean supportsAuthentication()</pre><p>The <code class="literal">supportsAuthentication()</code> method returns true if
   your plugin supports the <code class="literal">authenticate()</code> method.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idrepo-plugin-implementation"></a>26.2.&nbsp;Identity Repository Plugin Implementation</h2></div></div></div><p>Your IdRepo plugin implements operational methods depending on what
  you support. These methods perform the operations in your data store.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Create</span></dt><dd><p>OpenAM calls <code class="literal">create()</code> to provision a new identity
     in the repository, where <code class="literal">name</code> is the new identity's
     name, and <code class="literal">attrMap</code> holds the attributes names and
     values.</p><pre class="brush: java;">public String create(SSOToken token, IdType type, String name, Map attrMap)
  throws IdRepoException, SSOException</pre></dd><dt><span class="term">Read</span></dt><dd><p>OpenAM calls the following methods to retrieve subjects in the
     identity repository, and to check account activity. If your data store
     does not support binary attributes, return an empty <code class="literal">Map</code>
     for <code class="literal">getBinaryAttributes()</code>.</p><pre class="brush: java;">public boolean isExists(
  SSOToken token,
  IdType type,
  String name
) throws IdRepoException, SSOException

public boolean isActive(
  SSOToken token,
  IdType type,
  String name
) throws IdRepoException, SSOException

public Map getAttributes(
  SSOToken token,
  IdType type,
  String name
) throws IdRepoException, SSOException

public Map getAttributes(
  SSOToken token,
  IdType type,
  String name,
  Set attrNames
) throws IdRepoException, SSOException

public Map getBinaryAttributes(
  SSOToken token,
  IdType type,
  String name,
  Set attrNames
) throws IdRepoException, SSOException

public RepoSearchResults search(
  SSOToken token,
  IdType type,
  String pattern,
  Map avPairs,
  boolean recursive,
  int maxResults,
  int maxTime,
  Set returnAttrs
) throws IdRepoException, SSOException

public RepoSearchResults search(
  SSOToken token,
  IdType type,
  String pattern,
  int maxTime,
  int maxResults,
  Set returnAttrs,
  boolean returnAllAttrs,
  int filterOp,
  Map avPairs,
  boolean recursive
) throws IdRepoException, SSOException</pre></dd><dt><span class="term">Edit</span></dt><dd><p>OpenAM calls the following methods to update a subject in the
     identity repository.</p><pre class="brush: java;">public void setAttributes(
  SSOToken token,
  IdType type,
  String name,
  Map attributes,
  boolean isAdd
) throws IdRepoException, SSOException

public void setBinaryAttributes(
  SSOToken token,
  IdType type,
  String name,
  Map attributes,
  boolean isAdd
) throws IdRepoException, SSOException

public void removeAttributes(
  SSOToken token,
  IdType type,
  String name,
  Set attrNames
) throws IdRepoException, SSOException

public void modifyMemberShip(
  SSOToken token,
  IdType type,
  String name,
  Set members,
  IdType membersType,
  int operation
) throws IdRepoException, SSOException

public void setActiveStatus(
  SSOToken token,
  IdType type,
  String name,
  boolean active
)</pre></dd><dt><span class="term">Authenticate</span></dt><dd><p>OpenAM calls <code class="literal">authenticate()</code> with the credentials
     from the <code class="literal">DataStore</code> authentication module.</p><pre class="brush: java;">public boolean authenticate(Callback[] credentials)
  throws IdRepoException, AuthLoginException</pre></dd><dt><span class="term">Delete</span></dt><dd><p>The <code class="literal">delete()</code> method removes the subject from
     the identity repository. The <code class="literal">name</code> specifies the
     subject.</p><pre class="brush: java;">public void delete(SSOToken token, IdType type, String name)
  throws IdRepoException, SSOException</pre></dd><dt><span class="term">Service</span></dt><dd><p>The <code class="literal">IdOperation.SERVICE</code> operation is rarely used
     in recent OpenAM deployments.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idrepo-plugin-deployment"></a>26.3.&nbsp;Identity Repository Plugin Deployment</h2></div></div></div><p>
   When you build your IdRepo plugin,
   include <code class="filename">openam-core-12.0.0.jar</code> in the classpath.
   This file is found under <code class="filename">WEB-INF/lib/</code>
   where OpenAM is deployed.
  </p><p>
   You can either package your plugin as a .jar,
   and then add it to <code class="filename">WEB-INF/lib/</code>,
   or add the classes under <code class="filename">WEB-INF/classes/</code>.
  </p><p>To register your plugin with OpenAM, you add a
  <code class="literal">SubSchema</code> to the
  <code class="literal">sunIdentityRepositoryService</code> using the
  <span class="command"><strong>ssoadm</strong></span> command. First, you create the
  <code class="literal">SubSchema</code> document having the following structure.</p><pre class="brush: xml;">&lt;SubSchema i18nKey="x4000" inheritance="multiple" maintainPriority="no"
           name="CustomRepo" supportsApplicableOrganization="no" validate="yes"&gt;
 &lt;AttributeSchema cosQualifier="default" isSearchable="no"
                  name="RequiredValueValidator" syntax="string"
                  type="validator" &gt;
  &lt;DefaultValues&gt;
   &lt;Value&gt;com.sun.identity.sm.RequiredValueValidator&lt;/Value&gt;
  &lt;/DefaultValues&gt;
 &lt;/AttributeSchema&gt;
 &lt;AttributeSchema any="required" cosQualifier="default"
                  i18nKey="x4001" isSearchable="no"
                  name="sunIdRepoClass" syntax="string"
                  type="single" validator="RequiredValueValidator" &gt;
  &lt;DefaultValues&gt;
   &lt;Value&gt;org.test.CustomRepo&lt;/Value&gt;
  &lt;/DefaultValues&gt;
 &lt;/AttributeSchema&gt;
 &lt;AttributeSchema cosQualifier="default" i18nKey="x4002" isSearchable="no"
                  name="sunIdRepoAttributeMapping" syntax="string" type="list"&gt;
  &lt;DefaultValues&gt;
    &lt;Value&gt;&lt;/Value&gt;
  &lt;/DefaultValues&gt;
 &lt;/AttributeSchema&gt;
&lt;/SubSchema&gt;</pre><p>Also include the <code class="literal">AttributeSchema</code> required to
  configure your IdRepo plugin.</p><p>
   Notice the <code class="literal">i18nKey</code> attributes
   on <code class="literal">SubSchema</code> elements.
   The <code class="literal">i18nKey</code> attribute values correspond to properties in
   the <code class="filename">amIdRepoService.properties</code> file
   under <code class="filename">WEB-INF/classes/</code> where OpenAM is deployed.
   OpenAM console displays the label for the configuration user interface
   that it retrieves from the value of the <code class="literal">i18nKey</code> property
   in the <code class="filename">amIdRepoService.properties</code> file.
  </p><p>
   To make changes to the properties,
   first extract <code class="filename">amIdRepoService.properties</code>
   and if necessary the localized versions of this file
   from <code class="filename">openam-core-12.0.0.jar</code>
   to <code class="filename">WEB-INF/classes/</code> where OpenAM is deployed.
   For example, if OpenAM is deployed under
   <code class="filename">/path/to/tomcat/webapps/openam</code>,
   then you could run the following commands.
  </p><div class="screen"><pre>
$ <strong>cd /path/to/tomcat/webapps/openam/WEB-INF/classes/</strong>
$ <strong>jar -xvf ../lib/openam-core-12.0.0.jar amIdRepoService.properties</strong>
 <em>inflated: amIdRepoService.properties</em>
  </pre></div><p>Register your plugin using the <span class="command"><strong>ssoadm</strong></span> command after
  copy the files into place.</p><div class="screen"><pre>
$ <strong>ssoadm \
 add-sub-schema \
 --adminid amadmin \
 --password-file /tmp/pwd.txt \
 --servicename sunIdentityRepositoryService \
 --schematype Organization \
 --filename customIdRepo.xml</strong>
  </pre></div><p>Login to OpenAM console as administrator, then then Browse to Access
  Control &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Data Stores. In the
  Data Stores table, click New... to create a Data Store corresponding to your
  custom IdRepo plugin. In the first screen of the wizard, name the Data Store
  and select the type corresponding to your plugin. In the second screen of the
  wizard, add the configuration for your plugin.</p><p>After creating the Data Store, create a new subject in the realm to
  check that your plugin works as expected. You can do this under Access
  Control &gt; <em class="replaceable"><code>Realm Name</code></em> &gt; Subjects.</p><p>If your plugin supports authentication, then users should now be able
  to authenticate using the <code class="literal">DataStore</code> module for the
  realm.</p><pre class="literallayout">http://openam.example.com:8080/openam/UI/Login?realm=test&amp;module=DataStore</pre></div></div><div class="index"><div class="titlepage"><div><div><h1 class="title"><a name="d13846e14224"></a>Index</h1></div></div></div><div class="index"><div class="indexdiv"><h3>A</h3><dl><dt>Authentication</dt><dd><dl><dt>Custom module, <a class="indexterm" href="#chap-auth-spi">Customizing Authentication Modules</a></dt><dt>Java API, <a class="indexterm" href="#chap-authentication">Authenticating Using OpenAM Java SDK</a></dt><dt>Post authentication plugins, <a class="indexterm" href="#chap-post-auth">Creating a Post Authentication Plugin</a></dt><dt>REST API, <a class="indexterm" href="#rest-api-auth">Authentication &amp; Logout</a></dt><dt>Scripted modules, <a class="indexterm" href="#chap-scripted-auth-module">Scripted Authentication</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>D</h3><dl><dt>Dashboard services, <a class="indexterm" href="#rest-dashboard">Displaying Dashboard Applications</a></dt></dl></div><div class="indexdiv"><h3>F</h3><dl><dt>Fedlets</dt><dd><dl><dt>.NET, <a class="indexterm" href="#chap-fedlet-dotnet">Using Fedlets in .NET Applications</a></dt><dt>Java, <a class="indexterm" href="#chap-fedlet-java">Using Fedlets in Java Web Applications</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>I</h3><dl><dt>Installing</dt><dd><dl><dt>C SDK, <a class="indexterm" href="#chap-csdk">Using the OpenAM C API</a></dt><dt>Java SDK samples, <a class="indexterm" href="#install-jdk-samples">Installing OpenAM Client SDK Samples</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>O</h3><dl><dt>OAuth 2.0, <a class="indexterm" href="#chap-oauth2-scopes">Customizing OAuth 2.0 Scope Handling</a></dt><dd><dl><dt>REST API, <a class="indexterm" href="#rest-api-oauth2">OAuth 2.0 Authorization</a></dt></dl></dd><dt>OpenID Connect 1.0</dt><dd><dl><dt>REST API, <a class="indexterm" href="#rest-api-openid-connect">OpenID Connect 1.0</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>P</h3><dl><dt>Passwords</dt><dd><dl><dt>Change, <a class="indexterm" href="#rest-api-change-password">Changing Passwords</a></dt><dt>Reset, <a class="indexterm" href="#rest-api-password-reset">Resetting Forgotten Passwords</a>, <a class="indexterm" href="#rest-api-change-password">Changing Passwords</a></dt></dl></dd><dt>Policy</dt><dd><dl><dt>Java API, <a class="indexterm" href="#chap-policy-decisions">Requesting Policy Decisions Using OpenAM Java SDK</a></dt><dt>Plugins, <a class="indexterm" href="#chap-policy-spi">Customizing Policy Evaluation</a></dt><dt>REST API, <a class="indexterm" href="#rest-api-authz">About the REST Policy Endpoints</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>R</h3><dl><dt>Realm data</dt><dd><dl><dt>REST access, <a class="indexterm" href="#rest-api-crud-realm">Realm Management</a></dt></dl></dd><dt>REST API, <a class="indexterm" href="#chap-rest">RESTful Web Services</a>, <a class="indexterm" href="#chap-rest-authz-policy">RESTful Authorization and Policy Management Services</a>, <a class="indexterm" href="#chap-rest-oauth2-oidc">RESTful OAuth 2.0 and OpenID Connect 1.0 Services</a>, <a class="indexterm" href="#chap-rest-user-services">RESTful User Self-Service</a>, <a class="indexterm" href="#chap-rest-identity-realm-mgmt">RESTful Identity and Realm Management Services</a></dt><dt>REST STS, <a class="indexterm" href="#chap-rest-sts">RESTful Secure Token Service</a></dt></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>Secure Attribute Exchange (SAE), <a class="indexterm" href="#chap-sae">Using Secure Attribute Exchange</a></dt><dt>Self-registration, <a class="indexterm" href="#rest-api-self-registration">User Self-Registration</a></dt><dt>Session information</dt><dd><dl><dt>REST API, <a class="indexterm" href="#rest-api-tokens">Token Validation and Session Information</a></dt></dl></dd><dt>Session tokens</dt><dd><dl><dt>Java API, <a class="indexterm" href="#chap-session">Handling Single Sign-On Using OpenAM Java SDK</a></dt><dt>REST API, <a class="indexterm" href="#rest-api-auth">Authentication &amp; Logout</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>T</h3><dl><dt>Token validation</dt><dd><dl><dt>REST API, <a class="indexterm" href="#rest-api-tokens">Token Validation and Session Information</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>U</h3><dl><dt>User data</dt><dd><dl><dt>Custom profile attributes, <a class="indexterm" href="#chap-custom-attr">Customizing Profile Attributes</a></dt><dt>Custom repository, <a class="indexterm" href="#chap-identity-repo-spi">Customizing Identity Data Storage</a></dt><dt>REST access, <a class="indexterm" href="#rest-api-crud-identity">Identity Management</a></dt></dl></dd></dl></div></div></div></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10000&components=10007&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-14']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>