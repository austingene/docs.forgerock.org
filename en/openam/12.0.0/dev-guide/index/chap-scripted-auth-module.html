<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Chapter&nbsp;21.&nbsp;Scripted Authentication</title><link rel="stylesheet" type="text/css" href="coredoc.css"><link rel="stylesheet" type="text/css" href="css/coredoc.css"><link rel="stylesheet" type="text/css" href="sh/shCore.css"><link rel="stylesheet" type="text/css" href="sh/shCoreEclipse.css"><link rel="stylesheet" type="text/css" href="sh/shThemeEclipse.css"><script src="http://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script><script src="uses-jquery.js" type="text/javascript"></script><script src="sh/shCore.js" type="text/javascript"></script><script src="sh/shBrushAci.js" type="text/javascript"></script><script src="sh/shBrushBash.js" type="text/javascript"></script><script src="sh/shBrushCsv.js" type="text/javascript"></script><script src="sh/shBrushHttp.js" type="text/javascript"></script><script src="sh/shBrushJava.js" type="text/javascript"></script><script src="sh/shBrushJScript.js" type="text/javascript"></script><script src="sh/shBrushLDIF.js" type="text/javascript"></script><script src="sh/shBrushPlain.js" type="text/javascript"></script><script src="sh/shBrushProperties.js" type="text/javascript"></script><script src="sh/shBrushXml.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="OpenAM Developer's Guide"><link rel="up" href="index.html" title="OpenAM Developer's Guide"><link rel="prev" href="chap-oauth2-scopes.html" title="Chapter&nbsp;20.&nbsp;Customizing OAuth 2.0 Scope Handling"><link rel="next" href="chap-auth-spi.html" title="Chapter&nbsp;22.&nbsp;Customizing Authentication Modules"><link rel="copyright" href="legalnotice.html" title="Legal Notice"><script type="text/javascript">SyntaxHighlighter.all();</script>
<link rel="shortcut icon" href="http://forgerock.org/favicon.ico">
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;21.&nbsp;Scripted Authentication</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap-oauth2-scopes.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chap-auth-spi.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="chap-scripted-auth-module"></a>Chapter&nbsp;21.&nbsp;Scripted Authentication</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-about">21.1. About Authentication Module Scripts</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-api">21.2. Authentication Script API</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-javascript-example">21.3. Example JavaScript Authentication Module</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-groovy-example">21.4. Example Groovy Authentication Module</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-try-it-out">21.5. Trying It Out</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-sandbox">21.6. Scripted Authentication Sandbox</a></span></dt></dl></div><p>
  This chapter demonstrates how to develop scripts
  for a scripted authentication module.
 </p><a class="indexterm" name="d0e11513"></a><p>
  A scripted authentication module allows you to develop
  a custom authentication module by adding Groovy or JavaScript
  to the module configuration.
  Scripted authentication modules are an alternative to developing
  custom authentication modules in Java as described in
  <a href="../../dev-guide/index/chap-auth-spi.html" class="link"><em class="citetitle">Customizing Authentication Modules</em></a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-about"></a>21.1.&nbsp;About Authentication Module Scripts</h2></div></div></div><p>
   This section explains how client-side and server-side scripts
   cooperate to perform authentication.
  </p><p>
   A scripted authentication module runs scripts to authenticate a user.
   The configuration for the module can hold two scripts,
   one to include in the web page run on the client user-agent,
   another to run in OpenAM on the server side.
  </p><p>
   The client-side script is intended to retrieve data from the user-agent.
   This must be in a language the the user-agent, such as JavaScript,
   even if the server-side script is written in Groovy.
  </p><p>
   The client-side script data is returned to OpenAM by self-submitting form.
   This makes the client-side data available to the server-side script.
   The client-side script does this by adding data to a String object,
   <code class="literal">clientScriptOutputData</code>.
  </p><p>
   The server-side script is intended to handle authentication.
  </p><p>
   The server-side script runs after the client-side script has completed.
   The server-side script has access both
   to information added by the client-side script to
   <code class="literal">clientScriptOutputData</code>,
   and also to several objects from OpenAM
   described in <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-api" title="21.2.&nbsp;Authentication Script API">Section&nbsp;21.2, &#8220;Authentication Script API&#8221;</a>,
   allowing it to make an authentication decision.
   The server-side script thus must at minimum set the authentication state
   to success or failure.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-api"></a>21.2.&nbsp;Authentication Script API</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-auth-state">21.2.1. Accessing Authentication State</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-client-data">21.2.2. Access Client-Side Script Output Data</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-http-client">21.2.3. Accessing HTTP Services</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-id-repo">21.2.4. Accessing Profile Data</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-logger">21.2.5. Logging</a></span></dt><dt><span class="section"><a href="chap-scripted-auth-module.html#scripted-auth-module-request-data">21.2.6. Accessing Request Data</a></span></dt></dl></div><p>
   Client-side scripts have access only to the user-agent API.
   That API of course depends on the user agent.
  </p><div class="itemizedlist"><p>
    Server-side scripts have access to objects from OpenAM
    for the following uses.
   </p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-auth-state" title="21.2.1.&nbsp;Accessing Authentication State">Section&nbsp;21.2.1, &#8220;Accessing Authentication State&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-client-data" title="21.2.2.&nbsp;Access Client-Side Script Output Data">Section&nbsp;21.2.2, &#8220;Access Client-Side Script Output Data&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-http-client" title="21.2.3.&nbsp;Accessing HTTP Services">Section&nbsp;21.2.3, &#8220;Accessing HTTP Services&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-id-repo" title="21.2.4.&nbsp;Accessing Profile Data">Section&nbsp;21.2.4, &#8220;Accessing Profile Data&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-logger" title="21.2.5.&nbsp;Logging">Section&nbsp;21.2.5, &#8220;Logging&#8221;</a>
    </p></li><li class="listitem"><p>
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-request-data" title="21.2.6.&nbsp;Accessing Request Data">Section&nbsp;21.2.6, &#8220;Accessing Request Data&#8221;</a>
    </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-auth-state"></a>21.2.1.&nbsp;Accessing Authentication State</h3></div></div></div><p>
    OpenAM passes <code class="literal">authState</code> and <code class="literal">sharedState</code>
    to server-side scripts in order for the scripts
    to access authentication state.
   </p><p>
    Server-side scripts can access the current authentication state
    through the <code class="literal">authState</code> object.
   </p><p>
    The <code class="literal">authState</code> value is <code class="literal">SUCCESS</code>
    if the authentication is currently successful,
    or <code class="literal">FAILED</code> if authentication has failed.
    Server-side scripts must set a value for <code class="literal">authState</code>
    before completing.
   </p><p>
    If an earlier authentication module in the authentication chain
    has set the login name of the user,
    server-side scripts can access the login name
    through <code class="literal">username</code>.
    This is shared by
    Anonymous,
    Certificate,
    Data Store,
    Federation,
    HTTP Basic,
    JDBC,
    LDAP,
    Membership,
    RADIUS,
    <span lang="en" class="phrase">
SecurID,
</span>
    Windows Desktop SSO,
    &amp; Windows NT
    authentication modules.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-client-data"></a>21.2.2.&nbsp;Access Client-Side Script Output Data</h3></div></div></div><p>
    Client-side scripts add data they gather into a String object
    named <code class="literal">clientScriptOutputData</code>.
    Client-side scripts then cause the user-agent automatically
    to return the data to OpenAM by HTTP POST of a self-submitting form.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-http-client"></a>21.2.3.&nbsp;Accessing HTTP Services</h3></div></div></div><p>
    OpenAM passes an HTTP client object, <code class="literal">httpClient</code>,
    to server-side scripts.
    Server-side scripts can call HTTP services
    with the <code class="literal">httpClient.get</code>
    and <code class="literal">httpClient.post</code> methods.
    The methods return an <code class="literal">HttpClientResponse</code>.
   </p><div class="table"><a name="scripted-auth-module-http-client-methods"></a><div class="table-title">Table&nbsp;21.1.&nbsp;HTTP Client Methods</div><div class="table-contents"><table summary="HTTP Client Methods" width="100%" border="0"><colgroup><col width="12%"><col width="25%"><col width="25%"><col width="38%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">get</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>uri</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>requestData</code></em></code> (type:
         <code class="literal">Map</code>)
        </p>
       </td><td>
        <p>
         <code class="literal">HttpClientResponse</code>
        </p>
       </td><td>
        <p>
         Perform an HTTP GET on the specified URI
         with the specified request data,
         and return the response retrieved.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">post</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>uri</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>body</code></em></code> (type: <code class="literal">String</code>),
         <code class="literal"><em class="replaceable"><code>requestData</code></em></code> (type:
         <code class="literal">Map</code>)
        </p>
       </td><td>
        <p>
         <code class="literal">HttpClientResponse</code>
        </p>
       </td><td>
        <p>
         Perform an HTTP POST to the specified URI
         with the specified body and request data,
         and return the response retrieved.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"><p>
    The <code class="literal">requestData</code> object is a map where the keys are
    <code class="literal">cookies</code> and <code class="literal">headers</code>. OpenAM ignores other keys.
   </p><p>
    The <code class="literal">cookies</code> value, specifying the cookie headers in the
    request, is a list of Maps where the keys are <code class="literal">domain</code>,
    <code class="literal">field</code>, and <code class="literal">value</code>.
   </p><p>
    The <code class="literal">headers</code> value, specifying the headers in the request,
    is a list of Maps where the keys are <code class="literal">field</code>, and
    <code class="literal">value</code>.
   </p><p>An example <code class="literal">requestData</code> JavaScript object using GET
    would be as follows:</p><pre class="brush: javascript;">
var response = httpClient.get("http://example.com:8080/openam/json/users" + username,
 {
   cookies:[
    {
       "domain": ".example.com",
       "field": "iPlanetDirectoryPro,
       "value": "E8cDkvlad83kdKDodkIEIxqJ938DKSDLIE31djkiefjekda.*DLEDLKJKD09dkleuhDK3kEJKj"
    }
   ],
   headers:[
    {
       "field": "Content-type",
       "value": "application/json"
    }
   ]
 });
   </pre><p>An example <code class="literal">requestData</code> JavaScript object using POST
    would be as follows:</p><pre class="brush: javascript;">
var response = httpClient.post("http://example.com:8080/openam/json/authenticate","{
  "authId": "eyAiYWxnIjogIkhTMjU2IiwgInR5cCI6ICJqd3QiIH0.eyAib3RrIjogIm03ODVzN2x
   sbnR1bjZvbGZ1MHZhOGVtYTQxIiwgInNlc3Npb25JZCI6ICJBUUlDNXdNMkxZNFNmY3lEeDY3QnB
   PdzJtRU9rUzNpLWhfNDdRWlMwNHBEN1ppdy4qQUFKVFNRQUNNREVBQWxOTEFCUXROak15TURjNU1
   UZzROVFUwTXpnNE5qRTNNQS4uKiIsICJyZWFsbSI6ICJkYz1vcGVuYW0sZGM9Zm9yZ2Vyb2NrLGR
   jPW9yZyIgfQ.VDRqaekQuXBm2lNI29hfwVADLxjepezuO0241VNDsIM",
  "template": "",
  "stage": "DataStore1",
  "callbacks": [
    {
      "type": "NameCallback",
      "output": [
        {
          "name": "prompt",
          "value": "User Name:"
        }
       ],
      "input": [
        {
          "name": "IDToken1",
          "value": "demo"
        }
       ]
    },
    {
      "type": "PasswordCallback",
      "output": [
        {
          "name": "prompt",
          "value": "Password:"
        }
       ],
      "input": [
        {
          "name": "IDToken2",
          "value": "changeit"
        }
      ]
    }
  ]
 }",
 {
   cookies:[
   ],
   headers:[
    {
      "field": "Content-Type",
      "value": "application/json"
    }
   ]
 });
</pre><div class="note"><h3 class="title">Note</h3><p>To get the form data, you can access the <code class="literal">sharedState</code>
    object to get the data that previous modules in the chain have obtained.
    For example, if you have a DataStore module in your chain, you can get the
    username and password from the <code class="literal">sharedState</code> object in the
    script.
   </p></div><p>
    HTTP client requests are synchronous, blocking until they return.
    You can, however, set a global timeout for server-side scripts.
    For details, see the <em class="citetitle">Administration Guide</em> section,
    <a href="../../admin-guide/index/chap-auth-services.html#scripted-module-conf-hints" class="link"><em class="citetitle">Hints For Scripted Authentication Modules</em></a>.
   </p><p>
    Server-side scripts can access response data by using the methods
    listed in the table below.
   </p><div class="table"><a name="scripted-auth-module-http-client-response-methods"></a><div class="table-title">Table&nbsp;21.2.&nbsp;HTTP Client Response Methods</div><div class="table-contents"><table summary="HTTP Client Response Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getCookies</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Map&lt;String, String&gt;</code>
        </p>
       </td><td>
        <p>
         Get the cookies for the returned response, if any exist.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getEntity</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Get the entity of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Map&lt;String, String&gt;</code>
        </p>
       </td><td>
        <p>
         Get the headers for the returned response, if any exist.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getReasonPhrase</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Get the reason phrase of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getStatusCode</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">Integer</code>
        </p>
       </td><td>
        <p>
         Get the status code of the returned response.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">hasCookies</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         Indicates whether the returned response had any cookies.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">hasHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         Indicates whether the returned response had any headers.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-id-repo"></a>21.2.4.&nbsp;Accessing Profile Data</h3></div></div></div><p>
    Server-side scripts can access profile data through
    the methods of the <code class="literal">idRepository</code> object.
   </p><div class="table"><a name="scripted-auth-module-id-repo-methods"></a><div class="table-title">Table&nbsp;21.3.&nbsp;Profile Data Methods</div><div class="table-contents"><table summary="Profile Data Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         Set
        </p>
       </td><td>
        <p>
         Return the values of the named attribute for the named user.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">setAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeValue</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Set the named attribute to the specified value for the named user,
         and persist the result in the user's profile.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">addAttribute</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>userName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeName</code></em></code> (type: String),
         <code class="literal"><em class="replaceable"><code>attributeValue</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Adds an attribute value to the list of attribute values associated with the
         attribute name for a particular user.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-logger"></a>21.2.5.&nbsp;Logging</h3></div></div></div><p>
    Server-side scripts can log messages to OpenAM debug logs
    by using the methods of the <code class="literal">logger</code> object.
   </p><p>
    By default, OpenAM does not log debug messages from scripts.
    You can configure OpenAM to log such messages
    by setting the debug log level for the <code class="literal">amScript</code> service.
    For details, see the <em class="citetitle">Administration Guide</em> section,
    <a href="../../admin-guide/index/chap-monitoring.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
   </p><p>
    The following table lists the <code class="literal">logger</code> methods.
   </p><div class="table"><a name="scripted-auth-module-logger-methods"></a><div class="table-title">Table&nbsp;21.4.&nbsp;Logger Methods</div><div class="table-contents"><table summary="Logger Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">error</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if ERROR level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">errorEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when ERROR level debug messages are enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">message</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if MESSAGE level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">messageEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when MESSAGE level debug messages are enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">warning</code>
        </p>
       </td><td>
        <p>
         <code class="literal">String <em class="replaceable"><code>message</code></em></code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         Logs <em class="replaceable"><code>message</code></em> to OpenAM debug logs
         if WARNING level logging is enabled.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">warningEnabled</code>
        </p>
       </td><td>
        <p>
         <code class="literal">void</code>
        </p>
       </td><td>
        <p>
         <code class="literal">boolean</code>
        </p>
       </td><td>
        <p>
         <code class="literal">true</code> when WARNING level debug messages are enabled.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripted-auth-module-request-data"></a>21.2.6.&nbsp;Accessing Request Data</h3></div></div></div><p>
    Server-side scripts can get access to the login request
    by using the methods of the <code class="literal">requestData</code> object.
   </p><p>
    The following table lists the methods
    of the <code class="literal">requestData</code> object. Note that this object differs
    from the client-side <code class="literal">requestData</code> object (see
     <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-http-client-methods" title="Table&nbsp;21.1.&nbsp;HTTP Client Methods">Table&nbsp;21.1, &#8220;HTTP Client Methods&#8221;</a>)
    and contains information about the original authentication request made by the user.
   </p><div class="table"><a name="scripted-auth-module-request-data-methods"></a><div class="table-title">Table&nbsp;21.5.&nbsp;Request Data Methods</div><div class="table-contents"><table summary="Request Data Methods" width="100%" border="0"><colgroup><col width="20%"><col width="20%"><col width="20%"><col width="40%"></colgroup><thead><tr><th>Method</th><th>Parameters</th><th>Return Type</th><th>Description</th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">getHeader</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Return the String value of the named request header,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getHeaders</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String[]</code>
        </p>
       </td><td>
        <p>
         Return the array of String values of the named request header,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getParameter</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String</code>
        </p>
       </td><td>
        <p>
         Return the String value of the named request parameter,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">getParameters</code>
        </p>
       </td><td>
        <p>
         <code class="literal"><em class="replaceable"><code>name</code></em></code> (type: String)
        </p>
       </td><td>
        <p>
         <code class="literal">String[]</code>
        </p>
       </td><td>
        <p>
         Return the array of String values of the named request parameter,
         or <code class="literal">null</code> if parameter is not set.
        </p>
       </td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-javascript-example"></a>21.3.&nbsp;Example JavaScript Authentication Module</h2></div></div></div><p>
   This section demonstrates an authentication module
   with server-side JavaScript.
  </p><p>
   Before you start, make sure OpenAM is installed and configured,
   and create a new Scripted Module authentication module configuration
   in the realm / (Top Level Realm), called <code class="literal">JavaScript</code>.
  </p><p>
   To create the module configuration, browse in OpenAM Console
   to Access Control &gt; / (Top Level Realm) &gt; Authentication &gt; Module Instances,
   and then click New.
   The name of your new module should be <code class="literal">JavaScript</code>,
   and the type should be <code class="literal">Scripted Module</code>.
  </p><p>
   Next, browse to the new authentication module configuration in OpenAM console
   under Module Instances &gt; JavaScript.
  </p><p>
   You notice that an example server-side script already exists.
   Replace that script with the following program listing.
  </p><pre class="brush: javascript;">
var START_TIME = 9;  // 9am
var END_TIME   = 17; // 5pm

logger.message("Starting server-side JavaScript");
logger.message("User: " + username);

var now = new Date();
logger.message("Current time: " + now.getHours());

if (now.getHours() &lt; START_TIME || now.getHours() &gt; END_TIME) {
    logger.error("Login forbidden outside work hours!");
    authState = FAILED;
} else {
    logger.message("Authentication allowed!");
    authState = SUCCESS;
}
  </pre><p>
   This server-side script simply allows users to authenticate successfully
   if they login between 9 AM and 5 PM (according to the server time zone).
   It demonstrates logging messages to OpenAM debug logs.
  </p><p>
   If you are trying this script outside "work hours",
   then edit the <code class="literal">START_TIME</code> or <code class="literal">END_TIME</code>.
  </p><p>
   In addition, debug logging for server-side scripts is not enabled by default.
   Configure message-level debug logging for scripted authentication modules
   by setting the debug log level for the <code class="literal">amScript</code> service.
   For details, see the <em class="citetitle">Administration Guide</em> section,
   <a href="../../admin-guide/index/chap-monitoring.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
  </p><p>
   At this point, the authentication module is ready for use.
   You can either add an example Groovy scripted authentication module as well
   as described in <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-groovy-example" title="21.4.&nbsp;Example Groovy Authentication Module">Section&nbsp;21.4, &#8220;Example Groovy Authentication Module&#8221;</a>,
   or use the current module alone
   as described in <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-try-it-out" title="21.5.&nbsp;Trying It Out">Section&nbsp;21.5, &#8220;Trying It Out&#8221;</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-groovy-example"></a>21.4.&nbsp;Example Groovy Authentication Module</h2></div></div></div><p>
   This section demonstrates an authentication module
   with a server-side Groovy script.
  </p><p>
   Create a new Scripted Module authentication module
   for a server-side Groovy script as described for the JavaScript module
   in <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-javascript-example" title="21.3.&nbsp;Example JavaScript Authentication Module">Section&nbsp;21.3, &#8220;Example JavaScript Authentication Module&#8221;</a>.
   The name of your new module should be <code class="literal">Groovy</code>,
   and the type should be <code class="literal">Scripted Module</code>.
  </p><p>
   Next, browse to the new authentication module configuration in OpenAM console
   under Module Instances &gt; Groovy.
  </p><p>
   Set the Server-Side Script Language to Groovy.
  </p><p>
   Also notice that an example server-side script already exists.
   Replace that script with the following program listing.
  </p><pre class="brush: java;">
START_TIME = 9   // 9am
END_TIME   = 17  // 5pm

logger.message("Starting server-side Groovy script")
logger.message("User: " + username)

now = new Date()
logger.message("Current time: " + now.getHours())

if (now.getHours() &lt; START_TIME || now.getHours() &gt; END_TIME) {
    logger.error("Login forbidden outside work hours!")
    authState = FAILED
} else {
    logger.message("Authentication allowed!")
    authState = SUCCESS
}
  </pre><p>
   This server-side script simply allows users to authenticate successfully
   if they login between 9 AM and 5 PM (according to the server time zone).
   It demonstrates logging messages to OpenAM debug logs.
  </p><p>
   If you are trying this script outside "work hours",
   then edit the <code class="literal">START_TIME</code> or <code class="literal">END_TIME</code>.
  </p><p>
   In addition, debug logging for server-side scripts is not enabled by default.
   If you have not already done so,
   configure message-level debug logging for scripted authentication modules
   by setting the debug log level for the <code class="literal">amScript</code> service.
   For details, see the <em class="citetitle">Administration Guide</em> section,
   <a href="../../admin-guide/index/chap-monitoring.html#log-debug-selective-capture" class="link"><em class="citetitle">Debug Logging by Service</em></a>.
  </p><p>
   At this point, the authentication module is ready for use.
   You can use the module as described in
   <a class="xref" href="chap-scripted-auth-module.html#scripted-auth-module-try-it-out" title="21.5.&nbsp;Trying It Out">Section&nbsp;21.5, &#8220;Trying It Out&#8221;</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-try-it-out"></a>21.5.&nbsp;Trying It Out</h2></div></div></div><p>
   You can put the example scripted authentication modules
   into an authentication chain, and then try them out.
  </p><p>
   First create a new authentication chain.
   In OpenAM console under
   Access Control &gt; / (Top Level Realm) &gt; Authentication &gt; Authentication Chaining
   click New, and then name your new chain <code class="literal">scripted</code>.
  </p><p>
   After creating the chain, click Authentication Chaining &gt; scripted
   to edit the configuration for the chain.
  </p><p>
   Add a DataStore module as REQUIRED to the chain first.
   The DataStore module checks the user credentials,
   whereas the scripted authentication modules do not check credentials,
   but instead only check that the authentication request
   is processed during working hours.
   Without the DataStore module, therefore, the <code class="literal">username</code>
   in the scripted authentication modules could not be determined.
  </p><p>
   After the DataStore module, add as REQUIRED either or both
   of the example scripted authentication modules you configured to the chain.
   For example, if you add both the JavaScript and Groovy modules,
   then your <code class="literal">scripted</code> chain would have three REQUIRED modules,
   first the DataStore module, and then JavaScript and Groovy modules.
   Make sure you save the chain configuration.
  </p><p>
   To try the new authentication chain, first log out of OpenAM.
   Next, browse to the login URI for the chain
   <code class="literal">/XUI/#login/&amp;service=scripted</code>,
   where the full URL depends on your deployment,
   and is something like
   <code class="literal">http://openam.example.com:8080/openam/XUI/#login/&amp;service=scripted</code>.
  </p><p>
   Login as the sample user having
   username <code class="literal">demo</code> and password <code class="literal">changeit</code>.
  </p><p>
   When you complete the login process successfully, you should see
   the sample user profile page.
   You should also see messages such as the following
   in the <code class="filename">debug/Authentication</code> log file.
  </p><pre class="brush: plain;">
amScript:07/08/2014 11:31:21:835 AM CEST: Thread[pool-19-thread-5,5,main]
Starting server-side JavaScript
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
User: demo
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
Current time: 11
amScript:07/08/2014 11:31:21:837 AM CEST: Thread[pool-19-thread-5,5,main]
Authentication allowed!
amScript:07/08/2014 11:31:22:567 AM CEST: Thread[pool-19-thread-6,5,main]
Starting server-side Groovy script
amScript:07/08/2014 11:31:22:567 AM CEST: Thread[pool-19-thread-6,5,main]
User: demo
amScript:07/08/2014 11:31:22:568 AM CEST: Thread[pool-19-thread-6,5,main]
Current time: 11
amScript:07/08/2014 11:31:22:568 AM CEST: Thread[pool-19-thread-6,5,main]
Authentication allowed!
  </pre><p>
   If the login process fails due to errors in your scripts,
   then see the same log file for information about the errors.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripted-auth-module-sandbox"></a>21.6.&nbsp;Scripted Authentication Sandbox</h2></div></div></div><p>The OpenAM console provides a sandboxing feature to test your Javascript
   or Groovy scripted authentication modules, ensuring that malicious Java classes
   are not directly called.

   The sandbox validates the script by checking that all directly-called Java
   classes match those in a whitelist of classes that are allowed to be invoked.
  </p><p>You can configure the sandbox in the console by navigating to Configuration &gt;
   Authentication &gt; Scripted Module.
  </p><p>The sandbox supports the following features:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold"><strong>Java Class Whitelist</strong></span>. Specifies the list
     of class-name patterns allowed to be invoked by the script. Every class
     accessed by the script must match at least one of these patterns. You can
     specify the classes as is or use "*" wildcards. The default whitelist values
     are stored in the <code class="literal">amAuthScripted.xml</code> file.
    </p></li><li class="listitem"><p><span class="bold"><strong>Java Class Blacklist</strong></span>. Specifies the list
     of class-name patterns that are NOT allowed to be invoked by the script.
     The blacklist is applied AFTER the whitelist to exclude those classes.

     You can specify the classes to exclude as is or use "*" wildcards.
     The default blacklist values are stored in the <code class="literal">amAuthScripted.xml</code> file.
    </p></li><li class="listitem"><p><span class="bold"><strong>Using System SecurityManager</strong></span>. If enabled,
     the sandbox will make an additional call to
     <code class="literal">System.getSecurityManager().checkPackageAccess(...)</code>
     for each class that is accessed. The method throws a SecurityException
     if the calling thread is not allowed to access the package.
     This feature only takes effect if the security manager is enabled for the JVM.
    </p></li></ul></div><div class="variablelist"><div class="variablelist-title">Points about the Scripted Authentication Sandbox</div><dl class="variablelist"><dt><span class="term">Sandbox only validates directly accessible classes.</span></dt><dd><p>The sandbox only applies to classes that the script <span class="emphasis"><em>directly</em></span>
      accesses. If the script calls <code class="literal">Foo.a()</code> and then that method
      calls Bar.b(), then the sandbox will allow it. You must consider the whole
      chain of accessible classes from each white-listed class.
     </p><div class="note"><h3 class="title">Note</h3><p>"Access" means importing/loading a class,
      accessing any instance of that class (for example, passed as a parameter
      to the script), calling a static method on that class, calling a method on
      an instance of that class, accessing a method or field that returns an
      instance of that class, etc.
     </p></div></dd><dt><span class="term">All Java reflection classes are blacklisted by default.</span></dt><dd><p>All Java reflection classes (<code class="literal">java.lang.Class, java.lang.reflect.*</code>)
      are blacklisted by default to avoid bypassing the sandbox.
      Do not enable these reflection classes.
     </p></dd><dt><span class="term"><code class="literal">java.security.AccessController</code> is blacklisted by default.</span></dt><dd><p>The <code class="literal">java.security.AccessController</code> is blacklisted by default
      to prevent access to the <code class="literal">doPrivileged()</code> methods.
     </p></dd><dt><span class="term">No knowledge about inheritance.</span></dt><dd><p>The whitelist patterns apply only to the exact class or package names
      involved. The sandbox does not know anything about inheritance, so it is
      best to white list known, specific classes.
     </p></dd></dl></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap-oauth2-scopes.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chap-auth-spi.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;20.&nbsp;Customizing OAuth 2.0 Scope Handling&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;22.&nbsp;Customizing Authentication Modules</td></tr></table></div><p>&nbsp;</p><div id="footer"><p>Something wrong on this page? <a href="https://bugster.forgerock.org/jira/secure/CreateIssueDetails!init.jspa?pid=10000&components=10007&issuetype=1">Log a documentation bug.</a></p></div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23412190-14']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>